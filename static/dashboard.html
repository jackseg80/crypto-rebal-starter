<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Dashboard - Crypto Rebalancer</title>
    
    <script src="global-config.js"></script>
    <script src="shared-header.js"></script>
    
    <style>
        :root {
            /* Theme global unifi√© */
            --bg: #0a0f14;
            --card: #0e1620;
            --muted: #8fa0b3;
            --text: #e7eef7;
            --accent: #2dd4bf;
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
            --border: #1f2b3a;
            --pos: #22c55e;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header sera inject√© par shared-header.js */

        .wrap {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            margin-top: 20px;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 20px;
            transition: all 0.2s;
        }

        .card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(45, 212, 191, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-icon {
            font-size: 24px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 0;
            padding: 8px 0;
        }

        .metric-label {
            color: var(--muted);
            font-size: 14px;
        }

        .metric-value {
            font-weight: 600;
            font-size: 16px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .status-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .action-btn {
            background: var(--accent);
            color: #07211e;
            text-decoration: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(45, 212, 191, 0.3);
        }

        .action-btn.secondary {
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
        }

        .action-btn.secondary:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .portfolio-chart {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--muted);
            border: 1px dashed var(--border);
            border-radius: 8px;
            margin: 16px 0;
        }

        .recent-activity {
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-desc {
            color: var(--muted);
            font-size: 13px;
        }

        .activity-time {
            color: var(--muted);
            font-size: 12px;
        }

        .connections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .connection-item {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .connection-name {
            font-size: 12px;
            margin-bottom: 4px;
            color: var(--muted);
        }

        .loading {
            color: var(--muted);
            text-align: center;
            padding: 20px;
        }

        .error {
            color: var(--danger);
            text-align: center;
            padding: 20px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            border-radius: 8px;
            margin: 12px 0;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- Header sera inject√© par shared-header.js -->

    <div class="wrap">
        <div class="dashboard-grid">
            <!-- Portfolio Overview -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">üí∞</span>
                        Portfolio Overview
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button class="action-btn secondary" style="padding: 4px 8px; font-size: 12px;" onclick="forceRefreshData()">üîÑ</button>
                        <span class="status-badge status-active" id="portfolio-status">Loading</span>
                    </div>
                </div>
                
                <div class="metric">
                    <span class="metric-label">Total Value</span>
                    <span class="metric-value" id="total-value">--</span>
                </div>
                
                <div class="metric">
                    <span class="metric-label">P&L Today</span>
                    <span class="metric-value" id="daily-pnl">--</span>
                </div>
                
                <div class="portfolio-chart" id="portfolio-chart">
                    üìä Portfolio distribution chart
                    <br><small>(Integration avec CoinTracking data)</small>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">‚ö°</span>
                        Quick Actions
                    </div>
                </div>
                
                <div class="quick-actions">
                    <a href="rebalance.html" class="action-btn">
                        ‚öñÔ∏è Plan Rebalance
                    </a>
                    <a href="execution.html" class="action-btn secondary">
                        üöÄ Execute Orders
                    </a>
                    <a href="execution_history.html" class="action-btn secondary">
                        üìà View History
                    </a>
                    <a href="settings.html" class="action-btn secondary">
                        ‚öôÔ∏è Settings
                    </a>
                </div>
            </div>

            <!-- Execution Status -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">üéØ</span>
                        Execution Status
                    </div>
                    <span class="status-badge" id="execution-status">Loading</span>
                </div>
                
                <div class="metric">
                    <span class="metric-label">Last Execution</span>
                    <span class="metric-value" id="last-execution">--</span>
                </div>
                
                <div class="metric">
                    <span class="metric-label">Success Rate (24h)</span>
                    <span class="metric-value" id="success-rate">--</span>
                </div>
                
                <div class="metric">
                    <span class="metric-label">Total Volume (24h)</span>
                    <span class="metric-value" id="volume-24h">--</span>
                </div>
            </div>

            <!-- Exchange Connections -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">üîó</span>
                        Exchange Status
                    </div>
                    <a href="monitoring_advanced.html" class="status-badge status-active" style="text-decoration: none;">View Details</a>
                </div>
                
                <div class="connections-grid" id="connections-grid">
                    <div class="loading">Loading connections...</div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">üìã</span>
                        Recent Activity
                    </div>
                    <a href="execution_history.html" class="status-badge status-active" style="text-decoration: none;">View All</a>
                </div>
                
                <div class="recent-activity" id="recent-activity">
                    <div class="loading">Loading recent activity...</div>
                </div>
            </div>

            <!-- System Health -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">‚ù§Ô∏è</span>
                        System Health
                    </div>
                    <span class="status-badge" id="system-health">Loading</span>
                </div>
                
                <div class="metric">
                    <span class="metric-label">API Status</span>
                    <span class="metric-value" id="api-status">--</span>
                </div>
                
                <div class="metric">
                    <span class="metric-label">Data Freshness</span>
                    <span class="metric-value" id="data-freshness">--</span>
                </div>
                
                <div class="metric">
                    <span class="metric-label">Safety Validator</span>
                    <span class="metric-value" id="safety-status">--</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration et √©tat global
        let dashboardData = {
            portfolio: null,
            connections: null,
            recentActivity: null,
            executionStats: null
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üìä Dashboard unifi√© initialis√©');
            
            // Initialiser le header partag√©
            initSharedHeader('dashboard', { showConfigIndicators: true });
            
            // Charger les donn√©es
            await loadDashboardData();
            
            // Auto-refresh toutes les 30 secondes
            setInterval(loadDashboardData, 30000);
        });

        // Chargement des donn√©es du dashboard
        async function loadDashboardData() {
            try {
                // Charger les donn√©es en parall√®le
                const [portfolioData, connectionsData, historyData, executionStatus] = await Promise.allSettled([
                    loadPortfolioData(),
                    loadConnectionsStatus(),
                    loadRecentHistory(),
                    loadExecutionStatus()
                ]);

                // Mise √† jour avec gestion des erreurs individuelles
                updatePortfolioDisplay(portfolioData.status === 'fulfilled' ? portfolioData.value : null);
                updateConnectionsDisplay(connectionsData.status === 'fulfilled' ? connectionsData.value : null);
                updateRecentActivity(historyData.status === 'fulfilled' ? historyData.value : null);
                updateExecutionStatus(executionStatus.status === 'fulfilled' ? executionStatus.value : null);
                updateSystemHealth();

                console.log('‚úÖ Dashboard data loaded successfully');

            } catch (error) {
                console.error('Erreur chargement dashboard:', error);
                showError('Erreur lors du chargement des donn√©es');
            }
        }

        // Charger les donn√©es du portfolio
        async function loadPortfolioData() {
            try {
                // S'assurer que globalConfig est disponible
                if (typeof globalConfig === 'undefined') {
                    console.warn('globalConfig non disponible, utilisation source par d√©faut');
                    var source = 'cointracking';
                } else {
                    var source = globalConfig.get('data_source') || 'cointracking';
                }
                
                console.log(`üìä Chargement portfolio avec source: ${source}`);
                const response = await fetch(`http://localhost:8000/portfolio/metrics?source=${source}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Erreur portfolio:', error);
                return null;
            }
        }

        // Charger l'√©tat des connexions
        async function loadConnectionsStatus() {
            try {
                // Endpoint temporaire - remplacer quand disponible
                // const response = await fetch('http://localhost:8000/execution/connections');
                // return await response.json();
                
                // Donn√©es simul√©es pour l'instant
                return {
                    binance: { name: "Binance", connected: true },
                    kraken: { name: "Kraken", connected: true },
                    coinbase: { name: "Coinbase", connected: false }
                };
            } catch (error) {
                console.error('Erreur connexions:', error);
                return null;
            }
        }

        // Charger l'historique r√©cent
        async function loadRecentHistory() {
            try {
                // Endpoint temporaire - remplacer quand disponible
                // const response = await fetch('http://localhost:8000/execution/history/sessions?limit=5');
                // return await response.json();
                
                // Donn√©es simul√©es pour l'instant
                return {
                    sessions: [
                        {
                            exchange: "Binance",
                            total_orders: 3,
                            successful_orders: 3,
                            total_volume_usd: 1250.50,
                            timestamp: new Date(Date.now() - 3600000).toISOString() // 1h ago
                        },
                        {
                            exchange: "Kraken",
                            total_orders: 2,
                            successful_orders: 2,
                            total_volume_usd: 890.25,
                            timestamp: new Date(Date.now() - 7200000).toISOString() // 2h ago
                        }
                    ]
                };
            } catch (error) {
                console.error('Erreur historique:', error);
                return null;
            }
        }

        // Charger le statut d'ex√©cution
        async function loadExecutionStatus() {
            try {
                // Endpoint temporaire - remplacer quand disponible
                // const response = await fetch('http://localhost:8000/execution/statistics/summary');
                // return await response.json();
                
                // Donn√©es simul√©es pour l'instant
                return {
                    recent_24h: {
                        total_orders: 5,
                        success_rate: 96.5,
                        total_volume: 2140.75
                    }
                };
            } catch (error) {
                console.error('Erreur statut ex√©cution:', error);
                return null;
            }
        }

        // Mise √† jour affichage du portfolio
        function updatePortfolioDisplay(data) {
            if (!data || !data.ok) {
                document.getElementById('total-value').textContent = 'Erreur';
                document.getElementById('daily-pnl').textContent = 'Erreur';
                document.getElementById('portfolio-status').className = 'status-badge status-error';
                document.getElementById('portfolio-status').textContent = 'Erreur';
                return;
            }

            const metrics = data.metrics;
            const performance = data.performance;

            // Mettre √† jour la valeur totale
            document.getElementById('total-value').textContent = formatUSD(metrics.total_value_usd || 0);
            
            // Mettre √† jour le P&L r√©el depuis les donn√©es de performance
            const dailyPnl = performance?.absolute_change_usd || 0;
            const pnlElement = document.getElementById('daily-pnl');
            pnlElement.textContent = formatUSD(dailyPnl);
            pnlElement.style.color = dailyPnl >= 0 ? 'var(--success)' : 'var(--danger)';
            
            // Mettre √† jour le statut bas√© sur les donn√©es
            const statusEl = document.getElementById('portfolio-status');
            if (metrics.total_value_usd > 0) {
                statusEl.className = 'status-badge status-active';
                statusEl.textContent = 'Actif';
            } else {
                statusEl.className = 'status-badge status-warning';
                statusEl.textContent = 'Vide';
            }
        }

        // Mise √† jour affichage des connexions
        function updateConnectionsDisplay(data) {
            const container = document.getElementById('connections-grid');
            
            if (!data) {
                container.innerHTML = '<div class="error">Erreur de chargement</div>';
                return;
            }

            const connections = Object.values(data);
            const html = connections.map(conn => {
                const statusClass = conn.connected ? 'status-active' : 'status-error';
                const statusText = conn.connected ? 'Online' : 'Offline';
                
                return `
                    <div class="connection-item">
                        <div class="connection-name">${conn.name}</div>
                        <div class="status-badge ${statusClass}">${statusText}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // Mise √† jour activit√© r√©cente
        function updateRecentActivity(data) {
            const container = document.getElementById('recent-activity');
            
            if (!data || !data.sessions || data.sessions.length === 0) {
                container.innerHTML = `
                    <div class="activity-item">
                        <div>
                            <div>Aucune activit√© r√©cente</div>
                            <div class="activity-desc">Les sessions d'ex√©cution appara√Ætront ici</div>
                        </div>
                        <div class="activity-time">--</div>
                    </div>
                `;
                return;
            }

            const html = data.sessions.slice(0, 5).map(session => `
                <div class="activity-item">
                    <div>
                        <div>${session.total_orders || 0} ordres sur ${session.exchange || 'Exchange'}</div>
                        <div class="activity-desc">
                            ${session.successful_orders || 0} r√©ussis, ${formatUSD(session.total_volume_usd || 0)} volume
                        </div>
                    </div>
                    <div class="activity-time">
                        ${formatTimeAgo(session.timestamp)}
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // Mise √† jour statut d'ex√©cution
        function updateExecutionStatus(data) {
            if (!data || !data.recent_24h) {
                document.getElementById('last-execution').textContent = 'Aucune';
                document.getElementById('success-rate').textContent = '--';
                document.getElementById('volume-24h').textContent = '$0.00';
                
                const statusEl = document.getElementById('execution-status');
                statusEl.className = 'status-badge status-warning';
                statusEl.textContent = 'En attente';
                return;
            }

            document.getElementById('last-execution').textContent = 
                data.recent_24h?.total_orders > 0 ? 'R√©cent' : 'Aucune';
                
            const successRate = data.recent_24h?.success_rate;
            document.getElementById('success-rate').textContent = 
                successRate !== undefined ? successRate.toFixed(1) + '%' : '--';
                
            document.getElementById('volume-24h').textContent = 
                formatUSD(data.recent_24h?.total_volume || 0);

            const statusEl = document.getElementById('execution-status');
            if (successRate >= 95) {
                statusEl.className = 'status-badge status-active';
                statusEl.textContent = 'Excellent';
            } else if (successRate >= 90) {
                statusEl.className = 'status-badge status-warning';
                statusEl.textContent = 'Bon';
            } else if (successRate !== undefined) {
                statusEl.className = 'status-badge status-error';
                statusEl.textContent = '√Ä am√©liorer';
            } else {
                statusEl.className = 'status-badge status-warning';
                statusEl.textContent = 'En attente';
            }
        }

        // Mise √† jour sant√© syst√®me
        function updateSystemHealth() {
            document.getElementById('api-status').textContent = 'Online';
            document.getElementById('data-freshness').textContent = 'R√©cente';
            document.getElementById('safety-status').textContent = 'Actif';
            
            document.getElementById('system-health').className = 'status-badge status-active';
            document.getElementById('system-health').textContent = 'Healthy';
        }

        // Utilitaires de formatage
        function formatUSD(value) {
            if (!value) return '$0.00';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function formatTimeAgo(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            const now = new Date();
            const diffMinutes = Math.floor((now - date) / (1000 * 60));
            
            if (diffMinutes < 60) return `${diffMinutes}min`;
            if (diffMinutes < 1440) return `${Math.floor(diffMinutes / 60)}h`;
            return `${Math.floor(diffMinutes / 1440)}j`;
        }

        function showError(message) {
            console.error(message);
        }

        // Forcer un refresh des donn√©es avec la source actuelle
        async function forceRefreshData() {
            console.log('üîÑ Force refresh demand√© par utilisateur');
            // Vider le cache si n√©cessaire
            await loadDashboardData();
        }
    </script>
</body>
</html>