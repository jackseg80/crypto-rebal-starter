<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>📊 Dashboard - Crypto Rebalancer</title>
    <link rel="stylesheet" href="shared-theme.css">
    <link rel="stylesheet" href="theme-compat.css">
    <script type="module" src="components/nav.js"></script>
    <script type="module" src="components/tooltips.js"></script>
    <script type="module">
        import { initDeepLinks } from './components/deep-links.js';
        // Ancres pour dashboard.html : #overview #crypto #bourse #banque #divers #fx
        initDeepLinks({
            'overview': 'Vue d\'ensemble',
            'crypto': 'Crypto Portfolio',
            'bourse': 'Actions & ETF',
            'banque': 'Comptes bancaires',
            'divers': 'Actifs divers',
            'fx': 'Devises & Changes'
        });
    </script>

    <script src="debug-logger.js"></script>
    <script src="input-validator.js"></script>
    <script src="performance-optimizer.js"></script>
    <script src="global-config.js"></script>
    <script src="appearance.js"></script>
    <script type="module" src="modules/dashboard-main-controller.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--theme-background);
            color: var(--theme-text);
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.6;
            min-height: 100vh;
        }

        .wrap {
            max-width: 95vw;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            margin-top: 20px;
        }

        .card {
            background: var(--theme-surface);
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-sm);
        }

        .card:hover {
            border-color: var(--brand-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--theme-border);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-icon {
            font-size: 24px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 0;
            padding: 8px 0;
        }

        .metric-label {
            color: var(--theme-text-muted);
            font-size: 14px;
        }

        .metric-value {
            font-weight: 600;
            font-size: 16px;
            color: var(--theme-text);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: var(--success-bg);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .status-warning {
            background: var(--warning-bg);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .status-error {
            background: var(--danger-bg);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .action-btn {
            background: var(--brand-primary);
            color: white;
            text-decoration: none;
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            font-weight: 600;
            text-align: center;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
            background: var(--brand-primary-hover);
        }

        .action-btn.secondary {
            background: var(--theme-surface-elevated);
            color: var(--theme-text);
            border: 1px solid var(--theme-border);
        }

        .action-btn.secondary:hover {
            border-color: var(--brand-primary);
            color: var(--brand-primary);
            background: var(--theme-surface-hover);
        }

        /* Container pour graphique Chart.js */
        .portfolio-chart {
            height: 210px;
            position: relative;
            margin: var(--space-lg) 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .portfolio-chart canvas {
            max-height: 100%;
            max-width: 100%;
        }

        .recent-activity {
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) 0;
            border-bottom: 1px solid var(--theme-border);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-desc {
            color: var(--theme-text-muted);
            font-size: 13px;
        }

        .activity-time {
            color: var(--theme-text-muted);
            font-size: 12px;
        }

        .connections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .connection-item {
            text-align: center;
            padding: var(--space-md);
            border-radius: var(--radius-md);
            border: 1px solid var(--theme-border);
            background: var(--theme-surface-elevated);
        }

        .connection-name {
            font-size: 12px;
            margin-bottom: 4px;
            color: var(--theme-text-muted);
        }

        .loading {
            color: var(--theme-text-muted);
            text-align: center;
            padding: var(--space-xl);
        }

        .error {
            color: var(--danger);
            text-align: center;
            padding: var(--space-xl);
            background: var(--danger-bg);
            border: 1px solid var(--danger);
            border-radius: var(--radius-md);
            margin: var(--space-md) 0;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }
        }
    </style>


</head>

<body>
    <div class="wrap">
        <div class="dashboard-grid">
            <!-- Global Insight (Unified view) -->
            <div class="card" id="overview" draggable="true"
                data-tooltip="Vue unifiée: décision, cycle, on-chain, risque, sentiment"
                data-source="Scores unifiés du Risk Dashboard">
                <div class="card-header">
                    <a href="analytics-unified.html" class="card-title" style="text-decoration: none; color: inherit;">
                        <span class="card-icon">🧭</span> Global Insight
                    </a>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
                    <div>
                        <div style="font-size:.85rem; color: var(--theme-text-muted); font-weight:600;">Decision Index
                        </div>
                        <div id="gi-score" style="font-size:2rem; font-weight:800;">--</div>
                    </div>
                    <div style="text-align:right; font-size:.85rem; color: var(--theme-text-muted);">
                        <div>Cycle: <span id="gi-cycle">--</span></div>
                        <div>On‑Chain: <span id="gi-onchain">--</span></div>
                        <div>Risque: <span id="gi-risk">--</span></div>
                    </div>
                </div>
                <div id="gi-reco" style="margin-top:.5rem; font-size:.9rem; color: var(--theme-text);"></div>
                <div id="gi-meta"
                    style="text-align:center; font-size:11px; color:var(--theme-text-muted); margin-top:8px; padding-top:8px; border-top:1px solid var(--theme-border);">
                </div>
            </div>

            <!-- Crypto Overview - Disposition améliorée pour gagner de la place -->
            <div class="card" id="crypto" draggable="true" style="grid-column: span 2;"
                data-tooltip="Vue d'ensemble complète de votre portefeuille crypto avec répartition, métriques de performance et graphiques en temps réel."
                data-source="API /balances/current + prix CoinGecko/CoinGlass">
                <div class="card-header">
                    <div class="card-title"><span class="card-icon">₿</span>Crypto Overview</div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <span id="portfolio-source-display"
                            style="font-size:11px;color:var(--theme-text-muted);padding:2px 6px;background:var(--theme-bg);border-radius:4px;border:1px solid var(--theme-border);">--</span>
                        <button class="action-btn secondary" style="padding:4px 8px;font-size:12px;"
                            onclick="forceRefreshData()">🔄</button>
                        <span class="status-badge status-active" id="portfolio-status">Loading</span>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg);">
                    <!-- Colonne gauche : Métriques -->
                    <div>
                        <div class="metric">
                            <span class="metric-label">Total Value</span>
                            <span class="metric-value" id="total-value">--</span>
                        </div>

                        <div class="metric">
                            <span class="metric-label">P&L Today</span>
                            <span class="metric-value" id="daily-pnl">--</span>
                        </div>

                        <div class="metric">
                            <span class="metric-label">Assets Count</span>
                            <span class="metric-value" id="assets-count">--</span>
                        </div>
                    </div>

                    <!-- Colonne droite : Graphique et Breakdown -->
                    <div>
                        <div class="portfolio-chart" id="portfolio-chart">
                            <canvas id="portfolioChartCanvas"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bourse (Saxo) Overview - Lecture legacy -->
            <div class="card" id="bourse" draggable="true"
                data-tooltip="Vue d'ensemble de votre portefeuille d'actions et ETF via Saxo Bank en lecture seule."
                data-source="API /api/saxo/positions (legacy)">
                <div class="card-header">
                    <a href="saxo-dashboard.html" class="card-title" style="text-decoration: none; color: inherit;">
                        <span class="card-icon">🏦</span>Bourse (Saxo) Overview
                    </a>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <button class="action-btn secondary" style="padding:4px 8px;font-size:12px;"
                            onclick="refreshSaxoTile()">🔄</button>
                        <span class="status-badge" id="saxo-status">Loading</span>
                    </div>
                </div>

                <div class="metric">
                    <span class="metric-label">Valeur Totale</span>
                    <span class="metric-value" id="saxo-total-value">--</span>
                </div>

                <div class="metric">
                    <span class="metric-label">Positions</span>
                    <span class="metric-value" id="saxo-positions-count">--</span>
                </div>

                <div class="metric">
                    <span class="metric-label">Dernier Import</span>
                    <span class="metric-value" id="saxo-last-import" style="font-size:0.9rem;">--</span>
                </div>

                <div id="saxo-empty-state" style="display:none;text-align:center;color:var(--theme-text-muted);font-size:0.85rem;margin-top:12px;">
                    Aucune position Saxo.<br>
                    <a href="settings.html#sources" style="color:var(--theme-accent);">Importez un fichier dans Settings</a>
                </div>
            </div>

            <!-- Banque (Banks) Overview -->
            <div class="card" id="banque" draggable="true"
                data-tooltip="Vue d'ensemble de vos comptes bancaires (comptes courants, épargne)."
                data-source="API /api/wealth/banks/positions">
                <div class="card-header">
                    <a href="banks-manager.html" class="card-title" style="text-decoration: none; color: inherit;">
                        <span class="card-icon">💰</span>Banque Overview
                    </a>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <button class="action-btn secondary" style="padding:4px 8px;font-size:12px;"
                            onclick="refreshBanksTile()">🔄</button>
                        <span class="status-badge" id="banks-status">Loading</span>
                    </div>
                </div>

                <div class="metric">
                    <span class="metric-label">Valeur Totale</span>
                    <span class="metric-value" id="banks-total-value">--</span>
                </div>

                <div class="metric">
                    <span class="metric-label">Comptes</span>
                    <span class="metric-value" id="banks-accounts-count">--</span>
                </div>

                <div class="metric">
                    <span class="metric-label">Devises</span>
                    <span class="metric-value" id="banks-currencies-count">--</span>
                </div>

                <div id="banks-empty-state" style="display:none;text-align:center;color:var(--theme-text-muted);font-size:0.85rem;margin-top:12px;">
                    Aucun compte bancaire.<br>
                    <a href="banks-manager.html" style="color:var(--theme-accent);">Ajoutez-en un maintenant</a>
                </div>
            </div>

            <!-- Global Overview - Agrégation Crypto + Saxo + Banks -->
            <div class="card" id="global" draggable="true"
                data-tooltip="Vue d'ensemble globale de votre patrimoine (Crypto + Bourse + Banques)"
                data-source="API /api/wealth/global/summary">
                <div class="card-header">
                    <div class="card-title"><span class="card-icon">🌐</span>Global Overview</div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <button class="action-btn secondary" style="padding:4px 8px;font-size:12px;"
                            onclick="refreshGlobalTile()">🔄</button>
                        <span class="status-badge" id="global-status">Loading</span>
                    </div>
                </div>

                <!-- Total Global en tête -->
                <div style="text-align:center;padding:8px 0;border-bottom:1px solid var(--theme-border);">
                    <div style="font-size:0.75rem;color:var(--theme-text-muted);margin-bottom:2px;">Total</div>
                    <div id="global-total-value" style="font-size:1.3rem;font-weight:700;color:var(--theme-text);">--</div>
                </div>

                <!-- Modules avec graphiques intégrés -->
                <div id="global-breakdown" style="display:flex;flex-direction:column;gap:6px;margin-top:8px;">
                    <!-- Module cards will be added here by JS -->
                </div>
            </div>

            <!-- Execution Status -->
            <div class="card" id="card-execution" draggable="true"
                data-tooltip="Statut des exécutions automatiques de trades avec historique des performances et volumes traités."
                data-source="API /execution/status + logs internes">
                <div class="card-header">
                    <div class="card-title"><span class="card-icon">🎯</span>Execution Status</div>
                    <span class="status-badge" id="execution-status">Loading</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Last Execution</span>
                    <span class="metric-value" id="last-execution">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Success Rate (24h)</span>
                    <span class="metric-value" id="success-rate">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Total Volume (24h)</span>
                    <span class="metric-value" id="volume-24h">--</span>
                </div>
            </div>

            <!-- Exchange Connections -->
            <div class="card" id="card-exchange" draggable="true"
                data-tooltip="État des connexions avec les exchanges (Binance, KuCoin) et vérification des API keys."
                data-source="Tests de connectivité API en temps réel">
                <div class="card-header">
                    <div class="card-title"><span class="card-icon">🔗</span>Exchange Status</div>
                    <a href="monitoring.html" class="status-badge status-active" style="text-decoration:none;">View
                        Details</a>
                </div>
                <div class="connections-grid" id="connections-grid">
                    <div class="loading">Loading connections...</div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card" id="card-activity" draggable="true"
                data-tooltip="Historique des dernières opérations de trading, rebalancing et événements système."
                data-source="API /execution/history + logs système">
                <div class="card-header">
                    <div class="card-title"><span class="card-icon">📋</span>Recent Activity</div>
                    <a href="execution_history.html" class="status-badge status-active"
                        style="text-decoration:none;">View All</a>
                </div>
                <div class="recent-activity" id="recent-activity">
                    <div class="loading">Loading recent activity...</div>
                </div>
            </div>

            <!-- System Health -->
            <div class="card" id="card-health" draggable="true"
                data-tooltip="Surveillance de la santé du système : APIs, fraîcheur des données et validateurs de sécurité."
                data-source="Monitoring interne + tests API">
                <div class="card-header">
                    <div class="card-title"><span class="card-icon">❤️</span>System Health</div>
                    <span class="status-badge" id="system-health">Loading</span>
                </div>
                <div class="metric">
                    <span class="metric-label">API Status</span>
                    <span class="metric-value" id="api-status">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Data Freshness</span>
                    <span class="metric-value" id="data-freshness">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Safety Validator</span>
                    <span class="metric-value" id="safety-status">--</span>
                </div>
            </div>

            <!-- Scores -->
            <div class="card" id="card-scores" draggable="true"
                data-tooltip="Scores de performance et métriques calculés par les algorithmes ML pour évaluer le portefeuille."
                data-source="API /analytics/scores + modèles ML">
                <div class="card-header">
                    <a href="risk-dashboard.html" class="card-title" style="text-decoration: none; color: inherit;">
                        Scores
                    </a>
                    <span class="status-badge" id="scores-status">Loading</span>
                </div>
                <div id="scores-content">
                    <div class="loading">Chargement des scores...</div>
                </div>
            </div>

            <!-- Debug & New Modules -->
            <div class="card" id="card-debug" draggable="true"
                data-tooltip="Accès rapide aux outils de debug et aux nouveaux modules : Analytics, AI, Optimisation et Performance."
                data-source="Liens internes et outils développeur">
                <div class="card-header">
                    <div class="card-title"><span class="card-icon">🔧</span>Debug & Nouveaux Modules</div>
                    <a href="debug-menu.html" class="status-badge status-active" style="text-decoration:none;">Menu
                        Complet</a>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 12px;">
                    <a href="analytics-unified.html"
                        style="color: var(--theme-accent); text-decoration: none; padding: 8px; border: 1px solid var(--theme-border); border-radius: 6px; text-align: center; font-size: 0.9em;">
                        📊 Analytics
                    </a>
                    <a href="ai-dashboard.html"
                        style="color: var(--theme-accent); text-decoration: none; padding: 8px; border: 1px solid var(--theme-border); border-radius: 6px; text-align: center; font-size: 0.9em;">
                        🤖 AI Dashboard
                    </a>
                    <a href="portfolio-optimization.html"
                        style="color: var(--theme-accent); text-decoration: none; padding: 8px; border: 1px solid var(--theme-border); border-radius: 6px; text-align: center; font-size: 0.9em;">
                        🎯 Optimisation+
                    </a>
                    <a href="/api/performance/cache/stats" target="_blank"
                        style="color: var(--theme-accent); text-decoration: none; padding: 8px; border: 1px solid var(--theme-border); border-radius: 6px; text-align: center; font-size: 0.9em;">
                        ⚡ Performance
                    </a>
                </div>
                <div
                    style="padding: 8px 12px; font-size: 0.8em; color: var(--theme-text-secondary); border-top: 1px solid var(--theme-border);">
                    4 nouveaux systèmes: Performance (4.8x), Multi-actifs (7 classes), Charts interactifs, Optimisation
                    avancée
                </div>
            </div>

        </div>
    </div>


    <!-- ✅ Scores sync removed: store auto-hydrates and subscribes automatically -->

</body>

</html>