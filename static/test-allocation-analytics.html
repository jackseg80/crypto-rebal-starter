<!DOCTYPE html>
<html>
<head>
    <title>Test Allocation Analytics</title>
    <script src="global-config.js"></script>
</head>
<body>
    <h1>üîç Diagnostic Allocation Sugg√©r√©e</h1>
    <pre id="output"></pre>

    <script type="module">
        import { getUnifiedState } from './core/unified-insights-v2.js';
        import { renderUnifiedInsights } from './components/UnifiedInsights.js';

        const output = document.getElementById('output');

        function log(message) {
            output.textContent += message + '\n';
            console.log(message);
        }

        async function diagnoseProblem() {
            log('üîç D√©marrage du diagnostic...\n');

            try {
                // 1. Tester getUnifiedState
                log('1Ô∏è‚É£ Test getUnifiedState...');
                const unifiedState = await getUnifiedState();

                log(`‚úÖ getUnifiedState r√©ussi`);
                log(`   - Decision score: ${unifiedState.decision?.score || 'undefined'}`);
                log(`   - Decision source: ${unifiedState.decision?.source || 'undefined'}`);
                log(`   - Strategy targets: ${unifiedState.strategy?.targets?.length || 0} items`);
                log(`   - Intelligence allocation: ${unifiedState.intelligence?.allocation ? Object.keys(unifiedState.intelligence.allocation).length : 0} keys`);

                // 2. V√©rifier les targets
                if (unifiedState.strategy?.targets && unifiedState.strategy.targets.length > 0) {
                    log('\n2Ô∏è‚É£ Strategy Targets trouv√©s:');
                    unifiedState.strategy.targets.forEach(target => {
                        log(`   - ${target.symbol}: ${(target.weight * 100).toFixed(1)}%`);
                    });
                } else {
                    log('\n‚ùå Aucun strategy targets trouv√©');
                }

                // 3. V√©rifier intelligence allocation
                if (unifiedState.intelligence?.allocation) {
                    log('\n3Ô∏è‚É£ Intelligence Allocation trouv√©:');
                    Object.entries(unifiedState.intelligence.allocation).forEach(([key, value]) => {
                        log(`   - ${key}: ${value.toFixed(1)}%`);
                    });
                } else {
                    log('\n‚ùå Aucune intelligence allocation trouv√©e');
                }

                // 4. Tester le rendu UnifiedInsights
                log('\n4Ô∏è‚É£ Test du composant UnifiedInsights...');

                // Cr√©er un conteneur pour le test
                const testContainer = document.createElement('div');
                testContainer.id = 'test-container';
                document.body.appendChild(testContainer);

                await renderUnifiedInsights('test-container');
                log('‚úÖ Composant UnifiedInsights rendu avec succ√®s');

                // 5. V√©rifier localStorage
                log('\n5Ô∏è‚É£ Test localStorage allocation...');
                const storedAllocation = localStorage.getItem('unified_suggested_allocation');
                if (storedAllocation) {
                    const parsed = JSON.parse(storedAllocation);
                    log(`‚úÖ Allocation dans localStorage:`);
                    log(`   - Strategy: ${parsed.strategy}`);
                    log(`   - Timestamp: ${parsed.timestamp}`);
                    log(`   - Source: ${parsed.source}`);
                    if (parsed.targets) {
                        Object.entries(parsed.targets).forEach(([key, value]) => {
                            log(`   - ${key}: ${value}%`);
                        });
                    }
                } else {
                    log('‚ùå Aucune allocation dans localStorage');
                }

                // 6. Diagnostic final
                log('\nüéØ DIAGNOSTIC FINAL:');
                const hasTargets = (unifiedState.strategy?.targets?.length || 0) > 0;
                const hasIntelligence = !!unifiedState.intelligence?.allocation;
                const hasLocalStorage = !!storedAllocation;

                if (!hasTargets && !hasIntelligence) {
                    log('‚ùå PROBL√àME: Aucune donn√©e d\'allocation g√©n√©r√©e');
                    log('   Le moteur d\'allocation V2 ne produit pas de donn√©es');
                    log('   V√©rifiez calculateIntelligentDecisionIndexAPI');
                } else if (hasTargets || hasIntelligence) {
                    log('‚úÖ Donn√©es d\'allocation pr√©sentes');
                    log('   L\'allocation sugg√©r√©e devrait s\'afficher');
                }

            } catch (error) {
                log(`‚ùå ERREUR: ${error.message}`);
                log(`Stack: ${error.stack}`);
            }
        }

        // Lancer le diagnostic au chargement
        diagnoseProblem();
    </script>
</body>
</html>