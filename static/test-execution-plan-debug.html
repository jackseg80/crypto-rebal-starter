<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug Execution Plan - Phase Engine Integration</title>
  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">
  <script src="global-config.js"></script>
  <script src="appearance.js"></script>
</head>

<body>
  <header class="header">
    <div class="container">
      <h1>üîç Debug Execution Plan Integration</h1>
      <p>Test de l'int√©gration Phase Engine + Execution Plan</p>
    </div>
  </header>

  <main class="container">

    <div class="card">
      <h2>üéØ Phase Engine + Execution Plan Test</h2>
      <button id="test-integration" class="btn btn-primary">Test Integration</button>
      <div id="integration-results" style="margin-top: 1rem;"></div>
    </div>

    <div class="card">
      <h2>üìä Unified State Analysis</h2>
      <button id="analyze-unified" class="btn btn-secondary">Analyze Unified State</button>
      <div id="unified-analysis" style="margin-top: 1rem;"></div>
    </div>

    <div class="card">
      <h2>üíæ Saved Data Check</h2>
      <button id="check-saved-data" class="btn btn-info">Check Saved Data</button>
      <div id="saved-data-check" style="margin-top: 1rem;"></div>
    </div>

  </main>

  <script type="module">
    // Test Phase Engine + Execution Plan integration
    document.getElementById('test-integration').addEventListener('click', async () => {
      const results = document.getElementById('integration-results');
      results.innerHTML = '<div class="loading">Testing integration...</div>';

      try {
        // Import necessary modules
        const { getUnifiedState } = await import('./core/unified-insights-v2.js');
        const { calculateIntelligentDecisionIndexAPI } = await import('./core/strategy-api-adapter.js');

        console.log('üîç Testing Phase Engine + Execution Plan integration...');

        // Get current unified state
        const unifiedState = await getUnifiedState();
        console.log('üìä Unified state:', unifiedState);

        // Check if execution plan exists
        const hasExecutionPlan = unifiedState.execution?.plan_iter1;
        const executionDetails = unifiedState.execution;

        // Create test context for decision API
        const testContext = {
          cycleData: unifiedState.cycle,
          regimeData: unifiedState.regime,
          blendedScore: unifiedState.decision?.score || 50
        };

        // Test strategy API directly
        console.log('üöÄ Testing Strategy API with context:', testContext);
        const decision = await calculateIntelligentDecisionIndexAPI(testContext);
        console.log('üìã Decision result:', decision);

        const hasDecisionExecutionPlan = decision.execution_plan;

        results.innerHTML = `
          <div class="success">‚úÖ Integration test completed</div>
          <h3>Unified State Execution:</h3>
          <pre style="background: var(--theme-surface); padding: 1rem; border-radius: 6px; overflow-x: auto;">
Has execution plan: ${!!hasExecutionPlan}
Estimated iters: ${executionDetails?.estimated_iters_to_target || 'null'}
Cap per iter: ${executionDetails?.cap_pct_per_iter || 'null'}
Plan data: ${hasExecutionPlan ? 'Available' : 'Missing'}
          </pre>
          <h3>Decision API Execution:</h3>
          <pre style="background: var(--theme-surface); padding: 1rem; border-radius: 6px; overflow-x: auto;">
Has execution_plan: ${!!hasDecisionExecutionPlan}
Estimated iters: ${hasDecisionExecutionPlan?.estimated_iters || 'null'}
Convergence time: ${hasDecisionExecutionPlan?.convergence_time || 'null'}
Source: ${decision.source || 'unknown'}
API version: ${decision.api_version || 'unknown'}
          </pre>
          <h3>Phase Engine:</h3>
          <pre style="background: var(--theme-surface); padding: 1rem; border-radius: 6px; overflow-x: auto;">
Phase detected: ${unifiedState.cycle?.phase?.phase || 'unknown'}
Targets by group: ${Object.keys(unifiedState.targets_by_group || {}).length} groups
Phase tilts applied: ${unifiedState.phase?.tiltsApplied || 'unknown'}
          </pre>
        `;

      } catch (error) {
        console.error('‚ùå Integration test failed:', error);
        results.innerHTML = `<div class="error">‚ùå Test failed: ${error.message}</div>`;
      }
    });

    // Analyze unified state in detail
    document.getElementById('analyze-unified').addEventListener('click', async () => {
      const analysis = document.getElementById('unified-analysis');
      analysis.innerHTML = '<div class="loading">Analyzing unified state...</div>';

      try {
        const { getUnifiedState } = await import('./core/unified-insights-v2.js');
        const unifiedState = await getUnifiedState();

        analysis.innerHTML = `
          <h3>üìä Complete Unified State Analysis</h3>
          <pre style="background: var(--theme-surface); padding: 1rem; border-radius: 6px; overflow-x: auto; max-height: 400px;">
${JSON.stringify(unifiedState, null, 2)}
          </pre>
        `;

      } catch (error) {
        console.error('‚ùå Analysis failed:', error);
        analysis.innerHTML = `<div class="error">‚ùå Analysis failed: ${error.message}</div>`;
      }
    });

    // Check what's saved in localStorage
    document.getElementById('check-saved-data').addEventListener('click', () => {
      const check = document.getElementById('saved-data-check');

      try {
        const savedData = localStorage.getItem('unified_suggested_allocation');
        const parsed = savedData ? JSON.parse(savedData) : null;

        check.innerHTML = `
          <h3>üíæ Saved Data Check</h3>
          <h4>Raw localStorage:</h4>
          <pre style="background: var(--theme-surface); padding: 1rem; border-radius: 6px; overflow-x: auto;">
${savedData || 'No data found'}
          </pre>
          ${parsed ? `
          <h4>Parsed Data:</h4>
          <pre style="background: var(--theme-surface); padding: 1rem; border-radius: 6px; overflow-x: auto; max-height: 300px;">
Has execution_plan: ${!!parsed.execution_plan}
Source: ${parsed.source || 'unknown'}
Timestamp: ${parsed.timestamp || 'unknown'}
Targets keys: ${Object.keys(parsed.targets || {}).join(', ')}
Execution plan details: ${JSON.stringify(parsed.execution_plan, null, 2)}
          </pre>
          ` : ''}
        `;

      } catch (error) {
        console.error('‚ùå Check failed:', error);
        check.innerHTML = `<div class="error">‚ùå Check failed: ${error.message}</div>`;
      }
    });

  </script>

</body>
</html>