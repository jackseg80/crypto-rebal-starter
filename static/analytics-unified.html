<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics Unifi√©s - Crypto Rebalancer</title>
  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">
  <script src="global-config.js"></script>
  <script src="appearance.js"></script>
  <script type="module" src="components/nav.js"></script>
  <script type="module" src="analytics-unified.js"></script>
  <script type="module">
    import { renderUnifiedInsights } from './components/UnifiedInsights.js';
    import { store } from './core/risk-dashboard-store.js';
    
    // INTELLIGENT CACHE SYSTEM - Avoid constant recalculations
    const CACHE_CONFIG = {
      risk: { ttl: 5 * 60 * 1000, key: 'analytics_unified_risk' },      // 5 minutes
      cycle: { ttl: 60 * 60 * 1000, key: 'analytics_unified_cycle' },    // 1 hour  
      onchain: { ttl: 10 * 60 * 1000, key: 'analytics_unified_onchain' }, // 10 minutes
      blended: { ttl: 2 * 60 * 1000, key: 'analytics_unified_blended' }   // 2 minutes
    };

    // Generate cache key that includes data source to invalidate on source change
    function getCacheKey(baseKey) {
      const dataSource = globalConfig.get('data_source') || 'unknown';
      return `${baseKey}_${dataSource}`;
    }
    
    function isCacheValid(cacheKey, ttl) {
      try {
        const fullKey = getCacheKey(cacheKey);
        const cached = localStorage.getItem(fullKey);
        if (!cached) return false;
        const data = JSON.parse(cached);
        return Date.now() - data.timestamp < ttl;
      } catch { return false; }
    }
    
    function setCache(cacheKey, data) {
      try {
        const fullKey = getCacheKey(cacheKey);
        localStorage.setItem(fullKey, JSON.stringify({ data, timestamp: Date.now() }));
      } catch {}
    }
    
    function getCache(cacheKey) {
      try {
        const fullKey = getCacheKey(cacheKey);
        const cached = localStorage.getItem(fullKey);
        return cached ? JSON.parse(cached).data : null;
      } catch { return null; }
    }
    
    // Lightweight unified data loader with INTELLIGENT CACHING
    async function loadUnifiedData() {
      console.log('üß† Loading unified data with intelligent caching...');
      let loadedFromCache = 0;
      
      try {
        const priceDays = 365, corrDays = 90;
        
        // 1) Risk (backend) - With cache
        if (isCacheValid(CACHE_CONFIG.risk.key, CACHE_CONFIG.risk.ttl)) {
          console.log('‚úÖ Risk data loaded from cache');
          const riskData = getCache(CACHE_CONFIG.risk.key);
          store.set('risk', riskData);
          const rs = riskData?.risk_metrics?.risk_score;
          if (typeof rs === 'number') store.set('scores.risk', rs);
          store.set('ui.apiStatus.backend', 'healthy');
          loadedFromCache++;
        } else {
          try {
            const minUsd = globalConfig.get('min_usd_threshold');
            const riskUrl = globalConfig.getApiUrl('/api/risk/dashboard', { price_history_days: priceDays, lookback_days: corrDays, min_usd: minUsd });
            console.log(`üîç Fetching risk data from: ${riskUrl} (source: ${globalConfig.get('data_source')})`);
            const r = await fetch(riskUrl);
            if (r.ok) {
              const riskData = await r.json();
              setCache(CACHE_CONFIG.risk.key, riskData);
              store.set('risk', riskData);
              const rs = riskData?.risk_metrics?.risk_score;
              if (typeof rs === 'number') store.set('scores.risk', rs);
              store.set('ui.apiStatus.backend', 'healthy');
              console.log('‚úÖ Risk data fetched and cached');
            } else {
              store.set('ui.apiStatus.backend', 'error');
            }
          } catch (_) { store.set('ui.apiStatus.backend', 'error'); }

        }
        
        // 2) Cycle (client-side) - With cache
        if (isCacheValid(CACHE_CONFIG.cycle.key, CACHE_CONFIG.cycle.ttl)) {
          console.log('‚úÖ Cycle data loaded from cache');
          const cycleData = getCache(CACHE_CONFIG.cycle.key);
          store.set('cycle.months', cycleData.months);
          store.set('cycle.score', cycleData.score);
          store.set('cycle.phase', cycleData.phase);
          loadedFromCache++;
        } else {
          try {
            const { getCurrentCycleMonths, cycleScoreFromMonths, getCyclePhase } = await import('./modules/cycle-navigator.js');
            const c = getCurrentCycleMonths();
            const score = Math.round(cycleScoreFromMonths(c.months));
            const phase = getCyclePhase(c.months);
            const cycleData = { months: c.months, score, phase };
            setCache(CACHE_CONFIG.cycle.key, cycleData);
            store.set('cycle.months', c.months);
            store.set('cycle.score', score);
            store.set('cycle.phase', phase);
            console.log('‚úÖ Cycle data calculated and cached');
          } catch (e) { console.warn('Cycle data load failed:', e.message); }
        }

        // 3) On-Chain (via scraper/proxy) - With cache
        if (isCacheValid(CACHE_CONFIG.onchain.key, CACHE_CONFIG.onchain.ttl)) {
          console.log('‚úÖ On-Chain data loaded from cache');
          const onchainData = getCache(CACHE_CONFIG.onchain.key);
          if (typeof onchainData.score === 'number') {
            store.set('scores.onchain', onchainData.score);
          }
          store.set('scores.onchain_metadata', onchainData.metadata);
          store.set('scores.contradictory_signals', onchainData.contradictory_signals);
          store.set('ui.apiStatus.signals', 'healthy');
          loadedFromCache++;
        } else {
          try {
            const onchain = await import('./modules/onchain-indicators.js');
            const v2 = await import('./modules/composite-score-v2.js');
            const indicators = await onchain.fetchAllIndicators();
            const dyn = localStorage.getItem('enable_dynamic_weighting') === 'true';
            const composite = v2.calculateCompositeScoreV2(indicators, dyn);
            
            let finalComposite = composite;
            // Fallback minimal si score null: utiliser Fear & Greed pour produire un score on-chain basique
            if (finalComposite.score == null) {
              try {
                const apiBase = globalConfig.get('api_base_url');
                const resp = await fetch(`${apiBase}/api/ml/sentiment/fear-greed?days=1`);
                if (resp.ok) {
                  const data = await resp.json();
                  const latest = (data.fear_greed_data && (data.fear_greed_data[0] || data.fear_greed_data)) || null;
                  const fg = latest?.value ?? latest?.fear_greed_index;
                  if (typeof fg === 'number') {
                    const minimal = {
                      fear_greed_min: { name: 'Fear & Greed', value_numeric: fg, in_critical_zone: fg >= 80 || fg <= 20, raw_value: String(fg) },
                      _metadata: { available_count: 1 }
                    };
                    finalComposite = v2.calculateCompositeScoreV2(minimal, false);
                    console.log('‚úÖ On-Chain fallback (Fear & Greed) used in unified loader');
                  }
                }
              } catch (fe) { console.warn('On-chain FG fallback failed:', fe.message); }
            }

            const onchainData = {
              score: finalComposite.score,
              metadata: {
                categoryBreakdown: finalComposite.categoryBreakdown,
                criticalZoneCount: finalComposite.criticalZoneCount,
                confidence: finalComposite.confidence,
              },
              contradictory_signals: v2.analyzeContradictorySignals(finalComposite.categoryBreakdown)
            };
            
            setCache(CACHE_CONFIG.onchain.key, onchainData);
            
            if (typeof onchainData.score === 'number') {
              store.set('scores.onchain', onchainData.score);
            }
            store.set('scores.onchain_metadata', onchainData.metadata);
            store.set('scores.contradictory_signals', onchainData.contradictory_signals);
            store.set('ui.apiStatus.signals', 'healthy');
            console.log('‚úÖ On-Chain data calculated and cached');
          } catch (e) {
            console.warn('On-chain load failed:', e.message);
            store.set('ui.apiStatus.signals', 'error');
          }
        }

        // 4) Compute blended (decision index) - With cache
        if (isCacheValid(CACHE_CONFIG.blended.key, CACHE_CONFIG.blended.ttl)) {
          console.log('‚úÖ Blended score loaded from cache');
          const blendedData = getCache(CACHE_CONFIG.blended.key);
          store.set('scores.blended', blendedData.score);
          store.set('market.regime', blendedData.regime);
          loadedFromCache++;
        } else {
          try {
            const s = store.snapshot();
            const cycleScore = s.cycle?.score ?? 50;
            const onchainScore = s.scores?.onchain ?? 50;
            const riskScore = s.scores?.risk ?? 50;
            const ocConf = Math.max(0, Math.min(1, s.scores?.onchain_metadata?.confidence ?? 0.5));
            const cycleConf = Math.max(0, Math.min(1, s.cycle?.confidence ?? 0.5));
            const riskAdj = Math.max(0, Math.min(1, (100 - riskScore) / 100));
            const contradictions = (s.scores?.contradictory_signals || []).length;

            // Base weights
            let wCycle = 0.50 * (0.8 + 0.4 * cycleConf);
            let wOnchain = 0.30 * (0.8 + 0.4 * ocConf);
            let wRisk = 0.20 * (0.8 + 0.4 * riskAdj);

            // Penalize if contradictions present (limit to -20%)
            const contraFactor = Math.max(0.8, 1 - 0.1 * contradictions);
            wOnchain *= contraFactor;
            wCycle *= contraFactor;

            // Normalize weights
            const wSum = wCycle + wOnchain + wRisk;
            wCycle = wCycle / wSum;
            wOnchain = wOnchain / wSum;
            wRisk = wRisk / wSum;

            const blended = (cycleScore * wCycle) + (onchainScore * wOnchain) + ((100 - riskScore) * wRisk);
            const blendedScore = Math.round(Math.max(0, Math.min(100, blended)));
            
            // 5) Market Regime (sentiment/r√©gime agr√©g√©)  
            let regimeData = null;
            try {
              const { getRegimeDisplayData } = await import('./modules/market-regimes.js');
              regimeData = getRegimeDisplayData(blendedScore, onchainScore, riskScore);
            } catch (e) { console.warn('Market regime compute failed:', e.message); }
            
            const blendedData = { score: blendedScore, regime: regimeData };
            setCache(CACHE_CONFIG.blended.key, blendedData);
            
            store.set('scores.blended', blendedScore);
            store.set('market.regime', regimeData);
            console.log('‚úÖ Blended score calculated and cached');
          } catch (e) { console.warn('Blended compute failed:', e.message); }
        }
        
        const cacheEfficiency = loadedFromCache > 0 ? `${loadedFromCache}/4 from cache` : 'full calculation';
        console.log(`üéØ Unified data loading completed - ${cacheEfficiency}${loadedFromCache > 0 ? ' ‚ö°' : ''}`);

      } catch (e) {
        console.error('Unified loader fatal:', e);
      }
    }
    // Track data source changes for cache invalidation
    let lastKnownDataSource = globalConfig.get('data_source');
    console.log(`üìä Analytics Unified initialized with data source: ${lastKnownDataSource}`);

    // Listen for data source changes
    window.addEventListener('storage', function(e) {
      const expectedKey = (window.globalConfig?.getStorageKey && window.globalConfig.getStorageKey()) || 'crypto_rebal_settings_v1';
      if (e.key === expectedKey) {
        console.debug('Settings changed in another tab, checking for data source changes...');
        
        const currentSource = globalConfig.get('data_source');
        if (currentSource && currentSource !== lastKnownDataSource) {
          console.debug(`üîÑ Data source changed from ${lastKnownDataSource} to ${currentSource}, clearing cache and reloading...`);
          lastKnownDataSource = currentSource;
          // Clear all cache for this source change
          Object.values(CACHE_CONFIG).forEach(config => {
            const oldKey = getCacheKey(config.key).replace(`_${currentSource}`, `_${lastKnownDataSource || 'unknown'}`);
            localStorage.removeItem(oldKey);
          });
          // Reload with new source
          loadUnifiedData();
        }
      }
    });

    window.addEventListener('dataSourceChanged', (event) => {
      console.debug(`üîÑ Explicit data source change in analytics-unified: ${event.detail.oldSource} ‚Üí ${event.detail.newSource}`);
      lastKnownDataSource = event.detail.newSource;
      // Clear cache and reload
      loadUnifiedData();
    });

    document.addEventListener('DOMContentLoaded', () => {
      // initial paint
      renderUnifiedInsights('unified-root');
      // keep in sync with store changes without over-rendering
      let paintTimer;
      store.subscribe(() => {
        clearTimeout(paintTimer);
        paintTimer = setTimeout(() => renderUnifiedInsights('unified-root'), 250);
      });
      // initial data load
      loadUnifiedData();
    });
  </script>
  <style>
    .wrap {
      max-width: 95vw;
      margin: 0 auto;
      padding: var(--space-lg);
    }

    .tabs {
      display: flex;
      gap: .5rem;
      border-bottom: 1px solid var(--theme-border);
    }

    .tab-btn {
      padding: .6rem .9rem;
      border: 1px solid var(--theme-border);
      background: var(--theme-surface);
      color: var(--theme-text);
      border-radius: var(--radius-sm) var(--radius-sm) 0 0;
      cursor: pointer;
    }

    .tab-btn.active {
      border-color: var(--brand-primary);
      color: var(--brand-primary);
      background: color-mix(in oklab, var(--brand-primary) 10%, transparent);
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    .panel-card {
      background: var(--theme-surface);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-lg);
      padding: var(--space-md);
    }

    .metric-card {
      background: var(--theme-bg);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-md);
      padding: 1rem;
      text-align: center;
    }

    .metric-card h4 {
      margin: 0 0 0.5rem 0;
      font-size: 0.9rem;
      color: var(--theme-text-muted);
      font-weight: 500;
    }

    .metric-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--theme-text);
      margin: 0.5rem 0;
    }

    .metric-card small {
      color: var(--theme-text-muted);
      font-size: 0.8rem;
    }
  </style>
  <script type="module" src="components/tooltips.js"></script>
</head>

<body>
  <div class="wrap">
    <div id="unified-root"></div>
    <div style="height: 1rem;"></div>
    <div class="tabs" id="analytics-tabs">
      <button class="tab-btn active" data-target="#tab-risk">Risk</button>
      <button class="tab-btn" data-target="#tab-performance">Performance</button>
      <button class="tab-btn" data-target="#tab-cycles">Cycles</button>
      <button class="tab-btn" data-target="#tab-monitoring">Monitoring</button>
    </div>
  </div>

  <section class="wrap tab-panel active" id="tab-risk">
    <div class="panel-card">
      <h3>üõ°Ô∏è Risk Dashboard</h3>
      <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
        <div class="metric-card" data-metric="risk-var">
          <h4>Portfolio VaR</h4>
          <div class="metric-value">-2.34%</div>
          <small>95% confidence level</small>
        </div>
        <div class="metric-card" data-metric="risk-drawdown">
          <h4>Max Drawdown</h4>
          <div class="metric-value">-8.12%</div>
          <small>Current cycle</small>
        </div>
        <div class="metric-card" data-metric="risk-volatility">
          <h4>Volatility</h4>
          <div class="metric-value">24.6%</div>
          <small>30-day annualized</small>
        </div>
        <div class="metric-card" data-metric="risk-score">
          <h4>Risk Score</h4>
          <div class="metric-value">--/100</div>
          <small>Unknown</small>
        </div>
      </div>
      <!-- Scores cl√©s du Risk Dashboard (version compl√®te) -->
      <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-top: 1rem;">
        <div class="metric-card" data-metric="risk-kpi-diversification">
          <h4>Diversification Ratio</h4>
          <div class="metric-value">--</div>
          <small>Corr√©lation de portefeuille</small>
        </div>
        <div class="metric-card" data-metric="risk-kpi-effective-assets">
          <h4>Effective Assets</h4>
          <div class="metric-value">--</div>
          <small>Actifs non-redondants</small>
        </div>
        <div class="metric-card" data-metric="risk-kpi-blended">
          <h4>Score D√©cisionnel</h4>
          <div class="metric-value">--</div>
          <small>CCS √ó Cycle (synth√®se)</small>
        </div>
        <div class="metric-card" data-metric="risk-kpi-onchain">
          <h4>On-Chain Composite</h4>
          <div class="metric-value">--</div>
          <small>Fondamentaux on-chain</small>
        </div>
      </div>
      <div style="margin-top: 2rem; padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-md);">
        <h4>Risk Alerts</h4>
        <div style="color: var(--theme-text-muted);">‚Ä¢ Portfolio concentration within acceptable limits</div>
        <div style="color: var(--theme-text-muted);">‚Ä¢ Correlation risk moderate for current market conditions</div>
        <div style="color: var(--theme-text-muted);">‚Ä¢ No significant exposure warnings</div>
      </div>
      <div style="text-align: center; margin-top: 1.5rem;">
        <a href="risk-dashboard.html?nav=off" target="_blank"
          style="display: inline-block; background: var(--brand-primary); color: white; padding: 0.75rem 1.5rem; border-radius: var(--radius-md); text-decoration: none; font-weight: 600;">
          üìä Version compl√®te du Risk Dashboard
        </a>
      </div>
    </div>
  </section>
  <section class="wrap tab-panel" id="tab-performance">
    <div class="panel-card">
      <h3>üìä Performance Monitor</h3>
      <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
        <div class="metric-card" data-metric="perf-cache-size">
          <h4>Memory Cache Size</h4>
          <div class="metric-value">--</div>
          <small>Memory cache entries</small>
        </div>
        <div class="metric-card" data-metric="perf-disk-cache">
          <h4>Disk Cache Usage</h4>
          <div class="metric-value">-- MB</div>
          <small>Disk cache usage</small>
        </div>
        <div class="metric-card" data-metric="perf-memory">
          <h4>Process Memory</h4>
          <div class="metric-value">-- MB</div>
          <small>Process memory</small>
        </div>
        <div class="metric-card" data-metric="perf-system-memory">
          <h4>System Memory Usage</h4>
          <div class="metric-value">--%</div>
          <small>System memory usage</small>
        </div>
      </div>
      <div style="margin-top: 2rem; padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-md);">
        <h4>System Performance</h4>
        <div style="display: grid; gap: 0.5rem;">
          <div style="display: flex; justify-content: space-between;"><span>Memory Cache Hit Rate:</span><span
              style="color: var(--success);">--%</span></div>
          <div style="display: flex; justify-content: space-between;"><span>Available Memory:</span><span>-- GB</span>
          </div>
          <div style="display: flex; justify-content: space-between;"><span>Process Efficiency:</span><span>--</span>
          </div>
        </div>
      </div>
      <div style="text-align: center; margin-top: 1.5rem;">
        <a href="performance-monitor.html?nav=off" target="_blank"
          style="display: inline-block; background: var(--brand-primary); color: white; padding: 0.75rem 1.5rem; border-radius: var(--radius-md); text-decoration: none; font-weight: 600;">
          üìà Version compl√®te du Performance Monitor
        </a>
      </div>
    </div>
  </section>
  <section class="wrap tab-panel" id="tab-cycles">
    <div class="panel-card">
      <h3>üîÑ Cycle Analysis</h3>
      <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
        <div class="metric-card" data-metric="cycle-phase">
          <h4>Current Phase</h4>
          <div class="metric-value">--</div>
          <small>Current phase</small>
        </div>
        <div class="metric-card" data-metric="cycle-progress">
          <h4>Post-Halving Progress</h4>
          <div class="metric-value">-- months</div>
          <small>Post-halving progress</small>
        </div>
        <div class="metric-card" data-metric="cycle-score">
          <h4>Cycle Score</h4>
          <div class="metric-value">--</div>
          <small>Cycle position score</small>
        </div>
        <div class="metric-card" data-metric="cycle-confidence">
          <h4>Confidence</h4>
          <div class="metric-value">--%</div>
          <small>Model certainty</small>
        </div>
      </div>
      <div style="margin-top: 2rem; padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-md);">
        <h4>Market Cycle Indicators</h4>
        <div style="display: grid; gap: 0.5rem;">
          <div style="display: flex; justify-content: space-between;"><span>Fear & Greed Index:</span><span>45
              (Neutral)</span></div>
          <div style="display: flex; justify-content: space-between;"><span>RSI (Weekly):</span><span>58
              (Neutral)</span></div>
          <div style="display: flex; justify-content: space-between;"><span>MVRV Ratio:</span><span>2.1
              (Accumulation)</span></div>
        </div>
      </div>
      <div style="text-align: center; margin-top: 1.5rem;">
        <a href="cycle-analysis.html?nav=off" target="_blank"
          style="display: inline-block; background: var(--brand-primary); color: white; padding: 0.75rem 1.5rem; border-radius: var(--radius-md); text-decoration: none; font-weight: 600;">
          üîÑ Version compl√®te du Cycle Analysis
        </a>
      </div>
    </div>
  </section>
  <section class="wrap tab-panel" id="tab-monitoring">
    <div class="panel-card">
      <h3>üìà Advanced Analytics</h3>
      <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
        <div class="metric-card" data-metric="monitor-total-return">
          <h4>Total Return</h4>
          <div class="metric-value">--%</div>
          <small>Sur la p√©riode</small>
        </div>
        <div class="metric-card" data-metric="monitor-sharpe">
          <h4>Sharpe Ratio</h4>
          <div class="metric-value">--</div>
          <small>Risque ajust√©</small>
        </div>
        <div class="metric-card" data-metric="monitor-volatility">
          <h4>Volatility</h4>
          <div class="metric-value">--%</div>
          <small>Risque de march√©</small>
        </div>
        <div class="metric-card" data-metric="monitor-drawdown">
          <h4>Max Drawdown</h4>
          <div class="metric-value">--%</div>
          <small>Pire baisse</small>
        </div>
      </div>
      <div style="margin-top: 2rem; padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-md);">
        <h4>Advanced Metrics</h4>
        <div id="advanced-metrics-breakdown" style="display: grid; gap: 0.5rem;"></div>
      </div>
      <div style="text-align: center; margin-top: 1.5rem;">
        <a href="advanced-analytics.html?nav=off" target="_blank"
          style="display: inline-block; background: var(--brand-primary); color: white; padding: 0.75rem 1.5rem; border-radius: var(--radius-md); text-decoration: none; font-weight: 600;">üìà
          Version compl√®te des Advanced Analytics</a>
      </div>
    </div>
  </section>
</body>

</html>
