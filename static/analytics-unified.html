<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics Unifi√©s - Crypto Rebalancer</title>
  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">
  <link rel="stylesheet" href="components/governance-panel.css">
  <link rel="stylesheet" href="components/decision-index-panel.css?v=20251015fixed">
  <!-- IMPORTANT: analytics-unified-theme.css EN DERNIER pour surcharger le DI Panel -->
  <link rel="stylesheet" href="analytics-unified-theme.css?v=20251022v7">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script>
    // ‚úÖ Enregistrement datalabels (idempotent)
    if (window.Chart && window.ChartDataLabels && !window.__di_dl_registered__) {
      window.Chart.register(window.ChartDataLabels);
      // ‚úÖ D√©sactiver globalement, puis r√©activer seulement sur barre empil√©e
      window.Chart.defaults.set('plugins.datalabels', { display: false });
      window.__di_dl_registered__ = true;
      console.debug('‚úÖ chartjs-plugin-datalabels registered (global display: false)');
    }

    // ‚úÖ Enregistrement annotation plugin pour Bitcoin regime events
    if (window.Chart && window.ChartAnnotation && !window.__di_annotation_registered__) {
      window.Chart.register(window.ChartAnnotation);
      window.__di_annotation_registered__ = true;
      console.debug('‚úÖ chartjs-plugin-annotation registered');
    }
  </script>
  <script src="debug-logger.js"></script>
  <script src="global-config.js"></script>
  <script src="appearance.js"></script>
  <script type="module" src="components/nav.js"></script>
  <script type="module" src="analytics-unified.js"></script>
  <script type="module">
    import { initDeepLinks } from './components/deep-links.js';
    import {
      selectContradiction01,
      selectEffectiveCap,
      selectGovernanceTimestamp
    } from './selectors/governance.js';

    // Rendre les s√©lecteurs accessibles globalement
    window.selectContradiction01 = selectContradiction01;
    window.selectEffectiveCap = selectEffectiveCap;
    window.selectGovernanceTimestamp = selectGovernanceTimestamp;

    // Ancres pour analytics-unified.html - pointent vers le contenu r√©el
    initDeepLinks({
      'unified-root': 'Analytics Unifi√©s',
      'tab-intelligence-ml': 'Intelligence ML',
      'tab-risk': 'Risk Dashboard',
      'tab-performance': 'Performance Monitor',
      'tab-cycles': 'Cycle Analysis',
      'tab-monitoring': 'Advanced Analytics'
    });
  </script>
  <script type="module" src="modules/analytics-unified-main-controller.js"></script>

  <!-- Risk Dashboard Store + Calculation Modules (for flyout panel parity) -->
  <!-- global-config.js already loaded in head, don't reload -->
  <script type="module" src="core/risk-dashboard-store.js"></script>
  <script type="module" src="core/fetcher.js"></script>
  <script type="module" src="modules/signals-engine.js"></script>
  <script type="module" src="modules/cycle-navigator.js"></script>
  <script type="module" src="modules/onchain-indicators.js"></script>
  <script type="module" src="modules/market-regimes.js"></script>
  <script type="module" src="modules/targets-coordinator.js"></script>
  <script type="module" src="core/risk-data-orchestrator.js?v=20251022fix"></script>
</head>

<body>
  <div id="backend-fallback-banner"
    style="display:none; background: color-mix(in oklab, var(--warning) 20%, transparent); border: 1px solid var(--warning); color: var(--theme-text); padding: .6rem; margin: .5rem auto; max-width: 95vw; border-radius: 6px;">
    ‚ö† Backend indisponible ‚Äî mode prudent (cap r√©duit).
  </div>
  <div class="wrap">
    <!-- Governance Panel -->
    <div id="governance-container"></div>

    <div id="unified-root"></div>

    <!-- Tabs connect√©s directement aux panels -->
    <div class="tabs" id="analytics-tabs">
      <button class="tab-btn active" data-target="#tab-risk">Risk</button>
      <button class="tab-btn" data-target="#tab-performance">Performance</button>
      <button class="tab-btn" data-target="#tab-cycles">Cycles</button>
      <button class="tab-btn" data-target="#tab-monitoring">Monitoring</button>
      <button class="tab-btn" data-target="#tab-intelligence-ml">ü§ñ Intelligence ML</button>
      <button class="btn-refresh" id="manual-refresh-onchain" title="Forcer le rafra√Æchissement des indicateurs on-chain">üîÑ Actualiser</button>
    </div>

    <!-- Tab Panels -->
    <section class="tab-panel active" id="tab-risk">
    <div class="panel-card">
      <h3>üõ°Ô∏è Risk Dashboard</h3>
      <div class="metrics-grid-250">
        <div class="metric-card" data-metric="risk-var">
          <h4>VaR Portfolio</h4>
          <div class="metric-value" id="risk-var-value">--</div>
          <small>Niveau de confiance 95%</small>
        </div>
        <div class="metric-card" data-metric="risk-drawdown">
          <h4>Drawdown Maximum</h4>
          <div class="metric-value" id="risk-drawdown-value">--</div>
          <small>Cycle actuel</small>
        </div>
        <div class="metric-card" data-metric="risk-volatility">
          <h4>Volatilit√©</h4>
          <div class="metric-value" id="risk-volatility-value">--</div>
          <small>Annualis√©e 30 jours</small>
        </div>
        <div class="metric-card" data-metric="risk-score">
          <h4>Score de Risque</h4>
          <div class="metric-value" id="risk-score-value">--/100</div>
          <small>Inconnu</small>
        </div>
      </div>
      <!-- Scores cl√©s du Risk Dashboard (version compl√®te) -->
      <div class="metrics-grid-220">
        <div class="metric-card" data-metric="risk-kpi-diversification">
          <h4>Diversification Ratio</h4>
          <div class="metric-value">--</div>
          <small>Corr√©lation de portefeuille</small>
        </div>
        <div class="metric-card" data-metric="risk-kpi-effective-assets">
          <h4>Effective Assets</h4>
          <div class="metric-value">--</div>
          <small>Actifs non-redondants</small>
        </div>
        <div class="metric-card" data-metric="risk-kpi-blended">
          <h4>Score D√©cisionnel</h4>
          <div class="metric-value">--</div>
          <small>CCS √ó Cycle (synth√®se)</small>
        </div>
        <div class="metric-card" data-metric="risk-kpi-onchain">
          <h4>On-Chain Composite</h4>
          <div class="metric-value" id="risk-kpi-onchain-value">--</div>
          <small>Fondamentaux on-chain</small>
        </div>
      </div>
      <div class="info-section">
        <h4>Alertes Risque</h4>
        <div class="info-section-content">
          <div class="info-list-item">‚Ä¢ Concentration du portefeuille dans les limites acceptables</div>
          <div class="info-list-item">‚Ä¢ Risque de corr√©lation mod√©r√© pour les conditions actuelles</div>
          <div class="info-list-item">‚Ä¢ Aucune alerte d'exposition significative</div>
        </div>
      </div>
      <div class="actions-row">
        <a href="risk-dashboard.html?nav=off" target="_blank" class="action-link">
          üìä Version compl√®te du Risk Dashboard
        </a>
        <a href="simulations.html?nav=off" target="_blank" class="action-link action-link--success">
          üß™ Simulateur Pipeline Complet
        </a>
      </div>
      </div>
    </section>
    <section class="tab-panel" id="tab-performance">
    <div class="panel-card">
      <h3>üìä Performance Monitor</h3>
      <div class="metrics-grid-250">
        <div class="metric-card" data-metric="perf-cache-size">
          <h4>Taille Cache M√©moire</h4>
          <div class="metric-value">--</div>
          <small>Entr√©es en cache</small>
        </div>
        <div class="metric-card" data-metric="perf-disk-cache">
          <h4>Utilisation Cache Disque</h4>
          <div class="metric-value">-- MB</div>
          <small>Usage disque</small>
        </div>
        <div class="metric-card" data-metric="perf-memory">
          <h4>M√©moire Processus</h4>
          <div class="metric-value">-- MB</div>
          <small>M√©moire processus</small>
        </div>
        <div class="metric-card" data-metric="perf-system-memory">
          <h4>Utilisation M√©moire Syst√®me</h4>
          <div class="metric-value">--%</div>
          <small>M√©moire syst√®me</small>
        </div>
      </div>
      <div class="info-section">
        <h4>Performance Syst√®me</h4>
        <div class="info-section-content">
          <div class="info-item"><span>Taux de r√©ussite cache:</span><span class="text-positive">--%</span></div>
          <div class="info-item"><span>M√©moire disponible:</span><span>-- GB</span></div>
          <div class="info-item"><span>Efficacit√© processus:</span><span>--</span></div>
        </div>
      </div>
      <div class="actions-row">
        <a href="performance-monitor-unified.html" target="_blank" class="action-link">
          üìà Performance Monitor Unifi√© (Nouveau)
        </a>
      </div>
      </div>
    </section>
    <section class="tab-panel" id="tab-cycles">
    <div class="panel-card">
      <h3>üîÑ Cycle Analysis</h3>
      <div class="metrics-grid-250">
        <div class="metric-card" data-metric="cycle-phase">
          <h4>Phase Actuelle</h4>
          <div class="metric-value">--</div>
          <small>Phase courante</small>
        </div>
        <div class="metric-card" data-metric="cycle-progress">
          <h4>Progr√®s Post-Halving</h4>
          <div class="metric-value">-- mois</div>
          <small>Progression depuis halving</small>
        </div>
        <div class="metric-card" data-metric="cycle-score">
          <h4>Score de Cycle</h4>
          <div class="metric-value">--</div>
          <small>Position dans le cycle</small>
        </div>
        <div class="metric-card" data-metric="cycle-confidence">
          <h4>Confiance</h4>
          <div class="metric-value">--%</div>
          <small>Certitude du mod√®le</small>
        </div>
      </div>
      <div class="info-section">
        <h4>Market Cycle Indicators</h4>
        <div class="info-section-content" style="text-align: center; padding: 1rem;">
          üìä Indicateurs disponibles via l'API ML<br>
          <small class="text-subtle">Fear & Greed, RSI, MVRV Ratio</small>
          <!-- TODO: Connecter aux endpoints ML r√©els:
               - Fear & Greed: /api/ml/sentiment/fear-greed
               - RSI: √Ä impl√©menter via technical indicators
               - MVRV: √Ä impl√©menter via on-chain metrics
          -->
        </div>
      </div>
      <div class="actions-row">
        <a href="cycle-analysis.html?nav=off" target="_blank" class="action-link">
          üîÑ Version compl√®te du Cycle Analysis
        </a>
      </div>
      </div>
    </section>
    <section class="tab-panel" id="tab-monitoring">
    <div class="panel-card">
      <h3>üìà Advanced Analytics</h3>
      <div class="metrics-grid-250">
        <div class="metric-card" data-metric="monitor-total-return">
          <h4>Rendement Total</h4>
          <div class="metric-value">--%</div>
          <small>Sur la p√©riode</small>
        </div>
        <div class="metric-card" data-metric="monitor-sharpe">
          <h4>Ratio de Sharpe</h4>
          <div class="metric-value">--</div>
          <small>Risque ajust√©</small>
        </div>
        <div class="metric-card" data-metric="monitor-volatility">
          <h4>Volatilit√©</h4>
          <div class="metric-value">--%</div>
          <small>Risque de march√©</small>
        </div>
        <div class="metric-card" data-metric="monitor-drawdown">
          <h4>Drawdown Max</h4>
          <div class="metric-value">--%</div>
          <small>Pire baisse</small>
        </div>
      </div>
      <div class="info-section">
        <h4>M√©triques Avanc√©es</h4>
        <div id="advanced-metrics-breakdown" class="info-section-content"></div>
      </div>
      <div class="actions-row">
        <a href="performance-monitor-unified.html" target="_blank" class="action-link">
          üìä Performance Monitor Unifi√©
        </a>
      </div>
      </div>
    </section>

    <!-- Intelligence ML Tab Panel -->
    <section class="tab-panel" id="tab-intelligence-ml">
    <div class="panel-card">
      <h3>ü§ñ Intelligence ML - Vue Analyse Compl√®te</h3>
      <p>
        Analyse d√©taill√©e des mod√®les ML, pr√©dictions temps r√©el et administration avanc√©e
      </p>

      <!-- Stats ML Globales -->
      <div class="ml-stats-section">
        <h4>üìä Statistiques ML Globales</h4>
        <div class="metrics-grid-200">
          <div class="metric-card">
            <h5>Mod√®les Actifs</h5>
            <div class="metric-value" id="ml-active-models">--/4</div>
            <small>Mod√®les charg√©s</small>
          </div>
          <div class="metric-card">
            <h5>Confiance Moyenne</h5>
            <div class="metric-value" id="ml-avg-confidence">--%</div>
            <small>Niveau de confiance</small>
          </div>
          <div class="metric-card">
            <h5>Derni√®re Mise √† Jour</h5>
            <div class="metric-value" id="ml-last-update">--</div>
            <small>Status ML</small>
          </div>
        </div>
      </div>

      <!-- Vue Mod√®les D√©taill√©e -->
      <div class="ml-models-section">
        <h4>üß† Sant√© des Mod√®les</h4>
        <div class="metrics-grid-250">
          <div class="metric-card">
            <h5>üåä Volatility LSTM</h5>
            <div class="metric-value" id="ml-vol-model-status">‚ö™ Unknown</div>
            <small id="ml-vol-model-details">Statut du mod√®le</small>
          </div>
          <div class="metric-card">
            <h5>üîÑ Regime HMM</h5>
            <div class="metric-value" id="ml-regime-model-status">‚ö™ Unknown</div>
            <small id="ml-regime-model-details">Statut du mod√®le</small>
          </div>
          <div class="metric-card">
            <h5>üîó Correlation Transformer</h5>
            <div class="metric-value" id="ml-corr-model-status">‚ö™ Unknown</div>
            <small id="ml-corr-model-details">Statut du mod√®le</small>
          </div>
          <div class="metric-card">
            <h5>üí≠ Sentiment Composite</h5>
            <div class="metric-value" id="ml-sent-model-status">‚ö™ Unknown</div>
            <small id="ml-sent-model-details">Statut du mod√®le</small>
          </div>
        </div>
      </div>

      <!-- Pr√©dictions Temps R√©el -->
      <div class="ml-predictions-section">
        <h4>üîÆ Pr√©dictions Temps R√©el</h4>
        <div id="ml-predictions-container">
          <div class="prediction-grid metrics-grid-250">
            <!-- Volatilit√© -->
            <div class="metric-card" data-metric="ml-volatility-btc">
              <h5>BTC Volatilit√© 24h</h5>
              <div class="metric-value" id="ml-vol-btc">--</div>
              <small>Pr√©diction LSTM</small>
            </div>
            <div class="metric-card" data-metric="ml-volatility-eth">
              <h5>ETH Volatilit√© 24h</h5>
              <div class="metric-value" id="ml-vol-eth">--</div>
              <small>Pr√©diction LSTM</small>
            </div>
            <!-- R√©gimes -->
            <div class="metric-card" data-metric="ml-regime">
              <h5>R√©gime March√©</h5>
              <div class="metric-value" id="ml-regime">--</div>
              <small>Classification HMM</small>
            </div>
            <!-- Sentiment -->
            <div class="metric-card" data-metric="ml-sentiment">
              <h5>ML Sentiment</h5>
              <div class="metric-value" id="ml-sentiment">--</div>
              <small>Sentiment ML Agr√©g√©</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Administration ML (repliable, RBAC protected) -->
      <details class="ml-admin-section">
        <summary class="ml-admin-summary">
          üîß Administration ML (Admin Only)
        </summary>
        <div class="ml-admin-content">
          <div id="ml-admin-ops-container"></div>

          <!-- Actions Admin -->
          <div class="admin-actions">
            <button class="btn secondary" id="btn-retrain">
              üîÑ Retrain Models
            </button>
            <button class="btn secondary" id="btn-clear-cache">
              üóëÔ∏è Clear Cache
            </button>
            <button class="btn secondary" id="btn-logs">
              üì• Download Logs
            </button>
            <button class="btn secondary" id="btn-debug">
              üîç Debug Info
            </button>
          </div>

          <!-- ML Pipeline Status -->
          <div class="ml-pipeline-status">
            <h5>Pipeline Status</h5>
            <div id="ml-pipeline-container">
              Loading pipeline status...
            </div>
          </div>
        </div>
      </details>

      <!-- Lien vers Command Center -->
      <div class="actions-row">
        <a href="ai-dashboard.html" target="_blank" class="action-link">
          ü§ñ Ouvrir ML Command Center (Vue Ops)
        </a>
      </div>

      </div>
    </section>

  </div><!-- Fin du wrap principal -->

  <script type="module" src="modules/analytics-unified-tabs-controller.js"></script>

  <!-- Unified Risk Flyout Panel (Full Sidebar) -->
  <script type="module" src="components/flyout-panel.js"></script>
  <script type="module" src="components/risk-sidebar-full.js"></script>
  <script type="module">
    // Adapter le layout quand la sidebar est √©pingl√©e
    import { enableFlyoutLayoutAdapter } from './components/flyout-layout-adapter.js';
    enableFlyoutLayoutAdapter('.wrap'); // D√©caler uniquement le contenu, pas le menu
  </script>

  <flyout-panel position="left" width="340" persist-key="analytics_flyout">
    <span slot="title">üéØ Risk Dashboard</span>
    <risk-sidebar-full slot="content" poll-ms="0"></risk-sidebar-full>
  </flyout-panel>

</body>

</html>