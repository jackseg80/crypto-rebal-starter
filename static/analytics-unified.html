<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics Unifi√©s - Crypto Rebalancer</title>
  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">
  <link rel="stylesheet" href="components/governance-panel.css">
  <script src="global-config.js"></script>
  <script src="appearance.js"></script>
  <script type="module" src="components/nav.js"></script>
  <script type="module" src="analytics-unified.js"></script>
  <script type="module">
    import { initDeepLinks } from './components/deep-links.js';
    // Ancres pour analytics-unified.html : #unified #ml #cycles #performance #monitoring
    initDeepLinks({
      'unified': 'Analytics Unifi√©s',
      'ml': 'Machine Learning',
      'cycles': 'Analyse des Cycles',
      'performance': 'Performance',
      'monitoring': 'Monitoring'
    });
  </script>
  <script type="module">
    import { renderUnifiedInsights } from './components/UnifiedInsights.js';
    import { store } from './core/risk-dashboard-store.js';
    import { GovernancePanel } from './components/GovernancePanel.js';
    
    // INTELLIGENT CACHE SYSTEM - Avoid constant recalculations
    const CACHE_CONFIG = {
      risk: { ttl: 5 * 60 * 1000, key: 'analytics_unified_risk' },      // 5 minutes
      cycle: { ttl: 60 * 60 * 1000, key: 'analytics_unified_cycle' },    // 1 hour  
      onchain: { ttl: 10 * 60 * 1000, key: 'analytics_unified_onchain' }, // 10 minutes
      blended: { ttl: 2 * 60 * 1000, key: 'analytics_unified_blended' }   // 2 minutes
    };

    // Generate cache key that includes data source to invalidate on source change
    function getCacheKey(baseKey) {
      const dataSource = globalConfig.get('data_source') || 'unknown';
      return `${baseKey}_${dataSource}`;
    }
    
    function isCacheValid(cacheKey, ttl) {
      try {
        const fullKey = getCacheKey(cacheKey);
        const cached = localStorage.getItem(fullKey);
        if (!cached) return false;
        const data = JSON.parse(cached);
        return Date.now() - data.timestamp < ttl;
      } catch { return false; }
    }
    
    function setCache(cacheKey, data) {
      try {
        const fullKey = getCacheKey(cacheKey);
        localStorage.setItem(fullKey, JSON.stringify({ data, timestamp: Date.now() }));
      } catch {}
    }
    
    function getCache(cacheKey) {
      try {
        const fullKey = getCacheKey(cacheKey);
        const cached = localStorage.getItem(fullKey);
        return cached ? JSON.parse(cached).data : null;
      } catch { return null; }
    }
    
    // Update badges with current analytics data
    function updateAnalyticsBadges() {
      if (!window.analyticsBadges) return;

      try {
        const now = new Date();

        // Risk badge
        const riskData = store.get('risk');
        const riskScore = store.get('scores.risk');
        const riskStatus = store.get('ui.apiStatus.backend') === 'healthy' ? 'ok' : 'error';

        if (window.analyticsBadges.risk) {
          window.analyticsBadges.risk.updateData({
            source: 'Risk API',
            updated: now,
            contradiction: Math.round((riskData?.correlations?.average_correlation || 0.3) * 100),
            status: riskStatus
          });
        }

        // Performance badge
        const performance = store.get('performance') || {};
        if (window.analyticsBadges.performance) {
          window.analyticsBadges.performance.updateData({
            source: 'Performance',
            updated: now,
            contradiction: Math.round((performance.volatility || 0.15) * 100),
            status: 'ok'
          });
        }

        // Intelligence badge
        const mlStatus = store.get('ml.status') || {};
        const intelligenceStatus = mlStatus.ready ? 'ok' : 'stale';

        if (window.analyticsBadges.intelligence) {
          window.analyticsBadges.intelligence.updateData({
            source: 'ML Engine',
            updated: now,
            status: intelligenceStatus
          });
        }

        console.log('üè∑Ô∏è Analytics badges updated');
      } catch (error) {
        console.warn('Badge update failed:', error);
      }
    }

    // Lightweight unified data loader with INTELLIGENT CACHING
    async function loadUnifiedData() {
      console.log('üß† Loading unified data with intelligent caching...');
      let loadedFromCache = 0;
      
      try {
        const priceDays = 365, corrDays = 90;
        
        // 1) Risk (backend) - With cache
        if (isCacheValid(CACHE_CONFIG.risk.key, CACHE_CONFIG.risk.ttl)) {
          console.log('‚úÖ Risk data loaded from cache');
          const riskData = getCache(CACHE_CONFIG.risk.key);
          store.set('risk', riskData);
          const rs = riskData?.risk_metrics?.risk_score;
          if (typeof rs === 'number') store.set('scores.risk', rs);
          store.set('ui.apiStatus.backend', 'healthy');
          loadedFromCache++;
        } else {
          try {
            const minUsd = globalConfig.get('min_usd_threshold');
            const riskUrl = globalConfig.getApiUrl('/api/risk/dashboard', { price_history_days: priceDays, lookback_days: corrDays, min_usd: minUsd });
            console.log(`üîç Fetching risk data from: ${riskUrl} (source: ${globalConfig.get('data_source')})`);
            const r = await fetch(riskUrl);
            if (r.ok) {
              const riskData = await r.json();
              setCache(CACHE_CONFIG.risk.key, riskData);
              store.set('risk', riskData);
              const rs = riskData?.risk_metrics?.risk_score;
              if (typeof rs === 'number') store.set('scores.risk', rs);
              store.set('ui.apiStatus.backend', 'healthy');
              console.log('‚úÖ Risk data fetched and cached');
            } else {
              store.set('ui.apiStatus.backend', 'error');
            }
          } catch (_) { store.set('ui.apiStatus.backend', 'error'); }

        }
        
        // 2) Cycle (client-side) - With cache
        if (isCacheValid(CACHE_CONFIG.cycle.key, CACHE_CONFIG.cycle.ttl)) {
          console.log('‚úÖ Cycle data loaded from cache');
          const cycleData = getCache(CACHE_CONFIG.cycle.key);
          store.set('cycle.months', cycleData.months);
          store.set('cycle.score', cycleData.score);
          store.set('cycle.phase', cycleData.phase);
          loadedFromCache++;
        } else {
          try {
            const { getCurrentCycleMonths, cycleScoreFromMonths, getCyclePhase } = await import('./modules/cycle-navigator.js');
            const c = getCurrentCycleMonths();
            const score = Math.round(cycleScoreFromMonths(c.months));
            const phase = getCyclePhase(c.months);
            const cycleData = { months: c.months, score, phase };
            setCache(CACHE_CONFIG.cycle.key, cycleData);
            store.set('cycle.months', c.months);
            store.set('cycle.score', score);
            store.set('cycle.phase', phase);
            console.log('‚úÖ Cycle data calculated and cached');
          } catch (e) { console.warn('Cycle data load failed:', e.message); }
        }

        // 3) On-Chain (via scraper/proxy) - With cache
        if (isCacheValid(CACHE_CONFIG.onchain.key, CACHE_CONFIG.onchain.ttl)) {
          console.log('‚úÖ On-Chain data loaded from cache');
          const onchainData = getCache(CACHE_CONFIG.onchain.key);
          if (typeof onchainData.score === 'number') {
            store.set('scores.onchain', onchainData.score);
          }
          store.set('scores.onchain_metadata', onchainData.metadata);
          store.set('scores.contradictory_signals', onchainData.contradictory_signals);
          store.set('ui.apiStatus.signals', 'healthy');
          loadedFromCache++;
        } else {
          try {
            const onchain = await import('./modules/onchain-indicators.js');
            const v2 = await import('./modules/composite-score-v2.js');
            const indicators = await onchain.fetchAllIndicators();
            const dyn = localStorage.getItem('enable_dynamic_weighting') === 'true';
            const composite = v2.calculateCompositeScoreV2(indicators, dyn);
            
            let finalComposite = composite;
            // Fallback minimal si score null: utiliser Fear & Greed pour produire un score on-chain basique
            if (finalComposite.score == null) {
              try {
                const apiBase = globalConfig.get('api_base_url');
                const resp = await fetch(`${apiBase}/api/ml/sentiment/fear-greed?days=1`);
                if (resp.ok) {
                  const data = await resp.json();
                  const latest = (data.fear_greed_data && (data.fear_greed_data[0] || data.fear_greed_data)) || null;
                  const fg = latest?.value ?? latest?.fear_greed_index;
                  if (typeof fg === 'number') {
                    const minimal = {
                      fear_greed_min: { name: 'Fear & Greed', value_numeric: fg, in_critical_zone: fg >= 80 || fg <= 20, raw_value: String(fg) },
                      _metadata: { available_count: 1 }
                    };
                    finalComposite = v2.calculateCompositeScoreV2(minimal, false);
                    console.log('‚úÖ On-Chain fallback (Fear & Greed) used in unified loader');
                  }
                }
              } catch (fe) { console.warn('On-chain FG fallback failed:', fe.message); }
            }

            const onchainData = {
              score: finalComposite.score,
              metadata: {
                categoryBreakdown: finalComposite.categoryBreakdown,
                criticalZoneCount: finalComposite.criticalZoneCount,
                confidence: finalComposite.confidence,
              },
              contradictory_signals: v2.analyzeContradictorySignals(finalComposite.categoryBreakdown)
            };
            
            setCache(CACHE_CONFIG.onchain.key, onchainData);
            
            if (typeof onchainData.score === 'number') {
              store.set('scores.onchain', onchainData.score);
            }
            store.set('scores.onchain_metadata', onchainData.metadata);
            store.set('scores.contradictory_signals', onchainData.contradictory_signals);
            store.set('ui.apiStatus.signals', 'healthy');
            console.log('‚úÖ On-Chain data calculated and cached');
          } catch (e) {
            console.warn('On-chain load failed:', e.message);
            store.set('ui.apiStatus.signals', 'error');
          }
        }

        // 4) Compute blended (decision index) - With cache
        if (isCacheValid(CACHE_CONFIG.blended.key, CACHE_CONFIG.blended.ttl)) {
          console.log('‚úÖ Blended score loaded from cache');
          const blendedData = getCache(CACHE_CONFIG.blended.key);
          store.set('scores.blended', blendedData.score);
          store.set('market.regime', blendedData.regime);
          loadedFromCache++;
        } else {
          try {
            const s = store.snapshot();
            const cycleScore = s.cycle?.score ?? 50;
            const onchainScore = s.scores?.onchain ?? 50;
            const riskScore = s.scores?.risk ?? 50;
            const ocConf = Math.max(0, Math.min(1, s.scores?.onchain_metadata?.confidence ?? 0.5));
            const cycleConf = Math.max(0, Math.min(1, s.cycle?.confidence ?? 0.5));
            const riskAdj = Math.max(0, Math.min(1, (100 - riskScore) / 100));
            const contradictions = (s.scores?.contradictory_signals || []).length;

            // Base weights
            let wCycle = 0.50 * (0.8 + 0.4 * cycleConf);
            let wOnchain = 0.30 * (0.8 + 0.4 * ocConf);
            let wRisk = 0.20 * (0.8 + 0.4 * riskAdj);

            // Penalize if contradictions present (limit to -20%)
            const contraFactor = Math.max(0.8, 1 - 0.1 * contradictions);
            wOnchain *= contraFactor;
            wCycle *= contraFactor;

            // Normalize weights
            const wSum = wCycle + wOnchain + wRisk;
            wCycle = wCycle / wSum;
            wOnchain = wOnchain / wSum;
            wRisk = wRisk / wSum;

            const blended = (cycleScore * wCycle) + (onchainScore * wOnchain) + ((100 - riskScore) * wRisk);
            const blendedScore = Math.round(Math.max(0, Math.min(100, blended)));
            
            // 5) Market Regime (sentiment/r√©gime agr√©g√©)  
            let regimeData = null;
            try {
              const { getRegimeDisplayData } = await import('./modules/market-regimes.js');
              regimeData = getRegimeDisplayData(blendedScore, onchainScore, riskScore);
            } catch (e) { console.warn('Market regime compute failed:', e.message); }
            
            const blendedData = { score: blendedScore, regime: regimeData };
            setCache(CACHE_CONFIG.blended.key, blendedData);
            
            store.set('scores.blended', blendedScore);
            store.set('market.regime', regimeData);
            console.log('‚úÖ Blended score calculated and cached');
          } catch (e) { console.warn('Blended compute failed:', e.message); }
        }
        
        const cacheEfficiency = loadedFromCache > 0 ? `${loadedFromCache}/4 from cache` : 'full calculation';
        console.log(`üéØ Unified data loading completed - ${cacheEfficiency}${loadedFromCache > 0 ? ' ‚ö°' : ''}`);

        // Update badges with latest data
        updateAnalyticsBadges();

      } catch (e) {
        console.error('Unified loader fatal:', e);
      }
    }
    // Track data source changes for cache invalidation
    let lastKnownDataSource = globalConfig.get('data_source');
    console.log(`üìä Analytics Unified initialized with data source: ${lastKnownDataSource}`);

    // Listen for data source changes
    window.addEventListener('storage', function(e) {
      const expectedKey = (window.globalConfig?.getStorageKey && window.globalConfig.getStorageKey()) || 'crypto_rebal_settings_v1';
      if (e.key === expectedKey) {
        console.debug('Settings changed in another tab, checking for data source changes...');
        
        const currentSource = globalConfig.get('data_source');
        if (currentSource && currentSource !== lastKnownDataSource) {
          console.debug(`üîÑ Data source changed from ${lastKnownDataSource} to ${currentSource}, clearing cache and reloading...`);
          lastKnownDataSource = currentSource;
          // Clear all cache for this source change
          Object.values(CACHE_CONFIG).forEach(config => {
            const oldKey = getCacheKey(config.key).replace(`_${currentSource}`, `_${lastKnownDataSource || 'unknown'}`);
            localStorage.removeItem(oldKey);
          });
          // Reload with new source
          loadUnifiedData();
        }
      }
    });

    window.addEventListener('dataSourceChanged', (event) => {
      console.debug(`üîÑ Explicit data source change in analytics-unified: ${event.detail.oldSource} ‚Üí ${event.detail.newSource}`);
      lastKnownDataSource = event.detail.newSource;
      // Clear cache and reload
      loadUnifiedData();
    });

    document.addEventListener('DOMContentLoaded', async () => {
      // Initialize governance panel
      const governanceContainer = document.getElementById('governance-container');
      if (governanceContainer) {
        console.log('üèõÔ∏è Initializing Governance Panel in analytics dashboard...');
        const governancePanel = new GovernancePanel(governanceContainer);
        window.governancePanel = governancePanel; // For debugging
      }


      // initial paint
      renderUnifiedInsights('unified-root');
      
      // Initialize governance system
      setTimeout(async () => {
        try {
          console.log('üèõÔ∏è Initializing governance system in analytics dashboard...');
          await store.syncGovernanceState();
          await store.syncMLSignals();
          console.log('‚úÖ Governance system initialized in analytics dashboard');
          
          // Re-render to show governance status
          renderUnifiedInsights('unified-root');
          
          // Refresh governance panel if initialized
          if (window.governancePanel) {
            window.governancePanel.refreshState();
          }
        } catch (error) {
          console.warn('‚ö†Ô∏è Failed to initialize governance in analytics:', error);
        }
      }, 500);
      
      // keep in sync with store changes without over-rendering
      let paintTimer;
      store.subscribe(() => {
        clearTimeout(paintTimer);
        paintTimer = setTimeout(() => renderUnifiedInsights('unified-root'), 250);
      });
      // initial data load
      loadUnifiedData();

      // Simple fallback banner toggle
      setInterval(() => {
        try {
          const status = store.get('ui.apiStatus.backend');
          const banner = document.getElementById('backend-fallback-banner');
          if (!banner) return;
          banner.style.display = (status && status !== 'healthy') ? 'block' : 'none';
        } catch {}
      }, 2000);
    });
  </script>
  <style>
    .wrap {
      max-width: 95vw;
      margin: 0 auto;
      padding: var(--space-lg);
    }

    .tabs {
      display: flex;
      gap: .5rem;
      border-bottom: 1px solid var(--theme-border);
    }

    .tab-btn {
      padding: .6rem .9rem;
      border: 1px solid var(--theme-border);
      background: var(--theme-surface);
      color: var(--theme-text);
      border-radius: var(--radius-sm) var(--radius-sm) 0 0;
      cursor: pointer;
    }

    .tab-btn.active {
      border-color: var(--brand-primary);
      color: var(--brand-primary);
      background: color-mix(in oklab, var(--brand-primary) 10%, transparent);
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    .panel-card {
      background: var(--theme-surface);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-lg);
      padding: var(--space-md);
    }

    .metric-card {
      background: var(--theme-bg);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-md);
      padding: 1rem;
      text-align: center;
    }

    .metric-card h4 {
      margin: 0 0 0.5rem 0;
      font-size: 0.9rem;
      color: var(--theme-text-muted);
      font-weight: 500;
    }

    .metric-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--theme-text);
      margin: 0.5rem 0;
    }

    .metric-card small {
      color: var(--theme-text-muted);
      font-size: 0.8rem;
    }
  </style>
  <script type="module" src="components/tooltips.js"></script>
</head>

<body>
  <div id="backend-fallback-banner" style="display:none; background: color-mix(in oklab, var(--warning) 20%, transparent); border: 1px solid var(--warning); color: var(--theme-text); padding: .6rem; margin: .5rem auto; max-width: 95vw; border-radius: 6px;">
    ‚ö† Backend indisponible ‚Äî mode prudent (cap r√©duit).
  </div>
  <div class="wrap">
    <!-- Governance Panel -->
    <div id="governance-container"></div>


    <div id="unified-root"></div>
    <div style="height: 1rem;"></div>
    <div class="tabs" id="analytics-tabs">
      <button class="tab-btn active" data-target="#tab-risk">Risk</button>
      <button class="tab-btn" data-target="#tab-performance">Performance</button>
      <button class="tab-btn" data-target="#tab-cycles">Cycles</button>
      <button class="tab-btn" data-target="#tab-monitoring">Monitoring</button>
      <button class="tab-btn" data-target="#tab-intelligence-ml">ü§ñ Intelligence ML</button>
    </div>
  </div>

  <section class="wrap tab-panel active" id="tab-risk">
    <div class="panel-card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3>üõ°Ô∏è Risk Dashboard</h3>
        <div id="risk-badge-container"></div>
      </div>
      <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
        <div class="metric-card" data-metric="risk-var">
          <h4>Portfolio VaR</h4>
          <div class="metric-value">-2.34%</div>
          <small>95% confidence level</small>
        </div>
        <div class="metric-card" data-metric="risk-drawdown">
          <h4>Max Drawdown</h4>
          <div class="metric-value">-8.12%</div>
          <small>Current cycle</small>
        </div>
        <div class="metric-card" data-metric="risk-volatility">
          <h4>Volatility</h4>
          <div class="metric-value">24.6%</div>
          <small>30-day annualized</small>
        </div>
        <div class="metric-card" data-metric="risk-score">
          <h4>Risk Score</h4>
          <div class="metric-value">--/100</div>
          <small>Unknown</small>
        </div>
      </div>
      <!-- Scores cl√©s du Risk Dashboard (version compl√®te) -->
      <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-top: 1rem;">
        <div class="metric-card" data-metric="risk-kpi-diversification">
          <h4>Diversification Ratio</h4>
          <div class="metric-value">--</div>
          <small>Corr√©lation de portefeuille</small>
        </div>
        <div class="metric-card" data-metric="risk-kpi-effective-assets">
          <h4>Effective Assets</h4>
          <div class="metric-value">--</div>
          <small>Actifs non-redondants</small>
        </div>
        <div class="metric-card" data-metric="risk-kpi-blended">
          <h4>Score D√©cisionnel</h4>
          <div class="metric-value">--</div>
          <small>CCS √ó Cycle (synth√®se)</small>
        </div>
        <div class="metric-card" data-metric="risk-kpi-onchain">
          <h4>On-Chain Composite</h4>
          <div class="metric-value">--</div>
          <small>Fondamentaux on-chain</small>
        </div>
      </div>
      <div style="margin-top: 2rem; padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-md);">
        <h4>Risk Alerts</h4>
        <div style="color: var(--theme-text-muted);">‚Ä¢ Portfolio concentration within acceptable limits</div>
        <div style="color: var(--theme-text-muted);">‚Ä¢ Correlation risk moderate for current market conditions</div>
        <div style="color: var(--theme-text-muted);">‚Ä¢ No significant exposure warnings</div>
      </div>
      <div style="text-align: center; margin-top: 1.5rem;">
        <a href="risk-dashboard.html?nav=off" target="_blank"
          style="display: inline-block; background: var(--brand-primary); color: white; padding: 0.75rem 1.5rem; border-radius: var(--radius-md); text-decoration: none; font-weight: 600;">
          üìä Version compl√®te du Risk Dashboard
        </a>
      </div>
    </div>
  </section>
  <section class="wrap tab-panel" id="tab-performance">
    <div class="panel-card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3>üìä Performance Monitor</h3>
        <div id="performance-badge-container"></div>
      </div>
      <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
        <div class="metric-card" data-metric="perf-cache-size">
          <h4>Memory Cache Size</h4>
          <div class="metric-value">--</div>
          <small>Memory cache entries</small>
        </div>
        <div class="metric-card" data-metric="perf-disk-cache">
          <h4>Disk Cache Usage</h4>
          <div class="metric-value">-- MB</div>
          <small>Disk cache usage</small>
        </div>
        <div class="metric-card" data-metric="perf-memory">
          <h4>Process Memory</h4>
          <div class="metric-value">-- MB</div>
          <small>Process memory</small>
        </div>
        <div class="metric-card" data-metric="perf-system-memory">
          <h4>System Memory Usage</h4>
          <div class="metric-value">--%</div>
          <small>System memory usage</small>
        </div>
      </div>
      <div style="margin-top: 2rem; padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-md);">
        <h4>System Performance</h4>
        <div style="display: grid; gap: 0.5rem;">
          <div style="display: flex; justify-content: space-between;"><span>Memory Cache Hit Rate:</span><span
              style="color: var(--success);">--%</span></div>
          <div style="display: flex; justify-content: space-between;"><span>Available Memory:</span><span>-- GB</span>
          </div>
          <div style="display: flex; justify-content: space-between;"><span>Process Efficiency:</span><span>--</span>
          </div>
        </div>
      </div>
      <div style="text-align: center; margin-top: 1.5rem;">
        <a href="performance-monitor.html?nav=off" target="_blank"
          style="display: inline-block; background: var(--brand-primary); color: white; padding: 0.75rem 1.5rem; border-radius: var(--radius-md); text-decoration: none; font-weight: 600;">
          üìà Version compl√®te du Performance Monitor
        </a>
      </div>
    </div>
  </section>
  <section class="wrap tab-panel" id="tab-cycles">
    <div class="panel-card">
      <h3>üîÑ Cycle Analysis</h3>
      <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
        <div class="metric-card" data-metric="cycle-phase">
          <h4>Current Phase</h4>
          <div class="metric-value">--</div>
          <small>Current phase</small>
        </div>
        <div class="metric-card" data-metric="cycle-progress">
          <h4>Post-Halving Progress</h4>
          <div class="metric-value">-- months</div>
          <small>Post-halving progress</small>
        </div>
        <div class="metric-card" data-metric="cycle-score">
          <h4>Cycle Score</h4>
          <div class="metric-value">--</div>
          <small>Cycle position score</small>
        </div>
        <div class="metric-card" data-metric="cycle-confidence">
          <h4>Confidence</h4>
          <div class="metric-value">--%</div>
          <small>Model certainty</small>
        </div>
      </div>
      <div style="margin-top: 2rem; padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-md);">
        <h4>Market Cycle Indicators</h4>
        <div style="display: grid; gap: 0.5rem;">
          <div style="display: flex; justify-content: space-between;"><span>Fear & Greed Index:</span><span>45
              (Neutral)</span></div>
          <div style="display: flex; justify-content: space-between;"><span>RSI (Weekly):</span><span>58
              (Neutral)</span></div>
          <div style="display: flex; justify-content: space-between;"><span>MVRV Ratio:</span><span>2.1
              (Accumulation)</span></div>
        </div>
      </div>
      <div style="text-align: center; margin-top: 1.5rem;">
        <a href="cycle-analysis.html?nav=off" target="_blank"
          style="display: inline-block; background: var(--brand-primary); color: white; padding: 0.75rem 1.5rem; border-radius: var(--radius-md); text-decoration: none; font-weight: 600;">
          üîÑ Version compl√®te du Cycle Analysis
        </a>
      </div>
    </div>
  </section>
  <section class="wrap tab-panel" id="tab-monitoring">
    <div class="panel-card">
      <h3>üìà Advanced Analytics</h3>
      <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
        <div class="metric-card" data-metric="monitor-total-return">
          <h4>Total Return</h4>
          <div class="metric-value">--%</div>
          <small>Sur la p√©riode</small>
        </div>
        <div class="metric-card" data-metric="monitor-sharpe">
          <h4>Sharpe Ratio</h4>
          <div class="metric-value">--</div>
          <small>Risque ajust√©</small>
        </div>
        <div class="metric-card" data-metric="monitor-volatility">
          <h4>Volatility</h4>
          <div class="metric-value">--%</div>
          <small>Risque de march√©</small>
        </div>
        <div class="metric-card" data-metric="monitor-drawdown">
          <h4>Max Drawdown</h4>
          <div class="metric-value">--%</div>
          <small>Pire baisse</small>
        </div>
      </div>
      <div style="margin-top: 2rem; padding: 1rem; background: var(--theme-bg); border-radius: var(--radius-md);">
        <h4>Advanced Metrics</h4>
        <div id="advanced-metrics-breakdown" style="display: grid; gap: 0.5rem;"></div>
      </div>
      <div style="text-align: center; margin-top: 1.5rem;">
        <a href="advanced-analytics.html?nav=off" target="_blank"
          style="display: inline-block; background: var(--brand-primary); color: white; padding: 0.75rem 1.5rem; border-radius: var(--radius-md); text-decoration: none; font-weight: 600;">üìà
          Version compl√®te des Advanced Analytics</a>
      </div>
    </div>
  </section>

  <!-- Intelligence ML Tab Panel -->
  <section class="wrap tab-panel" id="tab-intelligence-ml">
    <div class="panel-card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3>ü§ñ Intelligence ML - Vue Analyse Compl√®te</h3>
        <div id="intelligence-badge-container"></div>
      </div>
      <p style="color: var(--theme-text-muted); margin-bottom: 2rem;">
        Analyse d√©taill√©e des mod√®les ML, pr√©dictions temps r√©el et administration avanc√©e
      </p>

      <!-- Stats ML Globales -->
      <div class="ml-stats-section" style="margin-bottom: 2rem;">
        <h4 style="margin-bottom: 1rem;">üìä Statistiques ML Globales</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
          <div class="metric-card">
            <h5>Mod√®les Actifs</h5>
            <div class="metric-value" id="ml-active-models">--/4</div>
            <small>Mod√®les charg√©s</small>
          </div>
          <div class="metric-card">
            <h5>Confiance Moyenne</h5>
            <div class="metric-value" id="ml-avg-confidence">--%</div>
            <small>Niveau de confiance</small>
          </div>
          <div class="metric-card">
            <h5>Derni√®re Mise √† Jour</h5>
            <div class="metric-value" id="ml-last-update">--</div>
            <small>Status ML</small>
          </div>
        </div>
      </div>

      <!-- Vue Mod√®les D√©taill√©e -->
      <div class="ml-models-section" style="margin-bottom: 2rem;">
        <h4 style="margin-bottom: 1rem;">üß† Sant√© des Mod√®les</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
          <div class="metric-card">
            <h5>üåä Volatility LSTM</h5>
            <div class="metric-value" id="ml-vol-model-status">‚ö™ Unknown</div>
            <small id="ml-vol-model-details">Statut du mod√®le</small>
          </div>
          <div class="metric-card">
            <h5>üîÑ Regime HMM</h5>
            <div class="metric-value" id="ml-regime-model-status">‚ö™ Unknown</div>
            <small id="ml-regime-model-details">Statut du mod√®le</small>
          </div>
          <div class="metric-card">
            <h5>üîó Correlation Transformer</h5>
            <div class="metric-value" id="ml-corr-model-status">‚ö™ Unknown</div>
            <small id="ml-corr-model-details">Statut du mod√®le</small>
          </div>
          <div class="metric-card">
            <h5>üí≠ Sentiment Composite</h5>
            <div class="metric-value" id="ml-sent-model-status">‚ö™ Unknown</div>
            <small id="ml-sent-model-details">Statut du mod√®le</small>
          </div>
        </div>
      </div>

      <!-- Pr√©dictions Temps R√©el -->
      <div class="ml-predictions-section" style="margin-bottom: 2rem;">
        <h4 style="margin-bottom: 1rem;">üîÆ Pr√©dictions Temps R√©el</h4>
        <div id="ml-predictions-container" style="display: grid; gap: 1rem;">
          <div class="prediction-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
            <!-- Volatilit√© -->
            <div class="metric-card" data-metric="ml-volatility-btc">
              <h5>BTC Volatilit√© 24h</h5>
              <div class="metric-value" id="ml-vol-btc">--</div>
              <small>Pr√©diction LSTM</small>
            </div>
            <div class="metric-card" data-metric="ml-volatility-eth">
              <h5>ETH Volatilit√© 24h</h5>
              <div class="metric-value" id="ml-vol-eth">--</div>
              <small>Pr√©diction LSTM</small>
            </div>
            <!-- R√©gimes -->
            <div class="metric-card" data-metric="ml-regime">
              <h5>R√©gime March√©</h5>
              <div class="metric-value" id="ml-regime">--</div>
              <small>Classification HMM</small>
            </div>
            <!-- Sentiment -->
            <div class="metric-card" data-metric="ml-sentiment">
              <h5>Fear & Greed</h5>
              <div class="metric-value" id="ml-sentiment">--</div>
              <small>Composite Score</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Administration ML (repliable, RBAC protected) -->
      <details class="ml-admin-section" style="margin-bottom: 2rem;">
        <summary style="cursor: pointer; padding: 0.75rem; background: var(--theme-surface-elevated); border-radius: var(--radius-sm); font-weight: 600;">
          üîß Administration ML (Admin Only)
        </summary>
        <div style="padding: 1rem; border: 1px solid var(--theme-border); border-top: none; border-radius: 0 0 var(--radius-sm) var(--radius-sm);">
          <div id="ml-admin-ops-container"></div>

          <!-- Actions Admin -->
          <div class="admin-actions" style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
            <button class="btn secondary" onclick="triggerMLRetraining()" id="btn-retrain">
              üîÑ Retrain Models
            </button>
            <button class="btn secondary" onclick="clearMLCache()" id="btn-clear-cache">
              üóëÔ∏è Clear Cache
            </button>
            <button class="btn secondary" onclick="downloadMLLogs()" id="btn-logs">
              üì• Download Logs
            </button>
            <button class="btn secondary" onclick="showMLDebug()" id="btn-debug">
              üîç Debug Info
            </button>
          </div>

          <!-- ML Pipeline Status -->
          <div class="ml-pipeline-status" style="margin-top: 1.5rem;">
            <h5 style="margin-bottom: 0.75rem;">Pipeline Status</h5>
            <div id="ml-pipeline-container" style="font-family: monospace; background: var(--theme-bg); padding: 1rem; border-radius: var(--radius-sm); font-size: 0.85rem;">
              Loading pipeline status...
            </div>
          </div>
        </div>
      </details>

      <!-- Lien vers Command Center -->
      <div style="text-align: center; margin-top: 2rem;">
        <a href="ai-dashboard.html" target="_blank"
          style="display: inline-block; background: var(--brand-primary); color: white; padding: 0.75rem 1.5rem; border-radius: var(--radius-md); text-decoration: none; font-weight: 600;">
          ü§ñ Ouvrir ML Command Center (Vue Ops)
        </a>
      </div>
    </div>
  </section>

  <script type="module">
    // Intelligence ML Tab - Simplified integration without external ML components

    let mlTabInitialized = false;

    // Initialisation quand l'onglet ML est s√©lectionn√©
    function initializeMLTab() {
      console.log('ü§ñ Initializing Intelligence ML tab...');

      try {
        // D√©marrer les pr√©dictions temps r√©el
        loadMLPredictions();
        loadMLPipelineStatus();

        // Refresh p√©riodique des pr√©dictions
        setInterval(loadMLPredictions, 60000); // 1 minute
        setInterval(loadMLPipelineStatus, 120000); // 2 minutes

        mlTabInitialized = true;
        console.log('‚úÖ Intelligence ML tab initialized');

      } catch (error) {
        console.error('‚ùå ML tab initialization failed:', error);
        showMLError('Initialization failed: ' + error.message);
      }
    }

    // Chargement du statut ML global et pr√©dictions - UTILISE SOURCE CENTRALIS√âE
    async function loadMLPredictions() {
      try {
        // 1) Statut ML global depuis source unifi√©e
        const { getUnifiedMLStatus } = await import('./shared-ml-functions.js');
        const mlStatus = await getUnifiedMLStatus();

        // Statistiques globales depuis source centralis√©e
        document.getElementById('ml-active-models').textContent = `${mlStatus.totalLoaded}/${mlStatus.totalModels}`;

        // Confiance depuis source centralis√©e
        const confidencePercent = Math.round((mlStatus.confidence || 0) * 100);
        document.getElementById('ml-avg-confidence').textContent = `${confidencePercent}%`;

        // Derni√®re mise √† jour depuis source centralis√©e
        document.getElementById('ml-last-update').textContent =
          mlStatus.timestamp ? new Date(mlStatus.timestamp).toLocaleTimeString('fr-FR') : '--';

        // Statuts des mod√®les individuels depuis source centralis√©e
        const individual = mlStatus.individual;

          // Volatility LSTM depuis source centralis√©e
          const volModelsLoaded = individual.volatility.loaded;
          const volSymbols = individual.volatility.symbols || 0;
          const volStatus = volModelsLoaded > 0 ? 'active' : 'inactive';
          const volStatusEl = document.getElementById('ml-vol-model-status');
          const volDetailsEl = document.getElementById('ml-vol-model-details');
          if (volStatusEl && volDetailsEl) {
            const icons = { 'active': 'üü¢', 'ready': 'üü¢', 'training': 'üîÑ', 'error': 'üî¥', 'inactive': '‚ö™', 'unknown': '‚ùì' };
            volStatusEl.textContent = `${icons[volStatus]} ${volStatus.charAt(0).toUpperCase() + volStatus.slice(1)}`;
            volDetailsEl.textContent = `${volModelsLoaded} mod√®les ‚Ä¢ ${volSymbols} symboles`;
          }

          // Regime HMM depuis source centralis√©e
          const regimeStatus = individual.regime.loaded > 0 ? 'active' : 'inactive';
          const regimeStatusEl = document.getElementById('ml-regime-model-status');
          const regimeDetailsEl = document.getElementById('ml-regime-model-details');
          if (regimeStatusEl && regimeDetailsEl) {
            const icons = { 'active': 'üü¢', 'ready': 'üü¢', 'training': 'üîÑ', 'error': 'üî¥', 'inactive': '‚ö™', 'unknown': '‚ùì' };
            regimeStatusEl.textContent = `${icons[regimeStatus]} ${regimeStatus.charAt(0).toUpperCase() + regimeStatus.slice(1)}`;
            regimeDetailsEl.textContent = individual.regime.available ? 'Mod√®le disponible' : 'Non disponible';
          }

          // Correlation Transformer depuis source centralis√©e
          const corrModelsLoaded = individual.correlation.loaded;
          const corrStatus = corrModelsLoaded > 0 ? 'active' : 'inactive';
          const corrStatusEl = document.getElementById('ml-corr-model-status');
          const corrDetailsEl = document.getElementById('ml-corr-model-details');
          if (corrStatusEl && corrDetailsEl) {
            const icons = { 'active': 'üü¢', 'ready': 'üü¢', 'training': 'üîÑ', 'error': 'üî¥', 'inactive': '‚ö™', 'unknown': '‚ùì' };
            corrStatusEl.textContent = `${icons[corrStatus]} ${corrStatus.charAt(0).toUpperCase() + corrStatus.slice(1)}`;
            corrDetailsEl.textContent = `${corrModelsLoaded} mod√®les charg√©s`;
          }

          // Sentiment Composite depuis source centralis√©e
          const sentStatusEl = document.getElementById('ml-sent-model-status');
          const sentDetailsEl = document.getElementById('ml-sent-model-details');
          if (sentStatusEl && sentDetailsEl) {
            const sentStatus = individual.sentiment.loaded > 0 ? 'active' : 'inactive';
            const icons = { 'active': 'üü¢', 'inactive': '‚ö™' };
            sentStatusEl.textContent = `${icons[sentStatus]} ${sentStatus.charAt(0).toUpperCase() + sentStatus.slice(1)}`;
            sentDetailsEl.textContent = individual.sentiment.available ? 'API composite disponible' : 'Non disponible';
          }

          console.log(`‚úÖ ML Status charg√© depuis source centralis√©e: ${mlStatus.source}`);
        } else {
          console.warn('‚ö†Ô∏è Impossible de charger le statut ML unifi√©, utilisation des API individuelles...');
          // Fallback vers l'ancien syst√®me si source centralis√©e √©choue
          await loadMLPredictionsFallback();
        }

        // 2) Volatilit√© BTC/ETH
        const volResponse = await fetch('/api/ml/volatility/predict/BTC?horizon=1d');
        if (volResponse.ok) {
          const volData = await volResponse.json();
          const vol = volData.volatility_forecast?.volatility_forecast || volData.volatility;
          document.getElementById('ml-vol-btc').textContent =
            vol ? `${(vol * 100).toFixed(1)}%` : '--';
        }

        const volETHResponse = await fetch('/api/ml/volatility/predict/ETH?horizon=1d');
        if (volETHResponse.ok) {
          const volETHData = await volETHResponse.json();
          const vol = volETHData.volatility_forecast?.volatility_forecast || volETHData.volatility;
          document.getElementById('ml-vol-eth').textContent =
            vol ? `${(vol * 100).toFixed(1)}%` : '--';
        }

        // 3) R√©gime de march√©
        const regimeResponse = await fetch('/api/ml/regime/current');
        if (regimeResponse.ok) {
          const regimeData = await regimeResponse.json();
          const regimeEl = document.getElementById('ml-regime');
          if (regimeData.regime_prediction) {
            const regime = regimeData.regime_prediction.regime_name || '--';
            regimeEl.textContent = regime;
            regimeEl.className = `metric-value regime-${regime.toLowerCase() === 'sideways' ? 'neutral' : regime.toLowerCase()}`;
          }
        }

        // 4) Sentiment F&G
        const sentResponse = await fetch('/api/ml/sentiment/fear-greed?days=1');
        if (sentResponse.ok) {
          const sentData = await sentResponse.json();
          const sentEl = document.getElementById('ml-sentiment');
          if (sentData.aggregated_sentiment) {
            const score = Math.round(sentData.aggregated_sentiment.score * 100); // Score sur 100
            sentEl.textContent = score;
            sentEl.className = `metric-value sentiment-${score < 25 ? 'fear' : score > 75 ? 'greed' : 'neutral'}`;
          }
        }

      } catch (error) {
        console.warn('ML predictions update failed:', error);
      }
    }

    // Fallback vers ancien syst√®me si source centralis√©e √©choue
    async function loadMLPredictionsFallback() {
      try {
        // Ancien syst√®me comme fallback
        const statusResponse = await fetch('/api/ml/status');
        if (statusResponse.ok) {
          const statusData = await statusResponse.json();
          const pipeline = statusData.pipeline_status || {};

          const totalLoaded = Math.min(Math.max(0, pipeline.loaded_models_count || 0), 4);
          document.getElementById('ml-active-models').textContent = `${totalLoaded}/4`;

          const confidencePercent = Math.min(100, Math.round((totalLoaded / 4) * 100));
          document.getElementById('ml-avg-confidence').textContent = `${confidencePercent}%`;

          const lastUpdate = pipeline.timestamp || statusData.timestamp;
          document.getElementById('ml-last-update').textContent =
            lastUpdate ? new Date(lastUpdate).toLocaleTimeString('fr-FR') : '--';

          console.log('‚ö†Ô∏è Using ML fallback system');
        }
      } catch (error) {
        console.error('ML fallback also failed:', error);
      }
    }

    // Chargement du statut pipeline ML
    async function loadMLPipelineStatus() {
      try {
        const response = await fetch('/api/ml/debug/pipeline-info', {
          headers: { 'X-Admin-Key': 'crypto-rebal-admin-2024' }
        });

        const container = document.getElementById('ml-pipeline-container');

        if (response.ok) {
          const data = await response.json();
          container.innerHTML = `
            <div>Models Loaded: ${data.models_loaded || 0}/4</div>
            <div>Cache Size: ${data.cache_size || 0} entries</div>
            <div>Last Update: ${data.last_update || 'Never'}</div>
            <div>Status: <span style="color: var(--success);">${data.status || 'Unknown'}</span></div>
          `;
        } else if (response.status === 401 || response.status === 403) {
          container.innerHTML = '<div style="color: var(--warning);">‚ö†Ô∏è Admin access required for pipeline info</div>';
        } else {
          container.innerHTML = '<div style="color: var(--danger);">‚ùå Pipeline status unavailable</div>';
        }

      } catch (error) {
        console.warn('Pipeline status update failed:', error);
        document.getElementById('ml-pipeline-container').innerHTML =
          '<div style="color: var(--danger);">‚ùå Connection error</div>';
      }
    }

    // Actions Admin ML
    window.triggerMLRetraining = async function() {
      if (!confirm('D√©clencher le re-entrainement des mod√®les ML ? (Peut prendre plusieurs minutes)')) return;

      try {
        const response = await fetch('/api/ml/train', {
          method: 'POST',
          headers: { 'X-Admin-Key': 'crypto-rebal-admin-2024' }
        });

        if (response.ok) {
          alert('‚úÖ Re-entrainement d√©marr√© en arri√®re-plan');
        } else {
          alert('‚ùå Erreur lors du d√©marrage: ' + response.statusText);
        }
      } catch (error) {
        alert('‚ùå Erreur: ' + error.message);
      }
    };

    window.clearMLCache = async function() {
      if (!confirm('Vider le cache ML ?')) return;

      try {
        const response = await fetch('/api/ml/cache/clear', {
          method: 'DELETE',
          headers: { 'X-Admin-Key': 'crypto-rebal-admin-2024' }
        });

        if (response.ok) {
          alert('‚úÖ Cache ML vid√©');
          location.reload();
        } else {
          alert('‚ùå Erreur: ' + response.statusText);
        }
      } catch (error) {
        alert('‚ùå Erreur: ' + error.message);
      }
    };

    window.downloadMLLogs = function() {
      window.open('/api/logs?component=ml&format=txt', '_blank');
    };

    window.showMLDebug = async function() {
      try {
        const response = await fetch('/api/ml/debug/pipeline-info', {
          headers: { 'X-Admin-Key': 'crypto-rebal-admin-2024' }
        });

        if (response.ok) {
          const data = await response.json();
          const debugWindow = window.open('', '_blank', 'width=800,height=600');
          debugWindow.document.write(`
            <html>
              <head><title>ML Debug Info</title></head>
              <body style="font-family: monospace; padding: 20px;">
                <h2>ML Debug Information</h2>
                <pre>${JSON.stringify(data, null, 2)}</pre>
              </body>
            </html>
          `);
        } else {
          alert('‚ùå Admin access required');
        }
      } catch (error) {
        alert('‚ùå Erreur: ' + error.message);
      }
    };

    function showMLError(message) {
      document.getElementById('tab-intelligence-ml').innerHTML = `
        <div class="panel-card" style="text-align: center; padding: 4rem; color: var(--danger);">
          <h3>‚ö†Ô∏è Intelligence ML Error</h3>
          <p>${message}</p>
          <button onclick="location.reload()" style="background: var(--brand-primary); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: var(--radius-md); cursor: pointer;">
            Retry
          </button>
        </div>
      `;
    }

    // Auto-initialisation quand l'onglet devient actif
    document.addEventListener('DOMContentLoaded', () => {
      // Observer les changements d'onglets - int√©gration avec le syst√®me existant
      const tabButtons = document.querySelectorAll('.tab-btn');

      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const targetId = button.dataset.target;

          // Si c'est l'onglet Intelligence ML
          if (targetId === '#tab-intelligence-ml') {
            setTimeout(() => {
              if (!mlTabInitialized) {
                initializeMLTab();
              }
            }, 100); // Petit d√©lai pour que l'onglet soit visible
          }
        });
      });

      // Initialisation pr√©ventive des donn√©es ML (m√™me si l'onglet n'est pas actif)
      // Cela permet d'avoir les donn√©es pr√™tes quand l'utilisateur clique sur l'onglet
      setTimeout(() => {
        console.log('ü§ñ Pre-loading ML data for Intelligence tab...');
        loadMLPredictions();
        loadMLPipelineStatus();
        mlTabInitialized = true;
      }, 1000); // D√©lai pour laisser la page se charger

      // Auto-init si l'URL contient #ml
      if (window.location.hash === '#ml' || window.location.search.includes('tab=ml')) {
        setTimeout(() => {
          const mlTab = document.querySelector('[data-target="#tab-intelligence-ml"]');
          mlTab?.click();
        }, 500);
      }
    });
  </script>

  <style>
    /* Styles sp√©cifiques pour l'onglet Intelligence ML */
    .ml-stats-section, .ml-models-section, .ml-predictions-section, .ml-admin-section {
      background: var(--theme-surface);
      border-radius: var(--radius-md);
      padding: 1.5rem;
      border: 1px solid var(--theme-border);
    }

    .prediction-grid .metric-card {
      transition: all 0.3s ease;
    }

    .prediction-grid .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* Couleurs pour les r√©gimes */
    .metric-value.regime-bull { color: var(--success); }
    .metric-value.regime-bear { color: var(--danger); }
    .metric-value.regime-neutral { color: var(--warning); }

    /* Couleurs pour le sentiment */
    .metric-value.sentiment-fear { color: var(--danger); }
    .metric-value.sentiment-greed { color: var(--success); }
    .metric-value.sentiment-neutral { color: var(--theme-text); }

    .admin-actions .btn {
      font-size: 0.85rem;
      padding: 0.5rem 1rem;
    }

    .ml-pipeline-status {
      background: var(--theme-bg);
      border-radius: var(--radius-sm);
      padding: 1rem;
    }

    /* Responsive pour onglet ML */
    @media (max-width: 768px) {
      .prediction-grid {
        grid-template-columns: 1fr 1fr !important;
      }

      .admin-actions {
        flex-direction: column;
      }

      .admin-actions .btn {
        width: 100%;
      }
    }
  </style>
</body>

</html>
