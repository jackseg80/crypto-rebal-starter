<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test DI History Module</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 900px;
      margin: 2rem auto;
      padding: 0 1rem;
      background: #1a1b26;
      color: #c0caf5;
    }
    h1 { color: #7aa2f7; }
    h2 { color: #bb9af7; margin-top: 2rem; }
    .test-case {
      background: #24283b;
      border-left: 3px solid #7aa2f7;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 4px;
    }
    .test-case h3 {
      margin-top: 0;
      color: #9ece6a;
    }
    .result {
      background: #1a1b26;
      padding: 0.5rem;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      overflow-x: auto;
    }
    .pass { color: #9ece6a; }
    .fail { color: #f7768e; }
    button {
      background: #7aa2f7;
      color: #1a1b26;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      margin-right: 0.5rem;
    }
    button:hover { background: #89b4fa; }
    .clear-btn { background: #f7768e; }
    .clear-btn:hover { background: #ff9e64; }
  </style>
</head>
<body>
  <h1>üß™ Test DI History Module</h1>
  <p>Tests de validation du module <code>utils/di-history.js</code></p>

  <div>
    <button onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
    <button onclick="clearStorage()" class="clear-btn">üóëÔ∏è Clear Storage</button>
  </div>

  <h2>Test Results</h2>
  <div id="results"></div>

  <script type="module">
    import * as diHistory from './utils/di-history.js';

    // Exposer pour console
    window.diHistory = diHistory;

    window.runAllTests = async function() {
      const resultsEl = document.getElementById('results');
      resultsEl.innerHTML = '';

      const tests = [
        testGetTodayCH,
        testMakeKey,
        testLoadHistory,
        testSaveHistory,
        testPushIfNeeded,
        testMigrateLegacy,
        testSanitization,
        testMaxLimit
      ];

      for (const test of tests) {
        const result = await test();
        resultsEl.innerHTML += result;
      }
    };

    window.clearStorage = function() {
      const keys = Object.keys(localStorage).filter(k => k.includes('di_history'));
      keys.forEach(k => localStorage.removeItem(k));
      alert(`üóëÔ∏è Cleared ${keys.length} DI history keys`);
    };

    function testGetTodayCH() {
      const today = diHistory.getTodayCH();
      const pass = /^\d{4}-\d{2}-\d{2}$/.test(today);
      return renderTest('getTodayCH()', pass, `Format: ${today}`, 'Expected YYYY-MM-DD format');
    }

    function testMakeKey() {
      const key1 = diHistory.makeKey({ user: 'demo', source: 'cointracking', suffix: '_prod' });
      const key2 = diHistory.makeKey({ user: 'jack', source: 'saxobank', suffix: '_sim' });
      const pass = key1 === 'di_history_demo_cointracking_prod' && key2 === 'di_history_jack_saxobank_sim';
      return renderTest('makeKey()', pass, `key1=${key1}, key2=${key2}`, 'Expected scoped keys');
    }

    function testLoadHistory() {
      const testKey = 'di_history_test_load';
      localStorage.setItem(testKey, JSON.stringify([
        { date: '2025-09-28', di: 60, timestamp: '2025-09-28T12:00:00Z' },
        { date: '2025-09-29', di: 65, timestamp: '2025-09-29T12:00:00Z' }
      ]));

      const history = diHistory.loadHistory(testKey);
      const pass = history.length === 2 && history[1].di === 65;

      localStorage.removeItem(testKey);

      return renderTest('loadHistory()', pass, `Loaded ${history.length} entries`, 'Expected 2 valid entries');
    }

    function testSaveHistory() {
      const testKey = 'di_history_test_save';
      const data = [
        { date: '2025-09-30', di: 70, timestamp: '2025-09-30T12:00:00Z' }
      ];

      diHistory.saveHistory(testKey, data);
      const loaded = JSON.parse(localStorage.getItem(testKey));
      const pass = loaded.length === 1 && loaded[0].di === 70;

      localStorage.removeItem(testKey);

      return renderTest('saveHistory()', pass, `Saved and verified`, 'Expected 1 entry with di=70');
    }

    function testPushIfNeeded() {
      const testKey = 'di_history_test_push';
      const history = [
        { date: '2025-09-29', di: 60, timestamp: '2025-09-29T12:00:00Z' }
      ];

      const today = diHistory.getTodayCH();

      // Cas 1: Nouveau jour (should add)
      const result1 = diHistory.pushIfNeeded({
        key: testKey,
        history,
        today,
        di: 65,
        max: 30,
        minDelta: 0.1
      });

      // Cas 2: M√™me jour, delta < seuil (should NOT add)
      const result2 = diHistory.pushIfNeeded({
        key: testKey,
        history: result1.history,
        today,
        di: 65.05,
        max: 30,
        minDelta: 0.1
      });

      // Cas 3: M√™me jour, delta > seuil (should add)
      const result3 = diHistory.pushIfNeeded({
        key: testKey,
        history: result2.history,
        today,
        di: 70,
        max: 30,
        minDelta: 0.1
      });

      const pass = result1.added && !result2.added && result3.added;

      localStorage.removeItem(testKey);

      return renderTest('pushIfNeeded()', pass,
        `Case 1 (new day): ${result1.added}, Case 2 (small delta): ${result2.added}, Case 3 (big delta): ${result3.added}`,
        'Expected: true, false, true'
      );
    }

    function testMigrateLegacy() {
      const legacy = [55, 58, 60, 62, 65];
      const migrated = diHistory.migrateLegacy(legacy, 30);

      const pass = migrated.length === 5 && migrated[0].migrated === true && Number.isFinite(migrated[0].di);

      return renderTest('migrateLegacy()', pass,
        `Migrated ${migrated.length} entries, first di=${migrated[0]?.di}`,
        'Expected 5 entries with migrated flag'
      );
    }

    function testSanitization() {
      const testKey = 'di_history_test_sanitize';
      const corrupted = [
        { date: '2025-09-28', di: 60, timestamp: '2025-09-28T12:00:00Z' },
        { date: '2025-09-29', di: NaN, timestamp: '2025-09-29T12:00:00Z' },  // Invalid
        { date: '2025-09-30', di: Infinity, timestamp: '2025-09-30T12:00:00Z' },  // Invalid
        { date: 'invalid', di: 70, timestamp: '2025-10-01T12:00:00Z' },  // Valid (date string check is basic)
        { di: 75 },  // Missing date
        { date: '2025-10-02', di: 80, timestamp: '2025-10-02T12:00:00Z' }
      ];

      localStorage.setItem(testKey, JSON.stringify(corrupted));
      const loaded = diHistory.loadHistory(testKey);

      // Should filter out NaN, Infinity, missing date
      const pass = loaded.length === 3 && loaded.every(e => Number.isFinite(e.di) && typeof e.date === 'string');

      localStorage.removeItem(testKey);

      return renderTest('Sanitization', pass,
        `Loaded ${loaded.length} valid entries from 6 corrupted`,
        'Expected 3 valid entries'
      );
    }

    function testMaxLimit() {
      const testKey = 'di_history_test_limit';
      const today = diHistory.getTodayCH();

      // Generate 35 entries
      let history = [];
      for (let i = 0; i < 35; i++) {
        history.push({
          date: `2025-09-${String(i + 1).padStart(2, '0')}`,
          di: 50 + i,
          timestamp: new Date().toISOString()
        });
      }

      diHistory.saveHistory(testKey, history);
      const loaded = diHistory.loadHistory(testKey, 30);

      const pass = loaded.length === 30 && loaded[0].di === 55;  // Should trim first 5

      localStorage.removeItem(testKey);

      return renderTest('Max Limit (30)', pass,
        `Loaded ${loaded.length} entries, first di=${loaded[0]?.di}`,
        'Expected 30 entries (oldest 5 trimmed)'
      );
    }

    function renderTest(name, pass, result, expected) {
      const statusClass = pass ? 'pass' : 'fail';
      const statusIcon = pass ? '‚úÖ' : '‚ùå';
      return `
        <div class="test-case">
          <h3>${statusIcon} ${name} <span class="${statusClass}">${pass ? 'PASS' : 'FAIL'}</span></h3>
          <div class="result">
            <strong>Result:</strong> ${result}<br>
            <strong>Expected:</strong> ${expected}
          </div>
        </div>
      `;
    }

    // Auto-run on load
    window.runAllTests();
  </script>
</body>
</html>
