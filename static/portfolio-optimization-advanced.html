<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio Optimization Avanc√© - Crypto Portfolio</title>

  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">

  <script src="global-config.js"></script>
  <script src="appearance.js"></script>

  <!-- Navigation unifi√©e -->
  <script type="module">
    if (new URLSearchParams(window.location.search).get('nav') !== 'off') {
      import('./components/nav.js');
    }
  </script>

  <!-- Chart.js for visualizations -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
  <script type="module" src="components/tooltips.js"></script>

  <style>
    .wrap { max-width: 95vw; margin: 0 auto; padding: var(--space-lg); }

    .card {
      background: var(--theme-surface);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      margin-bottom: var(--space-lg);
    }

    .card-header {
      border-bottom: 1px solid var(--theme-border);
      padding-bottom: var(--space-md);
      margin-bottom: var(--space-lg);
    }

    .card-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--theme-text);
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: .75rem;
      margin-bottom: var(--space-lg);
    }

    .controls label {
      display: block;
      font-size: .9rem;
      color: var(--theme-text-muted);
      margin-bottom: .25rem;
      font-weight: 500;
    }

    .controls select,
    .controls input,
    .controls textarea {
      width: 100%;
      padding: .5rem .6rem;
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-sm);
      background: var(--theme-surface);
      color: var(--theme-text);
      font-size: 0.9rem;
    }

    .controls textarea {
      min-height: 60px;
      resize: vertical;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    }

    .algorithm-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: var(--space-lg);
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 0.5rem 1rem;
      border: 1px solid var(--theme-border);
      background: var(--theme-surface);
      color: var(--theme-text);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
    }

    .tab-btn.active {
      background: var(--brand-primary);
      color: white;
      border-color: var(--brand-primary);
    }

    .tab-btn:hover:not(.active) {
      background: var(--theme-muted);
    }

    .algorithm-config {
      display: none;
      padding: var(--space-lg);
      background: var(--theme-bg);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-lg);
    }

    .algorithm-config.active {
      display: block;
    }

    .actions {
      margin-top: var(--space-lg);
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn {
      background: var(--brand-primary);
      color: #fff;
      border: 0;
      padding: .6rem 1rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn:hover {
      background: var(--brand-primary-hover);
    }

    .btn.secondary {
      background: var(--theme-surface);
      color: var(--theme-text);
      border: 1px solid var(--theme-border);
    }

    .btn.secondary:hover {
      background: var(--theme-muted);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: var(--space-lg);
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--space-md);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th, td {
      text-align: left;
      padding: .5rem;
      border-bottom: 1px solid var(--theme-border);
    }

    th {
      color: var(--theme-text-muted);
      font-weight: 600;
      background: var(--theme-bg);
    }

    .kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: .5rem;
      margin-bottom: var(--space-md);
    }

    .kpi {
      background: var(--theme-bg);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-md);
      padding: .6rem;
      text-align: center;
    }

    .kpi .label {
      color: var(--theme-text-muted);
      font-size: .8rem;
      margin-bottom: 0.25rem;
    }

    .kpi .value {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--brand-primary);
    }

    .error, .warning, .success {
      padding: .6rem;
      border-radius: var(--radius-sm);
      margin: .5rem 0;
      font-size: 0.9rem;
    }

    .error {
      background: var(--danger-bg);
      color: var(--danger);
      border: 1px solid var(--danger);
    }

    .warning {
      background: var(--warning-bg);
      color: var(--warning);
      border: 1px solid var(--warning);
    }

    .success {
      background: var(--pos-bg);
      color: var(--pos);
      border: 1px solid var(--pos);
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin-bottom: var(--space-md);
    }

    .help-text {
      font-size: 0.85rem;
      color: var(--theme-text-muted);
      margin-top: 0.25rem;
      font-style: italic;
    }

    .comparison-table {
      margin-top: var(--space-lg);
    }

    .comparison-table th {
      background: var(--brand-primary);
      color: white;
    }

    .param-group {
      background: var(--theme-surface-elevated);
      border-radius: var(--radius-sm);
      padding: var(--space-md);
      margin-bottom: var(--space-md);
    }

    .param-group h4 {
      margin: 0 0 var(--space-sm) 0;
      color: var(--theme-text);
      font-size: 1rem;
    }

    @media (max-width: 768px) {
      .controls {
        grid-template-columns: 1fr;
      }

      .algorithm-tabs {
        flex-direction: column;
      }

      .tab-btn {
        text-align: center;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          üßÆ Portfolio Optimization Avanc√©
        </div>
        <p style="margin: 0.5rem 0 0 0; color: var(--theme-text-muted); font-size: 0.95rem;">
          Algorithmes sophistiqu√©s d'allocation optimale : Markowitz, Black-Litterman, Risk Parity, CVaR, et plus
        </p>
      </div>

      <!-- Configuration de base -->
      <div class="controls">
        <div>
          <label for="source">Source des donn√©es</label>
          <select id="source">
            <option value="cointracking">CoinTracking CSV</option>
            <option value="cointracking_api">CoinTracking API</option>
            <option value="stub">Demo (stub)</option>
          </select>
        </div>
        <div>
          <label for="lookback">Historique (jours)</label>
          <input id="lookback" type="number" min="30" max="2000" value="365" />
          <div class="help-text">Plus long = plus stable, plus court = plus r√©actif</div>
        </div>
        <div>
          <label for="minusd">Montant min. par asset ($)</label>
          <input id="minusd" type="number" min="0" max="100000" step="10" value="100" />
        </div>
        <div>
          <label for="risk-free-rate">Taux sans risque (%)</label>
          <input id="risk-free-rate" type="number" min="0" max="10" step="0.1" value="2.0" />
          <div class="help-text">Utilis√© pour le calcul du Sharpe ratio</div>
        </div>
      </div>

      <!-- S√©lection d'algorithme -->
      <div class="algorithm-tabs">
        <button class="tab-btn active" data-algorithm="max_sharpe">Max Sharpe</button>
        <button class="tab-btn" data-algorithm="black_litterman">Black-Litterman</button>
        <button class="tab-btn" data-algorithm="risk_parity">Risk Parity</button>
        <button class="tab-btn" data-algorithm="max_diversification">Max Diversification</button>
        <button class="tab-btn" data-algorithm="cvar_optimization">CVaR Optimization</button>
        <button class="tab-btn" data-algorithm="efficient_frontier">Fronti√®re Efficiente</button>
      </div>

      <!-- Configuration Max Sharpe -->
      <div id="config-max_sharpe" class="algorithm-config active">
        <h4>üìà Maximisation du Ratio de Sharpe</h4>
        <p style="color: var(--theme-text-muted); margin-bottom: var(--space-md);">
          Optimise le ratio rendement/risque. Algorithme classique de Markowitz.
        </p>
        <div class="param-group">
          <h4>Contraintes</h4>
          <div class="controls">
            <div>
              <label for="max-weight-sharpe">Poids max par asset (%)</label>
              <input id="max-weight-sharpe" type="number" min="1" max="100" value="35" />
            </div>
            <div>
              <label for="max-sector-sharpe">Poids max par secteur (%)</label>
              <input id="max-sector-sharpe" type="number" min="1" max="100" value="60" />
            </div>
          </div>
        </div>
      </div>

      <!-- Configuration Black-Litterman -->
      <div id="config-black_litterman" class="algorithm-config">
        <h4>üîÆ Black-Litterman avec Vues de March√©</h4>
        <p style="color: var(--theme-text-muted); margin-bottom: var(--space-md);">
          Int√®gre vos opinions sur les rendements futurs avec l'√©quilibre du march√©.
        </p>
        <div class="param-group">
          <h4>Vues de March√©</h4>
          <div class="controls">
            <div style="grid-column: 1 / -1;">
              <label for="market-views">Vues sur les rendements annuels (JSON)</label>
              <textarea id="market-views" placeholder='{"BTC": 0.15, "ETH": 0.12, "SOL": 0.20}'>{"BTC": 0.15, "ETH": 0.12, "SOL": 0.20}</textarea>
              <div class="help-text">Format: {"SYMBOL": rendement_annuel}. Ex: 0.15 = 15% par an</div>
            </div>
            <div style="grid-column: 1 / -1;">
              <label for="view-confidence">Confiance dans les vues (JSON)</label>
              <textarea id="view-confidence" placeholder='{"BTC": 0.8, "ETH": 0.6, "SOL": 0.7}'>{"BTC": 0.8, "ETH": 0.6, "SOL": 0.7}</textarea>
              <div class="help-text">0 = aucune confiance, 1 = confiance totale</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Configuration Risk Parity -->
      <div id="config-risk_parity" class="algorithm-config">
        <h4>‚öñÔ∏è Risk Parity</h4>
        <p style="color: var(--theme-text-muted); margin-bottom: var(--space-md);">
          √âgalise la contribution au risque de chaque asset. Diversification optimale.
        </p>
        <div class="param-group">
          <h4>Param√®tres</h4>
          <div class="controls">
            <div>
              <label for="target-vol-rp">Volatilit√© cible (%)</label>
              <input id="target-vol-rp" type="number" min="5" max="50" step="1" value="15" />
              <div class="help-text">Laissez vide pour optimisation libre</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Configuration Max Diversification -->
      <div id="config-max_diversification" class="algorithm-config">
        <h4>üåê Maximisation de la Diversification</h4>
        <p style="color: var(--theme-text-muted); margin-bottom: var(--space-md);">
          Maximise le ratio de diversification (volatilit√©s individuelles pond√©r√©es / volatilit√© portfolio).
        </p>
        <div class="param-group">
          <h4>Contraintes</h4>
          <div class="controls">
            <div>
              <label for="min-div-ratio">Ratio diversification min</label>
              <input id="min-div-ratio" type="number" min="1" max="5" step="0.1" value="1.5" />
            </div>
            <div>
              <label for="max-corr-exp">Exposition corr√©lation max</label>
              <input id="max-corr-exp" type="number" min="0.1" max="1" step="0.05" value="0.7" />
            </div>
          </div>
        </div>
      </div>

      <!-- Configuration CVaR -->
      <div id="config-cvar_optimization" class="algorithm-config">
        <h4>üìâ Conditional Value at Risk (CVaR)</h4>
        <p style="color: var(--theme-text-muted); margin-bottom: var(--space-md);">
          Minimise les pertes extr√™mes. Optimisation pour la queue de distribution.
        </p>
        <div class="param-group">
          <h4>Param√®tres de Risque</h4>
          <div class="controls">
            <div>
              <label for="confidence-level">Niveau de confiance (%)</label>
              <input id="confidence-level" type="number" min="90" max="99" value="95" />
              <div class="help-text">95% = optimise pour les 5% pires sc√©narios</div>
            </div>
            <div>
              <label for="cvar-weight">Poids CVaR vs Sharpe</label>
              <input id="cvar-weight" type="number" min="0" max="1" step="0.1" value="0.7" />
              <div class="help-text">1.0 = 100% CVaR, 0.0 = 100% Sharpe</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Configuration Fronti√®re Efficiente -->
      <div id="config-efficient_frontier" class="algorithm-config">
        <h4>üìä Fronti√®re Efficiente</h4>
        <p style="color: var(--theme-text-muted); margin-bottom: var(--space-md);">
          Calcule l'ensemble des portfolios optimaux pour diff√©rents niveaux de risque.
        </p>
        <div class="param-group">
          <h4>Param√®tres de Calcul</h4>
          <div class="controls">
            <div>
              <label for="frontier-points">Nombre de points</label>
              <input id="frontier-points" type="number" min="10" max="100" value="30" />
            </div>
            <div>
              <label for="show-current">Afficher portfolio actuel</label>
              <select id="show-current">
                <option value="true">Oui</option>
                <option value="false">Non</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="runBtn">üöÄ Optimiser</button>
        <button class="btn secondary" id="compareBtn">üìä Comparer Algorithmes</button>
        <button class="btn secondary" id="resetBtn">üîÑ R√©initialiser</button>
        <span id="status" style="margin-left: auto; color: var(--theme-text-muted); font-size: 0.9rem;"></span>
      </div>
    </div>

    <!-- R√©sultats -->
    <div class="grid" id="results-container" style="display: none;">
      <div class="card">
        <div class="card-title" style="margin-bottom: var(--space-md);">üìà Allocation Optimale</div>
        <div class="chart-container">
          <canvas id="weightsChart"></canvas>
        </div>
        <table id="weightsTable"></table>
      </div>

      <div class="card">
        <div class="card-title" style="margin-bottom: var(--space-md);">üìä M√©triques de Performance</div>
        <div class="kpis" id="kpis"></div>
        <div id="additional-metrics"></div>
      </div>

      <div class="card">
        <div class="card-title" style="margin-bottom: var(--space-md);">üîÑ Plan de R√©√©quilibrage</div>
        <table id="tradesTable"></table>
      </div>
    </div>

    <!-- Fronti√®re Efficiente -->
    <div class="card" id="frontier-container" style="display: none;">
      <div class="card-title" style="margin-bottom: var(--space-md);">üìä Fronti√®re Efficiente</div>
      <div class="chart-container">
        <canvas id="frontierChart"></canvas>
      </div>
      <div id="frontier-details"></div>
    </div>

    <!-- Comparaison d'algorithmes -->
    <div class="card" id="comparison-container" style="display: none;">
      <div class="card-title" style="margin-bottom: var(--space-md);">üìä Comparaison d'Algorithmes</div>
      <table id="comparisonTable" class="comparison-table"></table>
    </div>
  </div>

  <script>
    const API_BASE = (window.globalConfig && globalConfig.get('api_base_url')) || '';
    let weightsChart, frontierChart;
    let currentResults = {};

    // Configuration des algorithmes
    const algorithms = {
      max_sharpe: { name: "Max Sharpe", endpoint: "max_sharpe" },
      black_litterman: { name: "Black-Litterman", endpoint: "black_litterman" },
      risk_parity: { name: "Risk Parity", endpoint: "risk_parity" },
      max_diversification: { name: "Max Diversification", endpoint: "max_diversification" },
      cvar_optimization: { name: "CVaR Optimization", endpoint: "cvar_optimization" },
      efficient_frontier: { name: "Fronti√®re Efficiente", endpoint: "efficient_frontier" }
    };

    // Utilitaires
    function formatPct(x) { return (x * 100).toFixed(2) + '%'; }
    function formatPct1(x) { return (x * 100).toFixed(1) + '%'; }
    function formatNum(x) { return x.toFixed(3); }
    function setStatus(msg) {
      document.getElementById('status').textContent = msg || '';
    }

    // Gestion des onglets d'algorithmes
    function setupAlgorithmTabs() {
      const tabs = document.querySelectorAll('.tab-btn');
      const configs = document.querySelectorAll('.algorithm-config');

      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const algorithm = tab.dataset.algorithm;

          // Update active tab
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');

          // Show corresponding config
          configs.forEach(c => c.classList.remove('active'));
          document.getElementById(`config-${algorithm}`).classList.add('active');
        });
      });
    }

    // Validation des param√®tres
    function validateParameters(algorithm) {
      const errors = [];

      if (algorithm === 'black_litterman') {
        try {
          const views = JSON.parse(document.getElementById('market-views').value);
          const confidence = JSON.parse(document.getElementById('view-confidence').value);

          if (Object.keys(views).length === 0) {
            errors.push("Au moins une vue de march√© est requise");
          }

          for (const [asset, ret] of Object.entries(views)) {
            if (typeof ret !== 'number' || ret < -1 || ret > 2) {
              errors.push(`Rendement invalide pour ${asset}: ${ret}`);
            }
          }

          for (const [asset, conf] of Object.entries(confidence)) {
            if (typeof conf !== 'number' || conf < 0 || conf > 1) {
              errors.push(`Confiance invalide pour ${asset}: ${conf}`);
            }
          }
        } catch (e) {
          errors.push("Format JSON invalide pour les vues de march√©");
        }
      }

      return errors;
    }

    // Optimisation principale
    async function runOptimization() {
      const activeTab = document.querySelector('.tab-btn.active');
      const algorithm = activeTab.dataset.algorithm;

      setStatus(`Optimisation ${algorithms[algorithm].name} en cours...`);

      // Validation
      const errors = validateParameters(algorithm);
      if (errors.length > 0) {
        setStatus('Erreur de validation');
        showError(errors.join('; '));
        return;
      }

      try {
        // Param√®tres de base
        const baseParams = {
          source: document.getElementById('source').value,
          min_usd: parseFloat(document.getElementById('minusd').value),
          min_history_days: 365,
          lookback_days: parseInt(document.getElementById('lookback').value),
          risk_free_rate: parseFloat(document.getElementById('risk-free-rate').value) / 100
        };

        let requestBody = {
          objective: algorithms[algorithm].endpoint,
          expected_return_method: 'mean_reversion',
          include_current_weights: true
        };

        // Param√®tres sp√©cifiques par algorithme
        if (algorithm === 'black_litterman') {
          requestBody.market_views = JSON.parse(document.getElementById('market-views').value);
          requestBody.view_confidence = JSON.parse(document.getElementById('view-confidence').value);
        } else if (algorithm === 'risk_parity') {
          const targetVol = document.getElementById('target-vol-rp').value;
          if (targetVol) {
            requestBody.target_volatility = parseFloat(targetVol) / 100;
          }
        } else if (algorithm === 'max_diversification') {
          requestBody.min_diversification_ratio = parseFloat(document.getElementById('min-div-ratio').value);
          requestBody.max_correlation_exposure = parseFloat(document.getElementById('max-corr-exp').value);
        } else if (algorithm === 'cvar_optimization') {
          requestBody.confidence_level = parseFloat(document.getElementById('confidence-level').value) / 100;
          requestBody.cvar_weight = parseFloat(document.getElementById('cvar-weight').value);
        } else if (algorithm === 'efficient_frontier') {
          requestBody.n_points = parseInt(document.getElementById('frontier-points').value);
          requestBody.include_current = document.getElementById('show-current').value === 'true';
        }

        // Contraintes
        if (algorithm !== 'efficient_frontier') {
          requestBody.constraints = {
            max_weight: parseFloat(document.getElementById('max-weight-sharpe')?.value || 35) / 100,
            max_sector_weight: parseFloat(document.getElementById('max-sector-sharpe')?.value || 60) / 100
          };
        }

        const params = new URLSearchParams(baseParams);
        const url = `${API_BASE}/api/portfolio/optimization/optimize-advanced?${params.toString()}`;

        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || 'Optimisation √©chou√©e');
        }

        currentResults[algorithm] = result;

        if (algorithm === 'efficient_frontier') {
          displayFrontierResults(result);
        } else {
          displayOptimizationResults(result, algorithm);
        }

        setStatus('‚úÖ Optimisation termin√©e avec succ√®s');

      } catch (error) {
        debugLogger.error('Optimization error:', error);
        setStatus('‚ùå Erreur d\'optimisation');
        showError(`Erreur: ${error.message}`);
      }
    }

    // Affichage des r√©sultats d'optimisation
    function displayOptimizationResults(result, algorithm) {
      document.getElementById('results-container').style.display = 'grid';
      document.getElementById('frontier-container').style.display = 'none';

      // Graphique des poids
      renderWeightsChart(result.weights);
      renderWeightsTable(result.weights);

      // KPIs
      renderKPIs(result, algorithm);

      // Trades de r√©√©quilibrage
      renderTrades(result.rebalancing_trades || []);
    }

    // Affichage fronti√®re efficiente
    function displayFrontierResults(result) {
      document.getElementById('results-container').style.display = 'none';
      document.getElementById('frontier-container').style.display = 'block';

      renderFrontierChart(result.efficient_frontier);
    }

    function renderWeightsChart(weights) {
      const entries = Object.entries(weights || {})
        .filter(([_, w]) => w > 0.001) // Filtrer les poids n√©gligeables
        .sort((a, b) => b[1] - a[1]);

      const ctx = document.getElementById('weightsChart');
      const labels = entries.map(e => e[0]);
      const data = entries.map(e => e[1] * 100);
      const colors = labels.map((_, i) => `hsl(${(i * 137.5) % 360} 70% 55%)`);

      if (weightsChart) weightsChart.destroy();
      weightsChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: colors,
            borderWidth: 2,
            borderColor: getComputedStyle(document.documentElement).getPropertyValue('--theme-surface')
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                usePointStyle: true,
                padding: 15
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.parsed.toFixed(1)}%`;
                }
              }
            }
          }
        }
      });
    }

    function renderWeightsTable(weights) {
      const entries = Object.entries(weights || {})
        .filter(([_, w]) => w > 0.001)
        .sort((a, b) => b[1] - a[1]);

      const table = document.getElementById('weightsTable');
      const rows = entries.map(([symbol, weight]) =>
        `<tr><td>${symbol}</td><td>${formatPct(weight)}</td></tr>`
      ).join('');

      table.innerHTML = `
        <thead>
          <tr><th>Asset</th><th>Allocation</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      `;
    }

    function renderKPIs(result, algorithm) {
      const kpis = document.getElementById('kpis');
      const baseKPIs = [
        { label: 'Rendement Attendu', value: formatPct(result.expected_return) },
        { label: 'Volatilit√©', value: formatPct(result.volatility) },
        { label: 'Ratio de Sharpe', value: formatNum(result.sharpe_ratio) },
        { label: 'Ratio Diversification', value: formatNum(result.diversification_ratio) },
        { label: 'Score Optimisation', value: formatNum(result.optimization_score) },
        { label: 'Contraintes OK', value: result.constraints_satisfied ? '‚úÖ' : '‚ö†Ô∏è' }
      ];

      // KPIs sp√©cifiques par algorithme
      const additionalKPIs = [];
      if (result.max_drawdown) {
        additionalKPIs.push({ label: 'Max Drawdown', value: formatPct(Math.abs(result.max_drawdown)) });
      }
      if (result.var_95) {
        additionalKPIs.push({ label: 'VaR 95%', value: formatPct(Math.abs(result.var_95)) });
      }
      if (result.cvar_95) {
        additionalKPIs.push({ label: 'CVaR 95%', value: formatPct(Math.abs(result.cvar_95)) });
      }

      const allKPIs = [...baseKPIs, ...additionalKPIs];
      kpis.innerHTML = allKPIs.map(kpi =>
        `<div class="kpi">
          <div class="label">${kpi.label}</div>
          <div class="value">${kpi.value}</div>
        </div>`
      ).join('');

      // M√©triques additionnelles
      const additionalDiv = document.getElementById('additional-metrics');
      let additionalHTML = '';

      if (result.risk_contributions) {
        const topRisks = Object.entries(result.risk_contributions)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);

        additionalHTML += `
          <h4 style="margin: 1rem 0 0.5rem 0;">üéØ Top 5 Contributions au Risque</h4>
          <div class="grid-3">
            ${topRisks.map(([asset, contrib]) =>
              `<div class="kpi">
                <div class="label">${asset}</div>
                <div class="value">${formatPct1(contrib)}</div>
              </div>`
            ).join('')}
          </div>
        `;
      }

      if (result.sector_exposures) {
        additionalHTML += `
          <h4 style="margin: 1rem 0 0.5rem 0;">üè¢ Expositions Sectorielles</h4>
          <div class="grid-3">
            ${Object.entries(result.sector_exposures).map(([sector, expo]) =>
              `<div class="kpi">
                <div class="label">${sector}</div>
                <div class="value">${formatPct1(expo)}</div>
              </div>`
            ).join('')}
          </div>
        `;
      }

      additionalDiv.innerHTML = additionalHTML;
    }

    function renderTrades(trades) {
      const table = document.getElementById('tradesTable');
      if (!trades || !trades.length) {
        table.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--theme-text-muted);">Aucun r√©√©quilibrage n√©cessaire</td></tr>';
        return;
      }

      const rows = trades.map(trade => {
        const deltaField = trade.delta || trade.weight_change || 0;
        const actionClass = deltaField > 0 ? 'pos' : deltaField < 0 ? 'neg' : '';

        return `<tr>
          <td>${trade.symbol || trade.asset || '-'}</td>
          <td>${trade.action || (deltaField > 0 ? 'Acheter' : 'Vendre')}</td>
          <td style="color: var(--${actionClass})">${formatPct1(Math.abs(deltaField))}</td>
          <td>${trade.amount_usd ? '$' + trade.amount_usd.toLocaleString() : '-'}</td>
        </tr>`;
      }).join('');

      table.innerHTML = `
        <thead>
          <tr><th>Asset</th><th>Action</th><th>Delta</th><th>Montant</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      `;
    }

    function renderFrontierChart(frontierData) {
      const ctx = document.getElementById('frontierChart');

      if (frontierChart) frontierChart.destroy();
      frontierChart = new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: [{
            label: 'Fronti√®re Efficiente',
            data: frontierData.risks.map((risk, i) => ({
              x: risk * 100,
              y: frontierData.returns[i] * 100
            })),
            borderColor: 'var(--brand-primary)',
            backgroundColor: 'var(--brand-primary)',
            borderWidth: 2,
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: { display: true, text: 'Volatilit√© (%)' },
              grid: { color: 'var(--theme-border)' }
            },
            y: {
              title: { display: true, text: 'Rendement Attendu (%)' },
              grid: { color: 'var(--theme-border)' }
            }
          },
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `Vol: ${context.parsed.x.toFixed(1)}%, Ret: ${context.parsed.y.toFixed(1)}%`;
                }
              }
            }
          }
        }
      });
    }

    // Comparaison d'algorithmes
    async function compareAlgorithms() {
      setStatus('Comparaison des algorithmes en cours...');
      document.getElementById('comparison-container').style.display = 'block';

      const compareList = ['max_sharpe', 'risk_parity', 'max_diversification'];
      const results = {};

      for (const algo of compareList) {
        try {
          const baseParams = {
            source: document.getElementById('source').value,
            min_usd: parseFloat(document.getElementById('minusd').value),
            lookback_days: parseInt(document.getElementById('lookback').value)
          };

          const requestBody = {
            objective: algorithms[algo].endpoint,
            expected_return_method: 'mean_reversion',
            include_current_weights: true
          };

          const params = new URLSearchParams(baseParams);
          const url = `${API_BASE}/api/portfolio/optimization/optimize-advanced?${params.toString()}`;

          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
          });

          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              results[algo] = result;
            }
          }
        } catch (e) {
          debugLogger.warn(`Failed to optimize ${algo}:`, e);
        }
      }

      renderComparisonTable(results);
      setStatus('‚úÖ Comparaison termin√©e');
    }

    function renderComparisonTable(results) {
      const table = document.getElementById('comparisonTable');
      const metrics = ['expected_return', 'volatility', 'sharpe_ratio', 'diversification_ratio'];

      let html = `
        <thead>
          <tr>
            <th>M√©trique</th>
            ${Object.keys(results).map(algo => `<th>${algorithms[algo].name}</th>`).join('')}
          </tr>
        </thead>
        <tbody>
      `;

      metrics.forEach(metric => {
        html += '<tr>';
        html += `<td><strong>${getMetricLabel(metric)}</strong></td>`;

        Object.keys(results).forEach(algo => {
          const value = results[algo][metric];
          const formattedValue = metric.includes('ratio') ? formatNum(value) : formatPct(value);
          html += `<td>${formattedValue}</td>`;
        });

        html += '</tr>';
      });

      html += '</tbody>';
      table.innerHTML = html;
    }

    function getMetricLabel(metric) {
      const labels = {
        expected_return: 'Rendement Attendu',
        volatility: 'Volatilit√©',
        sharpe_ratio: 'Ratio de Sharpe',
        diversification_ratio: 'Ratio Diversification'
      };
      return labels[metric] || metric;
    }

    // Fonctions utilitaires
    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error';
      errorDiv.textContent = message;

      const actions = document.querySelector('.actions');
      actions.parentNode.insertBefore(errorDiv, actions.nextSibling);

      setTimeout(() => errorDiv.remove(), 5000);
    }

    function resetForm() {
      // Reset form values
      document.getElementById('source').value = 'cointracking';
      document.getElementById('lookback').value = '365';
      document.getElementById('minusd').value = '100';
      document.getElementById('risk-free-rate').value = '2.0';

      // Reset algorithm-specific fields
      document.getElementById('max-weight-sharpe').value = '35';
      document.getElementById('market-views').value = '{"BTC": 0.15, "ETH": 0.12, "SOL": 0.20}';
      document.getElementById('view-confidence').value = '{"BTC": 0.8, "ETH": 0.6, "SOL": 0.7}';

      // Hide results
      document.getElementById('results-container').style.display = 'none';
      document.getElementById('frontier-container').style.display = 'none';
      document.getElementById('comparison-container').style.display = 'none';

      // Reset charts
      if (weightsChart) weightsChart.destroy();
      if (frontierChart) frontierChart.destroy();

      setStatus('');
      currentResults = {};
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      setupAlgorithmTabs();

      document.getElementById('runBtn').addEventListener('click', runOptimization);
      document.getElementById('compareBtn').addEventListener('click', compareAlgorithms);
      document.getElementById('resetBtn').addEventListener('click', resetForm);

      // Auto-run demo
      if (new URLSearchParams(location.search).get('autorun') === '1') {
        setTimeout(runOptimization, 1000);
      }
    });
  </script>
</body>

</html>