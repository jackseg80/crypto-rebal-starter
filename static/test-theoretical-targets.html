<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🎯 Test Objectifs Théoriques - Phase Engine</title>
  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">
  <script src="global-config.js"></script>
  <script src="appearance.js"></script>
</head>

<body>
  <header class="header">
    <div class="container">
      <h1>🎯 Test Objectifs Théoriques</h1>
      <p>Vérification du nouveau modèle risky-only avec tilts par phase</p>
    </div>
  </header>

  <main class="container">

    <!-- Phase Control Panel -->
    <div class="card">
      <h2>🎮 Contrôle des Phases</h2>
      <p>Forcez une phase spécifique pour tester les tilts risky-only :</p>

      <div class="button-group" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin: 1rem 0;">
        <button class="btn btn-secondary" onclick="forcePhase('neutral')">🟡 Neutral</button>
        <button class="btn btn-secondary" onclick="forcePhase('risk_off')">🔴 Risk Off</button>
        <button class="btn btn-primary" onclick="forcePhase('eth_expansion')">🟢 ETH Expansion</button>
        <button class="btn btn-primary" onclick="forcePhase('largecap_altseason')">🔵 Large-cap Altseason</button>
        <button class="btn btn-primary" onclick="forcePhase('full_altseason')">🟣 Full Altseason</button>
        <button class="btn btn-info" onclick="clearForcedPhase()">🔄 Auto Detection</button>
      </div>

      <div id="phase-status" class="alert" style="margin-top: 1rem;">
        Phase actuelle : <span id="current-phase">Chargement...</span>
      </div>
    </div>

    <!-- Theoretical Targets Display -->
    <div class="card">
      <h2>📊 Objectifs Théoriques Actuels</h2>
      <button id="refresh-targets" class="btn btn-primary">🔄 Actualiser les Objectifs</button>

      <div id="targets-display" style="margin-top: 1rem;">
        Cliquez sur "Actualiser" pour charger les objectifs...
      </div>
    </div>

    <!-- Phase Comparison -->
    <div class="card">
      <h2>⚖️ Comparaison Phase par Phase</h2>
      <button id="compare-all-phases" class="btn btn-warning">🔍 Comparer Toutes les Phases</button>

      <div id="comparison-display" style="margin-top: 1rem;">
        <p>Cette comparaison montrera les différences entre les allocations pour chaque phase.</p>
      </div>
    </div>

    <!-- Validation Tests -->
    <div class="card">
      <h2>✅ Tests de Validation</h2>
      <button id="run-validation" class="btn btn-success">🧪 Lancer Tests de Validation</button>

      <div id="validation-results" style="margin-top: 1rem;"></div>
    </div>

  </main>

  <script type="module">

    // Force a specific phase
    window.forcePhase = function(phase) {
      localStorage.setItem('forced_phase', phase);
      localStorage.removeItem('detected_phase_cache'); // Clear cache
      document.getElementById('current-phase').textContent = phase + ' (forcé)';
      document.getElementById('phase-status').className = 'alert alert-warning';
      console.log('🎭 Phase forcée:', phase);
    };

    // Clear forced phase
    window.clearForcedPhase = function() {
      localStorage.removeItem('forced_phase');
      localStorage.removeItem('detected_phase_cache');
      document.getElementById('current-phase').textContent = 'Auto-détection';
      document.getElementById('phase-status').className = 'alert alert-info';
      console.log('🔄 Auto-détection des phases réactivée');
    };

    // Display targets in a nice format
    function displayTargets(targets, container, title = '') {
      if (!targets) {
        container.innerHTML = '<div class="error">❌ Aucun objectif disponible</div>';
        return;
      }

      const total = Object.values(targets).reduce((sum, val) => sum + (val || 0), 0);
      const isValid = Math.abs(total - 100) < 0.1;

      let html = '';
      if (title) {
        html += `<h3>${title}</h3>`;
      }

      html += `<div class="targets-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin: 1rem 0;">`;

      // Sort by percentage (descending)
      const sortedEntries = Object.entries(targets).sort(([,a], [,b]) => (b || 0) - (a || 0));

      for (const [asset, pct] of sortedEntries) {
        if ((pct || 0) > 0.1) { // Only show significant allocations
          const color = pct > 20 ? 'var(--success)' : pct > 10 ? 'var(--warning)' : 'var(--info)';
          html += `
            <div style="background: var(--theme-surface); padding: 0.75rem; border-radius: 6px; border-left: 3px solid ${color};">
              <div style="font-weight: 600; color: var(--theme-text);">${asset}</div>
              <div style="font-size: 1.2em; font-weight: 700; color: ${color};">${(pct || 0).toFixed(1)}%</div>
            </div>
          `;
        }
      }

      html += `</div>`;
      html += `<div class="summary" style="padding: 0.5rem; background: var(--theme-surface); border-radius: 6px; margin-top: 0.5rem;">`;
      html += `<strong>Total: ${total.toFixed(1)}%</strong> ${isValid ? '✅' : '❌ Somme incorrecte!'}`;
      html += `</div>`;

      container.innerHTML = html;
    }

    // Refresh targets display
    document.getElementById('refresh-targets').addEventListener('click', async () => {
      const display = document.getElementById('targets-display');
      display.innerHTML = '<div class="loading">🔄 Chargement des objectifs...</div>';

      try {
        const { getUnifiedState } = await import('./core/unified-insights-v2.js');
        const unifiedState = await getUnifiedState();

        console.log('📊 Unified state loaded:', unifiedState);

        // Update current phase display
        const currentPhase = unifiedState.cycle?.phase?.phase || 'unknown';
        const forcedPhase = localStorage.getItem('forced_phase');

        if (forcedPhase) {
          document.getElementById('current-phase').textContent = `${forcedPhase} (forcé) → Détecté: ${currentPhase}`;
          document.getElementById('phase-status').className = 'alert alert-warning';
        } else {
          document.getElementById('current-phase').textContent = currentPhase;
          document.getElementById('phase-status').className = 'alert alert-info';
        }

        // Display targets
        if (unifiedState.targets_by_group) {
          displayTargets(unifiedState.targets_by_group, display, '🎯 Objectifs Théoriques (Nouveau Modèle)');

          // Additional info
          display.innerHTML += `
            <div style="margin-top: 1rem; padding: 1rem; background: var(--theme-surface); border-radius: 6px;">
              <h4>🔍 Détails du Calcul</h4>
              <ul>
                <li><strong>Phase détectée:</strong> ${currentPhase}</li>
                <li><strong>Score Decision:</strong> ${unifiedState.decision?.score || 'N/A'}</li>
                <li><strong>Score Cycle:</strong> ${unifiedState.cycle?.score || 'N/A'}</li>
                <li><strong>Tilts appliqués:</strong> ${unifiedState.phase?.tiltsApplied ? '✅ Oui' : '❌ Non'}</li>
                <li><strong>Stables préservées:</strong> ${unifiedState.phase?.stablesPreserved ? '✅ Oui' : '❌ Non'}</li>
                <li><strong>Source:</strong> ${unifiedState.decision?.source || 'unknown'}</li>
                <li><strong>Dernière MAJ:</strong> ${new Date().toLocaleTimeString()}</li>
              </ul>
            </div>
          `;
        } else {
          display.innerHTML = '<div class="error">❌ Aucun objectif targets_by_group trouvé dans unifiedState</div>';
        }

      } catch (error) {
        console.error('❌ Erreur lors du chargement des objectifs:', error);
        display.innerHTML = `<div class="error">❌ Erreur: ${error.message}</div>`;
      }
    });

    // Compare all phases
    document.getElementById('compare-all-phases').addEventListener('click', async () => {
      const display = document.getElementById('comparison-display');
      display.innerHTML = '<div class="loading">🔄 Comparaison en cours...</div>';

      try {
        const { getUnifiedState } = await import('./core/unified-insights-v2.js');

        const phases = ['neutral', 'risk_off', 'eth_expansion', 'largecap_altseason', 'full_altseason'];
        const results = {};

        for (const phase of phases) {
          // Force the phase
          localStorage.setItem('forced_phase', phase);
          localStorage.removeItem('detected_phase_cache');

          // Get state with forced phase
          const state = await getUnifiedState();
          results[phase] = state.targets_by_group;

          // Small delay to ensure phase change is processed
          await new Promise(resolve => setTimeout(resolve, 100));
        }

        // Clear forced phase
        localStorage.removeItem('forced_phase');
        localStorage.removeItem('detected_phase_cache');

        // Display comparison
        let html = '<h3>📊 Comparaison des Allocations par Phase</h3>';

        for (const [phase, targets] of Object.entries(results)) {
          const phaseLabel = {
            'neutral': '🟡 Neutral',
            'risk_off': '🔴 Risk Off',
            'eth_expansion': '🟢 ETH Expansion',
            'largecap_altseason': '🔵 Large-cap Altseason',
            'full_altseason': '🟣 Full Altseason'
          }[phase] || phase;

          html += `<div style="margin: 1rem 0; padding: 1rem; border: 1px solid var(--theme-border); border-radius: 6px;">`;
          html += `<h4>${phaseLabel}</h4>`;

          if (targets) {
            const sortedTargets = Object.entries(targets)
              .filter(([, pct]) => (pct || 0) > 0.1)
              .sort(([,a], [,b]) => (b || 0) - (a || 0));

            html += '<div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">';
            for (const [asset, pct] of sortedTargets) {
              html += `<span style="background: var(--theme-surface); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.9em;">${asset}: ${(pct || 0).toFixed(1)}%</span>`;
            }
            html += '</div>';
          } else {
            html += '<div class="error">❌ Aucune donnée</div>';
          }

          html += `</div>`;
        }

        display.innerHTML = html;

      } catch (error) {
        console.error('❌ Erreur lors de la comparaison:', error);
        display.innerHTML = `<div class="error">❌ Erreur: ${error.message}</div>`;
      }
    });

    // Validation tests
    document.getElementById('run-validation').addEventListener('click', async () => {
      const display = document.getElementById('validation-results');
      display.innerHTML = '<div class="loading">🧪 Tests de validation en cours...</div>';

      try {
        const { getUnifiedState } = await import('./core/unified-insights-v2.js');

        const tests = [];

        // Test 1: Stables preservation across phases
        const phases = ['neutral', 'risk_off', 'eth_expansion', 'largecap_altseason', 'full_altseason'];
        let stablesConsistent = true;
        let baseStables = null;

        for (const phase of phases) {
          localStorage.setItem('forced_phase', phase);
          localStorage.removeItem('detected_phase_cache');

          const state = await getUnifiedState();
          const stables = state.targets_by_group?.['Stablecoins'] || 0;

          if (baseStables === null) {
            baseStables = stables;
          } else if (Math.abs(stables - baseStables) > 0.1) {
            stablesConsistent = false;
          }

          await new Promise(resolve => setTimeout(resolve, 50));
        }

        tests.push({
          name: 'Préservation des Stablecoins',
          passed: stablesConsistent,
          details: `Stables: ${baseStables?.toFixed(1)}% (cohérent sur toutes les phases: ${stablesConsistent ? 'Oui' : 'Non'})`
        });

        // Test 2: Sum to 100%
        localStorage.setItem('forced_phase', 'full_altseason');
        localStorage.removeItem('detected_phase_cache');
        const testState = await getUnifiedState();
        const total = Object.values(testState.targets_by_group || {}).reduce((sum, val) => sum + (val || 0), 0);
        const sumValid = Math.abs(total - 100) < 0.1;

        tests.push({
          name: 'Somme = 100%',
          passed: sumValid,
          details: `Total: ${total.toFixed(2)}% (écart: ${Math.abs(total - 100).toFixed(2)}%)`
        });

        // Test 3: Phase-specific tilts
        localStorage.setItem('forced_phase', 'eth_expansion');
        localStorage.removeItem('detected_phase_cache');
        const ethState = await getUnifiedState();

        localStorage.setItem('forced_phase', 'neutral');
        localStorage.removeItem('detected_phase_cache');
        const neutralState = await getUnifiedState();

        const ethTilt = (ethState.targets_by_group?.['ETH'] || 0) > (neutralState.targets_by_group?.['ETH'] || 0);

        tests.push({
          name: 'Tilts spécifiques par phase',
          passed: ethTilt,
          details: `ETH expansion vs neutral: ${ethState.targets_by_group?.['ETH']?.toFixed(1)}% vs ${neutralState.targets_by_group?.['ETH']?.toFixed(1)}%`
        });

        // Clear forced phase
        localStorage.removeItem('forced_phase');
        localStorage.removeItem('detected_phase_cache');

        // Display results
        let html = '<h3>🧪 Résultats des Tests de Validation</h3>';

        for (const test of tests) {
          const icon = test.passed ? '✅' : '❌';
          const color = test.passed ? 'var(--success)' : 'var(--danger)';

          html += `
            <div style="margin: 0.5rem 0; padding: 0.75rem; border-left: 3px solid ${color}; background: var(--theme-surface); border-radius: 6px;">
              <div style="font-weight: 600; color: ${color};">${icon} ${test.name}</div>
              <div style="font-size: 0.9em; color: var(--theme-text-muted); margin-top: 0.25rem;">${test.details}</div>
            </div>
          `;
        }

        const passedCount = tests.filter(t => t.passed).length;
        const totalCount = tests.length;
        const allPassed = passedCount === totalCount;

        html += `
          <div style="margin-top: 1rem; padding: 1rem; background: ${allPassed ? 'var(--success-bg)' : 'var(--warning-bg)'}; border-radius: 6px; text-align: center;">
            <strong>${passedCount}/${totalCount} tests réussis</strong>
            ${allPassed ? ' 🎉 Tous les tests passent!' : ' ⚠️ Certains tests échouent'}
          </div>
        `;

        display.innerHTML = html;

      } catch (error) {
        console.error('❌ Erreur lors des tests de validation:', error);
        display.innerHTML = `<div class="error">❌ Erreur: ${error.message}</div>`;
      }
    });

    // Auto-refresh on page load
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('refresh-targets').click();
    });

  </script>

</body>
</html>