<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Alias Manager - Crypto Rebalancer</title>
<style>
  :root{
    --bg:#0a0f14; --card:#0e1620; --muted:#8fa0b3; --text:#e7eef7;
    --accent:#2dd4bf; --danger:#ef4444; --border:#1f2b3a; --pos:#22c55e;
    --warning:#f59e0b;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;background:linear-gradient(180deg,rgba(10,15,20,.95),rgba(10,15,20,.85));backdrop-filter: blur(6px);border-bottom:1px solid var(--border);z-index:10}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  h1{margin:0 0 8px 0;font-size:20px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label{font-size:12px;color:var(--muted)}
  input,select,button,textarea{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text)}
  button{cursor:pointer}
  .btn{background:var(--accent);color:#07211e;font-weight:700;border:0}
  .btn.secondary{background:#223044;color:var(--text);border:1px solid var(--border)}
  .btn.danger{background:var(--danger);color:white;border:0}
  .btn.warning{background:var(--warning);color:white;border:0}
  .btn.small{padding:6px 8px;font-size:12px;border-radius:8px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
  .muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left;font-size:13px}
  th{color:var(--muted);font-weight:600;background:#0b131d}
  tr:hover td{background:#0b131d}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#0b131d;font-size:12px}
  .right{text-align:right}
  .small{font-size:12px}
  .mt8{margin-top:8px}
  .mt16{margin-top:16px}
  .grid{display:grid;gap:16px}
  @media(min-width:900px){ .grid.g2{grid-template-columns:repeat(2,1fr)} }
  .search-box{width:100%;max-width:400px}
  .stats{display:flex;gap:16px;margin:16px 0}
  .stat{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;min-width:120px}
  .stat-value{font-size:24px;font-weight:700;color:var(--accent)}
  .stat-label{font-size:12px;color:var(--muted);margin-top:4px}
  .group-badge{
    display:inline-block;
    padding:2px 8px;
    border-radius:12px;
    font-size:11px;
    font-weight:600;
    background:#223044;
    border:1px solid var(--border);
  }
  .group-badge.btc{background:#f7931a;color:white}
  .group-badge.eth{background:#627eea;color:white}
  .group-badge.stablecoins{background:#26a69a;color:white}
  .group-badge.sol{background:#9945ff;color:white}
  .group-badge.others{background:var(--muted);color:var(--bg)}
  .alias-row{border-bottom:1px solid var(--border);padding:8px 0}
  .alias-row:last-child{border-bottom:none}
  .alias-actions{display:flex;gap:8px;justify-content:flex-end}
  .filters{display:flex;gap:12px;margin:16px 0;flex-wrap:wrap}
  .loading{text-align:center;padding:40px;color:var(--muted)}
</style>
</head>
<body>

<!-- Header sera inject√© par shared-header.js -->

<div class="wrap" style="margin-top: 20px;">
  <!-- Actions rapides -->
  <div class="card" style="margin-bottom: 16px;">
    <div class="row">
      <button class="btn small" onclick="loadData()">üîÑ Actualiser</button>
      <button class="btn small" onclick="getSuggestions()">üîç Suggestions</button>
      <button class="btn small" onclick="autoClassify()">üöÄ Auto-classifier</button>
    </div>
  </div>
</div>

<div class="wrap">
  <!-- Stats -->
  <div class="stats" id="stats" style="display:none">
    <div class="stat">
      <div class="stat-value" id="total-aliases">-</div>
      <div class="stat-label">Total Aliases</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="groups-count">-</div>
      <div class="stat-label">Groupes</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="memory-count">-</div>
      <div class="stat-label">En m√©moire</div>
    </div>
  </div>

  <div class="grid g2">
    <!-- Recherche et filtres -->
    <div class="card">
      <h3>üîç Recherche & Filtres</h3>
      
      <div class="filters">
        <div>
          <label>Rechercher</label><br/>
          <input type="text" id="search" class="search-box" placeholder="Nom d'alias..." oninput="filterAliases()">
        </div>
        <div>
          <label>Groupe</label><br/>
          <select id="group-filter" onchange="filterAliases()">
            <option value="">Tous les groupes</option>
          </select>
        </div>
      </div>

      <div class="row mt8">
        <button class="btn small" onclick="clearFilters()">Effacer filtres</button>
        <button class="btn warning small" onclick="showOnlyUnassigned()">Voir non-assign√©s</button>
        <button class="btn small" onclick="showOnlyNewAliases()" style="background: #f59e0b; color: white;">üÜï Voir nouveaux</button>
        <div style="flex-grow: 1;"></div>
        <label style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
          <input type="checkbox" id="coingecko-enabled" checked>CoinGecko activ√©
        </label>
      </div>
    </div>

    <!-- Actions batch -->
    <div class="card">
      <h3>‚ö° Actions rapides</h3>
      
      <div class="row">
        <div>
          <label>Nouveau groupe</label><br/>
          <select id="batch-group">
            <option value="">S√©lectionner groupe...</option>
          </select>
        </div>
        <div>
          <button class="btn" onclick="assignFiltered()">Assigner les filtr√©s</button>
        </div>
      </div>

      <div class="row mt8">
        <button class="btn secondary small" onclick="assignAllToOthers()">Tout ‚Üí Others</button>
        <button class="btn secondary small" onclick="exportAliases()">üì• Export JSON</button>
      </div>
    </div>
  </div>

  <!-- Liste des alias -->
  <div class="card mt16">
    <div class="row">
      <h3>üè∑Ô∏è Liste des Alias</h3>
      <div class="pill">
        <span id="filtered-count">0</span> / <span id="total-count">0</span> affich√©s
      </div>
    </div>

    <div id="loading" class="loading">
      Chargement des donn√©es...
    </div>

    <div id="aliases-container" style="display:none">
      <table>
        <thead>
          <tr>
            <th>Alias</th>
            <th>Groupe actuel</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="aliases-list">
        </tbody>
      </table>
    </div>
  </div>
</div>

<script src="/static/global-config.js"></script>
<script src="/static/shared-header.js"></script>
<script>
let allAliases = {};
let allGroups = [];
let filteredAliases = {};

// Charger donn√©es initiales
window.addEventListener('DOMContentLoaded', () => {
  // V√©rifier si un plan a √©t√© g√©n√©r√©
  if (!window.globalConfig?.hasPlan()) {
    // Rediriger vers la page de rebalancing si aucun plan n'existe
    alert('‚ö†Ô∏è Vous devez d\'abord g√©n√©rer un plan de rebalancing pour utiliser l\'Alias Manager.');
    window.location.href = 'rebalance.html';
    return;
  }
  
  // Initialiser le header partag√©
  initSharedHeader('alias-manager', { showConfigIndicators: true });
  
  loadApiUrl();
  loadData();
});

function loadApiUrl() {
  // Plus besoin de charger depuis localStorage - utilise globalConfig
  return;
}

function saveApiUrl() {
  // Plus besoin de sauver - utilise globalConfig
  return;
}

async function loadData() {
  const apiBase = globalConfig.get('api_base_url');
  
  try {
    // Charger les aliases existants du serveur
    const response = await fetch(`${apiBase}/taxonomy`);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    const data = await response.json();
    allAliases = data.aliases || {};
    allGroups = data.groups || [];
    
    // S'assurer qu'il y a au moins les groupes de base
    const defaultGroups = ['BTC', 'ETH', 'Stablecoins', 'SOL', 'L1/L0 majors', 'L2/Scaling', 'DeFi', 'AI/Data', 'Gaming/NFT', 'Memecoins', 'Others'];
    defaultGroups.forEach(group => {
      if (!allGroups.includes(group)) {
        allGroups.push(group);
      }
    });
    
    // Ajouter les unknown aliases du dernier plan s'ils existent
    const lastPlan = window.globalConfig?.getLastPlanData();
    if (lastPlan && lastPlan.unknown_aliases) {
      lastPlan.unknown_aliases.forEach(alias => {
        if (!allAliases[alias]) {
          allAliases[alias] = 'Others'; // Groupe par d√©faut pour les unknown aliases
        }
      });
    }
    
    updateStats(data);
    populateGroupSelectors();
    filterAliases();
    
    document.getElementById('loading').style.display = 'none';
    document.getElementById('aliases-container').style.display = 'block';
    document.getElementById('stats').style.display = 'flex';
    
  } catch (error) {
    document.getElementById('loading').innerHTML = `‚ùå Erreur: ${error.message}`;
  }
}

function updateStats(data) {
  document.getElementById('total-aliases').textContent = Object.keys(allAliases).length;
  document.getElementById('groups-count').textContent = allGroups.length;
  document.getElementById('memory-count').textContent = data.storage?.in_memory_count || 0;
}

function populateGroupSelectors() {
  const selectors = ['group-filter', 'batch-group'];
  
  selectors.forEach(id => {
    const select = document.getElementById(id);
    const currentValue = select.value;
    select.innerHTML = id === 'group-filter' ? '<option value="">Tous les groupes</option>' : '<option value="">S√©lectionner groupe...</option>';
    
    allGroups.forEach(group => {
      const option = document.createElement('option');
      option.value = group;
      option.textContent = group;
      select.appendChild(option);
    });
    
    if (currentValue) select.value = currentValue;
  });
}

function filterAliases() {
  const search = document.getElementById('search').value.toLowerCase();
  const groupFilter = document.getElementById('group-filter').value;
  
  filteredAliases = {};
  
  Object.entries(allAliases).forEach(([alias, group]) => {
    const matchesSearch = !search || alias.toLowerCase().includes(search);
    const matchesGroup = !groupFilter || group === groupFilter;
    
    if (matchesSearch && matchesGroup) {
      filteredAliases[alias] = group;
    }
  });
  
  renderAliases();
}

function renderAliases() {
  const tbody = document.getElementById('aliases-list');
  tbody.innerHTML = '';
  
  const sorted = Object.entries(filteredAliases).sort(([a], [b]) => a.localeCompare(b));
  
  // R√©cup√©rer la liste des unknown aliases pour les mettre en √©vidence
  const lastPlan = window.globalConfig?.getLastPlanData();
  const unknownAliases = new Set(lastPlan?.unknown_aliases || []);
  
  sorted.forEach(([alias, group]) => {
    const tr = document.createElement('tr');
    const isUnknown = unknownAliases.has(alias);
    
    tr.innerHTML = `
      <td>
        <strong>${alias}</strong>
        ${isUnknown ? '<span style="color: #f59e0b; font-size: 10px; margin-left: 4px;">üÜï NOUVEAU</span>' : ''}
      </td>
      <td><span class="group-badge ${group.toLowerCase().replace(/[^a-z]/g, '')}">${group}</span></td>
      <td class="alias-actions">
        <select onchange="changeGroup('${alias}', this.value)" style="width:120px">
          ${allGroups.map(g => `<option value="${g}" ${g === group ? 'selected' : ''}>${g}</option>`).join('')}
        </select>
        <button class="btn danger small" onclick="deleteAlias('${alias}')">üóëÔ∏è</button>
      </td>
    `;
    
    // Mettre en √©vidence les lignes des unknown aliases
    if (isUnknown) {
      tr.style.backgroundColor = 'rgba(245, 158, 11, 0.1)';
      tr.style.borderLeft = '3px solid #f59e0b';
    }
    
    tbody.appendChild(tr);
  });
  
  document.getElementById('filtered-count').textContent = Object.keys(filteredAliases).length;
  document.getElementById('total-count').textContent = Object.keys(allAliases).length;
}

async function changeGroup(alias, newGroup) {
  if (!newGroup || allAliases[alias] === newGroup) return;
  
  try {
    const apiBase = globalConfig.get('api_base_url');
    const response = await fetch(`${apiBase}/taxonomy/aliases`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ aliases: { [alias]: newGroup } })
    });
    
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    allAliases[alias] = newGroup;
    filterAliases();
    showNotification(`‚úÖ ${alias} ‚Üí ${newGroup}`, 'success');
    
  } catch (error) {
    showNotification(`‚ùå Erreur: ${error.message}`, 'error');
    loadData(); // Recharger en cas d'erreur
  }
}

async function deleteAlias(alias) {
  if (!confirm(`Supprimer l'alias "${alias}" ?`)) return;
  
  try {
    const apiBase = globalConfig.get('api_base_url');
    const response = await fetch(`${apiBase}/taxonomy/aliases/${alias}`, {
      method: 'DELETE'
    });
    
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    delete allAliases[alias];
    filterAliases();
    showNotification(`üóëÔ∏è ${alias} supprim√©`, 'success');
    
  } catch (error) {
    showNotification(`‚ùå Erreur: ${error.message}`, 'error');
  }
}

async function assignFiltered() {
  const group = document.getElementById('batch-group').value;
  if (!group) {
    alert('S√©lectionnez un groupe de destination');
    return;
  }
  
  const aliases = Object.keys(filteredAliases);
  if (aliases.length === 0) {
    alert('Aucun alias √† assigner');
    return;
  }
  
  if (!confirm(`Assigner ${aliases.length} aliases au groupe "${group}" ?`)) return;
  
  try {
    const apiBase = globalConfig.get('api_base_url');
    const payload = {};
    aliases.forEach(alias => payload[alias] = group);
    
    const response = await fetch(`${apiBase}/taxonomy/aliases`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ aliases: payload })
    });
    
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    // Mettre √† jour local
    aliases.forEach(alias => allAliases[alias] = group);
    filterAliases();
    showNotification(`‚úÖ ${aliases.length} aliases ‚Üí ${group}`, 'success');
    
  } catch (error) {
    showNotification(`‚ùå Erreur: ${error.message}`, 'error');
  }
}

async function assignAllToOthers() {
  const aliases = Object.keys(allAliases);
  if (!confirm(`Assigner TOUS les ${aliases.length} aliases au groupe "Others" ?`)) return;
  
  try {
    const apiBase = globalConfig.get('api_base_url');
    const payload = {};
    aliases.forEach(alias => payload[alias] = 'Others');
    
    const response = await fetch(`${apiBase}/taxonomy/aliases`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ aliases: payload })
    });
    
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    Object.keys(allAliases).forEach(alias => allAliases[alias] = 'Others');
    filterAliases();
    showNotification(`‚úÖ Tous les aliases ‚Üí Others`, 'success');
    
  } catch (error) {
    showNotification(`‚ùå Erreur: ${error.message}`, 'error');
  }
}

function clearFilters() {
  document.getElementById('search').value = '';
  document.getElementById('group-filter').value = '';
  filterAliases();
}

function showOnlyUnassigned() {
  // Simule les "non-assign√©s" comme ceux dans "Others"
  document.getElementById('group-filter').value = 'Others';
  filterAliases();
}

function showOnlyNewAliases() {
  // Effacer les filtres existants
  document.getElementById('search').value = '';
  document.getElementById('group-filter').value = '';
  
  // Filtrer pour ne montrer que les unknown aliases
  const lastPlan = window.globalConfig?.getLastPlanData();
  const unknownAliases = new Set(lastPlan?.unknown_aliases || []);
  
  filteredAliases = {};
  Object.entries(allAliases).forEach(([alias, group]) => {
    if (unknownAliases.has(alias)) {
      filteredAliases[alias] = group;
    }
  });
  
  renderAliases();
}

function exportAliases() {
  const blob = new Blob([JSON.stringify(allAliases, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'taxonomy_aliases.json';
  a.click();
  URL.revokeObjectURL(url);
}

// Nouvelles fonctions unifi√©es avec CoinGecko
async function getSuggestions() {
  try {
    const apiBase = globalConfig.get('api_base_url');
    const useCoingecko = document.getElementById('coingecko-enabled').checked;
    const endpoint = useCoingecko ? '/taxonomy/suggestions-enhanced' : '/taxonomy/suggestions';
    const response = await fetch(`${apiBase}${endpoint}`);
    
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    const data = await response.json();
    const { suggestions, auto_classified_count, unknown_count, coverage } = data;
    
    if (auto_classified_count === 0) {
      showNotification('Aucune suggestion automatique trouv√©e', 'info');
      return;
    }
    
    const coveragePercent = Math.round(coverage * 100);
    const suggestionsList = Object.entries(suggestions)
      .map(([symbol, group]) => `${symbol} ‚Üí ${group}`)
      .slice(0, 5)
      .join(', ');
    
    const sourceIcon = useCoingecko ? 'üöÄ' : 'üîç';
    const sourceLabel = useCoingecko ? 'Mode intelligent (regex + CoinGecko)' : 'Mode regex seul';
    showNotification(
      `${sourceIcon} ${auto_classified_count}/${unknown_count} suggestions trouv√©es (${coveragePercent}%)\nüìä ${sourceLabel}\nüí° ${suggestionsList}`, 
      'info', 
      10000
    );
    
  } catch (error) {
    showNotification(`‚ùå Erreur suggestions: ${error.message}`, 'error');
  }
}

async function autoClassify() {
  if (!confirm('Appliquer automatiquement la classification intelligente aux symboles inconnus ?')) {
    return;
  }
  
  try {
    const apiBase = globalConfig.get('api_base_url');
    const useCoingecko = document.getElementById('coingecko-enabled').checked;
    const endpoint = useCoingecko ? '/taxonomy/auto-classify-enhanced' : '/taxonomy/auto-classify';
    const response = await fetch(`${apiBase}${endpoint}`, {
      method: 'POST'
    });
    
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    const data = await response.json();
    
    if (data.classified === 0) {
      showNotification(data.message || 'Aucune classification automatique appliqu√©e', 'info');
    } else {
      const sourceIcon = useCoingecko ? 'üöÄ' : 'üîç';
      const sourceLabel = useCoingecko ? '(avec CoinGecko)' : '(regex seul)';
      showNotification(`‚úÖ ${data.classified} aliases classifi√©s automatiquement ${sourceLabel}`, 'success');
      await loadData(); // Recharger les donn√©es
    }
    
  } catch (error) {
    showNotification(`‚ùå Erreur classification auto: ${error.message}`, 'error');
  }
}

function showNotification(message, type = 'info', duration = 3000) {
  const notification = document.createElement('div');
  notification.className = 'notification';
  notification.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 1000;
    background: ${type === 'success' ? 'var(--pos)' : type === 'error' ? 'var(--danger)' : 'var(--accent)'};
    color: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    max-width: 400px;
    word-wrap: break-word;
    white-space: pre-line;
  `;
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, duration);
}
</script>

</body>
</html>