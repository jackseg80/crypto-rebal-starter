<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Command Center - Crypto Portfolio</title>

    <!-- Styles -->
    <link rel="stylesheet" href="shared-theme.css">
    <link rel="stylesheet" href="theme-compat.css">

    <!-- Navigation unifi√©e -->
    <script type="module" src="components/nav.js"></script>
    <script type="module" src="components/tooltips.js"></script>

    <!-- Scripts de base -->
    <script src="debug-logger.js"></script>
    <script src="input-validator.js"></script>
    <script src="performance-optimizer.js"></script>
    <script src="global-config.js"></script>
    <script src="appearance.js"></script>

    <!-- Store & Core -->
    <script src="core/risk-dashboard-store.js"></script>

    <!-- ML Components (factoris√©s) -->
    <script type="module" src="components/ml/index.js"></script>

    <style>
        body {
            margin: 0;
            background: var(--theme-background);
            color: var(--theme-text);
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.6;
        }

        .wrap {
            max-width: 95vw;
            margin: 0 auto;
            padding: 16px;
        }

        .dashboard-container {
            max-width: 100%;
            padding: 0;
            margin: 0 auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .page-title-container {
            flex: 1;
            min-width: 300px;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            color: var(--theme-text);
        }

        .page-subtitle {
            font-size: 1rem;
            color: var(--theme-text-muted);
            margin: 0.5rem 0 0 0;
        }

        .global-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            font-size: 0.9rem;
        }

        .btn.primary {
            background: var(--brand-primary);
            color: white;
        }

        .btn.primary:hover {
            background: var(--brand-primary-hover);
        }

        .btn.secondary {
            background: var(--theme-surface-elevated);
            color: var(--theme-text);
            border: 1px solid var(--theme-border);
        }

        .btn.secondary:hover {
            background: var(--theme-muted);
        }

        /* Command Center Layout */
        .command-center-layout {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: 2fr 1fr;
            margin-bottom: 2rem;
        }

        .main-insight-column {
            display: grid;
            gap: 1rem;
        }

        .sidebar-ops-column {
            display: grid;
            gap: 1rem;
        }

        /* Section Cards */
        .section-card {
            background: var(--theme-surface);
            border-radius: var(--radius-md);
            border: 1px solid var(--theme-border);
            overflow: hidden;
        }

        .section-header {
            background: var(--theme-surface-elevated);
            border-bottom: 1px solid var(--theme-border);
            padding: 1rem 1.25rem;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .section-icon {
            margin-right: 0.5rem;
        }

        .section-content {
            padding: 1.25rem;
        }

        /* Model Health Grid */
        .model-health-grid {
            display: grid;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        /* XAI Section */
        .xai-section {
            background: var(--theme-surface-elevated);
            border-radius: var(--radius-sm);
            padding: 1rem;
            margin-top: 1rem;
        }

        .xai-title {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--theme-text);
        }

        .xai-explanation {
            display: grid;
            gap: 0.5rem;
        }

        .xai-bullet {
            font-size: 0.9rem;
            color: var(--theme-text-muted);
            padding-left: 1rem;
            position: relative;
        }

        .xai-bullet:before {
            content: "‚Ä¢";
            position: absolute;
            left: 0;
            color: var(--brand-primary);
            font-weight: bold;
        }

        /* Runbooks */
        .runbooks-section {
            margin-top: 1rem;
        }

        .runbook-links {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .runbook-link {
            font-size: 0.8rem;
            color: var(--brand-primary);
            text-decoration: none;
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--brand-primary);
            border-radius: var(--radius-xs);
            transition: all 0.2s;
        }

        .runbook-link:hover {
            background: var(--brand-primary);
            color: white;
        }

        /* Status indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-xs);
            font-weight: 500;
        }

        .status-indicator.operational {
            background: var(--success-bg);
            color: var(--success);
        }

        .status-indicator.warning {
            background: var(--warning-bg);
            color: var(--warning);
        }

        .status-indicator.error {
            background: var(--danger-bg);
            color: var(--danger);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .command-center-layout {
                grid-template-columns: 1fr;
            }

            .sidebar-ops-column {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .wrap {
                padding: 12px;
            }

            .page-header {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .sidebar-ops-column {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <!-- Header -->
        <div class="page-header">
            <div class="page-title-container">
                <h1 class="page-title">ü§ñ ML Command Center</h1>
                <p class="page-subtitle">
                    Vue op√©rationnelle unifi√©e : Decision Engine, Model Health, Logs XAI & KPIs Ops
                </p>
            </div>
            <div class="global-actions">
                <a href="analytics-unified.html#ml" class="btn secondary">üìä Analytics ML</a>
                <a href="risk-dashboard.html#governance" class="btn secondary">üèõÔ∏è Governance</a>
                <button class="btn primary" onclick="refreshAll()">üîÑ Refresh</button>
            </div>
        </div>

        <!-- ML Command Center Layout -->
        <div class="command-center-layout">
            <!-- Main Column: Global Insight + Model Health -->
            <div class="main-insight-column">
                <!-- Global Insight & Politique (Decision Index + r√©sum√© SMART + cap effectif) -->
                <div class="section-card">
                    <div class="section-header">
                        <div>
                            <span class="section-icon">üß≠</span>
                            Global Insight & Politique
                        </div>
                        <div class="status-indicator operational" id="insight-status">
                            <span>üü¢</span> Operational
                        </div>
                    </div>
                    <div class="section-content">
                        <!-- Badge unifi√© (Source ‚Ä¢ Updated ‚Ä¢ Contrad ‚Ä¢ Cap ‚Ä¢ Overrides) -->
                        <div id="global-badges-container"></div>

                        <!-- Global Insight ML Component -->
                        <div id="global-insight-container"></div>

                        <!-- XAI Explanation (‚â§3 puces) -->
                        <div class="xai-section">
                            <div class="xai-title">ü§ñ Pourquoi cette d√©cision ? (XAI)</div>
                            <div class="xai-explanation" id="xai-explanation-container">
                                <div class="xai-bullet">Analyse en cours...</div>
                            </div>
                        </div>

                        <!-- Runbooks -->
                        <div class="runbooks-section">
                            <div class="xai-title">üìö Runbooks</div>
                            <div class="runbook-links">
                                <a href="#" class="runbook-link" onclick="showRunbook('freeze-s3')">Freeze S3</a>
                                <a href="#" class="runbook-link" onclick="showRunbook('caps-order')">Ordre Caps</a>
                                <a href="#" class="runbook-link" onclick="showRunbook('stale-error')">Stale/Error</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Model Health -->
                <div class="section-card">
                    <div class="section-header">
                        <div>
                            <span class="section-icon">ü©∫</span>
                            Model Health
                        </div>
                        <div class="status-indicator" id="health-status">
                            <span>üîÑ</span> Checking...
                        </div>
                    </div>
                    <div class="section-content">
                        <div id="model-health-container"></div>
                    </div>
                </div>
            </div>

            <!-- Sidebar Column: Ops KPIs -->
            <div class="sidebar-ops-column">
                <!-- KPIs Op√©rationnels -->
                <div class="section-card">
                    <div class="section-header">
                        <div>
                            <span class="section-icon">üìä</span>
                            Ops KPIs
                        </div>
                    </div>
                    <div class="section-content">
                        <div id="ops-kpis-container"></div>
                    </div>
                </div>

                <!-- System Status -->
                <div class="section-card">
                    <div class="section-header">
                        <div>
                            <span class="section-icon">üíì</span>
                            System Status
                        </div>
                    </div>
                    <div class="section-content">
                        <div id="system-status-container">
                            <div class="status-grid">
                                <div class="status-item" id="api-status">
                                    <span class="status-label">API:</span>
                                    <span class="status-value">--</span>
                                </div>
                                <div class="status-item" id="ml-status">
                                    <span class="status-label">ML:</span>
                                    <span class="status-value">--</span>
                                </div>
                                <div class="status-item" id="governance-status">
                                    <span class="status-label">Governance:</span>
                                    <span class="status-value">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { MLComponents } from './components/ml/index.js';

        // Variables globales
        let mlComponents;
        let store;

        // Initialisation
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ ML Command Center initializing...');

            try {
                // Initialiser le store (risk-dashboard-store.js)
                if (typeof window.store !== 'undefined') {
                    store = window.store;
                } else {
                    // Fallback si store pas disponible
                    console.warn('Store not available, using fallback');
                    store = { get: () => null, subscribe: () => {} };
                }

                // Initialiser les composants ML
                mlComponents = new MLComponents(store);
                mlComponents.addStyles();

                // Rendu du Command Center
                renderCommandCenter();

                // Setup des mises √† jour automatiques
                setupAutoUpdates();

                // Status initial
                updateSystemStatus();

                console.log('‚úÖ ML Command Center initialized');

            } catch (error) {
                console.error('‚ùå ML Command Center initialization failed:', error);
                showError('Initialization failed: ' + error.message);
            }
        });

        // Rendu du Command Center
        function renderCommandCenter() {
            // Badges globaux
            mlComponents.badges.setupAutoUpdate(
                document.getElementById('global-badges-container')
            );

            // Global Insight
            mlComponents.globalInsight.setupAutoUpdate(
                document.getElementById('global-insight-container'),
                { compact: false, showDetails: true }
            );

            // Model Health
            mlComponents.modelHealth.setupAutoUpdate(
                document.getElementById('model-health-container'),
                { compact: false }
            );

            // Ops KPIs
            mlComponents.opsKpis.setupAutoUpdate(
                document.getElementById('ops-kpis-container'),
                { compact: true }
            );
        }

        // Setup des mises √† jour automatiques
        function setupAutoUpdates() {
            // Refresh XAI explanations
            setInterval(updateXAIExplanations, 30000);

            // Refresh system status
            setInterval(updateSystemStatus, 60000);

            // √âcoute les √©v√©nements du store
            if (store && store.subscribe) {
                store.subscribe(() => {
                    updateInsightStatus();
                    updateXAIExplanations();
                });
            }
        }

        // Met √† jour les explications XAI
        function updateXAIExplanations() {
            const container = document.getElementById('xai-explanation-container');
            if (!container) return;

            // R√©cup√®re les donn√©es depuis le store
            const governance = store?.get('governance') || {};
            const mlSignals = governance.ml_signals || {};

            // G√©n√®re 3 explications maximum
            const explanations = [];

            // 1. R√®gle r√©gime/cycle
            if (mlSignals.regime) {
                const regime = mlSignals.regime.current || 'unknown';
                explanations.push(`R√©gime ${regime} d√©tect√© ‚Üí Ajustement allocation`);
            }

            // 2. Contributeur principal
            if (mlSignals.on_chain_score) {
                const score = Math.round(mlSignals.on_chain_score * 100);
                const trend = score > 60 ? '‚Üë' : score < 40 ? '‚Üì' : '‚Üí';
                explanations.push(`On-Chain Score ${score}% ${trend} ‚Üí Impact risque`);
            }

            // 3. Garde-fou engag√©
            if (governance.freeze_status) {
                explanations.push(`Freeze ${governance.freeze_status.toUpperCase()} activ√© ‚Üí S√©curit√© renforc√©e`);
            } else if (governance.cap_alert) {
                const cap = Math.round(governance.cap_alert * 100);
                explanations.push(`Cap Alert ${cap}% ‚Üí R√©duction exposition`);
            }

            // Fallback si pas d'explications
            if (explanations.length === 0) {
                explanations.push('Syst√®me en mode nominal - Aucun ajustement sp√©cifique');
            }

            // Rendu
            container.innerHTML = explanations.map(exp =>
                `<div class="xai-bullet">${exp}</div>`
            ).join('');
        }

        // Met √† jour le statut du syst√®me
        async function updateSystemStatus() {
            try {
                // API Status
                const apiStart = performance.now();
                const healthResponse = await fetch('/api/health');
                const apiLatency = Math.round(performance.now() - apiStart);

                document.getElementById('api-status').querySelector('.status-value').textContent =
                    healthResponse.ok ? `${apiLatency}ms` : 'Error';

                // ML Status
                const mlResponse = await fetch('/api/ml/status');
                const mlData = mlResponse.ok ? await mlResponse.json() : null;
                document.getElementById('ml-status').querySelector('.status-value').textContent =
                    mlData ? `${mlData.active_models || 0}/4` : 'Error';

                // Governance Status
                const govResponse = await fetch('/api/governance/state');
                const govData = govResponse.ok ? await govResponse.json() : null;
                document.getElementById('governance-status').querySelector('.status-value').textContent =
                    govData ? (govData.status || 'Active') : 'Error';

            } catch (error) {
                console.warn('System status update failed:', error);
            }
        }

        // Met √† jour le statut de l'insight
        function updateInsightStatus() {
            const governance = store?.get('governance') || {};
            const mlSignals = governance.ml_signals || {};
            const statusEl = document.getElementById('insight-status');

            if (mlSignals.timestamp) {
                const lastUpdate = new Date(mlSignals.timestamp);
                const ageMinutes = (Date.now() - lastUpdate.getTime()) / 60000;

                if (ageMinutes < 10) {
                    statusEl.className = 'status-indicator operational';
                    statusEl.innerHTML = '<span>üü¢</span> Operational';
                } else if (ageMinutes < 30) {
                    statusEl.className = 'status-indicator warning';
                    statusEl.innerHTML = '<span>üü°</span> Stale';
                } else {
                    statusEl.className = 'status-indicator error';
                    statusEl.innerHTML = '<span>üî¥</span> Error';
                }
            }
        }

        // Actions globales
        window.refreshAll = function() {
            console.log('üîÑ Refreshing all components...');
            location.reload();
        };

        window.showRunbook = function(type) {
            const runbooks = {
                'freeze-s3': 'Freeze S3: Purchases blocked, risk reductions allowed. Check governance.freeze_status.',
                'caps-order': 'Caps Priority: error(5%) > stale(8%) > alert_cap > engine_cap. Min value applies.',
                'stale-error': 'Stale/Error: Check ML signals timestamp, restart if needed.'
            };

            alert(runbooks[type] || 'Runbook not found');
        };

        function showError(message) {
            document.querySelector('.dashboard-container').innerHTML = `
                <div style="text-align: center; padding: 4rem; color: var(--danger);">
                    <h2>‚ö†Ô∏è Error</h2>
                    <p>${message}</p>
                    <button onclick="location.reload()" class="btn primary">Retry</button>
                </div>
            `;
        }
    </script>

    <style>
        /* System Status Grid */
        .status-grid {
            display: grid;
            gap: 0.75rem;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .status-label {
            font-weight: 500;
            color: var(--theme-text-muted);
        }

        .status-value {
            font-weight: 600;
            color: var(--theme-text);
        }
    </style>
</body>

</html>