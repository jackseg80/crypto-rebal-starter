<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test WealthContextBar - Int√©gration Source</title>
    <link rel="stylesheet" href="shared-theme.css">
    <link rel="stylesheet" href="theme-compat.css">
    <script type="module" src="components/nav.js"></script>
    <script type="module" src="components/WealthContextBar.js"></script>
    <script src="global-config.js"></script>
    <style>
        body {
            padding: 2rem;
            background: var(--theme-bg);
            color: var(--theme-text);
        }
        .test-section {
            background: var(--theme-surface);
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin: 2rem 0;
        }
        .test-section h2 {
            margin-top: 0;
            color: var(--brand-primary);
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        .status-item {
            background: var(--theme-bg);
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-md);
            padding: 1rem;
        }
        .status-item .label {
            font-size: 0.75rem;
            color: var(--theme-text-muted);
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        .status-item .value {
            font-size: 1.25rem;
            font-weight: 600;
        }
        .btn {
            background: var(--brand-primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.875rem;
            margin-right: 0.5rem;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .btn-secondary {
            background: var(--theme-surface);
            color: var(--theme-text);
            border: 1px solid var(--theme-border);
        }
        .log-output {
            background: var(--theme-bg);
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-md);
            padding: 1rem;
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
        }
        .log-entry {
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--theme-border);
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-time {
            color: var(--theme-text-muted);
            margin-right: 0.5rem;
        }
        .status-ok {
            color: var(--success);
        }
        .status-error {
            color: var(--danger);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test WealthContextBar - Int√©gration Source</h1>
        <p>V√©rification que le changement de source dans le menu "Compte" change bien la source de donn√©es pour tout le projet.</p>

        <div class="test-section">
            <h2>üìä √âtat Global</h2>
            <div class="status-grid">
                <div class="status-item">
                    <div class="label">Utilisateur Actif</div>
                    <div class="value" id="current-user">-</div>
                </div>
                <div class="status-item">
                    <div class="label">WealthContextBar Account</div>
                    <div class="value" id="wealth-account-value">-</div>
                </div>
                <div class="status-item">
                    <div class="label">window.userSettings.data_source</div>
                    <div class="value" id="user-settings-source">-</div>
                </div>
                <div class="status-item">
                    <div class="label">window.globalConfig data_source</div>
                    <div class="value" id="global-config-source">-</div>
                </div>
                <div class="status-item">
                    <div class="label">CSV Selected File</div>
                    <div class="value" id="csv-selected-file">-</div>
                </div>
                <div class="status-item">
                    <div class="label">Backend Saved Source</div>
                    <div class="value" id="backend-source">-</div>
                </div>
            </div>

            <div style="margin-top: 1rem;">
                <button class="btn" onclick="refreshAllStatus()">üîÑ Rafra√Æchir Tout</button>
                <button class="btn btn-secondary" onclick="testSourceChange()">üß™ Test Auto Changement</button>
                <button class="btn btn-secondary" onclick="clearLogs()">üóëÔ∏è Vider Logs</button>
            </div>
        </div>

        <div class="test-section">
            <h2>üìã Logs</h2>
            <div class="log-output" id="log-output">
                <div class="log-entry">En attente...</div>
            </div>
        </div>

        <div class="test-section">
            <h2>‚úÖ Checklist Validation</h2>
            <ul id="validation-checklist">
                <li id="check-1">‚è≥ Chargement initial...</li>
                <li id="check-2">‚è≥ WealthContextBar sources charg√©es...</li>
                <li id="check-3">‚è≥ window.userSettings initialis√©...</li>
                <li id="check-4">‚è≥ window.globalConfig initialis√©...</li>
                <li id="check-5">‚è≥ Synchronisation sources...</li>
            </ul>
        </div>
    </div>

    <script>
        const logOutput = document.getElementById('log-output');

        function addLog(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const typeColor = type === 'error' ? 'var(--danger)' : type === 'success' ? 'var(--success)' : 'var(--theme-text)';
            entry.innerHTML = `<span class="log-time">${time}</span><span style="color: ${typeColor}">${message}</span>`;
            logOutput.appendChild(entry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function clearLogs() {
            logOutput.innerHTML = '<div class="log-entry">Logs vid√©s.</div>';
        }

        function updateChecklistItem(id, status, message) {
            const item = document.getElementById(id);
            if (!item) return;

            const icon = status === 'ok' ? '‚úÖ' : status === 'error' ? '‚ùå' : '‚è≥';
            item.innerHTML = `${icon} ${message}`;
            item.className = status === 'ok' ? 'status-ok' : status === 'error' ? 'status-error' : '';
        }

        async function refreshAllStatus() {
            addLog('üîÑ Rafra√Æchissement de tous les status...');

            // User actif
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            document.getElementById('current-user').textContent = activeUser;

            // WealthContextBar context
            const wealthCtx = window.wealthContextBar?.getContext?.();
            document.getElementById('wealth-account-value').textContent = wealthCtx?.account || '-';

            // window.userSettings
            const userSource = window.userSettings?.data_source || '-';
            document.getElementById('user-settings-source').textContent = userSource;

            // window.globalConfig
            const globalSource = window.globalConfig?.get?.('data_source') || '-';
            document.getElementById('global-config-source').textContent = globalSource;

            // CSV file
            const csvFile = window.userSettings?.csv_selected_file || '-';
            document.getElementById('csv-selected-file').textContent = csvFile;

            // Backend source (via API)
            try {
                const response = await fetch('/api/users/settings', {
                    headers: { 'X-User': activeUser }
                });
                if (response.ok) {
                    const settings = await response.json();
                    document.getElementById('backend-source').textContent = settings.data_source || '-';

                    // V√©rifier coh√©rence
                    if (settings.data_source === userSource) {
                        addLog('‚úÖ Backend et frontend synchronis√©s', 'success');
                        updateChecklistItem('check-5', 'ok', 'Synchronisation sources OK');
                    } else {
                        addLog(`‚ö†Ô∏è D√©synchronisation: backend=${settings.data_source}, frontend=${userSource}`, 'error');
                        updateChecklistItem('check-5', 'error', `D√©synchronisation d√©tect√©e`);
                    }
                } else {
                    document.getElementById('backend-source').textContent = 'Erreur';
                    addLog('‚ùå Erreur lors de la r√©cup√©ration des settings backend', 'error');
                }
            } catch (error) {
                document.getElementById('backend-source').textContent = 'Erreur';
                addLog(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        async function testSourceChange() {
            addLog('üß™ D√©but du test de changement de source automatique...');

            // R√©cup√©rer les sources disponibles
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            try {
                const response = await fetch('/api/users/sources', {
                    headers: { 'X-User': activeUser }
                });

                if (!response.ok) {
                    addLog('‚ùå Impossible de charger les sources', 'error');
                    return;
                }

                const data = await response.json();
                const sources = data.sources || [];

                if (sources.length < 2) {
                    addLog('‚ö†Ô∏è Pas assez de sources pour tester (minimum 2)', 'error');
                    return;
                }

                // Prendre la premi√®re source CSV et la premi√®re API (ou 2 CSV)
                const firstSource = sources[0];
                const secondSource = sources[1];

                addLog(`üìÑ Test 1: Changement vers ${firstSource.label}...`);

                // Simuler un changement via le dropdown
                const accountSelect = document.getElementById('wealth-account');
                if (!accountSelect) {
                    addLog('‚ùå Dropdown wealth-account introuvable', 'error');
                    return;
                }

                // Changer vers premi√®re source
                accountSelect.value = `${firstSource.type}:${firstSource.key}`;
                accountSelect.dispatchEvent(new Event('change', { bubbles: true }));

                // Attendre un peu
                await new Promise(resolve => setTimeout(resolve, 1000));

                // V√©rifier
                await refreshAllStatus();

                addLog(`üìÑ Test 2: Changement vers ${secondSource.label}...`);

                // Changer vers seconde source
                accountSelect.value = `${secondSource.type}:${secondSource.key}`;
                accountSelect.dispatchEvent(new Event('change', { bubbles: true }));

                // Attendre un peu
                await new Promise(resolve => setTimeout(resolve, 1000));

                // V√©rifier
                await refreshAllStatus();

                addLog('‚úÖ Test automatique termin√© - V√©rifiez les r√©sultats ci-dessus', 'success');

            } catch (error) {
                addLog(`‚ùå Erreur durant le test: ${error.message}`, 'error');
            }
        }

        // Initialisation
        setTimeout(async () => {
            addLog('üöÄ Initialisation...');
            updateChecklistItem('check-1', 'ok', 'Chargement initial OK');

            // Attendre que WealthContextBar soit charg√©
            let retries = 0;
            while (!window.wealthContextBar && retries < 10) {
                await new Promise(resolve => setTimeout(resolve, 200));
                retries++;
            }

            if (window.wealthContextBar) {
                addLog('‚úÖ WealthContextBar charg√©');
                updateChecklistItem('check-2', 'ok', 'WealthContextBar sources charg√©es');
            } else {
                addLog('‚ùå WealthContextBar non charg√© apr√®s 2s', 'error');
                updateChecklistItem('check-2', 'error', 'WealthContextBar non trouv√©');
            }

            // V√©rifier window.userSettings
            if (window.userSettings) {
                addLog('‚úÖ window.userSettings initialis√©');
                updateChecklistItem('check-3', 'ok', 'window.userSettings initialis√©');
            } else {
                addLog('‚ö†Ô∏è window.userSettings non initialis√© (sera cr√©√© au premier changement)');
                updateChecklistItem('check-3', 'error', 'window.userSettings non initialis√©');
            }

            // V√©rifier window.globalConfig
            if (window.globalConfig) {
                addLog('‚úÖ window.globalConfig disponible');
                updateChecklistItem('check-4', 'ok', 'window.globalConfig initialis√©');
            } else {
                addLog('‚ùå window.globalConfig non disponible', 'error');
                updateChecklistItem('check-4', 'error', 'window.globalConfig manquant');
            }

            // Rafra√Æchir tous les status
            await refreshAllStatus();

        }, 1500);

        // √âcouter wealth:change
        window.addEventListener('wealth:change', (e) => {
            addLog('üì¢ Event wealth:change re√ßu', 'info');
            console.log('wealth:change detail:', e.detail);
        });
    </script>
</body>
</html>
