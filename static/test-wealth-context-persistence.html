<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test WealthContextBar Persistence</title>
    <link rel="stylesheet" href="shared-theme.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
        }
        .test-section {
            background: var(--theme-surface);
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .test-result {
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: var(--radius-sm);
        }
        .test-pass { background: var(--success-bg); color: var(--success); }
        .test-fail { background: var(--danger-bg); color: var(--danger); }
        .test-info { background: var(--info-bg); color: var(--info); }
        pre { background: var(--theme-bg); padding: 1rem; border-radius: var(--radius-sm); overflow-x: auto; }
        button {
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            border-radius: var(--radius-sm);
            border: 1px solid var(--theme-border);
            cursor: pointer;
        }
        .btn-primary { background: var(--brand-primary); color: white; border-color: var(--brand-primary); }
        .btn-secondary { background: var(--theme-surface); color: var(--theme-text); }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ðŸ§ª Test WealthContextBar Persistence</h1>

        <div class="test-section">
            <h2>Context State Tests</h2>
            <div id="context-tests"></div>
            <button class="btn-primary" onclick="runContextTests()">Run Context Tests</button>
        </div>

        <div class="test-section">
            <h2>LocalStorage Tests</h2>
            <div id="storage-tests"></div>
            <button class="btn-primary" onclick="runStorageTests()">Run Storage Tests</button>
        </div>

        <div class="test-section">
            <h2>Querystring Tests</h2>
            <div id="querystring-tests"></div>
            <button class="btn-primary" onclick="runQuerystringTests()">Run Querystring Tests</button>
        </div>

        <div class="test-section">
            <h2>Cross-Page Navigation Tests</h2>
            <div id="navigation-tests">
                <p>Test different contexts by clicking these links:</p>
                <button class="btn-secondary" onclick="testNavigation('crypto')">Navigate with Crypto Context</button>
                <button class="btn-secondary" onclick="testNavigation('bourse')">Navigate with Bourse Context</button>
                <button class="btn-secondary" onclick="testNavigation('banque')">Navigate with Banque Context</button>
            </div>
        </div>

        <div class="test-section">
            <h2>Current Context State</h2>
            <div id="current-context">
                <button class="btn-primary" onclick="showCurrentContext()">Show Current Context</button>
                <pre id="context-display"></pre>
            </div>
        </div>
    </div>

    <script type="module">
        import { wealthContextBar } from './components/WealthContextBar.js';

        window.wealthContextBar = wealthContextBar;

        // Test functions
        window.runContextTests = function() {
            const results = document.getElementById('context-tests');
            results.innerHTML = '';

            // Test 1: Check if WealthContextBar is available
            const test1 = document.createElement('div');
            test1.className = window.wealthContextBar ? 'test-result test-pass' : 'test-result test-fail';
            test1.textContent = `âœ“ WealthContextBar ${window.wealthContextBar ? 'available' : 'not available'}`;
            results.appendChild(test1);

            if (!window.wealthContextBar) return;

            // Test 2: Check getContext method
            try {
                const context = window.wealthContextBar.getContext();
                const test2 = document.createElement('div');
                test2.className = 'test-result test-pass';
                test2.textContent = `âœ“ getContext() returns: ${JSON.stringify(context)}`;
                results.appendChild(test2);
            } catch (error) {
                const test2 = document.createElement('div');
                test2.className = 'test-result test-fail';
                test2.textContent = `âœ— getContext() failed: ${error.message}`;
                results.appendChild(test2);
            }

            // Test 3: Check setContext method
            try {
                const testContext = {
                    household: 'Test Household',
                    account: 'Test Account',
                    module: 'crypto',
                    currency: 'EUR'
                };
                window.wealthContextBar.setContext(testContext);

                const test3 = document.createElement('div');
                test3.className = 'test-result test-pass';
                test3.textContent = 'âœ“ setContext() works';
                results.appendChild(test3);
            } catch (error) {
                const test3 = document.createElement('div');
                test3.className = 'test-result test-fail';
                test3.textContent = `âœ— setContext() failed: ${error.message}`;
                results.appendChild(test3);
            }
        };

        window.runStorageTests = function() {
            const results = document.getElementById('storage-tests');
            results.innerHTML = '';

            // Test localStorage read/write
            const testData = {
                household: 'Storage Test',
                account: 'Test Account',
                module: 'bourse',
                currency: 'CHF'
            };

            try {
                localStorage.setItem('wealth_context', JSON.stringify(testData));
                const retrieved = JSON.parse(localStorage.getItem('wealth_context'));

                const isEqual = JSON.stringify(testData) === JSON.stringify(retrieved);
                const test1 = document.createElement('div');
                test1.className = isEqual ? 'test-result test-pass' : 'test-result test-fail';
                test1.textContent = `${isEqual ? 'âœ“' : 'âœ—'} LocalStorage read/write works`;
                results.appendChild(test1);
            } catch (error) {
                const test1 = document.createElement('div');
                test1.className = 'test-result test-fail';
                test1.textContent = `âœ— LocalStorage failed: ${error.message}`;
                results.appendChild(test1);
            }
        };

        window.runQuerystringTests = function() {
            const results = document.getElementById('querystring-tests');
            results.innerHTML = '';

            // Test current querystring parsing
            const urlParams = new URLSearchParams(window.location.search);
            const hasWealthParams = urlParams.has('household') || urlParams.has('module');

            const test1 = document.createElement('div');
            test1.className = 'test-result test-info';
            test1.textContent = `Current URL params: ${window.location.search || 'none'}`;
            results.appendChild(test1);

            const test2 = document.createElement('div');
            test2.className = hasWealthParams ? 'test-result test-pass' : 'test-result test-info';
            test2.textContent = `${hasWealthParams ? 'âœ“' : 'â„¹'} Wealth parameters in URL: ${hasWealthParams ? 'found' : 'not found'}`;
            results.appendChild(test2);
        };

        window.testNavigation = function(module) {
            if (!window.wealthContextBar) {
                alert('WealthContextBar not available');
                return;
            }

            // Set a specific context for testing
            const testContext = {
                household: `Test ${module.toUpperCase()}`,
                account: 'Navigation Test',
                module: module,
                currency: 'USD'
            };

            window.wealthContextBar.setContext(testContext);

            // Navigate to different pages with context
            const pages = ['rebalance.html', 'execution.html'];
            const targetPage = pages[Math.floor(Math.random() * pages.length)];

            // Add querystring parameters
            const params = new URLSearchParams();
            params.set('household', testContext.household);
            params.set('account', testContext.account);
            params.set('module', testContext.module);
            params.set('currency', testContext.currency);

            window.location.href = `${targetPage}?${params.toString()}`;
        };

        window.showCurrentContext = function() {
            const display = document.getElementById('context-display');

            if (window.wealthContextBar) {
                const context = window.wealthContextBar.getContext();
                display.textContent = JSON.stringify(context, null, 2);
            } else {
                display.textContent = 'WealthContextBar not available';
            }

            // Also show localStorage and URL params
            const localStorage = window.localStorage.getItem('wealth_context');
            const urlParams = new URLSearchParams(window.location.search);

            display.textContent += '\n\nLocalStorage:\n' + (localStorage || 'not set');
            display.textContent += '\n\nURL Parameters:\n' + (window.location.search || 'none');
        };

        // Auto-run tests on load
        document.addEventListener('DOMContentLoaded', () => {
            runContextTests();
            runStorageTests();
            runQuerystringTests();
            showCurrentContext();
        });
    </script>
</body>
</html>