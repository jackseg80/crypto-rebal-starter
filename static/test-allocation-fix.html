<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Allocation Fix</title>
    <style>
        body { font-family: system-ui; margin: 20px; background: #1a1a1a; color: #fff; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #2d5016; border: 1px solid #4caf50; }
        .error { background: #5d1a1a; border: 1px solid #f44336; }
        .info { background: #1a2d5d; border: 1px solid #2196f3; }
        pre { background: #2a2a2a; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîß Test Fix Allocation Sugg√©r√©e</h1>
    <div id="results"></div>

    <script type="module">
        import { getUnifiedState } from './core/unified-insights-v2.js';
        import { calculateIntelligentDecisionIndexAPI } from './core/strategy-api-adapter.js';

        const results = document.getElementById('results');

        function addResult(type, title, content) {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>${title}</strong><br>${content}`;
            results.appendChild(div);
        }

        async function testAllocationFix() {
            addResult('info', 'üß™ Starting allocation test', 'Testing unified-insights-v2.js contradictions fix...');

            try {
                // Test 1: Basic module loading
                addResult('success', '‚úÖ Module Import', 'unified-insights-v2.js loaded successfully');

                // Test 2: Get unified state
                const unifiedState = await getUnifiedState();
                addResult('success', '‚úÖ getUnifiedState()', `State loaded: cycle=${unifiedState.cycle?.score}, onchain=${unifiedState.onchain?.score}`);

                // Test 3: Check contradictions
                if (unifiedState.contradictions) {
                    addResult('success', '‚úÖ Contradictions Analysis', `Found ${unifiedState.contradictions.length} contradictions`);
                } else {
                    addResult('info', '‚ÑπÔ∏è Contradictions Analysis', 'No contradictions detected');
                }

                // Test 4: Strategy API test
                const mockContext = {
                    blendedScore: 65,
                    cycleData: { score: 75, phase: { phase: 'growth' } },
                    onchainScore: 60,
                    riskScore: 45,
                    contradiction: 0.1
                };

                const decision = await calculateIntelligentDecisionIndexAPI(mockContext);
                addResult('success', '‚úÖ Strategy API', `Decision score: ${decision.score}, source: ${decision.source}`);

                // Test 5: Check allocation data
                if (unifiedState.intelligence?.allocation) {
                    addResult('success', '‚úÖ Allocation Data', `Found allocation: ${Object.keys(unifiedState.intelligence.allocation).join(', ')}`);
                    addResult('info', 'üíæ Allocation Details', `<pre>${JSON.stringify(unifiedState.intelligence.allocation, null, 2)}</pre>`);
                } else {
                    addResult('error', '‚ùå Allocation Data', 'No allocation data found in unified state');
                }

                // Test 6: Full state debug
                addResult('info', 'üîç Full State Debug', `<pre>${JSON.stringify({
                    decision: unifiedState.decision,
                    strategy: unifiedState.strategy,
                    health: unifiedState.health
                }, null, 2)}</pre>`);

            } catch (error) {
                addResult('error', '‚ùå Test Failed', `Error: ${error.message}<br><pre>${error.stack}</pre>`);
            }
        }

        // Run test
        testAllocationFix();
    </script>
</body>
</html>