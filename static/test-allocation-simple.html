<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🧪 Test Allocation Simple</title>
  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">
  <script src="global-config.js"></script>
  <script src="appearance.js"></script>
</head>

<body>
  <header class="header">
    <div class="container">
      <h1>🧪 Test Allocation Simple</h1>
      <p>Test direct de l'Allocation Engine V2 sans complexité</p>
    </div>
  </header>

  <main class="container">

    <div class="card">
      <h2>🔧 Actions Rapides</h2>
      <div style="display: flex; gap: 1rem; margin: 1rem 0; flex-wrap: wrap;">
        <button id="enable-apply" class="btn btn-success">✅ Activer Mode APPLY</button>
        <button id="force-eth-expansion" class="btn btn-primary">🟢 Force ETH Expansion</button>
        <button id="test-direct-engine" class="btn btn-warning">🏗️ Test Direct Engine</button>
        <button id="test-unified-state" class="btn btn-info">📊 Test Unified State</button>
      </div>
    </div>

    <div class="card">
      <h2>📊 Résultats</h2>
      <div id="test-results" style="margin-top: 1rem;">
        Cliquez sur un bouton de test pour voir les résultats.
      </div>
    </div>

    <div class="card">
      <h2>📝 Console Logs</h2>
      <button id="clear-logs" class="btn btn-secondary">🗑️ Clear</button>
      <div id="console-logs" style="background: var(--theme-surface); padding: 1rem; border-radius: 6px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.85em; white-space: pre-wrap; margin-top: 0.5rem;"></div>
    </div>

  </main>

  <script type="module">

    const logContainer = document.getElementById('console-logs');
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;

    function addLog(level, ...args) {
      const timestamp = new Date().toLocaleTimeString();
      const message = args.map(arg =>
        typeof arg === 'object' ? JSON.stringify(arg, null, 1) : String(arg)
      ).join(' ');

      logContainer.textContent += `[${timestamp}] ${level}: ${message}\n`;
      logContainer.scrollTop = logContainer.scrollHeight;

      // Call original
      if (level === 'LOG') originalLog(...args);
      else if (level === 'ERROR') originalError(...args);
      else if (level === 'WARN') originalWarn(...args);
    }

    console.log = (...args) => addLog('LOG', ...args);
    console.error = (...args) => addLog('ERROR', ...args);
    console.warn = (...args) => addLog('WARN', ...args);

    document.getElementById('clear-logs').addEventListener('click', () => {
      logContainer.textContent = '';
    });

    // Enable APPLY mode
    document.getElementById('enable-apply').addEventListener('click', () => {
      localStorage.setItem('PHASE_ENGINE_ENABLED', 'apply');
      console.log('✅ Mode APPLY activé');
    });

    // Force ETH expansion
    document.getElementById('force-eth-expansion').addEventListener('click', () => {
      localStorage.setItem('forced_phase', 'eth_expansion');
      localStorage.removeItem('detected_phase_cache');
      console.log('🟢 Phase ETH Expansion forcée');
    });

    // Test direct engine
    document.getElementById('test-direct-engine').addEventListener('click', async () => {
      const results = document.getElementById('test-results');
      results.innerHTML = '<div class="loading">🏗️ Test direct de l\'Allocation Engine...</div>';

      try {
        console.log('🏗️ Testing Allocation Engine V2 directly...');

        const { calculateHierarchicalAllocation } = await import('./core/allocation-engine.js');

        const testContext = {
          cycleScore: 75,
          regimeData: { name: 'expansion', confidence: 0.8 },
          adaptiveWeights: { btc: 0.35, eth: 0.25, stables: 0.25 },
          execution: { cap_pct_per_iter: 7, target_stables_pct: 25 }
        };

        console.log('🧮 Context:', testContext);

        const allocationResult = await calculateHierarchicalAllocation(testContext, [], { enableV2: true });

        console.log('📊 Allocation result:', allocationResult);

        if (allocationResult && allocationResult.allocation) {
          let html = '<h3>🏗️ Allocation Engine V2 - Résultat Direct</h3>';
          html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem; margin: 1rem 0;">';

          Object.entries(allocationResult.allocation)
            .sort(([,a], [,b]) => b - a)
            .forEach(([asset, fraction]) => {
              const pct = (fraction * 100);
              if (pct > 0.1) {
                const color = pct > 20 ? 'var(--success)' : pct > 10 ? 'var(--warning)' : 'var(--info)';
                html += `
                  <div style="background: var(--theme-surface); padding: 0.75rem; border-radius: 6px; border-left: 3px solid ${color};">
                    <div style="font-weight: 600; color: var(--theme-text);">${asset}</div>
                    <div style="font-size: 1.2em; font-weight: 700; color: ${color};">${pct.toFixed(1)}%</div>
                  </div>
                `;
              }
            });

          html += '</div>';

          // Execution info
          if (allocationResult.execution) {
            html += `
              <div style="margin-top: 1rem; padding: 1rem; background: var(--theme-surface); border-radius: 6px;">
                <h4>📋 Execution Plan</h4>
                <ul>
                  <li><strong>Estimated iterations:</strong> ${allocationResult.execution.estimated_iters_to_target || 'N/A'}</li>
                  <li><strong>Max delta:</strong> ${allocationResult.execution.max_delta_pct || 'N/A'}%</li>
                  <li><strong>Cap per iteration:</strong> ${allocationResult.execution.cap_per_iter || 'N/A'}%</li>
                </ul>
              </div>
            `;
          }

          results.innerHTML = html;

        } else {
          console.error('❌ Allocation Engine returned null');
          results.innerHTML = '<div class="error">❌ Allocation Engine returned null</div>';
        }

      } catch (error) {
        console.error('❌ Direct engine test failed:', error);
        results.innerHTML = `<div class="error">❌ Test échoué: ${error.message}</div>`;
      }
    });

    // Test unified state
    document.getElementById('test-unified-state').addEventListener('click', async () => {
      const results = document.getElementById('test-results');
      results.innerHTML = '<div class="loading">📊 Test du Unified State...</div>';

      try {
        console.log('📊 Testing Unified State...');

        const { getUnifiedState } = await import('./core/unified-insights-v2.js');
        const unifiedState = await getUnifiedState();

        console.log('📋 Unified state loaded:', {
          hasTargets: !!unifiedState.targets_by_group,
          keys: Object.keys(unifiedState),
          phase: unifiedState.cycle?.phase?.phase
        });

        if (unifiedState.targets_by_group) {
          let html = '<h3>📊 Unified State - Targets by Group</h3>';
          html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem; margin: 1rem 0;">';

          Object.entries(unifiedState.targets_by_group)
            .sort(([,a], [,b]) => b - a)
            .forEach(([asset, pct]) => {
              if (pct > 0.1) {
                const color = pct > 20 ? 'var(--success)' : pct > 10 ? 'var(--warning)' : 'var(--info)';
                html += `
                  <div style="background: var(--theme-surface); padding: 0.75rem; border-radius: 6px; border-left: 3px solid ${color};">
                    <div style="font-weight: 600; color: var(--theme-text);">${asset}</div>
                    <div style="font-size: 1.2em; font-weight: 700; color: ${color};">${pct.toFixed(1)}%</div>
                  </div>
                `;
              }
            });

          html += '</div>';

          // Phase info
          html += `
            <div style="margin-top: 1rem; padding: 1rem; background: var(--theme-surface); border-radius: 6px;">
              <h4>🎭 Phase Engine Status</h4>
              <ul>
                <li><strong>Mode:</strong> ${localStorage.getItem('PHASE_ENGINE_ENABLED') || 'shadow'}</li>
                <li><strong>Phase détectée:</strong> ${unifiedState.cycle?.phase?.phase || 'unknown'}</li>
                <li><strong>Phase forcée:</strong> ${localStorage.getItem('forced_phase') || 'none'}</li>
                <li><strong>Tilts appliqués:</strong> ${unifiedState.phase?.tiltsApplied ? 'Oui' : 'Non'}</li>
                <li><strong>Source decision:</strong> ${unifiedState.decision?.source || 'unknown'}</li>
              </ul>
            </div>
          `;

          results.innerHTML = html;

        } else {
          console.error('❌ No targets_by_group in unified state');
          results.innerHTML = '<div class="error">❌ Pas de targets_by_group dans le unified state</div>';
        }

      } catch (error) {
        console.error('❌ Unified state test failed:', error);
        results.innerHTML = `<div class="error">❌ Test échoué: ${error.message}<br><small>Vérifiez la console pour plus de détails</small></div>`;
      }
    });

    // Initialize
    console.log('🧪 Test allocation simple page loaded');

  </script>

</body>
</html>