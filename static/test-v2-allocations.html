<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🧪 Test Allocations V2</title>
  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">
  <script src="global-config.js"></script>
  <script src="appearance.js"></script>
</head>

<body>
  <header class="header">
    <div class="container">
      <h1>🧪 Test Allocations V2</h1>
      <p>Test du nouveau système avec Allocation Engine V2</p>
    </div>
  </header>

  <main class="container">

    <div class="card">
      <h2>🔧 Configuration</h2>
      <div style="display: flex; gap: 1rem; margin: 1rem 0;">
        <button id="enable-apply-mode" class="btn btn-success">✅ Activer Mode APPLY</button>
        <button id="force-eth-expansion" class="btn btn-primary">🟢 Force ETH Expansion</button>
        <button id="test-new-system" class="btn btn-warning">🧪 Test Nouveau Système</button>
      </div>
      <div id="config-status" class="alert alert-info">Configuration en cours...</div>
    </div>

    <div class="card">
      <h2>📊 Comparaison Avant/Après</h2>
      <div id="comparison-results" style="margin-top: 1rem;">
        <p>Cliquez sur "Test Nouveau Système" pour voir les différences.</p>
      </div>
    </div>

    <div class="card">
      <h2>🎯 Allocations Actuelles</h2>
      <button id="get-current-allocations" class="btn btn-primary">🔄 Obtenir Allocations Actuelles</button>
      <div id="current-allocations" style="margin-top: 1rem;"></div>
    </div>

    <div class="card">
      <h2>📝 Logs Debug</h2>
      <div id="debug-logs" style="background: var(--theme-surface); padding: 1rem; border-radius: 6px; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.9em; white-space: pre-wrap;"></div>
    </div>

  </main>

  <script type="module">

    // Capture logs
    const originalLog = console.log;
    const originalDebug = console.debug;
    const originalWarn = console.warn;
    const originalError = console.error;

    const logContainer = document.getElementById('debug-logs');
    let logBuffer = [];

    function captureLog(level, ...args) {
      const timestamp = new Date().toLocaleTimeString();
      const message = args.map(arg =>
        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
      ).join(' ');

      logBuffer.push(`[${timestamp}] ${level.toUpperCase()}: ${message}`);

      if (logBuffer.length > 30) {
        logBuffer = logBuffer.slice(-30);
      }

      logContainer.textContent = logBuffer.join('\n');
      logContainer.scrollTop = logContainer.scrollHeight;

      // Call original
      if (level === 'log') originalLog(...args);
      else if (level === 'debug') originalDebug(...args);
      else if (level === 'warn') originalWarn(...args);
      else if (level === 'error') originalError(...args);
    }

    console.log = (...args) => captureLog('log', ...args);
    console.debug = (...args) => captureLog('debug', ...args);
    console.warn = (...args) => captureLog('warn', ...args);
    console.error = (...args) => captureLog('error', ...args);

    // Update config status
    function updateConfigStatus() {
      const mode = localStorage.getItem('PHASE_ENGINE_ENABLED') || 'shadow';
      const forcedPhase = localStorage.getItem('forced_phase');
      const statusEl = document.getElementById('config-status');

      statusEl.innerHTML = `
        <strong>Mode Phase Engine:</strong> ${mode.toUpperCase()}<br>
        <strong>Phase forcée:</strong> ${forcedPhase || 'Auto-détection'}<br>
        <strong>Dernière MAJ:</strong> ${new Date().toLocaleTimeString()}
      `;

      statusEl.className = 'alert ' + (mode === 'apply' ? 'alert-success' : 'alert-warning');
    }

    // Enable APPLY mode
    document.getElementById('enable-apply-mode').addEventListener('click', () => {
      localStorage.setItem('PHASE_ENGINE_ENABLED', 'apply');
      console.log('✅ Mode APPLY activé');
      updateConfigStatus();
    });

    // Force ETH expansion
    document.getElementById('force-eth-expansion').addEventListener('click', () => {
      localStorage.setItem('forced_phase', 'eth_expansion');
      localStorage.removeItem('detected_phase_cache');
      console.log('🟢 Phase ETH Expansion forcée');
      updateConfigStatus();
    });

    // Test new system
    document.getElementById('test-new-system').addEventListener('click', async () => {
      const results = document.getElementById('comparison-results');
      results.innerHTML = '<div class="loading">🧪 Test du nouveau système...</div>';

      try {
        console.log('🚀 TESTING NEW V2 ALLOCATION SYSTEM');

        // Save old allocations (reference)
        console.log('📊 Getting reference allocations (before V2)...');

        // Test 1: Get current unified state
        const { getUnifiedState } = await import('./core/unified-insights-v2.js');
        const unifiedState = await getUnifiedState();

        console.log('🔍 Current unified state:', unifiedState);

        // Test 2: Test Allocation Engine V2 directly
        console.log('🏗️ Testing Allocation Engine V2 directly...');
        const { calculateHierarchicalAllocation } = await import('./core/allocation-engine.js');

        const testContext = {
          cycleScore: 75,
          regimeData: { name: 'expansion', confidence: 0.8 },
          adaptiveWeights: { btc: 0.35, eth: 0.25, stables: 0.25 },
          execution: { cap_pct_per_iter: 7, target_stables_pct: 25 }
        };

        const v2Result = await calculateHierarchicalAllocation(testContext, [], { enableV2: true });
        console.log('🏗️ Allocation Engine V2 direct result:', v2Result);

        let resultsHtml = '<h3>🧪 Résultats du Test V2</h3>';

        // Display unified state targets
        if (unifiedState.targets_by_group) {
          resultsHtml += `
            <div style="margin: 1rem 0;">
              <h4>📊 Unified State Targets</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem;">
                ${Object.entries(unifiedState.targets_by_group)
                  .filter(([, pct]) => (pct || 0) > 0.1)
                  .sort(([,a], [,b]) => (b || 0) - (a || 0))
                  .map(([asset, pct]) => {
                    const color = pct > 20 ? 'var(--success)' : pct > 10 ? 'var(--warning)' : 'var(--info)';
                    return `
                      <div style="background: var(--theme-surface); padding: 0.5rem; border-radius: 4px; border-left: 3px solid ${color};">
                        <div style="font-weight: 600; font-size: 0.9em;">${asset}</div>
                        <div style="font-size: 1.1em; font-weight: 700; color: ${color};">${(pct || 0).toFixed(1)}%</div>
                      </div>
                    `;
                  }).join('')}
              </div>
            </div>
          `;
        }

        // Display V2 direct result
        if (v2Result && v2Result.allocation) {
          resultsHtml += `
            <div style="margin: 1rem 0;">
              <h4>🏗️ Allocation Engine V2 Direct</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem;">
                ${Object.entries(v2Result.allocation)
                  .filter(([, fraction]) => (fraction || 0) > 0.001)
                  .sort(([,a], [,b]) => (b || 0) - (a || 0))
                  .map(([asset, fraction]) => {
                    const pct = fraction * 100;
                    const color = pct > 20 ? 'var(--success)' : pct > 10 ? 'var(--warning)' : 'var(--info)';
                    return `
                      <div style="background: var(--theme-surface); padding: 0.5rem; border-radius: 4px; border-left: 3px solid ${color};">
                        <div style="font-weight: 600; font-size: 0.9em;">${asset}</div>
                        <div style="font-size: 1.1em; font-weight: 700; color: ${color};">${pct.toFixed(1)}%</div>
                      </div>
                    `;
                  }).join('')}
              </div>
            </div>
          `;
        }

        // Analysis
        resultsHtml += `
          <div style="margin: 1rem 0; padding: 1rem; background: var(--theme-surface); border-radius: 6px;">
            <h4>🔍 Analyse</h4>
            <ul style="margin: 0; padding-left: 1.5rem;">
              <li><strong>Mode Phase Engine:</strong> ${localStorage.getItem('PHASE_ENGINE_ENABLED') || 'shadow'}</li>
              <li><strong>Phase forcée:</strong> ${localStorage.getItem('forced_phase') || 'none'}</li>
              <li><strong>Phase détectée:</strong> ${unifiedState.cycle?.phase?.phase || 'unknown'}</li>
              <li><strong>Tilts appliqués:</strong> ${unifiedState.phase?.tiltsApplied ? 'Oui' : 'Non'}</li>
              <li><strong>V2 Engine utilisé:</strong> ${v2Result ? 'Oui' : 'Non'}</li>
              <li><strong>Source decision:</strong> ${unifiedState.decision?.source || 'unknown'}</li>
            </ul>
          </div>
        `;

        results.innerHTML = resultsHtml;

      } catch (error) {
        console.error('❌ Test failed:', error);
        results.innerHTML = `<div class="error">❌ Test échoué: ${error.message}</div>`;
      }
    });

    // Get current allocations
    document.getElementById('get-current-allocations').addEventListener('click', async () => {
      const results = document.getElementById('current-allocations');
      results.innerHTML = '<div class="loading">🔄 Chargement allocations...</div>';

      try {
        console.log('📊 Getting current allocations...');

        const { getUnifiedState } = await import('./core/unified-insights-v2.js');
        const unifiedState = await getUnifiedState();

        if (unifiedState.targets_by_group) {
          let html = `
            <h3>🎯 Allocations Actuelles</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0;">
          `;

          const sortedTargets = Object.entries(unifiedState.targets_by_group)
            .sort(([,a], [,b]) => (b || 0) - (a || 0));

          for (const [asset, pct] of sortedTargets) {
            if ((pct || 0) > 0.1) {
              const color = pct > 25 ? 'var(--success)' : pct > 15 ? 'var(--warning)' : pct > 5 ? 'var(--info)' : 'var(--theme-text-muted)';
              html += `
                <div style="background: var(--theme-surface); padding: 1rem; border-radius: 6px; border-left: 4px solid ${color};">
                  <div style="font-weight: 600; color: var(--theme-text); margin-bottom: 0.5rem;">${asset}</div>
                  <div style="font-size: 1.5rem; font-weight: 700; color: ${color};">${(pct || 0).toFixed(1)}%</div>
                </div>
              `;
            }
          }

          html += `</div>`;

          const total = Object.values(unifiedState.targets_by_group).reduce((sum, val) => sum + (val || 0), 0);
          html += `
            <div style="text-align: center; margin-top: 1rem; padding: 0.75rem; background: var(--theme-surface); border-radius: 6px;">
              <strong>Total: ${total.toFixed(1)}%</strong> ${Math.abs(total - 100) < 0.1 ? '✅' : '❌ Somme incorrecte!'}
            </div>
          `;

          results.innerHTML = html;
        } else {
          results.innerHTML = '<div class="error">❌ Aucune allocation disponible</div>';
        }

      } catch (error) {
        console.error('❌ Error getting allocations:', error);
        results.innerHTML = `<div class="error">❌ Erreur: ${error.message}</div>`;
      }
    });

    // Initialize
    updateConfigStatus();
    console.log('🧪 Test V2 allocations page loaded');

  </script>

</body>
</html>