<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Force Load Bitcoin Chart</title>
  <script src="lazy-loader.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      background: #1a1a1a;
      color: #fff;
    }

    .controls {
      background: #333;
      padding: 1rem;
      margin-bottom: 2rem;
      border-radius: 8px;
    }

    button {
      background: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 0.5rem;
    }

    button:hover { background: #45a049; }

    .chart-container {
      background: #2a2a2a;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 1rem;
      margin: 2rem 0;
    }

    .chart-lazy-placeholder {
      width: 100%;
      height: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #333;
      color: #aaa;
      border: 2px dashed #555;
      border-radius: 8px;
    }

    canvas {
      width: 100% !important;
      height: 400px !important;
    }

    #logs {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 300px;
      height: 300px;
      background: #000;
      color: #0f0;
      font-family: monospace;
      font-size: 0.7rem;
      padding: 0.5rem;
      overflow-y: auto;
      border: 1px solid #333;
      z-index: 1000;
    }
  </style>
</head>

<body>
  <div id="logs"></div>

  <h1>🧪 Test Force Load Bitcoin Chart</h1>

  <div class="controls">
    <h3>Manual Controls:</h3>
    <button onclick="checkStatus()">🔍 Check Status</button>
    <button onclick="forceLoad()">🚀 Force Load Chart</button>
    <button onclick="checkElements()">📋 Check Elements</button>
    <button onclick="scrollToChart()">⬇️ Scroll to Chart</button>
  </div>

  <!-- Bitcoin Chart Container -->
  <div class="chart-container"
       id="bitcoin-chart-container"
       data-lazy-load="component"
       data-lazy-component="BitcoinCycleChart">

    <h3>📊 Bitcoin Cycle Chart</h3>

    <div class="chart-lazy-placeholder" id="placeholder">
      <div style="text-align: center;">
        <div style="font-size: 2rem; margin-bottom: 0.5rem;">📊</div>
        <div>Click "Force Load Chart" to test</div>
      </div>
    </div>

    <canvas id="bitcoin-cycle-chart" style="display: none;"></canvas>
  </div>

  <script>
    const logContainer = document.getElementById('logs');
    let logIndex = 0;

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logContainer.innerHTML += `[${++logIndex}] ${time}: ${msg}\n`;
      logContainer.scrollTop = logContainer.scrollHeight;
      console.log(`[${logIndex}] ${msg}`);
    }

    log("🚀 Force Load Test Starting");

    // Status checking function
    function checkStatus() {
      log("🔍 === STATUS CHECK ===");
      log(`LazyLoader available: ${!!window.lazyLoader}`);
      log(`BitcoinCycleChart available: ${!!window.BitcoinCycleChart}`);
      log(`Chart.js available: ${!!window.Chart}`);

      const container = document.getElementById('bitcoin-chart-container');
      log(`Container found: ${!!container}`);

      if (container) {
        log(`Container has lazy-load attr: ${container.dataset.lazyLoad}`);
        log(`Container has lazy-component attr: ${container.dataset.lazyComponent}`);
        log(`Container has lazy-loaded class: ${container.classList.contains('lazy-loaded')}`);
        log(`Container has lazy-error class: ${container.classList.contains('lazy-error')}`);
      }

      const placeholder = document.getElementById('placeholder');
      const canvas = document.getElementById('bitcoin-cycle-chart');
      log(`Placeholder found: ${!!placeholder}`);
      log(`Canvas found: ${!!canvas}`);

      if (placeholder) {
        log(`Placeholder display: ${placeholder.style.display || 'default'}`);
      }
      if (canvas) {
        log(`Canvas display: ${canvas.style.display || 'default'}`);
      }
    }

    // Force load function
    function forceLoad() {
      log("🚀 === FORCE LOAD ===");

      const container = document.getElementById('bitcoin-chart-container');
      if (!container) {
        log("❌ Container not found");
        return;
      }

      if (!window.lazyLoader) {
        log("❌ LazyLoader not available");
        return;
      }

      log("📊 Triggering manual lazy load...");

      try {
        window.lazyLoader.loadVisibleElement(container);
        log("✅ loadVisibleElement called");
      } catch (error) {
        log(`❌ Error in loadVisibleElement: ${error.message}`);
      }
    }

    // Elements checking function
    function checkElements() {
      log("📋 === ELEMENTS CHECK ===");

      const lazyElements = document.querySelectorAll('[data-lazy-load]');
      log(`Found ${lazyElements.length} lazy elements`);

      lazyElements.forEach((el, i) => {
        log(`Element ${i}: ${el.tagName}, component: ${el.dataset.lazyComponent}`);
        log(`  Classes: ${el.className}`);
        log(`  Display: ${getComputedStyle(el).display}`);
        log(`  Visible: ${el.offsetParent !== null}`);
      });
    }

    // Scroll to chart function
    function scrollToChart() {
      const container = document.getElementById('bitcoin-chart-container');
      if (container) {
        container.scrollIntoView({ behavior: 'smooth', block: 'center' });
        log("📜 Scrolled to chart container");
      }
    }

    // Simple chart creation function
    window.createBitcoinCycleChart = async function(canvasId) {
      log(`📊 createBitcoinCycleChart called with: ${canvasId}`);

      const canvas = document.getElementById(canvasId);
      if (!canvas) {
        log(`❌ Canvas not found: ${canvasId}`);
        return null;
      }

      if (!window.Chart) {
        log(`❌ Chart.js not available`);
        return null;
      }

      log(`✅ Creating chart on canvas ${canvasId}`);

      const data = {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
        datasets: [{
          label: 'Bitcoin Price (Test)',
          data: [30000, 45000, 35000, 55000, 42000, 60000],
          backgroundColor: 'rgba(247, 147, 26, 0.2)',
          borderColor: 'rgba(247, 147, 26, 1)',
          borderWidth: 2,
          fill: true
        }]
      };

      const config = {
        type: 'line',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          plugins: {
            title: {
              display: true,
              text: '📊 Bitcoin Test Chart (Force Loaded)',
              color: '#ffffff'
            },
            legend: {
              labels: { color: '#ffffff' }
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              ticks: { color: '#ffffff' },
              grid: { color: '#444' }
            },
            x: {
              ticks: { color: '#ffffff' },
              grid: { color: '#444' }
            }
          }
        }
      };

      try {
        const chart = new Chart(canvas, config);
        log(`✅ Chart created successfully!`);
        window.testBitcoinChart = chart;
        return chart;
      } catch (error) {
        log(`❌ Chart creation failed: ${error.message}`);
        return null;
      }
    };

    // Simple BitcoinCycleChart component
    class BitcoinCycleChart {
      constructor(element) {
        log(`🔧 BitcoinCycleChart constructor`);
        this.element = element;
        this.chartLoaded = false;
        this.placeholder = element.querySelector('.chart-lazy-placeholder');
        this.canvas = element.querySelector('#bitcoin-cycle-chart');
        log(`🔍 Placeholder: ${!!this.placeholder}, Canvas: ${!!this.canvas}`);
      }

      async init() {
        log(`🚀 BitcoinCycleChart.init() called`);

        try {
          if (this.placeholder) {
            log(`📝 Updating placeholder...`);
            this.placeholder.innerHTML = '<div style="text-align: center;"><div style="font-size: 2rem;">⏳</div><div>Loading Chart.js...</div></div>';
          }

          log(`📊 Loading Chart.js...`);
          await this.loadChartJS();
          log(`✅ Chart.js loaded`);

          if (this.placeholder) {
            this.placeholder.style.display = 'none';
            log(`👁️ Placeholder hidden`);
          }

          if (this.canvas) {
            this.canvas.style.display = 'block';
            log(`👁️ Canvas shown`);
          }

          if (typeof createBitcoinCycleChart === 'function') {
            log(`📊 Calling createBitcoinCycleChart...`);
            await createBitcoinCycleChart('bitcoin-cycle-chart');
            log(`✅ Chart creation completed`);
          } else {
            log(`❌ createBitcoinCycleChart not available`);
          }

          this.chartLoaded = true;
          log(`✅ BitcoinCycleChart.init() completed`);

        } catch (error) {
          log(`❌ BitcoinCycleChart.init() error: ${error.message}`);

          if (this.placeholder) {
            this.placeholder.innerHTML = `<div style="color: #f44; text-align: center;">❌ Error: ${error.message}</div>`;
          }
        }
      }

      async loadChartJS() {
        if (window.Chart) {
          log(`📊 Chart.js already available`);
          return;
        }

        log(`📊 Loading Chart.js from CDN...`);

        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js';

        const promise = new Promise((resolve, reject) => {
          script.onload = () => {
            log(`✅ Chart.js script loaded`);
            resolve();
          };
          script.onerror = () => {
            log(`❌ Chart.js script failed`);
            reject(new Error('Chart.js load failed'));
          };
        });

        document.head.appendChild(script);
        await promise;

        await new Promise(resolve => setTimeout(resolve, 100));

        if (!window.Chart) {
          throw new Error('Chart.js not available after load');
        }

        log(`✅ Chart.js ready: ${typeof window.Chart}`);
      }
    }

    // Register globally
    window.BitcoinCycleChart = BitcoinCycleChart;
    log(`📝 BitcoinCycleChart registered`);

    // Initial status check after DOM loads
    document.addEventListener('DOMContentLoaded', () => {
      log(`📄 DOM loaded`);

      setTimeout(() => {
        log(`⏰ Auto status check after 1 second`);
        checkStatus();
      }, 1000);
    });

    log(`📄 Script complete`);
  </script>
</body>
</html>