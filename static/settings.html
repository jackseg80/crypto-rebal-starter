<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Configuration - Crypto Rebalancer</title>
  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">
  <script type="module" src="components/nav.js"></script>
  <script type="module" src="components/tooltips.js"></script>

  <script src="debug-logger.js"></script>
  <script src="input-validator.js"></script>
  <script src="performance-optimizer.js"></script>
  <script src="global-config.js"></script>
  <script src="appearance.js"></script>
  <script type="module" src="sources-manager.js"></script>
  <style>
    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      background: var(--theme-background);
      color: var(--theme-text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif
    }

    header {
      position: sticky;
      top: 0;
      background: var(--theme-surface-elevated);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid var(--theme-border);
      z-index: 10
    }

    .wrap {
      max-width: 95vw;
      margin: 0 auto;
      padding: 16px
    }

    h1 {
      margin: 0 0 8px 0;
      font-size: 24px;
      font-weight: 800
    }

    h2 {
      margin: 0 0 12px 0;
      font-size: 18px;
      font-weight: 600
    }

    h3 {
      margin: 0 0 8px 0;
      font-size: 16px;
      font-weight: 600
    }

    .nav {
      display: flex;
      gap: 12px;
      margin: 12px 0
    }

    .nav a {
      padding: 8px 16px;
      border-radius: 8px;
      text-decoration: none;
      color: var(--theme-text-muted);
      border: 1px solid var(--theme-border);
      transition: all 0.2s
    }

    .nav a.active,
    .nav a:hover {
      background: var(--brand-primary);
      color: white;
      border-color: var(--brand-primary)
    }

    .card {
      background: var(--theme-surface);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-lg);
      padding: var(--space-xl);
      margin-bottom: var(--space-xl)
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: .5rem;
      border-bottom: 1px solid var(--theme-border);
      margin-bottom: var(--space-md);
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: .6rem .9rem;
      border: 1px solid var(--theme-border);
      background: var(--theme-surface);
      color: var(--theme-text);
      border-radius: 8px 8px 0 0;
      cursor: pointer;
    }

    .tab-btn.active {
      border-color: var(--brand-primary);
      color: var(--brand-primary);
      background: color-mix(in oklab, var(--brand-primary) 10%, transparent);
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    .card.success {
      border-color: var(--success);
      background: var(--success-bg)
    }

    .card.warning {
      border-color: var(--warning);
      background: var(--warning-bg)
    }

    .form-group {
      margin-bottom: 20px
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--theme-text)
    }

    .form-group .help {
      font-size: 13px;
      color: var(--theme-text-muted);
      margin-top: 4px
    }

    .form-row {
      display: flex;
      gap: 16px;
      align-items: center;
      margin-bottom: 12px
    }

    .form-row.vertical {
      flex-direction: column;
      align-items: flex-start
    }

    input,
    select,
    textarea {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--theme-border);
      background: var(--theme-surface);
      color: var(--theme-text);
      width: 100%;
      max-width: 400px;
      font-size: 14px;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--brand-primary);
      box-shadow: var(--focus-ring);
    }

    button {
      padding: 10px 20px;
      border-radius: 10px;
      border: 0;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn {
      background: var(--brand-primary);
      color: white
    }

    .btn:hover {
      background: var(--brand-primary-hover)
    }

    .btn.secondary {
      background: var(--theme-surface-elevated);
      color: var(--theme-text);
      border: 1px solid var(--theme-border)
    }

    .btn.danger {
      background: var(--danger);
      color: white
    }

    .btn.small {
      padding: 6px 12px;
      font-size: 13px
    }

    .radio-group {
      display: flex;
      gap: 16px;
      flex-wrap: wrap
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border: 1px solid var(--theme-border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s
    }

    .radio-option:hover {
      background: var(--brand-primary-subtle);
      border-color: var(--brand-primary)
    }

    .radio-option input[type="radio"] {
      width: auto;
      margin: 0
    }

    .radio-option.selected {
      background: var(--brand-primary-subtle);
      border-color: var(--brand-primary)
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-ok {
      background: var(--success);
      color: white
    }

    .status-warning {
      background: var(--warning);
      color: white
    }

    .status-error {
      background: var(--danger);
      color: white
    }

    .test-section {
      background: var(--theme-surface-elevated);
      border: 1px solid var(--theme-border);
      border-radius: 10px;
      padding: 16px;
      margin-top: 12px
    }

    .test-result {
      font-family: monospace;
      background: var(--theme-surface);
      border: 1px solid var(--theme-border);
      border-radius: 6px;
      padding: 12px;
      margin-top: 8px;
      font-size: 12px;
      color: var(--theme-text)
    }

    @media(max-width: 768px) {
      .wrap {
        padding: 12px
      }

      .form-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px
      }

      .radio-group {
        flex-direction: column;
        gap: 8px
      }

      input,
      select,
      textarea {
        max-width: 100%
      }
    }
  </style>

  <style>
    /* Ajustement pour la navigation simple */
    body.has-simple-nav {
      margin-left: 80px;
    }

    /* Responsive pour mobile */
    @media (max-width: 768px) {
      body.has-simple-nav {
        margin-left: 0;
      }
    }
  </style>
</head>

<body class="has-simple-nav">


  <div class="wrap">

    <!-- Tab header -->
    <div class="tabs" id="settings-tabs">
      <button class="tab-btn active" data-target="#tab-overview">R√©sum√©</button>
      <!-- <button class="tab-btn" data-target="#tab-data">Source</button> Ancien onglet masqu√© - utiliser Sources -->
      <button class="tab-btn" data-target="#tab-pricing">Pricing</button>
      <button class="tab-btn" data-target="#tab-api">Cl√©s API</button>
      <button class="tab-btn" data-target="#tab-sources">Sources</button>
      <button class="tab-btn" data-target="#tab-interface">Interface</button>
      <button class="tab-btn" data-target="#tab-advanced">Avanc√©</button>
    </div>


    <!-- Overview Tab -->
    <section class="tab-panel active" id="tab-overview">
      <div class="card" id="global-status"
        data-tooltip="Statut global du syst√®me avec indicateurs de sant√© des connexions API et services."
        data-source="Tests de connectivit√© en temps r√©el">
        <div style="display: flex; align-items: center; justify-content: space-between;">
          <div>
            <h3>üìä Statut Global</h3>
            <div id="status-summary">Chargement de la configuration...</div>
          </div>
          <div>
            <button class="btn" onclick="saveAllSettings()">üíæ Sauvegarder</button>
            <button class="btn secondary small" onclick="resetToDefaults()">üîÑ D√©faut</button>
          </div>
        </div>
      </div>

      <!-- Quick Settings: options les plus utilis√©es -->
      <div class="card" data-tooltip="R√©glages rapides les plus courants" data-source="globalConfig">
        <h3>‚öôÔ∏è R√©glages Rapides</h3>
        <div class="form-row">
          <div style="flex:1; min-width: 240px;">
            <label>Source de donn√©es</label>
            <select id="quick_data_source"></select>
            <div class="help">Impacte tous les dashboards (balances, analytics et rebalancing)</div>
          </div>
          <div style="flex:1; min-width: 240px;">
            <label>Mode de pricing</label>
            <select id="quick_pricing">
              <option value="local">üè† Local</option>
              <option value="auto">üöÄ Auto</option>
            </select>
            <div class="help">Local = prix depuis donn√©es, Auto = prix march√©</div>
          </div>
        </div>
        <div class="form-row">
          <div style="flex:1; min-width: 240px;">
            <label>Seuil minimum (USD)</label>
            <input type="number" id="quick_min_usd" min="0" step="0.01">
          </div>
          <div style="flex:1; min-width: 240px;">
            <label>Devise d'affichage</label>
            <select id="quick_currency">
              <option value="USD">USD ($)</option>
              <option value="EUR">EUR (‚Ç¨)</option>
              <option value="BTC">BTC (‚Çø)</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div style="flex:1; min-width: 240px;">
            <label>Th√®me</label>
            <select id="quick_theme">
              <option value="auto">üåì Automatique</option>
              <option value="light">‚òÄÔ∏è Clair</option>
              <option value="dark">üåô Sombre</option>
            </select>
          </div>
          <div style="flex:1; min-width: 240px;">
            <label>URL API backend</label>
            <input type="text" id="quick_api_base_url" placeholder="http://127.0.0.1:8000">
          </div>
        </div>
        <div style="display:flex; gap:8px; margin-top: 8px;">
          <button class="btn" id="quick_save_btn">üíæ Sauvegarder</button>
          <button class="btn secondary" id="quick_apply_btn">Appliquer sans sauvegarder</button>
        </div>
      </div>
    </section>

    <!-- Data Source Tab - DEPRECATED: Use Sources tab instead -->
    <section class="tab-panel" id="tab-data" style="display: none;">
      <!-- Bandeau de d√©pr√©ciation -->
      <div class="card" style="background: var(--warning-bg); border: 1px solid var(--warning); margin-bottom: 1rem;">
        <h4 style="color: var(--warning); margin: 0 0 0.5rem 0;">‚ö†Ô∏è Section D√©pr√©ci√©e</h4>
        <p style="margin: 0; color: var(--theme-text-muted); font-size: 0.9rem;">
          Cette section "Source" est <strong>obsol√®te</strong>. Les sources se g√®rent maintenant dans l'onglet
          <strong><a href="#tab-sources" style="color: var(--info);">Sources</a></strong> (nouveau syst√®me unifi√©).
          <br>Les s√©lections ci-dessous n'influencent plus les donn√©es affich√©es.
        </p>
      </div>

      <div class="card" style="opacity: 0.6; pointer-events: none;"
        data-tooltip="Configuration de la source principale pour les donn√©es de portfolio (CSV local, API CoinTracking ou √©changes directs)."
        data-source="Fichiers de configuration + APIs">
        <h3>üì° Source de Donn√©es (Legacy - Lecture Seule)</h3>
        <div class="form-group">
          <label>Source principale des balances</label>
          <div id="data_source_sections">
            <h4 style="margin:8px 0 6px 0;">Sources de d√©mo</h4>
            <div class="radio-group" id="data_source_demo"></div>
            <h4 style="margin:14px 0 6px 0;">Sources CoinTracking</h4>
            <div class="radio-group" id="data_source_ct"></div>
          </div>
          <div class="help">Cette source sera utilis√©e par d√©faut pour le Dashboard, Rebalancing et toutes les
            analytics.
          </div>
        </div>

        <div class="test-section">
          <button class="btn secondary small" onclick="testDataSource()">üß™ Tester la Source</button>
          <div id="data-source-test"></div>
        </div>
      </div>
    </section>

    <!-- Pricing Tab -->
    <section class="tab-panel" id="tab-pricing">
      <div class="card"
        data-tooltip="Configuration des prix de r√©f√©rence et devises pour les calculs de valeur du portefeuille."
        data-source="CoinGecko, CoinGlass, ou prix manuels">
        <h3>üí∞ Pricing & Devises</h3>
        <div class="form-group">
          <label>Mode de pricing</label>
          <div class="radio-group">
            <div class="radio-option" onclick="selectPricing('local')">
              <input type="radio" name="pricing" value="local" id="pricing_local">
              <label for="pricing_local">üè† <strong>Local</strong> - Prix depuis les donn√©es</label>
            </div>
            <div class="radio-option" onclick="selectPricing('auto')">
              <input type="radio" name="pricing" value="auto" id="pricing_auto">
              <label for="pricing_auto">üöÄ <strong>Auto</strong> - Prix automatiques</label>
            </div>
          </div>
          <div class="help">Local utilise les prix dans vos donn√©es, Auto r√©cup√®re les prix actuels via API.</div>
        </div>

        <div class="form-row">
          <div style="flex: 1;">
            <label>Devise d'affichage</label>
            <select id="display_currency">
              <option value="USD">USD ($)</option>
              <option value="EUR">EUR (‚Ç¨)</option>
              <option value="BTC">BTC (‚Çø)</option>
            </select>
          </div>
          <div style="flex: 1;">
            <label>Seuil minimum (USD)</label>
            <input type="number" id="min_usd_threshold" min="0" step="0.01" value="1.00">
          </div>
        </div>
      </div>
    </section>

    <!-- API Keys Tab -->
    <section class="tab-panel" id="tab-api">
      <div class="card"
        data-tooltip="Gestion s√©curis√©e des cl√©s API pour les exchanges et services de donn√©es (stockage local chiffr√©)."
        data-source="Stockage local s√©curis√© + validation API">
        <h3>üîë Cl√©s API</h3>

        <div class="form-group">
          <label>CoinGecko API Key</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input type="password" id="coingecko_api_key" placeholder="Optionnel - pour plus de requ√™tes"
              style="flex: 1;">
            <button class="btn small secondary" onclick="toggleApiKeyVisibility('coingecko_api_key')"
              style="min-width: 60px;">üëÅÔ∏è</button>
            <span id="coingecko_status" class="status-indicator status-warning" style="font-size: 10px;">Vide</span>
          </div>
          <div class="help">Cl√© Demo API CoinGecko pour la classification automatique et donn√©es de march√©.</div>
        </div>

        <div class="form-group">
          <label>CoinTracking API Key</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input type="password" id="cointracking_api_key" placeholder="Obligatoire pour source API" style="flex: 1;">
            <button class="btn small secondary" onclick="toggleApiKeyVisibility('cointracking_api_key')"
              style="min-width: 60px;">üëÅÔ∏è</button>
            <span id="cointracking_key_status" class="status-indicator status-warning"
              style="font-size: 10px;">Vide</span>
          </div>
          <div class="help">Cl√© API CoinTracking pour acc√®s temps r√©el √† vos balances.</div>
        </div>

        <div class="form-group">
          <label>CoinTracking API Secret</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input type="password" id="cointracking_api_secret" placeholder="Obligatoire pour source API"
              style="flex: 1;">
            <button class="btn small secondary" onclick="toggleApiKeyVisibility('cointracking_api_secret')"
              style="min-width: 60px;">üëÅÔ∏è</button>
            <span id="cointracking_secret_status" class="status-indicator status-warning"
              style="font-size: 10px;">Vide</span>
          </div>
          <div class="help">Cl√© secr√®te CoinTracking (g√©n√©r√©e avec la cl√© API).</div>
        </div>

        <div class="form-group">
          <label>FRED API Key (Federal Reserve Economic Data)</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input type="password" id="fred_api_key" placeholder="Cl√© pour donn√©es Bitcoin historiques"
              style="flex: 1;">
            <button class="btn small secondary" onclick="toggleApiKeyVisibility('fred_api_key')"
              style="min-width: 60px;">üëÅÔ∏è</button>
            <span id="fred_status" class="status-indicator status-warning" style="font-size: 10px;">Vide</span>
          </div>
          <div class="help">Cl√© API gratuite FRED pour historique Bitcoin complet depuis 2014 (vs 365j CoinGecko).</div>
        </div>

        <div class="form-group">
          <label>Debug Token (requis pour sync .env)</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input type="password" id="debug_token" placeholder="Token s√©curis√© pour acc√®s debug" style="flex: 1;">
            <button class="btn small secondary" onclick="toggleApiKeyVisibility('debug_token')"
              style="min-width: 60px;">üëÅÔ∏è</button>
          </div>
          <div class="help">Token requis pour certains endpoints de debug</div>
        </div>

        <!-- Actions sp√©cifiques Cl√©s API -->
        <div style="display:flex; gap:8px; margin: 8px 0 12px 0;">
          <button class="btn" onclick="saveAllSettings()">üíæ Sauvegarder</button>
          <button class="btn secondary" onclick="updateStatusSummary()">Appliquer sans sauvegarder</button>
        </div>


        <div class="test-section">
          <button class="btn secondary small" onclick="testApiKeys()">üß™ Tester les APIs</button>
          <div id="api-keys-test"></div>
        </div>
      </div>
    </section>


    <!-- Interface Tab -->
    <section class="tab-panel" id="tab-interface">

      <!-- Pr√©f√©rences Interface -->
      <div class="card"
        data-tooltip="Personnalisation de l'interface utilisateur : th√®mes, langue, format des nombres et raccourcis."
        data-source="Pr√©f√©rences utilisateur locales">
        <h3>üé® Interface & Pr√©f√©rences</h3>

        <div class="form-group">
          <label>Th√®me de l'interface</label>
          <div class="radio-group">
            <div class="radio-option" onclick="selectTheme('auto')">
              <input type="radio" name="theme" value="auto" id="theme_auto">
              <label for="theme_auto">üåì <strong>Automatique</strong> - Suit les pr√©f√©rences syst√®me</label>
            </div>
            <div class="radio-option" onclick="selectTheme('light')">
              <input type="radio" name="theme" value="light" id="theme_light">
              <label for="theme_light">‚òÄÔ∏è <strong>Clair</strong> - Mode jour</label>
            </div>
            <div class="radio-option" onclick="selectTheme('dark')">
              <input type="radio" name="theme" value="dark" id="theme_dark">
              <label for="theme_dark">üåô <strong>Sombre</strong> - Mode nuit</label>
            </div>
          </div>
          <div class="help">Le th√®me s'applique automatiquement sur toutes les pages de l'application.</div>
        </div>

        <!-- ====== Apparence / Style UI ====== -->
        <div class="card">
          <h2>Apparence</h2>
          <div class="form-group">
            <label>Style UI</label>
            <div class="style-grid" style="display:flex;gap:12px;flex-wrap:wrap">
              <label class="style-card"
                style="display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid var(--theme-border);background:var(--theme-surface-elevated);cursor:pointer">
                <input type="radio" name="ui-style" value="modern"> Modern
              </label>
              <label class="style-card"
                style="display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid var(--theme-border);background:var(--theme-surface-elevated);cursor:pointer">
                <input type="radio" name="ui-style" value="glass"> Glass
              </label>
              <label class="style-card"
                style="display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid var(--theme-border);background:var(--theme-surface-elevated);cursor:pointer">
                <input type="radio" name="ui-style" value="terminal"> Terminal
              </label>
              <label class="style-card"
                style="display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid var(--theme-border);background:var(--theme-surface-elevated);cursor:pointer">
                <input type="radio" name="ui-style" value="minimal"> Minimal
              </label>
            </div>
            <div class="help">Change uniquement l‚Äôhabillage (coins/ombres/surfaces). Aucune incidence sur la logique.
            </div>
          </div>
        </div>

        <script>
          document.addEventListener('DOMContentLoaded', () => {
            const saved = window.globalConfig?.get?.('style') || 'modern';
            document.querySelectorAll('input[name="ui-style"]').forEach(r => {
              r.checked = (r.value === saved);
              r.addEventListener('change', e => {
                window.globalConfig?.set?.('style', e.target.value);
                window.applyAppearance?.();
              });
            });
            // s‚Äôassure que le style s‚Äôapplique si on arrive direct
            window.applyAppearance?.();
          });
        </script>

        <div class="form-row">
          <div style="flex: 1;">
            <label>URL API Backend</label>
            <input type="text" id="api_base_url" value="http://127.0.0.1:8000">
            <div class="help">URL du serveur FastAPI backend</div>
          </div>
          <div style="flex: 1;">
            <label>Fr√©quence auto-refresh (min)</label>
            <input type="number" id="refresh_interval" min="1" max="60" value="5">
          </div>
        </div>

        <div class="form-group">
          <label>Fonctionnalit√©s actives</label>
          <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
              <input type="checkbox" id="enable_coingecko_classification" checked>
              Classification automatique CoinGecko
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
              <input type="checkbox" id="enable_portfolio_snapshots" checked>
              Snapshots automatiques du portfolio
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
              <input type="checkbox" id="enable_performance_tracking" checked>
              Suivi de performance historique
            </label>
          </div>
        </div>
      </div>
    </section>

<!-- Sources Tab Unified - Remplace CSV + Int√©grations -->
<section class="tab-panel" id="tab-sources">
  <div class="card" data-tooltip="G√©rez toutes vos sources de donn√©es (CoinTracking, Saxo, etc.) depuis un point central unifi√©."
    data-source="Syst√®me sources unifi√© v2">
    <h3>üìä Sources de Donn√©es</h3>
    <div class="help" style="margin-bottom: 16px;">
      Point d'entr√©e unique pour g√©rer toutes vos sources : scan, import et refresh des donn√©es CoinTracking, Saxo Bank et autres.
    </div>

    <!-- Status global des sources -->
    <div class="status-grid" id="sources_status_grid">
      <div class="status-item">
        <span class="label">Modules actifs:</span>
        <span class="value" id="sources_active_count">Loading...</span>
      </div>
      <div class="status-item">
        <span class="label">Derni√®re activit√©:</span>
        <span class="value" id="sources_last_activity">-</span>
      </div>
      <div class="status-item">
        <span class="label">Status global:</span>
        <span class="value" id="sources_status">Initialisation...</span>
      </div>
    </div>

    <!-- Grille des modules sources -->
    <div class="modules-grid" id="sources_modules_grid" style="margin-top: 16px;">
      <!-- Les cartes de modules seront inject√©es dynamiquement par sources-manager.js -->
      <div class="loading-placeholder">
        <div class="spinner"></div>
        <span>Chargement des modules sources...</span>
      </div>
    </div>

    <!-- Actions globales -->
    <div style="margin-top: 16px;">
      <div class="flex-row" style="gap: 12px; flex-wrap: wrap;">
        <button class="btn primary" onclick="scanAllSources()">
          üîç Scanner toutes les sources
        </button>
        <button class="btn info" onclick="refreshSourcesStatus()">
          üîÑ Actualiser status
        </button>
        <button class="btn secondary" onclick="showSourcesConfiguration()">
          ‚öôÔ∏è Configuration avanc√©e
        </button>
      </div>
    </div>

    <!-- Configuration sources (collapsible) -->
    <details class="config-details" id="sources_config_details" style="margin-top: 16px;">
      <summary>‚öôÔ∏è Configuration Sources Avanc√©e</summary>
      <div class="config-content">

        <div class="form-group">
          <label for="sources_snapshot_ttl">TTL des snapshots (heures)</label>
          <input type="number" id="sources_snapshot_ttl" value="24" min="1" max="168">
          <div class="help">Dur√©e avant qu'un snapshot soit consid√©r√© comme obsol√®te (d√©faut: 24h)</div>
        </div>

        <div class="form-group">
          <label for="sources_warning_threshold">Seuil d'alerte (heures)</label>
          <input type="number" id="sources_warning_threshold" value="12" min="1" max="72">
          <div class="help">Dur√©e avant d'afficher un avertissement de staleness (d√©faut: 12h)</div>
        </div>

        <div class="form-group">
          <label for="sources_auto_refresh">Actualisation automatique</label>
          <input type="checkbox" id="sources_auto_refresh" checked>
          <div class="help">Actualise automatiquement le statut toutes les 30 secondes</div>
        </div>

        <div style="margin-top: 16px;">
          <button class="btn secondary" onclick="saveSourcesConfiguration()">
            üíæ Sauvegarder configuration
          </button>
        </div>

      </div>
    </details>

    <!-- Logs sources -->
    <div id="sources_logs" style="margin-top: 16px; display: none;">
      <h4>üìã Logs r√©cents</h4>
      <div class="logs-container" id="sources_logs_content" style="max-height: 200px; overflow-y: auto; background: var(--theme-surface); padding: 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">
        <!-- Les logs seront ajout√©s dynamiquement -->
      </div>
      <div style="margin-top: 8px;">
        <button class="btn small secondary" onclick="toggleSourcesLogs()">
          üìã Basculer les logs
        </button>
        <button class="btn small info" onclick="clearSourcesLogs()">
          üóëÔ∏è Effacer
        </button>
      </div>
    </div>

  </div>
</section>

<!-- CSS sp√©cifique pour la section Sources -->
<style>
/* Grille des modules sources */
.modules-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 16px;
}

/* Cartes individuelles des modules */
.module-card {
  background: var(--theme-surface);
  border: 1px solid var(--theme-border);
  border-radius: 8px;
  padding: 16px;
  transition: all 0.2s ease;
}

.module-card:hover {
  border-color: var(--theme-accent);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.module-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.module-header h4 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
}

/* Badges de status */
.status-badge {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
  text-transform: uppercase;
}

.status-badge.enabled, .status-badge.success {
  background: #d4edda;
  color: #155724;
}

.status-badge.warning {
  background: #fff3cd;
  color: #856404;
}

.status-badge.disabled, .status-badge.error {
  background: #f8d7da;
  color: #721c24;
}

/* Statistiques des modules */
.module-stats {
  margin: 12px 0;
}

.stat-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 4px;
  font-size: 14px;
}

.stat-item .label {
  color: var(--theme-text-muted);
}

.stat-item .value {
  font-weight: 500;
}

/* Actions des modules */
.module-actions {
  margin-top: 12px;
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.btn-sm {
  padding: 6px 12px;
  font-size: 12px;
}

/* Loading placeholder */
.loading-placeholder {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  padding: 40px;
  color: var(--theme-text-muted);
  font-style: italic;
}

.spinner {
  width: 20px;
  height: 20px;
  border: 2px solid var(--theme-border);
  border-top: 2px solid var(--theme-accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Sources radio buttons compacts */
.sources-section {
  margin-top: 12px;
}

.sources-section h5 {
  margin: 0 0 8px 0;
  font-size: 14px;
  color: var(--theme-text-muted);
}

.sources-list {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.source-option {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 8px;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.2s;
  font-size: 13px;
}

.source-option:hover {
  background-color: var(--theme-surface-elevated);
}

.source-option input[type="radio"] {
  margin: 0;
  flex-shrink: 0;
  width: 14px;
  height: 14px;
}

.source-details {
  flex: 1;
  line-height: 1.3;
}

.source-details small {
  color: var(--theme-text-muted);
  font-size: 11px;
}

.legacy {
  color: #fd7e14;
  font-weight: 500;
}

/* Status grid am√©lior√© */
.status-grid .value.error {
  color: #dc3545;
}

.status-grid .value.warning {
  color: #fd7e14;
}

.status-grid .value.success {
  color: #28a745;
}

/* CSS pour la modal d'upload */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  backdrop-filter: blur(4px);
  transition: opacity 0.2s ease;
}

.modal-content {
  background: var(--theme-surface);
  border: 1px solid var(--theme-border);
  border-radius: 12px;
  width: 90%;
  max-width: 500px;
  max-height: 80vh;
  overflow: hidden;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid var(--theme-border);
  background: var(--theme-surface-elevated);
}

.modal-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.close-btn {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--theme-text-secondary);
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  transition: all 0.2s ease;
}

.close-btn:hover {
  background: var(--theme-surface);
  color: var(--theme-text);
}

.modal-body {
  padding: 20px;
  max-height: 50vh;
  overflow-y: auto;
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  padding: 16px 20px;
  border-top: 1px solid var(--theme-border);
  background: var(--theme-surface-elevated);
}

/* Zone d'upload */
.upload-area {
  border: 2px dashed var(--theme-border);
  border-radius: 8px;
  padding: 32px 16px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s ease;
  background: var(--theme-surface-elevated);
  margin: 16px 0;
}

.upload-area:hover {
  border-color: var(--theme-accent);
  background: var(--theme-surface);
}

.upload-area.drag-over {
  border-color: var(--theme-success);
  background: rgba(40, 167, 69, 0.1);
}

.upload-placeholder {
  color: var(--theme-text-secondary);
  font-size: 16px;
}

/* Liste des fichiers */
.file-list {
  margin: 16px 0;
}

.file-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  background: var(--theme-surface-elevated);
  border: 1px solid var(--theme-border);
  border-radius: 6px;
  margin-bottom: 8px;
}

.file-name {
  font-weight: 500;
}

.file-size {
  color: var(--theme-text-secondary);
  font-size: 14px;
}

/* Barre de progression */
.upload-progress {
  margin: 16px 0;
}

.progress-bar {
  width: 100%;
  height: 8px;
  background: var(--theme-surface-elevated);
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 8px;
}

.progress-fill {
  height: 100%;
  background: var(--theme-accent);
  transition: width 0.3s ease;
  width: 0%;
}

.progress-text {
  text-align: center;
  font-size: 14px;
  color: var(--theme-text-secondary);
}
</style>

<!-- JavaScript d'initialisation -->
<script>
// Fonctions utilitaires pour la section Sources
function showSourcesConfiguration() {
  const details = document.getElementById('sources_config_details');
  if (details) {
    details.open = true;
    details.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

function saveSourcesConfiguration() {
  const ttl = document.getElementById('sources_snapshot_ttl').value;
  const warning = document.getElementById('sources_warning_threshold').value;
  const autoRefresh = document.getElementById('sources_auto_refresh').checked;

  // TODO: Impl√©menter la sauvegarde via API
  showNotification('Configuration sources sauvegard√©e', 'success');
}

function toggleSourcesLogs() {
  const logsDiv = document.getElementById('sources_logs');
  if (logsDiv) {
    logsDiv.style.display = logsDiv.style.display === 'none' ? 'block' : 'none';
  }
}

function clearSourcesLogs() {
  const logsContent = document.getElementById('sources_logs_content');
  if (logsContent) {
    logsContent.innerHTML = '';
  }
}

// Initialisation automatique quand l'onglet Sources est activ√©
document.addEventListener('DOMContentLoaded', function() {
  // Fonction d'initialisation
  function tryInitSourcesManager() {
    setTimeout(() => {
      if (typeof initSourcesManager === 'function') {
        initSourcesManager();
      } else {
        console.warn('[Sources] sources-manager.js not loaded');
      }
    }, 100);
  }

  // Observer les changements d'onglet
  const sourcesTab = document.querySelector('button[data-target="#tab-sources"]');
  if (sourcesTab) {
    sourcesTab.addEventListener('click', function() {
      tryInitSourcesManager();
    });
  }

  // Initialiser automatiquement si on arrive directement sur l'onglet Sources
  if (window.location.hash === '#tab-sources') {
    // Attendre que la page soit compl√®tement charg√©e
    setTimeout(tryInitSourcesManager, 500);
  }
});
</script>

    <!-- Advanced Tab -->
    <section class="tab-panel" id="tab-advanced">
      <div class="card"
        data-tooltip="Outils avanc√©s pour maintenance, cache, et op√©rations syst√®me critiques (utiliser avec pr√©caution)."
        data-source="Fonctions syst√®me internes">
        <h3>üîß Actions Avanc√©es</h3>

        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
          <button class="btn secondary" onclick="exportSettings()">üì§ Exporter Config</button>
          <button class="btn secondary" onclick="importSettings()">üì• Importer Config</button>
          <button class="btn secondary" onclick="clearCache()">üóëÔ∏è Vider Cache</button>
          <button class="btn danger" onclick="resetAllData()">‚ö†Ô∏è Reset Complet</button>
        </div>

        <div class="test-section" style="margin-top: 16px;">
          <h4>üß™ Test Complet du Syst√®me</h4>
          <button class="btn" onclick="runFullSystemTest()">üöÄ Lancer Test Complet</button>
          <div id="full-system-test"></div>
        </div>
      </div>
    </section>

  </div>

  <script>
    // Tabs logic
    (function () {
      const btns = document.querySelectorAll('.tab-btn');
      const panels = document.querySelectorAll('.tab-panel');
      function activate(target) {
        btns.forEach(b => b.classList.toggle('active', b.getAttribute('data-target') === `#${target.id}`));
        panels.forEach(p => p.classList.toggle('active', p === target));
        history.replaceState(null, '', `#${target.id}`);
      }
      btns.forEach(btn => {
        btn.addEventListener('click', () => {
          const sel = btn.getAttribute('data-target');
          const target = document.querySelector(sel);
          if (target) activate(target);
        })
      });
      // Deep link support via hash
      const hash = location.hash && document.querySelector(location.hash);
      if (hash && hash.classList.contains('tab-panel')) activate(hash);
    })();

    // Appliquer le th√®me d√®s le chargement de global-config.js
    setTimeout(() => {
      if (window.globalConfig && window.globalConfig.applyTheme) {
        console.debug('Early theme application...');
        window.globalConfig.applyTheme();
      }
      if (window.applyAppearance) {
        window.applyAppearance();
      }
    }, 0);
  </script>
  <script>
    // Active user helper for per-user settings
    function getActiveUser() {
      try {
        const u = localStorage.getItem('activeUser');
        return u && typeof u === 'string' ? u : 'demo';
      } catch (_) { return 'demo'; }
    }
    // Back-compat: expose currentUser
    window.currentUser = getActiveUser();
    // Construit dynamiquement les contr√¥les de source de donn√©es √† partir de la source centralis√©e
    async function buildDataSourceControls() {
      try {
        // R√©cup√©rer les sources disponibles pour l'utilisateur actuel
        const response = await fetch('/api/users/sources', {
          headers: { 'X-User': getActiveUser() }
        });

        if (!response.ok) {
          console.error('Failed to load user data sources');
          return;
        }

        const data = await response.json();
        const sources = data.sources || [];
        // Rendre disponible globalement pour lookup lors de la s√©lection
        window.availableSources = sources;

        // 1) Peupler le select rapide
        const quickSelect = document.getElementById('quick_data_source');
        if (quickSelect) {
          quickSelect.innerHTML = '';
          for (const source of sources) {
            const opt = document.createElement('option');
            opt.value = source.key;
            opt.textContent = source.label;
            quickSelect.appendChild(opt);
          }
        }

        // 2) Construire les groupes radio de l'onglet Source
        const csvContainer = document.getElementById('data_source_demo'); // R√©utiliser pour CSV
        const apiContainer = document.getElementById('data_source_ct');   // R√©utiliser pour API

        if (csvContainer) {
          csvContainer.innerHTML = '<h4 style="margin: 0 0 0.5rem 0; color: var(--theme-text-muted);">üìÑ Fichiers CSV</h4>';
        }
        if (apiContainer) {
          apiContainer.innerHTML = '<h4 style="margin: 1rem 0 0.5rem 0; color: var(--theme-text-muted);">üåê API</h4>';
        }

        const buildOption = (source) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'radio-option';
          // S√©lection selon type
          if (source.type === 'csv') {
            wrapper.addEventListener('click', async () => {
              // Enregistrer le fichier s√©lectionn√© (nom de base)
              const fname = (source.file_path || '').split(/[/\\\\]/).pop();
              if (!window.userSettings) window.userSettings = getDefaultSettings();
              window.userSettings.csv_selected_file = fname || null;
              await selectDataSource(source.key);
              try { await saveSettings(); } catch (_) { }
            });
          } else {
            wrapper.addEventListener('click', async () => await selectDataSource(source.key));
          }

          const input = document.createElement('input');
          input.type = 'radio';
          input.name = 'data_source';
          input.value = source.key;
          if (source.type === 'csv') {
            const fname = (source.file_path || '').split(/[/\\\\]/).pop();
            if (fname) input.setAttribute('data-file', fname);
          }
          input.id = `source_${source.key}`;

          const label = document.createElement('label');
          label.setAttribute('for', `source_${source.key}`);
          label.innerHTML = source.label;

          wrapper.appendChild(input);
          wrapper.appendChild(label);
          return wrapper;
        };

        let hasCSV = false;
        let hasAPI = false;

        for (const source of sources) {
          const node = buildOption(source);
          if (source.type === 'csv') {
            if (csvContainer) csvContainer.appendChild(node);
            hasCSV = true;
          } else if (source.type === 'api') {
            if (apiContainer) apiContainer.appendChild(node);
            hasAPI = true;
          }
        }

        // Masquer les sections vides
        if (csvContainer && !hasCSV) {
          csvContainer.style.display = 'none';
        }
        if (apiContainer && !hasAPI) {
          apiContainer.style.display = 'none';
        }

      } catch (error) {
        console.error('Error building data source controls:', error);

        // Fallback: afficher une option g√©n√©rique
        const quickSelect = document.getElementById('quick_data_source');
        if (quickSelect) {
          quickSelect.innerHTML = '<option value="csv">üìÑ Fichiers CSV</option>';
        }
      }
    }

    // Initialisation des r√©glages rapides
    async function initQuickSettings() {
      const s = window.userSettings || getDefaultSettings();
      // S'assurer que les contr√¥les sont construits d'abord
      await buildDataSourceControls();
      // Valeurs initiales
      if (document.getElementById('quick_data_source')) {
        const quickEl = document.getElementById('quick_data_source');
        quickEl.value = s.data_source || 'stub_balanced';
        // Si un CSV sp√©cifique a √©t√© choisi, refl√©ter la cl√© correspondante si disponible
        try {
          const list = window.availableSources || [];
          if ((s.data_source === 'csv' || s.data_source === 'cointracking') && s.csv_selected_file) {
            const match = list.find(src => src.type === 'csv' && (src.file_path || '').split(/[/\\\\]/).pop() === s.csv_selected_file);
            if (match) quickEl.value = match.key;
          }
        } catch (_) { }
      }
      document.getElementById('quick_pricing').value = s.pricing || 'auto';
      document.getElementById('quick_min_usd').value = (s.min_usd_threshold ?? 1);
      document.getElementById('quick_currency').value = s.display_currency || 'USD';
      document.getElementById('quick_theme').value = s.theme || 'auto';
      document.getElementById('quick_api_base_url').value = s.api_base_url || window.location.origin;

      // Synchroniser l'√©tat initial des radios Source avec la valeur actuelle
      if (s.data_source) {
        try { await selectDataSource(s.data_source); } catch (_) { }
      }

      // Listeners: appliquent imm√©diatement dans globalConfig
      if (document.getElementById('quick_data_source')) {
        document.getElementById('quick_data_source').addEventListener('change', async (e) => {
          const key = e.target.value;
          // Si l'utilisateur choisit un CSV sp√©cifique via le select, enregistrer le fichier
          try {
            const src = (window.availableSources || []).find(s => s.key === key);
            if (src && src.type === 'csv') {
              const fname = (src.file_path || '').split(/[/\\\\]/).pop();
              if (!window.userSettings) window.userSettings = getDefaultSettings();
              window.userSettings.csv_selected_file = fname || null;
              await selectDataSource(key);
              try { await saveSettings(); } catch (_) { }
              return;
            }
          } catch (_) { }
          await selectDataSource(key);
        });
      }
      document.getElementById('quick_pricing').addEventListener('change', async (e) => {
        await selectPricing(e.target.value);
        if (window.globalConfig) window.globalConfig.set('pricing', e.target.value);
      });
      document.getElementById('quick_min_usd').addEventListener('change', (e) => {
        if (!window.userSettings) window.userSettings = getDefaultSettings();
        const val = parseFloat(e.target.value) || 0;
        window.userSettings.min_usd_threshold = val; // Sauvegarde pour persistance
        if (window.globalConfig) window.globalConfig.set('min_usd_threshold', val);
        // Synchroniser l'autre champ
        const mainInput = document.getElementById('min_usd_threshold');
        if (mainInput) mainInput.value = val;
      });
      document.getElementById('quick_currency').addEventListener('change', async (e) => {
        const val = e.target.value;
        // Mettre √† jour la config et synchroniser le select d√©taill√©
        if (!window.userSettings) window.userSettings = getDefaultSettings();
        window.userSettings.display_currency = val;
        if (window.globalConfig) window.globalConfig.set('display_currency', val);
        const mainSel = document.getElementById('display_currency');
        if (mainSel) mainSel.value = val;
        try { if (window.currencyManager && val !== 'USD') await window.currencyManager.ensureRate(val); } catch (_) { }
        updateStatusSummary();
      });
      document.getElementById('quick_theme').addEventListener('change', async (e) => {
        await selectTheme(e.target.value);
        if (window.globalConfig) window.globalConfig.set('theme', e.target.value);
      });
      document.getElementById('quick_api_base_url').addEventListener('change', (e) => {
        if (!window.userSettings) window.userSettings = getDefaultSettings();
        window.userSettings.api_base_url = e.target.value;
      });

      // Actions
      document.getElementById('quick_save_btn').addEventListener('click', async () => {
        // Rien de plus: tout est d√©j√† √©crit dans userSettings par les listeners
        await saveSettings();
        showNotification('‚úÖ R√©glages rapides sauvegard√©s', 'success');
      });
      document.getElementById('quick_apply_btn').addEventListener('click', async () => {
        await updateStatusSummary();
        showNotification('‚ö° R√©glages rapides appliqu√©s', 'info');
      });
    }

    // Fonction helper pour obtenir les settings par d√©faut
    function getDefaultSettings() {
      return {
        data_source: "csv",
        api_base_url: "http://localhost:8000",
        display_currency: "USD",
        min_usd_threshold: 1.0,
        csv_glob: "csv/*.csv",
        cointracking_api_key: "",
        cointracking_api_secret: "",
        coingecko_api_key: "",
        fred_api_key: "",
        debug_token: "",
        pricing: "local",
        refresh_interval: 5,
        enable_coingecko_classification: true,
        enable_portfolio_snapshots: true,
        enable_performance_tracking: true,
        theme: "auto",
        debug_mode: false
      };
    }

    // Charger les settings depuis l'API utilisateur
    async function loadSettings() {
      try {
        const response = await fetch('/api/users/settings', {
          headers: { 'X-User': getActiveUser() }
        });
        if (response.ok) {
          window.userSettings = await response.json();
        } else {
          console.warn('Failed to load user settings, using defaults');
          window.userSettings = getDefaultSettings();
        }
      } catch (error) {
        console.error('Error loading user settings:', error);
        window.userSettings = getDefaultSettings();
      }

      // Mettre √† jour l'interface
      updateUI();
      await updateStatusSummary();
      if (window.globalConfig) await initQuickSettings();
    }

    // Sauvegarder les settings via l'API utilisateur
    async function saveSettings() {
      try {
        // üêõ DEBUG: Log avant sauvegarde depuis settings.html
        console.log('[Settings] saveSettings() called with:', {
          hasApiKey: !!(window.userSettings || {}).cointracking_api_key,
          hasApiSecret: !!(window.userSettings || {}).cointracking_api_secret,
          userSettingsKeys: Object.keys(window.userSettings || {}),
          stackTrace: new Error().stack.split('\n').slice(1, 4)
        });

        const response = await fetch('/api/users/settings', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-User': getActiveUser()
          },
          body: JSON.stringify(window.userSettings)
        });

        if (response.ok) {
          console.log('User settings saved successfully');
        } else {
          const error = await response.json();
          console.error('Failed to save user settings:', error);
          showNotification('‚ùå Erreur lors de la sauvegarde', 'error');
        }
      } catch (error) {
        console.error('Error saving user settings:', error);
        showNotification('‚ùå Erreur lors de la sauvegarde', 'error');
      }
      await updateStatusSummary();
    }

    // Mettre √† jour l'interface avec les valeurs actuelles
    function updateUI() {
      const globalSettings = window.userSettings || getDefaultSettings();

      // Nettoyer les s√©lections pr√©c√©dentes
      document.querySelectorAll('.radio-option').forEach(el => el.classList.remove('selected'));

      // Source de donn√©es
      let srcSelected = false;
      if ((globalSettings.data_source === 'csv' || globalSettings.data_source === 'cointracking') && globalSettings.csv_selected_file) {
        const byFile = document.querySelector(`.radio-option input[name="data_source"][data-file="${globalSettings.csv_selected_file}"]`);
        if (byFile) {
          byFile.checked = true;
          if (byFile.parentElement) byFile.parentElement.classList.add('selected');
          srcSelected = true;
        }
      }
      if (!srcSelected) {
        const srcInput = document.getElementById(`source_${globalSettings.data_source}`);
        if (srcInput) {
          srcInput.checked = true;
          const parent = document.querySelector(`.radio-option input[name="data_source"][value="${globalSettings.data_source}"]`);
          if (parent && parent.parentElement) parent.parentElement.classList.add('selected');
        }
      }

      // Pricing
      document.getElementById(`pricing_${globalSettings.pricing}`).checked = true;
      document.querySelector(`.radio-option input[value="${globalSettings.pricing}"]`).parentElement.classList.add('selected');

      // Th√®me
      document.getElementById(`theme_${globalSettings.theme}`).checked = true;
      document.querySelector(`.radio-option input[value="${globalSettings.theme}"]`).parentElement.classList.add('selected');

      // Autres champs
      document.getElementById('display_currency').value = globalSettings.display_currency;
      // Synchroniser le select rapide avec la valeur principale
      const quickCurr = document.getElementById('quick_currency');
      if (quickCurr) quickCurr.value = globalSettings.display_currency;
      document.getElementById('min_usd_threshold').value = globalSettings.min_usd_threshold;

      // Cl√©s API masqu√©es
      document.getElementById('coingecko_api_key').value = globalSettings.coingecko_api_key ? maskApiKey(globalSettings.coingecko_api_key) : '';
      document.getElementById('cointracking_api_key').value = globalSettings.cointracking_api_key ? maskApiKey(globalSettings.cointracking_api_key) : '';
      document.getElementById('cointracking_api_secret').value = globalSettings.cointracking_api_secret ? maskApiKey(globalSettings.cointracking_api_secret) : '';
      document.getElementById('fred_api_key').value = globalSettings.fred_api_key ? maskApiKey(globalSettings.fred_api_key) : '';
      document.getElementById('debug_token').value = globalSettings.debug_token ? maskApiKey(globalSettings.debug_token) : '';

      // Mettre √† jour les statuts des cl√©s
      updateApiKeyStatus('coingecko', !!globalSettings.coingecko_api_key);
      updateApiKeyStatus('cointracking_key', !!globalSettings.cointracking_api_key);
      updateApiKeyStatus('cointracking_secret', !!globalSettings.cointracking_api_secret);
      updateApiKeyStatus('fred', !!globalSettings.fred_api_key);

      document.getElementById('api_base_url').value = globalSettings.api_base_url;
      document.getElementById('refresh_interval').value = globalSettings.refresh_interval;
      document.getElementById('enable_coingecko_classification').checked = globalSettings.enable_coingecko_classification;
      document.getElementById('enable_portfolio_snapshots').checked = globalSettings.enable_portfolio_snapshots;
      document.getElementById('enable_performance_tracking').checked = globalSettings.enable_performance_tracking;
    }

    // √âcouteur pour le select d√©taill√© de devise afin de synchroniser avec le quick-select
    document.addEventListener('DOMContentLoaded', () => {
      const mainCurrency = document.getElementById('display_currency');
      if (mainCurrency) {
        mainCurrency.addEventListener('change', async (e) => {
          const val = e.target.value;
          if (!window.userSettings) window.userSettings = getDefaultSettings();
          window.userSettings.display_currency = val;
          if (window.globalConfig) window.globalConfig.set('display_currency', val);
          const quick = document.getElementById('quick_currency');
          if (quick) quick.value = val;
          try { if (window.currencyManager && val !== 'USD') await window.currencyManager.ensureRate(val); } catch (_) { }
          await updateStatusSummary();
        });
      }
    });

    // Mettre √† jour le r√©sum√© du statut
    async function updateStatusSummary() {
      const summary = document.getElementById('status-summary');
      const globalSettings = window.userSettings || getDefaultSettings();

      // R√©cup√©rer le label de source depuis l'API utilisateur
      let sourceLabel = 'Aucune source';
      try {
        const response = await fetch('/api/users/sources', {
          headers: { 'X-User': getActiveUser() }
        });
        if (response.ok) {
          const data = await response.json();
          let currentSource = data.sources.find(s => s.key === globalSettings.data_source);
          // Si CSV g√©n√©rique, essayer de trouver l'entr√©e par nom de fichier s√©lectionn√©
          if ((!currentSource) && (globalSettings.data_source === 'csv' || globalSettings.data_source === 'cointracking') && globalSettings.csv_selected_file) {
            currentSource = data.sources.find(s => s.type === 'csv' && (s.file_path || '').split(/[/\\\\]/).pop() === globalSettings.csv_selected_file);
          }
          if (currentSource) {
            sourceLabel = currentSource.label;
          } else if (data.sources.length === 0) {
            sourceLabel = 'Aucune source';
          } else {
            sourceLabel = globalSettings.data_source;
          }
        }
      } catch (error) {
        console.debug('Could not load source labels:', error);
      }

      const pricingLabels = {
        'local': 'üè† Prix locaux',
        'auto': 'üöÄ Prix automatiques'
      };

      const themeLabels = {
        'auto': 'üåì Auto',
        'light': '‚òÄÔ∏è Clair',
        'dark': 'üåô Sombre'
      };

      summary.innerHTML = `
      <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-top: 8px;">
        <span class="status-indicator status-ok">
          ${sourceLabel}
      </span>
        <span class="status-indicator status-ok">
          ${pricingLabels[globalSettings.pricing]}
        </span>
        <span class="status-indicator status-ok">
          ${themeLabels[globalSettings.theme]}
        </span>
        <span class="status-indicator status-ok">
          ${globalSettings.display_currency}
        </span>
      </div>
      `;
    }

    // S√©lection de source de donn√©es
    async function selectDataSource(source) {
      // Ne retirer la s√©lection que pour le groupe des sources
      document.querySelectorAll('input[name="data_source"]').forEach(inp => {
        if (inp && inp.parentElement) inp.parentElement.classList.remove('selected');
      });
      if (!window.userSettings) window.userSettings = getDefaultSettings();

      // ‚ö†Ô∏è CRITIQUE: Pr√©server les cl√©s API avant modification
      // Recharger depuis le serveur pour √©viter la perte des cl√©s API
      try {
        const response = await fetch('/api/users/settings', {
          headers: { 'X-User': getActiveUser() }
        });
        if (response.ok) {
          const currentSettings = await response.json();
          // Fusionner TOUTES les cl√©s API depuis le serveur (plus s√ªr)
          const apiKeys = ['coingecko_api_key', 'cointracking_api_key', 'cointracking_api_secret', 'fred_api_key', 'debug_token'];
          apiKeys.forEach(key => {
            if (currentSettings[key]) {
              window.userSettings[key] = currentSettings[key];
            }
          });
        }
      } catch (e) {
        console.warn('Could not reload settings to preserve API keys:', e);
      }

      // Vider tous les caches quand la source change
      const oldSource = window.userSettings.data_source;
      const isCsvKey = typeof source === 'string' && source.startsWith('csv_');
      const effectiveNew = isCsvKey ? 'cointracking' : source;
      if (oldSource && oldSource !== effectiveNew) {
        console.log(`üîÑ Source change detected: ${oldSource} -> ${source}, clearing all caches`);

        // Vider le cache balance
        if (typeof window.clearBalanceCache === 'function') {
          window.clearBalanceCache();
        }

        // Vider localStorage cache
        Object.keys(localStorage).forEach(key => {
          if (key.startsWith('cache:') || key.includes('risk_score') || key.includes('balance_')) {
            localStorage.removeItem(key);
          }
        });

        // Mettre √† jour global config aussi
        if (typeof window.globalConfig !== 'undefined') {
          window.globalConfig.set('data_source', effectiveNew);
        }
      }

      // D√©terminer si on s√©lectionne une option CSV sp√©cifique (recalcul local si appel√© hors bloc ci-dessus)
      // const isCsvKey = typeof source === 'string' && source.startsWith('csv_');

      // Mettre √† jour la valeur stock√©e
      if (isCsvKey) {
        window.userSettings.data_source = 'cointracking';
      } else {
        window.userSettings.data_source = source;
      }

      // Synchroniser le select rapide (R√©sum√©)
      const quickSelect = document.getElementById('quick_data_source');
      if (quickSelect) {
        if (isCsvKey) {
          quickSelect.value = source;
        } else if ((window.userSettings.data_source === 'cointracking' || window.userSettings.data_source === 'csv') && window.userSettings.csv_selected_file) {
          try {
            const list = window.availableSources || [];
            const match = list.find(s => s.type === 'csv' && (s.file_path || '').split(/[/\\\\]/).pop() === window.userSettings.csv_selected_file);
            if (match) quickSelect.value = match.key; else quickSelect.value = window.userSettings.data_source;
          } catch (_) { quickSelect.value = window.userSettings.data_source; }
        } else {
          quickSelect.value = window.userSettings.data_source;
        }
      }

      // Cocher la radio correspondante (onglet Source)
      let radioMarked = false;
      if ((window.userSettings.data_source === 'cointracking' || window.userSettings.data_source === 'csv') && window.userSettings.csv_selected_file) {
        const byFile = document.querySelector(`.radio-option input[name="data_source"][data-file="${window.userSettings.csv_selected_file}"]`);
        if (byFile) {
          byFile.checked = true;
          if (byFile.parentElement) byFile.parentElement.classList.add('selected');
          radioMarked = true;
        }
      }
      if (!radioMarked) {
        const radio = document.getElementById(`source_${source}`);
        if (radio) {
          radio.checked = true;
          const parent = document.querySelector(`.radio-option input[name=\"data_source\"][value=\"${source}\"]`);
          if (parent && parent.parentElement) parent.parentElement.classList.add('selected');
        }
      }
      await updateStatusSummary();

      // Persister la s√©lection si elle change r√©ellement
      if (!oldSource || oldSource !== source) {
        try { await saveSettings(); } catch (_) { }
      }
    }

    // S√©lection de pricing
    async function selectPricing(pricing) {
      document.querySelectorAll('.radio-option').forEach(el => el.classList.remove('selected'));
      if (!window.userSettings) window.userSettings = getDefaultSettings();
      window.userSettings.pricing = pricing;
      if (window.globalConfig) window.globalConfig.set('pricing', pricing);
      document.getElementById(`pricing_${pricing}`).checked = true;
      document.querySelector(`.radio-option input[value="${pricing}"]`).parentElement.classList.add('selected');
      await updateStatusSummary();
    }

    // S√©lection de th√®me
    async function selectTheme(theme) {
      console.debug('Setting theme to:', theme);
      document.querySelectorAll('.radio-option').forEach(el => el.classList.remove('selected'));

      if (!window.userSettings) window.userSettings = getDefaultSettings();
      window.userSettings.theme = theme;
      if (window.globalConfig) window.globalConfig.set('theme', theme);
      // Appliquer le th√®me directement
      document.documentElement.setAttribute('data-theme', theme);

      // Mettre √† jour l'interface
      document.getElementById(`theme_${theme}`).checked = true;
      document.querySelector(`.radio-option input[value="${theme}"]`).parentElement.classList.add('selected');
      await updateStatusSummary();

      // Appliquer imm√©diatement le th√®me
      if (window.applyAppearance) {
        window.applyAppearance();
      }

      console.debug('Theme applied, current userSettings theme:', (window.userSettings || getDefaultSettings()).theme);
    }

    // Sauvegarder tous les settings
    async function saveAllSettings() {
      // R√©cup√©rer toutes les valeurs des champs et les stocker dans userSettings
      if (!window.userSettings) window.userSettings = getDefaultSettings();

      window.userSettings.display_currency = document.getElementById('display_currency').value;
      if (window.globalConfig) window.globalConfig.set('display_currency', window.userSettings.display_currency);
      window.userSettings.min_usd_threshold = parseFloat(document.getElementById('min_usd_threshold').value);
      // Synchroniser le champ rapide
      const quickMinUsd = document.getElementById('quick_min_usd');
      if (quickMinUsd) quickMinUsd.value = window.userSettings.min_usd_threshold;
      if (window.globalConfig) window.globalConfig.set('min_usd_threshold', window.userSettings.min_usd_threshold);

      // Cl√©s API: sauvegarder si champ visible OU si valeur diff√©rente du masque actuel
      function saveSecretIfProvided(fieldId, settingKey) {
        const field = document.getElementById(fieldId);
        if (!field) return;
        const current = (window.userSettings || getDefaultSettings())[settingKey] || '';
        const masked = current ? maskApiKey(current) : '';
        const incoming = (field.value || '').trim();
        if (!incoming) return; // rien saisi
        if (field.type === 'text' || incoming !== masked) {
          window.userSettings[settingKey] = incoming;
        }
      }

      saveSecretIfProvided('coingecko_api_key', 'coingecko_api_key');
      saveSecretIfProvided('cointracking_api_key', 'cointracking_api_key');
      saveSecretIfProvided('cointracking_api_secret', 'cointracking_api_secret');
      saveSecretIfProvided('fred_api_key', 'fred_api_key');
      saveSecretIfProvided('debug_token', 'debug_token');

      window.userSettings.api_base_url = document.getElementById('api_base_url').value;
      if (window.globalConfig) window.globalConfig.set('api_base_url', window.userSettings.api_base_url);
      window.userSettings.refresh_interval = parseInt(document.getElementById('refresh_interval').value);
      if (window.globalConfig) window.globalConfig.set('refresh_interval', window.userSettings.refresh_interval);

      window.userSettings.enable_coingecko_classification = document.getElementById('enable_coingecko_classification').checked;
      if (window.globalConfig) window.globalConfig.set('enable_coingecko_classification', window.userSettings.enable_coingecko_classification);
      window.userSettings.enable_portfolio_snapshots = document.getElementById('enable_portfolio_snapshots').checked;
      if (window.globalConfig) window.globalConfig.set('enable_portfolio_snapshots', window.userSettings.enable_portfolio_snapshots);
      window.userSettings.enable_performance_tracking = document.getElementById('enable_performance_tracking').checked;
      if (window.globalConfig) window.globalConfig.set('enable_performance_tracking', window.userSettings.enable_performance_tracking);

      // Mettre √† jour les statuts
      updateApiKeyStatus('coingecko', !!window.userSettings.coingecko_api_key);
      updateApiKeyStatus('cointracking_key', !!window.userSettings.cointracking_api_key);
      updateApiKeyStatus('cointracking_secret', !!window.userSettings.cointracking_api_secret);
      updateApiKeyStatus('fred', !!window.userSettings.fred_api_key);

      await saveSettings();

      // Notification
      showNotification('‚öôÔ∏è Configuration sauvegard√©e !', 'success');
    }

    // Test de la source de donn√©es
    async function testDataSource() {
      const testDiv = document.getElementById('data-source-test');
      testDiv.innerHTML = '<div class="test-result">üß™ Test en cours...</div>';

      try {
        const globalSettings = window.userSettings || getDefaultSettings();
        const response = await fetch(`${globalSettings.api_base_url}/balances/current?source=${globalSettings.data_source}`, {
          headers: { 'X-User': getActiveUser() }
        });
        const data = await response.json();

        if (response.ok && data.items && data.items.length > 0) {
          testDiv.innerHTML = `
        <div class="test-result" style="color: var(--pos);">
          ‚úÖ <strong>Succ√®s</strong><br>
          Source: ${data.source_used}<br>
          Assets trouv√©s: ${data.items.length}<br>
          Premier asset: ${data.items[0].symbol} (${data.items[0].value_usd || 0} USD)
        </div>
      `;
        } else {
          testDiv.innerHTML = `
        <div class="test-result" style="color: var(--warning);">
          ‚ö†Ô∏è <strong>Aucune donn√©e</strong><br>
          La source r√©pond mais ne retourne pas d'assets
        </div>
      `;
        }
      } catch (error) {
        testDiv.innerHTML = `
      <div class="test-result" style="color: var(--danger);">
        ‚ùå <strong>Erreur</strong><br>
        ${error.message}
      </div>
    `;
      }
    }

    // Auto-d√©tecter le DEBUG_TOKEN depuis l'environnement
    async function autoDetectDebugToken() {
      // V√©rifier le rate limiting
      const lastAttempt = localStorage.getItem('debug_token_detection_last');
      const now = Date.now();
      if (lastAttempt && (now - parseInt(lastAttempt)) < 60000) { // 1 minute
        console.debug('üîç DEBUG_TOKEN auto-d√©tection rate-limit√©e, skip');
        return;
      }
      localStorage.setItem('debug_token_detection_last', now.toString());

      // Pour l'instant, essayer une liste de tokens courants pour le dev
      const commonTokens = [
        'crypto-rebal-debug-2025-secure',
        'dev-token-2025',
        'debug-crypto-rebal'
      ];

      for (let i = 0; i < commonTokens.length; i++) {
        const token = commonTokens[i];
        try {
          const response = await fetch(`${(window.userSettings || getDefaultSettings()).api_base_url}/debug/api-keys?debug_token=${token}`, {
            headers: { 'X-User': getActiveUser() }
          });
          if (response.ok) {
            if (!window.userSettings) window.userSettings = getDefaultSettings();
            window.userSettings.debug_token = token;
            document.getElementById('debug_token').value = maskApiKey(token);
            console.debug('DEBUG_TOKEN auto-d√©tect√© et configur√©');
            showNotification('üîë DEBUG_TOKEN auto-d√©tect√©', 'success');
            return;
          }
          // Rate limit les tentatives
          if (response.status === 429) {
            console.debug(`üö¶ Rate limite atteinte, attendre avant prochaine tentative`);
            await new Promise(resolve => setTimeout(resolve, 2000)); // 2 secondes
          }
        } catch (e) {
          // Continuer avec le token suivant
          console.debug(`Token ${token} √©chou√©:`, e.message);
        }

        // D√©lai entre les tentatives pour √©viter rate limiting
        if (i < commonTokens.length - 1) {
          await new Promise(resolve => setTimeout(resolve, 1000)); // 1 seconde entre tentatives
        }
      }

      console.debug('DEBUG_TOKEN non trouv√© automatiquement, saisie manuelle requise');
    }

    // Auto-d√©tecter les cl√©s depuis .env du serveur
    async function autoDetectApiKeys() {
      try {
        const globalSettings = window.userSettings || getDefaultSettings();
        // Essayer de r√©cup√©rer les cl√©s depuis le backend  
        const debugToken = (window.userSettings || getDefaultSettings()).debug_token;
        if (!debugToken) {
          console.debug('Auto-d√©tection d√©sactiv√©e: DEBUG_TOKEN requis');
          return;
        }
        const response = await fetch(`${globalSettings.api_base_url}/debug/api-keys?debug_token=${debugToken}`, {
          headers: { 'X-User': getActiveUser() }
        });
        if (response.ok) {
          const data = await response.json();
          let foundKeys = false;

          // CoinGecko - ne pas sauvegarder les cl√©s masqu√©es du serveur
          if (data.coingecko_api_key && data.coingecko_api_key.endsWith('...')) {
            // Cl√© masqu√©e du serveur - ne pas l'assigner aux settings utilisateur
            console.debug('CoinGecko API key found on server (masked)');
          } else if (data.coingecko_api_key && !globalSettings.coingecko_api_key) {
            if (!window.userSettings) window.userSettings = getDefaultSettings();
            window.userSettings.coingecko_api_key = data.coingecko_api_key;
            foundKeys = true;
          }
          if ((window.userSettings || getDefaultSettings()).coingecko_api_key) {
            document.getElementById('coingecko_api_key').value = maskApiKey((window.userSettings || getDefaultSettings()).coingecko_api_key);
            updateApiKeyStatus('coingecko', true);
          }

          // FRED - ne pas sauvegarder les cl√©s masqu√©es du serveur
          if (data.fred_api_key && data.fred_api_key.endsWith('...')) {
            // Cl√© masqu√©e du serveur - ne pas l'assigner aux settings utilisateur
            console.debug('FRED API key found on server (masked)');
          } else if (data.fred_api_key && !globalSettings.fred_api_key) {
            if (!window.userSettings) window.userSettings = getDefaultSettings();
            window.userSettings.fred_api_key = data.fred_api_key;
            foundKeys = true;
          }
          if ((window.userSettings || getDefaultSettings()).fred_api_key) {
            document.getElementById('fred_api_key').value = maskApiKey((window.userSettings || getDefaultSettings()).fred_api_key);
            updateApiKeyStatus('fred', true);
          }

          // CoinTracking Key - ne pas sauvegarder les cl√©s masqu√©es du serveur
          if (data.cointracking_api_key && data.cointracking_api_key.endsWith('...')) {
            // Cl√© masqu√©e du serveur - ne pas l'assigner aux settings utilisateur
            console.debug('CoinTracking API key found on server (masked)');
          } else if (data.cointracking_api_key && !globalSettings.cointracking_api_key) {
            if (!window.userSettings) window.userSettings = getDefaultSettings();
            window.userSettings.cointracking_api_key = data.cointracking_api_key;
            foundKeys = true;
          }
          if ((window.userSettings || getDefaultSettings()).cointracking_api_key) {
            document.getElementById('cointracking_api_key').value = maskApiKey((window.userSettings || getDefaultSettings()).cointracking_api_key);
            updateApiKeyStatus('cointracking_key', true);
          }

          // CoinTracking Secret - ne pas sauvegarder les cl√©s masqu√©es du serveur
          if (data.cointracking_api_secret && data.cointracking_api_secret === '***masked***') {
            // Cl√© masqu√©e du serveur - ne pas l'assigner aux settings utilisateur
            console.debug('CoinTracking API secret found on server (masked)');
          } else if (data.cointracking_api_secret && !globalSettings.cointracking_api_secret) {
            if (!window.userSettings) window.userSettings = getDefaultSettings();
            window.userSettings.cointracking_api_secret = data.cointracking_api_secret;
            foundKeys = true;
          }
          if ((window.userSettings || getDefaultSettings()).cointracking_api_secret) {
            document.getElementById('cointracking_api_secret').value = maskApiKey((window.userSettings || getDefaultSettings()).cointracking_api_secret);
            updateApiKeyStatus('cointracking_secret', true);
          }

          if (foundKeys) {
            saveSettings(); // Sauvegarder les nouvelles cl√©s
            showNotification('üîë Cl√©s API d√©tect√©es depuis .env', 'success');
          }
        }
      } catch (e) {
        console.debug('Auto-d√©tection des cl√©s non disponible:', e.message);
      }
    }

    // Masquer une cl√© API pour l'affichage
    function maskApiKey(key) {
      if (!key || key.length < 8) return key;
      return key.substring(0, 4) + '‚Ä¢'.repeat(key.length - 8) + key.substring(key.length - 4);
    }

    // Mettre √† jour le statut d'une cl√© API
    function updateApiKeyStatus(keyType, hasKey) {
      const statusEl = document.getElementById(`${keyType}_status`);
      if (statusEl) {
        if (hasKey) {
          statusEl.textContent = 'Configur√©e';
          statusEl.className = 'status-indicator status-ok';
        } else {
          statusEl.textContent = 'Vide';
          statusEl.className = 'status-indicator status-warning';
        }
      }
    }

    // Basculer la visibilit√© d'une cl√© API
    function toggleApiKeyVisibility(fieldId) {
      const field = document.getElementById(fieldId);
      const isPassword = field.type === 'password';

      if (isPassword) {
        // Afficher la vraie cl√©
        const settingKey = fieldId; // m√™me nom que dans globalConfig
        field.type = 'text';
        field.value = (window.userSettings || getDefaultSettings())[settingKey] || '';
      } else {
        // Masquer avec des points
        field.type = 'password';
        const settingKey = fieldId;
        const value = (window.userSettings || getDefaultSettings())[settingKey];
        field.value = value ? maskApiKey(value) : '';
      }
    }

    // Synchroniser depuis .env
    async function syncApiKeysFromEnv() {
      try {
        const debugToken = (window.userSettings || getDefaultSettings()).debug_token;
        if (!debugToken) {
          showNotification('‚ùå DEBUG_TOKEN requis pour synchroniser depuis .env', 'error');
          return;
        }
        const response = await fetch(`${(window.userSettings || getDefaultSettings()).api_base_url}/debug/api-keys?debug_token=${debugToken}`);
        if (response.ok) {
          const data = await response.json();
          let foundKeys = false;

          // Forcer le rechargement de toutes les cl√©s depuis .env (ne pas sauver les masqu√©es)
          if (data.coingecko_api_key) {
            if (!data.coingecko_api_key.endsWith('...')) {
              if (!window.userSettings) window.userSettings = getDefaultSettings();
              window.userSettings.coingecko_api_key = data.coingecko_api_key;
            }
            document.getElementById('coingecko_api_key').value = maskApiKey(data.coingecko_api_key);
            updateApiKeyStatus('coingecko', true);
            foundKeys = true;
          } else {
            updateApiKeyStatus('coingecko', false);
          }

          if (data.fred_api_key) {
            if (!data.fred_api_key.endsWith('...')) {
              if (!window.userSettings) window.userSettings = getDefaultSettings();
              window.userSettings.fred_api_key = data.fred_api_key;
            }
            document.getElementById('fred_api_key').value = maskApiKey(data.fred_api_key);
            updateApiKeyStatus('fred', true);
            foundKeys = true;
          } else {
            updateApiKeyStatus('fred', false);
          }

          if (data.cointracking_api_key) {
            if (!data.cointracking_api_key.endsWith('...')) {
              if (!window.userSettings) window.userSettings = getDefaultSettings();
              window.userSettings.cointracking_api_key = data.cointracking_api_key;
            }
            document.getElementById('cointracking_api_key').value = maskApiKey(data.cointracking_api_key);
            updateApiKeyStatus('cointracking_key', true);
            foundKeys = true;
          } else {
            updateApiKeyStatus('cointracking_key', false);
          }

          if (data.cointracking_api_secret) {
            if (data.cointracking_api_secret !== '***masked***') {
              if (!window.userSettings) window.userSettings = getDefaultSettings();
              window.userSettings.cointracking_api_secret = data.cointracking_api_secret;
            }
            document.getElementById('cointracking_api_secret').value = maskApiKey(data.cointracking_api_secret);
            updateApiKeyStatus('cointracking_secret', true);
            foundKeys = true;
          } else {
            updateApiKeyStatus('cointracking_secret', false);
          }

          if (foundKeys) {
            saveSettings();
            showNotification('üì• Cl√©s recharg√©es depuis .env', 'success');
          } else {
            showNotification('‚ö†Ô∏è Aucune cl√© trouv√©e dans .env', 'warning');
          }
        } else {
          showNotification('‚ùå Erreur lecture .env', 'error');
        }
      } catch (e) {
        showNotification(`‚ùå Erreur: ${e.message}`, 'error');
      }
    }

    // Synchroniser vers .env
    async function syncApiKeysToEnv() {
      const payload = {
        coingecko_api_key: (window.userSettings || getDefaultSettings()).coingecko_api_key || '',
        cointracking_api_key: (window.userSettings || getDefaultSettings()).cointracking_api_key || '',
        cointracking_api_secret: (window.userSettings || getDefaultSettings()).cointracking_api_secret || '',
        fred_api_key: (window.userSettings || getDefaultSettings()).fred_api_key || ''
      };

      try {
        const debugToken = (window.userSettings || getDefaultSettings()).debug_token;
        if (!debugToken) {
          showNotification('‚ùå DEBUG_TOKEN requis pour sauvegarder vers .env', 'error');
          return;
        }
        const response = await fetch(`${(window.userSettings || getDefaultSettings()).api_base_url}/debug/api-keys?debug_token=${debugToken}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-User': getActiveUser() },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          const result = await response.json();
          if (result.updated) {
            showNotification('üíæ Cl√©s sauv√©es vers .env', 'success');
          } else {
            showNotification('‚ö™ Aucune cl√© √† sauvegarder', 'info');
          }
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (e) {
        showNotification(`‚ùå Erreur sauvegarde: ${e.message}`, 'error');
      }
    }

    // Test des cl√©s API
    async function testApiKeys() {
      const testDiv = document.getElementById('api-keys-test');
      testDiv.innerHTML = '<div class="test-result">üß™ Test des APIs...</div>';

      let results = [];
      const globalSettings = window.userSettings || getDefaultSettings();

      // Test CoinGecko
      if (globalSettings.coingecko_api_key) {
        try {
          const response = await fetch(`${globalSettings.api_base_url}/taxonomy/test-coingecko-api?api_key=${encodeURIComponent(globalSettings.coingecko_api_key)}`, {
            headers: { 'X-User': getActiveUser() }
          });
          const data = await response.json();
          results.push(`ü•∑ CoinGecko: ${data.ok ? '‚úÖ OK' : '‚ùå Erreur'}`);
          if (!data.ok && data.message) {
            results.push(`   ‚îî‚îÄ ${data.message}`);
          }
        } catch (e) {
          results.push(`ü•∑ CoinGecko: ‚ùå ${e.message}`);
        }
      } else {
        results.push(`ü•∑ CoinGecko: ‚ö™ Pas de cl√© configur√©e`);
      }

      // Test FRED via backend proxy
      if (globalSettings.fred_api_key) {
        try {
          const response = await fetch(`${globalSettings.api_base_url}/proxy/fred/bitcoin?limit=1`, {
            headers: { 'X-User': getActiveUser() }
          });
          const data = await response.json();
          results.push(`üèõÔ∏è FRED: ${response.ok && data.success ? '‚úÖ OK' : '‚ùå Erreur'}`);
          if (!response.ok && data.detail) {
            results.push(`   ‚îî‚îÄ ${data.detail}`);
          } else if (!data.success && data.error) {
            results.push(`   ‚îî‚îÄ ${data.error}`);
          }
        } catch (e) {
          results.push(`üèõÔ∏è FRED: ‚ùå ${e.message}`);
        }
      } else {
        results.push(`üèõÔ∏è FRED: ‚ö™ Pas de cl√© configur√©e`);
      }

      // Test CoinTracking API
      if (globalSettings.cointracking_api_key && globalSettings.cointracking_api_secret) {
        try {
          const response = await fetch(`${globalSettings.api_base_url}/balances/current?source=cointracking_api&limit=1`, {
            headers: { 'X-User': getActiveUser() }
          });
          const data = await response.json();
          results.push(`üìä CoinTracking API: ${response.ok && data.items ? '‚úÖ OK' : '‚ùå Erreur'}`);
        } catch (e) {
          results.push(`üìä CoinTracking API: ‚ùå ${e.message}`);
        }
      } else {
        results.push(`üìä CoinTracking API: ‚ö™ Cl√©s manquantes`);
      }

      // Test Backend disponibilit√©
      try {
        const response = await fetch(`${globalSettings.api_base_url}/health`, {
          headers: { 'X-User': getActiveUser() }
        });
        results.push(`üè• Backend: ${response.ok ? '‚úÖ OK' : '‚ùå Indisponible'}`);
      } catch (e) {
        results.push(`üè• Backend: ‚ùå ${e.message}`);
      }

      testDiv.innerHTML = `
      <div class="test-result">
        <strong>R√©sultats des tests:</strong><br>
          ${results.join('<br>')}
      </div>
      `;
    }

    // Test complet du syst√®me
    async function runFullSystemTest() {
      const testDiv = document.getElementById('full-system-test');
      testDiv.innerHTML = '<div class="test-result">üöÄ Test complet en cours...</div>';

      let results = [];
      const globalSettings = window.userSettings || getDefaultSettings();

      // Test backend
      try {
        const healthResponse = await fetch(`${globalSettings.api_base_url}/healthz`, { headers: { 'X-User': getActiveUser() } });
        results.push(`üè• Backend: ${healthResponse.ok ? '‚úÖ OK' : '‚ùå Erreur'}`);
      } catch (e) {
        results.push(`üè• Backend: ‚ùå ${e.message}`);
      }

      // Test source de donn√©es
      try {
        const balanceResponse = await fetch(`${globalSettings.api_base_url}/balances/current?source=${globalSettings.data_source}`, { headers: { 'X-User': getActiveUser() } });
        const balanceData = await balanceResponse.json();
        results.push(`üìä Balances: ${balanceData.items?.length > 0 ? '‚úÖ OK (' + balanceData.items.length + ' assets)' : '‚ùå Vide'}`);
      } catch (e) {
        results.push(`üìä Balances: ‚ùå ${e.message}`);
      }

      // Test portfolio analytics
      try {
        const metricsResponse = await fetch(`${globalSettings.api_base_url}/portfolio/metrics?source=${globalSettings.data_source}`, { headers: { 'X-User': getActiveUser() } });
        const metricsData = await metricsResponse.json();
        results.push(`üìà Analytics: ${metricsData.ok && metricsData.metrics?.total_value_usd > 0 ? '‚úÖ OK' : '‚ùå Erreur'}`);
      } catch (e) {
        results.push(`üìà Analytics: ‚ùå ${e.message}`);
      }

      // Test taxonomie
      try {
        const taxResponse = await fetch(`${globalSettings.api_base_url}/taxonomy/suggestions`, { headers: { 'X-User': getActiveUser() } });
        const taxData = await taxResponse.json();
        results.push(`üè∑Ô∏è Taxonomie: ${taxResponse.ok ? '‚úÖ OK' : '‚ùå Erreur'}`);
      } catch (e) {
        results.push(`üè∑Ô∏è Taxonomie: ‚ùå ${e.message}`);
      }

      testDiv.innerHTML = `
      <div class="test-result">
        <strong>üß™ R√©sultats du test complet:</strong><br>
          ${results.join('<br>')}
          <br><br>
            <strong>Configuration test√©e:</strong><br>
              Source: ${globalSettings.data_source}<br>
                Pricing: ${globalSettings.pricing}<br>
                  API: ${globalSettings.api_base_url}
                </div>
                `;
    }

    // Utilitaires
    function resetToDefaults() {
      if (confirm('Restaurer la configuration par d√©faut ?')) {
        globalConfig.reset();
        location.reload();
      }
    }

    function exportSettings() {
      globalConfig.export();
    }

    async function importSettings() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (file) {
          try {
            await globalConfig.importFromFile(file);
            location.reload();
          } catch (err) {
            alert('Erreur import: ' + err.message);
          }
        }
      };
      input.click();
    }

    function clearCache() {
      if (confirm('Vider tout le cache local ?')) {
        localStorage.removeItem('lastPortfolioSnapshot');
        showNotification('üóëÔ∏è Cache vid√© !', 'success');
      }
    }

    function resetAllData() {
      if (confirm('‚ö†Ô∏è ATTENTION: Supprimer TOUTES les donn√©es et configurations ?')) {
        localStorage.clear();
        showNotification('‚ö†Ô∏è Toutes les donn√©es supprim√©es !', 'warning');
        setTimeout(() => location.reload(), 1000);
      }
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.style.cssText = `
                position: fixed; bottom: 20px; right: 20px; z-index: 1000;
                padding: 12px 16px; border-radius: 8px; color: white; font-weight: 600;
                background: ${type === 'success' ? 'var(--pos)' : type === 'warning' ? 'var(--warning)' : 'var(--accent)'};
                `;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }

    // Appliquer le th√®me d√®s que possible
    function applyThemeImmediately() {
      console.debug('Applying theme immediately for settings page...');
      if (window.globalConfig && window.globalConfig.applyTheme) {
        window.globalConfig.applyTheme();
      }
      if (window.applyAppearance) {
        window.applyAppearance();
      }
      console.debug('Theme applied, current theme:', document.documentElement.getAttribute('data-theme'));
    }

    // Ajouter le header partag√© et initialiser
    document.addEventListener('DOMContentLoaded', () => {
      // Appliquer le th√®me imm√©diatement
      applyThemeImmediately();

      loadSettings().then(() => {
        // Tenter de r√©cup√©rer le DEBUG_TOKEN depuis le serveur
        autoDetectDebugToken();
      });
      // Tenter l'auto-d√©tection des cl√©s imm√©diatement
      autoDetectApiKeys();

      // √âcouter les changements de th√®me syst√®me pour mettre √† jour l'interface
      window.addEventListener('themeChanged', (event) => {
        console.debug('üé® Th√®me chang√©:', event.detail);
        // L'interface n'a pas besoin d'√™tre mise √† jour car elle suit d√©j√† globalConfig
      });
    });

    // ===== FONCTIONS T√âL√âCHARGEMENT CSV =====

    async function downloadCSVFiles() {
      const downloadBtn = document.getElementById('download-btn-text');
      const statusDiv = document.getElementById('csv-download-status');

      // V√©rifier les cl√©s API
      const userSettings = window.userSettings || getDefaultSettings();
      const apiKey = userSettings.cointracking_api_key;
      const apiSecret = userSettings.cointracking_api_secret;

      if (!apiKey || !apiSecret) {
        statusDiv.innerHTML = '<div class="error">‚ùå Cl√©s API CoinTracking requises pour le t√©l√©chargement automatique.</div>';
        return;
      }

      downloadBtn.textContent = '‚è≥ T√©l√©chargement...';
      statusDiv.innerHTML = '<div class="info">üîÑ T√©l√©chargement en cours...</div>';

      try {
        const selectedFiles = getSelectedFiles();
        const downloadPath = document.getElementById('csv_download_path').value || 'data/raw/';

        const results = [];

        for (const fileType of selectedFiles) {
          try {
            const result = await downloadSingleCSV(fileType, downloadPath);
            results.push(result);
          } catch (error) {
            results.push({
              type: fileType,
              success: false,
              error: error.message
            });
          }
        }

        displayDownloadResults(results);

      } catch (error) {
        statusDiv.innerHTML = `<div class="error">‚ùå Erreur t√©l√©chargement: ${error.message}</div>`;
      } finally {
        downloadBtn.textContent = 'üì• T√©l√©charger Maintenant';
      }
    }

    function getSelectedFiles() {
      const files = [];
      if (document.getElementById('download_current_balance').checked) {
        files.push('current_balance');
      }
      if (document.getElementById('download_balance_by_exchange').checked) {
        files.push('balance_by_exchange');
      }
      if (document.getElementById('download_coins_by_exchange').checked) {
        files.push('coins_by_exchange');
      }
      return files;
    }

    async function downloadSingleCSV(fileType, downloadPath) {
      // Appeler l'API backend pour t√©l√©charger le CSV
      const response = await globalConfig.apiRequest('/csv/download', {
        method: 'POST',
        body: JSON.stringify({
          file_type: fileType,
          download_path: downloadPath,
          auto_name: true  // Utilise automatiquement le nom avec date
        })
      });

      if (response.success) {
        return {
          type: fileType,
          success: true,
          filename: response.filename,
          path: response.path,
          size: response.size
        };
      } else {
        throw new Error(response.error || 'T√©l√©chargement √©chou√©');
      }
    }

    function displayDownloadResults(results) {
      const statusDiv = document.getElementById('csv-download-status');
      let html = '<div style="margin-top: 16px;"><h4>R√©sultats du t√©l√©chargement:</h4><ul>';

      results.forEach(result => {
        const icon = result.success ? '‚úÖ' : '‚ùå';
        const fileLabel = getFileLabel(result.type);

        if (result.success) {
          html += `<li>${icon} <strong>${fileLabel}</strong>: ${result.filename} (${formatFileSize(result.size)})</li>`;
        } else {
          html += `<li>${icon} <strong>${fileLabel}</strong>: ${result.error}</li>`;
        }
      });

      html += '</ul></div>';
      statusDiv.innerHTML = html;

      // Actualiser le status des fichiers apr√®s t√©l√©chargement
      setTimeout(checkCSVStatus, 1000);
    }

    function getFileLabel(type) {
      const labels = {
        'current_balance': 'Current Balance',
        'balance_by_exchange': 'Balance by Exchange',
        'coins_by_exchange': 'Coins by Exchange'
      };
      return labels[type] || type;
    }

    function formatFileSize(bytes) {
      if (!bytes) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    async function checkCSVStatus() {
      const statusDiv = document.getElementById('csv-download-status');

      try {
        const response = await globalConfig.apiRequest('/csv/status');

        if (response.success) {
          displayCSVStatus(response.files);
        } else {
          statusDiv.innerHTML = '<div class="error">‚ùå Impossible de v√©rifier le status des fichiers CSV.</div>';
        }
      } catch (error) {
        statusDiv.innerHTML = `<div class="error">‚ùå Erreur v√©rification: ${error.message}</div>`;
      }
    }

    function displayCSVStatus(files) {
      const statusDiv = document.getElementById('csv-download-status');

      if (!files || files.length === 0) {
        statusDiv.innerHTML = '<div class="warning">‚ö†Ô∏è Aucun fichier CSV trouv√© pour ce profil</div>';
        return;
      }

      let html = '<div style="margin-top: 16px;"><h4>Fichiers CSV disponibles:</h4><ul>';

      files.forEach(file => {
        const age = getFileAge(file.modified);
        const ageClass = age.days > 1 ? 'warning' : age.hours > 12 ? 'info' : 'success';

        html += `<li>
          <span class="status-indicator status-${ageClass}">üìÑ</span>
          <strong>${file.name}</strong> 
          (${formatFileSize(file.size)}, ${age.text})
        </li>`;
      });

      html += '</ul></div>';
      statusDiv.innerHTML = html;
    }

    function getFileAge(modifiedTimestamp) {
      const now = Date.now();
      const modified = new Date(modifiedTimestamp).getTime();
      const diffMs = now - modified;
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffDays = Math.floor(diffHours / 24);

      if (diffDays > 0) {
        return { days: diffDays, hours: diffHours, text: `${diffDays}j` };
      } else if (diffHours > 0) {
        return { days: 0, hours: diffHours, text: `${diffHours}h` };
      } else {
        const diffMinutes = Math.floor(diffMs / (1000 * 60));
        return { days: 0, hours: 0, text: `${diffMinutes}min` };
      }
    }

    function browseDownloadFolder() {
      // Pour l'instant, juste permettre de saisir manuellement
      // Dans une vraie application, on utiliserait l'API File System
      const currentPath = document.getElementById('csv_download_path').value;
      const newPath = prompt('Chemin du dossier de t√©l√©chargement:', currentPath);
      if (newPath) {
        document.getElementById('csv_download_path').value = newPath;
      }
    }

    // Charger le status des CSV au chargement de la page
    document.addEventListener('DOMContentLoaded', () => {
      try { loadSettings().catch(console.error); } catch (_) { }
      setTimeout(checkCSVStatus, 1000); // Attendre que globalConfig soit pr√™t
      setTimeout(loadSaxoIntegrationStatus, 1500); // Load Saxo status

      // √âcouter les changements d'utilisateur pour recharger les settings
      const userSelector = document.getElementById('user-selector');
      if (userSelector) {
        userSelector.addEventListener('change', async (e) => {
          console.log('User changed, reloading settings...');
          try {
            await loadSettings();
          } catch (error) {
            console.error('Failed to reload settings after user change:', error);
          }
        });
      }
    });

    // ========== SAXO INTEGRATION MANAGEMENT ==========

    async function loadSaxoIntegrationStatus() {
      try {
        const response = await fetch(`${(window.userSettings || getDefaultSettings()).api_base_url}/api/saxo/portfolios`, {
          timeout: 5000,
          headers: { 'X-User': getActiveUser() }
        });

        if (!response.ok) {
          if (response.status === 500) {
            console.debug('Saxo API endpoint non disponible (500), utilisation fallback');
          } else if (response.status === 404) {
            console.debug('Saxo endpoint non trouv√© (404), fonctionnalit√© non activ√©e');
          } else {
            console.debug(`Erreur Saxo API: ${response.status} ${response.statusText}`);
          }
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        updateSaxoStatus(data);

      } catch (error) {
        console.debug('Saxo integration not available or error:', error.message);
        // Fallback graceful avec √©tat vide
        updateSaxoStatus({
          portfolios: [],
          error: 'Service temporairement indisponible',
          status: 'unavailable'
        });
      }
    }

    function updateSaxoStatus(data) {
      const countSpan = document.getElementById('saxo-portfolios-count');
      const dashboardBtn = document.getElementById('saxo-dashboard-btn');
      const stockValueSpan = document.getElementById('stock-value');

      if (data.portfolios && data.portfolios.length > 0) {
        const totalValue = data.portfolios.reduce((sum, p) => sum + p.total_value_usd, 0);

        if (countSpan) {
          countSpan.textContent = `${data.portfolios.length} portfolio(s) - $${totalValue.toLocaleString()}`;
          countSpan.style.color = 'var(--success)';
        }

        if (dashboardBtn) {
          dashboardBtn.disabled = false;
          dashboardBtn.style.opacity = '1';
        }

        // Update stock value in summary
        if (stockValueSpan) {
          stockValueSpan.textContent = `$${totalValue.toLocaleString()}`;
          stockValueSpan.style.color = 'var(--brand-primary)';
        }

      } else {
        if (countSpan) {
          countSpan.textContent = 'Aucun portfolio import√©';
          countSpan.style.color = 'var(--theme-text-muted)';
        }

        if (dashboardBtn) {
          dashboardBtn.disabled = true;
          dashboardBtn.style.opacity = '0.5';
        }
      }
    }

    // === SAXO UPLOAD FUNCTIONS ===
    async function handleSaxoUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      console.log('üè¶ Starting Saxo upload:', file.name);

      const progressDiv = document.getElementById('saxo-upload-progress');
      const resultDiv = document.getElementById('saxo-upload-result');

      // Show progress
      progressDiv.style.display = 'block';
      resultDiv.style.display = 'none';

      try {
        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch(globalSettings.api_base_url + '/api/saxo/upload', {
          method: 'POST',
          body: formData,
          headers: {
            'X-User': getActiveUser()
          }
        });

        const result = await response.json();

        if (response.ok) {
          // Success
          resultDiv.innerHTML = `
            <div style="padding: 1rem; background: var(--success-bg); border: 1px solid var(--success); border-radius: var(--radius-md); color: var(--success);">
              <strong>‚úÖ Upload r√©ussi!</strong><br>
              ${result.portfolios_count || 1} portfolio(s) import√©(s) ‚Ä¢ ${result.positions_count || 0} positions
            </div>
          `;

          // Update status immediately
          await refreshSaxoStatus();

          // Show success toast (if available)
          if (window.showToast) {
            window.showToast('Portfolio Saxo import√© avec succ√®s!', 'success');
          }

          console.log('‚úÖ Saxo upload success:', result);

        } else {
          throw new Error(result.error || result.detail || 'Upload failed');
        }

      } catch (error) {
        console.error('‚ùå Saxo upload error:', error);

        resultDiv.innerHTML = `
          <div style="padding: 1rem; background: var(--danger-bg); border: 1px solid var(--danger); border-radius: var(--radius-md); color: var(--danger);">
            <strong>‚ùå Erreur d'upload</strong><br>
            ${error.message}
          </div>
        `;
      } finally {
        progressDiv.style.display = 'none';
        resultDiv.style.display = 'block';

        // Clear file input
        event.target.value = '';

        // Hide result after 10 seconds
        setTimeout(() => {
          resultDiv.style.display = 'none';
        }, 10000);
      }
    }

    async function refreshSaxoStatus() {
      console.log('üè¶ Refreshing Saxo status...');

      const statusSpan = document.getElementById('saxo-status-display');
      const dashboardBtn = document.getElementById('saxo-dashboard-btn');

      if (statusSpan) statusSpan.textContent = 'üîÑ V√©rification...';

      try {
        // Use the wealth store utility
        const { fetchSaxoSummary, formatCurrency } = await import('./modules/wealth-saxo-summary.js');
        const summary = await fetchSaxoSummary();

        if (summary.isEmpty || summary.error) {
          if (statusSpan) {
            statusSpan.textContent = 'üìÇ Aucun portfolio import√©';
            statusSpan.style.color = 'var(--theme-text-muted)';
          }
          if (dashboardBtn) {
            dashboardBtn.disabled = true;
            dashboardBtn.style.opacity = '0.5';
          }
        } else {
          if (statusSpan) {
            statusSpan.innerHTML = `‚úÖ Dernier import : ${summary.asof} ‚Ä¢ ${summary.positions_count} positions ‚Ä¢ ${formatCurrency(summary.total_value)}`;
            statusSpan.style.color = 'var(--success)';
          }
          if (dashboardBtn) {
            dashboardBtn.disabled = false;
            dashboardBtn.style.opacity = '1';
          }
        }

      } catch (error) {
        console.debug('[Settings Saxo] Error refreshing status:', error.message);
        if (statusSpan) {
          if (error.message?.includes('Failed to import')) {
            statusSpan.textContent = '‚ö†Ô∏è Module non disponible';
            statusSpan.style.color = 'var(--theme-text-muted)';
          } else {
            statusSpan.textContent = '‚ùå Service temporairement indisponible';
            statusSpan.style.color = 'var(--danger)';
          }
        }
        if (dashboardBtn) {
          dashboardBtn.disabled = true;
          dashboardBtn.style.opacity = '0.5';
        }
      }
    }

    // Initialize Saxo status on page load
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(refreshSaxoStatus, 1000); // Slight delay to ensure modules are loaded
    });

    // Make functions globally available
    window.handleSaxoUpload = handleSaxoUpload;
    window.refreshSaxoStatus = refreshSaxoStatus;

  </script>


  <script>
    // Initialisation automatique de la navigation simple
    document.addEventListener('DOMContentLoaded', function () {
      /* unified nav enabled via components/nav.js; legacy init removed */
    });
  </script>
</body>

</html>