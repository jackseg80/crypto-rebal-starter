<!DOCTYPE html>
<html>
<head>
    <title>üîß Debug CCS Sync - Strategic Dynamic Strategy</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #f5f5f5; }
        .section { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; border: 1px solid #ddd; }
        .success { color: #22c55e; font-weight: bold; }
        .error { color: #ef4444; font-weight: bold; }
        .warning { color: #f59e0b; font-weight: bold; }
        .info { color: #3b82f6; font-weight: bold; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        button { padding: 8px 16px; margin: 4px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-test { background: #3b82f6; color: white; }
        .btn-clear { background: #ef4444; color: white; }
        .btn-mock { background: #22c55e; color: white; }
    </style>
</head>
<body>
    <h1>üîß Debug Strategic (Dynamic) Strategy & CCS Sync</h1>
    
    <div class="section">
        <h2>üìã Actions de Test</h2>
        <button class="btn-test" onclick="checkLocalStorage()">üîç V√©rifier localStorage</button>
        <button class="btn-mock" onclick="createMockCCSData()">üéØ Cr√©er donn√©es CCS de test</button>
        <button class="btn-clear" onclick="clearCCSData()">üßπ Effacer donn√©es CCS</button>
        <button class="btn-test" onclick="testSyncFunction()">‚öôÔ∏è Tester fonction syncCCSTargets</button>
        <button class="btn-test" onclick="compareAllocations()">üìä Comparer allocations observ√©es</button>
    </div>

    <div class="section">
        <h2>üìä √âtat du localStorage</h2>
        <div id="localStorage-status">Cliquez sur "V√©rifier localStorage" pour voir l'√©tat</div>
    </div>

    <div class="section">
        <h2>üéØ Test de la fonction syncCCSTargets</h2>
        <div id="sync-test-result">Cliquez sur "Tester fonction" pour voir le r√©sultat</div>
    </div>

    <div class="section">
        <h2>üìä Comparaison des allocations</h2>
        <div id="allocation-comparison">Cliquez sur "Comparer allocations" pour analyser les diff√©rences</div>
    </div>

    <div class="section">
        <h2>‚öôÔ∏è Recommandations</h2>
        <div id="recommendations"></div>
    </div>

    <script>
        // Copie de la fonction syncCCSTargets depuis rebalance.html
        function syncCCSTargets() {
            const storedTargets = localStorage.getItem('last_targets');
            if (!storedTargets) return null;
            
            try {
                const targetsData = JSON.parse(storedTargets);
                console.log('Checking stored CCS targets:', targetsData);
                
                if (targetsData.source === 'risk-dashboard-ccs' && targetsData.targets && targetsData.timestamp) {
                    // V√©rifier que les donn√©es ne sont pas trop anciennes (30 minutes)
                    const dataAge = Date.now() - new Date(targetsData.timestamp).getTime();
                    const maxAge = 30 * 60 * 1000; // 30 minutes
                    
                    if (dataAge < maxAge) {
                        // Filtrer les targets pour ne garder que les valeurs num√©riques
                        const cleanTargets = {};
                        Object.entries(targetsData.targets).forEach(([key, value]) => {
                            if (typeof value === 'number' && key !== 'model_version') {
                                cleanTargets[key] = value;
                            }
                        });
                        
                        console.log('Valid CCS targets found:', cleanTargets);
                        return {
                            targets: cleanTargets,
                            strategy: targetsData.strategy,
                            timestamp: targetsData.timestamp
                        };
                    } else {
                        console.log('CCS targets too old, ignoring');
                    }
                }
            } catch (error) {
                console.error('Error parsing stored targets:', error);
            }
            
            return null;
        }

        function checkLocalStorage() {
            const status = document.getElementById('localStorage-status');
            const lastTargets = localStorage.getItem('last_targets');
            
            if (!lastTargets) {
                status.innerHTML = `
                    <div class="error">‚ùå Aucune donn√©e 'last_targets' trouv√©e dans localStorage</div>
                    <p>Ceci explique pourquoi Strategic (Dynamic) n'appara√Æt pas.</p>
                `;
                return;
            }
            
            try {
                const data = JSON.parse(lastTargets);
                const now = new Date();
                const timestamp = new Date(data.timestamp);
                const ageMinutes = Math.floor((now - timestamp) / (1000 * 60));
                
                status.innerHTML = `
                    <div class="success">‚úÖ Donn√©es trouv√©es dans localStorage</div>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                    <p><strong>√Çge des donn√©es:</strong> ${ageMinutes} minutes</p>
                    <p><strong>Source:</strong> ${data.source || 'Non sp√©cifi√©e'}</p>
                    <p><strong>Validit√©:</strong> ${ageMinutes < 30 ? '‚úÖ Valide' : '‚ùå Trop ancien (>30min)'}</p>
                `;
            } catch (error) {
                status.innerHTML = `
                    <div class="error">‚ùå Erreur parsing des donn√©es localStorage</div>
                    <p>Erreur: ${error.message}</p>
                    <pre>${lastTargets}</pre>
                `;
            }
        }

        function createMockCCSData() {
            const mockData = {
                source: 'risk-dashboard-ccs',
                strategy: 'Blended CCS* (72)',
                timestamp: new Date().toISOString(),
                targets: {
                    'BTC': 32.1,
                    'ETH': 24.2,
                    'Stablecoins': 21.3,
                    'L1/L0 majors': 11.1,
                    'L2/Scaling': 5.6,
                    'DeFi': 3.5,
                    'AI/Data': 2.2,
                    'Others': 0.0,
                    'model_version': 'ccs-blend-v1'
                }
            };
            
            localStorage.setItem('last_targets', JSON.stringify(mockData));
            
            const status = document.getElementById('localStorage-status');
            status.innerHTML = `
                <div class="success">‚úÖ Donn√©es CCS r√©elles cr√©√©es (Risk Dashboard: 32.1% BTC)</div>
                <p>Testez maintenant dans rebalance.html pour voir si vous obtenez les m√™mes allocations</p>
                <pre>${JSON.stringify(mockData, null, 2)}</pre>
            `;
        }

        function clearCCSData() {
            localStorage.removeItem('last_targets');
            
            const status = document.getElementById('localStorage-status');
            status.innerHTML = `
                <div class="warning">üßπ Donn√©es CCS effac√©es du localStorage</div>
                <p>Strategic (Dynamic) ne devrait plus appara√Ætre</p>
            `;
        }

        function testSyncFunction() {
            const result = syncCCSTargets();
            const resultDiv = document.getElementById('sync-test-result');
            
            if (result) {
                resultDiv.innerHTML = `
                    <div class="success">‚úÖ syncCCSTargets() fonctionne</div>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                    <p>Strategic (Dynamic) devrait appara√Ætre dans rebalance.html</p>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="error">‚ùå syncCCSTargets() retourne null</div>
                    <p>Raisons possibles:</p>
                    <ul>
                        <li>Pas de donn√©es 'last_targets' dans localStorage</li>
                        <li>Source diff√©rente de 'risk-dashboard-ccs'</li>
                        <li>Donn√©es plus anciennes que 30 minutes</li>
                        <li>Format de donn√©es incorrect</li>
                    </ul>
                `;
            }
            
            updateRecommendations();
        }

        function compareAllocations() {
            const compDiv = document.getElementById('allocation-comparison');
            
            // Allocations observ√©es par l'utilisateur
            const riskObserved = {
                'BTC': 32.1,
                'ETH': 24.2,
                'Stablecoins': 21.3,
                'L1/L0 majors': 11.1,
                'L2/Scaling': 5.6,
                'DeFi': 3.5,
                'AI/Data': 2.2,
                'Others': 0.0
            };

            const rebalanceObserved = {
                'BTC': 29.4,
                'ETH': 19.6,
                'Stablecoins': 29.4,
                'L1/L0 majors': 7.8,
                'L2/Scaling': 3.9,
                'DeFi': 7.8,
                'AI/Data': 2.0,
                'Others': 0.0
            };
            
            // Lire les donn√©es actuelles du localStorage
            let storedAllocations = null;
            const storedData = localStorage.getItem('last_targets');
            if (storedData) {
                try {
                    const parsed = JSON.parse(storedData);
                    storedAllocations = parsed.targets;
                } catch (error) {
                    console.error('Error parsing localStorage:', error);
                }
            }
            
            let html = `<div class="info">üìä Analyse des diff√©rences d'allocations:</div>`;
            html += `<table style="width:100%; border-collapse: collapse; margin: 10px 0;">`;
            html += `<tr style="background: #f0f0f0;">
                <th style="border: 1px solid #ddd; padding: 8px;">Asset</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Risk Dashboard</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Rebalance</th>
                <th style="border: 1px solid #ddd; padding: 8px;">localStorage</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Diff√©rence</th>
            </tr>`;
            
            Object.keys(riskObserved).forEach(asset => {
                const risk = riskObserved[asset];
                const rebalance = rebalanceObserved[asset];
                const stored = storedAllocations ? storedAllocations[asset] || 'N/A' : 'N/A';
                const diff = Math.abs(risk - rebalance);
                
                const diffClass = diff > 5 ? 'error' : diff > 1 ? 'warning' : 'success';
                
                html += `<tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">${asset}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${risk}%</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${rebalance}%</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${stored}${typeof stored === 'number' ? '%' : ''}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;" class="${diffClass}">${diff.toFixed(1)}%</td>
                </tr>`;
            });
            html += `</table>`;
            
            // Analyse des totaux
            const riskTotal = Object.values(riskObserved).reduce((sum, val) => sum + val, 0);
            const rebalanceTotal = Object.values(rebalanceObserved).reduce((sum, val) => sum + val, 0);
            const storedTotal = storedAllocations ? 
                Object.values(storedAllocations).filter(v => typeof v === 'number').reduce((sum, val) => sum + val, 0) : 0;
            
            html += `<div style="margin: 15px 0;">
                <div><strong>Totaux:</strong></div>
                <div>Risk Dashboard: ${riskTotal.toFixed(1)}%</div>
                <div>Rebalance: ${rebalanceTotal.toFixed(1)}%</div>
                <div>localStorage: ${storedTotal.toFixed(1)}%</div>
            </div>`;
            
            // Diagnostic
            html += `<div class="info">üîç Diagnostic:</div>`;
            if (Math.abs(riskTotal - 100) < 0.1 && Math.abs(rebalanceTotal - 100) < 0.1) {
                html += `<div class="warning">‚ö†Ô∏è Les deux totalisent ~100% mais avec des r√©partitions diff√©rentes</div>`;
                html += `<div>‚Üí Possible probl√®me de transformation/normalisation des donn√©es</div>`;
            }
            
            // V√©rifier si localStorage contient les bonnes donn√©es
            if (storedAllocations) {
                if (storedAllocations.BTC === riskObserved.BTC) {
                    html += `<div class="success">‚úÖ localStorage contient les donn√©es Risk Dashboard</div>`;
                } else if (storedAllocations.BTC === rebalanceObserved.BTC) {
                    html += `<div class="warning">‚ö†Ô∏è localStorage contient les donn√©es Rebalance transform√©es</div>`;
                } else {
                    html += `<div class="error">‚ùå localStorage contient des donn√©es diff√©rentes (BTC: ${storedAllocations.BTC}%)</div>`;
                }
            } else {
                html += `<div class="error">‚ùå Pas de donn√©es dans localStorage</div>`;
            }
            
            compDiv.innerHTML = html;
        }

        function updateRecommendations() {
            const recDiv = document.getElementById('recommendations');
            const hasData = localStorage.getItem('last_targets');
            const syncResult = syncCCSTargets();
            
            let recommendations = [];
            
            if (!hasData) {
                recommendations.push('üìù Cr√©er des donn√©es CCS de test avec le bouton vert');
                recommendations.push('üîÑ Ou aller dans Risk Dashboard pour g√©n√©rer de vraies donn√©es');
            }
            
            if (hasData && !syncResult) {
                const data = JSON.parse(hasData);
                const age = Math.floor((Date.now() - new Date(data.timestamp)) / (1000 * 60));
                
                if (age >= 30) {
                    recommendations.push('‚è∞ Donn√©es trop anciennes - Augmenter maxAge ou reg√©n√©rer');
                }
                
                if (data.source !== 'risk-dashboard-ccs') {
                    recommendations.push('üéØ Source incorrecte - Doit √™tre "risk-dashboard-ccs"');
                }
            }
            
            if (syncResult) {
                recommendations.push('‚úÖ Tout fonctionne - Strategic (Dynamic) devrait appara√Ætre');
                recommendations.push('üîÑ Testez le bouton "Sync CCS" dans rebalance.html');
            }
            
            recDiv.innerHTML = recommendations.map(r => `<div>${r}</div>`).join('');
        }

        // Test initial au chargement
        window.addEventListener('load', () => {
            checkLocalStorage();
            updateRecommendations();
        });
    </script>
</body>
</html>