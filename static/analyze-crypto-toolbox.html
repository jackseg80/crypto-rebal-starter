<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Analyze Crypto-Toolbox Structure</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a202c;
            color: #e2e8f0;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .card {
            background: #2d3748;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #4a5568;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            background: #3182ce;
            color: white;
            margin: 5px;
        }
        .btn:hover { background: #2c5282; }
        .log {
            background: #1a202c;
            padding: 15px;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .indicators-display {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .indicator-card {
            background: #1a202c;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #63b3ed;
        }
        .indicator-name {
            font-weight: bold;
            color: #63b3ed;
            margin-bottom: 8px;
        }
        .indicator-value {
            font-size: 20px;
            color: #48bb78;
            margin: 5px 0;
        }
        .indicator-critical {
            font-size: 14px;
            color: #f56565;
        }
        .html-preview {
            background: #1a202c;
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
            white-space: pre-wrap;
            color: #a0aec0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üîç Analyze Crypto-Toolbox Structure</h1>
            <p>Analyse de la structure HTML de crypto-toolbox.vercel.app/signaux</p>
            
            <div>
                <button class="btn" onclick="fetchAndAnalyze()">üì° Fetch & Analyze</button>
                <button class="btn" onclick="testDirectParsing()">üß™ Test Direct Parsing</button>
                <button class="btn" onclick="analyzeStructure()">üîç Analyze Structure</button>
                <button class="btn" onclick="clearResults()">üßπ Clear</button>
            </div>
        </div>

        <div class="card">
            <h3>üìä Extracted Indicators</h3>
            <div class="indicators-display" id="indicators-display">
                Aucun indicateur extrait...
            </div>
        </div>

        <div class="card">
            <h3>üìã HTML Preview</h3>
            <div class="html-preview" id="html-preview">
                HTML content will appear here...
            </div>
        </div>

        <div class="card">
            <h3>üìù Analysis Log</h3>
            <div class="log" id="analysis-log">
Crypto-Toolbox structure analyzer ready...
</div>
        </div>
    </div>

    <script>
        let logElement;
        let htmlPreviewElement;
        let indicatorsDisplayElement;
        
        window.onload = function() {
            logElement = document.getElementById('analysis-log');
            htmlPreviewElement = document.getElementById('html-preview');
            indicatorsDisplayElement = document.getElementById('indicators-display');
            log('üîç Structure analyzer initialized', 'success');
        };
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            logElement.textContent += `[${timestamp}] ${icon} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function displayIndicators(indicators) {
            if (!indicators || indicators.length === 0) {
                indicatorsDisplayElement.innerHTML = '<p>Aucun indicateur trouv√©</p>';
                return;
            }
            
            let html = '';
            indicators.forEach(indicator => {
                html += `
                    <div class="indicator-card">
                        <div class="indicator-name">${indicator.name}</div>
                        <div class="indicator-value">${indicator.value}</div>
                        <div class="indicator-critical">Zone critique: ${indicator.critical || 'N/A'}</div>
                        <div style="font-size: 12px; color: #718096; margin-top: 5px;">
                            Category: ${indicator.category || 'Unknown'}
                        </div>
                    </div>
                `;
            });
            indicatorsDisplayElement.innerHTML = html;
        }
        
        window.fetchAndAnalyze = async function() {
            log('üì° Fetching Crypto-Toolbox page...', 'info');
            
            try {
                const url = 'https://crypto-toolbox.vercel.app/signaux';
                
                log(`Making request to: ${url}`, 'info');
                const response = await fetch(url);
                
                log(`Response status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                log(`Content-Type: ${response.headers.get('content-type')}`, 'info');
                
                if (response.ok) {
                    const html = await response.text();
                    log(`HTML received: ${html.length} characters`, 'success');
                    
                    // Show HTML preview
                    const preview = html.substring(0, 2000);
                    htmlPreviewElement.textContent = preview + (html.length > 2000 ? '\n\n... (truncated)' : '');
                    
                    // Try to parse indicators
                    const indicators = parseIndicators(html);
                    log(`Parsed ${indicators.length} indicators`, indicators.length > 0 ? 'success' : 'error');
                    
                    displayIndicators(indicators);
                    
                    // Analyze structure
                    analyzeHTMLStructure(html);
                    
                } else {
                    log(`Failed to fetch: ${response.status}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Fetch failed: ${error.message}`, 'error');
                
                if (error.message.includes('CORS')) {
                    log('üö´ CORS error - trying alternative approach...', 'error');
                    testDirectParsing();
                }
            }
        };
        
        window.testDirectParsing = function() {
            log('üß™ Testing direct parsing with mock HTML...', 'info');
            
            // Mock HTML based on what we expect from crypto-toolbox
            const mockHTML = `
                <div class="container">
                    <h2>Indicateurs de donn√©es (9)</h2>
                    <table class="indicators-table">
                        <tr>
                            <td>MVRV Z-Score</td>
                            <td>45.2%</td>
                            <td>80%</td>
                        </tr>
                        <tr>
                            <td>Puell Multiple</td>
                            <td>62.8%</td>
                            <td>90%</td>
                        </tr>
                        <tr>
                            <td>NUPL</td>
                            <td>38.7%</td>
                            <td>85%</td>
                        </tr>
                        <tr>
                            <td>RSI Bitcoin</td>
                            <td>71.2%</td>
                            <td>70%</td>
                        </tr>
                    </table>
                    
                    <h2>Indicateurs classiques (2)</h2>
                    <table class="indicators-table">
                        <tr>
                            <td>Fear & Greed</td>
                            <td>65.0%</td>
                            <td>75%</td>
                        </tr>
                    </table>
                </div>
            `;
            
            log('Testing parsing with mock HTML...', 'info');
            const indicators = parseIndicators(mockHTML);
            log(`Mock parsing result: ${indicators.length} indicators`, 'success');
            
            displayIndicators(indicators);
            htmlPreviewElement.textContent = mockHTML;
        };
        
        function parseIndicators(html) {
            const indicators = [];
            
            try {
                // Create DOM parser
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Strategy 1: Look for tables
                const tables = doc.querySelectorAll('table');
                tables.forEach((table, tableIndex) => {
                    const rows = table.querySelectorAll('tr');
                    
                    rows.forEach((row, rowIndex) => {
                        const cells = row.querySelectorAll('td, th');
                        if (cells.length >= 2) {
                            const name = cells[0]?.textContent?.trim();
                            const value = cells[1]?.textContent?.trim();
                            const critical = cells[2]?.textContent?.trim();
                            
                            if (name && value && !name.toLowerCase().includes('indicateur') && value.includes('%')) {
                                indicators.push({
                                    name: name,
                                    value: value,
                                    critical: critical,
                                    category: `Table ${tableIndex + 1}`,
                                    source: 'table'
                                });
                            }
                        }
                    });
                });
                
                // Strategy 2: Look for specific patterns
                const patterns = [
                    { name: 'MVRV', regex: /MVRV.*?([0-9.]+%)/gi },
                    { name: 'Puell', regex: /Puell.*?([0-9.]+%)/gi },
                    { name: 'NUPL', regex: /NUPL.*?([0-9.]+%)/gi },
                    { name: 'RSI', regex: /RSI.*?([0-9.]+%)/gi },
                    { name: 'Fear.*Greed', regex: /Fear.*Greed.*?([0-9.]+%)/gi }
                ];
                
                patterns.forEach(pattern => {
                    const matches = html.matchAll(pattern.regex);
                    for (const match of matches) {
                        if (match[1]) {
                            indicators.push({
                                name: pattern.name,
                                value: match[1],
                                critical: 'N/A',
                                category: 'Pattern Match',
                                source: 'regex'
                            });
                        }
                    }
                });
                
            } catch (error) {
                log(`‚ùå Parsing error: ${error.message}`, 'error');
            }
            
            return indicators;
        }
        
        function analyzeHTMLStructure(html) {
            log('üîç Analyzing HTML structure...', 'info');
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Count different elements
            const tables = doc.querySelectorAll('table').length;
            const divs = doc.querySelectorAll('div').length;
            const spans = doc.querySelectorAll('span').length;
            const headers = doc.querySelectorAll('h1, h2, h3, h4, h5, h6').length;
            
            log(`Structure analysis:`, 'info');
            log(`  Tables: ${tables}`, 'info');
            log(`  Divs: ${divs}`, 'info');
            log(`  Spans: ${spans}`, 'info');
            log(`  Headers: ${headers}`, 'info');
            
            // Look for specific classes/IDs
            const classes = [];
            const ids = [];
            
            doc.querySelectorAll('*').forEach(el => {
                if (el.className && typeof el.className === 'string') {
                    el.className.split(' ').forEach(cls => {
                        if (cls && !classes.includes(cls)) classes.push(cls);
                    });
                }
                if (el.id && !ids.includes(el.id)) {
                    ids.push(el.id);
                }
            });
            
            log(`Found ${classes.length} unique classes`, 'info');
            log(`Found ${ids.length} unique IDs`, 'info');
            
            if (classes.length > 0) {
                log(`Sample classes: ${classes.slice(0, 10).join(', ')}`, 'info');
            }
        }
        
        window.analyzeStructure = function() {
            log('üîç Analyzing current HTML structure...', 'info');
            const html = htmlPreviewElement.textContent;
            if (html && html.trim()) {
                analyzeHTMLStructure(html);
            } else {
                log('No HTML to analyze. Fetch data first.', 'error');
            }
        };
        
        window.clearResults = function() {
            logElement.textContent = 'Results cleared...\n';
            htmlPreviewElement.textContent = 'HTML content will appear here...';
            indicatorsDisplayElement.innerHTML = 'Aucun indicateur extrait...';
        };
    </script>
</body>
</html>