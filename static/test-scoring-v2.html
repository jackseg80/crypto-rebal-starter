<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Test Scoring V2 - Corr√©lations & Consensus</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            background: #0f172a;
            color: #e2e8f0;
            line-height: 1.6;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #334155;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            background: #3b82f6;
            color: white;
            margin: 5px;
        }
        .btn:hover { background: #2563eb; }
        .btn.secondary {
            background: #64748b;
        }
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .v1-panel {
            border-left: 4px solid #f59e0b;
            background: #1e293b;
        }
        .v2-panel {
            border-left: 4px solid #10b981;
            background: #1e293b;
        }
        .score-display {
            font-size: 3rem;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }
        .score-v1 { color: #f59e0b; }
        .score-v2 { color: #10b981; }
        .category-breakdown {
            background: #0f172a;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #334155;
        }
        .correlation-analysis {
            background: #1e293b;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #3b82f6;
        }
        .consensus-signal {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin: 2px;
        }
        .consensus-bullish { background: #065f46; color: #10b981; }
        .consensus-bearish { background: #7f1d1d; color: #f87171; }
        .consensus-neutral { background: #374151; color: #9ca3af; }
        .improvement-tag {
            background: #1e40af;
            color: #93c5fd;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            display: inline-block;
            margin: 2px;
        }
        .log {
            background: #0f172a;
            padding: 15px;
            border-radius: 8px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üß™ Test Scoring System V2</h1>
            <p><strong>Comparaison V1 vs V2 :</strong> Corr√©lations, Consensus Voting & Cache Optimis√©</p>
            
            <div>
                <button class="btn" onclick="runComparison()">üÜö Compare V1 vs V2</button>
                <button class="btn secondary" onclick="testCorrelations()">üîó Test Correlations</button>
                <button class="btn secondary" onclick="testConsensus()">üó≥Ô∏è Test Consensus</button>
                <button class="btn secondary" onclick="analyzeCachePerformance()">‚ö° Cache Performance</button>
                <button class="btn secondary" onclick="clearResults()">üßπ Clear</button>
            </div>
        </div>

        <!-- Comparison Results -->
        <div class="comparison-grid" id="comparison-results" style="display: none;">
            <div class="card v1-panel">
                <h3>üìä System V1 (Actuel)</h3>
                <div id="v1-results">
                    <div class="score-display score-v1" id="v1-score">--</div>
                    <div id="v1-breakdown"></div>
                </div>
            </div>
            
            <div class="card v2-panel">
                <h3>üöÄ System V2 (Am√©lior√©)</h3>
                <div id="v2-results">
                    <div class="score-display score-v2" id="v2-score">--</div>
                    <div id="v2-breakdown"></div>
                </div>
            </div>
        </div>

        <!-- V2 Improvements -->
        <div class="card" id="improvements-panel" style="display: none;">
            <h3>‚ú® Am√©liorations V2</h3>
            <div id="improvements-content"></div>
        </div>

        <!-- Correlation Analysis -->
        <div class="card" id="correlation-panel" style="display: none;">
            <h3>üîó Analyse des Corr√©lations</h3>
            <div id="correlation-content"></div>
        </div>

        <!-- Test Log -->
        <div class="card">
            <h3>üìù Test Log</h3>
            <div class="log" id="test-log">
V2 scoring system test ready...
</div>
        </div>
    </div>

    <script type="module">
        let logElement;
        
        window.onload = function() {
            logElement = document.getElementById('test-log');
            log('üß™ V2 scoring system test ready', 'success');
        };
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            logElement.textContent += `[${timestamp}] ${icon} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        window.runComparison = async function() {
            log('üÜö Running V1 vs V2 comparison...', 'info');
            document.getElementById('comparison-results').style.display = 'grid';
            document.getElementById('improvements-panel').style.display = 'block';
            
            try {
                // Import both scoring systems
                const v1Module = await import('./modules/onchain-indicators.js');
                const v2Module = await import('./modules/composite-score-v2.js');
                
                log('‚úÖ Both modules imported successfully', 'success');
                
                // Get fresh indicators data
                const indicators = await v1Module.fetchAllIndicators();
                log(`üìä ${Object.keys(indicators).filter(k => !k.startsWith('_')).length} indicators loaded`, 'info');
                
                // Calculate V1 score
                log('üîÑ Calculating V1 score...', 'info');
                const v1Result = v1Module.calculateCompositeScore(indicators);
                
                // Calculate V2 score  
                log('üîÑ Calculating V2 score...', 'info');
                const v2Result = v2Module.calculateCompositeScoreV2(indicators);
                
                // Display results
                displayComparison(v1Result, v2Result);
                displayImprovements(v2Result);
                
                log(`‚úÖ Comparison complete: V1=${v1Result.score} vs V2=${v2Result.score}`, 'success');
                
            } catch (error) {
                log(`‚ùå Comparison failed: ${error.message}`, 'error');
                console.error(error);
            }
        };
        
        window.testCorrelations = async function() {
            log('üîó Testing correlation analysis...', 'info');
            document.getElementById('correlation-panel').style.display = 'block';
            
            try {
                const v2Module = await import('./modules/composite-score-v2.js');
                const v1Module = await import('./modules/onchain-indicators.js');
                
                const indicators = await v1Module.fetchAllIndicators();
                const v2Result = v2Module.calculateCompositeScoreV2(indicators);
                
                displayCorrelationAnalysis(v2Result.correlationAnalysis, v2Result.categoryBreakdown);
                
                log('‚úÖ Correlation analysis completed', 'success');
                
            } catch (error) {
                log(`‚ùå Correlation test failed: ${error.message}`, 'error');
            }
        };
        
        window.testConsensus = async function() {
            log('üó≥Ô∏è Testing consensus voting system...', 'info');
            
            try {
                const v2Module = await import('./modules/composite-score-v2.js');
                const v1Module = await import('./modules/onchain-indicators.js');
                
                const indicators = await v1Module.fetchAllIndicators();
                const v2Result = v2Module.calculateCompositeScoreV2(indicators);
                
                // Log consensus results
                Object.entries(v2Result.consensusSignals).forEach(([category, consensus]) => {
                    log(`üìä ${category}: ${consensus.consensus} (${consensus.confidence}% confidence)`, 'info');
                });
                
                // Check for contradictory signals
                const contradictions = v2Module.analyzeContradictorySignals(v2Result.categoryBreakdown);
                if (contradictions.length > 0) {
                    log(`‚ö†Ô∏è Found ${contradictions.length} contradictory signal(s)`, 'info');
                    contradictions.forEach(contradiction => {
                        log(`  ${contradiction.category1.name} (${contradiction.category1.signal}) vs ${contradiction.category2.name} (${contradiction.category2.signal})`, 'info');
                    });
                } else {
                    log('‚úÖ No contradictory signals detected', 'success');
                }
                
                log('‚úÖ Consensus voting test completed', 'success');
                
            } catch (error) {
                log(`‚ùå Consensus test failed: ${error.message}`, 'error');
            }
        };
        
        window.analyzeCachePerformance = async function() {
            log('‚ö° Analyzing cache performance...', 'info');
            
            try {
                const v1Module = await import('./modules/onchain-indicators.js');
                
                // Test multiple calls to see cache performance
                const start1 = performance.now();
                const result1 = await v1Module.fetchAllIndicators();
                const time1 = performance.now() - start1;
                
                const start2 = performance.now();
                const result2 = await v1Module.fetchAllIndicators();
                const time2 = performance.now() - start2;
                
                log(`üìä First call (fresh): ${time1.toFixed(0)}ms`, 'info');
                log(`üìä Second call (cached): ${time2.toFixed(0)}ms`, 'info');
                log(`‚ö° Cache speedup: ${(time1/time2).toFixed(1)}x faster`, 'success');
                
                if (time2 < 10) {
                    log('‚úÖ Cache is working efficiently (24h TTL)', 'success');
                } else {
                    log('‚ö†Ô∏è Cache might not be working as expected', 'info');
                }
                
            } catch (error) {
                log(`‚ùå Cache performance test failed: ${error.message}`, 'error');
            }
        };
        
        function displayComparison(v1Result, v2Result) {
            // V1 Results
            document.getElementById('v1-score').textContent = v1Result.score || 'N/A';
            
            let v1Html = `
                <div><strong>Confidence:</strong> ${Math.round((v1Result.confidence || 0) * 100)}%</div>
                <div><strong>Indicators:</strong> ${v1Result.totalIndicators || 0}</div>
                <div><strong>Critical:</strong> ${v1Result.criticalZoneCount || 0}</div>
            `;
            
            if (v1Result.categoryBreakdown) {
                v1Html += '<div class="category-breakdown"><h4>Categories:</h4>';
                Object.entries(v1Result.categoryBreakdown).forEach(([category, data]) => {
                    v1Html += `
                        <div class="category-item">
                            <span>${category}</span>
                            <span>${data.score}/100</span>
                        </div>
                    `;
                });
                v1Html += '</div>';
            }
            
            document.getElementById('v1-breakdown').innerHTML = v1Html;
            
            // V2 Results
            document.getElementById('v2-score').textContent = v2Result.score || 'N/A';
            
            let v2Html = `
                <div><strong>Confidence:</strong> ${Math.round((v2Result.confidence || 0) * 100)}%</div>
                <div><strong>Indicators:</strong> ${v2Result.totalIndicators || 0}</div>
                <div><strong>Critical:</strong> ${v2Result.criticalZoneCount || 0}</div>
            `;
            
            if (v2Result.categoryBreakdown) {
                v2Html += '<div class="category-breakdown"><h4>Categories V2:</h4>';
                Object.entries(v2Result.categoryBreakdown).forEach(([category, data]) => {
                    const consensus = data.consensus;
                    const consensusClass = consensus ? 
                        `consensus-${consensus.consensus}` : 'consensus-neutral';
                    
                    v2Html += `
                        <div class="category-item">
                            <span>${category} 
                                <span class="consensus-signal ${consensusClass}">${consensus?.consensus || 'neutral'}</span>
                            </span>
                            <span>${data.score}/100</span>
                        </div>
                    `;
                });
                v2Html += '</div>';
            }
            
            document.getElementById('v2-breakdown').innerHTML = v2Html;
        }
        
        function displayImprovements(v2Result) {
            const improvements = v2Result.improvements || [];
            const scoreDiff = v2Result.score - (document.getElementById('v1-score').textContent || 0);
            
            let html = `
                <div class="improvement-tag">Score difference: ${scoreDiff > 0 ? '+' : ''}${scoreDiff}</div>
            `;
            
            improvements.forEach(improvement => {
                html += `<div class="improvement-tag">${improvement}</div>`;
            });
            
            if (v2Result.correlationAnalysis) {
                html += '<h4>Correlation Reductions Applied:</h4>';
                Object.entries(v2Result.correlationAnalysis).forEach(([category, analysis]) => {
                    if (analysis.correlation_reduction) {
                        html += `
                            <div class="improvement-tag">
                                ${category}: ${analysis.original_count} ‚Üí ${analysis.reduced_count} indicators
                            </div>
                        `;
                    }
                });
            }
            
            document.getElementById('improvements-content').innerHTML = html;
        }
        
        function displayCorrelationAnalysis(correlationAnalysis, categoryBreakdown) {
            let html = '';
            
            Object.entries(correlationAnalysis).forEach(([category, analysis]) => {
                const categoryData = categoryBreakdown[category];
                
                html += `
                    <div class="correlation-analysis">
                        <h4>${category}</h4>
                        <p><strong>Original indicators:</strong> ${analysis.original_count}</p>
                        <p><strong>After correlation reduction:</strong> ${analysis.reduced_count}</p>
                        <p><strong>Weight adjustments:</strong> ${analysis.weight_adjustment}</p>
                        
                        ${categoryData && categoryData.consensus ? `
                            <p><strong>Consensus:</strong> 
                                <span class="consensus-signal consensus-${categoryData.consensus.consensus}">
                                    ${categoryData.consensus.consensus} (${categoryData.consensus.confidence}%)
                                </span>
                            </p>
                        ` : ''}
                    </div>
                `;
            });
            
            document.getElementById('correlation-content').innerHTML = html;
        }
        
        window.clearResults = function() {
            logElement.textContent = 'Log cleared...\n';
            document.getElementById('comparison-results').style.display = 'none';
            document.getElementById('improvements-panel').style.display = 'none';
            document.getElementById('correlation-panel').style.display = 'none';
        };
    </script>
</body>
</html>