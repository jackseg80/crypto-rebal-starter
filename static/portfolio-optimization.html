<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio Optimization - Crypto Portfolio</title>

  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">

  <script src="global-config.js"></script>
  <script src="appearance.js"></script>

  <!-- Navigation unifi√©e (conditionnelle) -->
  <script type="module">
    if (new URLSearchParams(window.location.search).get('nav') !== 'off') {
      import('./components/nav.js');
    }
  </script>

  <!-- Chart.js for visualizations -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
  <script type="module" src="components/tooltips.js"></script>

  <style>
    .wrap { max-width: 95vw; margin: 0 auto; padding: var(--space-lg); }

    .card {
      background: var(--theme-surface);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: .75rem;
      margin-top: .5rem;
    }

    .controls label {
      display: block;
      font-size: .9rem;
      color: var(--theme-text-muted);
      margin-bottom: .25rem;
    }

    .controls select,
    .controls input {
      width: 100%;
      padding: .5rem .6rem;
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-sm);
      background: var(--theme-surface);
      color: var(--theme-text);
    }

    .actions {
      margin-top: .75rem;
      display: flex;
      gap: .5rem;
    }

    .btn {
      background: var(--brand-primary);
      color: #fff;
      border: 0;
      padding: .5rem .8rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
    }

    .btn.secondary {
      background: var(--theme-surface);
      color: var(--theme-text);
      border: 1px solid var(--theme-border);
    }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: var(--space-lg); }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      text-align: left;
      padding: .5rem;
      border-bottom: 1px solid var(--theme-border);
    }

    th {
      color: var(--theme-text-muted);
      font-weight: 600;
    }

    .kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: .5rem;
      margin-top: .5rem;
    }

    .kpi {
      background: var(--theme-bg);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-md);
      padding: .6rem;
    }

    .kpi .label {
      color: var(--theme-text-muted);
      font-size: .85rem;
    }

    .kpi .value {
      font-weight: 700;
      font-size: 1.1rem;
    }

    .error {
      background: var(--danger-bg);
      color: var(--danger);
      border: 1px solid var(--danger);
      padding: .6rem;
      border-radius: var(--radius-sm);
    }
  </style>
  <script type="module" src="components/tooltips.js"></script>
</head>

<body>
  <script>
    // Clean accidental literal "\\n" artifacts in HTML text nodes (caused by a bad merge)
    document.addEventListener('DOMContentLoaded', () => {
      try {
        const skip = new Set(['SCRIPT', 'STYLE', 'CODE', 'PRE']);
        const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null);
        const nodes = [];
        let n;
        while ((n = walker.nextNode())) {
          if (n.parentElement && skip.has(n.parentElement.tagName)) continue;
          if (n.nodeValue && n.nodeValue.includes('\\n')) nodes.push(n);
        }
        nodes.forEach(t => { t.nodeValue = t.nodeValue.replace(/\\n/g, ''); });
      } catch (e) { /* noop */ }
    });
  </script>
  <div class="wrap">
    <div class="card">\n      <div class="card-header" style="border-bottom:1px solid var(--theme-border);">\n        <div class="card-title" style="display:flex; align-items:center; gap:.5rem;">üìê Portfolio Optimization</div>\n      </div>\n      <div class="card-content">\n      <div class="controls" id="controls">
        <div>
          <label for="objective">Objective</label>
          <select id="objective">
            <option value="max_sharpe">Max Sharpe</option>
            <option value="min_variance">Min Variance</option>
            <option value="max_return">Max Return</option>
            <option value="risk_parity">Risk Parity</option>
            <option value="risk_budgeting">Risk Budgeting</option>
          </select>
        </div>
        <div>
          <label for="lookback">Lookback (days)</label>
          <input id="lookback" type="number" min="30" max="2000" value="365" />
        </div>
        <div>
          <label for="source">Source</label>
          <select id="source">
            <option value="cointracking">CoinTracking CSV</option>
            <option value="cointracking_api">CoinTracking API</option>
            <option value="stub">Demo (stub)</option>
          </select>
        </div>
        <div>
          <label for="minusd">Min USD per asset</label>
          <input id="minusd" type="number" min="0" max="100000" step="10" value="100" />
        </div>
        <div>
          <label for="minhistory">Min history (days)</label>
          <input id="minhistory" type="number" min="30" max="1000" step="5" value="365" />
        </div>
      </div>

            <div class="actions">
        <button class="btn" id="runBtn">Optimiser</button>
        <button class="btn secondary" id="resetBtn">R√©initialiser</button>
        <span id="status" style="margin-left:auto; color: var(--theme-text-muted);"></span>
            </div>\n    </div>\n\n    <div class="grid" style="margin-top:1rem;">
      <div class="card">
        <div class="card-title" style="margin-bottom:.5rem;">Proposition d‚Äôallocation</div>
        <canvas id="weightsChart" height="200"></canvas>
        <table id="weightsTable" style="margin-top:.5rem;"></table>
      </div>
      <div class="card">
        <div class="card-title" style="margin-bottom:.5rem;">KPIs</div>
        <div class="kpis" id="kpis"></div>
        <div style="margin-top:.75rem;">
          <div class="card-title" style="margin-bottom:.25rem;">Trades de r√©√©√©quilibr√©ge</div>
          <table id="tradesTable"></table>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:1rem;">
      <div class="card-title" style="margin-bottom:.5rem; display:flex; align-items:center; gap:.5rem;">
        ‚ú® Propositions (sc√©narios)
        <button class="btn secondary" id="proposalsBtn" style="margin-left:auto;">G√©n√©rer des propositions</button>
      </div>
      <div id="proposalsInfo" style="color: var(--theme-text-muted); font-size:.9rem; margin-bottom:.5rem;">3 variantes:
        Conservateur, √â√©quilibr√©, Dynamique. Aucun bouton d‚Äôapplication ‚Äî affichage uniquement.</div>
      <div id="proposalsList" class="grid"
        style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:.75rem;"></div>
    </div>
  </div>

  <script>
    const API_BASE = (window.globalConfig && globalConfig.get('api_base_url')) || '';
    let weightsChart;

    function formatPct(x) { return (x * 100).toFixed(2) + '%'; }
    function formatPct0(x) { return (x * 100).toFixed(0) + '%'; }

    function setStatus(msg) { document.getElementById('status').textContent = msg || ''; }

    function renderWeights(weights) {
      const entries = Object.entries(weights || {}).sort((a, b) => b[1] - a[1]);
      const tbl = document.getElementById('weightsTable');
      tbl.innerHTML = '<tr><th>Actif</th><th>Poids</th></tr>' + entries.map(([s, w]) => `<tr><td>${s}</td><td>${formatPct(w)}</td></tr>`).join('');

      const ctx = document.getElementById('weightsChart');
      const labels = entries.map(e => e[0]);
      const data = entries.map(e => e[1] * 100);
      const colors = labels.map((_, i) => `hsl(${(i * 47) % 360} 70% 55%)`);
      if (weightsChart) weightsChart.destroy();
      weightsChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels, datasets: [{ data, backgroundColor: colors }] },
        options: { plugins: { legend: { position: 'bottom' } } }
      });
    }

    function renderKPIs(res) {
      const k = document.getElementById('kpis');
      const items = [
        { label: 'Expected Return', value: formatPct(res.expected_return) },
        { label: 'Volatility', value: formatPct(res.volatility) },
        { label: 'Sharpe Ratio', value: (res.sharpe_ratio ?? 0).toFixed(2) },
        { label: 'Diversification', value: (res.diversification_ratio ?? 0).toFixed(2) },
        { label: 'Score', value: (res.optimization_score ?? 0).toFixed(2) },
        { label: 'Constraints OK', value: res.constraints_satisfied ? '‚úÖ' : '‚ö†Ô∏è' }
      ];
      k.innerHTML = items.map(i => `<div class="kpi"><div class="label">${i.label}</div><div class="value">${i.value}</div></div>`).join('');
    }

    function renderTrades(trades) {
      const tbl = document.getElementById('tradesTable');
      if (!trades || !trades.length) { tbl.innerHTML = '<tr><td>Aucun trade requis</td></tr>'; return; }
      const rows = trades.map(t => {
        const cur = (typeof t.current_weight === 'number') ? t.current_weight : null;
        const tgt = (typeof t.target_weight === 'number') ? t.target_weight : null;
        const deltaField = (typeof t.delta === 'number') ? t.delta
                         : (typeof t.weight_change === 'number') ? t.weight_change
                         : (cur != null && tgt != null) ? (tgt - cur)
                         : 0;
        return `<tr>`+
          `<td>${t.symbol || t.asset || '-'}</td>`+
          `<td>${t.action || '-'}</td>`+
          `<td>${formatPct0(deltaField)}</td>`+
        `</tr>`;
      }).join('');
      tbl.innerHTML = '<tr><th>Actif</th><th>Action</th><th>Delta</th></tr>' + rows;
    }

    async function runOptimization() {
      try {
        setStatus('Optimisation en cours‚Ä¶');
        const objective = document.getElementById('objective').value;
        const lookback = parseInt(document.getElementById('lookback').value || '365', 10);
        const source = document.getElementById('source').value;
        const minusd = parseFloat(document.getElementById('minusd').value || '100');
        const minhistory = parseInt(document.getElementById('minhistory').value || '365', 10);

        const body = { objective, lookback_days: lookback, expected_return_method: 'mean_reversion', include_current_weights: true };
        const params = new URLSearchParams({ source, min_usd: String(minusd), min_history_days: String(minhistory) });
        const url = `${API_BASE}/api/portfolio/optimization/optimize?${params.toString()}`.replace(/\/+$/, '');

        const resp = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const res = await resp.json();
        if (!res.success) throw new Error(res.error || 'Optimization failed');

        renderWeights(res.weights);
        renderKPIs(res);
        renderTrades(res.rebalancing_trades || []);
        setStatus('‚úÖ Optimisation termin√©e');
      } catch (e) {
        console.error(e);
        setStatus('Erreur');
        const tbl = document.getElementById('weightsTable');
        tbl.innerHTML = `<tr><td><div class="error">${(e && e.message) || 'Erreur optimisation'}</div></td></tr>`;
      }
    }

    document.getElementById('runBtn').addEventListener('click', runOptimization);
    document.getElementById('resetBtn').addEventListener('click', () => {
      document.getElementById('objective').value = 'max_sharpe';
      document.getElementById('lookback').value = 365;
      document.getElementById('source').value = 'cointracking';
      document.getElementById('minusd').value = 100;
      document.getElementById('minhistory').value = 365;
      document.getElementById('weightsTable').innerHTML = '';
      document.getElementById('kpis').innerHTML = '';
      document.getElementById('tradesTable').innerHTML = '';
      if (weightsChart) { weightsChart.destroy(); weightsChart = null; }
      setStatus('');
    });

    // auto-run in demo
    document.addEventListener('DOMContentLoaded', () => {
      if (new URLSearchParams(location.search).get('autorun') === '1') runOptimization();
    });

    // --- Proposals (scenarios) ---
    function scenarioLabel(obj) {
      switch (obj) {
        case 'min_variance': return 'Conservateur';
        case 'max_sharpe': return '√â√©quilibr√©';
        case 'max_return': return 'Dynamique';
        default: return obj;
      }
    }

    function renderProposalCard(target, name, res) {
      const entries = Object.entries(res.weights || {}).sort((a, b) => b[1] - a[1]);
      const top = entries.slice(0, 5).map(([s, w]) => `<div style="display:flex; justify-content:space-between"><span>${s}</span><span>${formatPct(w)}</span></div>`).join('');
      target.innerHTML = `
        <div class="card">
          <div class="card-title" style="margin-bottom:.25rem;">${name}</div>
          <div class="kpis" style="margin:.25rem 0 .5rem 0; grid-template-columns: repeat(3, 1fr);">
            <div class="kpi"><div class="label">Sharpe</div><div class="value">${(res.sharpe_ratio ?? 0).toFixed(2)}</div></div>
            <div class="kpi"><div class="label">Ret.</div><div class="value">${formatPct(res.expected_return)}</div></div>
            <div class="kpi"><div class="label">Vol.</div><div class="value">${formatPct(res.volatility)}</div></div>
          </div>
          <div style="font-size:.9rem; color: var(--theme-text-muted); margin-bottom:.25rem;">Top 5</div>
          <div>${top || '<div style="color:var(--theme-text-muted)">Aucun</div>'}</div>
        </div>`;
    }

    async function runProposals() {
      const list = document.getElementById('proposalsList');
      list.innerHTML = '';
      const source = document.getElementById('source').value;
      const minusd = parseFloat(document.getElementById('minusd').value || '100');
      const minhistory = parseInt(document.getElementById('minhistory').value || '365', 10);
      const lookback = parseInt(document.getElementById('lookback').value || '365', 10);

      const scenarios = [
        { objective: 'min_variance', lookback_days: lookback },
        { objective: 'max_sharpe', lookback_days: lookback },
        { objective: 'max_return', lookback_days: lookback }
      ];

      for (const sc of scenarios) {
        const col = document.createElement('div');
        col.innerHTML = '<div class="card"><div class="card-title">' + scenarioLabel(sc.objective) + '</div><div style="color:var(--theme-text-muted);">Calcul‚Ä¶</div></div>';
        list.appendChild(col);
        try {
          const body = { objective: sc.objective, lookback_days: sc.lookback_days, expected_return_method: 'mean_reversion', include_current_weights: true };
          const params = new URLSearchParams({ source, min_usd: String(minusd), min_history_days: String(minhistory) });
          const url = `${API_BASE}/api/portfolio/optimization/optimize?${params.toString()}`;
          const resp = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const res = await resp.json();
          if (!res.success) throw new Error(res.error || 'Optimization failed');
          renderProposalCard(col, scenarioLabel(sc.objective), res);
        } catch (e) {
          col.innerHTML = `<div class="card"><div class="card-title">${scenarioLabel(sc.objective)}</div><div class="error">${(e && e.message) || 'Erreur'}</div></div>`;
        }
      }
    }

    document.getElementById('proposalsBtn').addEventListener('click', runProposals);
  </script>
</body>

</html>



