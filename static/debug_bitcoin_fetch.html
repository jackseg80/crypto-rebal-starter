<!DOCTYPE html>
<html>
<head>
  <title>Debug Bitcoin Fetch</title>
  <script src="global-config.js"></script>
</head>
<body>
  <h1>Debug fetchBitcoinHistoricalData</h1>
  <button onclick="testFetch()">Test Fetch</button>
  <div id="results"></div>

  <script>
    async function fetchBitcoinHistoricalData() {
      console.log('üèõÔ∏è Tentative de r√©cup√©ration historique Bitcoin...');
      
      // 1) FRED (CBBTCUSD) ‚Äî full-history 2014+, cl√© gratuite (CORS OK)
      const FRED_API_KEY = (window.globalConfig?.get?.('fred_api_key')) || '';
      console.log('üèõÔ∏è FRED API Key:', FRED_API_KEY ? 'Configur√©e (****)' : 'Non configur√©e');
      
      if (FRED_API_KEY) {
        try {
          console.log('üèõÔ∏è R√©cup√©ration historique Bitcoin depuis FRED API...');
          const url = `https://api.stlouisfed.org/fred/series/observations?series_id=CBBTCUSD&api_key=${encodeURIComponent(FRED_API_KEY)}&file_type=json&observation_start=2014-01-01&limit=100`;
          const r = await fetch(url, { mode: 'cors' });
          if (!r.ok) throw new Error(`FRED HTTP ${r.status}: ${r.statusText}`);
          const j = await r.json();
          if (Array.isArray(j.observations)) {
            const data = j.observations
              .filter(o => o.value !== '.' && o.value != null)
              .map(o => ({ time: new Date(o.date).getTime(), price: parseFloat(o.value) }))
              .filter(p => Number.isFinite(p.price));
            if (data.length > 0) {
              console.log(`‚úÖ FRED: ${data.length} points de donn√©es r√©cup√©r√©s (${data[0].price}$ √† ${data[data.length-1].price}$)`);
              return { data, source: 'FRED (CBBTCUSD)' };
            } else {
              console.warn('‚ö†Ô∏è FRED: Aucune donn√©e valide trouv√©e');
            }
          } else {
            console.warn('‚ö†Ô∏è FRED: Format de r√©ponse inattendu');
          }
        } catch (e) {
          console.warn('‚ùå FRED fetch √©chou√©, passage √† Binance:', e.message);
        }
      } else {
        console.log('‚ö™ FRED: Cl√© API non configur√©e, utilisation des alternatives');
      }

      // Fallback: Retourner donn√©es de test
      return {
        data: [
          { time: Date.now() - 365*24*60*60*1000, price: 50000 },
          { time: Date.now(), price: 100000 }
        ],
        source: 'Test data'
      };
    }

    async function testFetch() {
      const results = document.getElementById('results');
      results.innerHTML = '<p>Testing...</p>';
      
      try {
        const result = await fetchBitcoinHistoricalData();
        console.log('Result:', result);
        
        results.innerHTML = `
          <h3>‚úÖ Success!</h3>
          <p><strong>Source:</strong> ${result.source}</p>
          <p><strong>Data points:</strong> ${result.data.length}</p>
          <p><strong>Format:</strong> ${JSON.stringify(result.data[0])}</p>
          <p><strong>Sample data:</strong></p>
          <pre>${JSON.stringify(result.data.slice(0, 3), null, 2)}</pre>
        `;
      } catch (e) {
        console.error('Error:', e);
        results.innerHTML = `<h3>‚ùå Error: ${e.message}</h3>`;
      }
    }
  </script>
</body>
</html>