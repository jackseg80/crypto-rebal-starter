<!DOCTYPE html>
<html>
<head>
    <title>Debug Sources Direct</title>
</head>
<body>
    <h1>Debug Sources Direct</h1>
    <button onclick="testDirectCSV()">Test csv_0 Direct</button>
    <button onclick="testDirectAPI()">Test cointracking_api Direct</button>
    <button onclick="testGlobalConfigCSV()">Test Global Config csv_0</button>
    <button onclick="testGlobalConfigAPI()">Test Global Config API</button>
    <button onclick="setSourceCSV()">Set Source to csv_0</button>
    <button onclick="setSourceAPI()">Set Source to cointracking_api</button>
    <button onclick="checkCurrentConfig()">Check Current Config</button>

    <pre id="output"></pre>

    <script src="/static/global-config.js"></script>
    <script>
        function log(msg) {
            const output = document.getElementById('output');
            output.textContent += new Date().toLocaleTimeString() + ': ' + msg + '\n';
            console.log(msg);
        }

        async function testDirectCSV() {
            log('=== Test Direct CSV ===');
            try {
                const response = await fetch('/balances/current?source=csv_0', {
                    headers: { 'X-User': 'demo' }
                });
                const data = await response.json();
                log(`Direct CSV: ${data.items?.length || 0} items, source: ${data.source_used}`);
                if (data.items?.length > 0) {
                    log(`First item: ${data.items[0].symbol} - $${data.items[0].value_usd}`);
                }
            } catch (error) {
                log(`ERROR: ${error.message}`);
            }
        }

        async function testDirectAPI() {
            log('=== Test Direct API ===');
            try {
                const response = await fetch('/balances/current?source=cointracking_api', {
                    headers: { 'X-User': 'demo' }
                });
                const data = await response.json();
                log(`Direct API: ${data.items?.length || 0} items, source: ${data.source_used}`);
            } catch (error) {
                log(`ERROR: ${error.message}`);
            }
        }

        async function testGlobalConfigCSV() {
            log('=== Test Global Config CSV ===');
            try {
                globalConfig.set('data_source', 'csv_0');
                const data = await globalConfig.apiRequest('/balances/current', {
                    params: { source: 'csv_0' }
                });
                log(`Global Config CSV: ${data.items?.length || 0} items, source: ${data.source_used}`);
            } catch (error) {
                log(`ERROR: ${error.message}`);
            }
        }

        async function testGlobalConfigAPI() {
            log('=== Test Global Config API ===');
            try {
                globalConfig.set('data_source', 'cointracking_api');
                const data = await globalConfig.apiRequest('/balances/current', {
                    params: { source: 'cointracking_api' }
                });
                log(`Global Config API: ${data.items?.length || 0} items, source: ${data.source_used}`);
            } catch (error) {
                log(`ERROR: ${error.message}`);
            }
        }

        function setSourceCSV() {
            globalConfig.set('data_source', 'csv_0');
            localStorage.setItem('activeUser', 'demo');
            log('Set source to csv_0 and user to demo');
        }

        function setSourceAPI() {
            globalConfig.set('data_source', 'cointracking_api');
            localStorage.setItem('activeUser', 'demo');
            log('Set source to cointracking_api and user to demo');
        }

        function checkCurrentConfig() {
            log('=== Current Config ===');
            log(`Data source: ${globalConfig.get('data_source')}`);
            log(`API base: ${globalConfig.get('api_base_url')}`);
            log(`Active user: ${localStorage.getItem('activeUser')}`);
            log(`All settings: ${JSON.stringify(globalConfig.getAll())}`);
        }
    </script>
</body>
</html>