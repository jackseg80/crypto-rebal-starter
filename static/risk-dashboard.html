<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Risk Dashboard - Crypto Portfolio</title>

  <!-- Th√®me/compat identiques √† ta page actuelle -->
  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">

  <!-- Scripts partag√©s existants -->
  <script src="debug-logger.js"></script>
  <script src="global-config.js"></script>
  <script src="appearance.js"></script>
  <script src="lazy-loader.js"></script>

  <!-- Core modules ESM -->
  <script type="module" src="core/risk-dashboard-store.js"></script>
  <script type="module" src="core/risk-data-orchestrator.js"></script>  <!-- ‚úÖ SSOT hydration -->
  <script type="module" src="core/fetcher.js"></script>

  <!-- CCS modules ESM -->
  <script type="module" src="modules/signals-engine.js"></script>
  <script type="module" src="modules/cycle-navigator.js"></script>
  <script type="module" src="modules/targets-coordinator.js"></script>
  <script type="module" src="modules/onchain-indicators.js"></script>
  <script type="module" src="modules/market-regimes.js"></script>

  <!-- Unified asset groups system -->
  <script type="module" src="shared-asset-groups.js"></script>

  <!-- Risk v2 uses API instead of local modules -->

  <!-- Chart.js will be lazy-loaded when needed -->

  <!-- Risk Dashboard CSS -->
  <link rel="stylesheet" href="css/risk-dashboard.css">

  <!-- Navigation unifi√©e (conditionnelle) -->
  <script type="module">
    if (new URLSearchParams(window.location.search).get('nav') !== 'off') {
      import('./components/nav.js');
    }
  </script>
  <script type="module" src="components/tooltips.js"></script>

  <!-- Risk Dashboard Orchestrator -->
  <script type="module" src="modules/risk-dashboard-main.js"></script>
</head>

<body>
  <div id="backend-fallback-banner"
    style="display:none; background: color-mix(in oklab, var(--warning) 20%, transparent); border: 1px solid var(--warning); color: var(--theme-text); padding: .6rem; margin: .5rem auto; max-width: 95vw; border-radius: 6px;">
    ‚ö† Backend indisponible ‚Äî mode prudent (cap r√©duit).
  </div>

  <div class="wrap">
    <!-- Compact Header Controls -->
    <div class="page-header">
      <div class="page-title">
        <h1>Risk Dashboard</h1>
      </div>
      <div class="header-controls">
        <div class="timestamp" id="last-update">Loading...</div>
        <button class="icon-btn" id="refresh-btn" title="Refresh data" aria-label="Refresh data">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M13.65 2.35C12.2 0.9 10.21 0 8 0 3.58 0 0.01 3.58 0.01 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L9 7h7V0l-2.35 2.35z" fill="currentColor"/>
          </svg>
        </button>
        <div class="dropdown">
          <button class="icon-btn" id="options-menu-btn" title="Options" aria-label="More options" aria-haspopup="true" aria-expanded="false">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="8" cy="3" r="1.5" fill="currentColor"/>
              <circle cx="8" cy="8" r="1.5" fill="currentColor"/>
              <circle cx="8" cy="13" r="1.5" fill="currentColor"/>
            </svg>
          </button>
          <div class="dropdown-menu" id="options-menu">
            <button class="dropdown-item" id="force-refresh-btn" title="Clear cache and recalculate all scores">
              <span class="item-icon">üßπ</span>
              <span class="item-text">Force Refresh</span>
            </button>
            <button class="dropdown-item" id="force-cycle-refresh-btn" title="Clear cycle cache and reload cycles only">
              <span class="item-icon">üîÑ</span>
              <span class="item-text">Refresh Cycles</span>
            </button>
            <div class="dropdown-divider"></div>
            <button class="dropdown-item" id="test-endpoint-btn" title="Test API connection (dev only)">
              <span class="item-icon">üß™</span>
              <span class="item-text">Test API</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Layout Simple: Main Content uniquement (sidebar remplac√©e par Web Component flyout-panel) -->
    <div class="dashboard-layout">
      <!-- Main Content avec Onglets -->
      <div class="main-content">
        <div class="tabs" role="tablist">
          <button class="tab-button active" data-tab="risk" onclick="switchTab('risk')" role="tab" aria-selected="true" aria-controls="risk-tab">Risk Overview</button>
          <button class="tab-button" data-tab="cycles" onclick="switchTab('cycles')" role="tab" aria-selected="false" aria-controls="cycles-tab">Market Cycles</button>
          <button class="tab-button" data-tab="targets" onclick="switchTab('targets')" role="tab" aria-selected="false" aria-controls="targets-tab">Strategic Targets</button>
          <button class="tab-button" data-tab="alerts" onclick="switchTab('alerts')" role="tab" aria-selected="false" aria-controls="alerts-tab">Alerts History</button>
        </div>

        <div class="tab-content">
          <!-- Risk Overview Tab -->
          <div class="tab-pane active" id="risk-tab" role="tabpanel" aria-labelledby="risk-overview">
            <div id="risk-overview-badge-container" style="float: right; margin-bottom: 1rem;"></div>

            <!-- Persistent Controls (do not get replaced by dynamic render) -->
            <div id="risk-dashboard-content">
              <div class="loading">Loading risk metrics...</div>
            </div>
          </div>

          <!-- Market Cycles Tab -->
          <div class="tab-pane" id="cycles-tab" role="tabpanel" aria-labelledby="cycles">
            <div id="cycles-badge-container" style="float: right; margin-bottom: 1rem;"></div>
            <div id="cycles-content">
              <div class="loading">Loading cycle analysis...</div>
            </div>
          </div>

          <!-- Strategic Targets Tab -->
          <div class="tab-pane" id="targets-tab" role="tabpanel" aria-labelledby="targets">
            <div id="targets-badge-container" style="float: right; margin-bottom: 1rem;"></div>
            <div id="targets-content">
              <div class="loading">Loading strategic targets...</div>
            </div>
          </div>

          <!-- Alerts History Tab -->
          <div class="tab-pane" id="alerts-tab" role="tabpanel" aria-labelledby="alerts">
            <div id="alerts-content">
              <div class="alerts-header">
                <h3>üö® Alerts History</h3>
                <div class="alerts-controls">
                  <select id="alerts-severity-filter" onchange="filterAlertsHistory()">
                    <option value="" selected>All Severities</option>
                    <option value="S1">S1 - Info</option>
                    <option value="S2">S2 - Warning</option>
                    <option value="S3">S3 - Critical</option>
                  </select>
                  <select id="alerts-type-filter" onchange="filterAlertsHistory()">
                    <option value="" selected>All Types</option>
                    <option value="VOL_Q90_CROSS">High Volatility</option>
                    <option value="REGIME_FLIP">Regime Change</option>
                    <option value="CORR_HIGH">High Correlation</option>
                    <option value="CONTRADICTION_SPIKE">ML Contradiction</option>
                    <option value="DECISION_DROP">Low Confidence</option>
                    <option value="EXEC_COST_SPIKE">High Exec Cost</option>
                  </select>
                  <select id="alerts-period-filter" onchange="filterAlertsHistory()">
                    <option value="7">Last 7 days</option>
                    <option value="30">Last 30 days</option>
                    <option value="90">Last 90 days</option>
                  </select>
                  <button class="refresh-btn" onclick="refreshAlertsHistory()">Refresh</button>
                </div>
              </div>

              <div id="alerts-history-content">
                <div class="loading">Loading alerts history...</div>
              </div>

              <div class="alerts-pagination" id="alerts-pagination" style="display: none;">
                <button id="alerts-prev-btn" onclick="loadPreviousAlertsPage()" disabled>Previous</button>
                <span id="alerts-page-info">Page 1 of 1</span>
                <button id="alerts-next-btn" onclick="loadNextAlertsPage()" disabled>Next</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tooltip partag√© -->
  <div id="tooltip" class="tooltip" aria-hidden="true" role="tooltip">
    <div class="tip-title"></div>
    <div class="tip-body"></div>
  </div>

  <script type="module" src="modules/risk-dashboard-main-controller.js"></script>

  <script type="module" src="modules/risk-dashboard-alerts-controller.js"></script>

  <!-- PHASE 2A: Toast Container -->
  <div id="toast-container">
    <!-- Toasts will appear here -->
  </div>

  <!-- Fixed button outside toast container -->
  <div id="toast-buttons" style="position: fixed; bottom: 20px; right: 20px; z-index: 3000; pointer-events: auto;">
    <button onclick="hideAllToasts()" style="
      background: var(--danger); 
      color: white; 
      border: none; 
      padding: 8px 16px; 
      border-radius: var(--radius-md); 
      cursor: pointer;
      font-size: 0.875rem;
      box-shadow: var(--shadow-md);
      pointer-events: auto;
    ">üóëÔ∏è Clear All Alerts</button>
  </div>

  <!-- PHASE 2A: Alert Detail Modal -->
  <div class="modal-overlay" id="alert-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title">
          <span class="modal-severity-badge" id="modal-severity-badge">S3</span>
          <span id="modal-alert-type">VOL_Q90_CROSS</span>
        </h2>
        <button class="modal-close" onclick="closeAlertModal()">&times;</button>
      </div>

      <div class="modal-body">
        <!-- Alert Overview -->
        <div class="modal-section">
          <div class="modal-section-title">Alert Overview</div>
          <div class="alert-metadata" id="alert-overview">
            <div class="metadata-item">
              <span class="metadata-label">Alert ID</span>
              <span class="metadata-value" id="modal-alert-id">-</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Created</span>
              <span class="metadata-value" id="modal-created-at">-</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Current Value</span>
              <span class="metadata-value" id="modal-current-value">-</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Threshold</span>
              <span class="metadata-value" id="modal-threshold">-</span>
            </div>
          </div>
        </div>

        <!-- ML Signals Snapshot -->
        <div class="modal-section">
          <div class="modal-section-title">ML Signals Snapshot</div>
          <div class="signals-grid" id="signals-snapshot">
            <!-- Dynamic signal cards will be inserted here -->
          </div>
        </div>

        <!-- Suggested Action -->
        <div class="modal-section">
          <div class="modal-section-title">Suggested Action</div>
          <div class="suggested-action" id="suggested-action">
            <div class="action-type" id="action-type">Apply Policy</div>
            <div class="action-details" id="action-details">Mode: Slow, Cap Daily: 4%, Ramp Hours: 24</div>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="modal-action modal-action-secondary" onclick="closeAlertModal()">Close</button>
        <button class="modal-action modal-action-secondary" onclick="snoozeCurrentAlert()" id="snooze-btn">Snooze
          30m</button>
        <button class="modal-action modal-action-primary" onclick="acknowledgeCurrentAlert()"
          id="ack-btn">Acknowledge</button>
        <button class="modal-action modal-action-danger" onclick="applyAction()" id="apply-btn"
          style="display:none;">Apply Action</button>
      </div>
    </div>
  </div>

  <!-- Bitcoin Cycle Chart Lazy Loading Component -->
  <script>
    // Composant pour le chargement lazy de Chart.js et du graphique Bitcoin Cycle
    class BitcoinCycleChart {
      constructor(element) {
        debugLogger.debug('üîß BitcoinCycleChart constructor called with element:', element);
        this.element = element;
        this.chartLoaded = false;
        this.placeholder = element.querySelector('.chart-lazy-placeholder');
        this.canvas = element.querySelector('#bitcoin-cycle-chart');
        debugLogger.debug('üîç Placeholder found:', !!this.placeholder, 'Canvas found:', !!this.canvas);
      }

      async init() {
        debugLogger.debug('üöÄ BitcoinCycleChart init() called');

        // Guard: prevent re-initialization
        if (this.chartLoaded) {
          console.debug('‚ö° Chart already loaded, skipping re-initialization');
          return;
        }

        try {
          // Afficher un indicateur de chargement
          if (this.placeholder) {
            debugLogger.debug('‚úÖ Showing loading indicator');
            this.placeholder.innerHTML = `
              <div style="text-align: center;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìä</div>
                <div>Chargement de Chart.js...</div>
                <div class="lazy-loading" style="margin-top: 1rem;"></div>
              </div>
            `;
          } else {
            debugLogger.warn('‚ö†Ô∏è No placeholder found for loading indicator');
          }

          // Charger Chart.js de mani√®re asynchrone
          debugLogger.debug('üìä Starting to load Chart.js...');
          await this.loadChartJS();
          debugLogger.debug('‚úÖ Chart.js loaded successfully');

          // Masquer le placeholder et afficher le canvas
          debugLogger.debug('üîÑ Switching from placeholder to canvas...');
          if (this.placeholder) {
            this.placeholder.style.display = 'none';
            debugLogger.debug('‚úÖ Placeholder hidden');
          }
          if (this.canvas) {
            this.canvas.style.display = 'block';
            debugLogger.debug('‚úÖ Canvas shown');
          } else {
            debugLogger.warn('‚ö†Ô∏è No canvas found to show');
          }

          // Cr√©er le graphique Bitcoin Cycle
          if (typeof createBitcoinCycleChart === 'function') {
            debugLogger.debug('üìä Calling createBitcoinCycleChart...');
            await createBitcoinCycleChart('bitcoin-cycle-chart');
            debugLogger.debug('‚úÖ createBitcoinCycleChart completed');
          } else {
            debugLogger.error('‚ùå createBitcoinCycleChart function not found');
          }

          this.chartLoaded = true;
          debugLogger.debug('‚úÖ Bitcoin Cycle Chart loaded successfully via lazy loading');

        } catch (error) {
          debugLogger.error('‚ùå Failed to lazy load Bitcoin Cycle Chart:', error);

          // Afficher l'erreur dans le placeholder
          if (this.placeholder) {
            this.placeholder.innerHTML = `
              <div style="text-align: center; color: var(--theme-error, #dc3545);">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</div>
                <div>Erreur lors du chargement du graphique</div>
                <div style="font-size: 0.8rem; margin-top: 0.5rem;">${error.message}</div>
              </div>
            `;
          }
        }
      }

      async loadChartJS() {
        // V√©rifier si Chart.js est d√©j√† charg√©
        if (window.Chart) {
          debugLogger.debug('üìä Chart.js already loaded');
          return Promise.resolve();
        }

        debugLogger.debug('üìä Loading Chart.js...');

        // Charger Chart.js principal
        const chartPromise = new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js';
          script.onload = resolve;
          script.onerror = () => reject(new Error('Failed to load Chart.js'));
          document.head.appendChild(script);
        });

        await chartPromise;

        // Charger l'adaptateur de dates
        const adapterPromise = new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js';
          script.onload = resolve;
          script.onerror = () => reject(new Error('Failed to load Chart.js date adapter'));
          document.head.appendChild(script);
        });

        await adapterPromise;

        // Petit d√©lai pour s'assurer que Chart.js est disponible
        await new Promise(resolve => setTimeout(resolve, 100));

        if (!window.Chart) {
          throw new Error('Chart.js failed to initialize');
        }

        debugLogger.debug('‚úÖ Chart.js loaded successfully');
      }
    }

    // Enregistrer le composant globalement pour le lazy loader
    window.BitcoinCycleChart = BitcoinCycleChart;
  </script>

  <!-- Flyout Panel System -->
  <!-- Risk Dashboard CSS -->
  <link rel="stylesheet" href="css/risk-dashboard.css">

  <!-- Unified Risk Flyout Panel (Full Sidebar) -->
  <script type="module" src="components/flyout-panel.js"></script>
  <script type="module" src="components/risk-sidebar-full.js"></script>
  <script type="module">
    // Adapter le layout quand la sidebar est √©pingl√©e
    import { enableFlyoutLayoutAdapter } from './components/flyout-layout-adapter.js';
    enableFlyoutLayoutAdapter('.wrap'); // D√©caler uniquement le contenu, pas le menu
  </script>

  <flyout-panel position="left" width="280" persist-key="risk_dashboard_flyout" pinned>
    <span slot="title">üéØ Risk Dashboard</span>
    <risk-sidebar-full slot="content" poll-ms="0"></risk-sidebar-full>
  </flyout-panel>

</body>

</html><!-- Cache bust: 1759493016 -->
