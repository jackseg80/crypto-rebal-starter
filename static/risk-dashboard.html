<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Risk Dashboard - Crypto Portfolio</title>

  <!-- Th√®me/compat identiques √† ta page actuelle -->
  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">

  <!-- Scripts partag√©s existants -->
  <script src="global-config.js"></script>
  <script src="shared-header.js"></script>
  <script src="appearance.js"></script>
  
  <!-- Core modules ESM -->
  <script type="module" src="core/risk-dashboard-store.js"></script>
  <script type="module" src="core/fetcher.js"></script>
  
  <!-- CCS modules ESM -->
  <script type="module" src="modules/signals-engine.js"></script>
  <script type="module" src="modules/cycle-navigator.js"></script>

  <style>
    /* ===== Layout Hybride: Sidebar + Main ===== */
    .dashboard-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: var(--space-lg);
      min-height: calc(100vh - 200px);
    }

    .sidebar {
      background: var(--theme-surface);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      box-shadow: var(--shadow-sm);
      position: sticky;
      top: var(--space-lg);
      max-height: calc(100vh - 120px);
      overflow-y: auto;
    }

    .main-content {
      background: var(--theme-surface);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
    }

    /* ===== Sidebar Components ===== */
    .sidebar-section {
      margin-bottom: var(--space-xl);
    }

    .sidebar-section:last-child {
      margin-bottom: 0;
    }

    .sidebar-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--theme-text-muted);
      margin-bottom: var(--space-sm);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .ccs-gauge {
      text-align: center;
      padding: var(--space-lg);
      background: var(--theme-bg);
      border-radius: var(--radius-md);
      border: 2px solid var(--brand-primary);
    }

    .ccs-score {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--brand-primary);
      line-height: 1;
      margin-bottom: var(--space-xs);
    }

    .ccs-label {
      font-size: 0.75rem;
      color: var(--theme-text-muted);
      font-weight: 500;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      padding: var(--space-sm);
      background: var(--theme-bg);
      border-radius: var(--radius-sm);
      margin-bottom: var(--space-sm);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--theme-text-muted);
    }

    .status-dot.healthy { background: var(--success); }
    .status-dot.warning { background: var(--warning); }
    .status-dot.error { background: var(--danger); }

    .status-text {
      font-size: 0.75rem;
      color: var(--theme-text-muted);
    }

    /* ===== Onglets ===== */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--theme-border);
      background: var(--theme-bg);
    }

    .tab-button {
      flex: 1;
      padding: var(--space-lg);
      background: none;
      border: none;
      color: var(--theme-text-muted);
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-normal);
      border-bottom: 3px solid transparent;
    }

    .tab-button:hover {
      color: var(--theme-text);
      background: var(--theme-surface);
    }

    .tab-button.active {
      color: var(--brand-primary);
      border-bottom-color: var(--brand-primary);
      background: var(--theme-surface);
    }

    .tab-content {
      padding: var(--space-xl);
      min-height: 400px;
    }

    .tab-pane {
      display: none;
    }

    .tab-pane.active {
      display: block;
    }

    /* ===== Risk Components (existants) ===== */
    .risk-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: var(--space-lg);
      margin: var(--space-lg) 0;
    }

    .risk-card {
      background: var(--theme-surface);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-lg);
      padding: var(--space-xl);
      box-shadow: var(--shadow-sm);
      transition: all var(--transition-normal);
    }

    .risk-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .risk-card h3 {
      margin-top: 0;
      color: var(--theme-text);
      border-bottom: 2px solid var(--brand-primary);
      padding-bottom: var(--space-sm);
      font-size: 1.25rem;
      font-weight: 600;
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-sm) 0;
      border-bottom: 1px solid var(--theme-border);
    }

    .metric-label {
      font-weight: 500;
      color: var(--theme-text-muted);
      font-size: 0.875rem;
    }

    .metric-value {
      font-weight: 600;
      font-family: 'Monaco', 'Consolas', monospace;
      color: var(--theme-text);
    }

    .risk-level {
      display: inline-block;
      padding: 0.375rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .05em;
    }

    .risk-low {
      background: var(--success-bg);
      color: var(--success)
    }

    .risk-medium {
      background: var(--warning-bg);
      color: var(--warning)
    }

    .risk-high,
    .risk-very-high {
      background: var(--danger-bg);
      color: var(--danger)
    }

    .risk-critical {
      background: var(--danger);
      color: #fff
    }

    .alert {
      padding: var(--space-lg);
      margin: var(--space-sm) 0;
      border-radius: var(--radius-md);
      border-left: 4px solid;
    }

    .alert-high {
      background: var(--danger-bg);
      color: var(--danger);
      border-color: var(--danger)
    }

    .alert-medium {
      background: var(--warning-bg);
      color: var(--warning);
      border-color: var(--warning)
    }

    .alert-low {
      background: var(--info-bg);
      color: var(--info);
      border-color: var(--info)
    }

    .correlation-heatmap {
      width: 100%;
      height: 300px;
      background: var(--theme-surface);
      border: 1px solid var(--theme-border);
      border-radius: 4px;
      overflow-x: auto;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--theme-text-muted);
    }

    .error {
      background: var(--danger-bg);
      color: var(--danger);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid var(--danger);
    }

    .refresh-btn {
      background: var(--brand-primary);
      color: #fff;
      border: 0;
      padding: .75rem 1.5rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: .875rem;
      font-weight: 500;
      margin: var(--space-sm);
      transition: all var(--transition-normal);
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .refresh-btn:hover:not(:disabled) {
      background: var(--brand-primary-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .refresh-btn:disabled {
      background: var(--theme-border);
      cursor: not-allowed;
      opacity: .5
    }

    .timestamp {
      font-size: .75rem;
      color: var(--theme-text-muted);
      text-align: right;
      margin-bottom: var(--space-sm)
    }

    .controls {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      margin: var(--space-lg) 0;
      flex-wrap: wrap
    }

    /* ===== Tooltip (l√©ger, autonome) ===== */
    .tooltip {
      position: fixed;
      z-index: 9999;
      min-width: 260px;
      max-width: 360px;
      pointer-events: none;
      background: #0e1528;
      color: #e9f0ff;
      border: 1px solid #243355;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
      padding: 10px 12px;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity .12s ease, transform .12s ease;
    }

    .tooltip.show {
      opacity: 1;
      transform: translateY(0)
    }

    .tooltip .tip-title {
      font-weight: 700;
      margin-bottom: 6px;
      color: #d7e6ff
    }

    .tooltip .tip-body {
      white-space: pre-line;
      color: #c6d6f3;
      font-size: 13px
    }

    /* Indication de survol explicatif */
    .hinted {
      cursor: help;
      text-decoration: underline dotted;
      text-underline-offset: 2px;
    }
  </style>
</head>

<body>
  <div id="shared-header"></div>

  <div class="container">
    <!-- Controls Header -->
    <div class="controls">
      <button class="refresh-btn" onclick="refreshDashboard()" id="refresh-btn">üîÑ Refresh Data</button>
      <button class="refresh-btn" onclick="enableAutoRefresh()" id="auto-refresh-btn">‚è±Ô∏è Enable Auto-Refresh (30s)</button>
      <button class="refresh-btn" onclick="testEndpoint()" style="background:#007bff">üß™ Test API</button>
      <div class="timestamp" id="last-update"></div>
    </div>

    <!-- Layout Hybride: Sidebar + Main -->
    <div class="dashboard-layout">
      <!-- Sidebar Fixe -->
      <div class="sidebar">
        <!-- CCS Gauge -->
        <div class="sidebar-section">
          <div class="sidebar-title">Market Score CCS</div>
          <div class="ccs-gauge" id="ccs-gauge">
            <div class="ccs-score" id="ccs-score">--</div>
            <div class="ccs-label">Loading...</div>
          </div>
        </div>

        <!-- Cycle Indicator -->
        <div class="sidebar-section">
          <div class="sidebar-title">Cycle Position</div>
          <div id="cycle-indicator">
            <div class="status-indicator">
              <div class="status-dot" id="cycle-dot"></div>
              <div class="status-text" id="cycle-text">Loading cycle data...</div>
            </div>
          </div>
        </div>

        <!-- Targets Summary -->
        <div class="sidebar-section">
          <div class="sidebar-title">Target Changes</div>
          <div id="targets-summary">
            <div class="status-text">No changes proposed</div>
          </div>
        </div>

        <!-- API Status -->
        <div class="sidebar-section">
          <div class="sidebar-title">API Health</div>
          <div id="api-status">
            <div class="status-indicator">
              <div class="status-dot" id="backend-dot"></div>
              <div class="status-text">Backend API</div>
            </div>
            <div class="status-indicator">
              <div class="status-dot" id="signals-dot"></div>
              <div class="status-text">Market Signals</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content avec Onglets -->
      <div class="main-content">
        <div class="tabs">
          <button class="tab-button active" data-tab="risk" onclick="switchTab('risk')">Risk Overview</button>
          <button class="tab-button" data-tab="cycles" onclick="switchTab('cycles')">Market Cycles</button>
          <button class="tab-button" data-tab="targets" onclick="switchTab('targets')">Strategic Targets</button>
        </div>

        <div class="tab-content">
          <!-- Risk Overview Tab -->
          <div class="tab-pane active" id="risk-tab">
            <div id="risk-dashboard-content">
              <div class="loading">Loading risk metrics...</div>
            </div>
          </div>

          <!-- Market Cycles Tab -->
          <div class="tab-pane" id="cycles-tab">
            <div id="cycles-content">
              <div class="loading">Loading cycle analysis...</div>
            </div>
          </div>

          <!-- Strategic Targets Tab -->
          <div class="tab-pane" id="targets-tab">
            <div id="targets-content">
              <h3>üéØ Strategic Targets</h3>
              <p>Target management will be implemented here...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tooltip partag√© -->
  <div id="tooltip" class="tooltip" aria-hidden="true" role="tooltip">
    <div class="tip-title"></div>
    <div class="tip-body"></div>
  </div>

  <script type="module">
    // Import core modules
    import { store } from './core/risk-dashboard-store.js';
    import { fetchCached } from './core/fetcher.js';
    
    // Import CCS modules
    import { fetchAndComputeCCS, interpretCCS, DEFAULT_CCS_WEIGHTS } from './modules/signals-engine.js';
    import { estimateCyclePosition, blendCCS, getCyclePhase } from './modules/cycle-navigator.js';

    // Global state
    let autoRefreshInterval = null;
    let isRefreshing = false;

    // ====== Tab Management ======
    window.switchTab = function(tabName) {
      // Update UI state
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
      
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');
      
      // Update store
      store.set('ui.activeTab', tabName);
      
      // Render content based on active tab
      switch (tabName) {
        case 'risk':
          // Risk content is already rendered by refreshDashboard
          break;
        case 'cycles':
          renderCyclesContent();
          break;
        case 'targets':
          // TODO: renderTargetsContent();
          document.getElementById('targets-content').innerHTML = '<h3>üéØ Strategic Targets</h3><p>Target management coming soon...</p>';
          break;
      }
      
      console.log(`Switched to tab: ${tabName}`);
    };

    // ====== Tooltip helpers ======
    const $tip = document.getElementById('tooltip');
    const $tipTitle = $tip?.querySelector('.tip-title');
    const $tipBody = $tip?.querySelector('.tip-body');
    
    function showTip(title, body, x, y) { 
      if (!$tip) return; 
      $tipTitle.textContent = title || ''; 
      $tipBody.textContent = body || ''; 
      $tip.style.left = x + 'px'; 
      $tip.style.top = y + 'px'; 
      $tip.classList.add('show'); 
      $tip.setAttribute('aria-hidden', 'false'); 
    }
    
    function moveTip(x, y) { 
      if (!$tip) return; 
      $tip.style.left = x + 'px'; 
      $tip.style.top = y + 'px'; 
    }
    
    function hideTip() { 
      if (!$tip) return; 
      $tip.classList.remove('show'); 
      $tip.setAttribute('aria-hidden', 'true'); 
    }
    
    function attachTip(el, title, body) { 
      if (!el) return; 
      el.addEventListener('mouseenter', e => showTip(title, body, e.clientX, e.clientY)); 
      el.addEventListener('mousemove', e => moveTip(e.clientX, e.clientY)); 
      el.addEventListener('mouseleave', hideTip); 
      el.classList.add('hinted'); 
    }

    // ====== Formatters ======
    const pct = v => (v == null || isNaN(v) ? 'N/A' : (v * 100).toFixed(2) + '%');
    const num = v => (v == null || isNaN(v) ? 'N/A' : Number(v).toFixed(2));
    
    // ====== API Functions ======
    async function fetchRiskData() {
      return fetchCached(
        'risk-dashboard',
        () => fetch('http://localhost:8000/api/risk/dashboard?source=cointracking&pricing=local&min_usd=1.00')
          .then(r => {
            if (!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
            return r.json();
          }),
        'risk'
      );
    }
    
    // ====== CCS Functions ======
    async function loadCCSData() {
      try {
        console.log('Loading CCS data...');
        
        // Fetch CCS and cycle data in parallel
        const [ccsResult, cycleData] = await Promise.all([
          fetchAndComputeCCS(DEFAULT_CCS_WEIGHTS),
          estimateCyclePosition()
        ]);
        
        // Update store with CCS data
        store.set('ccs.score', ccsResult.score);
        store.set('ccs.signals', ccsResult.signals);
        store.set('ccs.weights', ccsResult.weights);
        store.set('ccs.lastUpdate', new Date().toISOString());
        store.set('ccs.model_version', ccsResult.model_version);
        
        // Update store with cycle data
        store.set('cycle.months', cycleData.months);
        store.set('cycle.phase', cycleData.phase);
        store.set('cycle.score', cycleData.score);
        store.set('cycle.confidence', cycleData.confidence);
        store.set('cycle.multipliers', cycleData.multipliers);
        
        // Update API status
        store.set('ui.apiStatus.signals', 'healthy');
        
        console.log(`CCS loaded: ${ccsResult.score}, Cycle: ${cycleData.phase.phase} (${Math.round(cycleData.months)}m)`);
        
        return { ccs: ccsResult, cycle: cycleData };
        
      } catch (error) {
        console.error('Failed to load CCS data:', error);
        store.set('ui.apiStatus.signals', 'error');
        throw error;
      }
    }
    
    async function loadBlendedCCS() {
      try {
        const state = store.snapshot();
        const ccsScore = state.ccs?.score;
        const cycleMonths = state.cycle?.months;
        const cycleWeight = state.cycle?.weight || 0.3;
        
        if (ccsScore && cycleMonths) {
          const blended = blendCCS(ccsScore, cycleMonths, cycleWeight);
          store.set('cycle.ccsStar', blended.blendedCCS);
          return blended;
        }
        
        return null;
      } catch (error) {
        console.error('Failed to blend CCS:', error);
        return null;
      }
    }
    
    // ====== Sidebar Updates ======
    function updateSidebar(state) {
      // Update CCS gauge
      const ccsScore = state.ccs?.score;
      const ccsScoreEl = document.getElementById('ccs-score');
      const ccsLabelEl = ccsScoreEl?.nextElementSibling;
      
      if (ccsScore !== null && ccsScore !== undefined) {
        ccsScoreEl.textContent = Math.round(ccsScore);
        
        // Interpret CCS for color coding
        const interpretation = interpretCCS(ccsScore);
        ccsScoreEl.style.color = interpretation.color;
        ccsLabelEl.textContent = `${interpretation.label} (${new Date().toLocaleTimeString()})`;
      } else {
        ccsScoreEl.textContent = '--';
        ccsScoreEl.style.color = 'var(--brand-primary)';
        ccsLabelEl.textContent = 'Loading...';
      }
      
      // Update API status
      const backendDot = document.getElementById('backend-dot');
      const signalsDot = document.getElementById('signals-dot');
      
      if (backendDot) {
        backendDot.className = `status-dot ${state.ui?.apiStatus?.backend || 'unknown'}`;
      }
      if (signalsDot) {
        signalsDot.className = `status-dot ${state.ui?.apiStatus?.signals || 'unknown'}`;
      }
      
      // Update cycle indicator with enhanced info
      const cycleText = document.getElementById('cycle-text');
      const cycleDot = document.getElementById('cycle-dot');
      
      if (state.cycle?.months && state.cycle?.phase) {
        const months = Math.round(state.cycle.months);
        const phase = state.cycle.phase;
        
        cycleText.innerHTML = `
          <div style="font-size: 11px; font-weight: 600;">${phase.emoji} ${phase.phase.replace('_', ' ').toUpperCase()}</div>
          <div style="font-size: 10px; opacity: 0.8;">Month ${months} post-halving</div>
        `;
        
        // Color based on phase
        cycleDot.style.backgroundColor = phase.color;
        cycleDot.className = 'status-dot';
      } else {
        cycleText.textContent = 'Loading cycle data...';
        cycleDot.className = 'status-dot';
      }
      
      // Update targets summary placeholder
      const targetsSummary = document.getElementById('targets-summary');
      if (targetsSummary) {
        const ccsStar = state.cycle?.ccsStar;
        if (ccsStar && ccsScore) {
          targetsSummary.innerHTML = `
            <div style="font-size: 11px;">
              <div>CCS: ${Math.round(ccsScore)} ‚Üí ${Math.round(ccsStar)} (blended)</div>
              <div style="font-size: 10px; opacity: 0.8; margin-top: 2px;">Cycle weight: ${Math.round((state.cycle?.weight || 0.3) * 100)}%</div>
            </div>
          `;
        } else {
          targetsSummary.innerHTML = '<div class="status-text">Loading targets...</div>';
        }
      }
    }

    function rate(key, value) {
      const r = RISK_RULES[key]; if (!r || value == null || isNaN(value)) return { dot: 'orange', verdict: 'Indisponible', body: 'Donn√©e indisponible.' };
      const v = Math.abs(value);
      const inR = ([a, b]) => v >= a && v < b;
      let dot = 'red', verdict = '√âlev√© / risqu√©';
      if (inR(r.good)) { dot = 'green'; verdict = 'Plut√¥t bas / ma√Ætris√©'; }
      else if (inR(r.warn)) { dot: 'orange'; verdict = 'Interm√©diaire / √† surveiller'; }
      const fmt = (key === 'sharpe' || key === 'sortino') ? num : pct;
      const body = `${r.explain}\n\nValeur actuelle : ${fmt(value)}\nLecture : ${verdict}`;
      return { dot, verdict, body, label: r.label };
    }

    // Note: Initialization moved to the bottom of the script

    // ====== Main Functions ======
    async function refreshDashboard() {
      if (isRefreshing) return;
      isRefreshing = true;
      
      const refreshBtn = document.getElementById('refresh-btn');
      refreshBtn.disabled = true; 
      refreshBtn.textContent = 'üîÑ Refreshing‚Ä¶';
      
      // Update loading state
      store.set('ui.loading', true);
      store.set('ui.apiStatus.backend', 'unknown');

      try {
        // Fetch risk data and CCS data in parallel
        const [riskData, ccsData] = await Promise.all([
          fetchRiskData(),
          loadCCSData().catch(err => {
            console.warn('CCS data failed, continuing with risk only:', err);
            return null;
          })
        ]);
        
        if (riskData && riskData.success) {
          // Update store with risk data
          store.set('riskMetrics', riskData.risk_metrics);
          store.set('portfolioSummary', riskData.portfolio_summary);
          store.set('correlationMetrics', riskData.correlation_metrics);
          store.set('ui.apiStatus.backend', 'healthy');
          
          // Render risk dashboard in the active tab
          renderRiskDashboard(riskData);
          
          // Update timestamp
          if (riskData.timestamp && riskData.calculation_time) { 
            updateTimestamp(riskData.timestamp, riskData.calculation_time); 
          }
          
          // If CCS data loaded successfully, compute blended CCS
          if (ccsData) {
            await loadBlendedCCS();
          }
          
          console.log('Risk dashboard refreshed successfully');
          
        } else {
          throw new Error(riskData?.message || 'Failed to load risk dashboard');
        }
        
      } catch (err) {
        console.error('Dashboard error:', err);
        store.set('ui.apiStatus.backend', 'error');
        renderError('Network error: ' + err.message);
      } finally {
        isRefreshing = false;
        store.set('ui.loading', false);
        refreshBtn.disabled = false; 
        refreshBtn.textContent = 'üîÑ Refresh Data';
      }
    }

    function renderRiskDashboard(data) {
      const container = document.getElementById('risk-dashboard-content');
      if (!data || !data.risk_metrics || !data.correlation_metrics || !data.portfolio_summary) {
        renderError('Incomplete data received from API'); return;
      }
      const m = data.risk_metrics;
      const c = data.correlation_metrics;
      const p = data.portfolio_summary;

      // Helpers d'affichage
      function formatPercent(v) { return (v == null || isNaN(v)) ? 'N/A' : (v * 100).toFixed(2) + '%'; }
      function formatNumber(v) {
        if (v == null || isNaN(v)) return 'N/A';
        return new Intl.NumberFormat('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(v);
      }
      function safeFixed(v, d = 2) { return (v == null || isNaN(v)) ? 'N/A' : Number(v).toFixed(d); }

      container.innerHTML = `
        <!-- Portfolio Summary -->
        <div class="risk-card">
          <h3>üìä Portfolio Summary</h3>
          <div class="metric-row">
            <span class="metric-label">Total Value:</span>
            <span class="metric-value">$${formatNumber(p.total_value)}</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Number of Assets:</span>
            <span class="metric-value">${p.num_assets}</span>
          </div>
          <div class="metric-row">
            <span class="metric-label hinted" data-tipkey="data_conf">Data Confidence</span>
            <span class="metric-value">${safeFixed((p.confidence_level || 0) * 100, 1)}%</span>
          </div>
        </div>

        <div class="risk-grid">
          <!-- VaR/CVaR -->
          <div class="risk-card">
            <h3>üìâ Value at Risk (VaR)</h3>
            <div class="metric-row">
              <span class="metric-label hinted" data-key="var95_1d">VaR 95% (1 day)</span>
              <span class="metric-value hinted" data-key="var95_1d" data-value="${m.var_95_1d}">${formatPercent(m.var_95_1d)}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label hinted" data-key="var99_1d">VaR 99% (1 day)</span>
              <span class="metric-value hinted" data-key="var99_1d" data-value="${m.var_99_1d}">${formatPercent(m.var_99_1d)}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label hinted" data-key="cvar95_1d">CVaR 95% (1 day)</span>
              <span class="metric-value hinted" data-key="cvar95_1d" data-value="${m.cvar_95_1d}">${formatPercent(m.cvar_95_1d)}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label hinted" data-key="cvar99_1d">CVaR 99% (1 day)</span>
              <span class="metric-value hinted" data-key="cvar99_1d" data-value="${m.cvar_99_1d}">${formatPercent(m.cvar_99_1d)}</span>
            </div>
          </div>

          <!-- Performance -->
          <div class="risk-card">
            <h3>üìà Risk-Adjusted Performance</h3>
            <div class="metric-row">
              <span class="metric-label hinted" data-key="volatility_ann">Volatility (Annual)</span>
              <span class="metric-value hinted" data-key="volatility_ann" data-value="${m.volatility_annualized}">${formatPercent(m.volatility_annualized)}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label hinted" data-key="sharpe">Sharpe Ratio</span>
              <span class="metric-value hinted" data-key="sharpe" data-value="${m.sharpe_ratio}">${safeFixed(m.sharpe_ratio)}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label hinted" data-key="sortino">Sortino Ratio</span>
              <span class="metric-value hinted" data-key="sortino" data-value="${m.sortino_ratio}">${safeFixed(m.sortino_ratio)}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Calmar Ratio</span>
              <span class="metric-value">${safeFixed(m.calmar_ratio)}</span>
            </div>
          </div>

          <!-- Drawdowns -->
          <div class="risk-card">
            <h3>üìä Drawdown Analysis</h3>
            <div class="metric-row">
              <span class="metric-label hinted" data-key="max_drawdown">Max Drawdown</span>
              <span class="metric-value hinted" data-key="max_drawdown" data-value="${m.max_drawdown}">${formatPercent(m.max_drawdown)}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label hinted" data-key="current_drawdown">Current Drawdown</span>
              <span class="metric-value hinted" data-key="current_drawdown" data-value="${m.current_drawdown}">${formatPercent(m.current_drawdown)}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Risk Score</span>
              <span class="metric-value">${safeFixed(m.risk_score, 1)}/100</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Risk Level</span>
              <span class="risk-level risk-${(m.overall_risk_level || 'unknown').replace('_', '-')}">${(m.overall_risk_level || 'Unknown').replace('_', ' ')}</span>
            </div>
          </div>

          <!-- Diversification -->
          <div class="risk-card">
            <h3>üîó Diversification Analysis</h3>
            <div class="metric-row">
              <span class="metric-label hinted" data-key="diversification_ratio">Diversification Ratio</span>
              <span class="metric-value hinted" data-key="diversification_ratio" data-value="${c.diversification_ratio}">${safeFixed(c.diversification_ratio)}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label hinted" data-key="effective_assets">Effective Assets</span>
              <span class="metric-value hinted" data-key="effective_assets" data-value="${c.effective_assets}">${safeFixed(c.effective_assets, 1)}</span>
            </div>

            ${c.top_correlations && c.top_correlations.length ? `
              <h4>Top Asset Correlations:</h4>
              ${c.top_correlations.slice(0, 3).map(t => `
                <div class="metric-row">
                  <span class="metric-label">${t.asset1} - ${t.asset2}:</span>
                  <span class="metric-value ${(Math.abs(t.correlation || 0) > 0.7) ? 'text-warning' : 'text-success'}">${((t.correlation || 0) * 100).toFixed(1)}%</span>
                </div>
              `).join('')}
            ` : ``}
          </div>
        </div>

        <!-- Alerts -->
        ${data.alerts && data.alerts.length ? `
          <div class="risk-card">
            <h3>‚ö†Ô∏è Risk Alerts</h3>
            ${data.alerts.map(a => `
              <div class="alert alert-${a.level}">
                <strong>${a.message}</strong><br>
                <em>Recommendation: ${a.recommendation}</em>
              </div>
            `).join('')}
          </div>
        ` : `
          <div class="risk-card">
            <h3>‚úÖ All Clear</h3>
            <p>No significant risk alerts at this time.</p>
          </div>
        `}
      `;

      // Apr√®s rendu : brancher les info-bulles et verdicts
      decorateRiskTooltips();
    }
    
    // ====== Cycles Content ======
    function renderCyclesContent() {
      const container = document.getElementById('cycles-content');
      const state = store.snapshot();
      const ccsData = state.ccs;
      const cycleData = state.cycle;
      
      if (!ccsData?.score || !cycleData?.months) {
        container.innerHTML = '<div class="loading">Loading cycle data...</div>';
        return;
      }
      
      const blended = cycleData.ccsStar || ccsData.score;
      const interpretation = interpretCCS(blended);
      
      container.innerHTML = `
        <div class="risk-grid">
          <!-- CCS Overview -->
          <div class="risk-card">
            <h3>üìä CCS Market Score</h3>
            <div style="text-align: center; margin: var(--space-lg) 0;">
              <div style="font-size: 3rem; font-weight: 700; color: ${interpretation.color};">
                ${Math.round(ccsData.score)}
              </div>
              <div style="font-size: 1rem; color: var(--theme-text-muted);">
                ${interpretation.label}
              </div>
            </div>
            
            <div class="metric-row">
              <span class="metric-label">Model Version:</span>
              <span class="metric-value">${ccsData.model_version}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Last Update:</span>
              <span class="metric-value">${new Date(ccsData.lastUpdate).toLocaleTimeString()}</span>
            </div>
          </div>
          
          <!-- Cycle Position -->
          <div class="risk-card">
            <h3>üîÑ Cycle Position</h3>
            <div style="text-align: center; margin: var(--space-lg) 0;">
              <div style="font-size: 2rem;">
                ${cycleData.phase?.emoji || '‚ö´'} 
              </div>
              <div style="font-size: 1rem; font-weight: 600; color: ${cycleData.phase?.color || '#6b7280'};">
                ${cycleData.phase?.phase?.replace('_', ' ').toUpperCase() || 'UNKNOWN'}
              </div>
              <div style="font-size: 0.875rem; color: var(--theme-text-muted);">
                Month ${Math.round(cycleData.months)} post-halving
              </div>
            </div>
            
            <div class="metric-row">
              <span class="metric-label">Cycle Score:</span>
              <span class="metric-value">${Math.round(cycleData.score)}/100</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Confidence:</span>
              <span class="metric-value">${Math.round(cycleData.confidence * 100)}%</span>
            </div>
          </div>
          
          <!-- Blended Analysis -->
          <div class="risk-card">
            <h3>‚öñÔ∏è Blended Strategy</h3>
            <div class="metric-row">
              <span class="metric-label">Original CCS:</span>
              <span class="metric-value">${Math.round(ccsData.score)}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Cycle Weight:</span>
              <span class="metric-value">${Math.round((cycleData.weight || 0.3) * 100)}%</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Blended CCS*:</span>
              <span class="metric-value" style="color: ${interpretation.color}; font-weight: 700;">
                ${Math.round(blended)}
              </span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Strategy:</span>
              <span class="metric-value">${interpretation.label}</span>
            </div>
          </div>
        </div>
        
        <!-- Signal Details -->
        <div class="risk-card">
          <h3>üì° Signal Breakdown</h3>
          <div class="risk-grid">
            ${Object.entries(ccsData.signals || {}).map(([key, signal]) => `
              <div class="metric-row">
                <span class="metric-label">${key.replace('_', ' ').toUpperCase()}:</span>
                <span class="metric-value">
                  ${Math.round(signal.normalized || 0)} 
                  <span style="font-size: 0.75rem; opacity: 0.7;">(${Math.round((signal.weight || 0) * 100)}%)</span>
                </span>
              </div>
            `).join('')}
          </div>
        </div>
        
        <!-- Cycle Multipliers -->
        <div class="risk-card">
          <h3>üéØ Asset Class Multipliers</h3>
          <div style="font-size: 0.875rem; color: var(--theme-text-muted); margin-bottom: var(--space-sm);">
            Based on current cycle phase: <strong>${cycleData.phase?.phase?.replace('_', ' ')}</strong>
          </div>
          <div class="risk-grid">
            ${Object.entries(cycleData.multipliers || {}).map(([asset, multiplier]) => {
              const color = multiplier > 1.1 ? 'var(--success)' : 
                           multiplier < 0.9 ? 'var(--danger)' : 'var(--theme-text)';
              return `
                <div class="metric-row">
                  <span class="metric-label">${asset}:</span>
                  <span class="metric-value" style="color: ${color};">
                    ${multiplier.toFixed(2)}x
                  </span>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    function renderError(message) {
      document.getElementById('risk-dashboard-content').innerHTML = `
        <div class="error">
          <h3>‚ùå Error Loading Dashboard</h3>
          <p>${message}</p>
          <button class="refresh-btn" onclick="refreshDashboard()">Try Again</button>
        </div>
      `;
    }

    function updateTimestamp(ts, calcTime) {
      const d = new Date(ts);
      document.getElementById('last-update').textContent = `Last updated: ${d.toLocaleString()} (${calcTime})`;
    }

    function enableAutoRefresh() {
      const btn = document.getElementById('auto-refresh-btn');
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval); autoRefreshInterval = null;
        btn.textContent = '‚è±Ô∏è Enable Auto-Refresh (30s)'; btn.style.background = '';
      } else {
        autoRefreshInterval = setInterval(refreshDashboard, 30000);
        btn.textContent = '‚èπÔ∏è Disable Auto-Refresh'; btn.style.background = '#28a745';
      }
    }

    // Test endpoint (identique √† ta version)
    async function testEndpoint() {
      try {
        const r = await fetch('http://localhost:8000/api/risk/dashboard?source=cointracking&pricing=local&min_usd=1.00');
        const t = await r.text();
        try { JSON.parse(t); alert('API Response received. Check console for details.'); }
        catch { alert('API returned non-JSON response: ' + t.substring(0, 200)); }
      } catch (e) { alert('API test failed: ' + e.message); }
    }

    // ===== D√©coration des tooltips apr√®s rendu =====
    function decorateRiskTooltips() {
      // Info sp√©cifique pour Data Confidence (inchang√©)
      document.querySelectorAll('[data-tipkey="data_conf"]').forEach(el => {
        attachTip(el, 'Data Confidence', "Qualit√© de l'historique de march√© utilis√© pour les m√©triques.\nPlus haut = plus fiable.");
      });

      // === Nouvelle attache dynamique pour les m√©triques ===
      document.querySelectorAll('.hinted[data-key]').forEach(el => {
        const key = el.getAttribute('data-key');

        // attache une bulle "vivante" qui lit la valeur *au moment* du survol
        el.addEventListener('mouseenter', (e) => {
          // 1) essaie data-value
          let raw = el.getAttribute('data-value');

          // 2) fallback: parse le texte visible (ex: "1.23%" -> 0.0123)
          if (!raw || raw === '0') {
            const txt = (el.textContent || '').trim();
            if (txt.endsWith('%')) {
              const n = parseFloat(txt.replace('%', '').replace(',', '.'));
              raw = isFinite(n) ? String(n / 100) : '';
            } else {
              const n = parseFloat(txt.replace(',', '.'));
              raw = isFinite(n) ? String(n) : '';
            }
          }

          const val = Number(String(raw || '').replace(',', '.'));
          const rating = rate(key, isNaN(val) ? null : val);

          const title = rating.label || key;
          const fmt = (key === 'sharpe' || key === 'sortino') ? num : pct;
          const body = `${rating.explain}\n\nValeur actuelle : ${isNaN(val) ? 'N/A' : fmt(val)}\nLecture : ${rating.verdict}`;

          showTip(title, body, e.clientX, e.clientY);
        });

        el.addEventListener('mousemove', (e) => moveTip(e.clientX, e.clientY));
        el.addEventListener('mouseleave', hideTip);
        el.classList.add('hinted');
      });
    }

    // ====== Initialization & Store Connection ======
    
    // Subscribe to store changes for sidebar and content updates
    store.subscribe((state) => {
      updateSidebar(state);
      
      // Auto-update active tab content when data changes
      const activeTab = state.ui?.activeTab;
      if (activeTab === 'cycles' && state.ccs?.score && state.cycle?.months) {
        renderCyclesContent();
      }
    });
    
    // Global functions for backwards compatibility
    window.refreshDashboard = refreshDashboard;
    window.enableAutoRefresh = enableAutoRefresh;
    window.testEndpoint = testEndpoint;
    
    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Risk Dashboard CCS MVP initializing...');
      
      // Initialize shared header
      initSharedHeader('risk-dashboard');
      
      // Hydrate store from localStorage
      store.hydrate();
      
      // Initial sidebar update
      updateSidebar(store.snapshot());
      
      // Load initial data
      refreshDashboard();
      
      console.log('Risk Dashboard CCS MVP initialized');
    });
  </script>
</body>

</html>