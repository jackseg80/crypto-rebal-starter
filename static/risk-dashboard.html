<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Risk Dashboard - Crypto Portfolio</title>

  <!-- Th√®me/compat identiques √† ta page actuelle -->
  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">

  <!-- Scripts partag√©s existants -->
  <script src="global-config.js"></script>
  <script src="shared-header.js"></script>
  <script src="appearance.js"></script>

  <style>
    .risk-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: var(--space-lg);
      margin: var(--space-lg) 0;
    }

    .risk-card {
      background: var(--theme-surface);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-lg);
      padding: var(--space-xl);
      box-shadow: var(--shadow-sm);
      transition: all var(--transition-normal);
    }

    .risk-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .risk-card h3 {
      margin-top: 0;
      color: var(--theme-text);
      border-bottom: 2px solid var(--brand-primary);
      padding-bottom: var(--space-sm);
      font-size: 1.25rem;
      font-weight: 600;
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-sm) 0;
      border-bottom: 1px solid var(--theme-border);
    }

    .metric-label {
      font-weight: 500;
      color: var(--theme-text-muted);
      font-size: 0.875rem;
    }

    .metric-value {
      font-weight: 600;
      font-family: 'Monaco', 'Consolas', monospace;
      color: var(--theme-text);
    }

    .risk-level {
      display: inline-block;
      padding: 0.375rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .05em;
    }

    .risk-low {
      background: var(--success-bg);
      color: var(--success)
    }

    .risk-medium {
      background: var(--warning-bg);
      color: var(--warning)
    }

    .risk-high,
    .risk-very-high {
      background: var(--danger-bg);
      color: var(--danger)
    }

    .risk-critical {
      background: var(--danger);
      color: #fff
    }

    .alert {
      padding: var(--space-lg);
      margin: var(--space-sm) 0;
      border-radius: var(--radius-md);
      border-left: 4px solid;
    }

    .alert-high {
      background: var(--danger-bg);
      color: var(--danger);
      border-color: var(--danger)
    }

    .alert-medium {
      background: var(--warning-bg);
      color: var(--warning);
      border-color: var(--warning)
    }

    .alert-low {
      background: var(--info-bg);
      color: var(--info);
      border-color: var(--info)
    }

    .correlation-heatmap {
      width: 100%;
      height: 300px;
      background: var(--theme-surface);
      border: 1px solid var(--theme-border);
      border-radius: 4px;
      overflow-x: auto;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--theme-text-muted);
    }

    .error {
      background: var(--danger-bg);
      color: var(--danger);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid var(--danger);
    }

    .refresh-btn {
      background: var(--brand-primary);
      color: #fff;
      border: 0;
      padding: .75rem 1.5rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: .875rem;
      font-weight: 500;
      margin: var(--space-sm);
      transition: all var(--transition-normal);
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .refresh-btn:hover:not(:disabled) {
      background: var(--brand-primary-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .refresh-btn:disabled {
      background: var(--theme-border);
      cursor: not-allowed;
      opacity: .5
    }

    .timestamp {
      font-size: .75rem;
      color: var(--theme-text-muted);
      text-align: right;
      margin-bottom: var(--space-sm)
    }

    .controls {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      margin: var(--space-lg) 0;
      flex-wrap: wrap
    }

    /* ===== Tooltip (l√©ger, autonome) ===== */
    .tooltip {
      position: fixed;
      z-index: 9999;
      min-width: 260px;
      max-width: 360px;
      pointer-events: none;
      background: #0e1528;
      color: #e9f0ff;
      border: 1px solid #243355;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
      padding: 10px 12px;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity .12s ease, transform .12s ease;
    }

    .tooltip.show {
      opacity: 1;
      transform: translateY(0)
    }

    .tooltip .tip-title {
      font-weight: 700;
      margin-bottom: 6px;
      color: #d7e6ff
    }

    .tooltip .tip-body {
      white-space: pre-line;
      color: #c6d6f3;
      font-size: 13px
    }

    /* Indication de survol explicatif */
    .hinted {
      cursor: help;
      text-decoration: underline dotted;
      text-underline-offset: 2px;
    }
  </style>
</head>

<body>
  <div id="shared-header"></div>

  <div class="container">
    <div class="controls">
      <button class="refresh-btn" onclick="refreshDashboard()" id="refresh-btn">üîÑ Refresh Data</button>
      <button class="refresh-btn" onclick="enableAutoRefresh()" id="auto-refresh-btn">‚è±Ô∏è Enable Auto-Refresh
        (30s)</button>
      <button class="refresh-btn" onclick="testEndpoint()" style="background:#007bff">üß™ Test API</button>
      <div class="timestamp" id="last-update"></div>
    </div>

    <div id="dashboard-content">
      <div class="loading">Loading risk metrics.</div>
    </div>
  </div>

  <!-- Tooltip partag√© -->
  <div id="tooltip" class="tooltip" aria-hidden="true" role="tooltip">
    <div class="tip-title"></div>
    <div class="tip-body"></div>
  </div>

  <script>
    let autoRefreshInterval = null;
    let isRefreshing = false;

    // ====== Tooltip helpers ======
    const $tip = document.getElementById('tooltip');
    const $tipTitle = $tip?.querySelector('.tip-title');
    const $tipBody = $tip?.querySelector('.tip-body');
    function showTip(title, body, x, y) { if (!$tip) return; $tipTitle.textContent = title || ''; $tipBody.textContent = body || ''; $tip.style.left = x + 'px'; $tip.style.top = y + 'px'; $tip.classList.add('show'); $tip.setAttribute('aria-hidden', 'false'); }
    function moveTip(x, y) { if (!$tip) return; $tip.style.left = x + 'px'; $tip.style.top = y + 'px'; }
    function hideTip() { if (!$tip) return; $tip.classList.remove('show'); $tip.setAttribute('aria-hidden', 'true'); }
    function attachTip(el, title, body) { if (!el) return; el.addEventListener('mouseenter', e => showTip(title, body, e.clientX, e.clientY)); el.addEventListener('mousemove', e => moveTip(e.clientX, e.clientY)); el.addEventListener('mouseleave', hideTip); el.classList.add('hinted'); }

    // ====== Bar√®me et textes d'aide ======
    const pct = v => (v == null || isNaN(v) ? 'N/A' : (v * 100).toFixed(2) + '%');
    const num = v => (v == null || isNaN(v) ? 'N/A' : Number(v).toFixed(2));

    // Bornes heuristiques (ajuste selon tes pr√©f√©rences)
    const RISK_RULES = {
      var95_1d: { label: 'VaR 95% (1j)', good: [0, 0.01], warn: [0.01, 0.02], bad: [0.02, Infinity], explain: "Perte 1j que tu ne d√©passes qu'1x sur 20.\nPlus bas = mieux." },
      var99_1d: { label: 'VaR 99% (1j)', good: [0, 0.015], warn: [0.015, 0.03], bad: [0.03, Infinity], explain: "Perte 1j que tu ne d√©passes qu'1x sur 100.\nPlus bas = mieux." },
      cvar95_1d: { label: 'cVaR 95% (1j)', good: [0, 0.013], warn: [0.013, 0.025], bad: [0.025, Infinity], explain: "Perte moyenne dans les pires 5% des jours.\nPlus bas = mieux." },
      cvar99_1d: { label: 'cVaR 99% (1j)', good: [0, 0.018], warn: [0.018, 0.035], bad: [0.035, Infinity], explain: "Perte moyenne dans les pires 1% des jours.\nPlus bas = mieux." },
      volatility_ann: { label: 'Volatilit√© (ann.)', good: [0, 0.40], warn: [0.40, 0.80], bad: [0.80, Infinity], explain: "Variabilit√© annualis√©e du portefeuille.\nPlus bas = plus d√©fensif." },
      sharpe: { label: 'Sharpe', good: [1.5, Infinity], warn: [0.8, 1.5], bad: [-Infinity, 0.8], explain: "Rendement exc√©dentaire / risque.\n>1.0 correct ‚Ä¢ >1.5 bon ‚Ä¢ >2.0 excellent." },
      sortino: { label: 'Sortino', good: [1.8, Infinity], warn: [1.0, 1.8], bad: [-Infinity, 1.0], explain: "Comme Sharpe mais p√©nalise seulement la baisse.\n>1.5 bon." },
      max_drawdown: { label: 'Max Drawdown', good: [0, 0.35], warn: [0.35, 0.60], bad: [0.60, Infinity], explain: "Pire chute historique.\nPlus bas = trajectoire plus lisse." },
      current_drawdown: { label: 'Drawdown courant', good: [0, 0.10], warn: [0.10, 0.25], bad: [0.25, Infinity], explain: "√âcart actuel au dernier sommet.\nPlus bas = mieux." },
      diversification_ratio: { label: 'Diversification Ratio', good: [1.5, Infinity], warn: [1.2, 1.5], bad: [-Infinity, 1.2], explain: "Plus √©lev√© = meilleure diversification." },
      effective_assets: { label: 'Effective Assets', good: [8, Infinity], warn: [4, 8], bad: [-Infinity, 4], explain: "Nombre effectif d'actifs ind√©pendants." }
    };

    function rate(key, value) {
      const r = RISK_RULES[key]; if (!r || value == null || isNaN(value)) return { dot: 'orange', verdict: 'Indisponible', body: 'Donn√©e indisponible.' };
      const v = Math.abs(value);
      const inR = ([a, b]) => v >= a && v < b;
      let dot = 'red', verdict = '√âlev√© / risqu√©';
      if (inR(r.good)) { dot = 'green'; verdict = 'Plut√¥t bas / ma√Ætris√©'; }
      else if (inR(r.warn)) { dot: 'orange'; verdict = 'Interm√©diaire / √† surveiller'; }
      const fmt = (key === 'sharpe' || key === 'sortino') ? num : pct;
      const body = `${r.explain}\n\nValeur actuelle : ${fmt(value)}\nLecture : ${verdict}`;
      return { dot, verdict, body, label: r.label };
    }

    // ====== Initialisation ======
    document.addEventListener('DOMContentLoaded', function () {
      initSharedHeader('risk-dashboard'); // conserve ton menu/header existant
      refreshDashboard();
    });

    async function refreshDashboard() {
      if (isRefreshing) return;
      isRefreshing = true;
      const refreshBtn = document.getElementById('refresh-btn');
      refreshBtn.disabled = true; refreshBtn.textContent = 'üîÑ Refreshing‚Ä¶';

      try {
        const resp = await fetch('http://localhost:8000/api/risk/dashboard?source=cointracking&pricing=local&min_usd=1.00');
        if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
        const data = await resp.json();
        if (data && data.success) {
          renderDashboard(data);
          if (data.timestamp && data.calculation_time) { updateTimestamp(data.timestamp, data.calculation_time); }
        } else {
          renderError(data?.message || 'Failed to load risk dashboard');
        }
      } catch (err) {
        console.error('Dashboard error:', err);
        renderError('Network error: ' + err.message);
      } finally {
        isRefreshing = false;
        refreshBtn.disabled = false; refreshBtn.textContent = 'üîÑ Refresh Data';
      }
    }

    function renderDashboard(data) {
      const container = document.getElementById('dashboard-content');
      if (!data || !data.risk_metrics || !data.correlation_metrics || !data.portfolio_summary) {
        renderError('Incomplete data received from API'); return;
      }
      const m = data.risk_metrics;
      const c = data.correlation_metrics;
      const p = data.portfolio_summary;

      // Helpers d'affichage
      function formatPercent(v) { return (v == null || isNaN(v)) ? 'N/A' : (v * 100).toFixed(2) + '%'; }
      function formatNumber(v) {
        if (v == null || isNaN(v)) return 'N/A';
        return new Intl.NumberFormat('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(v);
      }
      function safeFixed(v, d = 2) { return (v == null || isNaN(v)) ? 'N/A' : Number(v).toFixed(d); }

      container.innerHTML = `
        <!-- Portfolio Summary -->
        <div class="risk-card">
          <h3>üìä Portfolio Summary</h3>
          <div class="metric-row">
            <span class="metric-label">Total Value:</span>
            <span class="metric-value">$${formatNumber(p.total_value)}</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Number of Assets:</span>
            <span class="metric-value">${p.num_assets}</span>
          </div>
          <div class="metric-row">
            <span class="metric-label hinted" data-tipkey="data_conf">Data Confidence</span>
            <span class="metric-value">${safeFixed((p.confidence_level || 0) * 100, 1)}%</span>
          </div>
        </div>

        <div class="risk-grid">
          <!-- VaR/CVaR -->
          <div class="risk-card">
            <h3>üìâ Value at Risk (VaR)</h3>
            <div class="metric-row">
              <span class="metric-label hinted" data-key="var95_1d">VaR 95% (1 day)</span>
              <span class="metric-value hinted" data-key="var95_1d" data-value="${m.var_95_1d}">${formatPercent(m.var_95_1d)}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label hinted" data-key="var99_1d">VaR 99% (1 day)</span>
              <span class="metric-value hinted" data-key="var99_1d" data-value="${m.var_99_1d}">${formatPercent(m.var_99_1d)}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label hinted" data-key="cvar95_1d">CVaR 95% (1 day)</span>
              <span class="metric-value hinted" data-key="cvar95_1d" data-value="${m.cvar_95_1d}">${formatPercent(m.cvar_95_1d)}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label hinted" data-key="cvar99_1d">CVaR 99% (1 day)</span>
              <span class="metric-value hinted" data-key="cvar99_1d" data-value="${m.cvar_99_1d}">${formatPercent(m.cvar_99_1d)}</span>
            </div>
          </div>

          <!-- Performance -->
          <div class="risk-card">
            <h3>üìà Risk-Adjusted Performance</h3>
            <div class="metric-row">
              <span class="metric-label hinted" data-key="volatility_ann">Volatility (Annual)</span>
              <span class="metric-value hinted" data-key="volatility_ann" data-value="${m.volatility_annualized}">${formatPercent(m.volatility_annualized)}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label hinted" data-key="sharpe">Sharpe Ratio</span>
              <span class="metric-value hinted" data-key="sharpe" data-value="${m.sharpe_ratio}">${safeFixed(m.sharpe_ratio)}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label hinted" data-key="sortino">Sortino Ratio</span>
              <span class="metric-value hinted" data-key="sortino" data-value="${m.sortino_ratio}">${safeFixed(m.sortino_ratio)}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Calmar Ratio</span>
              <span class="metric-value">${safeFixed(m.calmar_ratio)}</span>
            </div>
          </div>

          <!-- Drawdowns -->
          <div class="risk-card">
            <h3>üìä Drawdown Analysis</h3>
            <div class="metric-row">
              <span class="metric-label hinted" data-key="max_drawdown">Max Drawdown</span>
              <span class="metric-value hinted" data-key="max_drawdown" data-value="${m.max_drawdown}">${formatPercent(m.max_drawdown)}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label hinted" data-key="current_drawdown">Current Drawdown</span>
              <span class="metric-value hinted" data-key="current_drawdown" data-value="${m.current_drawdown}">${formatPercent(m.current_drawdown)}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Risk Score</span>
              <span class="metric-value">${safeFixed(m.risk_score, 1)}/100</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Risk Level</span>
              <span class="risk-level risk-${(m.overall_risk_level || 'unknown').replace('_', '-')}">${(m.overall_risk_level || 'Unknown').replace('_', ' ')}</span>
            </div>
          </div>

          <!-- Diversification -->
          <div class="risk-card">
            <h3>üîó Diversification Analysis</h3>
            <div class="metric-row">
              <span class="metric-label hinted" data-key="diversification_ratio">Diversification Ratio</span>
              <span class="metric-value hinted" data-key="diversification_ratio" data-value="${c.diversification_ratio}">${safeFixed(c.diversification_ratio)}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label hinted" data-key="effective_assets">Effective Assets</span>
              <span class="metric-value hinted" data-key="effective_assets" data-value="${c.effective_assets}">${safeFixed(c.effective_assets, 1)}</span>
            </div>

            ${c.top_correlations && c.top_correlations.length ? `
              <h4>Top Asset Correlations:</h4>
              ${c.top_correlations.slice(0, 3).map(t => `
                <div class="metric-row">
                  <span class="metric-label">${t.asset1} - ${t.asset2}:</span>
                  <span class="metric-value ${(Math.abs(t.correlation || 0) > 0.7) ? 'text-warning' : 'text-success'}">${((t.correlation || 0) * 100).toFixed(1)}%</span>
                </div>
              `).join('')}
            ` : ``}
          </div>
        </div>

        <!-- Alerts -->
        ${data.alerts && data.alerts.length ? `
          <div class="risk-card">
            <h3>‚ö†Ô∏è Risk Alerts</h3>
            ${data.alerts.map(a => `
              <div class="alert alert-${a.level}">
                <strong>${a.message}</strong><br>
                <em>Recommendation: ${a.recommendation}</em>
              </div>
            `).join('')}
          </div>
        ` : `
          <div class="risk-card">
            <h3>‚úÖ All Clear</h3>
            <p>No significant risk alerts at this time.</p>
          </div>
        `}
      `;

      // Apr√®s rendu : brancher les info-bulles et verdicts
      decorateRiskTooltips();
    }

    function renderError(message) {
      document.getElementById('dashboard-content').innerHTML = `
        <div class="error">
          <h3>‚ùå Error Loading Dashboard</h3>
          <p>${message}</p>
          <button class="refresh-btn" onclick="refreshDashboard()">Try Again</button>
        </div>
      `;
    }

    function updateTimestamp(ts, calcTime) {
      const d = new Date(ts);
      document.getElementById('last-update').textContent = `Last updated: ${d.toLocaleString()} (${calcTime})`;
    }

    function enableAutoRefresh() {
      const btn = document.getElementById('auto-refresh-btn');
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval); autoRefreshInterval = null;
        btn.textContent = '‚è±Ô∏è Enable Auto-Refresh (30s)'; btn.style.background = '';
      } else {
        autoRefreshInterval = setInterval(refreshDashboard, 30000);
        btn.textContent = '‚èπÔ∏è Disable Auto-Refresh'; btn.style.background = '#28a745';
      }
    }

    // Test endpoint (identique √† ta version)
    async function testEndpoint() {
      try {
        const r = await fetch('http://localhost:8000/api/risk/dashboard?source=cointracking&pricing=local&min_usd=1.00');
        const t = await r.text();
        try { JSON.parse(t); alert('API Response received. Check console for details.'); }
        catch { alert('API returned non-JSON response: ' + t.substring(0, 200)); }
      } catch (e) { alert('API test failed: ' + e.message); }
    }

    // ===== D√©coration des tooltips apr√®s rendu =====
    function decorateRiskTooltips() {
      // Info sp√©cifique pour Data Confidence (inchang√©)
      document.querySelectorAll('[data-tipkey="data_conf"]').forEach(el => {
        attachTip(el, 'Data Confidence', "Qualit√© de l'historique de march√© utilis√© pour les m√©triques.\nPlus haut = plus fiable.");
      });

      // === Nouvelle attache dynamique pour les m√©triques ===
      document.querySelectorAll('.hinted[data-key]').forEach(el => {
        const key = el.getAttribute('data-key');

        // attache une bulle "vivante" qui lit la valeur *au moment* du survol
        el.addEventListener('mouseenter', (e) => {
          // 1) essaie data-value
          let raw = el.getAttribute('data-value');

          // 2) fallback: parse le texte visible (ex: "1.23%" -> 0.0123)
          if (!raw || raw === '0') {
            const txt = (el.textContent || '').trim();
            if (txt.endsWith('%')) {
              const n = parseFloat(txt.replace('%', '').replace(',', '.'));
              raw = isFinite(n) ? String(n / 100) : '';
            } else {
              const n = parseFloat(txt.replace(',', '.'));
              raw = isFinite(n) ? String(n) : '';
            }
          }

          const val = Number(String(raw || '').replace(',', '.'));
          const rating = rate(key, isNaN(val) ? null : val);

          const title = rating.label || key;
          const fmt = (key === 'sharpe' || key === 'sortino') ? num : pct;
          const body = `${rating.explain}\n\nValeur actuelle : ${isNaN(val) ? 'N/A' : fmt(val)}\nLecture : ${rating.verdict}`;

          showTip(title, body, e.clientX, e.clientY);
        });

        el.addEventListener('mousemove', (e) => moveTip(e.clientX, e.clientY));
        el.addEventListener('mouseleave', hideTip);
        el.classList.add('hinted');
      });
    }
  </script>
</body>

</html>