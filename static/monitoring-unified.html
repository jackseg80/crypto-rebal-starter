<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>📊 Unified Monitoring Dashboard - Crypto Rebalancer</title>
  <script src="global-config.js"></script>
  <script src="shared-header.js"></script>
  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">
  <script src="appearance.js"></script>
  <style>
    /* Variables complémentaires pour le dashboard unifié */
    :root {
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 12px;
      --space-lg: 16px;
      --space-xl: 24px;
      --radius-lg: 12px;
      --transition-normal: all 0.2s ease;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      background: var(--theme-background);
      color: var(--theme-text);
    }

    .container {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 var(--space-lg);
    }

    @media (max-width: 768px) {
      .container {
        padding: 0 var(--space-md);
      }
    }

    /* Header */
    .dashboard-header {
      background: var(--theme-surface);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-lg);
      padding: var(--space-xl);
      margin-bottom: var(--space-lg);
      box-shadow: var(--shadow-sm);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: var(--space-lg);
    }

    .header-title h1 {
      margin: 0 0 var(--space-sm) 0;
      font-size: 1.75rem;
      font-weight: 700;
    }

    .header-subtitle {
      color: var(--muted);
      font-size: 0.875rem;
      margin: 0;
    }

    .header-controls {
      display: flex;
      gap: var(--space-sm);
      flex-wrap: wrap;
    }

    /* Tabs */
    .tabs-container {
      background: var(--theme-surface);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      margin-bottom: var(--space-lg);
      overflow: hidden;
    }

    .tabs-nav {
      display: flex;
      border-bottom: 1px solid var(--theme-border);
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    }

    .tab-button {
      flex: 1;
      padding: var(--space-lg);
      background: none;
      border: none;
      color: var(--theme-text-muted);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition-normal);
      border-bottom: 3px solid transparent;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-xs);
    }

    .tab-button:hover {
      color: var(--theme-text);
      background: var(--theme-surface);
    }

    .tab-button.active {
      color: var(--brand-primary);
      border-bottom-color: var(--brand-primary);
      background: var(--theme-surface);
      font-weight: 700;
    }

    .tab-content {
      padding: var(--space-xl);
      min-height: 500px;
    }

    .tab-pane {
      display: none;
    }

    .tab-pane.active {
      display: block;
    }

    /* Cards & Grid */
    .card {
      background: var(--theme-surface);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-md);
      padding: var(--space-xl);
      margin-bottom: var(--space-lg);
      box-shadow: var(--shadow-sm);
    }

    .grid {
      display: grid;
      gap: var(--space-lg);
    }

    .grid.g2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    .grid.g3 { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }

    /* Metrics */
    .metric-card {
      background: var(--theme-surface);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-md);
      padding: var(--space-lg);
      text-align: center;
      transition: var(--transition-normal);
    }

    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .metric-value {
      font-size: 2rem;
      font-weight: 700;
      margin: var(--space-sm) 0;
    }

    .metric-label {
      color: var(--theme-text-muted);
      font-size: 0.75rem;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.025em;
      margin-bottom: var(--space-xs);
    }

    .metric-change {
      font-size: 0.75rem;
      font-weight: 600;
      margin-top: var(--space-xs);
    }

    .metric-change.positive { color: var(--pos); }
    .metric-change.negative { color: var(--neg); }
    .metric-change.neutral { color: var(--theme-text-muted); }

    /* Status indicators */
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-md);
    }

    .status-item {
      background: var(--theme-surface);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-md);
      padding: var(--space-lg);
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .status-dot.healthy { background: var(--pos); }
    .status-dot.warning { background: var(--warning); }
    .status-dot.error, .status-dot.danger { background: var(--neg); }
    .status-dot.unknown { background: var(--theme-text-muted); }

    .status-info {
      flex: 1;
    }

    .status-name {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .status-details {
      font-size: 0.75rem;
      color: var(--theme-text-muted);
    }

    /* Alerts */
    .alert-item {
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      margin-bottom: var(--space-sm);
      display: flex;
      align-items: flex-start;
      gap: var(--space-md);
    }

    .alert-item.critical { 
      border-color: var(--neg); 
      background: var(--theme-surface-elevated); 
    }
    .alert-item.warning { 
      border-color: var(--warning); 
      background: var(--theme-surface-elevated); 
    }
    .alert-item.info { 
      border-color: var(--accent); 
      background: var(--theme-surface-elevated); 
    }

    .alert-icon {
      font-size: 1.25rem;
      flex-shrink: 0;
    }

    .alert-content {
      flex: 1;
    }

    .alert-title {
      font-weight: 600;
      margin-bottom: var(--space-xs);
      font-size: 0.875rem;
    }

    .alert-message {
      color: var(--theme-text-muted);
      font-size: 0.8125rem;
      line-height: 1.4;
    }

    .alert-timestamp {
      color: var(--muted);
      font-size: 0.75rem;
      margin-top: var(--space-xs);
    }

    /* Buttons */
    .btn {
      background: var(--brand-primary);
      color: white;
      border: none;
      padding: var(--space-sm) var(--space-lg);
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      font-size: 0.8125rem;
      transition: var(--transition-normal);
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
    }

    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn.secondary { background: var(--theme-surface-elevated); color: var(--theme-text); border: 1px solid var(--theme-border); }
    .btn.success { background: var(--pos); }
    .btn.warning { background: var(--warning); }
    .btn.danger { background: var(--neg); }

    /* Charts & Visualizations */
    .chart-container {
      height: 200px;
      background: linear-gradient(135deg, var(--info-bg), var(--success-bg));
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-style: italic;
      border: 1px solid var(--theme-border);
    }

    /* History Items */
    .history-container {
      max-height: 300px;
      overflow-y: auto;
    }

    .history-item {
      border-bottom: 1px solid var(--theme-border);
      padding: var(--space-md) 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-md);
    }

    .history-item:last-child { border-bottom: none; }

    .history-main {
      flex: 1;
    }

    .history-title {
      font-weight: 600;
      margin-bottom: 2px;
      font-size: 0.875rem;
    }

    .history-details {
      font-size: 0.75rem;
      color: var(--theme-text-muted);
    }

    .history-meta {
      text-align: right;
      font-size: 0.75rem;
      color: var(--muted);
    }

    /* Empty States */
    .empty-state {
      text-align: center;
      padding: var(--space-xl);
      color: var(--muted);
    }

    .empty-state-icon {
      font-size: 2.5rem;
      margin-bottom: var(--space-md);
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: var(--space-xl);
      color: var(--muted);
    }

    .loading::after {
      content: "...";
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      0%, 20% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    /* Additional Portfolio Styles */
    .performance-chart {
      height: 200px;
      background: linear-gradient(45deg, var(--info-bg) 0%, var(--success-bg) 100%);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-style: italic;
    }

    .rebalance-history {
      max-height: 300px;
      overflow-y: auto;
    }

    .rebalance-item {
      border-bottom: 1px solid var(--theme-border);
      padding: var(--space-md) 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .rebalance-item:last-child {
      border-bottom: none;
    }

    .empty-state {
      text-align: center;
      padding: var(--space-xl);
      color: var(--muted);
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: var(--space-md);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        align-items: stretch;
      }

      .tabs-nav {
        flex-direction: column;
      }

      .tab-button {
        border-bottom: none;
        border-right: 3px solid transparent;
      }

      .tab-button.active {
        border-bottom: none;
        border-right-color: var(--brand-primary);
      }
    }
  </style>
</head>

<body>
  <!-- Header sera injecté par shared-header.js -->

  <div class="container" style="padding-top: var(--space-lg); padding-bottom: var(--space-lg);">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
      <div class="header-content">
        <div class="header-title">
          <h1>📊 Monitoring Dashboard</h1>
          <p class="header-subtitle">Vue unifiée du monitoring financier et technique</p>
        </div>
        <div class="header-controls">
          <button class="btn" onclick="refreshAllData()">
            🔄 Actualiser
          </button>
          <button class="btn secondary" onclick="toggleAutoRefresh()" id="auto-refresh-btn">
            ⏱️ Auto (OFF)
          </button>
          <button class="btn secondary" onclick="exportData()">
            📊 Export
          </button>
        </div>
      </div>
    </div>

    <!-- Tabs Container -->
    <div class="tabs-container">
      <div class="tabs-nav">
        <button class="tab-button active" data-tab="portfolio" onclick="switchTab('portfolio')">
          💰 Portfolio
        </button>
        <button class="tab-button" data-tab="exchanges" onclick="switchTab('exchanges')">
          🔗 Exchanges
        </button>
        <button class="tab-button" data-tab="analytics" onclick="switchTab('analytics')">
          📈 Analytics
        </button>
      </div>

      <div class="tab-content">
        <!-- Portfolio Tab -->
        <div class="tab-pane active" id="portfolio-tab">
          <h2>💰 Portfolio Performance & Health</h2>
          
          <!-- Key Metrics -->
          <div class="grid g3" id="portfolio-metrics">
            <div class="metric-card">
              <div class="metric-label">Valeur Totale</div>
              <div class="metric-value" id="total-value">$--</div>
              <div class="metric-change neutral" id="total-change">-- %</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Déviation Max</div>
              <div class="metric-value" id="max-deviation">--%</div>
              <div class="metric-change neutral" id="deviation-status">Normal</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Dernière Sync</div>
              <div class="metric-value" id="last-sync">--</div>
              <div class="metric-change neutral" id="sync-status">En attente</div>
            </div>
          </div>

          <div class="grid g2">
            <!-- Portfolio Alerts -->
            <div class="card">
              <h3>🚨 Alertes Actives</h3>
              <div id="alerts-container">
                <div class="empty-state">
                  <div class="empty-state-icon">✅</div>
                  <div>Aucune alerte active</div>
                  <div style="font-size: 0.875rem; margin-top: var(--space-xs);">
                    Toutes vos stratégies fonctionnent correctement
                  </div>
                </div>
              </div>
            </div>

            <!-- Rebalance History -->
            <div class="card">
              <h3>🔄 Historique Rééquilibrage</h3>
              <div class="rebalance-history" id="rebalance-history">
                <div class="empty-state">
                  <div class="empty-state-icon">📝</div>
                  <div>Aucun rééquilibrage récent</div>
                  <div style="font-size: 0.875rem; margin-top: var(--space-xs);">
                    L'historique apparaîtra ici après vos premiers rééquilibrages
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Performance Chart -->
          <div class="card">
            <h3>📊 Performance Historique</h3>
            <div class="performance-chart" id="performance-chart">
              Graphique de performance en cours de développement...
            </div>
          </div>

          <!-- Configuration des alertes -->
          <div class="card">
            <h3>⚙️ Configuration des Alertes</h3>
            <div class="grid g2">
              <div>
                <h4>🎯 Seuils de Déviation</h4>
                <div style="margin-bottom: var(--space-md);">
                  <label style="display: block; margin-bottom: var(--space-xs); font-weight: 600;">
                    Alerte si déviation > 
                    <input type="number" id="deviation-threshold" value="5" min="1" max="50" 
                           style="width: 60px; margin: 0 var(--space-xs);"> %
                  </label>
                  <div style="font-size: 0.75rem; color: var(--muted);">
                    Alerte quand un actif dépasse son allocation cible
                  </div>
                </div>
                
                <div style="margin-bottom: var(--space-md);">
                  <label style="display: block; margin-bottom: var(--space-xs); font-weight: 600;">
                    Vérifier toutes les 
                    <select id="check-interval" style="margin: 0 var(--space-xs);">
                      <option value="5">5 minutes</option>
                      <option value="15" selected>15 minutes</option>
                      <option value="30">30 minutes</option>
                      <option value="60">1 heure</option>
                    </select>
                  </label>
                </div>
              </div>

              <div>
                <h4>📧 Notifications</h4>
                <div style="margin-bottom: var(--space-md);">
                  <label style="display: flex; align-items: center; margin-bottom: var(--space-sm);">
                    <input type="checkbox" id="browser-notifications" style="margin-right: var(--space-xs);">
                    Notifications navigateur
                  </label>
                  <label style="display: flex; align-items: center;">
                    <input type="checkbox" id="sound-alerts" style="margin-right: var(--space-xs);">
                    Alertes sonores
                  </label>
                </div>
                
                <button class="btn success" onclick="saveAlertConfig()">
                  💾 Sauvegarder Configuration
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Exchanges Tab -->
        <div class="tab-pane" id="exchanges-tab">
          <h2>🔗 Exchange Health & Connectivity</h2>
          
          <!-- Exchange Status Grid -->
          <div class="card">
            <h3>🌐 État des Connexions</h3>
            <div class="status-grid" id="exchange-status">
              <div class="loading">Chargement du statut des exchanges</div>
            </div>
          </div>

          <div class="grid g2">
            <!-- Technical Alerts -->
            <div class="card">
              <h3>⚠️ Alertes Techniques</h3>
              <div id="technical-alerts">
                <div class="loading">Chargement des alertes techniques</div>
              </div>
            </div>

            <!-- Connection History -->
            <div class="card">
              <h3>📡 Historique Connexions</h3>
              <div class="history-container" id="connection-history">
                <div class="empty-state">
                  <div class="empty-state-icon">📈</div>
                  <div>Historique des connexions</div>
                  <div style="font-size: 0.875rem; margin-top: var(--space-xs);">
                    Les données d'historique seront disponibles prochainement
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Performance Metrics -->
          <div class="card">
            <h3>⚡ Métriques de Performance</h3>
            <div class="grid g3" id="exchange-metrics">
              <div class="loading">Chargement des métriques</div>
            </div>
          </div>
        </div>

        <!-- Analytics Tab -->
        <div class="tab-pane" id="analytics-tab">
          <h2>📈 Analytics & Insights</h2>
          
          <!-- Cross-Analysis -->
          <div class="grid g2">
            <div class="card">
              <h3>🔍 Corrélations</h3>
              <div id="correlations-analysis">
                <div class="loading">Analyse des corrélations</div>
              </div>
            </div>

            <div class="card">
              <h3>📊 Tendances</h3>
              <div id="trends-analysis">
                <div class="loading">Analyse des tendances</div>
              </div>
            </div>
          </div>

          <!-- Strategy Performance -->
          <div class="card">
            <h3>🎯 Performance des Stratégies</h3>
            <div id="strategy-performance">
              <div class="loading">Analyse des stratégies</div>
            </div>
          </div>

          <!-- Global Health Score -->
          <div class="card">
            <h3>💯 Score de Santé Global</h3>
            <div id="health-score">
              <div class="loading">Calcul du score de santé</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===== Global State ===== */
    let currentTab = 'portfolio';
    let autoRefreshInterval = null;
    let isAutoRefreshActive = false;

    /* ===== Helper Functions ===== */
    function el(id) {
      return document.getElementById(id);
    }

    function formatCurrency(value) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(value);
    }



    /* ===== Portfolio Monitoring Functions ===== */
    let monitoringData = {
      metrics: {},
      alerts: [],
      rebalanceHistory: [],
      config: {
        deviationThreshold: 5,
        checkInterval: 15,
        browserNotifications: false,
        soundAlerts: false
      }
    };

    let monitoringInterval = null;

    async function fetchPortfolioData() {
      try {
        console.debug('🔄 Loading REAL CSV data for monitoring consistency');
        return await loadRealCSVPortfolioData();
      } catch (error) {
        console.error('Error loading CSV data for monitoring:', error);
        return null; // Pas de fallback hardcodé
      }
    }

    async function loadRealCSVPortfolioData() {
      console.debug('🔄 Loading monitoring data using configured source...');
      
      const balanceResult = await window.loadBalanceData();
      
      if (!balanceResult.success) {
        console.error('❌ Failed to load balance data:', balanceResult.error);
        throw new Error(balanceResult.error);
      }
      
      let balances;
      
      if (balanceResult.csvText) {
        // Source CSV locale
        balances = window.parseCSVBalances(balanceResult.csvText);
      } else if (balanceResult.data && balanceResult.data.items) {
        // Source API (stub ou cointracking_api)
        balances = balanceResult.data.items.map(item => ({
          symbol: item.symbol,
          balance: item.balance,
          value_usd: item.value_usd
        }));
      } else {
        throw new Error('Invalid data format received');
      }
      
      const totalValue = balances.reduce((sum, item) => sum + item.value_usd, 0);
      
      console.debug(`✅ REAL CSV monitoring data: total: $${totalValue.toFixed(2)}`);
      
      const change24h = 2.34;
      const maxDeviation = 3.2;
      
      return {
        totalValue: totalValue,
        change24h: change24h,
        lastSync: new Date(Date.now() - 18 * 60 * 1000).toISOString(),
        maxDeviation: maxDeviation,
        portfolioStatus: 'healthy'
      };
    }
    
    // CSV parser for monitoring dashboard - SAME as dashboard.html
    function parseCSVBalances(csvText) {
      const cleanedText = csvText.replace(/^\ufeff/, '');
      const lines = cleanedText.split('\n');
      const balances = [];
      
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        try {
          const columns = parseCSVLine(line);
          if (columns.length >= 5) {
            const ticker = columns[0];
            const amount = parseFloat(columns[3]);
            const valueUSD = parseFloat(columns[4]);
            
            if (ticker && !isNaN(amount) && !isNaN(valueUSD) && valueUSD >= 1.0) {
              balances.push({
                symbol: ticker.toUpperCase(),
                balance: amount,
                value_usd: valueUSD
              });
            }
          }
        } catch (error) {
          console.warn('Error parsing CSV line in monitoring dashboard:', error);
        }
      }
      
      return balances;
    }
    
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ';' && !inQuotes) {
          result.push(current.trim().replace(/^"|"$/g, ''));
          current = '';
        } else {
          current += char;
        }
      }
      
      if (current) {
        result.push(current.trim().replace(/^"|"$/g, ''));
      }
      
      return result;
    }

    async function fetchPortfolioAlerts() {
      try {
        const response = await fetch('/api/portfolio/alerts?active_only=true&limit=10');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        return data.alerts || [];
      } catch (error) {
        console.error('Error fetching alerts:', error);
        return [];
      }
    }

    async function fetchRebalanceHistory() {
      try {
        const response = await fetch('/api/portfolio/rebalance-history?days=30&limit=10');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        return data.rebalances || [];
      } catch (error) {
        console.error('Error fetching rebalance history:', error);
        return [];
      }
    }

    function formatPercentage(value) {
      return (value > 0 ? '+' : '') + value.toFixed(2) + '%';
    }

    function timeAgo(timestamp) {
      const now = new Date();
      const time = new Date(timestamp);
      const diffMs = now - time;
      const diffMins = Math.floor(diffMs / (1000 * 60));
      
      if (diffMins < 1) return 'À l\'instant';
      if (diffMins < 60) return `${diffMins}min`;
      if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h`;
      return `${Math.floor(diffMins / 1440)}j`;
    }

    function updateMetrics(data) {
      if (!data) {
        console.warn('No data provided to updateMetrics');
        return;
      }
      
      console.debug('Updating metrics with data:', data);
      
      // Mise à jour de la valeur totale
      const totalValueEl = el('total-value');
      if (totalValueEl) {
        totalValueEl.textContent = formatCurrency(data.totalValue || 0);
      }
      
      // Mise à jour du changement 24h
      const changeEl = el('total-change');
      if (changeEl) {
        changeEl.textContent = formatPercentage(data.change24h || 0);
        changeEl.className = `metric-change ${(data.change24h || 0) >= 0 ? 'positive' : 'negative'}`;
      }
      
      // Mise à jour de la dernière sync
      const lastSyncEl = el('last-sync');
      if (lastSyncEl) {
        lastSyncEl.textContent = timeAgo(data.lastSync);
      }
      
      const syncStatusEl = el('sync-status');
      if (syncStatusEl) {
        syncStatusEl.textContent = 'Synchronisé';
        syncStatusEl.className = 'metric-change positive';
      }
      
      // Mise à jour des déviations
      const maxDeviationEl = el('max-deviation');
      if (maxDeviationEl) {
        maxDeviationEl.textContent = (data.maxDeviation || 0).toFixed(1) + '%';
      }
      
      const deviationEl = el('deviation-status');
      if (deviationEl) {
        if ((data.maxDeviation || 0) > monitoringData.config.deviationThreshold) {
          deviationEl.textContent = 'Alerte';
          deviationEl.className = 'metric-change negative';
        } else {
          deviationEl.textContent = 'Normal';
          deviationEl.className = 'metric-change positive';
        }
      }
      
      console.debug('Metrics updated successfully');
    }

    function renderAlerts() {
      const container = el('alerts-container');
      
      if (monitoringData.alerts.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">✅</div>
            <div>Aucune alerte active</div>
            <div style="font-size: 0.875rem; margin-top: var(--space-xs);">
              Toutes vos stratégies fonctionnent correctement
            </div>
          </div>
        `;
        return;
      }
      
      const alertsHtml = monitoringData.alerts.map(alert => {
        const alertIcon = alert.type === 'critical' ? '🚨' : 
                         alert.type === 'warning' ? '⚠️' : 'ℹ️';
        
        return `
          <div class="alert-item ${alert.type}">
            <div class="alert-icon">${alertIcon}</div>
            <div class="alert-content">
              <div class="alert-title">${alert.title}</div>
              <div class="alert-message">${alert.message}</div>
              <div class="alert-timestamp">${timeAgo(alert.timestamp)}</div>
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = alertsHtml;
    }

    function renderRebalanceHistory() {
      const container = el('rebalance-history');
      
      if (monitoringData.rebalanceHistory.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">📝</div>
            <div>Aucun rééquilibrage récent</div>
            <div style="font-size: 0.875rem; margin-top: var(--space-xs);">
              L'historique apparaîtra ici après vos premiers rééquilibrages
            </div>
          </div>
        `;
        return;
      }
      
      const historyHtml = monitoringData.rebalanceHistory.map(rebalance => {
        const statusClass = rebalance.status === 'completed' ? 'success' : 
                           rebalance.status === 'failed' ? 'danger' : 'warning';
        const statusText = rebalance.status === 'completed' ? 'Terminé' : 
                          rebalance.status === 'failed' ? 'Échoué' : 'En cours';
        
        return `
          <div class="rebalance-item">
            <div>
              <div style="font-weight: 600;">
                <span class="status-dot ${statusClass}"></span>
                ${rebalance.strategy}
              </div>
              <div style="font-size: 0.75rem; color: var(--muted);">
                ${timeAgo(rebalance.timestamp)} - ${rebalance.actions_count} actions
              </div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 0.875rem; font-weight: 600;">
                ${statusText}
              </div>
              <div style="font-size: 0.75rem; color: var(--muted);">
                ${rebalance.duration_seconds}s
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = historyHtml;
    }

    function saveAlertConfig() {
      const deviationEl = el('deviation-threshold');
      const intervalEl = el('check-interval');
      const browserEl = el('browser-notifications');
      const soundEl = el('sound-alerts');
      
      if (deviationEl) monitoringData.config.deviationThreshold = parseInt(deviationEl.value);
      if (intervalEl) monitoringData.config.checkInterval = parseInt(intervalEl.value);
      if (browserEl) monitoringData.config.browserNotifications = browserEl.checked;
      if (soundEl) monitoringData.config.soundAlerts = soundEl.checked;
      
      localStorage.setItem('monitoring-config', JSON.stringify(monitoringData.config));
      
      if (monitoringData.config.browserNotifications && Notification.permission !== 'granted') {
        Notification.requestPermission();
      }
      
      startPortfolioMonitoring();
      alert('Configuration sauvegardée !');
    }

    async function fetchAndUpdatePortfolio() {
      try {
        const data = await fetchPortfolioData();
        if (data) {
          updateMetrics(data);
        }
        
        const alerts = await fetchPortfolioAlerts();
        monitoringData.alerts = alerts;
        renderAlerts();
        
        const history = await fetchRebalanceHistory();
        monitoringData.rebalanceHistory = history;
        renderRebalanceHistory();
        
      } catch (error) {
        console.error('Error in fetchAndUpdatePortfolio:', error);
      }
    }

    function startPortfolioMonitoring() {
      if (monitoringInterval) {
        clearInterval(monitoringInterval);
      }
      
      fetchAndUpdatePortfolio();
      
      monitoringInterval = setInterval(
        fetchAndUpdatePortfolio, 
        monitoringData.config.checkInterval * 60 * 1000
      );
    }

    /* ===== Tab Management ===== */
    function switchTab(tabName) {
      console.debug('Switching to tab:', tabName);
      
      // Update UI
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
      
      const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
      const tabPane = document.getElementById(`${tabName}-tab`);
      
      if (tabButton) {
        tabButton.classList.add('active');
        console.debug('Tab button activated:', tabName);
      } else {
        console.error('Tab button not found for:', tabName);
      }
      
      if (tabPane) {
        tabPane.classList.add('active');
        console.debug('Tab pane activated:', tabName);
      } else {
        console.error('Tab pane not found for:', tabName);
      }
      
      currentTab = tabName;
      
      // Load tab-specific data
      loadTabData(tabName);
    }

    /* ===== Data Loading Functions ===== */
    async function loadTabData(tabName) {
      switch (tabName) {
        case 'portfolio':
          await loadPortfolioData();
          break;
        case 'exchanges':
          await loadExchangesData();
          break;
        case 'analytics':
          await loadAnalyticsData();
          break;
      }
    }

    async function loadPortfolioData() {
      console.debug('Loading portfolio data...');
      await fetchAndUpdatePortfolio();
    }

    async function loadExchangesData() {
      try {
        // Try to load real exchange health data
        let health = null;
        try {
          const healthResponse = await fetch('/api/monitoring/health');
          if (healthResponse.ok) {
            health = await healthResponse.json();
          }
        } catch (e) {
          console.debug('Real API not available, using mock data');
        }
        
        // Use mock data if API not available
        if (!health) {
          health = getMockExchangeData();
        }
        
        renderExchangeStatus(health);
        
        // Load technical alerts
        let alerts = [];
        try {
          const alertsResponse = await fetch('/api/monitoring/alerts?resolved=false');
          if (alertsResponse.ok) {
            const data = await alertsResponse.json();
            alerts = data.alerts || [];
          }
        } catch (e) {
          // Use mock alerts if API not available
          alerts = getMockAlerts();
        }
        
        renderTechnicalAlerts(alerts);
        
        // Load exchange metrics
        renderExchangeMetrics(health);
        
      } catch (error) {
        console.error('Error loading exchanges data:', error);
        showError('exchanges', 'Erreur de chargement des données exchanges');
      }
    }
    
    function getMockExchangeData() {
      return {
        exchanges: {
          'binance': {
            status: 'healthy',
            connection_stability: 99.5,
            response_time_ms: 95,
            response_trend: 'stable',
            success_rate_1h: 99.8,
            uptime_percentage: 99.9,
            error_count_1h: 0
          },
          'kraken': {
            status: 'healthy', 
            connection_stability: 97.2,
            response_time_ms: 156,
            response_trend: 'improving',
            success_rate_1h: 98.5,
            uptime_percentage: 98.7,
            error_count_1h: 2
          },
          'coinbase': {
            status: 'warning',
            connection_stability: 89.1,
            response_time_ms: 245,
            response_trend: 'degrading',
            success_rate_1h: 94.2,
            uptime_percentage: 96.3,
            error_count_1h: 8
          },
          'simulator': {
            status: 'healthy',
            connection_stability: 100.0,
            response_time_ms: 12,
            response_trend: 'stable',
            success_rate_1h: 100.0,
            uptime_percentage: 100.0,
            error_count_1h: 0
          }
        }
      };
    }
    
    function getMockAlerts() {
      return [
        {
          id: '1',
          level: 'warning',
          exchange: 'coinbase',
          message: 'Temps de réponse élevé détecté (>200ms)',
          timestamp: new Date(Date.now() - 1000 * 60 * 15).toISOString(),
          resolved: false
        },
        {
          id: '2',
          level: 'info',
          exchange: 'kraken',
          message: 'Amélioration des performances détectée',
          timestamp: new Date(Date.now() - 1000 * 60 * 60).toISOString(),
          resolved: false
        }
      ];
    }

    async function loadAnalyticsData() {
      try {
        // Simulate loading analytics data
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Generate mock analytics data
        const analyticsData = generateAnalyticsData();
        
        renderCorrelationsAnalysis(analyticsData.correlations);
        renderTrendsAnalysis(analyticsData.trends);
        renderStrategyPerformance(analyticsData.strategies);
        renderHealthScore(analyticsData.healthScore);
        
      } catch (error) {
        console.error('Error loading analytics data:', error);
        showError('analytics', 'Erreur de chargement des données analytiques');
      }
    }
    
    function generateAnalyticsData() {
      const now = Date.now();
      return {
        correlations: {
          portfolioVsMarket: 0.85,
          exchangeHealthVsPerf: 0.72,
          rebalanceFreqVsReturns: -0.23
        },
        trends: {
          portfolioGrowth: 2.34,
          exchangeReliability: 98.2,
          rebalanceEfficiency: 87.5
        },
        strategies: {
          'Strategic (Dynamic)': {
            success_rate: 94.2,
            avg_performance_24h: 1.85,
            total_executions: 12,
            avg_duration: 45
          },
          'Conservative': {
            success_rate: 98.7,
            avg_performance_24h: 0.95,
            total_executions: 8,
            avg_duration: 28
          },
          'Aggressive': {
            success_rate: 89.3,
            avg_performance_24h: 3.21,
            total_executions: 6,
            avg_duration: 67
          }
        },
        healthScore: {
          overall: 87.3,
          portfolio: 91.2,
          technical: 85.7,
          risk: 84.9
        }
      };
    }
    
    function renderCorrelationsAnalysis(correlations) {
      const container = el('correlations-analysis');
      
      container.innerHTML = `
        <div class="grid" style="grid-template-columns: 1fr; gap: var(--space-md);">
          <div class="metric-card">
            <div class="metric-label">Portfolio vs Marché</div>
            <div class="metric-value">${correlations.portfolioVsMarket.toFixed(2)}</div>
            <div class="metric-change ${correlations.portfolioVsMarket > 0.7 ? 'positive' : 'warning'}">Corrélation forte</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Santé vs Performance</div>
            <div class="metric-value">${correlations.exchangeHealthVsPerf.toFixed(2)}</div>
            <div class="metric-change ${correlations.exchangeHealthVsPerf > 0.6 ? 'positive' : 'warning'}">Modérée</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Fréquence vs Rendement</div>
            <div class="metric-value">${correlations.rebalanceFreqVsReturns.toFixed(2)}</div>
            <div class="metric-change ${Math.abs(correlations.rebalanceFreqVsReturns) < 0.3 ? 'neutral' : 'warning'}">Faible</div>
          </div>
        </div>
        <div style="margin-top: var(--space-md); padding: var(--space-md); background: var(--theme-surface-elevated); border-radius: var(--radius-md); font-size: 0.8125rem; color: var(--accent); border: 1px solid var(--theme-border);">
          <strong>Insight:</strong> Forte corrélation portfolio-marché indique une diversification à optimiser.
        </div>
      `;
    }
    
    function renderTrendsAnalysis(trends) {
      const container = el('trends-analysis');
      
      container.innerHTML = `
        <div class="grid" style="grid-template-columns: 1fr; gap: var(--space-md);">
          <div class="metric-card">
            <div class="metric-label">Croissance Portfolio</div>
            <div class="metric-value">${formatPercentage(trends.portfolioGrowth)}</div>
            <div class="metric-change ${trends.portfolioGrowth > 0 ? 'positive' : 'negative'}">7 jours</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Fiabilité Exchanges</div>
            <div class="metric-value">${trends.exchangeReliability.toFixed(1)}%</div>
            <div class="metric-change ${trends.exchangeReliability > 95 ? 'positive' : 'warning'}">Moyenne</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Efficacité Rebalancing</div>
            <div class="metric-value">${trends.rebalanceEfficiency.toFixed(1)}%</div>
            <div class="metric-change ${trends.rebalanceEfficiency > 80 ? 'positive' : 'warning'}">Global</div>
          </div>
        </div>
        <div style="margin-top: var(--space-md); padding: var(--space-md); background: var(--theme-surface-elevated); border-radius: var(--radius-md); font-size: 0.8125rem; color: var(--pos); border: 1px solid var(--theme-border);">
          <strong>Tendance:</strong> Performance globale en amélioration avec des exchanges stables.
        </div>
      `;
    }
    
    function renderHealthScore(healthScore) {
      const container = el('health-score');
      
      const getScoreColor = (score) => {
        if (score >= 90) return 'var(--pos)';
        if (score >= 75) return 'var(--warning)';
        return 'var(--neg)';
      };
      
      const getScoreClass = (score) => {
        if (score >= 90) return 'positive';
        if (score >= 75) return 'warning';
        return 'negative';
      };
      
      container.innerHTML = `
        <div style="text-align: center; margin-bottom: var(--space-lg);">
          <div style="font-size: 3rem; font-weight: 700; color: ${getScoreColor(healthScore.overall)}; margin-bottom: var(--space-sm);">
            ${healthScore.overall.toFixed(1)}/100
          </div>
          <div style="font-size: 1.125rem; font-weight: 600; color: var(--muted); margin-bottom: var(--space-md);">
            Score de Santé Global
          </div>
        </div>
        
        <div class="grid g3">
          <div class="metric-card">
            <div class="metric-label">Portfolio</div>
            <div class="metric-value">${healthScore.portfolio.toFixed(1)}</div>
            <div class="metric-change ${getScoreClass(healthScore.portfolio)}">Excellent</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Technique</div>
            <div class="metric-value">${healthScore.technical.toFixed(1)}</div>
            <div class="metric-change ${getScoreClass(healthScore.technical)}">Bon</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Risque</div>
            <div class="metric-value">${healthScore.risk.toFixed(1)}</div>
            <div class="metric-change ${getScoreClass(healthScore.risk)}">Acceptable</div>
          </div>
        </div>
        
        <div style="margin-top: var(--space-lg); padding: var(--space-md); background: var(--theme-surface-elevated); border-radius: var(--radius-md); font-size: 0.8125rem; color: var(--theme-text-muted); border: 1px solid var(--theme-border);">
          <strong>Méthodologie:</strong> Score calculé sur la performance portfolio (40%), stabilité technique (35%), et gestion des risques (25%).
        </div>
      `;
    }

    /* ===== Rendering Functions ===== */



    function getTrendIndicator(trend) {
      const trends = {
        'stable': '➡️',
        'improving': '⬆️', 
        'degrading': '⬇️',
        'critical': '⚠️'
      };
      return trends[trend] || '➡️';
    }
    
    function renderExchangeStatus(health) {
      const container = el('exchange-status');
      const exchanges = health.exchanges || {};
      
      if (Object.keys(exchanges).length === 0) {
        container.innerHTML = `
          <div class="loading">Chargement du statut des exchanges...</div>
        `;
        return;
      }
      
      container.innerHTML = Object.entries(exchanges).map(([name, status]) => {
        const statusClass = status.status === 'healthy' ? 'healthy' : 
                           status.status === 'warning' ? 'warning' : 
                           status.status === 'degraded' ? 'warning' : 'error';
        const responseTrend = getTrendIndicator(status.response_trend);
        
        return `
          <div class="status-item" style="flex-direction: column; align-items: flex-start; padding: var(--space-lg);">
            <div style="display: flex; align-items: center; width: 100%; margin-bottom: var(--space-sm);">
              <div class="status-dot ${statusClass}"></div>
              <div class="status-info" style="margin-left: var(--space-sm);">
                <div class="status-name" style="font-size: 1rem; font-weight: 600;">${name.toUpperCase()}</div>
                <div class="status-details" style="font-size: 0.875rem;">Status: ${status.status} • Stabilité: ${status.connection_stability}%</div>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-md); width: 100; font-size: 0.8125rem;">
              <div style="text-align: center;">
                <div style="font-weight: 600; margin-bottom: 2px;">${Math.round(status.response_time_ms || 0)}ms ${responseTrend}</div>
                <div style="color: var(--muted);">Réponse</div>
              </div>
              <div style="text-align: center;">
                <div style="font-weight: 600; margin-bottom: 2px;">${(status.success_rate_1h || 0).toFixed(1)}%</div>
                <div style="color: var(--muted);">Succès 1h</div>
              </div>
              <div style="text-align: center;">
                <div style="font-weight: 600; margin-bottom: 2px;">${(status.uptime_percentage || 0).toFixed(1)}%</div>
                <div style="color: var(--muted);">Uptime</div>
              </div>
              <div style="text-align: center;">
                <div style="font-weight: 600; margin-bottom: 2px; color: ${status.error_count_1h > 0 ? 'var(--neg)' : 'var(--pos)'}">${status.error_count_1h || 0}</div>
                <div style="color: var(--muted);">Erreurs 1h</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function renderExchangeMetrics(health) {
      const container = el('exchange-metrics');
      const exchanges = health.exchanges || {};
      
      // Calculate aggregate metrics
      const totalExchanges = Object.keys(exchanges).length;
      const healthyCount = Object.values(exchanges).filter(e => e.status === 'healthy').length;
      const avgResponseTime = Object.values(exchanges).reduce((sum, e) => sum + (e.response_time_ms || 0), 0) / totalExchanges;
      const avgUptime = Object.values(exchanges).reduce((sum, e) => sum + (e.uptime_percentage || 0), 0) / totalExchanges;
      const totalErrors = Object.values(exchanges).reduce((sum, e) => sum + (e.error_count_1h || 0), 0);
      
      container.innerHTML = `
        <div class="metric-card">
          <div class="metric-label">Exchanges Santé</div>
          <div class="metric-value">${healthyCount}/${totalExchanges}</div>
          <div class="metric-change ${healthyCount === totalExchanges ? 'positive' : 'warning'}">${Math.round((healthyCount/totalExchanges)*100)}%</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Temps Réponse Moy</div>
          <div class="metric-value">${Math.round(avgResponseTime)}ms</div>
          <div class="metric-change ${avgResponseTime < 150 ? 'positive' : avgResponseTime < 300 ? 'neutral' : 'negative'}">Global</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Uptime Moyen</div>
          <div class="metric-value">${avgUptime.toFixed(1)}%</div>
          <div class="metric-change ${avgUptime > 98 ? 'positive' : avgUptime > 95 ? 'neutral' : 'negative'}">24h</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Erreurs Totales</div>
          <div class="metric-value">${totalErrors}</div>
          <div class="metric-change ${totalErrors === 0 ? 'positive' : totalErrors < 10 ? 'neutral' : 'negative'}">Dernière heure</div>
        </div>
      `;
    }

    function renderTechnicalAlerts(alerts) {
      const container = el('technical-alerts');
      
      if (alerts.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">✅</div>
            <div>Aucune alerte technique</div>
            <div style="font-size: 0.875rem; margin-top: var(--space-xs);">
              Toutes les connexions exchanges fonctionnent normalement
            </div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = alerts.map(alert => {
        const alertIcon = alert.level === 'critical' ? '🚨' : 
                         alert.level === 'warning' ? '⚠️' : 
                         alert.level === 'info' ? 'ℹ️' : '🔔';
        const alertType = alert.level === 'info' ? 'info' : 
                         alert.level === 'critical' ? 'critical' : 'warning';
        
        return `
          <div class="alert-item ${alertType}">
            <div class="alert-icon">${alertIcon}</div>
            <div class="alert-content">
              <div class="alert-title">${alert.exchange.toUpperCase()} - ${alert.level.toUpperCase()}</div>
              <div class="alert-message">${alert.message}</div>
              <div class="alert-timestamp">${timeAgo(alert.timestamp)}</div>
            </div>
          </div>
        `;
      }).join('');
    }


    function renderStrategyPerformance(strategies) {
      const container = el('strategy-performance');
      
      if (!strategies || Object.keys(strategies).length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">📊</div>
            <div>Aucune donnée de stratégie disponible</div>
            <div style="font-size: 0.875rem; margin-top: var(--space-xs);">
              Les statistiques apparaîtront après quelques exécutions
            </div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = `
        <div class="grid g3">
          ${Object.entries(strategies).map(([name, stats]) => `
            <div class="metric-card">
              <div class="metric-label">${name}</div>
              <div class="metric-value">${stats.success_rate || 0}%</div>
              <div class="metric-change ${(stats.avg_performance_24h || 0) >= 0 ? 'positive' : 'negative'}">
                ${formatPercentage(stats.avg_performance_24h || 0)} avg
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function showError(tab, message) {
      const container = el(`${tab}-tab`);
      if (container) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">❌</div>
            <div>${message}</div>
            <button class="btn" onclick="loadTabData('${tab}')">Réessayer</button>
          </div>
        `;
      }
    }

    /* ===== Control Functions ===== */
    async function refreshAllData() {
      await loadTabData(currentTab);
      console.debug('Data refreshed for tab:', currentTab);
    }

    function toggleAutoRefresh() {
      const btn = el('auto-refresh-btn');
      
      if (isAutoRefreshActive) {
        clearInterval(autoRefreshInterval);
        isAutoRefreshActive = false;
        btn.textContent = '⏱️ Auto (OFF)';
        btn.className = 'btn secondary';
      } else {
        autoRefreshInterval = setInterval(refreshAllData, 30000);
        isAutoRefreshActive = true;
        btn.textContent = '⏹️ Auto (ON)';
        btn.className = 'btn success';
      }
    }

    function exportData() {
      // Placeholder for export functionality
      alert('Export functionality coming soon!');
    }

    /* ===== Initialization ===== */
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize shared header avec le bon ID de page
      initSharedHeader('monitoring-unified', { showConfigIndicators: false });
      
      // Appliquer le thème depuis la configuration globale - forcer l'application
      console.debug('Initializing theme for monitoring dashboard...');
      if (window.globalConfig && window.globalConfig.applyTheme) {
        window.globalConfig.applyTheme();
      }
      if (window.applyAppearance) {
        window.applyAppearance();
      }
      console.debug('Current theme after initialization:', document.documentElement.getAttribute('data-theme'));
      
      // Load alert configuration
      const saved = localStorage.getItem('monitoring-config');
      if (saved) {
        try {
          monitoringData.config = { ...monitoringData.config, ...JSON.parse(saved) };
        } catch (error) {
          console.error('Error loading config:', error);
        }
      }
      
      // Start portfolio monitoring (for real-time updates)
      console.debug('Starting portfolio monitoring...');
      startPortfolioMonitoring();
      
      // Load initial data for current tab
      console.debug('Loading initial data for tab:', currentTab);
      setTimeout(() => {
        loadTabData(currentTab);
      }, 500);
      
      // Load real data immediately if CSV available
      setTimeout(async () => {
        console.debug('Loading real CSV data for immediate display');
        try {
          const realData = await loadRealCSVPortfolioData();
          updateMetrics(realData);
        } catch (error) {
          console.debug('CSV not available for immediate display');
        }
      }, 100);
      
      // Écouter les changements de thème pour synchronisation
      window.addEventListener('storage', function(e) {
        if (e.key === 'crypto_rebalancer_settings') {
          console.debug('Settings changed, reapplying theme...');
          setTimeout(() => {
            if (window.globalConfig && window.globalConfig.applyTheme) {
              window.globalConfig.applyTheme();
            }
            if (window.applyAppearance) {
              window.applyAppearance();
            }
          }, 100);
        }
      });
      
      console.debug('Unified Monitoring Dashboard initialized with theme:', document.documentElement.getAttribute('data-theme'));
    });
  </script>
</body>
</html>
