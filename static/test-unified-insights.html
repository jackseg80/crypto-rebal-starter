<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>🧠 Test Unified Insights</title>
    <link rel="stylesheet" href="shared-theme.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: var(--theme-surface);
            border-radius: var(--radius-md);
        }
        .test-section {
            margin: 1rem 0;
            padding: 1rem;
            background: var(--theme-bg);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--primary);
        }
        .success { border-left-color: var(--success); }
        .error { border-left-color: var(--danger); }
        pre {
            font-size: 0.85rem;
            background: var(--theme-surface);
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            overflow: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🧠 Test Unified Insights</h1>
        <div id="test-results">Loading tests...</div>
        <button onclick="runTests()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer;">
            🔄 Run Tests Again
        </button>
    </div>

    <script type="module">
        import { getUnifiedState, deriveRecommendations } from './core/unified-insights.js';
        import { store } from './core/risk-dashboard-store.js';

        window.runTests = async function() {
            const resultsEl = document.getElementById('test-results');
            resultsEl.innerHTML = '<div>Running tests...</div>';
            
            const tests = [];

            // Test 1: Store initialization
            try {
                const storeState = store.snapshot();
                tests.push({
                    name: '🗄️ Store State',
                    success: true,
                    data: {
                        has_scores: !!storeState.scores,
                        has_cycle: !!storeState.cycle,
                        has_risk: !!storeState.risk,
                        has_ccs: !!storeState.ccs
                    }
                });
            } catch (error) {
                tests.push({
                    name: '🗄️ Store State',
                    success: false,
                    error: error.message
                });
            }

            // Initialize minimal data for testing
            store.set('cycle.months', 18);
            store.set('cycle.score', 65);
            store.set('scores.onchain', 72);
            store.set('scores.risk', 45);
            store.set('scores.blended', 68);
            store.set('ccs.signals', {
                fear_greed: { value: 48 },
                btc_dominance: { value: 57.5 },
                funding_rate: { value: 0.0001 }
            });

            // Test 2: Unified State
            try {
                const unifiedState = await getUnifiedState();
                tests.push({
                    name: '🧠 Unified State',
                    success: true,
                    data: {
                        decision_score: unifiedState.decision?.score,
                        decision_confidence: unifiedState.decision?.confidence,
                        cycle_score: unifiedState.cycle?.score,
                        cycle_phase: unifiedState.cycle?.phase?.phase,
                        onchain_score: unifiedState.onchain?.score,
                        risk_score: unifiedState.risk?.score,
                        regime_name: unifiedState.regime?.name,
                        intelligence_modules: unifiedState.health?.intelligence_modules
                    }
                });
            } catch (error) {
                tests.push({
                    name: '🧠 Unified State',
                    success: false,
                    error: error.message,
                    stack: error.stack
                });
            }

            // Test 3: Recommendations
            try {
                const unifiedState = await getUnifiedState();
                const recommendations = deriveRecommendations(unifiedState);
                tests.push({
                    name: '💡 Recommendations',
                    success: true,
                    data: {
                        count: recommendations.length,
                        recommendations: recommendations.map(r => ({
                            priority: r.priority,
                            title: r.title,
                            source: r.source
                        }))
                    }
                });
            } catch (error) {
                tests.push({
                    name: '💡 Recommendations',
                    success: false,
                    error: error.message,
                    stack: error.stack
                });
            }

            // Render results
            resultsEl.innerHTML = tests.map(test => `
                <div class="test-section ${test.success ? 'success' : 'error'}">
                    <h3>${test.name} ${test.success ? '✅' : '❌'}</h3>
                    ${test.success ? 
                        `<pre>${JSON.stringify(test.data, null, 2)}</pre>` :
                        `<div style="color: var(--danger); margin-bottom: 0.5rem;">Error: ${test.error}</div>
                         ${test.stack ? `<pre style="font-size: 0.75rem; color: var(--theme-text-muted);">${test.stack}</pre>` : ''}`
                    }
                </div>
            `).join('');
        };

        // Auto-run on load
        window.addEventListener('load', () => {
            setTimeout(runTests, 500);
        });
    </script>
</body>
</html>