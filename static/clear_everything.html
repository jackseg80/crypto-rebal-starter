<!DOCTYPE html>
<html>
<head>
    <title>Clear Everything</title>
</head>
<body>
    <h1>Clear Everything and Test</h1>
    <button onclick="clearEverything()">Clear All Cache & Storage</button>
    <button onclick="setCSVAndTest()">Set CSV_0 and Test</button>
    <button onclick="forceRefreshTest()">Force Refresh Test</button>

    <pre id="output"></pre>

    <script src="/static/global-config.js"></script>
    <script>
        function log(msg) {
            const output = document.getElementById('output');
            output.textContent += new Date().toLocaleTimeString() + ': ' + msg + '\n';
            console.log(msg);
        }

        function clearEverything() {
            // Clear localStorage completely
            localStorage.clear();

            // Clear all caches if available
            if (typeof window.clearBalanceCache === 'function') {
                window.clearBalanceCache();
            }

            // Reset global config
            if (typeof globalConfig !== 'undefined') {
                globalConfig.reset();
            }

            log('Everything cleared');
        }

        async function setCSVAndTest() {
            log('=== Setting CSV and Testing ===');

            // Set user and source
            localStorage.setItem('activeUser', 'demo');
            globalConfig.set('data_source', 'csv_0');

            log(`User: ${localStorage.getItem('activeUser')}`);
            log(`Source: ${globalConfig.get('data_source')}`);

            try {
                // Test direct API call
                const response = await fetch('/balances/current?source=csv_0', {
                    headers: { 'X-User': 'demo' }
                });
                const directData = await response.json();
                log(`Direct API: ${directData.items?.length || 0} items, source: ${directData.source_used}`);

                // Test loadBalanceData
                if (typeof window.loadBalanceData === 'function') {
                    const result = await window.loadBalanceData(true); // Force refresh
                    log(`loadBalanceData: success=${result.success}, items=${result.data?.items?.length || 0}, source=${result.source}`);
                    if (result.data?.items?.length > 0) {
                        log(`First item: ${result.data.items[0].symbol} - $${result.data.items[0].value_usd}`);
                    }
                } else {
                    log('loadBalanceData function not found');
                }
            } catch (error) {
                log(`ERROR: ${error.message}`);
            }
        }

        async function forceRefreshTest() {
            log('=== Force Refresh Test ===');
            try {
                if (typeof window.refreshBalanceData === 'function') {
                    const result = await window.refreshBalanceData();
                    log(`refreshBalanceData result: ${JSON.stringify(result)}`);
                } else {
                    log('refreshBalanceData function not found');
                }
            } catch (error) {
                log(`ERROR: ${error.message}`);
            }
        }
    </script>
</body>
</html>