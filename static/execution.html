<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üöÄ Ex√©cution - Crypto Rebalancer</title>
  
  <style>
    :root {
      --primary: #2563eb;
      --success: #059669;
      --warning: #d97706;
      --danger: #dc2626;
      --muted: #64748b;
      --border: #e2e8f0;
      --bg-light: #f8fafc;
      --text: #1e293b;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      line-height: 1.6;
      color: var(--text);
      background: #f8fafc;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 24px;
      border-left: 4px solid var(--primary);
    }

    .header h1 {
      color: var(--primary);
      margin-bottom: 8px;
      font-size: 2rem;
    }

    .header p {
      color: var(--muted);
      font-size: 1.1rem;
    }

    .section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 24px;
      overflow: hidden;
    }

    .section-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-light);
    }

    .section-header h2 {
      color: var(--text);
      font-size: 1.5rem;
      margin-bottom: 4px;
    }

    .section-header p {
      color: var(--muted);
    }

    .section-content {
      padding: 24px;
    }

    .tab-nav {
      display: flex;
      border-bottom: 1px solid var(--border);
      background: var(--bg-light);
    }

    .tab-button {
      padding: 16px 24px;
      background: none;
      border: none;
      cursor: pointer;
      font-weight: 500;
      color: var(--muted);
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .tab-button.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      background: white;
    }

    .tab-content {
      display: none;
      padding: 24px;
    }

    .tab-content.active {
      display: block;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .status-pending { background: #fef3c7; color: #92400e; }
    .status-executing { background: #dbeafe; color: #1d4ed8; }
    .status-completed { background: #d1fae5; color: #065f46; }
    .status-failed { background: #fee2e2; color: #991b1b; }
    .status-cancelled { background: #f3f4f6; color: #374151; }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      margin: 16px 0;
    }

    .progress-fill {
      height: 100%;
      background: var(--success);
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    .grid {
      display: grid;
      gap: 20px;
    }

    .grid-2 {
      grid-template-columns: 1fr 1fr;
    }

    .grid-3 {
      grid-template-columns: 1fr 1fr 1fr;
    }

    .metric-card {
      background: var(--bg-light);
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .metric-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
    }

    .metric-label {
      color: var(--muted);
      font-size: 0.875rem;
    }

    .orders-table {
      width: 100%;
      border-collapse: collapse;
    }

    .orders-table th,
    .orders-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .orders-table th {
      background: var(--bg-light);
      font-weight: 600;
      color: var(--text);
    }

    .amount-positive { color: var(--success); }
    .amount-negative { color: var(--danger); }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .alert {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .alert-info {
      background: #dbeafe;
      color: #1e40af;
      border-left: 4px solid #3b82f6;
    }

    .alert-success {
      background: #d1fae5;
      color: #065f46;
      border-left: 4px solid #059669;
    }

    .alert-warning {
      background: #fef3c7;
      color: #92400e;
      border-left: 4px solid #d97706;
    }

    .alert-danger {
      background: #fee2e2;
      color: #991b1b;
      border-left: 4px solid #dc2626;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text);
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
    }

    .form-textarea {
      resize: vertical;
      min-height: 120px;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .real-trading-warning {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      border: 2px solid var(--danger);
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
    }

    .real-trading-warning h3 {
      color: var(--danger);
      margin-bottom: 12px;
      font-size: 1.25rem;
    }

    .real-trading-warning ul {
      color: #7f1d1d;
      margin-left: 20px;
    }

    @media (max-width: 768px) {
      .grid-2, .grid-3 {
        grid-template-columns: 1fr;
      }
      
      .tab-nav {
        flex-wrap: wrap;
      }
      
      .orders-table {
        font-size: 0.875rem;
      }
    }
  </style>
</head>

<body>
  <!-- Header sera inject√© par shared-header.js -->

  <div class="container">
    <div class="header">
      <h1>üöÄ Ex√©cution de Plans</h1>
      <p>Validation, ex√©cution et monitoring en temps r√©el de vos plans de rebalancement</p>
    </div>

    <!-- Navigation par onglets -->
    <div class="section">
      <div class="tab-nav">
        <button class="tab-button active" onclick="switchTab('create')">
          üìù Cr√©er Plan
        </button>
        <button class="tab-button" onclick="switchTab('monitor')">
          üìä Monitoring
        </button>
        <button class="tab-button" onclick="switchTab('history')">
          üìú Historique
        </button>
        <button class="tab-button" onclick="switchTab('exchanges')">
          üè¢ Exchanges
        </button>
      </div>

      <!-- Onglet Cr√©ation de Plan -->
      <div id="tab-create" class="tab-content active">
        <div class="alert alert-info">
          <strong>‚ÑπÔ∏è Information :</strong> Importez un plan de rebalancement existant ou saisissez les actions manuellement.
        </div>

        <div class="form-group">
          <label class="form-label">Plan de Rebalancement (JSON)</label>
          <textarea 
            id="rebalance-actions" 
            class="form-input form-textarea" 
            placeholder='[{"symbol": "BTC", "action": "sell", "usd": -1000, "exec_hint": "Sell on Binance"}, ...]'
          ></textarea>
          <small style="color: var(--muted);">
            Collez ici les actions g√©n√©r√©es par le module de rebalancement
          </small>
        </div>

        <div class="grid grid-2">
          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="dry-run" checked>
              <label for="dry-run" class="form-label">Mode Simulation (Dry Run)</label>
            </div>
            <small style="color: var(--muted);">
              Recommand√© pour les tests. Aucun ordre r√©el ne sera pass√©.
            </small>
          </div>

          <div class="form-group">
            <label class="form-label">Ordres Parall√®les Max</label>
            <input type="number" id="max-parallel" class="form-input" value="3" min="1" max="10">
          </div>
        </div>

        <div id="real-trading-warning" class="real-trading-warning" style="display: none;">
          <h3>‚ö†Ô∏è ATTENTION - Mode Trading R√©el</h3>
          <p><strong>Vous allez ex√©cuter des ordres r√©els avec de l'argent r√©el !</strong></p>
          <ul>
            <li>V√©rifiez soigneusement toutes les actions avant validation</li>
            <li>Assurez-vous que vos cl√©s API sont correctement configur√©es</li>
            <li>Surveillez l'ex√©cution en temps r√©el</li>
            <li>Gardez des liquidit√©s suffisantes sur les exchanges</li>
          </ul>
        </div>

        <div class="grid grid-2">
          <button class="btn btn-primary" onclick="validatePlan()">
            üîç Valider Plan
          </button>
          <button class="btn btn-success" onclick="createAndExecutePlan()" disabled id="execute-btn">
            üöÄ Cr√©er et Ex√©cuter
          </button>
        </div>

        <div id="validation-result" style="margin-top: 20px;"></div>
      </div>

      <!-- Onglet Monitoring -->
      <div id="tab-monitor" class="tab-content">
        <div class="grid grid-3">
          <div class="metric-card">
            <div class="metric-value" id="active-executions">0</div>
            <div class="metric-label">Ex√©cutions Actives</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="total-volume">$0</div>
            <div class="metric-label">Volume Total</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="success-rate">0%</div>
            <div class="metric-label">Taux de Succ√®s</div>
          </div>
        </div>

        <div id="active-plans-container" style="margin-top: 24px;">
          <!-- Les plans actifs seront inject√©s ici -->
        </div>

        <button class="btn btn-primary" onclick="refreshMonitoring()">
          üîÑ Actualiser
        </button>
      </div>

      <!-- Onglet Historique -->
      <div id="tab-history" class="tab-content">
        <div id="plans-history-container">
          <!-- L'historique sera inject√© ici -->
        </div>

        <button class="btn btn-primary" onclick="loadPlansHistory()">
          üìú Charger Historique
        </button>
      </div>

      <!-- Onglet Exchanges -->
      <div id="tab-exchanges" class="tab-content">
        <div class="alert alert-info">
          <strong>üè¢ Exchanges Configur√©s :</strong> Statut des adaptateurs d'exchange disponibles
        </div>

        <div id="exchanges-container">
          <!-- La liste des exchanges sera inject√©e ici -->
        </div>

        <div class="grid grid-2">
          <button class="btn btn-primary" onclick="loadExchanges()">
            üîÑ Actualiser Exchanges
          </button>
          <button class="btn btn-success" onclick="connectExchanges()">
            üîó Connecter Tous
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="/static/global-config.js"></script>
  <script src="/static/shared-header.js"></script>
  <script>
    // Configuration globale d√©j√† charg√©e par global-config.js
    // const globalConfig est d√©j√† disponible
    let validatedPlan = null;
    let activeMonitoring = null;

    // ========== UTILITAIRES ==========

    function formatUSD(value) {
      if (value === null || value === undefined) return '$0.00';
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(value);
    }

    function formatPercent(value) {
      if (value === null || value === undefined) return '0.0%';
      return `${value.toFixed(1)}%`;
    }

    function formatTimestamp(isoString) {
      if (!isoString) return 'N/A';
      return new Date(isoString).toLocaleString('fr-FR');
    }

    function getStatusBadgeClass(status) {
      const statusMap = {
        'pending': 'status-pending',
        'executing': 'status-executing', 
        'completed': 'status-completed',
        'failed': 'status-failed',
        'cancelled': 'status-cancelled'
      };
      return statusMap[status] || 'status-pending';
    }

    function showAlert(container, type, message) {
      container.innerHTML = `
        <div class="alert alert-${type}">
          ${message}
        </div>
      `;
    }

    // ========== NAVIGATION ONGLETS ==========

    function switchTab(tabName) {
      // Masquer tous les onglets
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // D√©sactiver tous les boutons
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Activer l'onglet s√©lectionn√©
      document.getElementById(`tab-${tabName}`).classList.add('active');
      event.target.classList.add('active');
      
      // Charger les donn√©es selon l'onglet
      switch(tabName) {
        case 'monitor':
          refreshMonitoring();
          break;
        case 'history':
          loadPlansHistory();
          break;
        case 'exchanges':
          loadExchanges();
          break;
      }
    }

    // ========== GESTION DRY RUN ==========

    document.getElementById('dry-run').addEventListener('change', function() {
      const warning = document.getElementById('real-trading-warning');
      if (this.checked) {
        warning.style.display = 'none';
      } else {
        warning.style.display = 'block';
      }
    });

    // ========== VALIDATION DE PLAN ==========

    async function validatePlan() {
      const actionsText = document.getElementById('rebalance-actions').value.trim();
      const resultContainer = document.getElementById('validation-result');
      
      if (!actionsText) {
        showAlert(resultContainer, 'warning', 'Veuillez saisir les actions de rebalancement');
        return;
      }
      
      try {
        const parsedInput = JSON.parse(actionsText);
        
        // Support two formats: direct actions array or complete execution data
        let actions, metadata;
        if (Array.isArray(parsedInput)) {
          // Format 1: Direct actions array
          actions = parsedInput;
          metadata = {
            source: 'manual_input',
            timestamp: new Date().toISOString()
          };
        } else if (parsedInput.rebalance_actions) {
          // Format 2: Complete execution data from rebalance export
          actions = parsedInput.rebalance_actions;
          metadata = parsedInput.metadata || {
            source: 'imported_plan',
            timestamp: new Date().toISOString()
          };
        } else {
          throw new Error('Format JSON invalide. Attendu: array d\'actions ou objet avec rebalance_actions');
        }
        
        const response = await globalConfig.apiRequest('/execution/validate-plan', {
          method: 'POST',
          body: JSON.stringify({
            rebalance_actions: actions,
            metadata: metadata
          })
        });
        
        if (response.valid) {
          validatedPlan = response;
          document.getElementById('execute-btn').disabled = false;
          
          resultContainer.innerHTML = `
            <div class="alert alert-success">
              <strong>‚úÖ Plan Valid√© avec Succ√®s</strong><br>
              üìä <strong>${response.total_orders}</strong> ordres ‚Ä¢ 
              üí∞ <strong>${formatUSD(response.total_volume)}</strong> volume total<br>
              ${response.large_orders_count > 0 ? `‚ö†Ô∏è ${response.large_orders_count} gros ordres d√©tect√©s` : ''}
            </div>
          `;
          
          if (response.warnings.length > 0) {
            resultContainer.innerHTML += `
              <div class="alert alert-warning">
                <strong>‚ö†Ô∏è Avertissements :</strong><br>
                ${response.warnings.map(w => `‚Ä¢ ${w}`).join('<br>')}
              </div>
            `;
          }
        } else {
          resultContainer.innerHTML = `
            <div class="alert alert-danger">
              <strong>‚ùå Erreurs de Validation :</strong><br>
              ${response.errors.map(e => `‚Ä¢ ${e}`).join('<br>')}
            </div>
          `;
        }
        
      } catch (error) {
        console.error('Validation error:', error);
        showAlert(resultContainer, 'danger', `Erreur de validation: ${error.message}`);
      }
    }

    // ========== CR√âATION ET EX√âCUTION ==========

    async function createAndExecutePlan() {
      if (!validatedPlan) {
        alert('Veuillez d\'abord valider le plan');
        return;
      }
      
      const dryRun = document.getElementById('dry-run').checked;
      const maxParallel = parseInt(document.getElementById('max-parallel').value);
      
      // Confirmation pour le mode r√©el
      if (!dryRun) {
        const confirmed = confirm(
          '‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\n' +
          'Vous allez ex√©cuter des ordres r√©els avec de l\'argent r√©el !\n\n' +
          `${validatedPlan.total_orders} ordres ‚Ä¢ ${formatUSD(validatedPlan.total_volume)} volume\n\n` +
          '√ätes-vous s√ªr de vouloir continuer ?'
        );
        
        if (!confirmed) return;
      }
      
      try {
        // Ex√©cuter le plan
        const response = await globalConfig.apiRequest(`/execution/execute-plan?plan_id=${validatedPlan.plan_id}&dry_run=${dryRun}&max_parallel=${maxParallel}`, {
          method: 'POST'
        });
        
        if (response.success) {
          // Basculer vers l'onglet monitoring
          switchTab('monitor');
          
          // D√©marrer le monitoring en temps r√©el
          startRealTimeMonitoring(response.plan_id);
          
          alert(`üöÄ Ex√©cution lanc√©e !\n\nPlan: ${response.plan_id}\nMode: ${dryRun ? 'Simulation' : 'Trading R√©el'}`);
        }
        
      } catch (error) {
        console.error('Execution error:', error);
        alert(`Erreur d'ex√©cution: ${error.message}`);
      }
    }

    // ========== MONITORING TEMPS R√âEL ==========

    function startRealTimeMonitoring(planId) {
      // Arr√™ter le monitoring pr√©c√©dent
      if (activeMonitoring) {
        clearInterval(activeMonitoring);
      }
      
      // Monitoring toutes les 2 secondes
      activeMonitoring = setInterval(async () => {
        try {
          const progress = await globalConfig.apiRequest(`/execution/status/${planId}`);
          updateMonitoringDisplay(planId, progress);
        } catch (error) {
          console.error('Monitoring error:', error);
          // Arr√™ter le monitoring en cas d'erreur persistante
          clearInterval(activeMonitoring);
        }
      }, 2000);
    }

    function updateMonitoringDisplay(planId, progress) {
      const container = document.getElementById('active-plans-container');
      
      const statusClass = getStatusBadgeClass(progress.status);
      const isActive = progress.is_active;
      
      container.innerHTML = `
        <div class="section">
          <div class="section-header">
            <h3>Plan ${planId}</h3>
            <span class="status-badge ${statusClass}">
              ${isActive ? 'üü¢' : '‚ö™'} ${progress.status.toUpperCase()}
            </span>
          </div>
          <div class="section-content">
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progress.completion_percentage || 0}%"></div>
            </div>
            
            <div class="grid grid-3">
              <div class="metric-card">
                <div class="metric-value">${progress.completed_orders}/${progress.total_orders}</div>
                <div class="metric-label">Ordres Compl√©t√©s</div>
              </div>
              <div class="metric-card">
                <div class="metric-value">${formatPercent(progress.success_rate)}</div>
                <div class="metric-label">Taux de Succ√®s</div>
              </div>
              <div class="metric-card">
                <div class="metric-value">${formatUSD(progress.volume_executed)}</div>
                <div class="metric-label">Volume Ex√©cut√©</div>
              </div>
            </div>
            
            ${progress.failed_orders > 0 ? `
              <div class="alert alert-warning">
                ‚ö†Ô∏è ${progress.failed_orders} ordre(s) en √©chec
              </div>
            ` : ''}
            
            <div style="margin-top: 16px;">
              <button class="btn btn-primary" onclick="showPlanDetails('${planId}')">
                üìã D√©tails des Ordres
              </button>
              ${isActive ? `
                <button class="btn btn-danger" onclick="cancelExecution('${planId}')">
                  ‚õî Annuler Ex√©cution
                </button>
              ` : ''}
            </div>
          </div>
        </div>
      `;
      
      // Arr√™ter le monitoring si termin√©
      if (!isActive && progress.status !== 'executing') {
        clearInterval(activeMonitoring);
        activeMonitoring = null;
      }
    }

    // ========== AUTRES FONCTIONS ==========

    async function refreshMonitoring() {
      try {
        const stats = await globalConfig.apiRequest('/execution/pipeline-status');
        
        document.getElementById('active-executions').textContent = stats.active_executions;
        document.getElementById('total-volume').textContent = formatUSD(stats.statistics.total_volume || 0);
        document.getElementById('success-rate').textContent = formatPercent(stats.statistics.success_rate || 0);
        
        if (stats.active_plan_ids.length === 0) {
          document.getElementById('active-plans-container').innerHTML = `
            <div class="alert alert-info">
              ‚ÑπÔ∏è Aucune ex√©cution active actuellement
            </div>
          `;
        }
        
      } catch (error) {
        console.error('Monitoring refresh error:', error);
      }
    }

    async function loadPlansHistory() {
      try {
        const response = await globalConfig.apiRequest('/execution/plans?limit=20');
        const container = document.getElementById('plans-history-container');
        
        if (response.plans.length === 0) {
          container.innerHTML = `
            <div class="alert alert-info">
              üìú Aucun plan d'ex√©cution dans l'historique
            </div>
          `;
          return;
        }
        
        const plansHtml = response.plans.map(plan => `
          <div class="section" style="margin-bottom: 16px;">
            <div class="section-content">
              <div class="grid grid-2">
                <div>
                  <strong>${plan.plan_id}</strong><br>
                  <span class="status-badge ${getStatusBadgeClass(plan.status)}">
                    ${plan.status.toUpperCase()}
                  </span>
                </div>
                <div style="text-align: right;">
                  <div><strong>${formatUSD(plan.total_volume)}</strong></div>
                  <div style="color: var(--muted);">${plan.total_orders} ordres</div>
                </div>
              </div>
              <div style="margin-top: 8px; font-size: 0.875rem; color: var(--muted);">
                Cr√©√©: ${formatTimestamp(plan.created_at)}
              </div>
            </div>
          </div>
        `).join('');
        
        container.innerHTML = plansHtml;
        
      } catch (error) {
        console.error('History loading error:', error);
      }
    }

    async function loadExchanges() {
      try {
        const response = await globalConfig.apiRequest('/execution/exchanges');
        const container = document.getElementById('exchanges-container');
        
        const exchangesHtml = response.exchanges.map(exchange => `
          <div class="section" style="margin-bottom: 16px;">
            <div class="section-content">
              <div class="grid grid-2">
                <div>
                  <strong>${exchange.name}</strong><br>
                  <span style="color: var(--muted);">${exchange.type}</span>
                </div>
                <div style="text-align: right;">
                  <span class="status-badge ${exchange.connected ? 'status-completed' : 'status-pending'}">
                    ${exchange.connected ? 'üü¢ Connect√©' : 'üî¥ D√©connect√©'}
                  </span><br>
                  <small style="color: var(--muted);">
                    Frais: ${(exchange.config.fee_rate * 100).toFixed(2)}% ‚Ä¢ 
                    Min: ${formatUSD(exchange.config.min_order_size)}
                  </small>
                </div>
              </div>
            </div>
          </div>
        `).join('');
        
        container.innerHTML = exchangesHtml;
        
      } catch (error) {
        console.error('Exchanges loading error:', error);
      }
    }

    async function connectExchanges() {
      try {
        const response = await globalConfig.apiRequest('/execution/exchanges/connect', {
          method: 'POST'
        });
        
        alert(response.message);
        loadExchanges(); // Actualiser la liste
        
      } catch (error) {
        console.error('Connect exchanges error:', error);
        alert(`Erreur de connexion: ${error.message}`);
      }
    }

    async function cancelExecution(planId) {
      const confirmed = confirm(`√ätes-vous s√ªr de vouloir annuler l'ex√©cution du plan ${planId} ?`);
      if (!confirmed) return;
      
      try {
        await globalConfig.apiRequest(`/execution/cancel/${planId}`, {
          method: 'POST'
        });
        
        alert('Annulation demand√©e. Les ordres en cours vont se terminer.');
        refreshMonitoring();
        
      } catch (error) {
        console.error('Cancel execution error:', error);
        alert(`Erreur d'annulation: ${error.message}`);
      }
    }

    function showPlanDetails(planId) {
      // Ouvrir les d√©tails dans une nouvelle fen√™tre ou modal
      window.open(`/static/execution-details.html?plan_id=${planId}`, '_blank');
    }

    // ========== INITIALISATION ==========

    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Execution interface DOM loaded');
      
      // Initialiser le header partag√©
      initSharedHeader('execution');
      
      // Charger les √©changes par d√©faut
      loadExchanges();
      
      // Exemple pr√©-rempli
      document.getElementById('rebalance-actions').value = JSON.stringify([
        {"symbol": "BTC", "action": "sell", "usd": -1000, "exec_hint": "Sell on Binance", "group": "BTC"},
        {"symbol": "ETH", "action": "buy", "usd": 500, "exec_hint": "Buy on Kraken", "group": "ETH"},
        {"symbol": "SOL", "action": "buy", "usd": 500, "exec_hint": "Buy on Binance", "group": "SOL"}
      ], null, 2);
    });
  </script>
</body>
</html>