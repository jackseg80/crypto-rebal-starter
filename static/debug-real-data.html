<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Debug Real Data Sources</title>
    <link rel="stylesheet" href="shared-theme.css">
    <link rel="stylesheet" href="theme-compat.css">
    <script type="module" src="components/nav.js"></script>

    <style>
        body {
            font-family: system-ui;
            background: var(--theme-background);
            color: var(--theme-text);
            margin: 0;
            padding: 2rem;
        }

        .debug-section {
            background: var(--theme-surface);
            border: 1px solid var(--theme-border);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .data-display {
            background: var(--theme-bg);
            border: 1px solid var(--theme-border);
            border-radius: 4px;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.85rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 1rem 0;
        }

        .status-ok { color: var(--success); }
        .status-error { color: var(--danger); }
        .status-warning { color: var(--warning); }

        .api-test {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 1rem;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid var(--theme-border);
        }

        .api-test:last-child {
            border-bottom: none;
        }

        button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-md);
            background: var(--theme-surface);
            color: var(--theme-text);
            cursor: pointer;
        }

        button:hover {
            background: var(--brand-primary);
            color: white;
        }
    </style>
</head>
<body>
    <div style="max-width: 1200px; margin: 0 auto;">
        <h1>üîç Debug Sources de Donn√©es R√©elles</h1>
        <p>Diagnostic des sources de donn√©es disponibles pour le badge global.</p>

        <!-- Global Stores -->
        <div class="debug-section">
            <h2>üìä Stores Globaux</h2>
            <div id="stores-status">‚è≥ Analysing...</div>
            <div class="data-display" id="stores-data"></div>
            <button onclick="analyzeStores()">üîç Analyser Stores</button>
        </div>

        <!-- API Endpoints -->
        <div class="debug-section">
            <h2>üåê APIs Disponibles</h2>
            <div id="api-tests">
                <div class="api-test">
                    <span>Governance Status</span>
                    <span class="status-warning" id="api-governance-status">Untested</span>
                    <button onclick="testGovernanceAPI()">Test</button>
                </div>
                <div class="api-test">
                    <span>ML Signals</span>
                    <span class="status-warning" id="api-ml-status">Untested</span>
                    <button onclick="testMLAPI()">Test</button>
                </div>
                <div class="api-test">
                    <span>Risk Dashboard</span>
                    <span class="status-warning" id="api-risk-status">Untested</span>
                    <button onclick="testRiskAPI()">Test</button>
                </div>
                <div class="api-test">
                    <span>Balances</span>
                    <span class="status-warning" id="api-balances-status">Untested</span>
                    <button onclick="testBalancesAPI()">Test</button>
                </div>
            </div>
            <div class="data-display" id="api-responses"></div>
        </div>

        <!-- Current Badge Data -->
        <div class="debug-section">
            <h2>üè∑Ô∏è Badge Actuel avec Donn√©es R√©elles</h2>
            <div style="margin: 1rem 0; padding: 1rem; background: var(--theme-bg); border-radius: 4px; text-align: center;">
                <div id="real-badge"></div>
            </div>
            <button onclick="debugBadgeData()">üîç Debug Badge Data</button>
            <div class="data-display" id="badge-debug"></div>
        </div>

        <!-- Live Updates Test -->
        <div class="debug-section">
            <h2>üîÑ Test Mises √† Jour Temps R√©el</h2>
            <div id="live-updates">
                <p>Monitoring des √©v√©nements en temps r√©el...</p>
                <div class="data-display" id="events-log"></div>
                <button onclick="clearEventsLog()">Clear Log</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { renderBadges, getDecisionSource, getUpdatedTs, getContradiction, computeEffectiveCap, getOverridesCount, getBackendStatus } from './components/Badges.js';

        let eventsLog = [];

        function logEvent(message) {
            const timestamp = new Date().toLocaleTimeString('fr-FR');
            eventsLog.push(`[${timestamp}] ${message}`);
            document.getElementById('events-log').textContent = eventsLog.join('\n');
        }

        window.clearEventsLog = () => {
            eventsLog = [];
            document.getElementById('events-log').textContent = '';
        };

        // Analyze available stores
        window.analyzeStores = () => {
            const storesData = document.getElementById('stores-data');
            const storesStatus = document.getElementById('stores-status');

            let analysis = 'ANALYSE DES STORES GLOBAUX:\n\n';
            let foundStores = 0;

            // Check window.store
            if (window.store) {
                foundStores++;
                analysis += `‚úÖ window.store trouv√©\n`;
                analysis += `   Type: ${typeof window.store}\n`;
                if (typeof window.store.snapshot === 'function') {
                    analysis += `   ‚úÖ store.snapshot() disponible\n`;
                    try {
                        const snapshot = window.store.snapshot();
                        analysis += `   √âtat actuel: ${JSON.stringify(snapshot, null, 2).substring(0, 300)}...\n\n`;
                    } catch (e) {
                        analysis += `   ‚ö†Ô∏è Erreur snapshot: ${e.message}\n\n`;
                    }
                }
                if (typeof window.store.subscribe === 'function') {
                    analysis += `   ‚úÖ store.subscribe() disponible\n`;
                }
            } else {
                analysis += `‚ùå window.store non trouv√©\n\n`;
            }

            // Check globalConfig
            if (window.globalConfig) {
                foundStores++;
                analysis += `‚úÖ window.globalConfig trouv√©\n`;
                analysis += `   API Base: ${window.globalConfig.get?.('api_base_url') || 'N/A'}\n`;
                analysis += `   Data Source: ${window.globalConfig.get?.('data_source') || 'N/A'}\n\n`;
            } else {
                analysis += `‚ùå window.globalConfig non trouv√©\n\n`;
            }

            // Check other globals
            ['governancePanel', 'riskDashboardBadges', 'wealthContextBar'].forEach(global => {
                if (window[global]) {
                    foundStores++;
                    analysis += `‚úÖ window.${global} trouv√©\n`;
                } else {
                    analysis += `‚ùå window.${global} non trouv√©\n`;
                }
            });

            storesData.textContent = analysis;
            storesStatus.className = foundStores > 0 ? 'status-ok' : 'status-error';
            storesStatus.textContent = `${foundStores} stores trouv√©s`;

            logEvent(`Stores analysis: ${foundStores} sources found`);
        };

        // Test API endpoints
        async function testAPI(endpoint, statusId, description) {
            const statusEl = document.getElementById(statusId);
            const responsesEl = document.getElementById('api-responses');

            statusEl.textContent = 'Testing...';
            statusEl.className = 'status-warning';

            try {
                let url = endpoint;
                if (window.globalConfig?.getApiUrl) {
                    url = window.globalConfig.getApiUrl(endpoint);
                } else if (window.globalConfig?.get) {
                    const base = window.globalConfig.get('api_base_url') || 'http://localhost:8000';
                    url = base + endpoint;
                }

                const response = await fetch(url);
                const data = await response.json();

                statusEl.textContent = `‚úÖ ${response.status}`;
                statusEl.className = 'status-ok';

                responsesEl.textContent += `\n\n=== ${description} ===\n`;
                responsesEl.textContent += `URL: ${url}\n`;
                responsesEl.textContent += `Status: ${response.status}\n`;
                responsesEl.textContent += `Response: ${JSON.stringify(data, null, 2).substring(0, 500)}...\n`;

                logEvent(`${description}: SUCCESS (${response.status})`);
                return data;

            } catch (error) {
                statusEl.textContent = `‚ùå ${error.message}`;
                statusEl.className = 'status-error';

                responsesEl.textContent += `\n\n=== ${description} ERROR ===\n`;
                responsesEl.textContent += `Error: ${error.message}\n`;

                logEvent(`${description}: ERROR - ${error.message}`);
                return null;
            }
        }

        window.testGovernanceAPI = () => testAPI('/api/governance/status', 'api-governance-status', 'Governance API');
        window.testMLAPI = () => testAPI('/api/ml/signals', 'api-ml-status', 'ML Signals API');
        window.testRiskAPI = () => testAPI('/api/risk/dashboard', 'api-risk-status', 'Risk Dashboard API');
        window.testBalancesAPI = () => testAPI('/balances/current', 'api-balances-status', 'Balances API');

        // Debug current badge data
        window.debugBadgeData = () => {
            const debugEl = document.getElementById('badge-debug');
            const badgeEl = document.getElementById('real-badge');

            // Get current state
            const state = window.store?.snapshot?.() || window.store?.getState?.() || window.globalStore || {};

            let debug = 'ANALYSE DES DONN√âES BADGE ACTUELLES:\n\n';

            try {
                const source = getDecisionSource(state);
                const updated = getUpdatedTs(state);
                const contradiction = getContradiction(state);
                const cap = computeEffectiveCap(state);
                const overrides = getOverridesCount(state);
                const status = getBackendStatus(state);

                debug += `Source: "${source}"\n`;
                debug += `Updated: "${updated}"\n`;
                debug += `Contradiction: ${contradiction}%\n`;
                debug += `Cap: ${cap}%\n`;
                debug += `Overrides: ${overrides}\n`;
                debug += `Status: "${status}"\n\n`;

                debug += `√âtat brut:\n${JSON.stringify(state, null, 2)}`;

                // Render badge with current data
                renderBadges(badgeEl);

                logEvent('Badge data analyzed and refreshed');

            } catch (error) {
                debug += `ERREUR: ${error.message}\n`;
                debug += `Stack: ${error.stack}`;
            }

            debugEl.textContent = debug;
        };

        // Setup event listeners
        document.addEventListener('DOMContentLoaded', () => {
            logEvent('Debug page loaded');

            // Auto-analyze stores
            setTimeout(analyzeStores, 1000);

            // Listen for real events
            ['governance:updated', 'ml:signals:updated', 'wealth:change'].forEach(eventName => {
                window.addEventListener(eventName, (event) => {
                    logEvent(`Event: ${eventName} - ${JSON.stringify(event.detail || {}).substring(0, 100)}`);
                });
            });

            // Store change listener
            if (window.store?.subscribe) {
                window.store.subscribe(() => {
                    logEvent('Store state changed');
                });
            }

            logEvent('Event listeners setup complete');
        });
    </script>
</body>
</html>