<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Strategy API Migration - PR-C</title>
  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">
  <style>
    .migration-test {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .test-section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-secondary);
    }
    
    .comparison-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    
    .result-panel {
      padding: 15px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg-primary);
    }
    
    .result-panel h4 {
      margin-top: 0;
      color: var(--text-primary);
    }
    
    .score-display {
      font-size: 2em;
      font-weight: bold;
      margin: 10px 0;
    }
    
    .legacy-score { color: var(--warning); }
    .api-score { color: var(--success); }
    
    .metadata {
      font-size: 0.9em;
      color: var(--text-secondary);
      margin-top: 10px;
    }
    
    .targets-list {
      list-style: none;
      padding: 0;
    }
    
    .targets-list li {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid var(--border);
    }
    
    .test-controls {
      margin: 20px 0;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .test-controls button {
      padding: 8px 16px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--accent);
      color: white;
      cursor: pointer;
    }
    
    .test-controls button:hover {
      background: var(--accent-hover);
    }
    
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .error {
      color: var(--danger);
      background: rgba(244, 67, 54, 0.1);
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    
    .templates-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .template-card {
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg-primary);
      text-align: center;
      cursor: pointer;
      transition: border-color 0.3s;
    }
    
    .template-card:hover {
      border-color: var(--accent);
    }
    
    .template-card.selected {
      border-color: var(--success);
      background: rgba(76, 175, 80, 0.1);
    }
  </style>
</head>
<body>
  <div class="migration-test">
    <h1>🚀 Strategy API Migration Test - PR-C</h1>
    <p>Test et validation de la migration de <code>calculateIntelligentDecisionIndex</code> vers l'API Strategy.</p>
    
    <!-- Section contrôles de migration -->
    <div class="test-section">
      <h2>Contrôles de Migration</h2>
      <div id="migration-controls-container"></div>
    </div>
    
    <!-- Section templates disponibles -->
    <div class="test-section">
      <h2>Templates Strategy Disponibles</h2>
      <div id="templates-loading">Chargement des templates...</div>
      <div id="templates-grid" class="templates-grid" style="display: none;"></div>
    </div>
    
    <!-- Section comparaison legacy vs API -->
    <div class="test-section">
      <h2>Comparaison Legacy vs Strategy API</h2>
      
      <div class="test-controls">
        <button id="test-both">Test Legacy + API</button>
        <button id="test-api-only">Test API Seulement</button>
        <button id="test-templates">Comparer Templates</button>
        <button id="clear-cache">Clear Cache</button>
      </div>
      
      <div id="comparison-results" style="display: none;">
        <div class="comparison-grid">
          <div class="result-panel">
            <h4>🔴 Legacy (Frontend)</h4>
            <div id="legacy-results">
              <div class="score-display legacy-score" id="legacy-score">--</div>
              <div class="metadata" id="legacy-metadata">En attente...</div>
              <ul class="targets-list" id="legacy-targets"></ul>
            </div>
          </div>
          
          <div class="result-panel">
            <h4>🚀 Strategy API (Backend)</h4>
            <div id="api-results">
              <div class="score-display api-score" id="api-score">--</div>
              <div class="metadata" id="api-metadata">En attente...</div>
              <ul class="targets-list" id="api-targets"></ul>
            </div>
          </div>
        </div>
        
        <div class="result-panel" style="margin-top: 20px;">
          <h4>📊 Comparaison et Analyse</h4>
          <div id="comparison-analysis"></div>
        </div>
      </div>
    </div>
    
    <!-- Section test unified state -->
    <div class="test-section">
      <h2>Test Unified State (Intégration Complète)</h2>
      
      <div class="test-controls">
        <button id="test-unified-v1">Test Unified V1 (Legacy)</button>
        <button id="test-unified-v2">Test Unified V2 (API)</button>
        <button id="toggle-comparison-logging">Toggle Comparison Logging</button>
      </div>
      
      <div id="unified-results" class="result-panel" style="display: none;">
        <pre id="unified-output"></pre>
      </div>
    </div>
    
    <!-- Section logs et debug -->
    <div class="test-section">
      <h2>Logs et Debug</h2>
      <div class="test-controls">
        <button id="clear-logs">Clear Logs</button>
        <button id="export-results">Export Results</button>
      </div>
      <pre id="debug-logs" style="background: var(--bg-primary); padding: 15px; border-radius: 4px; font-size: 12px; max-height: 300px; overflow-y: auto;"></pre>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module" src="global-config.js"></script>
  <script type="module">
    import { createMigrationControls } from './components/MigrationControls.js';
    import { calculateIntelligentDecisionIndexAPI, getAvailableStrategyTemplates, compareStrategyTemplates, StrategyConfig } from './core/strategy-api-adapter.js';
    import { calculateIntelligentDecisionIndex as legacyCalculation } from './core/unified-insights.js';
    import { getUnifiedState as getUnifiedStateV1 } from './core/unified-insights.js';
    import { getUnifiedState as getUnifiedStateV2 } from './core/unified-insights-v2.js';

    // Références DOM
    const migrationControlsContainer = document.getElementById('migration-controls-container');
    const templatesLoading = document.getElementById('templates-loading');
    const templatesGrid = document.getElementById('templates-grid');
    const comparisonResults = document.getElementById('comparison-results');
    const legacyScore = document.getElementById('legacy-score');
    const apiScore = document.getElementById('api-score');
    const legacyMetadata = document.getElementById('legacy-metadata');
    const apiMetadata = document.getElementById('api-metadata');
    const legacyTargets = document.getElementById('legacy-targets');
    const apiTargets = document.getElementById('api-targets');
    const comparisonAnalysis = document.getElementById('comparison-analysis');
    const unifiedResults = document.getElementById('unified-results');
    const unifiedOutput = document.getElementById('unified-output');
    const debugLogs = document.getElementById('debug-logs');

    // État de l'application
    let selectedTemplate = 'balanced';
    let templates = {};
    let comparisonLoggingEnabled = false;

    // Logger pour debug
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
      debugLogs.textContent += logEntry;
      debugLogs.scrollTop = debugLogs.scrollHeight;
      
      if (type === 'error') {
        console.error(message);
      } else {
        console.log(message);
      }
    }

    // Initialiser les contrôles de migration
    createMigrationControls(migrationControlsContainer);
    log('Migration controls initialized');

    // Charger les templates disponibles
    async function loadTemplates() {
      try {
        templates = await getAvailableStrategyTemplates();
        templatesLoading.style.display = 'none';
        templatesGrid.style.display = 'grid';
        
        templatesGrid.innerHTML = '';
        Object.entries(templates).forEach(([id, info]) => {
          const card = document.createElement('div');
          card.className = 'template-card';
          if (id === selectedTemplate) card.classList.add('selected');
          
          card.innerHTML = `
            <h4>${info.name}</h4>
            <p>${info.risk_level}</p>
            <small>${id}</small>
          `;
          
          card.addEventListener('click', () => {
            document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selectedTemplate = id;
            StrategyConfig.setDefaultTemplate(id);
            log(`Template selected: ${id}`);
          });
          
          templatesGrid.appendChild(card);
        });
        
        log(`Loaded ${Object.keys(templates).length} templates`);
      } catch (error) {
        log(`Failed to load templates: ${error.message}`, 'error');
        templatesLoading.innerHTML = '<div class="error">Erreur chargement templates</div>';
      }
    }

    // Données de contexte simulées pour les tests
    function createTestContext() {
      return {
        blendedScore: 65.5,
        cycleData: {
          months: 18,
          score: 70,
          phase: { phase: 'expansion', description: 'Expansion phase' },
          confidence: 0.7,
          multipliers: {}
        },
        regimeData: {
          regime: { name: 'Bull Moderate', emoji: '📈', confidence: 0.8 },
          recommendations: [
            { priority: 'medium', message: 'Maintenir allocation risquée' }
          ]
        },
        signalsData: {
          interpretation: 'bullish',
          confidence: 0.7,
          signals_strength: 'medium'
        },
        onchainScore: 72,
        onchainConfidence: 0.75,
        riskScore: 45,
        contradiction: 0.2
      };
    }

    // Test comparaison legacy vs API
    async function testBothMethods() {
      const testBtn = document.getElementById('test-both');
      testBtn.classList.add('loading');
      testBtn.disabled = true;
      comparisonResults.style.display = 'block';
      
      try {
        log('Starting legacy vs API comparison test');
        const context = createTestContext();
        
        // Test legacy
        log('Testing legacy calculation...');
        const legacyStart = performance.now();
        const legacyResult = legacyCalculation(context);
        const legacyTime = performance.now() - legacyStart;
        
        // Test API
        log('Testing API calculation...');
        const apiStart = performance.now();
        const apiResult = await calculateIntelligentDecisionIndexAPI(context);
        const apiTime = performance.now() - apiStart;
        
        // Afficher les résultats
        displayComparisonResults(legacyResult, legacyTime, apiResult, apiTime);
        
        log('Comparison test completed successfully');
      } catch (error) {
        log(`Comparison test failed: ${error.message}`, 'error');
      } finally {
        testBtn.classList.remove('loading');
        testBtn.disabled = false;
      }
    }

    // Afficher les résultats de comparaison
    function displayComparisonResults(legacyResult, legacyTime, apiResult, apiTime) {
      // Scores
      legacyScore.textContent = legacyResult.score?.toFixed(1) || '--';
      apiScore.textContent = apiResult.score?.toFixed(1) || '--';
      
      // Metadata
      legacyMetadata.innerHTML = `
        <div>Confiance: ${(legacyResult.confidence * 100)?.toFixed(1) || '--'}%</div>
        <div>Temps: ${legacyTime.toFixed(1)}ms</div>
        <div>Source: Frontend calculation</div>
        <div>Reasoning: ${legacyResult.reasoning || 'N/A'}</div>
      `;
      
      apiMetadata.innerHTML = `
        <div>Confiance: ${(apiResult.confidence * 100)?.toFixed(1) || '--'}%</div>
        <div>Temps: ${apiTime.toFixed(1)}ms</div>
        <div>Source: ${apiResult.source || 'N/A'}</div>
        <div>Template: ${apiResult.template_used || 'N/A'}</div>
        <div>Policy: ${apiResult.policy_hint || 'N/A'}</div>
      `;
      
      // Targets (API only)
      legacyTargets.innerHTML = '<li>Pas de targets legacy</li>';
      apiTargets.innerHTML = '';
      if (apiResult.targets) {
        apiResult.targets.forEach(target => {
          const li = document.createElement('li');
          li.innerHTML = `
            <span>${target.symbol}</span>
            <span>${(target.weight * 100).toFixed(1)}%</span>
          `;
          apiTargets.appendChild(li);
        });
      }
      
      // Analyse comparative
      const scoreDiff = Math.abs((legacyResult.score || 0) - (apiResult.score || 0));
      const confidenceDiff = Math.abs((legacyResult.confidence || 0) - (apiResult.confidence || 0));
      
      comparisonAnalysis.innerHTML = `
        <div>Différence de score: ${scoreDiff.toFixed(2)} points</div>
        <div>Différence de confiance: ${(confidenceDiff * 100).toFixed(1)}%</div>
        <div>Performance: API ${apiTime < legacyTime ? 'plus rapide' : 'plus lente'} (${Math.abs(apiTime - legacyTime).toFixed(1)}ms)</div>
        <div>Cohérence: ${scoreDiff < 10 ? '✅ Élevée' : scoreDiff < 20 ? '⚠️ Modérée' : '❌ Faible'}</div>
      `;
    }

    // Test API seulement
    async function testAPIOnly() {
      const testBtn = document.getElementById('test-api-only');
      testBtn.classList.add('loading');
      testBtn.disabled = true;
      
      try {
        log(`Testing API with template: ${selectedTemplate}`);
        StrategyConfig.setDefaultTemplate(selectedTemplate);
        
        const context = createTestContext();
        const result = await calculateIntelligentDecisionIndexAPI(context);
        
        apiScore.textContent = result.score?.toFixed(1) || '--';
        apiMetadata.innerHTML = `
          <div>Template: ${result.template_used || 'N/A'}</div>
          <div>Policy: ${result.policy_hint || 'N/A'}</div>
          <div>Source: ${result.source || 'N/A'}</div>
        `;
        
        comparisonResults.style.display = 'block';
        log('API-only test completed');
      } catch (error) {
        log(`API test failed: ${error.message}`, 'error');
      } finally {
        testBtn.classList.remove('loading');
        testBtn.disabled = false;
      }
    }

    // Test comparaison templates
    async function testTemplatesComparison() {
      const testBtn = document.getElementById('test-templates');
      testBtn.classList.add('loading');
      
      try {
        log('Comparing all templates...');
        const templateIds = Object.keys(templates);
        const comparison = await compareStrategyTemplates(templateIds);
        
        let analysisHtml = '<h5>Comparaison Templates:</h5>';
        Object.entries(comparison.comparisons || {}).forEach(([id, data]) => {
          if (data.error) {
            analysisHtml += `<div>${id}: ❌ ${data.error}</div>`;
          } else {
            analysisHtml += `<div>${id}: ${data.decision_score?.toFixed(1) || 'N/A'} (${data.policy_hint || 'N/A'})</div>`;
          }
        });
        
        comparisonAnalysis.innerHTML = analysisHtml;
        comparisonResults.style.display = 'block';
        log('Templates comparison completed');
      } catch (error) {
        log(`Templates comparison failed: ${error.message}`, 'error');
      } finally {
        testBtn.classList.remove('loading');
      }
    }

    // Test unified state
    async function testUnifiedState(version) {
      const isV2 = version === 'v2';
      const testBtn = document.getElementById(`test-unified-${version}`);
      testBtn.classList.add('loading');
      
      try {
        log(`Testing unified state ${version}...`);
        
        const startTime = performance.now();
        const state = isV2 ? await getUnifiedStateV2() : await getUnifiedStateV1();
        const endTime = performance.now();
        
        unifiedOutput.textContent = JSON.stringify({
          version: version,
          execution_time_ms: (endTime - startTime).toFixed(1),
          decision_score: state.decision?.score,
          confidence: state.decision?.confidence,
          strategy_info: state.strategy || null,
          health: state.health,
          migration_status: state.intelligence?.migration_status || 'legacy'
        }, null, 2);
        
        unifiedResults.style.display = 'block';
        log(`Unified state ${version} test completed in ${(endTime - startTime).toFixed(1)}ms`);
      } catch (error) {
        log(`Unified state ${version} test failed: ${error.message}`, 'error');
        unifiedOutput.textContent = `Error: ${error.message}`;
        unifiedResults.style.display = 'block';
      } finally {
        testBtn.classList.remove('loading');
      }
    }

    // Event listeners
    document.getElementById('test-both').addEventListener('click', testBothMethods);
    document.getElementById('test-api-only').addEventListener('click', testAPIOnly);
    document.getElementById('test-templates').addEventListener('click', testTemplatesComparison);
    document.getElementById('clear-cache').addEventListener('click', () => {
      StrategyConfig.clearCache();
      log('Cache cleared');
    });
    
    document.getElementById('test-unified-v1').addEventListener('click', () => testUnifiedState('v1'));
    document.getElementById('test-unified-v2').addEventListener('click', () => testUnifiedState('v2'));
    document.getElementById('toggle-comparison-logging').addEventListener('click', () => {
      comparisonLoggingEnabled = !comparisonLoggingEnabled;
      log(`Comparison logging ${comparisonLoggingEnabled ? 'enabled' : 'disabled'}`);
    });
    
    document.getElementById('clear-logs').addEventListener('click', () => {
      debugLogs.textContent = '';
      log('Logs cleared');
    });
    
    document.getElementById('export-results').addEventListener('click', () => {
      const results = {
        timestamp: new Date().toISOString(),
        templates: templates,
        selected_template: selectedTemplate,
        logs: debugLogs.textContent
      };
      
      const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `strategy-migration-test-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      log('Results exported');
    });

    // Initialisation
    loadTemplates();
    StrategyConfig.setDebugMode(true);
    log('Migration test page initialized');
  </script>
</body>
</html>