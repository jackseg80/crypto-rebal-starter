<!DOCTYPE html>
<html>
<head>
    <title>Fix Demo User</title>
</head>
<body>
    <h1>Fix Demo User Configuration</h1>
    <button onclick="fixDemoUser()">Fix Demo User</button>
    <button onclick="testAPI()">Test API After Fix</button>
    <pre id="output"></pre>

    <script>
        function log(msg) {
            document.getElementById('output').textContent += msg + '\n';
            console.log(msg);
        }

        function fixDemoUser() {
            // Set active user to demo
            localStorage.setItem('activeUser', 'demo');

            // Clear any corrupted cache
            localStorage.removeItem('crypto_rebalancer_settings');

            // Set basic config
            const config = {
                data_source: 'csv_0',
                api_base_url: window.location.origin,
                pricing: 'local',
                min_usd_threshold: 5.0
            };
            localStorage.setItem('crypto_rebalancer_settings', JSON.stringify(config));

            log('✅ Demo user configured');
            log(`Active user: ${localStorage.getItem('activeUser')}`);
            log(`Config: ${localStorage.getItem('crypto_rebalancer_settings')}`);
        }

        async function testAPI() {
            try {
                // Test direct API
                const response = await fetch('/balances/current?source=csv_0', {
                    headers: { 'X-User': 'demo' }
                });
                const data = await response.json();
                log(`✅ API test: ${data.items?.length || 0} items`);

                // Test with current settings
                const config = JSON.parse(localStorage.getItem('crypto_rebalancer_settings') || '{}');
                const response2 = await fetch(`/balances/current?source=${config.data_source || 'csv_0'}`, {
                    headers: { 'X-User': localStorage.getItem('activeUser') || 'demo' }
                });
                const data2 = await response2.json();
                log(`✅ Config test: ${data2.items?.length || 0} items`);

            } catch (error) {
                log(`❌ Error: ${error.message}`);
            }
        }
    </script>
</body>
</html>