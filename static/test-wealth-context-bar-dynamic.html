<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test WealthContextBar - Sources Dynamiques</title>
    <link rel="stylesheet" href="shared-theme.css">
    <link rel="stylesheet" href="theme-compat.css">
    <script type="module" src="components/nav.js"></script>
    <script type="module" src="components/WealthContextBar.js"></script>
    <style>
        body {
            padding: 2rem;
            background: var(--theme-bg);
            color: var(--theme-text);
        }
        .test-section {
            background: var(--theme-surface);
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin: 2rem 0;
        }
        .test-section h2 {
            margin-top: 0;
            color: var(--brand-primary);
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .test-card {
            background: var(--theme-bg);
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-md);
            padding: 1rem;
        }
        .test-card h3 {
            margin-top: 0;
            font-size: 0.875rem;
            color: var(--theme-text-muted);
        }
        .test-card .value {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        .log-output {
            background: var(--theme-bg);
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-md);
            padding: 1rem;
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1rem;
        }
        .log-entry {
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--theme-border);
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-time {
            color: var(--theme-text-muted);
            margin-right: 0.5rem;
        }
        .btn {
            background: var(--brand-primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.875rem;
            margin-right: 0.5rem;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .btn-secondary {
            background: var(--theme-surface);
            color: var(--theme-text);
            border: 1px solid var(--theme-border);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test WealthContextBar - Sources Dynamiques</h1>
        <p>Cette page teste le nouveau syst√®me de sources dynamiques dans le menu secondaire.</p>

        <div class="test-section">
            <h2>üìä √âtat Actuel</h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3>Utilisateur Actif</h3>
                    <div class="value" id="current-user">-</div>
                </div>
                <div class="test-card">
                    <h3>Compte S√©lectionn√©</h3>
                    <div class="value" id="current-account">-</div>
                </div>
                <div class="test-card">
                    <h3>Type de Source</h3>
                    <div class="value" id="source-type">-</div>
                </div>
                <div class="test-card">
                    <h3>Cl√© de Source</h3>
                    <div class="value" id="source-key">-</div>
                </div>
            </div>

            <div style="margin-top: 1rem;">
                <button class="btn" onclick="refreshState()">üîÑ Rafra√Æchir √âtat</button>
                <button class="btn btn-secondary" onclick="clearLogs()">üóëÔ∏è Vider Logs</button>
                <button class="btn btn-secondary" onclick="testUserSwitch()">üë§ Tester Switch User</button>
            </div>
        </div>

        <div class="test-section">
            <h2>üìù Event Logs (wealth:change)</h2>
            <div class="log-output" id="log-output">
                <div class="log-entry">En attente d'√©v√©nements...</div>
            </div>
        </div>

        <div class="test-section">
            <h2>üîç localStorage Debug</h2>
            <div class="log-output" id="storage-debug">-</div>
        </div>
    </div>

    <script>
        const logOutput = document.getElementById('log-output');
        const storageDebug = document.getElementById('storage-debug');

        function addLog(message, data = null) {
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">${time}</span>${message}`;
            if (data) {
                entry.innerHTML += `<pre style="margin-top: 0.25rem; color: var(--theme-text-muted);">${JSON.stringify(data, null, 2)}</pre>`;
            }
            logOutput.appendChild(entry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function clearLogs() {
            logOutput.innerHTML = '<div class="log-entry">Logs vid√©s.</div>';
        }

        function refreshState() {
            const activeUser = localStorage.getItem('activeUser') || 'demo';
            const ctx = window.wealthContextBar?.getContext();

            document.getElementById('current-user').textContent = activeUser;
            document.getElementById('current-account').textContent = ctx?.account || '-';

            // Parse account value
            if (ctx?.account && ctx.account !== 'all') {
                const parts = ctx.account.split(':');
                if (parts.length === 2) {
                    document.getElementById('source-type').textContent = parts[0];
                    document.getElementById('source-key').textContent = parts[1];
                } else {
                    document.getElementById('source-type').textContent = 'legacy';
                    document.getElementById('source-key').textContent = ctx.account;
                }
            } else {
                document.getElementById('source-type').textContent = 'all';
                document.getElementById('source-key').textContent = '-';
            }

            updateStorageDebug();
            addLog('√âtat rafra√Æchi', ctx);
        }

        function updateStorageDebug() {
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('wealth_ctx:')) {
                    keys.push({
                        key: key,
                        value: JSON.parse(localStorage.getItem(key) || '{}')
                    });
                }
            }
            storageDebug.textContent = JSON.stringify(keys, null, 2);
        }

        function testUserSwitch() {
            const currentUser = localStorage.getItem('activeUser') || 'demo';
            const newUser = currentUser === 'demo' ? 'jack' : 'demo';

            addLog(`üîÑ Simulation switch user: ${currentUser} ‚Üí ${newUser}`);

            // Simuler l'√©v√©nement activeUserChanged
            const event = new CustomEvent('activeUserChanged', {
                detail: { oldUser: currentUser, newUser: newUser }
            });

            localStorage.setItem('activeUser', newUser);
            window.dispatchEvent(event);

            setTimeout(() => {
                refreshState();
                addLog(`‚úÖ Switch termin√© vers ${newUser}`);
            }, 500);
        }

        // √âcouter les √©v√©nements wealth:change
        window.addEventListener('wealth:change', (e) => {
            addLog('üì¢ Event wealth:change re√ßu', e.detail);
            refreshState();
        });

        // √âcouter activeUserChanged
        window.addEventListener('activeUserChanged', (e) => {
            addLog('üë§ Event activeUserChanged re√ßu', e.detail);
        });

        // Initialisation
        setTimeout(() => {
            refreshState();
            addLog('‚úÖ Page initialis√©e');
        }, 1000);
    </script>
</body>
</html>
