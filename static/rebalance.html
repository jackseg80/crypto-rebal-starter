<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crypto Rebalancer</title>
  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">
  <link rel="stylesheet" href="components/governance-panel.css">
  <script src="global-config.js"></script>
  <script type="module" src="components/nav.js"></script>
  <script type="module" src="core/risk-dashboard-store.js"></script>
  <script type="module" src="core/fetcher.js"></script>
  <script type="module" src="modules/signals-engine.js"></script>
  <script type="module" src="modules/cycle-navigator.js"></script>
  <script type="module" src="modules/onchain-indicators.js"></script>
  <script type="module" src="modules/market-regimes.js"></script>
  <script type="module" src="modules/targets-coordinator.js"></script>
  <script type="module" src="core/risk-data-orchestrator.js"></script>
  <script type="module">
    import { initDeepLinks } from './components/deep-links.js';
    import { wealthContextBar } from './components/WealthContextBar.js';

    // Ancres pour rebalance.html : #proposed-targets #bourse #funding-plan #dca-schedule #constraints
    initDeepLinks({
      'proposed-targets': 'Objectifs Propos√©s',
      'bourse': 'Rebalance Bourse',
      'funding-plan': 'Plan de Financement',
      'dca-schedule': 'Planning DCA',
      'constraints': 'Contraintes'
    });

    // Exposer wealthContextBar globalement pour usage dans le script principal
    window.wealthContextBar = wealthContextBar;
  </script>

  <script type="module">
    import { CANONICAL_GROUPS } from './modules/targets-coordinator.js';

    function materializeAllocations(rawAlloc) {
      const base = Object.fromEntries(CANONICAL_GROUPS.map(g => [g, 0]));
      if (rawAlloc && typeof rawAlloc === 'object') {
        for (const [k, v] of Object.entries(rawAlloc)) {
          if (k in base) base[k] = Number(v) || 0;
        }
      }
      return base;
    }

    // üëá Exposer les symboles n√©cessaires vers le global
    window.CANONICAL_GROUPS = CANONICAL_GROUPS;
    window.materializeAllocations = materializeAllocations;

    function renderStrategyBadges(containerEl, strategy) {
      // selon ton payload : allocations || targets || weights
      const raw = strategy.allocations ?? strategy.targets ?? strategy.weights ?? {};
      const alloc = materializeAllocations(raw);
      containerEl.innerHTML = ''; // reset
      for (const group of CANONICAL_GROUPS) {
        const val = alloc[group];
        const chip = document.createElement('span');
        chip.className = 'badge badge--group' + (val === 0 ? ' badge--zero' : '');
        chip.textContent = `${group}: ${val.toFixed(1)}%`;
        containerEl.appendChild(chip);
      }
    }

    // appelle renderStrategyBadges(card.querySelector('.badges'), strategy)
  </script>

  <script src="debug-logger.js"></script>
  <script src="input-validator.js"></script>
  <script src="performance-optimizer.js"></script>
  <script src="appearance.js"></script>

  <!-- Unified Risk Flyout Panel (Full Sidebar) -->
  <script type="module" src="components/flyout-panel.js"></script>
  <script type="module" src="components/risk-sidebar-full.js"></script>
  <script type="module">
    // Adapter le layout quand la sidebar est √©pingl√©e
    import { enableFlyoutLayoutAdapter } from './components/flyout-layout-adapter.js';
    enableFlyoutLayoutAdapter('.wrap'); // D√©caler uniquement le contenu, pas le menu
  </script>

  <style>
    /* Onglets locaux (Rebalancing / Optimization) */
    .tabs {
      display: flex;
      gap: .5rem;
      align-items: center;
      padding: .75rem 0;
    }

    .tab-btn {
      padding: .5rem .75rem;
      border: 1px solid var(--theme-border);
      background: var(--theme-surface);
      color: var(--theme-text);
      border-radius: var(--radius-sm);
      cursor: pointer;
    }

    .tab-btn.active {
      border-color: var(--brand-primary);
      color: var(--brand-primary);
      background: color-mix(in oklab, var(--brand-primary) 10%, transparent);
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      background: var(--theme-background);
      color: var(--theme-text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif
    }

    header {
      position: sticky;
      top: 0;
      background: var(--theme-surface-elevated);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid var(--theme-border);
      z-index: 10
    }

    .wrap {
      width: 100%;
      max-width: 95vw;
      margin: 0 auto;
      padding: 0 var(--space-lg);
    }


    @media (min-width: 1280px) {
      #strategies-container {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    h1 {
      margin: 0 0 8px 0;
      font-size: 20px
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center
    }

    label {
      font-size: 12px;
      color: var(--theme-text-muted)
    }

    input,
    select,
    button,
    textarea {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--theme-border);
      background: var(--theme-surface);
      color: var(--theme-text)
    }

    button {
      cursor: pointer
    }

    .btn {
      background: var(--brand-primary);
      color: white;
      font-weight: 700;
      border: 0
    }

    .btn.secondary {
      background: var(--theme-surface-elevated);
      color: var(--theme-text);
      border: 1px solid var(--theme-border)
    }

    .btn.ghost {
      background: transparent;
      border: 1px dashed var(--theme-border);
      color: var(--theme-text-muted)
    }

    .btn.small {
      padding: 6px 8px;
      font-size: 12px;
      border-radius: 8px
    }

    .card {
      background: var(--theme-surface);
      border: 1px solid var(--theme-border);
      border-radius: var(--radius-lg);
      padding: var(--space-md)
    }

    .muted {
      color: var(--theme-text-muted)
    }

    table {
      width: 100%;
      border-collapse: collapse
    }

    th,
    td {
      border-bottom: 1px solid var(--theme-border);
      padding: 6px 8px;
      text-align: left;
      font-size: 13px;
      color: var(--theme-text)
    }

    th {
      color: var(--theme-text-muted);
      font-weight: 600
    }

    tr:hover td {
      background: var(--theme-surface-hover)
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--theme-border);
      background: var(--theme-surface-elevated);
      font-size: 12px
    }

    .right {
      text-align: right
    }

    .small {
      font-size: 12px
    }

    .mt8 {
      margin-top: 8px
    }

    .mt16 {
      margin-top: 16px
    }

    .grid {
      display: grid;
      gap: 10px
    }

    @media(min-width:900px) {
      .grid.g2 {
        grid-template-columns: repeat(2, 1fr)
      }

      .grid.g3 {
        grid-template-columns: repeat(3, 1fr)
      }
    }

    /* Styles pour les cartes de strat√©gies */
    .strategy-card {
      border: 2px solid var(--theme-border);
      border-radius: var(--radius-md);
      padding: var(--space-lg);
      cursor: pointer;
      transition: all var(--transition-normal);
      background: var(--theme-surface);
    }

    /* --- Mode Compact --- */
    #strategies-content.compact .strategy-card {
      padding: var(--space-md);
    }

    #strategies-content.compact .strategy-title {
      font-size: 14px;
    }

    #strategies-content.compact .strategy-risk {
      font-size: 10px;
      padding: 1px 5px;
    }

    #strategies-content.compact .allocation-pill {
      font-size: 10px;
      padding: 1px 4px;
    }

    #strategies-content.compact .strategy-allocations {
      gap: 4px;
    }

    /* ligne r√©sum√© des allocs en mode compact */
    .strategy-alloc-summary {
      font-size: 12px;
      color: var(--theme-text-muted);
      margin-top: 6px;
    }

    .alloc-more {
      cursor: pointer;
      text-decoration: underline;
      font-weight: 600;
    }

    /* densifier la grille & les gaps en compact */
    #strategies-content.compact #strategies-container {
      gap: 8px !important;
    }

    .strategy-card:hover {
      border-color: var(--brand-primary);
      background: var(--theme-surface-hover);
    }

    .strategy-card.selected {
      border-color: var(--brand-primary) !important;
      background: var(--brand-primary-subtle) !important;
      box-shadow: var(--shadow-lg);
    }

    .strategy-card.dynamic-strategy.selected {
      border: 3px solid var(--brand-primary) !important;
      background: linear-gradient(135deg, var(--brand-primary-subtle), var(--warning-bg)) !important;
      box-shadow: 0 0 0 2px var(--brand-primary-subtle);
    }

    .strategy-card.placeholder-strategy.selected {
      border: 3px solid var(--brand-primary) !important;
      background: var(--brand-primary-subtle) !important;
      opacity: 1 !important;
    }

    .strategy-card.error-strategy.selected {
      border: 3px solid var(--brand-primary) !important;
      background: linear-gradient(135deg, var(--brand-primary-subtle), var(--danger-bg)) !important;
    }

    .strategy-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .strategy-title {
      font-weight: 700;
      font-size: 16px;
    }

    .strategy-risk {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 6px;
      font-weight: 600;
    }

    .risk-faible {
      background: var(--success);
      color: white;
    }

    .risk-moyen {
      background: var(--warning);
      color: white;
    }

    .risk-lev {
      background: var(--danger);
      color: white;
    }

    .risk-faible-moyen {
      background: var(--success);
      color: white;
    }

    .risk-trsfaible {
      background: #22c55e;
      color: white;
    }

    .risk-trslev {
      background: #dc2626;
      color: white;
    }

    .strategy-allocations {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .allocation-pill {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 6px;
      background: var(--brand-primary-subtle);
      border: 1px solid var(--brand-primary);
      color: var(--brand-primary);
    }

    @media(min-width: 768px) {
      #strategies-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media(min-width: 1200px) {
      #strategies-container {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .delta-pos {
      color: var(--success)
    }

    .delta-neg {
      color: var(--danger)
    }

    .badge {
      font-weight: 700
    }

    .legend {
      display: flex;
      gap: 10px;
      flex-wrap: wrap
    }

    .dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 2px;
      margin-right: 4px
    }

    /* Notifications stylis√©es */
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 16px;
      border-radius: var(--radius-md);
      font-size: 14px;
      z-index: 1000;
      background: var(--theme-surface);
      border: 1px solid var(--theme-border);
      box-shadow: var(--shadow-lg);
      animation: slideIn 0.3s ease-out;
      color: var(--theme-text);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .notification.success {
      border-left: 4px solid var(--success);
    }

    .notification.error {
      border-left: 4px solid var(--danger);
    }

    /* Toggle Switch pour le mode priority */
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--theme-border);
      transition: .3s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: var(--brand-primary);
    }

    input:checked+.slider:before {
      transform: translateX(20px);
    }

    /* Priority groups pills */
    .priority-group-pill {
      display: inline-block;
      padding: 2px 6px;
      margin: 2px;
      background: var(--brand-primary-subtle);
      border: 1px solid var(--brand-primary);
      border-radius: 4px;
      font-size: 10px;
      color: var(--brand-primary);
    }

    .priority-group-pill.fallback {
      background: var(--warning-subtle);
      border-color: var(--warning);
      color: var(--warning);
    }

    /* Tri des colonnes dans le tableau Actions */
    .sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-right: 20px;
    }

    .sortable:hover {
      background-color: var(--theme-surface-elevated);
    }

    .sort-arrow {
      position: absolute;
      right: 4px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      color: var(--theme-text-muted);
      transition: color 0.2s;
    }

    .sortable.sort-asc .sort-arrow {
      color: var(--brand-primary);
    }

    .sortable.sort-asc .sort-arrow::before {
      content: '‚Üë';
    }

    .sortable.sort-desc .sort-arrow {
      color: var(--brand-primary);
    }

    .sortable.sort-desc .sort-arrow::before {
      content: '‚Üì';
    }

    .sortable.sort-asc .sort-arrow,
    .sortable.sort-desc .sort-arrow {
      font-weight: bold;
    }
  </style>

  <script type="module" src="components/tooltips.js"></script>
</head>

<body>

  <!-- Unified Risk Flyout Panel -->
  <flyout-panel position="left" width="340" persist-key="rebalance_flyout">
    <span slot="title">üéØ Risk Dashboard</span>
    <risk-sidebar-full slot="content" poll-ms="0"></risk-sidebar-full>
  </flyout-panel>

  <div class="wrap" style="padding-top: var(--space-lg);">
    <!-- Governance Panel (Decision Engine) -->
    <div id="governance-container"></div>

    <!-- Strat√©gies de Rebalancing -->
    <div id="proposed-targets" class="card" style="margin-bottom: 16px;">
      <h3 style="display:flex; align-items:center; justify-content:space-between;">
        <span style="cursor:pointer" onclick="toggleStrategiesSection()">üéØ Strat√©gies Pr√©d√©finies</span>
        <span style="display:flex; align-items:center; gap:8px">
          <span class="small muted">Vue :</span>
          <button class="btn small secondary" id="btnViewDetailed">D√©taill√©e</button>
          <button class="btn small" id="btnViewCompact"
            style="background: var(--theme-surface-elevated);">Compacte</button>
          <span id="strategies-toggle" style="cursor:pointer; transition: transform .3s; margin-left:8px"
            onclick="toggleStrategiesSection()">‚ñº</span>
        </span>
      </h3>
      <div id="strategies-content">
        <div id="strategies-container" style="display: grid; gap: 12px; margin-top: 12px;">
          <div style="text-align: center; padding: 20px; color: var(--theme-text-muted);">
            Chargement des strat√©gies...
          </div>
        </div>
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--theme-border);">
          <div class="row">
            <button id="apply-strategy-btn" class="btn small" style="background: var(--success);" disabled>
              ‚úÖ Appliquer la Strat√©gie
            </button>
            <button id="reset-strategy-btn" class="btn small secondary">
              üîÑ Reset Manuel
            </button>
            <button id="refresh-dynamic-btn" class="btn small" style="background: var(--warning);"
              onclick="window.refreshDynamicStrategy()">
              üéØ Sync CCS
            </button>
            <div style="flex-grow: 1;"></div>
            <span id="selected-strategy-info" class="pill" style="display: none;">
              Aucune strat√©gie s√©lectionn√©e
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions et Export -->
    <div class="card" style="margin-bottom: 16px;">
      <div class="row">
        <div style="align-self:flex-end">
          <button id="btnCsv" class="btn secondary" disabled>T√©l√©charger CSV</button>
          <button id="btnJson" class="btn secondary" disabled>Export JSON</button>
          <button id="btnCopyJson" class="btn secondary" disabled>üìã Copier JSON</button>
        </div>
        <div style="align-self:flex-end;margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
          <span id="dynamicTargetsIndicator" class="pill" style="background:var(--warning);color:white;display:none;">üéØ
            Targets dynamiques</span>
          <span id="total" class="pill">Total : ‚Äî</span>
          <span id="status" class="pill">Pr√™t.</span>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="tabs" id="rebalance-tabs">
      <button class="tab-btn active" data-target="#rebalance-tab">Rebalancing</button>
      <button class="tab-btn" data-target="#optimization-tab">Optimization</button>
    </div>
  </div>

  <main class="wrap tab-panel active" id="rebalance-tab">
    <!-- Param√®tres d'allocation intra-groupe -->
    <section class="card" style="margin-bottom: 16px;">
      <h3 style="margin-bottom: 12px;">‚öôÔ∏è Param√®tres d'Allocation</h3>
      <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <label for="sub-allocation-toggle" style="font-size: 14px; cursor: pointer;">
            Mode intra-groupe :
          </label>
          <label class="switch">
            <input type="checkbox" id="sub-allocation-toggle">
            <span class="slider"></span>
          </label>
          <span id="sub-allocation-label" style="font-weight: 600; color: var(--brand-primary);">
            Proportionnel
          </span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <label for="min-trade-input" style="font-size: 14px;">Trade minimum :</label>
          <input type="number" id="min-trade-input" value="25" min="1" max="1000" step="1"
            style="width: 80px; padding: 4px 8px; border: 1px solid var(--theme-border); border-radius: 4px;">
          <span style="font-size: 14px; color: var(--theme-text-muted);">USD</span>
        </div>
        <div id="priority-status" style="display: none; flex: 1; min-width: 200px;">
          <div style="font-size: 12px; color: var(--theme-text-muted); margin-bottom: 4px;">
            <span id="universe-source"></span> ‚Ä¢ <span id="universe-timestamp"></span>
          </div>
          <div id="priority-groups-info" style="font-size: 11px; color: var(--brand-primary);"></div>
        </div>
      </div>
    </section>

    <!-- Donuts -->
    <section class="card">
      <h3>R√©partition</h3>
      <div class="grid g2">
        <div>
          <div class="small muted">Actuelle</div>
          <div id="donutCurrent"></div>
        </div>
        <div>
          <div class="small muted">Cible</div>
          <div id="donutTarget"></div>
        </div>
      </div>
      <div id="legend" class="legend mt8"></div>
    </section>

    <!-- R√©sum√© -->
    <section id="dca-schedule" class="card mt16">
      <h3>R√©sum√© par groupe</h3>
      <div id="summary" class="grid g3 mt8"></div>
    </section>

    <!-- Actions -->
    <section id="funding-plan" class="card mt16">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <h3>Actions</h3>
        <div id="pricing-badge"></div>
      </div>
      <div style="overflow:auto;max-height:50vh;border:1px solid var(--theme-border);border-radius:var(--radius-md)">
        <table id="tblActions">
          <thead>
            <tr>
              <th class="sortable" data-sort="group">group <span class="sort-arrow">‚áÖ</span></th>
              <th class="sortable" data-sort="alias">alias <span class="sort-arrow">‚áÖ</span></th>
              <th class="sortable" data-sort="symbol">symbol <span class="sort-arrow">‚áÖ</span></th>
              <th class="sortable" data-sort="action">action <span class="sort-arrow">‚áÖ</span></th>
              <th class="sortable right" data-sort="usd">usd <span class="sort-arrow">‚áÖ</span></th>
              <th class="sortable right" data-sort="est_quantity">est_quantity <span class="sort-arrow">‚áÖ</span></th>
              <th class="sortable right" data-sort="price_used">price_used <span class="sort-arrow">‚áÖ</span></th>
              <th class="sortable" data-sort="location">location <span class="sort-arrow">‚áÖ</span></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Unknown aliases -->
    <section id="constraints" class="card mt16">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <h3>Unknown aliases</h3>
          <div class="small">Par d√©faut, <strong>Others</strong> est pr√©s√©lectionn√©.</div>
        </div>
        <div style="display:flex;gap:12px;align-items:flex-end">
          <div>
            <label class="small">Tout vers</label><br />
            <select id="bulk_group">
              <option value="BTC">BTC</option>
              <option value="ETH">ETH</option>
              <option value="Stablecoins">Stablecoins</option>
              <option value="SOL">SOL</option>
              <option value="L1/L0 majors">L1/L0 majors</option>
              <option value="L2/Scaling">L2/Scaling</option>
              <option value="DeFi">DeFi</option>
              <option value="AI/Data">AI/Data</option>
              <option value="Gaming/NFT">Gaming/NFT</option>
              <option value="Memecoins">Memecoins</option>
              <option value="Others" selected>Others</option>
            </select>
            <button id="btnBulkAdd" class="btn ghost">Ajouter tout</button>
          </div>
          <div id="alias-manager-button" style="display: none;">
            <button class="btn secondary small" onclick="openAliasManager()"
              title="Ouvrir l'interface de gestion des aliases">
              üè∑Ô∏è Alias Manager
            </button>
          </div>
        </div>
      </div>
      <div id="unknownList" class="small mt16"></div>
    </section>
  </main>

  <section id="bourse" class="wrap tab-panel">
    <div class="card">
      <div style="display:flex; align-items:center; gap:.5rem; margin-bottom:.5rem;">
        <h3 style="margin:0;">Optimization</h3>
        <button id="openOptimizationNewTab" class="btn secondary small" style="margin-left:auto;">Open in new
          tab</button>
      </div>
      <div id="optimization-container"></div>
      <div id="optimization-status" class="small muted" style="margin-top:.5rem; display:none"></div>
    </div>
  </section>


  <script type="module" src="modules/rebalance-controller.js"></script>

  <script>
    // Initialisation automatique de la navigation th√©matique
    document.addEventListener('DOMContentLoaded', function () {
      // Auto-d√©tecter la page courante pour la navigation th√©matique
      /* unified nav enabled via components/nav.js; legacy init removed */
    });
  </script>

  <script type="module">
    import { GovernancePanel } from './components/GovernancePanel.js';

    // Initialize Governance Panel (Decision Engine) for rebalance page
    document.addEventListener('DOMContentLoaded', async function () {
      const governanceContainer = document.getElementById('governance-container');
      if (governanceContainer) {
        debugLogger.debug('üèõÔ∏è Initializing Governance Panel for rebalance...');
        const governancePanel = new GovernancePanel(governanceContainer);

        // Auto-refresh initial state
        setTimeout(() => {
          governancePanel.refreshState();
        }, 1000);

        // Store reference globally for debugging
        window.governancePanel = governancePanel;
        debugLogger.debug('‚úÖ Governance Panel initialized');
      }
    });
  </script>

</body>

</html>