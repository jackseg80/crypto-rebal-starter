<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Crypto Rebalancer</title>
<style>
  :root{
    --bg:#0a0f14; --card:#0e1620; --muted:#8fa0b3; --text:#e7eef7;
    --accent:#2dd4bf; --danger:#ef4444; --border:#1f2b3a; --pos:#22c55e;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;background:linear-gradient(180deg,rgba(10,15,20,.95),rgba(10,15,20,.85));backdrop-filter: blur(6px);border-bottom:1px solid var(--border);z-index:10}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  h1{margin:0 0 8px 0;font-size:20px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label{font-size:12px;color:var(--muted)}
  input,select,button,textarea{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text)}
  button{cursor:pointer}
  .btn{background:var(--accent);color:#07211e;font-weight:700;border:0}
  .btn.secondary{background:#223044;color:var(--text);border:1px solid var(--border)}
  .btn.ghost{background:transparent;border:1px dashed var(--border);color:var(--muted)}
  .btn.small{padding:6px 8px;font-size:12px;border-radius:8px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
  .muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:6px 8px;text-align:left;font-size:13px}
  th{color:var(--muted);font-weight:600}
  tr:hover td{background:#0b131d}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#0b131d;font-size:12px}
  .right{text-align:right}
  .small{font-size:12px}
  .mt8{margin-top:8px}
  .mt16{margin-top:16px}
  .grid{display:grid;gap:10px}
  @media(min-width:900px){ .grid.g2{grid-template-columns:repeat(2,1fr)} .grid.g3{grid-template-columns:repeat(3,1fr)} }
  .delta-pos{color:var(--pos)}
  .delta-neg{color:var(--danger)}
  .badge{font-weight:700}
  .legend{display:flex;gap:10px;flex-wrap:wrap}
  .dot{display:inline-block;width:10px;height:10px;border-radius:2px;margin-right:4px}
  /* Notifications stylisées */
  .notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 1000;
    background: var(--card);
    border: 1px solid var(--border);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    animation: slideIn 0.3s ease-out;
  }
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  .notification.success { border-left: 4px solid #22c55e; }
  .notification.error { border-left: 4px solid #ef4444; }
  .notification {
    position: fixed; bottom: 20px; right: 20px; padding: 12px 16px;
    border-radius: 8px; font-size: 14px; z-index: 1000;
    background: #0e1620; border: 1px solid #1f2b3a;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    animation: slideIn 0.3s ease-out;
  }
  @keyframes slideIn {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
  }
  .notification.success { border-left: 4px solid #22c55e; }
  .notification.error { border-left: 4px solid #ef4444; }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>⚖️ Crypto Rebalancer</h1>
    <div class="row">
      <div>
        <label>API</label><br/>
        <input id="api_base" value="http://127.0.0.1:8000" style="width:260px">
      </div>
      <div>
        <label>Source</label><br/>
        <select id="source">
          <option value="stub">stub (démo)</option>
          <option value="cointracking">cointracking (CSV)</option>
          <option value="cointracking_api">cointracking_api</option>
        </select>
      </div>
      <div>
        <label>min_usd</label><br/>
        <input id="min_usd" type="number" value="1" style="width:90px">
      </div>
      <div>
        <label>Pricing</label><br/>
        <select id="pricing_mode">
          <option value="local">Local (rapide)</option>
          <option value="hybrid" selected>Hybride (recommandé)</option>
          <option value="auto">Marché (précis)</option>
        </select>
      </div>
      <div style="align-self:flex-end">
        <button id="btnRun" class="btn">Générer le plan</button>
        <button id="btnCsv" class="btn secondary" disabled>Télécharger CSV</button>
      </div>
      <div style="align-self:flex-end;margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
        <span id="total" class="pill">Total : —</span>
        <span id="status" class="pill">Prêt.</span>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- Donuts -->
  <section class="card">
    <h3>Répartition</h3>
    <div class="grid g2">
      <div>
        <div class="small muted">Actuelle</div>
        <div id="donutCurrent"></div>
      </div>
      <div>
        <div class="small muted">Cible</div>
        <div id="donutTarget"></div>
      </div>
    </div>
    <div id="legend" class="legend mt8"></div>
  </section>

  <!-- Résumé -->
  <section class="card mt16">
    <h3>Résumé par groupe</h3>
    <div id="summary" class="grid g3 mt8"></div>
  </section>

  <!-- Actions -->
  <section class="card mt16">
    <div class="row" style="justify-content:space-between;align-items:flex-end">
      <h3>Actions</h3>
      <div class="legend small">
        <span><span class="pill" style="background:#16a34a;border-color:#16a34a;color:white;font-size:10px">L</span> Prix local</span>
        <span><span class="pill" style="background:#dc2626;border-color:#dc2626;color:white;font-size:10px">M</span> Prix marché</span>
      </div>
    </div>
    <div style="overflow:auto;max-height:50vh;border:1px solid var(--border);border-radius:10px">
      <table id="tblActions">
        <thead>
          <tr>
            <th>group</th><th>alias</th><th>symbol</th><th>action</th>
            <th class="right">usd</th><th class="right">est_quantity</th><th class="right">price_used</th><th>source</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Unknown aliases -->
  <section class="card mt16">
    <div class="row" style="justify-content:space-between;align-items:flex-end">
      <div>
        <h3>Unknown aliases</h3>
        <div class="small">Par défaut, <strong>Others</strong> est présélectionné.</div>
      </div>
      <div>
        <label class="small">Tout vers</label><br/>
        <select id="bulk_group">
          <option value="BTC">BTC</option>
          <option value="ETH">ETH</option>
          <option value="Stablecoins">Stablecoins</option>
          <option value="SOL">SOL</option>
          <option value="L1/L0 majors">L1/L0 majors</option>
          <option value="Others" selected>Others</option>
        </select>
        <button id="btnBulkAdd" class="btn ghost">Ajouter tout</button>
      </div>
    </div>
    <div id="unknownList" class="small mt16"></div>
  </section>
</main>

<script>
/* ---------- Helpers ---------- */
const $  = sel => document.querySelector(sel);
const el = id  => document.getElementById(id);
const fmt  = n => (n==null || isNaN(n)) ? "" : Number(n).toLocaleString(undefined, {maximumFractionDigits: 8});
const fmt2 = n => (n==null || isNaN(n)) ? "—" : Number(n).toLocaleString(undefined, {maximumFractionDigits: 2});

function setStatus(text){ el("status").textContent = text; }
function showNotification(text, type = 'info', duration = 3000) {
  const notif = document.createElement('div');
  notif.className = `notification ${type}`;
  notif.textContent = text;
  document.body.appendChild(notif);
  setTimeout(() => notif.remove(), duration);
}
function setTotal(v){
  const n = Number(v||0);
  el("total").textContent = "Total : " + (isFinite(n) ? n.toLocaleString(undefined,{maximumFractionDigits:2})+" $" : "—");
}

async function postJson(url, body){
  const r = await fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body || {})
  });
  if(!r.ok){ throw new Error(`[${r.status}] ${await r.text()}`); }
  return r.json();
}

async function postCsv(url, body){
  const r = await fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body || {})
  });
  if(!r.ok){ throw new Error(`[${r.status}] ${await r.text()}`); }
  return r.blob();
}

function buildPayload(){
  // Tu peux brancher ça aux inputs si tu veux les rendre éditables
  return {
    group_targets_pct: { BTC:35, ETH:25, Stablecoins:10, SOL:10, "L1/L0 majors":10, Others:10 },
    primary_symbols: {
      BTC:["BTC","TBTC","WBTC"],
      ETH:["ETH","WSTETH","STETH","RETH","WETH"],
      SOL:["SOL","JUPSOL","JITOSOL"]
    },
    sub_allocation: "proportional",
    min_trade_usd: 25
  };
}

function currentQuery(){
  const api = el("api_base").value.trim().replace(/\/+$/,'');
  const source = el("source").value;
  const min_usd = el("min_usd").value || "1";
  const pricing = el("pricing_mode").value;
  const qs = new URLSearchParams({ source, min_usd, pricing }).toString();
  return { api, qs };
}

/* ---------- Donuts (SVG) ---------- */
const COLORS = ["#60a5fa","#34d399","#f472b6","#f59e0b","#a78bfa","#f87171","#22d3ee","#eab308"];
function donutSVG(weights, title){
  const size = 160, r = 68, cx = 80, cy = 80, stroke = 22;
  const names = Object.keys(weights||{});
  let start = -Math.PI/2;
  const segs = [];
  names.forEach((name, i)=>{
    const pct = Math.max(0, Number(weights[name]||0)) / 100;
    const angle = pct * Math.PI*2;
    const end = start + angle;
    if (pct > 0){
      const largeArc = angle > Math.PI ? 1 : 0;
      const x1 = cx + r * Math.cos(start), y1 = cy + r * Math.sin(start);
      const x2 = cx + r * Math.cos(end),   y2 = cy + r * Math.sin(end);
      const path = `M ${x1} ${y1} A ${r} ${r} 0 ${largeArc} 1 ${x2} ${y2}`;
      segs.push(`<path d="${path}" stroke="${COLORS[i % COLORS.length]}" stroke-width="${stroke}" fill="none" />`);
    }
    start = end;
  });
  const total = (Object.values(weights||{}).reduce((a,b)=>a+Number(b||0),0)).toFixed(0);
  return `<svg width="${size}" height="${size}" viewBox="0 0 160 160">
    <circle cx="${cx}" cy="${cy}" r="${r}" stroke="#152232" stroke-width="${stroke}" fill="none"/>
    ${segs.join("")}
    <text x="${cx}" y="${cy-2}" text-anchor="middle" font-size="14" fill="#cbd5e1">${title||""}</text>
    <text x="${cx}" y="${cy+14}" text-anchor="middle" font-size="12" fill="#93a3b5">${total}%</text>
  </svg>`;
}
function renderDonuts(plan){
  const cw = plan?.current_weights_pct || {};
  const tw = plan?.target_weights_pct  || {};
  $("#donutCurrent").innerHTML = donutSVG(cw, "Actuel");
  $("#donutTarget").innerHTML  = donutSVG(tw, "Cible");

  const names = Object.keys(tw).length ? Object.keys(tw) : Object.keys(cw);
  const html = (names||[]).map((g,i)=>`<span><span class="dot" style="background:${COLORS[i%COLORS.length]}"></span>${g}</span>`).join("");
  $("#legend").innerHTML = html;
}

/* ---------- Résumé & Actions ---------- */
function renderActions(actions){
  const tb = $("#tblActions tbody");
  tb.innerHTML = (actions||[]).map(a => {
    const priceSourceBadge = a.price_source === 'market' ? 
      '<span class="pill" style="background:#dc2626;border-color:#dc2626;color:white;font-size:10px">M</span>' : 
      a.price_source === 'local' ? 
      '<span class="pill" style="background:#16a34a;border-color:#16a34a;color:white;font-size:10px">L</span>' : '';
    
    return `
    <tr>
      <td>${a.group||""}</td>
      <td>${a.alias||""}</td>
      <td>${a.symbol||""}</td>
      <td>${a.action||""}</td>
      <td class="right">${fmt(a.usd)}</td>
      <td class="right">${fmt(a.est_quantity)}</td>
      <td class="right">${fmt(a.price_used)}</td>
      <td>${priceSourceBadge}</td>
    </tr>
    `;
  }).join("");
}
function renderSummary(plan){
  const grp = plan?.current_by_group || {};
  const cw  = plan?.current_weights_pct || {};
  const tw  = plan?.target_weights_pct || {};
  const dU  = plan?.deltas_by_group_usd || {};
  const names = Object.keys(tw).length ? Object.keys(tw) : Object.keys(cw);
  const html = (names||[]).map(g=>{
    const cur = cw[g]; const tgt = tw[g]; const du = dU[g];
    const cls = (du||0) >= 0 ? "delta-pos" : "delta-neg";
    return `<div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="badge">${g}</div>
        <div class="muted small">${fmt2(grp[g])} $</div>
      </div>
      <div class="small mt8">Actuel: <strong>${fmt2(cur)}%</strong> • Cible: <strong>${fmt2(tgt)}%</strong></div>
      <div class="small">Delta: <strong class="${cls}">${fmt2(du)} $</strong></div>
    </div>`;
  }).join("");
  $("#summary").innerHTML = html || '<span class="muted">Aucun résumé disponible.</span>';
}

function renderUnknownAliases(list){
  const container = el("unknownList");
  if (!list || !list.length) { container.innerHTML = '<span class="muted">Aucun 🎉</span>'; return; }
  const options = ["BTC","ETH","Stablecoins","SOL","L1/L0 majors","Others"]
    .map(g => `<option value="${g}" ${g==="Others"?'selected':''}>${g}</option>`).join("");
  container.innerHTML = list.map(a => `
    <div class="row">
      <div class="pill">${a}</div>
      <select class="u_group">${options}</select>
      <button class="btn secondary small act-add" data-alias="${a}">Ajouter</button>
    </div>
  `).join("");

  // Gestion des clics sur les boutons Ajouter
  el("unknownList").addEventListener("click", async (ev) => {
    const btn = ev.target.closest('button.act-add');
    if (!btn || btn.disabled) return;

    ev.preventDefault();

    try {
      btn.disabled = true;
      const row = btn.closest('.row');
      const alias = (btn.dataset.alias || '').toUpperCase().trim();
      const groupSelect = row.querySelector('select.u_group');
      const group = groupSelect?.value || 'Others';

      if (!alias) throw new Error('Alias invalide');
      
      const { api } = currentQuery();
      const response = await fetch(`${api}/taxonomy/aliases`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ aliases: { [alias]: group } })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || `Erreur HTTP ${response.status}`);
      }

      await runPlan(); // Rafraîchit les données
      showNotification(`✅ ${alias} assigné à ${group}`, 'success');

    } catch (error) {
      console.error('Erreur:', error);
      showNotification(`❌ ${error.message}`, 'error', 5000);
    } finally {
      btn.disabled = false;
    }
  });
}

/* ---------- Taxonomy calls ---------- */
async function addAliases(map){
  const { api } = currentQuery();
  setStatus("Écriture…");
  const body = { aliases: map || {} };
  const res = await postJson(`${api}/taxonomy/aliases`, body);
  setStatus(`OK (${res?.written||Object.keys(map||{}).length} alias)`);
  return res;
}

/* ---------- Flow ---------- */
function persistSourceInit(){
  const k = "reb_source";
  const saved = localStorage.getItem(k);
  el("source").value = saved || "stub"; // défaut: stub (pas d’appel auto)
  el("source").addEventListener("change", ()=> localStorage.setItem(k, el("source").value));
}

async function runPlan(){
  try {
    const t0 = performance.now();
    el("btnRun").disabled = true;
    el("btnCsv").disabled = true;
    setStatus("Calcul…");
    const { api, qs } = currentQuery();
    const url = `${api}/rebalance/plan?${qs}`;
    const plan = await postJson(url, buildPayload());

    renderDonuts(plan);
    renderSummary(plan);
    renderActions(plan.actions||[]);
    renderUnknownAliases(plan.unknown_aliases||[]);
    setTotal(plan?.total_usd);

    const ms = Math.round(performance.now() - t0);
    let statusText = `OK • ${ms} ms • source=${plan?.meta?.source_used||'(?)'} • items=${plan?.meta?.items_count??"-"}`;
    
    // Ajouter infos pricing hybride si disponibles
    if (plan?.meta?.pricing_mode === 'hybrid' && plan?.meta?.pricing_hybrid) {
      const hybridInfo = plan.meta.pricing_hybrid;
      statusText += ` • pricing=hybrid (âge=${Math.round(hybridInfo.data_age_min)}min, seuils=${hybridInfo.max_age_min}min/${hybridInfo.max_deviation_pct}%)`;
    } else if (plan?.meta?.pricing_mode) {
      statusText += ` • pricing=${plan.meta.pricing_mode}`;
    }
    
    setStatus(statusText);
    el("btnCsv").disabled = false;
  } catch (e){
    console.error(e);
    setStatus("Erreur: " + (e?.message || e));
  } finally {
    el("btnRun").disabled = false;
  }
}

async function downloadCsv(){
  try{
    el("btnCsv").disabled = true;
    setStatus("Génération CSV…");
    const { api, qs } = currentQuery();
    const blob = await postCsv(`${api}/rebalance/plan.csv?${qs}`, buildPayload());
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    const ts = new Date().toISOString().replace(/[:.]/g,"-");
    a.href = url;
    a.download = `rebalance-actions-${ts}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    setStatus("CSV téléchargé.");
  } catch(e){
    console.error(e);
    setStatus("Erreur CSV: " + (e?.message || e));
  } finally{
    el("btnCsv").disabled = false;
  }
}

async function bulkAddUnknown(){
  const container = el("unknownList");
  const rows = Array.from(container.querySelectorAll(".row"));
  if (!rows.length){ return; }
  const defaultGroup = el("bulk_group").value || "Others";
  const map = {};
  rows.forEach(r=>{
    const alias = (r.querySelector(".act-add")?.getAttribute("data-alias")) || "";
    const sel = r.querySelector(".u_group");
    const group = sel ? sel.value : defaultGroup;
    if (alias) map[alias] = group || defaultGroup;
  });
  await addAliases(map);
  await runPlan();
}

/* ---------- Init ---------- */
window.addEventListener("DOMContentLoaded", ()=>{
  persistSourceInit();
  el("btnRun").addEventListener("click", runPlan);
  el("btnCsv").addEventListener("click", downloadCsv);
  el("btnBulkAdd").addEventListener("click", bulkAddUnknown);
  setStatus("Prêt.");
});
</script>
</body>
</html>
