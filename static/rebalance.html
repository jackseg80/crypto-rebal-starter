<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Crypto Rebalancer</title>
<style>
  :root{
    --bg:#0a0f14; --card:#0e1620; --muted:#8fa0b3; --text:#e7eef7;
    --accent:#2dd4bf; --danger:#ef4444; --border:#1f2b3a; --pos:#22c55e;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
  header{position:sticky;top:0;background:linear-gradient(180deg,rgba(10,15,20,.95),rgba(10,15,20,.85));backdrop-filter: blur(6px);border-bottom:1px solid var(--border);z-index:10}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  h1{margin:0 0 8px 0;font-size:20px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label{font-size:12px;color:var(--muted)}
  input,select,button,textarea{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text)}
  button{cursor:pointer}
  .btn{background:var(--accent);color:#07211e;font-weight:700;border:0}
  .btn.secondary{background:#223044;color:var(--text);border:1px solid var(--border)}
  .btn.ghost{background:transparent;border:1px dashed var(--border);color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
  .muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:6px 8px;text-align:left;font-size:13px}
  th{color:var(--muted);font-weight:600}
  tr:hover td{background:#0b131d}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#0b131d;font-size:12px}
  .right{text-align:right}
  .small{font-size:12px}
  .mt8{margin-top:8px}
  .mt16{margin-top:16px}
  .grid{display:grid;gap:10px}
  @media(min-width:900px){ .grid.g3{grid-template-columns:repeat(3,1fr)} }
  .delta-pos{color:var(--pos)}
  .delta-neg{color:var(--danger)}
  .badge{font-weight:700}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>‚öñÔ∏è Crypto Rebalancer</h1>
    <div class="row">
      <div>
        <label>API</label><br/>
        <input id="api_base" value="http://127.0.0.1:8000" style="width:260px">
      </div>
      <div>
        <label>Source</label><br/>
        <select id="source">
          <option value="stub">stub (d√©mo)</option>
          <option value="cointracking">cointracking (CSV)</option>
          <option value="cointracking_api">cointracking_api</option>
        </select>
      </div>
      <div>
        <label>min_usd</label><br/>
        <input id="min_usd" type="number" value="1" style="width:90px">
      </div>
      <div class="grow" style="align-self:flex-end">
        <label class="small">
          <input type="checkbox" id="pricing_local" checked>
          Prix locaux (rapide)
        </label>
      </div>
      <div style="align-self:flex-end">
        <button id="btnRun" class="btn">G√©n√©rer le plan</button>
        <button id="btnCsv" class="btn secondary" disabled>T√©l√©charger CSV</button>
      </div>
      <div style="align-self:flex-end;margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
        <span id="total" class="pill">Total : ‚Äî</span>
        <span id="status" class="pill">Pr√™t.</span>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- R√©sum√© -->
  <section class="card">
    <h3>R√©sum√©</h3>
    <div id="summary" class="grid g3 mt8"></div>
  </section>

  <!-- Actions -->
  <section class="card mt16">
    <h3>Actions</h3>
    <div style="overflow:auto;max-height:50vh;border:1px solid var(--border);border-radius:10px">
      <table id="tblActions">
        <thead>
          <tr>
            <th>group</th><th>alias</th><th>symbol</th><th>action</th>
            <th class="right">usd</th><th class="right">est_quantity</th><th class="right">price_used</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Unknown aliases -->
  <section class="card mt16">
    <div class="row" style="justify-content:space-between;align-items:flex-end">
      <div>
        <h3>Unknown aliases</h3>
        <div class="small">Par d√©faut, <strong>Others</strong> est pr√©s√©lectionn√©.</div>
      </div>
      <div>
        <label class="small">Tout vers</label><br/>
        <select id="bulk_group">
          <option value="BTC">BTC</option>
          <option value="ETH">ETH</option>
          <option value="Stablecoins">Stablecoins</option>
          <option value="SOL">SOL</option>
          <option value="L1/L0 majors">L1/L0 majors</option>
          <option value="Others" selected>Others</option>
        </select>
        <button id="btnBulkAdd" class="btn ghost">Ajouter tout</button>
      </div>
    </div>
    <div id="unknownList" class="small mt16"></div>
  </section>
</main>

<script>
const $ = sel => document.querySelector(sel);
const el = id => document.getElementById(id);
const fmt = n => (n==null || isNaN(n)) ? "" : Number(n).toLocaleString(undefined, {maximumFractionDigits: 8});
const fmt2 = n => (n==null || isNaN(n)) ? "‚Äî" : Number(n).toLocaleString(undefined,{maximumFractionDigits:2});

function setStatus(text){ el("status").textContent = text; }
function setTotal(v){
  const n = Number(v||0);
  el("total").textContent = "Total : " + (isFinite(n) ? n.toLocaleString(undefined,{maximumFractionDigits:2})+" $" : "‚Äî");
}

async function postJson(url, body){
  const r = await fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body||{}) });
  if(!r.ok){ throw new Error(`[${r.status}] ${await r.text()}`); }
  return r.json();
}

function buildPayload(){
  return {
    group_targets_pct: { BTC:35, ETH:25, Stablecoins:10, SOL:10, "L1/L0 majors":10, Others:10 },
    primary_symbols: { BTC:["BTC","TBTC","WBTC"], ETH:["ETH","WSTETH","STETH","RETH","WETH"], SOL:["SOL","JUPSOL","JITOSOL"] },
    sub_allocation: "proportional",
    min_trade_usd: 25
  };
}

function currentQuery(){
  const api = el("api_base").value.trim().replace(/\/+$/,'');
  const source = el("source").value;
  const min_usd = el("min_usd").value || "1";
  const pricing = el("pricing_local").checked ? "local" : "auto";
  const qs = new URLSearchParams({ source, min_usd, pricing }).toString();
  return { api, qs };
}

function renderActions(actions){
  const tb = $("#tblActions tbody");
  tb.innerHTML = (actions||[]).map(a => `
    <tr>
      <td>${a.group||""}</td>
      <td>${a.alias||""}</td>
      <td>${a.symbol||""}</td>
      <td>${a.action||""}</td>
      <td class="right">${fmt(a.usd)}</td>
      <td class="right">${fmt(a.est_quantity)}</td>
      <td class="right">${fmt(a.price_used)}</td>
    </tr>
  `).join("");
}

function renderSummary(plan){
  const grp = plan?.current_by_group || {};
  const cw  = plan?.current_weights_pct || {};
  const tw  = plan?.target_weights_pct || {};
  const dU  = plan?.deltas_by_group_usd || {};
  const names = Object.keys(tw).length ? Object.keys(tw) : Object.keys(cw);
  const html = (names||[]).map(g=>{
    const cur = cw[g]; const tgt = tw[g]; const du = dU[g];
    const cls = (du||0) >= 0 ? "delta-pos" : "delta-neg";
    return `<div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="badge">${g}</div>
        <div class="muted small">${fmt2(grp[g])} $</div>
      </div>
      <div class="small mt8">Actuel: <strong>${fmt2(cur)}%</strong> ‚Ä¢ Cible: <strong>${fmt2(tgt)}%</strong></div>
      <div class="small">Delta: <strong class="${cls}">${fmt2(du)} $</strong></div>
    </div>`;
  }).join("");
  $("#summary").innerHTML = html || '<span class="muted">Aucun r√©sum√© disponible.</span>';
}

function renderUnknownAliases(list){
  const container = el("unknownList");
  if (!list || !list.length) { container.innerHTML = '<span class="muted">Aucun üéâ</span>'; return; }
  const options = ["BTC","ETH","Stablecoins","SOL","L1/L0 majors","Others"]
    .map(g => `<option value="${g}" ${g==="Others"?'selected':''}>${g}</option>`).join("");
  container.innerHTML = list.map(a => `
    <div class="row">
      <div class="pill">${a}</div>
      <select class="u_group">${options}</select>
      <button class="btn secondary small act-add" data-alias="${a}">Ajouter</button>
    </div>
  `).join("");
}

function persistSourceInit(){
  const k = "reb_source";
  const saved = localStorage.getItem(k);
  el("source").value = saved || "stub"; // d√©faut: stub
  el("source").addEventListener("change", ()=> localStorage.setItem(k, el("source").value));
}

async function runPlan(){
  try {
    const t0 = performance.now();
    el("btnRun").disabled = true;
    el("btnCsv").disabled = true;
    setStatus("Calcul‚Ä¶");
    const { api, qs } = currentQuery();

    const url = `${api}/rebalance/plan?${qs}`;
    const plan = await postJson(url, buildPayload());
    renderSummary(plan);
    renderActions(plan.actions||[]);
    renderUnknownAliases(plan.unknown_aliases||[]);

    const t1 = performance.now();
    const ms = Math.round(t1 - t0);

    setTotal(plan?.total_usd);
    setStatus(`OK ‚Ä¢ source=${plan?.meta?.source_used||'(?)'} ‚Ä¢ items=${plan?.meta?.items_count??"-"}`);
    el("btnCsv").disabled = false;
  } catch (e){
    console.error(e);
    setStatus(`Erreur: ${e.message||e}`);
    alert(e.message||e);
  } finally {
    el("btnRun").disabled = false;
  }
}

async function downloadCsv(){
  try{
    const t0 = performance.now();
    el("btnCsv").disabled = true;
    setStatus("G√©n√©ration CSV‚Ä¶");
    const { api, qs } = currentQuery();
    const url = `${api}/rebalance/plan.csv?${qs}`;

    const r = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(buildPayload())
    });
    if(!r.ok){ throw new Error(`[${r.status}] ${await r.text()}`); }
    const blob = await r.blob();

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "rebalance-actions.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1500);

    const t1 = performance.now();
    setStatus("CSV t√©l√©charg√© ‚úÖ");
  }catch(e){
    console.error(e);
    setStatus(`Erreur: ${e.message||e}`);
    alert(e.message||e);
  }finally{
    el("btnCsv").disabled = false;
  }
}

el("btnRun").addEventListener("click", runPlan);
el("btnCsv").addEventListener("click", downloadCsv);

// BULK unknown -> groupe choisi
el("btnBulkAdd").addEventListener("click", async ()=>{
  const group = el("bulk_group").value || "Others";
  const items = [...document.querySelectorAll("#unknownList .act-add")].map(b => b.dataset.alias).filter(Boolean);
  if(!items.length){ alert("Aucun alias inconnu."); return; }
  if(!confirm(`Ajouter ${items.length} alias en ${group} ?`)) return;
  try{
    setStatus("Ajout en cours‚Ä¶");
    const api = el("api_base").value.trim().replace(/\/+$/,'');
    const payload = { aliases: Object.fromEntries(items.map(a => [a, group])) };
    const r = await fetch(`${api}/taxonomy/aliases`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    if(!r.ok){ throw new Error(`[${r.status}] ${await r.text()}`); }
    await runPlan();
  }catch(e){
    console.error(e);
    setStatus(`Erreur: ${e.message||e}`);
    alert(e.message||e);
  }
});

// init: on ne lance RIEN automatiquement
persistSourceInit();
</script>
</body>
</html>
