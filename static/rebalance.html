<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crypto Rebalancer</title>
  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">
  <link rel="stylesheet" href="css/rebalance.css">
  <link rel="stylesheet" href="components/governance-panel.css">
  <script src="global-config.js"></script>
  <script type="module" src="components/nav.js"></script>
  <script type="module" src="core/risk-dashboard-store.js"></script>
  <script type="module" src="core/fetcher.js"></script>
  <script type="module" src="modules/signals-engine.js"></script>
  <script type="module" src="modules/cycle-navigator.js"></script>
  <script type="module" src="modules/onchain-indicators.js"></script>
  <script type="module" src="modules/market-regimes.js"></script>
  <script type="module" src="modules/targets-coordinator.js"></script>
  <script type="module" src="core/risk-data-orchestrator.js"></script>
  <script type="module">
    import { initDeepLinks } from './components/deep-links.js';
    import { wealthContextBar } from './components/WealthContextBar.js';

    // Ancres pour rebalance.html : #proposed-targets #optimization #funding-plan #dca-schedule #constraints
    initDeepLinks({
      'proposed-targets': 'Objectifs Propos√©s',
      'optimization': 'Optimization',
      'funding-plan': 'Plan de Financement',
      'dca-schedule': 'Planning DCA',
      'constraints': 'Contraintes'
    });

    // Exposer wealthContextBar globalement pour usage dans le script principal
    window.wealthContextBar = wealthContextBar;
  </script>


  <script src="debug-logger.js"></script>
  <script src="input-validator.js"></script>
  <script src="performance-optimizer.js"></script>
  <script src="appearance.js"></script>

  <!-- Unified Risk Flyout Panel (Full Sidebar) -->
  <script type="module" src="components/flyout-panel.js"></script>
  <script type="module" src="components/risk-sidebar-full.js"></script>
  <script type="module">
    // Adapter le layout quand la sidebar est √©pingl√©e
    import { enableFlyoutLayoutAdapter } from './components/flyout-layout-adapter.js';
    enableFlyoutLayoutAdapter('.wrap'); // D√©caler uniquement le contenu, pas le menu
  </script>

  <script type="module" src="components/tooltips.js"></script>
</head>

<body>

  <!-- Unified Risk Flyout Panel -->
  <flyout-panel position="left" width="340" persist-key="rebalance_flyout">
    <span slot="title">üéØ Risk Dashboard</span>
    <risk-sidebar-full slot="content" poll-ms="0"></risk-sidebar-full>
  </flyout-panel>

  <div class="wrap" style="padding-top: var(--space-lg);">
    <!-- Governance Panel (Decision Engine) -->
    <div id="governance-container"></div>

    <!-- Strat√©gies de Rebalancing -->
    <div id="proposed-targets" class="card" style="margin-bottom: 16px;">
      <h3 style="display:flex; align-items:center; justify-content:space-between;">
        <span style="cursor:pointer" onclick="toggleStrategiesSection()">üéØ Strat√©gies Pr√©d√©finies</span>
        <span style="display:flex; align-items:center; gap:8px">
          <span class="small muted">Vue :</span>
          <button class="btn small secondary" id="btnViewDetailed">D√©taill√©e</button>
          <button class="btn small" id="btnViewCompact"
            style="background: var(--theme-surface-elevated);">Compacte</button>
          <span id="strategies-toggle" style="cursor:pointer; transition: transform .3s; margin-left:8px"
            onclick="toggleStrategiesSection()">‚ñº</span>
        </span>
      </h3>
      <div id="strategies-content">
        <div id="strategies-container" style="display: grid; gap: 12px; margin-top: 12px;">
          <div style="text-align: center; padding: 20px; color: var(--theme-text-muted);">
            Chargement des strat√©gies...
          </div>
        </div>
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--theme-border);">
          <div class="row" style="gap: 8px; flex-wrap: wrap;">
            <!-- Boutons d'action strat√©gies -->
            <button id="apply-strategy-btn" class="btn small" style="background: var(--success);" disabled>
              ‚úÖ Appliquer la Strat√©gie
            </button>
            <button id="reset-strategy-btn" class="btn small secondary">
              üîÑ Reset Manuel
            </button>
            <button id="refresh-dynamic-btn" class="btn small" style="background: var(--warning);"
              onclick="window.refreshDynamicStrategy()">
              üéØ Sync CCS
            </button>

            <!-- S√©parateur vertical -->
            <div style="border-left: 1px solid var(--theme-border); height: 32px; margin: 0 4px;"></div>

            <!-- Boutons d'export -->
            <button id="btnCsv" class="btn secondary small" disabled>T√©l√©charger CSV</button>
            <button id="btnJson" class="btn secondary small" disabled>Export JSON</button>
            <button id="btnCopyJson" class="btn secondary small" disabled>üìã Copier JSON</button>

            <!-- Spacer -->
            <div style="flex-grow: 1;"></div>

            <!-- Pills de status -->
            <span id="selected-strategy-info" class="pill" style="display: none;">
              Aucune strat√©gie s√©lectionn√©e
            </span>
            <span id="dynamicTargetsIndicator" class="pill" style="background:var(--warning);color:white;display:none;">
              üéØ Targets dynamiques
            </span>
            <span id="total" class="pill">Total : ‚Äî</span>
            <span id="status" class="pill">Pr√™t.</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="tabs" id="rebalance-tabs">
      <button class="tab-btn active" data-target="#rebalance-tab">Rebalancing</button>
      <button class="tab-btn" data-target="#optimization-tab">Optimization</button>
    </div>
  </div>

  <main class="wrap tab-panel active" id="rebalance-tab">
    <!-- Param√®tres d'allocation intra-groupe -->
    <section class="card" style="margin-bottom: 16px;">
      <h3 style="margin-bottom: 12px;">‚öôÔ∏è Param√®tres d'Allocation</h3>
      <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <label for="sub-allocation-toggle" style="font-size: 14px; cursor: pointer;">
            Mode intra-groupe :
          </label>
          <label class="switch">
            <input type="checkbox" id="sub-allocation-toggle">
            <span class="slider"></span>
          </label>
          <span id="sub-allocation-label" style="font-weight: 600; color: var(--brand-primary);">
            Proportionnel
          </span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <label for="min-trade-input" style="font-size: 14px;">Trade minimum :</label>
          <input type="number" id="min-trade-input" value="25" min="1" max="1000" step="1"
            style="width: 80px; padding: 4px 8px; border: 1px solid var(--theme-border); border-radius: 4px;">
          <span style="font-size: 14px; color: var(--theme-text-muted);">USD</span>
        </div>
        <div id="priority-status" style="display: none; flex: 1; min-width: 200px;">
          <div style="font-size: 12px; color: var(--theme-text-muted); margin-bottom: 4px;">
            <span id="universe-source"></span> ‚Ä¢ <span id="universe-timestamp"></span>
          </div>
          <div id="priority-groups-info" style="font-size: 11px; color: var(--brand-primary);"></div>
        </div>
      </div>
    </section>

    <!-- Donuts -->
    <section class="card">
      <h3>R√©partition</h3>
      <div class="grid g2">
        <div>
          <div class="small muted">Actuelle</div>
          <div id="donutCurrent"></div>
        </div>
        <div>
          <div class="small muted">Cible</div>
          <div id="donutTarget"></div>
        </div>
      </div>
      <div id="legend" class="legend mt8"></div>
    </section>

    <!-- R√©sum√© -->
    <section id="dca-schedule" class="card mt16">
      <h3>R√©sum√© par groupe</h3>
      <div id="summary" class="grid g3 mt8"></div>
    </section>

    <!-- Actions -->
    <section id="funding-plan" class="card mt16">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <h3>Actions</h3>
        <div id="pricing-badge"></div>
      </div>
      <div style="overflow:auto;max-height:50vh;border:1px solid var(--theme-border);border-radius:var(--radius-md)">
        <table id="tblActions">
          <thead>
            <tr>
              <th class="sortable" data-sort="group">group <span class="sort-arrow">‚áÖ</span></th>
              <th class="sortable" data-sort="alias">alias <span class="sort-arrow">‚áÖ</span></th>
              <th class="sortable" data-sort="symbol">symbol <span class="sort-arrow">‚áÖ</span></th>
              <th class="sortable" data-sort="action">action <span class="sort-arrow">‚áÖ</span></th>
              <th class="sortable right" data-sort="usd">usd <span class="sort-arrow">‚áÖ</span></th>
              <th class="sortable right" data-sort="est_quantity">est_quantity <span class="sort-arrow">‚áÖ</span></th>
              <th class="sortable right" data-sort="price_used">price_used <span class="sort-arrow">‚áÖ</span></th>
              <th class="sortable" data-sort="location">location <span class="sort-arrow">‚áÖ</span></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Unknown aliases -->
    <section id="constraints" class="card mt16">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <h3>Unknown aliases</h3>
          <div class="small">Par d√©faut, <strong>Others</strong> est pr√©s√©lectionn√©.</div>
        </div>
        <div style="display:flex;gap:12px;align-items:flex-end">
          <div>
            <label class="small">Tout vers</label><br />
            <select id="bulk_group">
              <option value="BTC">BTC</option>
              <option value="ETH">ETH</option>
              <option value="Stablecoins">Stablecoins</option>
              <option value="SOL">SOL</option>
              <option value="L1/L0 majors">L1/L0 majors</option>
              <option value="L2/Scaling">L2/Scaling</option>
              <option value="DeFi">DeFi</option>
              <option value="AI/Data">AI/Data</option>
              <option value="Gaming/NFT">Gaming/NFT</option>
              <option value="Memecoins">Memecoins</option>
              <option value="Others" selected>Others</option>
            </select>
            <button id="btnBulkAdd" class="btn ghost">Ajouter tout</button>
          </div>
          <div id="alias-manager-button" style="display: none;">
            <button class="btn secondary small" onclick="openAliasManager()"
              title="Ouvrir l'interface de gestion des aliases">
              üè∑Ô∏è Alias Manager
            </button>
          </div>
        </div>
      </div>
      <div id="unknownList" class="small mt16"></div>
    </section>
  </main>

  <section id="optimization" class="wrap tab-panel">
    <div class="card">
      <div style="display:flex; align-items:center; gap:.5rem; margin-bottom:.5rem;">
        <h3 style="margin:0;">Optimization</h3>
        <button id="openOptimizationNewTab" class="btn secondary small" style="margin-left:auto;">Open in new
          tab</button>
      </div>
      <div id="optimization-container"></div>
      <div id="optimization-status" class="small muted" style="margin-top:.5rem; display:none"></div>
    </div>
  </section>


  <script type="module" src="modules/rebalance-controller.js"></script>


  <script type="module">
    import { GovernancePanel } from './components/GovernancePanel.js';

    // Initialize Governance Panel (Decision Engine) for rebalance page
    document.addEventListener('DOMContentLoaded', async function () {
      const governanceContainer = document.getElementById('governance-container');
      if (governanceContainer) {
        debugLogger.debug('üèõÔ∏è Initializing Governance Panel for rebalance...');
        const governancePanel = new GovernancePanel(governanceContainer);

        // Auto-refresh initial state
        setTimeout(() => {
          governancePanel.refreshState();
        }, 1000);

        // Store reference globally for debugging
        window.governancePanel = governancePanel;
        debugLogger.debug('‚úÖ Governance Panel initialized');
      }
    });
  </script>

</body>

</html>