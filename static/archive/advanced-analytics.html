<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Analytics Avanc√©s - Crypto Rebalancer</title>
    
    <!-- Navigation -->
    <link rel="stylesheet" href="simple-navigation.css">
    <script src="simple-navigation.js"></script>
    
    <!-- Theme & Charts -->
    <link rel="stylesheet" href="shared-theme.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            color: #ffffff;
            min-height: 100vh;
        }

        body.has-simple-nav {
            margin-left: 80px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 3rem;
            background: linear-gradient(45deg, #00ff88, #00aaff, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }

        .header p {
            color: #aaa;
            font-size: 1.2rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .panel-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #00ff88;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #00ff88;
            margin-bottom: 0.5rem;
        }

        .metric-label {
            color: #aaa;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 2rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 1rem;
        }

        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(135deg, #00ff88, #00aaff);
            color: black;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 255, 136, 0.3);
        }

        .btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .performance-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            overflow: hidden;
        }

        .performance-table th,
        .performance-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .performance-table th {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            font-weight: 600;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-good { background: #00ff88; }
        .status-warning { background: #ffaa00; }
        .status-error { background: #ff4444; }

        .drawdown-analysis {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
        }

        .sharpe-analysis {
            background: rgba(0, 170, 255, 0.1);
            border: 1px solid rgba(0, 170, 255, 0.3);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #aaa;
        }

        @media (max-width: 768px) {
            body.has-simple-nav {
                margin-left: 0;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body class="has-simple-nav">
    <div class="container">
        <div class="header">
            <h1>üìä Analytics Avanc√©s</h1>
            <p>M√©triques de performance d√©taill√©es et analyse de strat√©gies</p>
        </div>

        <!-- M√©triques Principales -->
        <div class="metric-grid">
            <div class="metric-card">
                <div class="metric-value" id="total-return">--</div>
                <div class="metric-label">Rendement Total</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="sharpe-ratio">--</div>
                <div class="metric-label">Ratio de Sharpe</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="max-drawdown">--</div>
                <div class="metric-label">Drawdown Max</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="volatility">--</div>
                <div class="metric-label">Volatilit√©</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="win-rate">--</div>
                <div class="metric-label">Taux de R√©ussite</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="rebal-frequency">--</div>
                <div class="metric-label">Fr√©q. Rebalancing</div>
            </div>
        </div>

        <!-- Contr√¥les -->
        <div class="controls">
            <button class="btn" onclick="loadPerformanceData()">üîÑ Actualiser Donn√©es</button>
            <button class="btn secondary" onclick="analyzeDrawdown()">üìâ Analyse Drawdown</button>
            <button class="btn secondary" onclick="compareStrategies()">‚öîÔ∏è Comparer Strat√©gies</button>
            <button class="btn secondary" onclick="generateReport()">üìã Rapport D√©taill√©</button>
            <button class="btn secondary" onclick="exportData()">üíæ Exporter</button>
        </div>

        <div class="dashboard-grid">
            <!-- Performance Timeline -->
            <div class="panel">
                <div class="panel-title">üìà Performance Timeline</div>
                <div class="chart-container">
                    <canvas id="performance-chart"></canvas>
                </div>
            </div>

            <!-- Analyse Drawdown -->
            <div class="panel drawdown-analysis">
                <div class="panel-title">üìâ Analyse des Drawdowns</div>
                <div class="chart-container">
                    <canvas id="drawdown-chart"></canvas>
                </div>
            </div>

            <!-- Distribution des Returns -->
            <div class="panel">
                <div class="panel-title">üìä Distribution des Returns</div>
                <div class="chart-container">
                    <canvas id="returns-distribution"></canvas>
                </div>
            </div>

            <!-- Ratio de Sharpe Rolling -->
            <div class="panel sharpe-analysis">
                <div class="panel-title">üìê Sharpe Ratio Rolling</div>
                <div class="chart-container">
                    <canvas id="sharpe-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Comparaison de Strat√©gies -->
        <div class="panel">
            <div class="panel-title">‚öîÔ∏è Comparaison Multi-Strat√©gies</div>
            <div id="strategy-comparison" class="loading">Chargement des donn√©es de comparaison...</div>
        </div>

        <!-- Table de Performance D√©taill√©e -->
        <div class="panel">
            <div class="panel-title">üìã Performance D√©taill√©e</div>
            <table class="performance-table">
                <thead>
                    <tr>
                        <th>M√©trique</th>
                        <th>Valeur</th>
                        <th>Benchmark</th>
                        <th>Status</th>
                        <th>P√©riode</th>
                    </tr>
                </thead>
                <tbody id="performance-details">
                    <tr>
                        <td>Rendement Annualis√©</td>
                        <td id="annualized-return">--</td>
                        <td>15.2%</td>
                        <td><span class="status-indicator status-good"></span>Excellent</td>
                        <td>12M</td>
                    </tr>
                    <tr>
                        <td>Volatilit√© Annualis√©e</td>
                        <td id="annualized-vol">--</td>
                        <td>22.5%</td>
                        <td><span class="status-indicator status-warning"></span>Mod√©r√©</td>
                        <td>12M</td>
                    </tr>
                    <tr>
                        <td>Max Drawdown</td>
                        <td id="max-dd">--</td>
                        <td>-15.3%</td>
                        <td><span class="status-indicator status-good"></span>Bon</td>
                        <td>12M</td>
                    </tr>
                    <tr>
                        <td>Calmar Ratio</td>
                        <td id="calmar-ratio">--</td>
                        <td>1.2</td>
                        <td><span class="status-indicator status-good"></span>Excellent</td>
                        <td>12M</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        
        // Variables globales pour les graphiques
        let performanceChart, drawdownChart, returnsChart, sharpeChart;
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initializeNavigation();
            initializeCharts();
            loadPerformanceData();
        });

        function initializeNavigation() {
            if (typeof createSimpleNavigation !== 'undefined') {
                window.simpleNavigation = createSimpleNavigation('advanced-analytics');
                document.body.classList.add('has-simple-nav');
            }
        }

        function initializeCharts() {
            // Configuration commune
            Chart.defaults.color = '#ffffff';
            Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
            Chart.defaults.backgroundColor = 'rgba(255, 255, 255, 0.1)';

            // Performance Chart
            const perfCtx = document.getElementById('performance-chart').getContext('2d');
            performanceChart = new Chart(perfCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Performance Portfolio',
                        data: [],
                        borderColor: '#00ff88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Benchmark BTC',
                        data: [],
                        borderColor: '#00aaff',
                        backgroundColor: 'rgba(0, 170, 255, 0.1)',
                        fill: false,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: { callback: value => value.toFixed(1) + '%' }
                        }
                    }
                }
            });

            // Drawdown Chart
            const ddCtx = document.getElementById('drawdown-chart').getContext('2d');
            drawdownChart = new Chart(ddCtx, {
                type: 'area',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Drawdown (%)',
                        data: [],
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            max: 0,
                            ticks: { callback: value => value.toFixed(1) + '%' }
                        }
                    }
                }
            });

            // Returns Distribution
            const retCtx = document.getElementById('returns-distribution').getContext('2d');
            returnsChart = new Chart(retCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Fr√©quence',
                        data: [],
                        backgroundColor: 'rgba(0, 255, 136, 0.6)',
                        borderColor: '#00ff88',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Rendement Daily (%)' } },
                        y: { title: { display: true, text: 'Fr√©quence' } }
                    }
                }
            });

            // Sharpe Ratio Rolling
            const sharpeCtx = document.getElementById('sharpe-chart').getContext('2d');
            sharpeChart = new Chart(sharpeCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Sharpe Ratio (30d)',
                        data: [],
                        borderColor: '#00aaff',
                        backgroundColor: 'rgba(0, 170, 255, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            ticks: { callback: value => value.toFixed(2) }
                        }
                    }
                }
            });
        }

        async function loadPerformanceData() {
            try {
                console.log('Loading performance data...');
                
                // Charger les vraies donn√©es depuis l'API
                const [metricsResponse, timeseriesResponse] = await Promise.all([
                    fetch(`${API_BASE}/analytics/advanced/metrics?days=365`),
                    fetch(`${API_BASE}/analytics/advanced/timeseries?days=365`)
                ]);
                
                if (metricsResponse.ok && timeseriesResponse.ok) {
                    const metrics = await metricsResponse.json();
                    const timeseries = await timeseriesResponse.json();
                    
                    updateMetrics(metrics);
                    updateChartsFromAPI(timeseries);
                    updatePerformanceTableFromAPI(metrics);
                } else {
                    console.warn('API not available, using mock data');
                    const mockData = generateMockPerformanceData();
                    updateMetrics(mockData.metrics);
                    updateCharts(mockData.timeSeriesData);
                    updatePerformanceTable(mockData.detailedMetrics);
                }
                
            } catch (error) {
                console.error('Error loading performance data:', error);
                // Fallback to mock data
                const mockData = generateMockPerformanceData();
                updateMetrics(mockData.metrics);
                updateCharts(mockData.timeSeriesData);
                updatePerformanceTable(mockData.detailedMetrics);
            }
        }

        function generateMockPerformanceData() {
            const dates = [];
            const performance = [];
            const benchmark = [];
            const drawdown = [];
            const sharpe = [];
            
            let portfolioValue = 100;
            let benchmarkValue = 100;
            let peak = 100;
            
            for (let i = 0; i < 365; i++) {
                const date = new Date();
                date.setDate(date.getDate() - (365 - i));
                dates.push(date.toLocaleDateString());
                
                // Performance simul√©e
                const dailyReturn = (Math.random() - 0.48) * 0.03; // Slight positive bias
                const benchmarkReturn = (Math.random() - 0.5) * 0.04;
                
                portfolioValue *= (1 + dailyReturn);
                benchmarkValue *= (1 + benchmarkReturn);
                
                performance.push(((portfolioValue / 100) - 1) * 100);
                benchmark.push(((benchmarkValue / 100) - 1) * 100);
                
                // Drawdown
                if (portfolioValue > peak) peak = portfolioValue;
                const currentDrawdown = ((portfolioValue - peak) / peak) * 100;
                drawdown.push(currentDrawdown);
                
                // Sharpe ratio approximation
                const rollingReturn = performance.slice(-30).reduce((a, b) => a + b, 0) / 30;
                const rollingSharpe = rollingReturn / Math.max(0.1, Math.abs(rollingReturn) * 0.5);
                sharpe.push(rollingSharpe);
            }
            
            return {
                metrics: {
                    totalReturn: ((portfolioValue / 100) - 1) * 100,
                    sharpeRatio: 1.85,
                    maxDrawdown: Math.min(...drawdown),
                    volatility: 18.3,
                    winRate: 58.7,
                    rebalFrequency: 12.5
                },
                timeSeriesData: {
                    dates,
                    performance,
                    benchmark,
                    drawdown,
                    sharpe
                },
                detailedMetrics: {
                    annualizedReturn: 24.8,
                    annualizedVol: 18.3,
                    maxDrawdown: Math.min(...drawdown),
                    calmarRatio: 1.35
                }
            };
        }

        function updateMetrics(metrics) {
            // Support both API format and mock format
            const totalReturn = metrics.total_return_pct || metrics.totalReturn;
            const sharpeRatio = metrics.sharpe_ratio || metrics.sharpeRatio;
            const maxDrawdown = metrics.max_drawdown_pct || metrics.maxDrawdown;
            const volatility = metrics.volatility_pct || metrics.volatility;
            const winRate = metrics.positive_months_pct || metrics.winRate;
            const rebalFreq = metrics.avg_drawdown_duration_days || metrics.rebalFrequency;

            document.getElementById('total-return').textContent = 
                totalReturn.toFixed(1) + '%';
            document.getElementById('sharpe-ratio').textContent = 
                sharpeRatio.toFixed(2);
            document.getElementById('max-drawdown').textContent = 
                maxDrawdown.toFixed(1) + '%';
            document.getElementById('volatility').textContent = 
                volatility.toFixed(1) + '%';
            document.getElementById('win-rate').textContent = 
                winRate.toFixed(1) + '%';
            document.getElementById('rebal-frequency').textContent = 
                rebalFreq.toFixed(1) + 'j';
        }

        function updateCharts(data) {
            // Performance Chart
            performanceChart.data.labels = data.dates;
            performanceChart.data.datasets[0].data = data.performance;
            performanceChart.data.datasets[1].data = data.benchmark;
            performanceChart.update('none');

            // Drawdown Chart
            drawdownChart.data.labels = data.dates;
            drawdownChart.data.datasets[0].data = data.drawdown;
            drawdownChart.update('none');

            // Sharpe Chart
            sharpeChart.data.labels = data.dates;
            sharpeChart.data.datasets[0].data = data.sharpe;
            sharpeChart.update('none');

            // Returns Distribution (histogram)
            const returns = data.performance.slice(1).map((val, i) => val - data.performance[i]);
            const histogram = createHistogram(returns, 20);
            returnsChart.data.labels = histogram.labels;
            returnsChart.data.datasets[0].data = histogram.counts;
            returnsChart.update('none');
        }

        function updatePerformanceTable(metrics) {
            const annualizedReturn = metrics.annualizedReturn || metrics.annualized_return_pct;
            const annualizedVol = metrics.annualizedVol || metrics.volatility_pct;
            const maxDD = metrics.maxDrawdown || metrics.max_drawdown_pct;
            const calmarRatio = metrics.calmarRatio || metrics.calmar_ratio;

            document.getElementById('annualized-return').textContent = 
                annualizedReturn.toFixed(1) + '%';
            document.getElementById('annualized-vol').textContent = 
                annualizedVol.toFixed(1) + '%';
            document.getElementById('max-dd').textContent = 
                maxDD.toFixed(1) + '%';
            document.getElementById('calmar-ratio').textContent = 
                calmarRatio.toFixed(2);
        }

        function updateChartsFromAPI(timeseries) {
            // Performance Chart
            performanceChart.data.labels = timeseries.dates;
            performanceChart.data.datasets[0].data = timeseries.cumulative_returns;
            // Pas de benchmark dans l'API pour l'instant
            performanceChart.data.datasets[1].data = [];
            performanceChart.update('none');

            // Drawdown Chart
            drawdownChart.data.labels = timeseries.dates;
            drawdownChart.data.datasets[0].data = timeseries.drawdowns;
            drawdownChart.update('none');

            // Sharpe Chart
            sharpeChart.data.labels = timeseries.dates;
            sharpeChart.data.datasets[0].data = timeseries.rolling_sharpe;
            sharpeChart.update('none');

            // Returns Distribution (histogram)
            const histogram = createHistogram(timeseries.returns, 20);
            returnsChart.data.labels = histogram.labels;
            returnsChart.data.datasets[0].data = histogram.counts;
            returnsChart.update('none');
        }

        function updatePerformanceTableFromAPI(metrics) {
            updatePerformanceTable({
                annualizedReturn: metrics.annualized_return_pct,
                annualizedVol: metrics.volatility_pct,
                maxDrawdown: metrics.max_drawdown_pct,
                calmarRatio: metrics.calmar_ratio
            });
        }

        function createHistogram(data, bins) {
            const min = Math.min(...data);
            const max = Math.max(...data);
            const binWidth = (max - min) / bins;
            
            const labels = [];
            const counts = new Array(bins).fill(0);
            
            for (let i = 0; i < bins; i++) {
                labels.push((min + i * binWidth).toFixed(2));
            }
            
            data.forEach(value => {
                const binIndex = Math.min(Math.floor((value - min) / binWidth), bins - 1);
                counts[binIndex]++;
            });
            
            return { labels, counts };
        }

        async function analyzeDrawdown() {
            try {
                const response = await fetch(`${API_BASE}/analytics/advanced/drawdown-analysis?days=365`);
                if (response.ok) {
                    const data = await response.json();
                    
                    const summary = data.summary;
                    alert(`üîç Analyse Drawdown:\n\n` +
                          `‚Ä¢ P√©riodes de drawdown: ${summary.total_drawdown_periods}\n` +
                          `‚Ä¢ Drawdown moyen: ${summary.avg_drawdown_pct.toFixed(1)}%\n` +
                          `‚Ä¢ Dur√©e moyenne: ${summary.avg_duration_days.toFixed(0)} jours\n` +
                          `‚Ä¢ Dur√©e max: ${summary.max_duration_days} jours\n` +
                          `‚Ä¢ Taux de r√©cup√©ration: ${(summary.recovery_rate * 100).toFixed(1)}%`);
                } else {
                    alert('üîç Erreur lors du chargement de l\'analyse de drawdown');
                }
            } catch (error) {
                alert('üîç Analyse Drawdown non disponible actuellement');
            }
        }

        async function compareStrategies() {
            try {
                const response = await fetch(`${API_BASE}/analytics/advanced/strategy-comparison?strategies=rebalancing&strategies=buy_hold&strategies=momentum`);
                if (response.ok) {
                    const data = await response.json();
                    
                    let resultText = '‚öîÔ∏è Comparaison Strat√©gies:\n\n';
                    Object.entries(data.comparison).forEach(([strategy, metrics]) => {
                        resultText += `${strategy.toUpperCase()}:\n`;
                        resultText += `  ‚Ä¢ Return: ${metrics.total_return.toFixed(1)}%\n`;
                        resultText += `  ‚Ä¢ Sharpe: ${metrics.sharpe_ratio.toFixed(2)}\n`;
                        resultText += `  ‚Ä¢ Max DD: ${metrics.max_drawdown.toFixed(1)}%\n\n`;
                    });
                    
                    resultText += `üèÜ Meilleure strat√©gie: ${data.best_overall.toUpperCase()}`;
                    alert(resultText);
                } else {
                    alert('‚öîÔ∏è Erreur lors de la comparaison des strat√©gies');
                }
            } catch (error) {
                alert('‚öîÔ∏è Comparaison multi-strat√©gies non disponible actuellement');
            }
        }

        function generateReport() {
            alert('üìã G√©n√©ration de rapport PDF disponible dans la version pro');
        }

        function exportData() {
            alert('üíæ Export CSV/JSON des m√©triques disponible');
        }

        console.log('üìä Advanced Analytics Dashboard initialized');
    </script>
</body>
</html>