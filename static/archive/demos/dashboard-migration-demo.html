<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üìä Dashboard Migration Demo - Strategy API PR-C</title>
    <link rel="stylesheet" href="shared-theme.css">
    <link rel="stylesheet" href="theme-compat.css">
    <script type="module" src="components/nav.js"></script>
    <script type="module" src="components/tooltips.js"></script>

    <script src="debug-logger.js"></script>
    <script src="input-validator.js"></script>
    <script src="performance-optimizer.js"></script>
    <script src="global-config.js"></script>
    <script src="appearance.js"></script>
    
    <style>
        .migration-demo-header {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            color: white;
            padding: 15px;
            margin: -20px -20px 20px -20px;
            border-radius: 8px 8px 0 0;
        }
        
        .migration-controls-inline {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .strategy-info-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .targets-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .target-item {
            text-align: center;
            padding: 10px;
            background: var(--bg-primary);
            border-radius: 4px;
            border: 1px solid var(--border);
        }
        
        .target-symbol {
            font-weight: bold;
            font-size: 14px;
            color: var(--text-primary);
        }
        
        .target-weight {
            font-size: 18px;
            color: var(--accent);
            margin: 5px 0;
        }
        
        .target-rationale {
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        .comparison-mode {
            background: var(--warning);
            color: black;
            padding: 8px;
            border-radius: 4px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
    </style>

    <script type="module">
        // MIGRATION DEMO - Comparing Legacy vs Strategy API
        import { getUnifiedState as getUnifiedStateV1 } from './core/unified-insights.js';
        import { getUnifiedState as getUnifiedStateV2, deriveRecommendations } from './core/unified-insights-v2.js';
        import { createMigrationIndicator } from './components/MigrationControls.js';
        import { StrategyConfig } from './core/strategy-api-adapter.js';
        import { store } from './core/risk-dashboard-store.js';
        
        const colorForScore = (s) => s>70?'var(--danger)':s>=40?'var(--warning)':'var(--success)';
        
        let currentMode = 'api'; // 'legacy', 'api', 'comparison'
        let refreshInterval;
        
        // Migration controls
        const migrationControlsContainer = document.querySelector('.migration-controls-inline');
        const migrationIndicator = createMigrationIndicator(migrationControlsContainer, (enabled) => {
            currentMode = enabled ? 'api' : 'legacy';
            document.getElementById('mode-display').textContent = enabled ? 'Strategy API (V2)' : 'Legacy (V1)';
            refreshGI();
        });
        
        // Add comparison mode toggle
        const comparisonBtn = document.createElement('button');
        comparisonBtn.textContent = 'Compare';
        comparisonBtn.style.cssText = 'margin-left: 8px; padding: 4px 8px; font-size: 11px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary); cursor: pointer;';
        comparisonBtn.addEventListener('click', () => {
            currentMode = currentMode === 'comparison' ? 'api' : 'comparison';
            comparisonBtn.textContent = currentMode === 'comparison' ? 'Stop Compare' : 'Compare';
            document.getElementById('mode-display').textContent = currentMode === 'comparison' ? 'Comparison Mode' : 'Strategy API (V2)';
            refreshGI();
        });
        migrationControlsContainer.appendChild(comparisonBtn);
        
        async function refreshGI(){
            try {
                console.debug('üß† Refreshing Global Insight - Demo Mode:', currentMode);
                
                if (currentMode === 'comparison') {
                    await refreshComparisonMode();
                    return;
                }
                
                // Use appropriate version based on mode
                const getUnifiedState = currentMode === 'api' ? getUnifiedStateV2 : getUnifiedStateV1;
                const startTime = performance.now();
                const unifiedState = await getUnifiedState();
                const endTime = performance.now();
                
                console.debug('‚úÖ Unified state loaded:', {
                    version: currentMode,
                    execution_time: `${(endTime - startTime).toFixed(1)}ms`,
                    decision_score: unifiedState.decision?.score,
                    migration_status: unifiedState.intelligence?.migration_status || 'legacy'
                });
                
                // Update main display
                updateGlobalInsight(unifiedState, endTime - startTime);
                
                // Update strategy info panel (API only)
                updateStrategyInfo(unifiedState);
                
                // Derive and display recommendations
                const recommendations = deriveRecommendations(unifiedState);
                updateRecommendations(recommendations);
                
            } catch(e) {
                console.error('‚ùå Global Insight refresh failed:', e);
                document.getElementById('gi-content').innerHTML = `
                    <div class="gi-error">
                        <span class="gi-score">‚ö†Ô∏è</span>
                        <span class="gi-label">Error loading insights</span>
                        <span class="gi-details">${e.message}</span>
                    </div>
                `;
            }
        }
        
        async function refreshComparisonMode() {
            try {
                console.debug('üìä Comparison mode - loading both versions...');
                
                const [legacyState, apiState] = await Promise.all([
                    getUnifiedStateV1(),
                    getUnifiedStateV2()
                ]);
                
                updateComparisonDisplay(legacyState, apiState);
                
            } catch (e) {
                console.error('‚ùå Comparison mode failed:', e);
            }
        }
        
        function updateGlobalInsight(unifiedState, executionTime) {
            const giContent = document.getElementById('gi-content');
            const decision = unifiedState.decision || {};
            const cycle = unifiedState.cycle || {};
            const risk = unifiedState.risk || {};
            const regime = unifiedState.regime || {};
            
            const score = decision.score ?? 50;
            const confidence = Math.round((decision.confidence || 0.5) * 100);
            
            giContent.innerHTML = `
                <div class="gi-main">
                    <div class="gi-score" style="color: ${colorForScore(score)}">${Math.round(score)}</div>
                    <div class="gi-label">Global Intelligence Score</div>
                    <div class="gi-confidence">Confiance: ${confidence}%</div>
                    <div class="gi-details">${decision.reasoning || 'Analyse en cours...'}</div>
                </div>
                
                <div class="gi-components">
                    <div class="gi-component">
                        <div class="component-label">Cycle</div>
                        <div class="component-value" style="color: ${colorForScore(cycle.score || 50)}">${cycle.score || '--'}</div>
                        <div class="component-detail">${cycle.phase?.description || cycle.phase?.phase || 'N/A'}</div>
                    </div>
                    <div class="gi-component">
                        <div class="component-label">Risk</div>
                        <div class="component-value" style="color: ${colorForScore(100 - (risk.score || 50))}">${risk.score || '--'}</div>
                        <div class="component-detail">${risk.volatility ? `Vol: ${(risk.volatility * 100).toFixed(1)}%` : 'N/A'}</div>
                    </div>
                    <div class="gi-component">
                        <div class="component-label">Regime</div>
                        <div class="component-value">${regime.emoji || 'üìä'}</div>
                        <div class="component-detail">${regime.name || 'Unknown'}</div>
                    </div>
                    <div class="gi-component">
                        <div class="component-label">Performance</div>
                        <div class="component-value">${executionTime.toFixed(0)}ms</div>
                        <div class="component-detail">${currentMode}</div>
                    </div>
                </div>
            `;
        }
        
        function updateStrategyInfo(unifiedState) {
            const strategyPanel = document.getElementById('strategy-info-panel');
            const strategy = unifiedState.strategy;
            
            if (!strategy || !strategy.enabled) {
                strategyPanel.style.display = 'none';
                return;
            }
            
            strategyPanel.style.display = 'block';
            
            const targetsHtml = strategy.targets?.map(target => `
                <div class="target-item">
                    <div class="target-symbol">${target.symbol}</div>
                    <div class="target-weight">${(target.weight * 100).toFixed(1)}%</div>
                    <div class="target-rationale">${target.rationale || ''}</div>
                </div>
            `).join('') || '<div>Pas de targets disponibles</div>';
            
            document.getElementById('strategy-details').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <strong>Template:</strong> ${strategy.template_used || 'N/A'}<br>
                        <strong>Policy:</strong> ${strategy.policy_hint || 'N/A'}
                    </div>
                    <div style="text-align: right; font-size: 12px; color: var(--text-secondary);">
                        ${strategy.generated_at ? new Date(strategy.generated_at).toLocaleTimeString() : 'N/A'}
                    </div>
                </div>
                
                <div class="targets-display">
                    ${targetsHtml}
                </div>
            `;
        }
        
        function updateComparisonDisplay(legacyState, apiState) {
            const giContent = document.getElementById('gi-content');
            
            const legacyScore = legacyState.decision?.score ?? 50;
            const apiScore = apiState.decision?.score ?? 50;
            const scoreDiff = Math.abs(legacyScore - apiScore);
            
            giContent.innerHTML = `
                <div class="comparison-mode">
                    üîÑ Mode Comparaison: Legacy vs Strategy API
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="comparison-panel">
                        <h4>üî¥ Legacy (V1)</h4>
                        <div class="gi-score" style="color: ${colorForScore(legacyScore)}">${Math.round(legacyScore)}</div>
                        <div class="gi-details">Source: Frontend calculation</div>
                        <div class="gi-confidence">Confiance: ${Math.round((legacyState.decision?.confidence || 0.5) * 100)}%</div>
                    </div>
                    
                    <div class="comparison-panel">
                        <h4>üöÄ Strategy API (V2)</h4>
                        <div class="gi-score" style="color: ${colorForScore(apiScore)}">${Math.round(apiScore)}</div>
                        <div class="gi-details">Template: ${apiState.strategy?.template_used || 'N/A'}</div>
                        <div class="gi-confidence">Policy: ${apiState.strategy?.policy_hint || 'N/A'}</div>
                    </div>
                </div>
                
                <div class="comparison-analysis" style="margin-top: 15px; padding: 10px; background: var(--bg-primary); border-radius: 4px;">
                    <strong>Analyse:</strong>
                    Diff√©rence de score: ${scoreDiff.toFixed(1)} points
                    (${scoreDiff < 5 ? '‚úÖ Excellente coh√©rence' : scoreDiff < 15 ? '‚ö†Ô∏è Coh√©rence acceptable' : '‚ùå R√©vision n√©cessaire'})
                </div>
            `;
            
            // Update strategy panel with API data
            updateStrategyInfo(apiState);
        }
        
        function updateRecommendations(recommendations) {
            const recoContainer = document.getElementById('recommendations-container');
            
            if (!recommendations || recommendations.length === 0) {
                recoContainer.innerHTML = '<div class="no-recommendations">Aucune recommandation pour le moment</div>';
                return;
            }
            
            const recoHtml = recommendations.slice(0, 4).map(reco => `
                <div class="recommendation-item priority-${reco.priority}">
                    <span class="reco-icon">${reco.icon}</span>
                    <div class="reco-content">
                        <div class="reco-title">${reco.title}</div>
                        <div class="reco-reason">${reco.reason}</div>
                        <div class="reco-source">Source: ${reco.source}</div>
                    </div>
                </div>
            `).join('');
            
            recoContainer.innerHTML = recoHtml;
        }
        
        // Auto-refresh setup
        function startAutoRefresh() {
            refreshGI();
            refreshInterval = setInterval(refreshGI, 30000); // Refresh every 30s
        }
        
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
        
        // Initialize with fallback approach
        function initializeMigrationDemo() {
            try {
                console.log('üöÄ Dashboard Migration Demo initializing...');
                
                // Enable Strategy API by default for demo
                StrategyConfig.setEnabled(true);
                StrategyConfig.setDebugMode(true);
                
                console.log('‚úÖ Strategy API configured, starting auto-refresh...');
                startAutoRefresh();
                console.log('üöÄ Dashboard Migration Demo initialized successfully');
            } catch (error) {
                console.error('‚ùå Migration demo initialization failed:', error);
                
                // Show error in UI
                document.getElementById('gi-content').innerHTML = `
                    <div class="gi-error">
                        <span class="gi-score">‚ùå</span>
                        <span class="gi-label">Initialization Error</span>
                        <span class="gi-details">${error.message}</span>
                    </div>
                `;
            }
        }
        
        // Try immediate initialization, fallback to delayed
        window.addEventListener('DOMContentLoaded', () => {
            if (window.globalConfig) {
                console.log('‚úÖ globalConfig available immediately');
                initializeMigrationDemo();
            } else {
                console.log('‚è≥ globalConfig not ready, waiting...');
                setTimeout(() => {
                    if (window.globalConfig) {
                        console.log('‚úÖ globalConfig ready after delay');
                        initializeMigrationDemo();
                    } else {
                        console.error('‚ùå globalConfig still not available, initializing anyway...');
                        initializeMigrationDemo();
                    }
                }, 500);
            }
        });
        
        window.addEventListener('beforeunload', stopAutoRefresh);
        
        // Expose for debugging
        window.migrationDemo = {
            refreshGI,
            setMode: (mode) => { 
                currentMode = mode; 
                refreshGI(); 
            },
            getUnifiedStateV1,
            getUnifiedStateV2,
            StrategyConfig
        };
    </script>
</head>

<body>
    <div class="container">
        <div class="migration-demo-header">
            <h1>üìä Dashboard Migration Demo</h1>
            <p>D√©monstration de la migration de <code>calculateIntelligentDecisionIndex</code> vers l'API Strategy (PR-C)</p>
            <div class="migration-controls-inline"></div>
        </div>
        
        <!-- Mode indicator -->
        <div style="text-align: center; margin-bottom: 20px; padding: 8px; background: var(--bg-secondary); border-radius: 4px;">
            <strong>Mode actuel:</strong> <span id="mode-display">Strategy API (V2)</span>
        </div>
        
        <!-- Strategy Info Panel (API only) -->
        <div id="strategy-info-panel" class="strategy-info-panel">
            <h3>üéØ Strategy API Information</h3>
            <div id="strategy-details">Chargement des donn√©es strategy...</div>
        </div>
        
        <!-- Main Global Insight Display -->
        <div class="global-insight-widget">
            <div class="gi-header">
                <h2>üß† Global Intelligence</h2>
                <div class="gi-subtitle">Analyse unifi√©e des signaux crypto</div>
            </div>
            
            <div id="gi-content" class="gi-content">
                <div class="gi-loading">
                    <span class="gi-score">‚è≥</span>
                    <span class="gi-label">Chargement de l'intelligence...</span>
                </div>
            </div>
        </div>
        
        <!-- Recommendations -->
        <div class="recommendations-widget">
            <div class="widget-header">
                <h3>üí° Recommandations Intelligentes</h3>
            </div>
            <div id="recommendations-container" class="recommendations-container">
                Chargement des recommandations...
            </div>
        </div>
        
        <!-- Debug info -->
        <details style="margin-top: 30px;">
            <summary style="cursor: pointer; padding: 10px; background: var(--bg-secondary); border-radius: 4px;">
                üîß Debug & Performance Info
            </summary>
            <div style="margin-top: 10px; padding: 15px; background: var(--bg-primary); border-radius: 4px; font-family: monospace; font-size: 12px;">
                <div>Ouvrir la console d√©veloppeur pour les logs d√©taill√©s</div>
                <div>API Strategy: <span id="api-status">V√©rification...</span></div>
                <div>Cache TTL: 60s</div>
                <div>Auto-refresh: 30s</div>
            </div>
        </details>
    </div>

    <style>
        .global-insight-widget {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .gi-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .gi-header h2 {
            margin: 0;
            color: var(--text-primary);
        }

        .gi-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 5px;
        }

        .gi-content {
            text-align: center;
        }

        .gi-main {
            margin-bottom: 20px;
        }

        .gi-score {
            font-size: 4em;
            font-weight: bold;
            display: block;
            margin-bottom: 10px;
        }

        .gi-label {
            font-size: 18px;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .gi-confidence {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .gi-details {
            font-size: 13px;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.4;
        }

        .gi-components {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .gi-component {
            text-align: center;
            padding: 15px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .component-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .component-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .component-detail {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .gi-loading {
            padding: 40px 20px;
        }

        .gi-error {
            padding: 20px;
            color: var(--danger);
        }

        .recommendations-widget {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .widget-header {
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        .widget-header h3 {
            margin: 0;
            color: var(--text-primary);
        }

        .recommendations-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .recommendation-item {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            transition: border-color 0.3s;
        }

        .recommendation-item.priority-high {
            border-left: 4px solid var(--danger);
        }

        .recommendation-item.priority-medium {
            border-left: 4px solid var(--warning);
        }

        .recommendation-item.priority-low {
            border-left: 4px solid var(--success);
        }

        .reco-icon {
            font-size: 20px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .reco-content {
            flex-grow: 1;
        }

        .reco-title {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .reco-reason {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .reco-source {
            font-size: 11px;
            color: var(--text-muted);
            font-style: italic;
        }

        .no-recommendations {
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
            font-style: italic;
        }

        .comparison-panel {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }

        .comparison-panel h4 {
            margin-top: 0;
            color: var(--text-primary);
        }
    </style>
</body>

</html>