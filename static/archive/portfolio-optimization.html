<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio Optimization - Crypto Portfolio</title>

  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">

  <script src="global-config.js"></script>
  <script src="appearance.js"></script>

  <!-- Chart.js for visualizations -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>

  <!-- Navigation Simple -->
  <link rel="stylesheet" href="simple-navigation.css">
  <script src="simple-navigation.js"></script>
  <link rel="stylesheet" href="navigation-fix.css">

  <style>
    /* Styles sp√©cifiques √† l'optimisation */
    .optimization-grid {
      display: grid;
      grid-template-columns: minmax(350px, 1fr) minmax(450px, 1.5fr);
      gap: var(--space-xl);
      align-items: start;
    }

    .control-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-md); 
      margin-bottom: var(--space-lg);
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
    }

    .control-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--theme-text-muted);
    }

    .button-group {
      display: flex;
      gap: var(--space-sm);
      flex-wrap: wrap;
      margin: var(--space-lg) 0;
    }

    .advanced-section {
      background: var(--theme-surface-elevated);
      border-radius: var(--radius-md);
      padding: var(--space-lg);
      margin: var(--space-lg) 0;
      border: 1px solid var(--theme-border);
    }

    .advanced-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-md);
    }

    .metric-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: var(--space-sm);
      margin: var(--space-lg) 0;
    }

    .weight-table {
      width: 100%;
      border-collapse: collapse;
      margin: var(--space-lg) 0;
    }

    .weight-table th,
    .weight-table td {
      padding: var(--space-md);
      text-align: left;
      border-bottom: 1px solid var(--theme-border);
    }

    .weight-table th {
      background: var(--theme-surface-elevated);
      font-weight: 600;
      color: var(--theme-text);
    }

    .weight-bar {
      height: 6px;
      background: var(--brand-primary);
      border-radius: var(--radius-sm);
      margin-top: var(--space-xs);
    }

    .trade-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-md);
      background: var(--theme-surface-elevated);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-sm);
      border-left: 4px solid var(--theme-border);
    }

    .trade-buy {
      border-left-color: var(--success);
    }

    .trade-sell {
      border-left-color: var(--warning);
    }

    .priority-high {
      border-left-color: var(--danger);
    }

    .priority-medium {
      border-left-color: var(--warning);
    }

    .priority-low {
      border-left-color: var(--success);
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin: var(--space-xl) 0;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .optimization-grid {
        grid-template-columns: 1fr;
      }

      .control-grid {
        grid-template-columns: 1fr;
      }

      .advanced-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .button-group {
        flex-direction: column;
      }

      .button-group .btn {
        width: 100%;
      }

      .metric-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .metric-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="card">
      <div class="card-header">
        <h1 class="card-title">üìä Portfolio Optimization</h1>
        <p class="card-description">Optimize your portfolio allocation using Markowitz theory</p>
      </div>

      <div class="card-content">
        <div class="alert alert-info">
          Uses cached daily price history. If many assets are excluded, pre-download histories or lower Min History.
        </div>

        <div class="optimization-grid">
          <!-- Left Panel: Settings -->
          <div class="left-panel">
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Optimization Settings</h2>
              </div>

              <div class="card-content">
                <div class="control-grid">
                  <div class="control-group">
                    <label for="data-source" class="control-label">Data Source</label>
                    <select id="data-source" class="form-input form-select">
                      <option value="cointracking">CoinTracking CSV</option>
                      <option value="cointracking_api">CoinTracking API</option>
                      <option value="stub" selected>Test Data (Stub)</option>
                    </select>
                  </div>

                  <div class="control-group">
                    <label for="objective" class="control-label">Objective</label>
                    <select id="objective" class="form-input form-select">
                      <option value="max_sharpe">Max Sharpe (recommended)</option>
                      <option value="min_variance">Minimize Risk</option>
                      <option value="max_return">Maximize Return</option>
                      <option value="risk_parity">Risk Parity</option>
                      <option value="mean_reversion">Mean Reversion</option>
                    </select>
                  </div>

                  <div class="control-group">
                    <label for="method" class="control-label">Return Model</label>
                    <select id="method" class="form-input form-select">
                      <option value="mean_reversion" selected>Mean Reversion</option>
                      <option value="historical">Historical</option>
                      <option value="momentum">Momentum</option>
                    </select>
                  </div>

                  <div class="control-group">
                    <label for="lookback" class="control-label">History Window</label>
                    <select id="lookback" class="form-input form-select">
                      <option value="90">3 Months</option>
                      <option value="180">6 Months</option>
                      <option value="365" selected>1 Year</option>
                      <option value="730">2 Years</option>
                      <option value="1095">3 Years</option>
                      <option value="1460">4 Years</option>
                    </select>
                  </div>

                  <div class="control-group">
                    <label for="min-history" class="control-label">Min History</label>
                    <select id="min-history" class="form-input form-select">
                      <option value="90">3 Months</option>
                      <option value="180">6 Months</option>
                      <option value="365" selected>1 Year</option>
                      <option value="730">2 Years</option>
                      <option value="1095">3 Years</option>
                      <option value="1460">4 Years</option>
                    </select>
                  </div>

                  <div class="control-group">
                    <label for="min-usd" class="control-label">Min USD</label>
                    <input type="number" id="min-usd" value="100" min="1" class="form-input">
                  </div>

                  <div class="control-group">
                    <label class="control-label">Mode</label>
                    <div class="checkbox-group">
                      <input type="checkbox" id="conservative" onchange="updateConstraints()" checked>
                      <label for="conservative" class="text-muted">Conservative</label>
                    </div>
                  </div>
                </div>

                <div class="button-group">
                  <button class="btn btn-secondary" id="analyze-btn" onclick="runAnalysis()">
                    üîç Analyze
                  </button>
                  <button class="btn btn-primary" id="optimize-btn" onclick="runOptimization()">
                    üöÄ Optimize
                  </button>
                  <button class="btn btn-ghost" onclick="loadDefaults()">
                    üîÑ Reset
                  </button>
                </div>

                <!-- Advanced Constraints -->
                <details class="advanced-section">
                  <summary style="cursor: pointer; font-weight: 600; color: var(--theme-text-muted);">
                    ‚öôÔ∏è Advanced Risk Constraints
                  </summary>

                  <div class="advanced-grid" style="margin-top: var(--space-md);">
                    <div class="control-group">
                      <label for="max-weight" class="control-label">Max Asset Weight (%)</label>
                      <input type="number" id="max-weight" value="40" min="1" max="100" class="form-input">
                    </div>

                    <div class="control-group">
                      <label for="max-sector" class="control-label">Max Sector Weight (%)</label>
                      <input type="number" id="max-sector" value="50" min="1" max="100" class="form-input">
                    </div>

                    <div class="control-group">
                      <label for="min-diversification" class="control-label">Min Diversification Ratio</label>
                      <input type="number" id="min-diversification" value="0.4" min="0" max="1" step="0.1"
                        class="form-input">
                    </div>

                    <div class="control-group">
                      <label for="min-weight" class="control-label">Min Asset Weight (%)</label>
                      <input type="number" id="min-weight" value="0" min="0" max="5" step="0.1" class="form-input">
                    </div>

                    <div class="control-group">
                      <label for="min-assets" class="control-label">Min Active Assets</label>
                      <input type="number" id="min-assets" value="10" min="0" max="50" step="1" class="form-input">
                    </div>

                    <div class="control-group">
                      <label for="target-vol" class="control-label">Target Volatility (%)</label>
                      <input type="number" id="target-vol" value="" min="0" max="100" step="0.1" placeholder="e.g. 25"
                        class="form-input">
                    </div>
                  </div>
                </details>

                <div id="error-container"></div>
              </div>
            </div>

            <!-- Analysis Panel -->
            <div class="card" id="analysis-panel" style="display:none; margin-top: var(--space-lg);">
              <div class="card-header">
                <h2 class="card-title">Pre-Analysis</h2>
              </div>

              <div class="card-content">
                <div id="analysis-container" class="text-muted"></div>

                <div class="button-group">
                  <button class="btn btn-primary" onclick="applySuggestions()">
                    Apply Suggestions
                  </button>
                  <button class="btn btn-secondary" onclick="applyAndOptimize()">
                    Apply & Optimize
                  </button>
                </div>

                <div style="margin-top: var(--space-lg);">
                  <h3 style="margin-bottom: var(--space-sm);">Scenarios</h3>
                  <div id="scenarios-container"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Panel: Results -->
          <div class="right-panel">
            <div id="results" style="display: none;">
              <div class="card">
                <div class="card-header">
                  <h2 class="card-title">Optimization Results</h2>
                </div>

                <div class="card-content">
                  <div class="metric-grid" id="metrics-grid">
                    <!-- Metrics will be populated here -->
                  </div>

                  <div class="chart-container">
                    <canvas id="allocation-chart"></canvas>
                  </div>

                  <h3>Optimal Allocation</h3>
                  <div id="weights-container">
                    <!-- Weights table will be populated here -->
                  </div>

                  <h3>Sector Exposures</h3>
                  <div id="sectors-container">
                    <!-- Sectors will be populated here -->
                  </div>

                  <h3>Details</h3>
                  <div id="details-container" class="text-muted"></div>
                </div>
              </div>

              <div class="card" id="trades-section" style="margin-top: var(--space-lg); display: none;">
                <div class="card-header">
                  <h2 class="card-title">üìà Rebalancing Trades</h2>
                  <p class="card-description">Trades needed to achieve optimal allocation</p>
                </div>

                <div class="card-content">
                  <div id="trades-container">
                    <!-- Trades will be populated here -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let optimizationChart = null;

    async function loadDefaults() {
      try {
        const response = await fetch('/api/portfolio/optimization/constraints/defaults');
        const data = await response.json();

        document.getElementById('max-weight').value = data.constraints.max_weight * 100;
        document.getElementById('max-sector').value = data.constraints.max_sector_weight * 100;
        document.getElementById('min-diversification').value = data.constraints.min_diversification_ratio;
        if (typeof data.constraints.min_weight === 'number') {
          document.getElementById('min-weight').value = (data.constraints.min_weight * 100).toFixed(2);
        }
        if (typeof data.constraints.target_volatility === 'number' && data.constraints.target_volatility > 0) {
          document.getElementById('target-vol').value = (data.constraints.target_volatility * 100).toFixed(1);
        }
        document.getElementById('conservative').checked = data.conservative;

      } catch (error) {
        console.error('Failed to load defaults:', error);
      }
    }

    async function updateConstraints() {
      const conservative = document.getElementById('conservative').checked;

      try {
        const response = await fetch(`/api/portfolio/optimization/constraints/defaults?conservative=${conservative}`);
        const data = await response.json();

        document.getElementById('max-weight').value = data.constraints.max_weight * 100;
        document.getElementById('max-sector').value = data.constraints.max_sector_weight * 100;
        document.getElementById('min-diversification').value = data.constraints.min_diversification_ratio;
        if (typeof data.constraints.min_weight === 'number') {
          document.getElementById('min-weight').value = (data.constraints.min_weight * 100).toFixed(2);
        }
        if (typeof data.constraints.target_volatility === 'number' && data.constraints.target_volatility > 0) {
          document.getElementById('target-vol').value = (data.constraints.target_volatility * 100).toFixed(1);
        } else {
          document.getElementById('target-vol').value = '';
        }

      } catch (error) {
        console.error('Failed to update constraints:', error);
      }
    }

    async function runOptimization() {
      const btn = document.getElementById('optimize-btn');
      const errorContainer = document.getElementById('error-container');

      btn.disabled = true;
      btn.textContent = '‚è≥ Optimizing...';
      errorContainer.innerHTML = '';

      try {
        const request = {
          objective: document.getElementById('objective').value,
          lookback_days: parseInt(document.getElementById('lookback').value),
          expected_return_method: document.getElementById('method').value,
          conservative: document.getElementById('conservative').checked,
          custom_constraints: {
            max_weight: parseFloat(document.getElementById('max-weight').value) / 100,
            max_sector_weight: parseFloat(document.getElementById('max-sector').value) / 100,
            min_diversification_ratio: parseFloat(document.getElementById('min-diversification').value),
            min_weight: parseFloat(document.getElementById('min-weight').value) / 100
          },
          include_current_weights: true
        };

        // Enforce min active assets by bounding max_weight accordingly
        const minAssets = parseInt(document.getElementById('min-assets').value || '0');
        if (minAssets && minAssets > 0) {
          const impliedMax = 1 / minAssets;
          request.custom_constraints.max_weight = Math.min(request.custom_constraints.max_weight, impliedMax);
        }

        // Include target volatility if specified
        const tvol = parseFloat(document.getElementById('target-vol').value);
        if (!isNaN(tvol) && tvol > 0) {
          request.custom_constraints.target_volatility = tvol / 100.0;
        }

        const minUsd = document.getElementById('min-usd').value;
        const minHistory = document.getElementById('min-history').value;
        const dataSource = document.getElementById('data-source').value;
        const response = await fetch(`/api/portfolio/optimization/optimize?source=${dataSource}&min_usd=${minUsd}&min_history_days=${minHistory}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(request)
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.detail || 'Optimization failed');
        }

        displayResults(result);
        document.getElementById('results').style.display = 'block';
        // Smooth scroll to the allocation chart after results render
        setTimeout(() => {
          const chartEl = document.getElementById('allocation-chart');
          if (chartEl && chartEl.scrollIntoView) {
            chartEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }, 100);

      } catch (error) {
        console.error('Optimization error:', error);
        errorContainer.innerHTML = `
          <div class="alert alert-danger">
            ‚ùå Optimization failed: ${error.message}
          </div>
        `;
      } finally {
        btn.disabled = false;
        btn.textContent = 'üöÄ Optimize Portfolio';
      }
    }

    function displayResults(result) {
      console.log('Displaying results:', result);
      console.log('Weights:', result.weights);

      displayMetrics(result);
      displayAllocationChart(result.weights);
      displayWeights(result.weights, result.risk_contributions);
      displaySectors(result.sector_exposures);
      displayTrades(result.rebalancing_trades);
      displayDetails(result.optimization_details);
    }

    async function runAnalysis() {
      const btn = document.getElementById('analyze-btn');
      const source = document.getElementById('data-source').value;
      // Analyze the full portfolio regardless of current Min USD filter
      const minUsdForAnalysis = 1;
      btn.disabled = true; btn.textContent = '‚è≥ Analyzing...';
      try {
        const resp = await fetch(`/api/portfolio/optimization/analyze?source=${source}&min_usd=${minUsdForAnalysis}`);
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.detail || 'Analysis failed');
        window.lastAnalysis = data;
        // Ensure the results wrapper is visible when only analyzing
        document.getElementById('results').style.display = 'block';
        document.getElementById('analysis-panel').style.display = 'block';
        renderAnalysis(data);
        renderScenarios(data.scenarios || []);
      } catch (e) {
        console.error('Analysis error:', e);
        errorContainer.innerHTML = `
          <div class="alert alert-danger">
            ‚ùå Analysis failed: ${e.message}
          </div>
        `;
      } finally {
        btn.disabled = false; btn.textContent = 'üîç Analyze Portfolio';
      }
    }

    function renderAnalysis(a) {
      const el = document.getElementById('analysis-container');
      const cov = a.history_coverage || {};
      el.innerHTML = `
        <div class="metric-grid">
          <div class="metric-card"><div class="metric-value">$${a.total_value_usd.toLocaleString()}</div><div class="metric-label">Total Value</div></div>
          <div class="metric-card"><div class="metric-value">${a.asset_count}</div><div class="metric-label">Assets</div></div>
          <div class="metric-card"><div class="metric-value">${(a.stablecoins_weight * 100).toFixed(1)}%</div><div class="metric-label">Stablecoins</div></div>
          <div class="metric-card"><div class="metric-value">${(a.top10_weight * 100).toFixed(1)}%</div><div class="metric-label">Top10 Weight</div></div>
          <div class="metric-card"><div class="metric-value">${a.hhi.toFixed(3)}</div><div class="metric-label">HHI</div></div>
        </div>
        <div style="margin: var(--space-sm) 0;">
          <span class="badge badge-info">‚â•365d: ${cov['365'] || 0}</span>
          <span class="badge badge-info">‚â•730d: ${cov['730'] || 0}</span>
          <span class="badge badge-info">‚â•1095d: ${cov['1095'] || 0}</span>
          <span class="badge badge-info">‚â•1460d: ${cov['1460'] || 0}</span>
        </div>
        <div style="margin: var(--space-sm) 0;">
          <strong>Suggested:</strong>
          <span class="badge badge-success">Min USD: $${(a.suggest.min_usd || 0).toLocaleString()}</span>
          <span class="badge badge-success">History/Min: ${a.suggest.lookback_days}d</span>
          <span class="badge badge-success">Objective: ${a.suggest.objective}</span>
          <span class="badge badge-success">Method: ${a.suggest.expected_return_method}</span>
        </div>
        ${(a.notes || []).length ? `<div style="margin-top: var(--space-sm);">${a.notes.map(n => `<div class="badge badge-warning">${n}</div>`).join(' ')}</div>` : ''}
      `;
    }

    function displayMetrics(result) {
      const metricsGrid = document.getElementById('metrics-grid');

      const metrics = [
        { label: 'Expected Return', value: `${(result.expected_return * 100).toFixed(1)}%`, color: 'var(--success)' },
        { label: 'Volatility', value: `${(result.volatility * 100).toFixed(1)}%`, color: 'var(--warning)' },
        { label: 'Sharpe Ratio', value: result.sharpe_ratio.toFixed(2), color: 'var(--brand-primary)' },
        { label: 'Diversification', value: result.diversification_ratio.toFixed(2), color: 'var(--info)' },
        { label: 'Optimization Score', value: result.optimization_score.toFixed(2), color: 'var(--brand-primary)' },
        { label: 'Constraints Met', value: result.constraints_satisfied ? '‚úÖ Yes' : '‚ùå No', color: result.constraints_satisfied ? 'var(--success)' : 'var(--danger)' }
      ];

      metricsGrid.innerHTML = metrics.map(metric => `
        <div class="metric-card">
          <div class="metric-value" style="color: ${metric.color}">${metric.value}</div>
          <div class="metric-label">${metric.label}</div>
        </div>
      `).join('');
    }

    function displayAllocationChart(weights) {
      const ctx = document.getElementById('allocation-chart').getContext('2d');

      if (optimizationChart) {
        optimizationChart.destroy();
      }

      // Get all non-zero weights and sort them
      const nonZeroWeights = Object.entries(weights)
        .filter(([_, weight]) => weight > 0)
        .sort(([_, a], [__, b]) => b - a);

      // If we have too many small weights, group them
      let sortedWeights;
      if (nonZeroWeights.length > 10) {
        const mainWeights = nonZeroWeights.slice(0, 9);
        const otherWeights = nonZeroWeights.slice(9);
        const otherSum = otherWeights.reduce((sum, [_, weight]) => sum + weight, 0);

        if (otherSum > 0.001) { // 0.1%
          sortedWeights = [...mainWeights, ['Others', otherSum]];
        } else {
          sortedWeights = mainWeights;
        }
      } else {
        // Show significant weights (>0.5%)
        sortedWeights = nonZeroWeights.filter(([_, weight]) => weight > 0.005);
      }

      // If still empty, show top weights regardless
      if (sortedWeights.length === 0) {
        sortedWeights = nonZeroWeights.slice(0, 5);
      }

      // If we still have no data, show a placeholder
      if (sortedWeights.length === 0) {
        ctx.fillStyle = '#666';
        ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        ctx.fillStyle = 'white';
        ctx.textAlign = 'center';
        ctx.font = '16px Arial';
        ctx.fillText('No allocation data', ctx.canvas.width / 2, ctx.canvas.height / 2);
        return;
      }

      try {
        optimizationChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: sortedWeights.map(([symbol, _]) => symbol),
            datasets: [{
              data: sortedWeights.map(([_, weight]) => weight * 100),
              backgroundColor: [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right'
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return `${context.label}: ${context.parsed.toFixed(1)}%`;
                  }
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Chart creation error:', error);
        // Fallback: show error message
        ctx.fillStyle = '#ff6b6b';
        ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        ctx.fillStyle = 'white';
        ctx.textAlign = 'center';
        ctx.font = '14px Arial';
        ctx.fillText('Chart Error', ctx.canvas.width / 2, ctx.canvas.height / 2);
      }
    }

    function displayWeights(weights, riskContributions) {
      const weightsContainer = document.getElementById('weights-container');

      const sortedWeights = Object.entries(weights)
        .sort(([_, a], [__, b]) => b - a);

      const maxWeight = Math.max(...Object.values(weights));

      weightsContainer.innerHTML = `
        <table class="weight-table">
          <thead>
            <tr>
              <th>Asset</th>
              <th>Weight</th>
              <th>Allocation</th>
              <th>Risk Contribution</th>
            </tr>
          </thead>
          <tbody>
            ${sortedWeights.map(([symbol, weight]) => {
        const riskContrib = riskContributions[symbol] || 0;
        return `
                <tr>
                  <td><strong>${symbol}</strong></td>
                  <td>${(weight * 100).toFixed(1)}%</td>
                  <td>
                    <div class="weight-bar" style="width: ${(weight / maxWeight) * 100}%"></div>
                  </td>
                  <td>${(riskContrib * 100).toFixed(1)}%</td>
                </tr>
              `;
      }).join('')}
          </tbody>
        </table>
      `;
    }

    function displaySectors(sectorExposures) {
      const sectorsContainer = document.getElementById('sectors-container');

      if (!sectorExposures || Object.keys(sectorExposures).length === 0) {
        sectorsContainer.innerHTML = '<p class="text-muted">No sector data available</p>';
        return;
      }

      const sortedSectors = Object.entries(sectorExposures)
        .sort(([_, a], [__, b]) => b - a);

      sectorsContainer.innerHTML = `
        <div class="metric-grid">
          ${sortedSectors.map(([sector, weight]) => `
            <div class="metric-card">
              <div class="metric-value">${(weight * 100).toFixed(1)}%</div>
              <div class="metric-label">${sector}</div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function displayTrades(trades) {
      const tradesContainer = document.getElementById('trades-container');
      const tradesSection = document.getElementById('trades-section');

      if (!trades || trades.length === 0) {
        tradesSection.style.display = 'none';
        return;
      }

      tradesSection.style.display = 'block';

      tradesContainer.innerHTML = `
        <div class="badge badge-info">Total Trades: ${trades.length}</div>
        <div class="badge badge-info">High Priority: ${trades.filter(t => t.priority === 'high').length}</div>
        <br><br>
        ${trades.map(trade => `
          <div class="trade-item priority-${trade.priority} ${trade.action === 'buy' ? 'trade-buy' : 'trade-sell'}">
            <div>
              <strong style="color: ${trade.action === 'buy' ? 'var(--success)' : 'var(--warning)'}">${trade.action.toUpperCase()} ${trade.symbol}</strong>
              <div class="text-muted">
                ${trade.current_weight * 100}% ‚Üí ${trade.target_weight * 100}%
                (${trade.weight_change > 0 ? '+' : ''}${(trade.weight_change * 100).toFixed(1)}%)
              </div>
            </div>
            <div style="text-align: right;">
              <div><strong>$${trade.usd_amount.toLocaleString()}</strong></div>
              <div class="badge badge-${trade.priority === 'high' ? 'danger' : trade.priority === 'medium' ? 'warning' : 'success'}">${trade.priority}</div>
            </div>
          </div>
        `).join('')}
      `;
    }

    function displayDetails(details) {
      const el = document.getElementById('details-container');
      if (!details) { el.innerHTML = ''; return; }
      const excluded = (details.excluded_symbols || []).slice(0, 20);
      el.innerHTML = `
        <div class="badge badge-info">Assets optimized: ${details.assets_optimized}</div>
        <div class="badge badge-info">Excluded: ${details.assets_excluded}</div>
        <div class="badge badge-info">Lookback: ${details.lookback_days}d</div>
        <div class="badge badge-info">Portfolio value: $${(details.total_portfolio_value || 0).toLocaleString()}</div>
        <div style="margin-top: var(--space-sm); font-size: 0.9em;">
          ${excluded.length ? `Excluded symbols (first ${excluded.length}): ${excluded.join(', ')}` : 'No excluded symbols'}
        </div>
      `;
    }

    function applySuggestions() {
      const s = (window.lastAnalysis || {}).suggest || {};
      applySuggestionObject(s);
    }

    function applyAndOptimize() {
      applySuggestions();
      setTimeout(() => runOptimization(), 50);
    }

    function applySuggestionObject(s) {
      if (!s) return;
      if (s.objective) document.getElementById('objective').value = s.objective;
      if (s.expected_return_method) document.getElementById('method').value = s.expected_return_method;
      if (typeof s.min_usd === 'number') document.getElementById('min-usd').value = s.min_usd;
      if (typeof s.lookback_days === 'number') document.getElementById('lookback').value = s.lookback_days;
      if (typeof s.min_history_days === 'number') document.getElementById('min-history').value = s.min_history_days;
      if (typeof s.max_weight === 'number') document.getElementById('max-weight').value = (s.max_weight * 100).toFixed(0);
      if (typeof s.max_sector_weight === 'number') document.getElementById('max-sector').value = (s.max_sector_weight * 100).toFixed(0);
      if (typeof s.min_diversification_ratio === 'number') document.getElementById('min-diversification').value = s.min_diversification_ratio;
      if (typeof s.min_weight === 'number') { const el = document.getElementById('min-weight'); if (el) el.value = (s.min_weight * 100).toFixed(2); }
      if (typeof s.target_volatility === 'number' && s.target_volatility > 0) { const el = document.getElementById('target-vol'); if (el) el.value = (s.target_volatility * 100).toFixed(1); }
      if (typeof s.min_assets === 'number' && s.min_assets > 0) { const el = document.getElementById('min-assets'); if (el) el.value = s.min_assets; }
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function () {
      initializeSharedHeader();
      loadDefaults();
    });
  </script>

  <script>
    // Initialisation automatique de la navigation th√©matique
    document.addEventListener('DOMContentLoaded', function () {
      // Auto-d√©tecter la page courante pour la navigation th√©matique
      if (typeof createSimpleNavigation !== 'undefined') {
        const pageId = window.location.pathname.split('/').pop().replace('.html', '') || 'dashboard';
        createSimpleNavigation('portfolio-optimization');
      }
    });
  </script>
</body>

</html>