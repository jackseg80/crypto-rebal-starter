<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🔍 Debug Phase Engine Détaillé</title>
  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">
  <script src="global-config.js"></script>
  <script src="appearance.js"></script>
</head>

<body>
  <header class="header">
    <div class="container">
      <h1>🔍 Debug Phase Engine Détaillé</h1>
      <p>Analyse approfondie des tilts par phase</p>
    </div>
  </header>

  <main class="container">

    <div class="card">
      <h2>🧪 Test Détaillé des Phases</h2>
      <button id="test-phases-detailed" class="btn btn-primary">🔍 Test Détaillé</button>
      <div id="detailed-results" style="margin-top: 1rem;"></div>
    </div>

    <div class="card">
      <h2>📝 Logs Phase Engine</h2>
      <div id="phase-logs" style="background: var(--theme-surface); padding: 1rem; border-radius: 6px; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.85em; white-space: pre-wrap;"></div>
    </div>

  </main>

  <script type="module">

    // Capture detailed logs
    const logContainer = document.getElementById('phase-logs');
    const originalLog = console.log;
    const originalDebug = console.debug;
    const originalWarn = console.warn;

    function addLog(level, ...args) {
      const timestamp = new Date().toLocaleTimeString();
      const message = args.map(arg =>
        typeof arg === 'object' ? JSON.stringify(arg, null, 1) : String(arg)
      ).join(' ');

      logContainer.textContent += `[${timestamp}] ${level}: ${message}\n`;
      logContainer.scrollTop = logContainer.scrollHeight;

      // Call original
      if (level === 'LOG') originalLog(...args);
      else if (level === 'DEBUG') originalDebug(...args);
      else if (level === 'WARN') originalWarn(...args);
    }

    console.log = (...args) => addLog('LOG', ...args);
    console.debug = (...args) => addLog('DEBUG', ...args);
    console.warn = (...args) => addLog('WARN', ...args);

    document.getElementById('test-phases-detailed').addEventListener('click', async () => {
      const results = document.getElementById('detailed-results');
      results.innerHTML = '<div class="loading">🔍 Analyse détaillée en cours...</div>';

      try {
        console.log('🚀 STARTING DETAILED PHASE ENGINE ANALYSIS');

        const { applyPhaseTilts } = await import('./core/phase-engine.js');

        // Base targets from Allocation Engine V2 pattern
        const baseTargets = {
          'BTC': 24.0,
          'Stablecoins': 20.0,
          'ETH': 17.6,
          'L1/L0 majors': 15.4,
          'SOL': 7.7,
          'DeFi': 5.8,
          'L2/Scaling': 3.8,
          'Memecoins': 2.0,
          'Others': 1.8,
          'Gaming/NFT': 1.0,
          'AI/Data': 1.0
        };

        console.log('📊 Base targets for testing:', baseTargets);

        // Test each phase individually
        const phases = ['neutral', 'risk_off', 'eth_expansion', 'largecap_altseason', 'full_altseason'];
        const results_by_phase = {};

        for (const phase of phases) {
          console.log(`\n🎭 Testing phase: ${phase}`);

          const context = {
            DI: phase === 'full_altseason' ? 85 : 70,
            breadth_alts: phase === 'full_altseason' ? 0.85 : 0.6
          };

          console.log(`Context for ${phase}:`, context);

          const result = await applyPhaseTilts({ ...baseTargets }, phase, context);

          console.log(`Result for ${phase}:`, {
            tiltsApplied: result.metadata?.tiltsApplied,
            reason: result.metadata?.reason,
            stablesPreserved: result.metadata?.stablesPreserved,
            deltas: result.metadata?.deltas
          });

          results_by_phase[phase] = result;
        }

        // Display detailed comparison
        let html = '<h3>🔍 Analyse Détaillée des Phases</h3>';

        // Summary table
        html += '<div style="overflow-x: auto; margin: 1rem 0;">';
        html += '<table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">';
        html += '<thead><tr style="background: var(--theme-surface);">';
        html += '<th style="padding: 0.5rem; border: 1px solid var(--theme-border);">Asset</th>';

        phases.forEach(phase => {
          html += `<th style="padding: 0.5rem; border: 1px solid var(--theme-border);">${phase}</th>`;
        });

        html += '</tr></thead><tbody>';

        // Row for each asset
        const allAssets = Object.keys(baseTargets);
        allAssets.forEach(asset => {
          html += '<tr>';
          html += `<td style="padding: 0.5rem; border: 1px solid var(--theme-border); font-weight: 600;">${asset}</td>`;

          phases.forEach(phase => {
            const value = results_by_phase[phase]?.targets?.[asset] || 0;
            const baseValue = baseTargets[asset];
            const delta = value - baseValue;
            const deltaStr = delta !== 0 ? ` (${delta > 0 ? '+' : ''}${delta.toFixed(1)})` : '';

            let cellStyle = 'padding: 0.5rem; border: 1px solid var(--theme-border);';
            if (Math.abs(delta) > 0.1) {
              cellStyle += delta > 0 ? ' background: var(--success-bg); color: var(--success);' : ' background: var(--danger-bg); color: var(--danger);';
            }

            html += `<td style="${cellStyle}">${value.toFixed(1)}%${deltaStr}</td>`;
          });

          html += '</tr>';
        });

        html += '</tbody></table></div>';

        // Metadata summary
        html += '<div style="margin: 1rem 0;"><h4>📋 Métadonnées des Phases</h4>';
        phases.forEach(phase => {
          const result = results_by_phase[phase];
          const tiltsApplied = result.metadata?.tiltsApplied;
          const reason = result.metadata?.reason;

          html += `
            <div style="margin: 0.5rem 0; padding: 0.5rem; background: var(--theme-surface); border-radius: 4px;">
              <strong>${phase}:</strong>
              <span style="color: ${tiltsApplied ? 'var(--success)' : 'var(--warning)'};">
                ${tiltsApplied ? '✅ Tilts appliqués' : '❌ Pas de tilts'}
              </span>
              ${reason ? ` - ${reason}` : ''}
            </div>
          `;
        });
        html += '</div>';

        // Key differences
        html += '<div style="margin: 1rem 0;"><h4>🔍 Différences Clés</h4>';

        const neutralResult = results_by_phase['neutral'];
        const ethResult = results_by_phase['eth_expansion'];
        const fullResult = results_by_phase['full_altseason'];

        if (neutralResult && ethResult && fullResult) {
          const ethETH_delta = (ethResult.targets?.ETH || 0) - (neutralResult.targets?.ETH || 0);
          const ethL2_delta = (ethResult.targets?.['L2/Scaling'] || 0) - (neutralResult.targets?.['L2/Scaling'] || 0);
          const fullL2_delta = (fullResult.targets?.['L2/Scaling'] || 0) - (neutralResult.targets?.['L2/Scaling'] || 0);
          const fullDeFi_delta = (fullResult.targets?.['DeFi'] || 0) - (neutralResult.targets?.['DeFi'] || 0);

          html += `
            <ul>
              <li><strong>ETH Expansion → ETH:</strong> ${ethETH_delta > 0 ? '+' : ''}${ethETH_delta.toFixed(1)}% (attendu: +5%)</li>
              <li><strong>ETH Expansion → L2/Scaling:</strong> ${ethL2_delta > 0 ? '+' : ''}${ethL2_delta.toFixed(1)}% (attendu: +3%)</li>
              <li><strong>Full Altseason → L2/Scaling:</strong> ${fullL2_delta > 0 ? '+' : ''}${fullL2_delta.toFixed(1)}% (attendu: +8%)</li>
              <li><strong>Full Altseason → DeFi:</strong> ${fullDeFi_delta > 0 ? '+' : ''}${fullDeFi_delta.toFixed(1)}% (attendu: +6%)</li>
            </ul>
          `;
        }
        html += '</div>';

        results.innerHTML = html;

      } catch (error) {
        console.error('❌ Detailed analysis failed:', error);
        results.innerHTML = `<div class="error">❌ Analyse échouée: ${error.message}</div>`;
      }
    });

    console.log('🔍 Debug phase detailed page loaded');

  </script>

</body>
</html>