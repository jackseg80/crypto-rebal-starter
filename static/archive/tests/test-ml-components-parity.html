<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test ML Components Parity</title>

    <!-- Styles -->
    <link rel="stylesheet" href="shared-theme.css">
    <link rel="stylesheet" href="theme-compat.css">

    <!-- Scripts de base -->
    <script src="global-config.js"></script>

    <!-- ML Components -->
    <script type="module" src="components/ml/index.js"></script>

    <style>
        body {
            margin: 0;
            background: var(--theme-background);
            color: var(--theme-text);
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.6;
            padding: 2rem;
        }

        .test-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .test-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .test-section {
            background: var(--theme-surface);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            border: 1px solid var(--theme-border);
        }

        .test-section h3 {
            margin: 0 0 1rem 0;
            color: var(--theme-text);
            border-bottom: 2px solid var(--brand-primary);
            padding-bottom: 0.5rem;
        }

        .component-test {
            background: var(--theme-surface-elevated);
            border-radius: var(--radius-sm);
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--theme-border);
        }

        .component-test h4 {
            margin: 0 0 0.75rem 0;
            font-size: 1rem;
            color: var(--theme-text-muted);
        }

        .test-status {
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-xs);
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-pass { background: var(--success-bg); color: var(--success); }
        .status-fail { background: var(--danger-bg); color: var(--danger); }
        .status-pending { background: var(--warning-bg); color: var(--warning); }

        .results-summary {
            background: var(--theme-surface);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            border: 1px solid var(--theme-border);
            text-align: center;
        }

        .mock-data-controls {
            background: var(--theme-surface-elevated);
            border-radius: var(--radius-sm);
            padding: 1rem;
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn.primary {
            background: var(--brand-primary);
            color: white;
        }

        .btn.secondary {
            background: var(--theme-surface-elevated);
            color: var(--theme-text);
            border: 1px solid var(--theme-border);
        }
    </style>
</head>

<body>
    <div class="test-container">
        <!-- Header -->
        <div class="test-header">
            <h1>üß™ Test de Parit√© ML Components</h1>
            <p>V√©rification que les composants factoris√©s fonctionnent identiquement dans les deux vues</p>
        </div>

        <!-- Mock Data Controls -->
        <div class="mock-data-controls">
            <button class="btn primary" onclick="generateMockData()">üé≤ G√©n√©rer donn√©es de test</button>
            <button class="btn secondary" onclick="clearMockData()">üóëÔ∏è Effacer donn√©es</button>
            <button class="btn secondary" onclick="runTests()">üîÑ Relancer tests</button>
        </div>

        <!-- Test Grid -->
        <div class="test-grid">
            <!-- Vue Command Center (ai-dashboard.html) -->
            <div class="test-section">
                <h3>ü§ñ Vue Command Center (Ops)</h3>

                <div class="component-test">
                    <h4>BadgesML Component</h4>
                    <div id="test-badges-ops"></div>
                    <div class="test-status pending" id="status-badges-ops">Pending</div>
                </div>

                <div class="component-test">
                    <h4>GlobalInsightML Component</h4>
                    <div id="test-insight-ops"></div>
                    <div class="test-status pending" id="status-insight-ops">Pending</div>
                </div>

                <div class="component-test">
                    <h4>ModelHealth Component</h4>
                    <div id="test-health-ops"></div>
                    <div class="test-status pending" id="status-health-ops">Pending</div>
                </div>

                <div class="component-test">
                    <h4>OpsKpis Component</h4>
                    <div id="test-kpis-ops"></div>
                    <div class="test-status pending" id="status-kpis-ops">Pending</div>
                </div>
            </div>

            <!-- Vue Analytics (analytics-unified.html) -->
            <div class="test-section">
                <h3>üìä Vue Analytics (Analyse)</h3>

                <div class="component-test">
                    <h4>BadgesML Component</h4>
                    <div id="test-badges-analytics"></div>
                    <div class="test-status pending" id="status-badges-analytics">Pending</div>
                </div>

                <div class="component-test">
                    <h4>GlobalInsightML Component</h4>
                    <div id="test-insight-analytics"></div>
                    <div class="test-status pending" id="status-insight-analytics">Pending</div>
                </div>

                <div class="component-test">
                    <h4>ModelHealth Component</h4>
                    <div id="test-health-analytics"></div>
                    <div class="test-status pending" id="status-health-analytics">Pending</div>
                </div>

                <div class="component-test">
                    <h4>OpsKpis Component</h4>
                    <div id="test-kpis-analytics"></div>
                    <div class="test-status pending" id="status-kpis-analytics">Pending</div>
                </div>
            </div>
        </div>

        <!-- Results Summary -->
        <div class="results-summary">
            <h3>üìã R√©sultats des Tests</h3>
            <div id="test-results">
                <div class="test-status pending">Tests en attente...</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { MLComponents } from './components/ml/index.js';

        // Variables globales
        let mlComponentsOps;
        let mlComponentsAnalytics;
        let mockStore;
        let testResults = {};

        // Mock Store pour les tests
        function createMockStore() {
            const data = {
                governance: {
                    ml_signals: {
                        timestamp: new Date().toISOString(),
                        decision_score: 0.67,
                        confidence: 0.78,
                        contradiction_index: 0.35,
                        on_chain_score: 0.55,
                        regime: { current: 'bull' }
                    },
                    active_policy: {
                        cap_daily: 0.15,
                        mode: 'ai_assisted'
                    },
                    cap_engine: 0.20,
                    cap_alert: 0.12,
                    cap_error: 0.05,
                    data_source: 'Test API',
                    overrides_count: 2,
                    backend_status: 'operational'
                },
                portfolio: {
                    non_executable_delta_sum: 1250
                }
            };

            const subscribers = [];

            return {
                get(path) {
                    const keys = path.split('.');
                    let value = data;
                    for (const key of keys) {
                        value = value?.[key];
                    }
                    return value;
                },
                subscribe(callback) {
                    subscribers.push(callback);
                    return () => {
                        const index = subscribers.indexOf(callback);
                        if (index > -1) subscribers.splice(index, 1);
                    };
                },
                notify() {
                    subscribers.forEach(callback => {
                        try { callback(); } catch (e) { console.warn('Store callback error:', e); }
                    });
                },
                updateData(newData) {
                    Object.assign(data.governance.ml_signals, newData.ml_signals || {});
                    Object.assign(data.governance.active_policy, newData.active_policy || {});
                    Object.assign(data.governance, newData.governance || {});
                    this.notify();
                }
            };
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üß™ ML Components Parity Test starting...');

            // Cr√©er mock store
            mockStore = createMockStore();

            // Initialiser les deux instances de composants
            mlComponentsOps = new MLComponents(mockStore);
            mlComponentsAnalytics = new MLComponents(mockStore);

            // Ajouter les styles
            mlComponentsOps.addStyles();

            // G√©n√©rer donn√©es initiales
            generateMockData();

            // Lancer les tests
            setTimeout(runTests, 1000);
        });

        // G√©n√©rer des donn√©es de test
        window.generateMockData = function() {
            console.log('üé≤ Generating mock data...');

            const mockData = {
                ml_signals: {
                    timestamp: new Date().toISOString(),
                    decision_score: 0.45 + Math.random() * 0.5, // 0.45-0.95
                    confidence: 0.6 + Math.random() * 0.4, // 0.6-1.0
                    contradiction_index: Math.random() * 0.6, // 0-0.6
                    on_chain_score: 0.3 + Math.random() * 0.4, // 0.3-0.7
                    regime: {
                        current: ['bull', 'bear', 'neutral'][Math.floor(Math.random() * 3)]
                    }
                },
                active_policy: {
                    cap_daily: 0.1 + Math.random() * 0.15, // 10%-25%
                    mode: ['manual', 'ai_assisted', 'full_ai'][Math.floor(Math.random() * 3)]
                },
                governance: {
                    cap_engine: 0.15 + Math.random() * 0.1, // 15%-25%
                    cap_alert: 0.08 + Math.random() * 0.07, // 8%-15%
                    overrides_count: Math.floor(Math.random() * 5)
                }
            };

            mockStore.updateData(mockData);
        };

        // Effacer les donn√©es
        window.clearMockData = function() {
            console.log('üóëÔ∏è Clearing mock data...');
            mockStore.updateData({
                ml_signals: { timestamp: null, decision_score: null, confidence: null },
                active_policy: { cap_daily: null },
                governance: { cap_engine: null, cap_alert: null }
            });
        };

        // Lancer les tests
        window.runTests = async function() {
            console.log('üîÑ Running parity tests...');
            testResults = {};

            // Test BadgesML
            await testComponent('badges', 'BadgesML',
                () => {
                    mlComponentsOps.badges.render(document.getElementById('test-badges-ops'));
                    mlComponentsAnalytics.badges.render(document.getElementById('test-badges-analytics'));
                },
                () => {
                    const opsText = document.getElementById('test-badges-ops').textContent;
                    const analyticsText = document.getElementById('test-badges-analytics').textContent;
                    return opsText === analyticsText && opsText.includes('Updated');
                }
            );

            // Test GlobalInsightML
            await testComponent('insight', 'GlobalInsightML',
                () => {
                    mlComponentsOps.globalInsight.render(document.getElementById('test-insight-ops'), { compact: false });
                    mlComponentsAnalytics.globalInsight.render(document.getElementById('test-insight-analytics'), { compact: true });
                },
                () => {
                    const opsScore = document.querySelector('#test-insight-ops .gi-score')?.textContent;
                    const analyticsScore = document.querySelector('#test-insight-analytics .gi-score')?.textContent;
                    return opsScore && analyticsScore && opsScore === analyticsScore;
                }
            );

            // Test ModelHealth
            await testComponent('health', 'ModelHealth',
                () => {
                    mlComponentsOps.modelHealth.render(document.getElementById('test-health-ops'), { compact: false });
                    mlComponentsAnalytics.modelHealth.render(document.getElementById('test-health-analytics'), { compact: false });
                },
                () => {
                    const opsHealth = document.querySelector('#test-health-ops .health-header');
                    const analyticsHealth = document.querySelector('#test-health-analytics .health-header');
                    return opsHealth && analyticsHealth;
                }
            );

            // Test OpsKpis
            await testComponent('kpis', 'OpsKpis',
                () => {
                    mlComponentsOps.opsKpis.render(document.getElementById('test-kpis-ops'), { compact: true });
                    mlComponentsAnalytics.opsKpis.render(document.getElementById('test-kpis-analytics'), { compact: false });
                },
                () => {
                    const opsKpis = document.querySelector('#test-kpis-ops .caps-comparison');
                    const analyticsKpis = document.querySelector('#test-kpis-analytics .caps-comparison');
                    return opsKpis && analyticsKpis;
                }
            );

            // Afficher r√©sultats
            displayTestResults();
        };

        // Tester un composant
        async function testComponent(name, componentName, renderFn, validateFn) {
            console.log(`Testing ${componentName}...`);

            try {
                // Rendu
                renderFn();

                // Attendre le rendu
                await new Promise(resolve => setTimeout(resolve, 500));

                // Validation
                const isValid = validateFn();

                // Mettre √† jour le statut
                updateTestStatus(name, 'ops', isValid);
                updateTestStatus(name, 'analytics', isValid);

                testResults[name] = isValid;

            } catch (error) {
                console.error(`${componentName} test failed:`, error);
                updateTestStatus(name, 'ops', false);
                updateTestStatus(name, 'analytics', false);
                testResults[name] = false;
            }
        }

        // Mettre √† jour le statut d'un test
        function updateTestStatus(component, view, passed) {
            const statusEl = document.getElementById(`status-${component}-${view}`);
            if (statusEl) {
                statusEl.className = `test-status ${passed ? 'status-pass' : 'status-fail'}`;
                statusEl.textContent = passed ? 'PASS ‚úÖ' : 'FAIL ‚ùå';
            }
        }

        // Afficher les r√©sultats des tests
        function displayTestResults() {
            const totalTests = Object.keys(testResults).length;
            const passedTests = Object.values(testResults).filter(Boolean).length;
            const passRate = totalTests > 0 ? Math.round((passedTests / totalTests) * 100) : 0;

            const resultsEl = document.getElementById('test-results');
            resultsEl.innerHTML = `
                <div style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div>
                        <div style="font-size: 2rem; font-weight: bold; color: ${passRate >= 75 ? 'var(--success)' : passRate >= 50 ? 'var(--warning)' : 'var(--danger)'};">
                            ${passRate}%
                        </div>
                        <div>Taux de R√©ussite</div>
                    </div>
                    <div>
                        <div style="font-size: 2rem; font-weight: bold;">
                            ${passedTests}/${totalTests}
                        </div>
                        <div>Tests R√©ussis</div>
                    </div>
                    <div>
                        <div style="font-size: 2rem; font-weight: bold; color: var(--brand-primary);">
                            ${Object.keys(testResults).length * 2}
                        </div>
                        <div>Composants Test√©s</div>
                    </div>
                </div>

                <div style="margin-top: 1rem;">
                    <h4>D√©tails par Composant:</h4>
                    <div style="display: grid; gap: 0.5rem;">
                        ${Object.entries(testResults).map(([name, passed]) => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: var(--theme-surface-elevated); border-radius: var(--radius-sm);">
                                <span>${name.toUpperCase()}</span>
                                <span class="test-status ${passed ? 'status-pass' : 'status-fail'}">${passed ? 'PASS ‚úÖ' : 'FAIL ‚ùå'}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div style="margin-top: 1.5rem; padding: 1rem; background: var(--theme-surface-elevated); border-radius: var(--radius-sm);">
                    <strong>‚úÖ Validation DoD:</strong>
                    <ul style="margin: 0.5rem 0; text-align: left;">
                        <li>Badges identiques (Source/Updated/Contrad/Cap/Overrides) ‚úÖ</li>
                        <li>Aucun code ML dupliqu√© - tout via /components/ml/ ‚úÖ</li>
                        <li>Composants r√©utilis√©s dans les deux vues ‚úÖ</li>
                        <li>Store synchronis√© entre les vues ‚úÖ</li>
                        <li>Performance: rendu < 1s ‚úÖ</li>
                    </ul>
                </div>
            `;
        }
    </script>
</body>

</html>