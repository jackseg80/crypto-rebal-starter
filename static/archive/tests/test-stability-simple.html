<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔬 Test Stabilité Simple</title>
    <link rel="stylesheet" href="shared-theme.css">
    <style>
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 1rem;
        }

        .test-card {
            background: var(--theme-bg);
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin: 1rem 0;
        }

        .test-result {
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: var(--radius-sm);
            font-family: monospace;
        }

        .test-pass {
            background: color-mix(in oklab, var(--success) 15%, var(--theme-bg));
            border: 1px solid var(--success);
            color: var(--success);
        }

        .test-fail {
            background: color-mix(in oklab, var(--danger) 15%, var(--theme-bg));
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .control-button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-sm);
            background: var(--primary);
            color: white;
            cursor: pointer;
            margin: 0.5rem;
        }

        .debug-output {
            background: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 1rem;
            border-radius: var(--radius-sm);
            height: 200px;
            overflow-y: auto;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔬 Test Stabilité Simple</h1>
        <p>Tests de base sans imports complexes pour diagnostiquer le problème.</p>

        <div class="test-card">
            <h3>🧪 Tests de Base</h3>
            <button class="control-button" onclick="runBasicTests()">▶️ Exécuter Tests</button>
            <div id="test-results"></div>
        </div>

        <div class="test-card">
            <h3>📊 Mock Hystérésis</h3>
            <button class="control-button" onclick="testHysteresis()">Test Deadband</button>
            <button class="control-button" onclick="testEMA()">Test EMA</button>
            <div id="hysteresis-results"></div>
        </div>

        <div class="test-card">
            <h3>🪣 Mock Rate Limiter</h3>
            <button class="control-button" onclick="testRateLimit()">Test Token Bucket</button>
            <div id="rate-limit-results"></div>
        </div>

        <div class="test-card">
            <h3>📋 Debug Console</h3>
            <div class="debug-output" id="debug-console"></div>
        </div>
    </div>

    <script>
        // Simple logging
        function log(message, type = 'info') {
            const console = document.getElementById('debug-console');
            const timestamp = new Date().toLocaleTimeString();
            const colorMap = {
                info: '#00ff00',
                warn: '#ffaa00',
                error: '#ff0000',
                success: '#00ff88'
            };

            const color = colorMap[type] || '#00ff00';
            console.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            console.scrollTop = console.scrollHeight;
        }

        // Mock implementations for testing
        class MockHysteresis {
            constructor(deadband = 0.02, persistence = 3) {
                this.deadband = deadband;
                this.persistence = persistence;
                this.lastStable = null;
                this.directionBuffer = [];
                this.smoothValue = null;
                this.emaAlpha = 0.3;
            }

            apply(newValue) {
                log(`📥 Input: ${newValue.toFixed(3)}`, 'info');

                // Initialize
                if (this.lastStable === null) {
                    this.lastStable = newValue;
                    this.smoothValue = newValue;
                    log(`🔄 Initialized: ${newValue.toFixed(3)}`, 'info');
                    return newValue;
                }

                // EMA smoothing
                this.smoothValue = this.emaAlpha * newValue + (1 - this.emaAlpha) * this.smoothValue;
                log(`📊 EMA: ${this.smoothValue.toFixed(3)}`, 'info');

                // Check deadband
                const delta = this.smoothValue - this.lastStable;
                const direction = Math.abs(delta) > this.deadband ? Math.sign(delta) : 0;

                log(`🎯 Delta: ${delta.toFixed(3)}, Direction: ${direction}`, 'info');

                // Update direction buffer
                this.directionBuffer.push(direction);
                if (this.directionBuffer.length > this.persistence) {
                    this.directionBuffer.shift();
                }

                // Check for consistent direction
                const consistent = this.directionBuffer.length === this.persistence &&
                                   this.directionBuffer.every(d => d === direction && d !== 0);

                if (consistent) {
                    this.lastStable = this.smoothValue;
                    this.directionBuffer = [];
                    log(`✅ Change applied: ${this.lastStable.toFixed(3)}`, 'success');
                }

                return this.lastStable;
            }

            getDebugInfo() {
                return {
                    lastStable: this.lastStable,
                    smoothValue: this.smoothValue,
                    directionBuffer: this.directionBuffer,
                    bufferStatus: `${this.directionBuffer.length}/${this.persistence}`
                };
            }
        }

        class MockTokenBucket {
            constructor(capacity = 12, refillRate = 6) {
                this.capacity = capacity;
                this.tokens = capacity;
                this.refillRate = refillRate;
                this.lastRefill = Date.now();
            }

            refill() {
                const now = Date.now();
                const elapsed = (now - this.lastRefill) / 1000;
                this.tokens = Math.min(this.capacity, this.tokens + elapsed * this.refillRate);
                this.lastRefill = now;
            }

            consume(amount = 1) {
                this.refill();
                if (this.tokens >= amount) {
                    this.tokens -= amount;
                    return true;
                }
                return false;
            }

            availableTokens() {
                this.refill();
                return Math.floor(this.tokens);
            }
        }

        // Test functions
        function addResult(containerId, message, success) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${success ? 'test-pass' : 'test-fail'}`;
            div.textContent = `${success ? '✅' : '❌'} ${message}`;
            container.appendChild(div);
        }

        function runBasicTests() {
            const container = document.getElementById('test-results');
            container.innerHTML = '';

            log('🚀 Démarrage tests de base', 'info');

            // Test 1: Math operations
            try {
                const result = 2 + 2;
                addResult('test-results', `Math test: 2+2=${result}`, result === 4);
                log(`➕ Math test passed: ${result}`, 'success');
            } catch (error) {
                addResult('test-results', `Math test failed: ${error.message}`, false);
                log(`❌ Math test failed: ${error.message}`, 'error');
            }

            // Test 2: Array operations
            try {
                const arr = [1, 2, 3];
                const sum = arr.reduce((a, b) => a + b, 0);
                addResult('test-results', `Array sum: ${sum}`, sum === 6);
                log(`🔢 Array test passed: ${sum}`, 'success');
            } catch (error) {
                addResult('test-results', `Array test failed: ${error.message}`, false);
                log(`❌ Array test failed: ${error.message}`, 'error');
            }

            // Test 3: Promise operations
            Promise.resolve(42)
                .then(value => {
                    addResult('test-results', `Promise test: ${value}`, value === 42);
                    log(`🎯 Promise test passed: ${value}`, 'success');
                })
                .catch(error => {
                    addResult('test-results', `Promise test failed: ${error.message}`, false);
                    log(`❌ Promise test failed: ${error.message}`, 'error');
                });

            log('✅ Tests de base terminés', 'success');
        }

        function testHysteresis() {
            const container = document.getElementById('hysteresis-results');
            container.innerHTML = '';

            log('⚖️ Test hystérésis avec deadband ±2%', 'info');

            const hysteresis = new MockHysteresis();

            // Test deadband
            let result1 = hysteresis.apply(0.50);
            let result2 = hysteresis.apply(0.51); // +1% < deadband

            const deadbandWorks = Math.abs(result1 - result2) < 0.001;
            addResult('hysteresis-results', `Deadband test: ${result1.toFixed(3)} → ${result2.toFixed(3)}`, deadbandWorks);

            // Test persistence
            let result3 = hysteresis.apply(0.55); // +5% > deadband, tick 1
            let result4 = hysteresis.apply(0.55); // tick 2
            let result5 = hysteresis.apply(0.55); // tick 3, should trigger

            const persistenceWorks = Math.abs(result5 - 0.55) < 0.02;
            addResult('hysteresis-results', `Persistence test: final=${result5.toFixed(3)}`, persistenceWorks);

            log(`🔍 Debug info: ${JSON.stringify(hysteresis.getDebugInfo())}`, 'info');
            log('⚖️ Test hystérésis terminé', 'success');
        }

        function testEMA() {
            const container = document.getElementById('hysteresis-results');

            log('📊 Test EMA smoothing', 'info');

            const hysteresis = new MockHysteresis();
            hysteresis.apply(0.30); // baseline

            hysteresis.apply(0.70); // big jump
            const smoothed = hysteresis.smoothValue;

            const smoothingWorks = smoothed > 0.30 && smoothed < 0.70;
            addResult('hysteresis-results', `EMA smoothing: ${smoothed.toFixed(3)} (between 0.30-0.70)`, smoothingWorks);

            log(`📈 EMA result: ${smoothed.toFixed(3)}`, smoothingWorks ? 'success' : 'error');
        }

        function testRateLimit() {
            const container = document.getElementById('rate-limit-results');
            container.innerHTML = '';

            log('🪣 Test token bucket rate limiting', 'info');

            const bucket = new MockTokenBucket();

            // Test consumption
            let consumed = 0;
            for (let i = 0; i < 15; i++) {
                if (bucket.consume()) consumed++;
            }

            addResult('rate-limit-results', `Consumed ${consumed}/15 tokens`, consumed <= 12);

            // Test refill
            setTimeout(() => {
                const available = bucket.availableTokens();
                addResult('rate-limit-results', `Available after 1s: ${available}`, available > 0);
                log(`🔄 Tokens after refill: ${available}`, 'success');
            }, 1000);

            log(`🪣 Token bucket test: ${consumed} tokens consumed`, 'success');
        }

        // Initialize
        log('🔬 Test suite initialisée', 'info');
        log('💡 Cliquez sur les boutons pour exécuter les tests', 'info');
    </script>
</body>
</html>