<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Exact Replica Bitcoin Chart</title>
  <script src="lazy-loader.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      background: #1a1a1a;
      color: #ffffff;
    }

    .risk-card {
      background: #2a2a2a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 1rem;
      margin: 2rem 0;
    }

    .chart-lazy-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--theme-bg-secondary, #333);
      color: var(--theme-text-muted, #aaa);
      border: 1px dashed var(--theme-border, #555);
      border-radius: 8px;
    }

    canvas {
      width: 100%;
      height: 100%;
    }

    .spacer {
      height: 100vh;
      background: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 1rem 0;
    }

    #logs {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 300px;
      height: 400px;
      background: #000;
      color: #0f0;
      font-family: monospace;
      font-size: 0.8rem;
      padding: 0.5rem;
      overflow-y: auto;
      border: 1px solid #333;
      z-index: 1000;
    }
  </style>
</head>

<body>
  <div id="logs"></div>

  <h1>üß™ Test Exact Replica - Bitcoin Chart</h1>

  <div class="spacer">Scroll down to trigger lazy loading</div>

  <!-- EXACT COPY from risk-dashboard.html lines 5849-5872 -->
  <div class="risk-card" style="margin-bottom: 2rem;"
       data-lazy-load="component"
       data-lazy-component="BitcoinCycleChart">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h3 style="margin: 0;">üìà Graphique des Cycles Bitcoin</h3>
      <button onclick="toggleSection('bitcoin-cycle')" style="background: none; border: 1px solid var(--theme-border); border-radius: 4px; padding: 4px 8px; cursor: pointer; color: var(--theme-text); font-size: 0.8rem;" title="R√©duire/Agrandir">
        <span id="bitcoin-cycle-arrow">‚ñº</span>
      </button>
    </div>
    <div id="bitcoin-cycle-content">
      <!-- Label de source inject√© dynamiquement -->
      <div id="btc-source-label" style="margin-left:auto;color:var(--theme-text-muted);font-size:12px;"></div>
      <div style="height: 520px; position: relative; margin: 1rem 0;">
        <div class="chart-lazy-placeholder" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: var(--theme-bg-secondary); color: var(--theme-text-muted); border: 1px dashed var(--theme-border); border-radius: 8px;">
          <div style="text-align: center;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìä</div>
            <div>Graphique se charge au scroll...</div>
          </div>
        </div>
        <canvas id="bitcoin-cycle-chart" style="width: 100%; height: 100%; display: none;"></canvas>
      </div>
    </div>
  </div>

  <div class="spacer">Chart should load above</div>

  <script>
    // Logging system
    const logContainer = document.getElementById('logs');
    let logIndex = 0;

    function log(message) {
      const time = new Date().toLocaleTimeString();
      logContainer.innerHTML += `[${++logIndex}] ${time}: ${message}\n`;
      logContainer.scrollTop = logContainer.scrollHeight;
      console.log(`[${logIndex}] ${message}`);
    }

    // Override console
    const origLog = console.log;
    const origError = console.error;
    const origWarn = console.warn;

    console.log = (...args) => {
      origLog.apply(console, args);
      log("LOG: " + args.join(' '));
    };

    console.error = (...args) => {
      origError.apply(console, args);
      log("ERROR: " + args.join(' '));
    };

    console.warn = (...args) => {
      origWarn.apply(console, args);
      log("WARN: " + args.join(' '));
    };

    log("üöÄ Starting exact replica test");

    // Toggle function (from risk dashboard)
    window.toggleSection = function(sectionId) {
      log(`toggleSection called with: ${sectionId}`);
      const content = document.getElementById(sectionId + '-content');
      const arrow = document.getElementById(sectionId + '-arrow');

      if (!content || !arrow) {
        log(`toggleSection - content or arrow not found for ${sectionId}`);
        return;
      }

      const isCollapsed = content.style.display === 'none';
      log(`toggleSection - ${sectionId} is currently collapsed: ${isCollapsed}`);

      if (isCollapsed) {
        content.style.display = '';
        arrow.textContent = '‚ñº';
        log(`toggleSection - expanded ${sectionId}`);
      } else {
        content.style.display = 'none';
        arrow.textContent = '‚ñ∂';
        log(`toggleSection - collapsed ${sectionId}`);
      }
    };

    // Create Bitcoin cycle chart function (simplified)
    window.createBitcoinCycleChart = async function(canvasId, forceRefresh = false) {
      log(`createBitcoinCycleChart called: canvasId=${canvasId}, forceRefresh=${forceRefresh}`);

      const canvas = document.getElementById(canvasId);
      if (!canvas) {
        log(`createBitcoinCycleChart - canvas not found: ${canvasId}`);
        return null;
      }

      if (!window.Chart) {
        log(`createBitcoinCycleChart - Chart.js not loaded`);
        return null;
      }

      log(`createBitcoinCycleChart - creating chart on canvas ${canvasId}`);

      const data = {
        labels: ['Point 1', 'Point 2', 'Point 3', 'Point 4', 'Point 5'],
        datasets: [{
          label: 'Bitcoin Test Data',
          data: [30000, 45000, 35000, 50000, 42000],
          backgroundColor: 'rgba(247, 147, 26, 0.2)',
          borderColor: 'rgba(247, 147, 26, 1)',
          borderWidth: 2,
          fill: true
        }]
      };

      const config = {
        type: 'line',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'üìä Bitcoin Cycle Chart (Test)',
              color: '#ffffff'
            },
            legend: {
              labels: { color: '#ffffff' }
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              ticks: { color: '#ffffff' },
              grid: { color: '#444' }
            },
            x: {
              ticks: { color: '#ffffff' },
              grid: { color: '#444' }
            }
          }
        }
      };

      try {
        const chart = new Chart(canvas, config);
        log(`createBitcoinCycleChart - chart created successfully`);
        window.bitcoinCycleChart = chart;
        return chart;
      } catch (error) {
        log(`createBitcoinCycleChart - error: ${error.message}`);
        return null;
      }
    };

    // EXACT COPY of BitcoinCycleChart from risk-dashboard.html
    class BitcoinCycleChart {
      constructor(element) {
        log('üîß BitcoinCycleChart constructor called with element: ' + element.tagName);
        this.element = element;
        this.chartLoaded = false;
        this.placeholder = element.querySelector('.chart-lazy-placeholder');
        this.canvas = element.querySelector('#bitcoin-cycle-chart');
        log('üîç Placeholder found: ' + !!this.placeholder + ', Canvas found: ' + !!this.canvas);
      }

      async init() {
        log('üöÄ BitcoinCycleChart init() called');
        try {
          // Afficher un indicateur de chargement
          if (this.placeholder) {
            log('‚úÖ Showing loading indicator');
            this.placeholder.innerHTML = `
              <div style="text-align: center;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚è≥</div>
                <div>Chargement de Chart.js...</div>
                <div class="lazy-loading" style="margin-top: 1rem;"></div>
              </div>
            `;
          } else {
            log('‚ö†Ô∏è No placeholder found for loading indicator');
          }

          // Charger Chart.js de mani√®re asynchrone
          log('üìä Starting to load Chart.js...');
          await this.loadChartJS();
          log('‚úÖ Chart.js loaded successfully');

          // Masquer le placeholder et afficher le canvas
          log('üîÑ Switching from placeholder to canvas...');
          if (this.placeholder) {
            this.placeholder.style.display = 'none';
            log('‚úÖ Placeholder hidden');
          }
          if (this.canvas) {
            this.canvas.style.display = 'block';
            log('‚úÖ Canvas shown');
          } else {
            log('‚ö†Ô∏è No canvas found to show');
          }

          // Cr√©er le graphique Bitcoin Cycle
          if (typeof createBitcoinCycleChart === 'function') {
            log('üìä Calling createBitcoinCycleChart...');
            await createBitcoinCycleChart('bitcoin-cycle-chart');
            log('‚úÖ createBitcoinCycleChart completed');
          } else {
            log('‚ùå createBitcoinCycleChart function not found');
          }

          this.chartLoaded = true;
          log('‚úÖ Bitcoin Cycle Chart loaded successfully via lazy loading');

        } catch (error) {
          log('‚ùå Failed to load BitcoinCycleChart: ' + error.message);

          // Afficher l'erreur dans le placeholder
          if (this.placeholder) {
            this.placeholder.innerHTML = `
              <div style="text-align: center; color: var(--theme-error, #dc3545);">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</div>
                <div>Erreur lors du chargement du graphique</div>
                <div style="font-size: 0.8rem; margin-top: 0.5rem;">${error.message}</div>
              </div>
            `;
          }
        }
      }

      async loadChartJS() {
        // V√©rifier si Chart.js est d√©j√† charg√©
        if (window.Chart) {
          log('üìä Chart.js already loaded');
          return Promise.resolve();
        }

        log('üìä Loading Chart.js...');

        // Charger Chart.js principal
        const chartPromise = new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js';
          script.onload = resolve;
          script.onerror = () => reject(new Error('Failed to load Chart.js'));
          document.head.appendChild(script);
        });

        await chartPromise;

        // Charger l'adaptateur de dates
        const adapterPromise = new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js';
          script.onload = resolve;
          script.onerror = () => reject(new Error('Failed to load Chart.js date adapter'));
          document.head.appendChild(script);
        });

        await adapterPromise;

        // Petit d√©lai pour s'assurer que Chart.js est disponible
        await new Promise(resolve => setTimeout(resolve, 100));

        if (!window.Chart) {
          throw new Error('Chart.js failed to initialize');
        }

        log('‚úÖ Chart.js loaded successfully');
      }
    }

    // Enregistrer le composant globalement pour le lazy loader
    window.BitcoinCycleChart = BitcoinCycleChart;
    log('üìù BitcoinCycleChart registered globally');

    // Wait for everything to load
    document.addEventListener('DOMContentLoaded', () => {
      log('üìÑ DOM loaded');

      setTimeout(() => {
        log('üîç Checking lazy loader...');
        if (window.lazyLoader) {
          log('‚úÖ Lazy loader is available');
          const elements = document.querySelectorAll('[data-lazy-load]');
          log(`Found ${elements.length} lazy elements`);
        } else {
          log('‚ùå Lazy loader not available');
        }
      }, 500);
    });

    log('üìÑ Script loaded');
  </script>
</body>
</html>