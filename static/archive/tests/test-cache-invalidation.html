<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Cache Invalidation</title>
  <script src="global-config.js" type="module"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      background: #1a1a1a;
      color: #fff;
    }
    .test-section {
      background: #333;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 8px;
    }
    button {
      background: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 0.5rem;
    }
    button:hover { background: #45a049; }
    .log {
      background: #000;
      color: #0f0;
      font-family: monospace;
      padding: 1rem;
      white-space: pre-line;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #333;
      margin: 1rem 0;
    }
    .status {
      padding: 0.5rem;
      margin: 0.5rem 0;
      border-radius: 4px;
    }
    .status.ok { background: #004400; }
    .status.error { background: #440000; }
  </style>
</head>
<body>
  <h1>🧪 Test Cache Invalidation</h1>

  <div class="test-section">
    <h3>📊 Current State</h3>
    <div>
      <strong>Current Data Source:</strong>
      <span id="current-source">Loading...</span>
    </div>
    <div>
      <strong>Cache Keys Count:</strong>
      <span id="cache-count">Loading...</span>
    </div>
  </div>

  <div class="test-section">
    <h3>🔧 Test Controls</h3>
    <button onclick="addTestCacheEntries()">➕ Add Test Cache Entries</button>
    <button onclick="changeToCSV()">🗂️ Switch to CSV Source</button>
    <button onclick="changeToAPI()">🌐 Switch to API Source</button>
    <button onclick="clearAllCaches()">🧹 Manual Clear All Caches</button>
    <button onclick="refreshStatus()">🔄 Refresh Status</button>
  </div>

  <div class="test-section">
    <h3>📝 Event Log</h3>
    <div id="log" class="log"></div>
    <button onclick="clearLog()">🧹 Clear Log</button>
  </div>

  <script type="module">
    let logElement = document.getElementById('log');
    let logLines = [];

    function log(message) {
      const timestamp = new Date().toLocaleTimeString();
      const logLine = `[${timestamp}] ${message}`;
      logLines.push(logLine);
      logElement.textContent = logLines.slice(-20).join('\n');
      console.log(logLine);
    }

    window.clearLog = () => {
      logLines = [];
      logElement.textContent = '';
    };

    // Listen for events
    window.addEventListener('configChanged', (e) => {
      log(`🔧 Config Changed: ${e.detail.key} = ${e.detail.newValue} (was: ${e.detail.oldValue})`);
    });

    window.addEventListener('dataSourceChanged', (e) => {
      log(`🔄 Data Source Changed: ${e.detail.oldSource} → ${e.detail.newSource}`);
    });

    window.addEventListener('storage', (e) => {
      if (e.key && (e.key.includes('crypto_rebal_settings') || e.key.includes('cache:'))) {
        log(`💾 Storage Event: ${e.key} changed`);
      }
    });

    // Test functions
    window.addTestCacheEntries = () => {
      const testKeys = [
        'cache:balance_test',
        'cache:portfolio_test',
        'risk_score_test',
        'balance_cache_test',
        'portfolio_cache_test'
      ];

      testKeys.forEach(key => {
        localStorage.setItem(key, JSON.stringify({ test: true, timestamp: Date.now() }));
      });

      log(`➕ Added ${testKeys.length} test cache entries`);
      refreshStatus();
    };

    window.changeToCSV = () => {
      log('🗂️ Changing to CSV source...');
      window.globalConfig.set('data_source', 'csv_0');
    };

    window.changeToAPI = () => {
      log('🌐 Changing to API source...');
      window.globalConfig.set('data_source', 'cointracking_api');
    };

    window.clearAllCaches = () => {
      if (typeof window.refreshAllData === 'function') {
        log('🧹 Manual cache clear via refreshAllData()');
        window.refreshAllData();
      } else {
        log('❌ refreshAllData() not available');
      }
    };

    window.refreshStatus = () => {
      // Update current source
      const currentSource = window.globalConfig.get('data_source') || 'unknown';
      document.getElementById('current-source').textContent = currentSource;

      // Count cache keys
      const cacheKeys = Object.keys(localStorage).filter(key =>
        key.startsWith('cache:') ||
        key.includes('risk_score') ||
        key.includes('balance_') ||
        key.includes('portfolio_')
      );
      document.getElementById('cache-count').textContent = cacheKeys.length;

      log(`📊 Status refreshed: source=${currentSource}, cache_keys=${cacheKeys.length}`);
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      log('🚀 Cache Invalidation Test Started');

      // Wait for globalConfig to be ready
      setTimeout(() => {
        if (window.globalConfig) {
          log('✅ GlobalConfig loaded');
          refreshStatus();
        } else {
          log('❌ GlobalConfig not found');
        }
      }, 500);
    });
  </script>
</body>
</html>