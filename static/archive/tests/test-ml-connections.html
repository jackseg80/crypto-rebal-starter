<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>🧪 Test Connexions ML</title>
    <link rel="stylesheet" href="shared-theme.css">
    <style>
        .test-container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 2rem;
            background: var(--theme-surface);
            border-radius: var(--radius-md);
        }
        .test-item {
            margin: 1rem 0;
            padding: 1rem;
            background: var(--theme-bg);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--theme-border);
        }
        .success { border-left-color: var(--success); }
        .error { border-left-color: var(--danger); }
        .warning { border-left-color: var(--warning); }
        .endpoint { font-family: monospace; font-size: 0.9rem; color: var(--theme-text-muted); }
        .result { margin-top: 0.5rem; font-size: 0.9rem; }
        pre { font-size: 0.8rem; background: var(--theme-surface); padding: 0.5rem; border-radius: var(--radius-sm); overflow-x: auto; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🧪 Test Connexions ML - Dashboard AI</h1>
        <p>Vérification des endpoints ML utilisés par le dashboard AI unifié.</p>
        
        <div id="test-results">
            <div class="test-item">
                <div>🔄 Lancement des tests...</div>
            </div>
        </div>
        
        <button onclick="runTests()" style="margin-top: 2rem; padding: 0.75rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer;">
            🔄 Relancer les Tests
        </button>
    </div>

    <script type="module">
        const API_BASE = window.location.origin + '/api/ml';
        const PIPELINE_API_BASE = API_BASE + '/pipeline';
        
        const tests = [
            {
                name: 'Statut ML Unifié',
                endpoint: '/unified/status',
                check: (data) => data && typeof data === 'object'
            },
            {
                name: 'Statut Pipeline',
                endpoint: '/pipeline/status', 
                api_base: window.location.origin + '/api/ml',
                check: (data) => data.success && data.pipeline_status
            },
            {
                name: 'Modèles Volatilité Status',
                endpoint: '/volatility/models/status',
                check: (data) => data && typeof data === 'object'
            },
            {
                name: 'Statut Régime',
                endpoint: '/regime/status',
                check: (data) => data && typeof data === 'object'
            },
            {
                name: 'Matrice Corrélations',
                endpoint: '/correlation/matrix/current?window_days=30',
                check: (data) => data && typeof data === 'object'
            },
            {
                name: 'Fear & Greed Index',
                endpoint: '/sentiment/fear-greed?days=1',
                check: (data) => data && typeof data === 'object'
            },
            {
                name: 'Prédictions Unifiées (remplace les endpoints volatilité individuels)',
                endpoint: '/unified/predictions',
                check: (data) => data.success && data.predictions && Array.isArray(data.predictions.symbols)
            },
            {
                name: 'Régime Marché Actuel',
                endpoint: '/regime/current?lookback_days=60',
                check: (data) => data && typeof data === 'object'
            }
        ];

        window.runTests = async function() {
            const resultsEl = document.getElementById('test-results');
            resultsEl.innerHTML = '<div class="test-item"><div>🔄 Exécution des tests...</div></div>';
            
            const results = [];
            
            for (const test of tests) {
                const startTime = Date.now();
                try {
                    const apiBase = test.api_base || API_BASE;
                    const url = apiBase + test.endpoint;
                    
                    console.log(`Testing: ${url}`);
                    const response = await fetch(url);
                    const duration = Date.now() - startTime;
                    
                    if (response.ok) {
                        const data = await response.json();
                        const isValid = test.check(data);
                        
                        results.push({
                            name: test.name,
                            endpoint: test.endpoint,
                            status: 'success',
                            duration,
                            details: isValid ? 'Structure de données valide' : 'Structure inattendue',
                            data: JSON.stringify(data, null, 2).substring(0, 300) + (JSON.stringify(data).length > 300 ? '...' : '')
                        });
                    } else {
                        results.push({
                            name: test.name,
                            endpoint: test.endpoint,
                            status: 'error',
                            duration,
                            details: `HTTP ${response.status}: ${response.statusText}`
                        });
                    }
                } catch (error) {
                    const duration = Date.now() - startTime;
                    results.push({
                        name: test.name,
                        endpoint: test.endpoint,
                        status: 'error',
                        duration,
                        details: error.message
                    });
                }
            }
            
            // Afficher les résultats
            const successCount = results.filter(r => r.status === 'success').length;
            const avgDuration = results.reduce((sum, r) => sum + r.duration, 0) / results.length;
            
            resultsEl.innerHTML = `
                <div class="test-item ${successCount === results.length ? 'success' : successCount > 0 ? 'warning' : 'error'}">
                    <h3>📊 Résumé des Tests</h3>
                    <div>✅ ${successCount}/${results.length} endpoints fonctionnels</div>
                    <div>⚡ Temps de réponse moyen: ${avgDuration.toFixed(0)}ms</div>
                    <div>🕒 Tests exécutés: ${new Date().toLocaleTimeString()}</div>
                </div>
                ${results.map(result => `
                    <div class="test-item ${result.status}">
                        <h4>${result.status === 'success' ? '✅' : '❌'} ${result.name}</h4>
                        <div class="endpoint">GET ${result.endpoint}</div>
                        <div class="result">
                            <strong>Statut:</strong> ${result.status === 'success' ? 'OK' : 'ERREUR'} 
                            (${result.duration}ms)
                            <br><strong>Détails:</strong> ${result.details}
                        </div>
                        ${result.data ? `<pre>${result.data}</pre>` : ''}
                    </div>
                `).join('')}
            `;
        };

        // Auto-exécution des tests
        window.addEventListener('load', () => {
            setTimeout(runTests, 500);
        });
    </script>
</body>
</html>