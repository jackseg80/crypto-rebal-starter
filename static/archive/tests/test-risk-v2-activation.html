<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Risk v2 Activation</title>
    <link rel="stylesheet" href="shared-theme.css">
    <script src="global-config.js"></script>
</head>
<body>
    <div class="container">
        <h1>üöÄ Test Risk v2 Activation</h1>

        <div class="test-section">
            <h2>Status des Modules v2</h2>
            <div id="module-status"></div>
        </div>

        <div class="test-section">
            <h2>Test Strategy API</h2>
            <button onclick="testStrategyAPI()">Tester Strategy API</button>
            <div id="strategy-results"></div>
        </div>

        <div class="test-section">
            <h2>Test Unified Insights v2</h2>
            <button onclick="testUnifiedInsightsV2()">Tester Unified Insights v2</button>
            <div id="insights-results"></div>
        </div>

        <div class="test-section">
            <h2>Logs de Debug</h2>
            <div id="debug-logs" style="background: #f5f5f5; padding: 10px; font-family: monospace; max-height: 300px; overflow-y: auto;"></div>
        </div>
    </div>

    <script type="module">
        // Import des modules v2
        import { getUnifiedState, deriveRecommendations } from './core/unified-insights-v2.js';
        import { StrategyConfig } from './core/strategy-api-adapter.js';
        import { calculateCompositeScoreV2 } from './modules/composite-score-v2.js';

        // Activer le debug mode
        StrategyConfig.setDebugMode(true);

        // Logger custom pour capturer les logs
        const originalConsoleDebug = console.debug;
        const originalConsoleLog = console.log;
        const debugLogs = [];

        function captureLog(level, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg =>
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');

            debugLogs.push(`[${timestamp}] ${level}: ${message}`);
            updateDebugDisplay();

            // Appeler la fonction console originale
            if (level === 'DEBUG') originalConsoleDebug(...args);
            else originalConsoleLog(...args);
        }

        console.debug = (...args) => captureLog('DEBUG', ...args);
        console.log = (...args) => captureLog('LOG', ...args);

        function updateDebugDisplay() {
            const debugDiv = document.getElementById('debug-logs');
            if (debugDiv) {
                debugDiv.innerHTML = debugLogs.slice(-20).map(log =>
                    `<div style="margin-bottom: 3px;">${log}</div>`
                ).join('');
                debugDiv.scrollTop = debugDiv.scrollHeight;
            }
        }

        // Test du statut des modules
        async function checkModuleStatus() {
            const statusDiv = document.getElementById('module-status');
            const status = {
                'unified-insights-v2': false,
                'strategy-api-adapter': false,
                'composite-score-v2': false,
                'strategy-config': false
            };

            try {
                // Test des imports
                status['unified-insights-v2'] = typeof getUnifiedState === 'function';
                status['strategy-api-adapter'] = typeof StrategyConfig === 'object';
                status['composite-score-v2'] = typeof calculateCompositeScoreV2 === 'function';
                status['strategy-config'] = StrategyConfig.getConfig().enabled === true;

                statusDiv.innerHTML = Object.entries(status).map(([module, ok]) =>
                    `<div style="color: ${ok ? 'green' : 'red'};">
                        ${ok ? '‚úÖ' : '‚ùå'} ${module}: ${ok ? 'OK' : 'FAILED'}
                    </div>`
                ).join('');

            } catch (error) {
                statusDiv.innerHTML = `<div style="color: red;">Erreur: ${error.message}</div>`;
            }
        }

        // Test Strategy API
        window.testStrategyAPI = async function() {
            const resultsDiv = document.getElementById('strategy-results');
            resultsDiv.innerHTML = '<div>‚è≥ Test en cours...</div>';

            try {
                const baseUrl = window.globalConfig?.get('api_base_url') || window.location.origin;

                // Test 1: Templates disponibles
                const templatesResponse = await fetch(`${baseUrl}/api/strategy/templates`);
                const templates = await templatesResponse.json();

                // Test 2: Preview d'une strat√©gie
                const previewResponse = await fetch(`${baseUrl}/api/strategy/preview`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ template_id: 'balanced' })
                });
                const preview = await previewResponse.json();

                resultsDiv.innerHTML = `
                    <div style="color: green;">‚úÖ Strategy API fonctionnelle!</div>
                    <div><strong>Templates:</strong> ${Object.keys(templates).join(', ')}</div>
                    <div><strong>Preview Score:</strong> ${preview.decision_score}</div>
                    <div><strong>Policy:</strong> ${preview.policy_hint}</div>
                    <div><strong>Targets:</strong> ${preview.targets?.length || 0} assets</div>
                `;

            } catch (error) {
                resultsDiv.innerHTML = `<div style="color: red;">‚ùå Erreur Strategy API: ${error.message}</div>`;
            }
        };

        // Test Unified Insights v2
        window.testUnifiedInsightsV2 = async function() {
            const resultsDiv = document.getElementById('insights-results');
            resultsDiv.innerHTML = '<div>‚è≥ Test en cours...</div>';

            try {
                // Test getUnifiedState v2
                const unifiedState = await getUnifiedState();
                const recommendations = deriveRecommendations(unifiedState);

                resultsDiv.innerHTML = `
                    <div style="color: green;">‚úÖ Unified Insights v2 fonctionnel!</div>
                    <div><strong>Version:</strong> ${unifiedState.intelligence?.version || 'legacy'}</div>
                    <div><strong>Migration Status:</strong> ${unifiedState.intelligence?.migration_status || 'unknown'}</div>
                    <div><strong>Decision Score:</strong> ${unifiedState.decision?.score}</div>
                    <div><strong>Decision Source:</strong> ${unifiedState.decision?.source}</div>
                    <div><strong>Strategy API Status:</strong> ${unifiedState.health?.intelligence_modules?.strategy_api || 'unknown'}</div>
                    <div><strong>Recommandations:</strong> ${recommendations?.length || 0}</div>
                    <div><strong>Template Used:</strong> ${unifiedState.strategy?.template_used || 'none'}</div>
                `;

            } catch (error) {
                resultsDiv.innerHTML = `<div style="color: red;">‚ùå Erreur Unified Insights v2: ${error.message}</div>`;
            }
        };

        // Auto-start des tests
        document.addEventListener('DOMContentLoaded', () => {
            checkModuleStatus();
        });
    </script>

    <style>
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { background: var(--primary); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { opacity: 0.9; }
    </style>
</body>
</html>