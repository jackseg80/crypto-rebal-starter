<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🧪 Test Unified Simple</title>
  <link rel="stylesheet" href="shared-theme.css">
  <link rel="stylesheet" href="theme-compat.css">
  <script src="global-config.js"></script>
  <script src="appearance.js"></script>
</head>

<body>
  <header class="header">
    <div class="container">
      <h1>🧪 Test Unified Simple</h1>
      <p>Test simplifié sans erreurs de syntaxe</p>
    </div>
  </header>

  <main class="container">

    <div class="card">
      <h2>🎮 Configuration Phase Engine</h2>
      <div style="display: flex; gap: 1rem; margin: 1rem 0; flex-wrap: wrap;">
        <button id="enable-apply" class="btn btn-success">✅ Mode APPLY</button>
        <button id="force-eth-expansion" class="btn btn-primary">🟢 ETH Expansion</button>
        <button id="force-full-altseason" class="btn btn-primary">🟣 Full Altseason</button>
        <button id="clear-phase" class="btn btn-secondary">🔄 Auto</button>
      </div>
      <div id="config-status" class="alert alert-info">
        <strong>Mode:</strong> <span id="current-mode">shadow</span><br>
        <strong>Phase:</strong> <span id="current-phase">auto</span>
      </div>
    </div>

    <div class="card">
      <h2>🎯 Comparaison des Allocations</h2>
      <button id="compare-allocations" class="btn btn-warning">🔄 Comparer les Allocations</button>
      <div id="comparison-results" style="margin-top: 1rem;"></div>
    </div>

    <div class="card">
      <h2>📊 Allocation Engine Direct</h2>
      <button id="test-allocation-engine" class="btn btn-info">🏗️ Test Allocation Engine</button>
      <div id="engine-results" style="margin-top: 1rem;"></div>
    </div>

  </main>

  <script type="module">

    function updateConfigStatus() {
      const mode = localStorage.getItem('PHASE_ENGINE_ENABLED') || 'shadow';
      const phase = localStorage.getItem('forced_phase') || 'auto';

      document.getElementById('current-mode').textContent = mode;
      document.getElementById('current-phase').textContent = phase;

      const statusEl = document.getElementById('config-status');
      statusEl.className = 'alert ' + (mode === 'apply' ? 'alert-success' : 'alert-warning');
    }

    // Configuration buttons
    document.getElementById('enable-apply').addEventListener('click', () => {
      localStorage.setItem('PHASE_ENGINE_ENABLED', 'apply');
      console.log('✅ Mode APPLY activé');
      updateConfigStatus();
    });

    document.getElementById('force-eth-expansion').addEventListener('click', () => {
      localStorage.setItem('forced_phase', 'eth_expansion');
      localStorage.removeItem('detected_phase_cache');
      console.log('🟢 Phase ETH Expansion forcée');
      updateConfigStatus();
    });

    document.getElementById('force-full-altseason').addEventListener('click', () => {
      localStorage.setItem('forced_phase', 'full_altseason');
      localStorage.removeItem('detected_phase_cache');
      console.log('🟣 Phase Full Altseason forcée');
      updateConfigStatus();
    });

    document.getElementById('clear-phase').addEventListener('click', () => {
      localStorage.removeItem('forced_phase');
      localStorage.removeItem('detected_phase_cache');
      console.log('🔄 Auto-détection activée');
      updateConfigStatus();
    });

    // Compare allocations
    document.getElementById('compare-allocations').addEventListener('click', async () => {
      const results = document.getElementById('comparison-results');
      results.innerHTML = '<div class="loading">🔄 Comparaison en cours...</div>';

      try {
        console.log('🔄 Comparing allocations across different modes...');

        // Test 1: Test direct allocation engine
        const { calculateHierarchicalAllocation } = await import('./core/allocation-engine.js');

        const baseContext = {
          cycleScore: 70,
          regimeData: { name: 'expansion', confidence: 0.8 },
          adaptiveWeights: { btc: 0.35, eth: 0.25, stables: 0.25 },
          execution: { cap_pct_per_iter: 7, target_stables_pct: 25 }
        };

        console.log('🏗️ Testing allocation engine with base context...');
        const baseAllocation = await calculateHierarchicalAllocation(baseContext, [], { enableV2: true });

        // Test 2: Test with different cycle score
        const bullContext = { ...baseContext, cycleScore: 85 };
        console.log('🚀 Testing allocation engine with bull context...');
        const bullAllocation = await calculateHierarchicalAllocation(bullContext, [], { enableV2: true });

        // Test 3: Test Phase Engine with Allocation Engine V2 targets
        console.log('🎭 Testing Phase Engine with V2 targets...');
        const { applyPhaseTilts } = await import('./core/phase-engine.js');

        // Use Allocation Engine V2 results as base targets for Phase Engine
        const v2Targets = {};
        if (baseAllocation && baseAllocation.allocation) {
          for (const [asset, fraction] of Object.entries(baseAllocation.allocation)) {
            v2Targets[asset] = fraction * 100; // Convert to percentage
          }
        }

        console.log('📊 Using V2 targets for Phase Engine:', v2Targets);

        const ethExpansionResult = await applyPhaseTilts(v2Targets, 'eth_expansion', { DI: 70, breadth_alts: 0.6 });
        const fullAltseasonResult = await applyPhaseTilts(v2Targets, 'full_altseason', { DI: 85, breadth_alts: 0.85 });

        // Display results
        let html = '<h3>📊 Comparaison des Allocations</h3>';

        // Base vs Bull Allocation Engine
        if (baseAllocation && bullAllocation) {
          html += `
            <div style="margin: 1rem 0;">
              <h4>🏗️ Allocation Engine V2 (Base vs Bull)</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                  <h5>📊 Base (Cycle: 70)</h5>
                  ${Object.entries(baseAllocation.allocation)
                    .sort(([,a], [,b]) => b - a)
                    .map(([asset, pct]) => `<div>${asset}: ${(pct * 100).toFixed(1)}%</div>`)
                    .join('')}
                </div>
                <div>
                  <h5>🚀 Bull (Cycle: 85)</h5>
                  ${Object.entries(bullAllocation.allocation)
                    .sort(([,a], [,b]) => b - a)
                    .map(([asset, pct]) => `<div>${asset}: ${(pct * 100).toFixed(1)}%</div>`)
                    .join('')}
                </div>
              </div>
            </div>
          `;
        }

        // Phase Engine Results
        html += `
          <div style="margin: 1rem 0;">
            <h4>🎭 Phase Engine (ETH Expansion vs Full Altseason)</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div>
                <h5>🟢 ETH Expansion</h5>
                <div><strong>Tilts appliqués:</strong> ${ethExpansionResult.metadata.tiltsApplied ? 'Oui' : 'Non'}</div>
                ${Object.entries(ethExpansionResult.targets)
                  .sort(([,a], [,b]) => b - a)
                  .map(([asset, pct]) => `<div>${asset}: ${pct.toFixed(1)}%</div>`)
                  .join('')}
              </div>
              <div>
                <h5>🟣 Full Altseason</h5>
                <div><strong>Tilts appliqués:</strong> ${fullAltseasonResult.metadata.tiltsApplied ? 'Oui' : 'Non'}</div>
                ${Object.entries(fullAltseasonResult.targets)
                  .sort(([,a], [,b]) => b - a)
                  .map(([asset, pct]) => `<div>${asset}: ${pct.toFixed(1)}%</div>`)
                  .join('')}
              </div>
            </div>
          </div>
        `;

        // Key differences
        const ethETH = ethExpansionResult.targets.ETH;
        const fullETH = fullAltseasonResult.targets.ETH;
        const ethL2 = ethExpansionResult.targets['L2/Scaling'];
        const fullL2 = fullAltseasonResult.targets['L2/Scaling'];

        html += `
          <div style="margin: 1rem 0; padding: 1rem; background: var(--theme-surface); border-radius: 6px;">
            <h4>🔍 Différences Clés</h4>
            <ul>
              <li><strong>ETH:</strong> Expansion ${ethETH.toFixed(1)}% vs Altseason ${fullETH.toFixed(1)}% (Δ: ${(fullETH - ethETH).toFixed(1)}%)</li>
              <li><strong>L2/Scaling:</strong> Expansion ${ethL2.toFixed(1)}% vs Altseason ${fullL2.toFixed(1)}% (Δ: ${(fullL2 - ethL2).toFixed(1)}%)</li>
              <li><strong>Stables:</strong> Toujours préservées ✅</li>
            </ul>
          </div>
        `;

        results.innerHTML = html;

      } catch (error) {
        console.error('❌ Comparison failed:', error);
        results.innerHTML = `<div class="error">❌ Comparaison échouée: ${error.message}</div>`;
      }
    });

    // Test allocation engine
    document.getElementById('test-allocation-engine').addEventListener('click', async () => {
      const results = document.getElementById('engine-results');
      results.innerHTML = '<div class="loading">🏗️ Test de l\'Allocation Engine...</div>';

      try {
        const { calculateHierarchicalAllocation } = await import('./core/allocation-engine.js');

        const testContext = {
          cycleScore: 75,
          regimeData: { name: 'expansion', confidence: 0.8 },
          adaptiveWeights: { btc: 0.30, eth: 0.25, stables: 0.25 },
          execution: { cap_pct_per_iter: 7, target_stables_pct: 25 }
        };

        console.log('🧮 Testing allocation engine...');
        const result = await calculateHierarchicalAllocation(testContext, [], { enableV2: true });

        if (result && result.allocation) {
          let html = '<h3>🏗️ Allocation Engine V2 - Test Direct</h3>';
          html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem; margin: 1rem 0;">';

          Object.entries(result.allocation)
            .sort(([,a], [,b]) => b - a)
            .forEach(([asset, fraction]) => {
              const pct = fraction * 100;
              if (pct > 0.1) {
                const color = pct > 20 ? 'var(--success)' : pct > 10 ? 'var(--warning)' : 'var(--info)';
                html += `
                  <div style="background: var(--theme-surface); padding: 0.75rem; border-radius: 6px; border-left: 3px solid ${color};">
                    <div style="font-weight: 600;">${asset}</div>
                    <div style="font-size: 1.2em; font-weight: 700; color: ${color};">${pct.toFixed(1)}%</div>
                  </div>
                `;
              }
            });

          html += '</div>';

          const total = Object.values(result.allocation).reduce((sum, val) => sum + val, 0);
          html += `<div style="text-align: center; margin-top: 1rem;"><strong>Total: ${(total * 100).toFixed(1)}%</strong></div>`;

          results.innerHTML = html;
        } else {
          results.innerHTML = '<div class="error">❌ Engine returned null</div>';
        }

      } catch (error) {
        console.error('❌ Engine test failed:', error);
        results.innerHTML = `<div class="error">❌ Test échoué: ${error.message}</div>`;
      }
    });

    // Initialize
    updateConfigStatus();
    console.log('🧪 Test unified simple page loaded');

  </script>

</body>
</html>