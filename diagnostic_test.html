<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Strategy Button Diagnostic Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; border: 1px solid #ccc; padding: 15px; }
        .btn { padding: 10px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; background: #3b82f6; color: white; }
        .btn:hover { background: #2563eb; }
        .success { background: #10b981; color: white; }
        .error { background: #dc2626; color: white; }
        .warning { background: #f59e0b; color: white; }
        #results { background: #f3f4f6; padding: 10px; min-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>Strategy Button Diagnostic Test</h1>
    
    <div class="test-section">
        <h3>Module Loading Test</h3>
        <button id="loadModulesBtn" class="btn">Test Module Loading</button>
        <div id="moduleResults"></div>
    </div>
    
    <div class="test-section">
        <h3>Strategy Application Test</h3>
        <button id="testMacroBtn" class="btn">Test Macro Strategy</button>
        <button id="testCcsBtn" class="btn">Test CCS Strategy</button>
        <button id="testCycleBtn" class="btn">Test Cycle Strategy</button>
        <button id="testBlendBtn" class="btn">Test Blended Strategy</button>
        <div id="strategyResults"></div>
    </div>
    
    <div class="test-section">
        <h3>localStorage Communication Test</h3>
        <button id="testStorageBtn" class="btn">Test Storage Save/Load</button>
        <div id="storageResults"></div>
    </div>
    
    <div class="test-section">
        <h3>Full Debug Log</h3>
        <div id="results"></div>
    </div>

    <script type="module">
        const results = document.getElementById('results');
        const moduleResults = document.getElementById('moduleResults');
        const strategyResults = document.getElementById('strategyResults');
        const storageResults = document.getElementById('storageResults');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#dc2626' : type === 'success' ? '#10b981' : '#374151';
            results.innerHTML += `<div style="color: ${color}; margin: 5px 0;">[${timestamp}] ${message}</div>`;
            results.scrollTop = results.scrollHeight;
        }

        function updateSection(sectionElement, message, type = 'info') {
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'warning';
            sectionElement.innerHTML = `<div class="${className}" style="padding: 10px; margin: 10px 0;">${message}</div>`;
        }

        // Test module loading
        document.getElementById('loadModulesBtn').onclick = async function() {
            try {
                log('Testing module imports...');
                
                const { fetchAndComputeCCS, DEFAULT_CCS_WEIGHTS } = await import('./static/modules/signals-engine.js');
                const { estimateCyclePosition, blendCCS } = await import('./static/modules/cycle-navigator.js');
                const { proposeTargets, applyTargets } = await import('./static/modules/targets-coordinator.js');
                const { store } = await import('./static/core/risk-dashboard-store.js');
                
                log('✅ All modules imported successfully', 'success');
                updateSection(moduleResults, '✅ All modules loaded successfully', 'success');
                
                // Test basic function calls
                const ccs = await fetchAndComputeCCS();
                log(`✅ CCS computed: ${ccs.score}`, 'success');
                
                const cycle = estimateCyclePosition();
                log(`✅ Cycle estimated: ${cycle.phase.phase} (${Math.round(cycle.months)}m)`, 'success');
                
                // Set up store
                store.set('ccs', ccs);
                store.set('cycle', cycle);
                
                const blended = blendCCS(ccs.score, cycle.months, 0.3);
                store.set('cycle.ccsStar', blended.blendedCCS);
                log(`✅ Blended CCS: ${blended.blendedCCS.toFixed(1)}`, 'success');
                
                // Store functions globally for strategy tests
                window.testProposeTargets = proposeTargets;
                window.testApplyTargets = applyTargets;
                window.testStore = store;
                
                updateSection(moduleResults, '✅ All modules loaded and initialized successfully', 'success');
                
            } catch (error) {
                log(`❌ Module loading error: ${error.message}`, 'error');
                updateSection(moduleResults, `❌ Module loading failed: ${error.message}`, 'error');
            }
        };
        
        // Test strategy functions
        async function testStrategy(mode) {
            try {
                if (!window.testProposeTargets) {
                    throw new Error('Modules not loaded. Run module test first.');
                }
                
                log(`Testing ${mode} strategy...`);
                
                const proposal = window.testProposeTargets(mode);
                log(`✅ Proposal generated: ${proposal.strategy}`, 'success');
                log(`   BTC: ${proposal.targets.BTC?.toFixed(1)}%`, 'info');
                log(`   ETH: ${proposal.targets.ETH?.toFixed(1)}%`, 'info');
                log(`   Confidence: ${(proposal.confidence * 100).toFixed(1)}%`, 'info');
                
                await window.testApplyTargets(proposal);
                log(`✅ Strategy ${mode} applied successfully`, 'success');
                
                // Check localStorage
                const saved = localStorage.getItem('last_targets');
                if (saved) {
                    const data = JSON.parse(saved);
                    log(`✅ Data saved to localStorage: BTC=${data.targets.BTC?.toFixed(1)}%`, 'success');
                }
                
                updateSection(strategyResults, `✅ ${mode} strategy test passed`, 'success');
                
            } catch (error) {
                log(`❌ Strategy ${mode} error: ${error.message}`, 'error');
                updateSection(strategyResults, `❌ ${mode} strategy failed: ${error.message}`, 'error');
            }
        }
        
        document.getElementById('testMacroBtn').onclick = () => testStrategy('macro');
        document.getElementById('testCcsBtn').onclick = () => testStrategy('ccs');
        document.getElementById('testCycleBtn').onclick = () => testStrategy('cycle');
        document.getElementById('testBlendBtn').onclick = () => testStrategy('blend');
        
        // Test localStorage communication
        document.getElementById('testStorageBtn').onclick = function() {
            try {
                log('Testing localStorage communication...');
                
                const testData = {
                    targets: { BTC: 45.5, ETH: 25.3, 'Stablecoins': 15.2 },
                    timestamp: new Date().toISOString(),
                    strategy: 'test-strategy',
                    source: 'diagnostic-test'
                };
                
                localStorage.setItem('last_targets', JSON.stringify(testData));
                log('✅ Data saved to localStorage', 'success');
                
                const retrieved = JSON.parse(localStorage.getItem('last_targets'));
                if (retrieved.targets.BTC === testData.targets.BTC) {
                    log('✅ Data retrieved correctly from localStorage', 'success');
                    updateSection(storageResults, '✅ localStorage communication working', 'success');
                } else {
                    throw new Error('Data mismatch in localStorage');
                }
                
                // Test event dispatching
                window.dispatchEvent(new CustomEvent('targetsUpdated', {
                    detail: { targets: testData.targets, strategy: testData.strategy, source: 'test' }
                }));
                log('✅ Event dispatched successfully', 'success');
                
            } catch (error) {
                log(`❌ localStorage test error: ${error.message}`, 'error');
                updateSection(storageResults, `❌ localStorage test failed: ${error.message}`, 'error');
            }
        };
        
        log('Diagnostic test ready. Click buttons to run tests.');
    </script>
</body>
</html>