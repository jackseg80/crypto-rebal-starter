<!DOCTYPE html>
<html>
<head>
    <title>üî¨ CCS Diagnostic - Exact Issue Reproduction</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #f5f5f5; }
        .result { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #3b82f6; }
        .success { border-left-color: #22c55e; }
        .error { border-left-color: #ef4444; }
        .warning { border-left-color: #f59e0b; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f0f0f0; }
        .diff-high { background: #fecaca; color: #b91c1c; font-weight: bold; }
        .diff-medium { background: #fed7aa; color: #c2410c; }
        .diff-low { background: #dcfce7; color: #16a34a; }
    </style>
</head>
<body>
    <h1>üî¨ CCS Diagnostic Test</h1>
    <p>Ce test reproduit exactement le probl√®me observ√© par l'utilisateur</p>
    
    <div id="results">Chargement...</div>
    
    <script type="module">
        import { proposeTargets, generateCCSTargets, interpretCCS, normalizeTargets, DEFAULT_MACRO_TARGETS } from './static/modules/targets-coordinator.js';
        import { store } from './static/core/risk-dashboard-store.js';
        
        function runDiagnostic() {
            const resultsDiv = document.getElementById('results');
            let html = '';
            
            try {
                // 1. Test les interpr√©tations CCS
                html += '<div class="result"><h2>üéØ Test 1: Interpr√©tation CCS Score 72</h2>';
                
                const ccsScore = 72;
                const interpretation = interpretCCS(ccsScore);
                html += `<p><strong>CCS Score:</strong> ${ccsScore}</p>`;
                html += `<p><strong>Interpretation:</strong> ${interpretation.level} (${interpretation.label})</p>`;
                
                // 2. Test generateCCSTargets direct
                html += '<h3>generateCCSTargets(72) direct:</h3>';
                const directCCSTargets = generateCCSTargets(ccsScore);
                
                html += '<table>';
                html += '<tr><th>Asset</th><th>Valeur</th><th>Attendu par utilisateur</th><th>Match?</th></tr>';
                
                const expectedByUser = {
                    'BTC': 32.1,
                    'ETH': 24.2,
                    'Stablecoins': 21.3,
                    'L1/L0 majors': 11.1,
                    'L2/Scaling': 5.6,
                    'DeFi': 3.5,
                    'AI/Data': 2.2,
                    'Others': 0.0
                };
                
                Object.entries(directCCSTargets).forEach(([asset, value]) => {
                    if (asset === 'model_version') return;
                    
                    const expected = expectedByUser[asset] || 0;
                    const diff = Math.abs(value - expected);
                    const matchClass = diff < 0.1 ? 'diff-low' : diff < 2 ? 'diff-medium' : 'diff-high';
                    const match = diff < 0.1 ? '‚úÖ' : '‚ùå';
                    
                    html += `<tr>
                        <td>${asset}</td>
                        <td class="${matchClass}">${value.toFixed(1)}%</td>
                        <td>${expected}%</td>
                        <td>${match}</td>
                    </tr>`;
                });
                html += '</table></div>';
                
                // 3. Simuler store state et tester proposeTargets
                html += '<div class="result"><h2>üî¨ Test 2: Simulation Store State</h2>';
                
                // Mock store state like the user might have
                const mockState = {
                    ccs: { score: 72 },
                    cycle: { 
                        ccsStar: 72,  // This should trigger blendedCCS >= 70 case
                        multipliers: null,
                        weight: 0.3 
                    }
                };
                
                // Override store temporarily
                const originalGet = store.get;
                const originalSnapshot = store.snapshot;
                
                store.get = function(path) {
                    const keys = path.split('.');
                    return keys.reduce((obj, key) => obj?.[key], mockState);
                };
                
                store.snapshot = function() {
                    return mockState;
                };
                
                html += `<p><strong>Mock Store State:</strong></p>`;
                html += `<pre>${JSON.stringify(mockState, null, 2)}</pre>`;
                
                // Test blend strategy
                const blendProposal = proposeTargets('blend');
                
                html += '<h3>proposeTargets("blend") result:</h3>';
                html += `<p><strong>Strategy:</strong> ${blendProposal.strategy}</p>`;
                
                html += '<table>';
                html += '<tr><th>Asset</th><th>Blend Result</th><th>Attendu</th><th>Direct CCS</th><th>Analyse</th></tr>';
                
                Object.entries(blendProposal.targets).forEach(([asset, value]) => {
                    if (asset === 'model_version') return;
                    
                    const expected = expectedByUser[asset] || 0;
                    const directValue = directCCSTargets[asset];
                    const diff = Math.abs(value - expected);
                    const matchClass = diff < 0.1 ? 'diff-low' : diff < 2 ? 'diff-medium' : 'diff-high';
                    
                    let analysis = '';
                    if (Math.abs(value - directValue) < 0.1) {
                        analysis = 'Match CCS direct';
                    } else if (Math.abs(value - expected) < 0.1) {
                        analysis = 'Match utilisateur ‚úÖ';
                    } else {
                        analysis = 'Valeur diff√©rente ‚ùå';
                    }
                    
                    html += `<tr>
                        <td>${asset}</td>
                        <td class="${matchClass}">${value.toFixed(1)}%</td>
                        <td>${expected}%</td>
                        <td>${directValue.toFixed(1)}%</td>
                        <td>${analysis}</td>
                    </tr>`;
                });
                html += '</table>';
                
                // Restore store
                store.get = originalGet;
                store.snapshot = originalSnapshot;
                
                html += '</div>';
                
                // 4. Test what happens when we save to localStorage
                html += '<div class="result"><h2>üíæ Test 3: localStorage Save</h2>';
                
                const testSaveData = {
                    targets: blendProposal.targets,
                    strategy: blendProposal.strategy,
                    timestamp: new Date().toISOString(),
                    source: 'risk-dashboard-ccs'
                };
                
                localStorage.setItem('test_targets', JSON.stringify(testSaveData));
                const retrievedData = JSON.parse(localStorage.getItem('test_targets'));
                
                html += '<h3>Donn√©es sauvegard√©es vs r√©cup√©r√©es:</h3>';
                html += '<table>';
                html += '<tr><th>Asset</th><th>Avant Save</th><th>Apr√®s Retrieve</th><th>Identique?</th></tr>';
                
                Object.entries(blendProposal.targets).forEach(([asset, originalValue]) => {
                    if (asset === 'model_version') return;
                    
                    const retrievedValue = retrievedData.targets[asset];
                    const identical = Math.abs(originalValue - retrievedValue) < 0.001;
                    
                    html += `<tr>
                        <td>${asset}</td>
                        <td>${originalValue.toFixed(3)}%</td>
                        <td>${retrievedValue.toFixed(3)}%</td>
                        <td>${identical ? '‚úÖ' : '‚ùå'}</td>
                    </tr>`;
                });
                html += '</table>';
                
                localStorage.removeItem('test_targets');
                html += '</div>';
                
            } catch (error) {
                html += `<div class="result error"><h2>‚ùå Erreur</h2><pre>${error.message}\n${error.stack}</pre></div>`;
            }
            
            resultsDiv.innerHTML = html;
        }
        
        // Run diagnostic automatically
        runDiagnostic();
        
    </script>
</body>
</html>