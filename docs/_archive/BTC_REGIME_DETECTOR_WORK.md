# Crypto Regime Detector - Documentation Finale

> **Statut**: ‚úÖ PROJET 100% TERMIN√â | Derni√®re mise √† jour: 2025-10-21
> **Objectif**: Syst√®me hybride de d√©tection de r√©gimes multi-assets (Stock/BTC/ETH) avec UI centralis√©e

---

## üìä R√©sum√© du Projet

### ‚úÖ Phases Compl√©t√©es (100%)

**Phase 1 - Backend (100%)**
- Syst√®me hybride Rule-Based + HMM adapt√© pour Bitcoin
- 3 endpoints API: `/regime`, `/regime-history`, `/regime-forecast`
- Thresholds crypto-adjusted (3x plus volatiles que actions)
- Cache optimis√© (30x-600x speedup)

**Phase 2 - Frontend (100%)**
- Module `btc-regime-chart.js` (530 lignes)
- Charts interactifs (timeline + probabilities)
- Timeframe selector (1Y/2Y/5Y/10Y)
- Event annotations (Mt.Gox, FTX, COVID, ATHs)

**Phase 3 - Validation (100%)**
- Script `validate_btc_regime.py` (5/5 tests passent)
- Thresholds valid√©s
- Current regime: Correction @ 85% ‚úÖ

**Phase 4 - Restructuration UI (100%)**
- Nouvel onglet "üìà R√©gimes de March√©" dans `ai-dashboard.html`
- Centralisation Stock Market + Bitcoin regime detection
- Tableau comparatif cross-asset
- ~~Redirect notice dans `analytics-unified.html`~~ (supprim√© lors du nettoyage Oct 2025)

**Phase 5 - Extensions Multi-Assets (100%)**
- Ethereum regime detection ajout√© (m√™me syst√®me hybride que BTC)
- Stock regime probabilities modal (`stock-regime-history.js`)
- Cross-Asset Comparison √©tendu √† 3 assets (Stock/BTC/ETH)
- UI optimis√©e (tuiles statistiques plus compactes)

---

## üèóÔ∏è Architecture Finale

### Navigation
```
ai-dashboard.html ‚Üí Onglet "üìà R√©gimes de March√©"
‚îÇ
‚îú‚îÄ Section 1: Stock Market Regime Detection (HMM)
‚îÇ  ‚îú‚îÄ API: /api/ml/bourse/regime?benchmark=SPY
‚îÇ  ‚îî‚îÄ Modal: Stock Regime Probabilities (stock-regime-history.js)
‚îÇ
‚îú‚îÄ Section 2: Bitcoin Regime Detection (Hybrid)
‚îÇ  ‚îî‚îÄ API: /api/ml/crypto/regime?symbol=BTC
‚îÇ     ‚îî‚îÄ Charts: Timeline + Probabilities (btc-regime-chart.js)
‚îÇ
‚îú‚îÄ Section 2.5: Ethereum Regime Detection (Hybrid)
‚îÇ  ‚îî‚îÄ API: /api/ml/crypto/regime?symbol=ETH
‚îÇ
‚îî‚îÄ Section 3: Cross-Asset Comparison (Stock/BTC/ETH)
   ‚îî‚îÄ Tableau comparatif 3 assets
```

### Fichiers Cl√©s

**Backend:**
- `services/ml/models/btc_regime_detector.py` - D√©tecteur hybride g√©n√©rique (526 lignes, supporte BTC/ETH/etc.)
- `api/ml_crypto_endpoints.py` - 3 endpoints API crypto (427 lignes)
- `scripts/validate_btc_regime.py` - Validation script (200 lignes)

**Frontend:**
- `static/ai-dashboard.html` - Onglet R√©gimes de March√© (3 sections)
- `static/modules/btc-regime-chart.js` - Charts Bitcoin (530 lignes)
- `static/modules/stock-regime-history.js` - Modal Stock probabilities (296 lignes)
- ~~`static/analytics-unified.html` - Redirect notice~~ (section obsol√®te supprim√©e)

**Documentation:**
- `docs/BTC_HYBRID_REGIME_DETECTOR.md` - Documentation technique
- `docs/BTC_REGIME_DETECTOR_WORK.md` - Ce fichier
- `data/ml_predictions/btc_regime_validation_report.json` - R√©sultats validation

---

## üîß Configuration Thresholds

| Regime | Bitcoin/Ethereum | Stock Market | Justification |
|--------|------------------|--------------|---------------|
| **Bear Market** | DD ‚â§ -50%, 30d | DD ‚â§ -20%, 60d | Cryptos 3x plus volatiles |
| **Expansion** | +30%/mois, 3 mois | +15%/mois, 3 mois | Recovery plus violents |
| **Bull Market** | DD > -20%, vol <60% | DD > -5%, vol <20% | Baseline volatilit√© crypto |
| **Correction** | DD 10-50% **ET** vol >40% | DD 10-20% OU vol >30% | R√®gle stricte (AND logic) |

**Raisons:**
- BTC/ETH volatilit√© annuelle: 60-100% (vs bourse 15-25%)
- Bear markets crypto: -50% √† -85% (vs bourse -20% √† -55%)
- Recovery crypto: +100-300% en 3-6 mois (vs bourse +15-50%)
- **Ethereum**: Utilise les m√™mes thresholds que Bitcoin (volatilit√© similaire)

**Note Correction Rule**: AND logic (`DD 10-50% ET vol >40%`) pour √©viter de marquer les p√©riodes de haute volatilit√© bull/expansion comme Correction.

---

## üéØ Syst√®me Hybride

**Probl√®me**: HMM seul rate 100% des bear markets (temporal blindness)

**Solution**: Rule-Based + HMM Fusion
- **Rule-Based (‚â•85% confidence)**: Cas clairs (bear >50%, bull stable, expansion)
- **HMM (nuanc√©)**: Corrections 10-50%, consolidations
- **Fusion Logic**: Rule override HMM si confidence ‚â• 85%

**Contextual Features** (nouveaux):
- `drawdown_from_peak` - D√©tecte drawdowns cumulatifs (-55%)
- `days_since_peak` - Persistence temporelle (60+ jours)
- `trend_30d` - Contexte directionnel

---

## üì° API Endpoints

### 1. Current Regime Detection (Crypto)
```bash
GET /api/ml/crypto/regime?symbol=BTC&lookback_days=365
GET /api/ml/crypto/regime?symbol=ETH&lookback_days=365
```

**Response:**
```json
{
  "ok": true,
  "data": {
    "current_regime": "Correction",
    "confidence": 0.85,
    "detection_method": "rule_based",
    "rule_reason": "Moderate drawdown -11.8% + Elevated volatility 45.7%",
    "regime_probabilities": {
      "Bear Market": 0.05,
      "Correction": 0.85,
      "Bull Market": 0.08,
      "Expansion": 0.02
    }
  }
}
```

### 2. Historical Timeline (Crypto)
```bash
GET /api/ml/crypto/regime-history?symbol=BTC&lookback_days=365
```

**Response:**
```json
{
  "ok": true,
  "data": {
    "dates": ["2024-01-01", "2024-01-02", ...],
    "prices": [42000, 42500, ...],
    "regimes": ["Bull Market", "Bull Market", ...],
    "regime_ids": [2, 2, ...],
    "events": [
      {"date": "2024-03-14", "label": "BTC ATH $73k", "type": "peak"}
    ]
  }
}
```

### 3. Forecast Scenarios (Crypto)
```bash
GET /api/ml/crypto/regime-forecast?symbol=BTC&forecast_days=30
```

### 4. Stock Market Regime (HMM)
```bash
GET /api/ml/bourse/regime?benchmark=SPY&lookback_days=365
```

**Response:**
```json
{
  "current_regime": "Bull Market",
  "confidence": 0.888,
  "regime_probabilities": {
    "Bull": 0.888,
    "Bear": 0.05,
    "Sideways": 0.04,
    "Distribution": 0.022
  }
}
```

---

## üìù Commits Effectu√©s

### Phase 4 - UI Restructuration (4 commits)

1. **`1965208`** - Restructuration UI initiale
   - Nouvel onglet "R√©gimes de March√©" avec 3 sections
   - D√©placement code Bitcoin depuis analytics-unified.html
   - Redirect notice ajout√©

2. **`9da196f`** - Fix Chart.js dependencies
   - Ajout Chart.js v4.4.1 + plugins (annotation, date-fns, datalabels)
   - CSS styles regime-chips + detection-method badges
   - Styles responsive

3. **`5d9b4f1`** - Debug logging am√©lior√©
   - Logging d√©taill√© (üì°, ‚úÖ, ‚ùå, ‚ö†Ô∏è)
   - Gestion 3 formats de r√©ponse API Bitcoin
   - Meilleurs messages d'erreur

4. **`7071269`** - Fix endpoint Stock Regime
   - Changement `/api/ml/predict` ‚Üí `/api/ml/bourse/regime`
   - Parsing correct: `current_regime` au lieu de `regime_prediction`
   - Cross-Asset Comparison fonctionnel

### Phase 5 - Extensions Multi-Assets (√Ä committer)

1. **Ethereum Regime Detection**
   - Section Ethereum ajout√©e dans R√©gimes tab
   - Utilise m√™me backend g√©n√©rique (btc_regime_detector.py supporte symbol=ETH)
   - UI: Current regime + confidence + detection method + rule reason
   - Lightweight view (pas de charts d√©taill√©s comme Bitcoin)

2. **Stock Regime Probabilities Modal**
   - Nouveau module `stock-regime-history.js` (296 lignes)
   - Modal affichant les probabilit√©s HMM de chaque √©tat
   - Bouton "üìä View Probabilities" dans section Stock Market
   - Graphique en barres avec couleurs par r√©gime

3. **Cross-Asset Comparison √©tendu**
   - Tableau 3 assets: Stock / Bitcoin / Ethereum
   - Colonnes: Current Regime, Confidence, Detection Method, Bear Threshold
   - Loading automatique des 3 sources en parall√®le

4. **UI Optimisations**
   - Tuiles statistiques r√©duites: padding 1rem, font-size 1.5rem
   - Min-width: 150px (vs 200px avant)
   - Gap r√©duit: 0.75rem (vs 1rem)

### Phases Pr√©c√©dentes (3 commits)

1. **`735b340`** - Backend + Frontend fixes
   - Rule 4 "Correction" (AND logic) pour √©viter Bear permanent
   - Endpoint `/regime-forecast` ajout√©
   - Fix graphique r√©tr√©cit (canvas height fixe)

2. **`f699578`** - Bitcoin regime detector complet
   - Backend: btc_regime_detector.py + ml_crypto_endpoints.py
   - Frontend: btc-regime-chart.js
   - Validation: validate_btc_regime.py

3. **`e197c0e`** - Optimisation performance
   - Cache in-memory (TTL: 1h) pour /regime-history
   - Feature caching (30x-600x speedup)

---

## üöÄ Usage

### Acc√®s Frontend
1. Ouvrir `http://localhost:8000/static/ai-dashboard.html`
2. Cliquer sur l'onglet **"üìà R√©gimes de March√©"** (4√®me onglet)
3. Observer les sections :
   - **Stock Market Regime** (HMM) - avec bouton "üìä View Probabilities"
   - **Bitcoin Regime** (Hybrid) - avec charts timeline + probabilities
   - **Ethereum Regime** (Hybrid) - lightweight summary
   - **Cross-Asset Comparison** - tableau 3 assets (Stock/BTC/ETH)

### Features
- **Multi-Assets**: 3 assets track√©s simultan√©ment (Stock/BTC/ETH)
- **Timeframe selector** (Bitcoin): 1Y/2Y/5Y/10Y (boutons)
- **Event annotations** (Bitcoin): Mt.Gox (2014), FTX (2022), COVID (2020), ATHs
- **Regime chips**: Couleurs (Bear=rouge, Bull=vert, Correction=orange, Expansion=bleu)
- **Stock Probabilities Modal**: Clic "View Probabilities" ‚Üí graphique probabilit√©s HMM
- **Lazy loading**: Charts initialis√©s au premier clic (performance)
- **Refresh buttons**: Mise √† jour manuelle des donn√©es

---

## üêõ Bugs Fix√©s

### Bug 1: R√©gime Bear Permanent
- **Sympt√¥me**: Toujours d√©tect√© en "Bear Market" m√™me avec DD -11.8%
- **Cause**: Aucune r√®gle pour cas interm√©diaires ‚Üí HMM d√©cidait √† tort
- **Fix**: Ajout√© Rule 4 "Correction" (DD 10-50% OU vol >60%)

### Bug 2: Graphique R√©tr√©cit
- **Sympt√¥me**: Canvas perd dimensions apr√®s changement timeframe
- **Fix**: Canvas height fixe + container min-height: 550px

### Bug 3: Chart is not defined
- **Sympt√¥me**: Erreur JS sur ai-dashboard.html
- **Fix**: Ajout Chart.js + plugins dans `<head>`

### Bug 4: Stock Regime N/A
- **Sympt√¥me**: Endpoint retourne `regime_prediction: null`
- **Fix**: Changement endpoint `/api/ml/predict` ‚Üí `/api/ml/bourse/regime`

### Bug 5: Stock Modal 404 Error
- **Sympt√¥me**: Modal "View History" retourne 404 (config path incorrect)
- **Fix Phase 5**:
  - Changement fetch config: `/config/global-config.json` ‚Üí `window.fetchUserConfig()`
  - Titre modal: "History" ‚Üí "Probabilities" (plus pr√©cis)
  - Graphique: Affiche probabilit√©s HMM au lieu d'historique temporel

---

## ‚úÖ Validation

**Script**: `scripts/validate_btc_regime.py`

**Tests Pass√©s (5/5)**:
- ‚úÖ Bear drawdown -0.50
- ‚úÖ Bear duration 30d
- ‚úÖ Expansion +0.30/month
- ‚úÖ Bull volatility 0.60
- ‚úÖ Correction rule exists

**Current Regime Detection**:
- Detected: Correction @ 85%
- Method: rule_based
- Valid: YES ‚úÖ

---

## üéØ Prochaines √âtapes Potentielles

1. ~~**Ethereum Regime Detection**~~ - ‚úÖ **TERMIN√â Phase 5**
2. ~~**Stock Regime Probabilities Modal**~~ - ‚úÖ **TERMIN√â Phase 5**
3. **Export Functionality** - CSV/JSON export pour tableau comparatif
4. **Alertes Automatiques** - Notifications sur changement de r√©gime
5. **Altseason Detection** - R√©gime sp√©cifique altcoins vs BTC
6. **Ethereum Charts Complets** - Ajouter timeline + probabilities charts comme Bitcoin
7. **Historical Regime Timeline (Stock)** - Impl√©menter vraie timeline (n√©cessite backend history)

---

## üìö Documentation Compl√©mentaire

- **`docs/BTC_HYBRID_REGIME_DETECTOR.md`** - Documentation technique d√©taill√©e
- **`docs/HYBRID_REGIME_DETECTOR.md`** - Syst√®me bourse (Stock Market)
- **API Swagger**: `http://localhost:8000/docs` (endpoints interactifs)

---

**Projet Multi-Asset Regime Detection**: ‚úÖ **100% Termin√© (Phase 5)** | Oct 2025
