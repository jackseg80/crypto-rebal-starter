<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rebalance Plan</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#38bdf8; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
    body { margin:0; font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width:1100px; margin:32px auto; padding:0 16px; }
    h1 { font-size:22px; margin:0 0 16px; }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .card { background:var(--card); border:1px solid #1f2937; border-radius:12px; padding:16px; flex:1 1 420px; }
    .muted { color:var(--muted); }
    input[type="number"], input[type="text"] { width:100%; padding:8px; background:#0b1220; border:1px solid #273249; color:var(--text); border-radius:8px; }
    input[type="range"] { width:100%; }
    button { background:var(--accent); border:0; color:#06121a; font-weight:600; padding:10px 14px; border-radius:10px; cursor:pointer; }
    button.ghost { background:#0b1220; color:var(--text); border:1px solid #273249; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; }
    .ok { background:#052814; color:#86efac; }
    .warn { background:#2a1e04; color:#fde68a; }
    .bad { background:#2a0b0b; color:#fecaca; }
    table { width:100%; border-collapse:collapse; }
    th, td { text-align:right; padding:8px; border-bottom:1px solid #1f2937; }
    th:first-child, td:first-child { text-align:left; }
    .small { font-size:12px; }
    .section-title { display:flex; align-items:center; justify-content:space-between; margin:6px 0 12px; }
    .chips { display:flex; gap:6px; flex-wrap:wrap; }
    .chip { background:#0b1220; border:1px solid #273249; padding:4px 8px; border-radius:999px; font-size:12px; }
    details { background:#0b1220; border:1px solid #273249; border-radius:10px; padding:10px 12px; }
    summary { cursor:pointer; }
    .two { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    @media (max-width:900px){ .two { grid-template-columns:1fr; } }

    /* === LIGNE DES SLIDERS : plus de chevauchement === */
    #sliders .row-item{
      display:grid;
      grid-template-columns: 160px 1fr 90px; /* libellé | slider | nombre */
      gap:10px;
      align-items:center;
      margin:6px 0;
    }
    #sliders .row-item label{
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* badge “Somme : …” */
    #sumBadge{
      display:inline-block; margin-left:8px; padding:2px 8px; border-radius:12px;
      background:#123f2a; color:#b6ffcf; font-size:12px;
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Rebalance — plan & export CSV</h1>

  <div class="row">
    <!-- Colonne gauche -->
    <div class="card">
      <div class="section-title">
        <strong>Répartition cible (doit faire 100%)</strong>
        <span id="sumBadge" class="pill warn">Somme : 0%</span>
      </div>

      <div id="sliders"></div>

      <div class="two" style="margin-top:12px">
        <div>
          <label class="small muted">min_trade_usd</label>
          <input id="minTrade" type="number" step="1" min="0" value="25">
        </div>
        <div>
          <label class="small muted">min_usd (filtre ligne)</label>
          <input id="minUsd" type="number" step="1" min="0" value="1">
        </div>
      </div>

      <div style="margin-top:12px">
        <label class="small muted">primary_symbols (virgule)</label>
        <div class="two">
          <input id="symBTC" type="text" placeholder="BTC,TBTC,WBTC" value="BTC,TBTC,WBTC">
          <input id="symETH" type="text" placeholder="ETH,WSTETH,STETH,RETH,WETH" value="ETH,WSTETH,STETH,RETH,WETH">
        </div>
        <div class="two" style="margin-top:8px">
          <input id="symSOL" type="text" placeholder="SOL,JUPSOL,JITOSOL" value="SOL,JUPSOL,JITOSOL">
          <input id="symExtra" type="text" placeholder="(optionnel) GROUP=SYM1,SYM2" value="">
        </div>
      </div>

      <div style="display:flex; gap:8px; margin-top:14px;">
        <button id="btnPlan">Générer le plan</button>
        <button id="btnCsv" class="ghost">Télécharger CSV</button>
        <button id="btnSave" class="ghost">Sauvegarder</button>
        <button id="btnReset" class="ghost">Reset</button>
      </div>
      <div class="muted small" style="margin-top:8px">Astuce: la config est sauvegardée en localStorage.</div>
    </div>

    <!-- Colonne droite -->
    <div class="card" style="flex:2 1 520px;">
      <div class="section-title">
        <strong>Résumé</strong>
        <span id="badgeTotal" class="pill ok">Total: -</span>
      </div>
      <div id="summary" class="muted small">Clique sur “Générer le plan”.</div>

      <div style="margin-top:12px">
        <table id="tblGroups" hidden>
          <thead>
            <tr><th>Group</th><th>CurrentUSD</th><th>Current%</th><th>TargetUSD</th><th>Target%</th><th>DeltaUSD</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="two" style="margin-top:16px">
        <div>
          <div class="section-title"><strong>Top achats</strong></div>
          <table id="tblBuys" hidden>
            <thead><tr><th>group</th><th>alias</th><th>symbol</th><th>usd</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div>
          <div class="section-title"><strong>Top ventes</strong></div>
          <table id="tblSells" hidden>
            <thead><tr><th>group</th><th>alias</th><th>symbol</th><th>usd</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div style="margin-top:16px">
        <details>
          <summary><strong>Aliases inconnus</strong> <span id="unknownCount" class="pill muted">0</span></summary>
          <div id="unknownList" class="chips" style="margin-top:8px;"></div>
        </details>
      </div>
    </div>
  </div>
</div>

<script>
/* ====== Config ====== */
const API = (path, qs="") => `http://127.0.0.1:8000${path}${qs}`;
const GROUPS = ["BTC","ETH","Stablecoins","SOL","L1/L0 majors","Others"];

/* ====== UI sliders ====== */
const slidersEl = document.getElementById('sliders');
const sumBadge  = document.getElementById('sumBadge');
const minTrade  = document.getElementById('minTrade');
const minUsd    = document.getElementById('minUsd');
const symBTC    = document.getElementById('symBTC');
const symETH    = document.getElementById('symETH');
const symSOL    = document.getElementById('symSOL');
const symExtra  = document.getElementById('symExtra');

const sliders = {}; // { group: {range, num} }

function makeRow(group, value=0){
  const row = document.createElement('div');
  row.className = 'row-item';

  const label = document.createElement('label');
  label.textContent = group;
  row.appendChild(label);

  const range = document.createElement('input');
  range.type = 'range'; range.min = 0; range.max = 100; range.step = 1; range.value = value;
  row.appendChild(range);

  const num = document.createElement('input');
  num.type = 'number'; num.min = 0; num.max = 100; num.step = 1; num.value = value;
  row.appendChild(num);

  range.addEventListener('input', ()=>{ num.value = range.value; refreshSum(); saveScratch(); });
  num.addEventListener('input',   ()=>{ range.value = num.value || 0; refreshSum(); saveScratch(); });

  sliders[group] = { range, num };
  slidersEl.appendChild(row);
}

function refreshSum(){
  let sum = 0;
  for (const g of GROUPS) sum += Number(sliders[g].num.value || 0);
  sumBadge.textContent = `Somme : ${sum}%`;
  sumBadge.className = 'pill ' + (sum===100 ? 'ok' : (sum>100 ? 'bad' : 'warn'));
}

function defaultTargets(){
  return { BTC:35, ETH:25, Stablecoins:10, SOL:10, "L1/L0 majors":10, Others:10 };
}

/* ====== localStorage ====== */
function saveScratch(){
  const cfg = {
    targets: Object.fromEntries(GROUPS.map(g=>[g, Number(sliders[g].num.value||0)])),
    min_trade_usd: Number(minTrade.value||25),
    min_usd: Number(minUsd.value||1),
    primary_symbols: collectPrimarySymbols(),
  };
  localStorage.setItem('rebalance_config', JSON.stringify(cfg));
}
function loadScratch(){
  const raw = localStorage.getItem('rebalance_config');
  if(!raw) return;
  try{
    const cfg = JSON.parse(raw);
    if (cfg.targets) for (const g of GROUPS) {
      if (g in cfg.targets) sliders[g].range.value = sliders[g].num.value = cfg.targets[g];
    }
    if (cfg.min_trade_usd != null) minTrade.value = cfg.min_trade_usd;
    if (cfg.min_usd != null)       minUsd.value   = cfg.min_usd;
    if (cfg.primary_symbols){
      if (cfg.primary_symbols.BTC) symBTC.value = cfg.primary_symbols.BTC.join(',');
      if (cfg.primary_symbols.ETH) symETH.value = cfg.primary_symbols.ETH.join(',');
      if (cfg.primary_symbols.SOL) symSOL.value = cfg.primary_symbols.SOL.join(',');
      const extras = Object.entries(cfg.primary_symbols)
        .filter(([k])=>!["BTC","ETH","SOL"].includes(k))
        .map(([k,v])=>`${k}=${v.join(',')}`).join(' ; ');
      symExtra.value = extras;
    }
  }catch{}
}
function collectPrimarySymbols(){
  const map = {
    BTC: symBTC.value.split(',').map(s=>s.trim()).filter(Boolean),
    ETH: symETH.value.split(',').map(s=>s.trim()).filter(Boolean),
    SOL: symSOL.value.split(',').map(s=>s.trim()).filter(Boolean),
  };
  if (symExtra.value.trim()){
    const parts = symExtra.value.split(';');
    for(const p of parts){
      const [g, list] = p.split('=');
      if (g && list) map[g.trim()] = list.split(',').map(s=>s.trim()).filter(Boolean);
    }
  }
  return map;
}

/* init sliders */
for (const g of GROUPS) makeRow(g, defaultTargets()[g] ?? 0);
loadScratch();
refreshSum();

/* ====== API calls ====== */
const badgeTotal  = document.getElementById('badgeTotal');
const summary     = document.getElementById('summary');
const tblGroups   = document.getElementById('tblGroups');
const tbGroups    = tblGroups.querySelector('tbody');
const tblBuys     = document.getElementById('tblBuys');
const tbBuys      = tblBuys.querySelector('tbody');
const tblSells    = document.getElementById('tblSells');
const tbSells     = tblSells.querySelector('tbody');
const unknownCount= document.getElementById('unknownCount');
const unknownList = document.getElementById('unknownList');

function fmt(n){ return n.toLocaleString('fr-FR', {maximumFractionDigits:2}); }

function buildPayload(){
  const targets = Object.fromEntries(GROUPS.map(g=>[g, Number(sliders[g].num.value||0)]));
  return {
    group_targets_pct: targets,
    sub_allocation: "proportional",
    min_trade_usd: Number(minTrade.value||25),
    primary_symbols: collectPrimarySymbols(),
  };
}

async function callPlan(){
  const qs = `?source=cointracking&min_usd=${encodeURIComponent(minUsd.value||1)}`;
  const payload = buildPayload();
  const res = await fetch(API('/rebalance/plan', qs), {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  if(!res.ok){ const t = await res.text(); throw new Error(t); }
  return res.json();
}

/* ====== UI actions ====== */
document.getElementById('btnSave').onclick  = ()=>{ saveScratch(); alert('Config sauvegardée.'); };
document.getElementById('btnReset').onclick = ()=>{ localStorage.removeItem('rebalance_config'); location.reload(); };

document.getElementById('btnPlan').onclick = async ()=>{
  try{
    summary.textContent = 'Calcul en cours...';
    const plan = await callPlan();

    badgeTotal.textContent = `Total: ${fmt(plan.total_usd)}`;
    summary.innerHTML = `
      <div class="chips">
        <span class="chip">Achats: ${fmt(plan.actions.filter(a=>a.action==='buy').reduce((s,a)=>s+a.usd,0))} USD</span>
        <span class="chip">Ventes: ${fmt(plan.actions.filter(a=>a.action==='sell').reduce((s,a)=>s+a.usd,0))} USD</span>
        <span class="chip">Actions: ${plan.actions.length}</span>
      </div>`;

    tbGroups.innerHTML = '';
    const groups = Object.keys(plan.current_by_group || {});
    for(const g of groups){
      const cur    = plan.current_by_group[g] || 0;
      const curPct = plan.current_weights_pct?.[g] ?? 0;
      const tgtPct = plan.target_weights_pct?.[g] ?? 0;
      const tgtUSD = plan.targets_usd?.[g] ?? 0;
      const delta  = plan.deltas_by_group_usd?.[g] ?? 0;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${g}</td><td>${fmt(cur)}</td><td>${fmt(curPct)}</td><td>${fmt(tgtUSD)}</td><td>${fmt(tgtPct)}</td><td>${fmt(delta)}</td>`;
      tbGroups.appendChild(tr);
    }
    tblGroups.hidden = false;

    const buys  = plan.actions.filter(a=>a.action==='buy').sort((a,b)=>b.usd-a.usd).slice(0,12);
    const sells = plan.actions.filter(a=>a.action==='sell').sort((a,b)=>a.usd-b.usd).slice(0,12);
    tbBuys.innerHTML  = buys.map(a=>`<tr><td>${a.group}</td><td>${a.alias}</td><td>${a.symbol}</td><td>${fmt(a.usd)}</td></tr>`).join('');
    tbSells.innerHTML = sells.map(a=>`<tr><td>${a.group}</td><td>${a.alias}</td><td>${a.symbol}</td><td>${fmt(a.usd)}</td></tr>`).join('');
    tblBuys.hidden  = buys.length===0;
    tblSells.hidden = sells.length===0;

    const unk = plan.unknown_aliases || [];
    unknownCount.textContent = unk.length;
    unknownList.innerHTML = unk.map(x=>`<span class="chip">${x}</span>`).join('');
  }catch(err){
    alert('Erreur: ' + err.message);
  }
};

document.getElementById('btnCsv').onclick = async ()=>{
  try{
    const qs = `?source=cointracking&min_usd=${encodeURIComponent(minUsd.value||1)}`;
    const payload = buildPayload();
    const res = await fetch(API('/rebalance/plan.csv', qs), {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!res.ok){ const t = await res.text(); throw new Error(t); }
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'rebalance-actions.csv';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }catch(err){
    alert('Erreur CSV: ' + err.message);
  }
};
</script>
</body>
</html>
