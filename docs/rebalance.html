<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rebalance Planner</title>
  <style>
    :root { --bg:#0b1220; --fg:#e7ecf3; --muted:#9aa7b2; --card:#121a2a; --acc:#5ac8fa; --bad:#ff6b6b; --ok:#2ecc71; --warn:#f4b400; }
    * { box-sizing: border-box; }
    html, body { margin:0; height:100%; background:var(--bg); color:var(--fg); font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    a { color: var(--acc); text-decoration: none; }
    .container { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    header { display:flex; gap:12px; align-items:center; margin-bottom: 18px; }
    header h1 { font-size: 18px; margin:0; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width: 920px) { .row { grid-template-columns: 1fr; } }
    .card { background:var(--card); border:1px solid #1e2740; border-radius:14px; padding:16px; }
    .card h3 { margin:0 0 12px; font-size:15px; }
    label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input[type="text"], input[type="number"], select, textarea {
      width:100%; background:#0e1628; color:var(--fg); border:1px solid #243056; border-radius:10px; padding:10px 12px; outline:none;
    }
    input[type="range"] { width:100%; }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .grid-3 { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    .targets { display:grid; grid-template-columns: 130px 1fr 70px; gap:10px; align-items:center; }
    .sum { font-weight:600; }
    .sum.bad { color: var(--bad); }
    .sum.ok { color: var(--ok); }
    .btn { display:inline-flex; align-items:center; gap:8px; background:#233259; color:#fff; border:1px solid #2e4175; padding:10px 14px; border-radius:10px; cursor:pointer; user-select:none; }
    .btn.primary { background:#2a72ff; border-color:#2a72ff; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .warn { color: var(--warn); }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; background:#1a2440; border:1px solid #2a3c6f; margin:3px; font-size:12px; }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding:8px 10px; border-bottom:1px solid #1e2740; }
    th { font-size:12px; color:var(--muted); font-weight:600; }
    tfoot td { font-weight:700; }
    .right { text-align:right; }
    .muted { color: var(--muted); }
    .badge-buy { color:#16c784; }
    .badge-sell { color:#ff6868; }
    .flex { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .hidden { display:none !important; }
    .small { font-size:12px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Rebalance Planner</h1>
      <span class="muted">·</span>
      <a href="./index.html">ouvrir le dashboard</a>
      <span class="muted">·</span>
      <a href="https://github.com/jackseg80/crypto-rebal-starter" target="_blank" rel="noreferrer">repo</a>
    </header>

    <div class="row">
      <div class="card">
        <h3>Connexion API</h3>
        <div class="grid-2">
          <div>
            <label>API base URL</label>
            <input id="apiUrl" type="text" placeholder="http://127.0.0.1:8000" />
            <div id="httpsWarn" class="small warn hidden" style="margin-top:6px;">
              Cette page est servie en <b>https</b>. Pour éviter le “mixed content”, ton API doit aussi être accessible en <b>https</b> (ex: ngrok).
            </div>
          </div>
          <div>
            <label>Source</label>
            <input id="source" type="text" value="cointracking" />
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Paramètres</h3>
        <div class="grid-3">
          <div>
            <label>min_usd (filtre données)</label>
            <input id="minUsd" type="number" min="0" step="1" value="1" />
          </div>
          <div>
            <label>min_trade_usd</label>
            <input id="minTrade" type="number" min="0" step="1" value="25" />
          </div>
          <div>
            <label>sub_allocation</label>
            <select id="subAlloc">
              <option value="proportional" selected>proportional</option>
              <option value="flat">flat</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Poids cibles (%)</h3>
        <div id="targets" class="targets">
          <!-- Lignes générées par JS -->
        </div>
        <div class="flex" style="margin-top:10px;">
          <span class="muted">Somme :</span>
          <span id="sum" class="sum">0</span>%
          <button id="btnNormalize" class="btn">Normaliser à 100%</button>
          <button id="btnPreset" class="btn">Preset BTC35 / ETH25 / 10x4</button>
        </div>
      </div>

      <div class="card">
        <h3>Primary symbols (mapping intra-groupe)</h3>
        <div class="grid-3">
          <div>
            <label>BTC aliases (CSV)</label>
            <input id="symBTC" type="text" value="BTC,TBTC,WBTC" />
          </div>
          <div>
            <label>ETH aliases (CSV)</label>
            <input id="symETH" type="text" value="ETH,WSTETH,STETH,RETH,WETH" />
          </div>
          <div>
            <label>SOL aliases (CSV)</label>
            <input id="symSOL" type="text" value="SOL,JUPSOL,JITOSOL" />
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="toolbar">
        <button id="btnPlan" class="btn primary">Générer le plan</button>
        <button id="btnCSV" class="btn" disabled>Exporter les actions en CSV</button>
        <span id="status" class="muted"></span>
      </div>
    </div>

    <div id="results" class="row" style="margin-top:16px;">
      <div class="card">
        <h3>Résumé</h3>
        <div id="summary" class="small muted">—</div>
        <div id="unknown" style="margin-top:8px;"></div>
      </div>

      <div class="card">
        <h3>Top achats / ventes</h3>
        <div class="row">
          <div>
            <table id="tblBuys">
              <thead><tr><th>group</th><th>alias</th><th>symbol</th><th class="right">usd</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div>
            <table id="tblSells">
              <thead><tr><th>group</th><th>alias</th><th>symbol</th><th class="right">usd</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Répartition actuelle vs cible</h3>
        <table id="tblDist">
          <thead>
            <tr><th>Group</th><th class="right">CurrentUSD</th><th class="right">CurrentPct</th><th class="right">TargetUSD</th><th class="right">TargetPct</th><th class="right">DeltaUSD</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  // --- Config & état ---
  const GROUPS = ["BTC","ETH","Stablecoins","SOL","L1/L0 majors","Others"];
  const els = {
    apiUrl: document.getElementById('apiUrl'),
    httpsWarn: document.getElementById('httpsWarn'),
    source: document.getElementById('source'),
    minUsd: document.getElementById('minUsd'),
    minTrade: document.getElementById('minTrade'),
    subAlloc: document.getElementById('subAlloc'),
    targets: document.getElementById('targets'),
    sum: document.getElementById('sum'),
    btnNormalize: document.getElementById('btnNormalize'),
    btnPreset: document.getElementById('btnPreset'),
    symBTC: document.getElementById('symBTC'),
    symETH: document.getElementById('symETH'),
    symSOL: document.getElementById('symSOL'),
    btnPlan: document.getElementById('btnPlan'),
    btnCSV: document.getElementById('btnCSV'),
    status: document.getElementById('status'),
    summary: document.getElementById('summary'),
    tblBuys: document.querySelector('#tblBuys tbody'),
    tblSells: document.querySelector('#tblSells tbody'),
    tblDist: document.querySelector('#tblDist tbody'),
    unknown: document.getElementById('unknown'),
  };
  let lastActions = [];

  // Warn https→http
  function checkHttpsWarning() {
    const api = els.apiUrl.value.trim();
    if (location.protocol === 'https:' && api.startsWith('http://')) {
      els.httpsWarn.classList.remove('hidden');
    } else {
      els.httpsWarn.classList.add('hidden');
    }
  }

  // Sliders
  function makeTargetRow(group, value=0) {
    const label = document.createElement('div');
    label.textContent = group;

    const range = document.createElement('input');
    range.type = 'range'; range.min = 0; range.max = 100; range.step = 0.5; range.value = value;

    const pct = document.createElement('input');
    pct.type = 'number'; pct.min = 0; pct.max = 100; pct.step = 0.5; pct.value = value;

    range.addEventListener('input', () => { pct.value = range.value; updateSum(); });
    pct.addEventListener('input', () => { range.value = pct.value; updateSum(); });

    els.targets.appendChild(label);
    els.targets.appendChild(range);
    els.targets.appendChild(pct);
  }

  function initTargets() {
    els.targets.innerHTML = '';
    // preset défaut
    const preset = { BTC:35, ETH:25, Stablecoins:10, SOL:10, "L1/L0 majors":10, Others:10 };
    GROUPS.forEach(g => makeTargetRow(g, preset[g] ?? 0));
    updateSum();
  }

  function readTargets() {
    const rows = els.targets.querySelectorAll('input[type="number"]');
    const out = [];
    GROUPS.forEach((g, i) => {
      const v = parseFloat(rows[i].value || '0');
      out.push({ group: g, weight_pct: isFinite(v) ? v : 0 });
    });
    return out;
    // NOTE: l’API accepte aussi un dict group_targets_pct, mais on utilise ici la version "targets" (liste).
  }

  function updateSum() {
    const total = readTargets().reduce((s, t) => s + (t.weight_pct || 0), 0);
    els.sum.textContent = total.toFixed(1);
    els.sum.classList.toggle('ok', Math.abs(total-100) < 0.01);
    els.sum.classList.toggle('bad', Math.abs(total-100) >= 0.01);
  }

  function normalizeTo100() {
    const t = readTargets();
    const sum = t.reduce((s,x)=>s+x.weight_pct,0);
    if (sum <= 0) return;
    const rows = els.targets.querySelectorAll('input[type="number"]');
    t.forEach((x,i)=> { rows[i].value = (x.weight_pct*100/sum).toFixed(1); rows[i].dispatchEvent(new Event('input')); });
  }

  function setPreset() {
    initTargets();
  }

  // Helpers
  function toCSV(actions) {
    const head = ['group','alias','symbol','action','usd'];
    const esc = v => `"${String(v ?? '').replace(/"/g,'""')}"`;
    const rows = actions.map(a => [a.group,a.alias,a.symbol,a.action,a.usd]);
    return [head, ...rows].map(r => r.map(esc).join(',')).join('\r\n');
  }

  function download(filename, text) {
    const blob = new Blob([text], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }

  function fmtUsd(n) { return new Intl.NumberFormat('fr-FR', { style:'currency', currency:'USD', maximumFractionDigits: 2 }).format(n); }
  function fmtPct(n) { return `${Number(n).toFixed(3)}%`; }

  // Appel API
  async function generatePlan() {
    try {
      els.status.textContent = 'Calcul en cours…';
      els.btnPlan.disabled = true;

      const api = els.apiUrl.value.trim() || 'http://127.0.0.1:8000';
      checkHttpsWarning();

      const q = new URLSearchParams({ source: els.source.value.trim() || 'cointracking', min_usd: String(els.minUsd.value || '1') });
      const url = `${api}/rebalance/plan?${q.toString()}`;

      const primary_symbols = {};
      if (els.symBTC.value.trim()) primary_symbols.BTC = els.symBTC.value.split(',').map(s=>s.trim()).filter(Boolean);
      if (els.symETH.value.trim()) primary_symbols.ETH = els.symETH.value.split(',').map(s=>s.trim()).filter(Boolean);
      if (els.symSOL.value.trim()) primary_symbols.SOL = els.symSOL.value.split(',').map(s=>s.trim()).filter(Boolean);

      const payload = {
        targets: readTargets(),
        sub_allocation: els.subAlloc.value,
        min_trade_usd: Number(els.minTrade.value || 25),
        primary_symbols
      };

      const resp = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if (!resp.ok) {
        const errText = await resp.text();
        throw new Error(`HTTP ${resp.status} – ${errText}`);
      }
      const plan = await resp.json();
      renderPlan(plan);

      els.status.textContent = 'OK';
    } catch (e) {
      console.error(e);
      els.status.textContent = `Erreur: ${e.message || e}`;
    } finally {
      els.btnPlan.disabled = false;
    }
  }

  function renderPlan(plan) {
    // Résumé
    const total = plan.total_usd ?? 0;
    const cur = plan.current_by_group || {};
    const tgtPct = plan.target_weights_pct || {};
    const deltas = plan.deltas_by_group_usd || {};

    // Dist tableau
    const tbody = els.tblDist; tbody.innerHTML = '';
    const groups = GROUPS.slice(); // ordre fixe
    groups.forEach(g => {
      const curUsd = cur[g] ?? 0;
      const curPct = plan.current_weights_pct?.[g] ?? 0;
      const tarPct = tgtPct[g] ?? 0;
      const tarUsd = total * (tarPct/100);
      const delta = (deltas[g] ?? (tarUsd - curUsd));
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${g}</td>
        <td class="right">${fmtUsd(curUsd)}</td>
        <td class="right">${Number(curPct).toFixed(3)}%</td>
        <td class="right">${fmtUsd(tarUsd)}</td>
        <td class="right">${Number(tarPct).toFixed(1)}%</td>
        <td class="right">${fmtUsd(delta)}</td>`;
      tbody.appendChild(tr);
    });

    // Summary
    const lines = [];
    lines.push(`<div>Total USD : <b>${fmtUsd(total)}</b></div>`);
    const sumBuys = (plan.actions || []).filter(a=>a.action==='buy').reduce((s,a)=>s+(a.usd||0),0);
    const sumSells = (plan.actions || []).filter(a=>a.action==='sell').reduce((s,a)=>s+(a.usd||0),0);
    lines.push(`<div>Achats : <span class="badge-buy">${fmtUsd(sumBuys)}</span> — Ventes : <span class="badge-sell">${fmtUsd(sumSells)}</span> — Net : <b>${fmtUsd(sumBuys + sumSells)}</b></div>`);
    els.summary.innerHTML = lines.join('');

    // Unknown aliases
    const unk = plan.unknown_aliases || [];
    els.unknown.innerHTML = (unk.length ? `<div class="small muted">Unknown aliases:</div>` : '') + unk.map(x=>`<span class="pill">${x}</span>`).join('');

    // Top lists
    lastActions = plan.actions || [];
    const buys = lastActions.filter(a=>a.action==='buy').sort((a,b)=>b.usd-a.usd).slice(0,15);
    const sells = lastActions.filter(a=>a.action==='sell').sort((a,b)=>a.usd-b.usd).slice(0,15);

    function fillTable(tbody, rows) {
      tbody.innerHTML = '';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.group}</td><td>${r.alias}</td><td>${r.symbol}</td><td class="right">${fmtUsd(r.usd)}</td>`;
        tbody.appendChild(tr);
      });
    }
    fillTable(els.tblBuys, buys);
    fillTable(els.tblSells, sells);

    // CSV
    els.btnCSV.disabled = lastActions.length === 0;
  }

  // Events
  els.btnPlan.addEventListener('click', generatePlan);
  els.btnCSV.addEventListener('click', () => {
    const csv = toCSV(lastActions);
    const ts = new Date().toISOString().replace(/[:.]/g,'-');
    download(`rebalance-actions-${ts}.csv`, csv);
  });
  els.btnNormalize.addEventListener('click', normalizeTo100);
  els.btnPreset.addEventListener('click', setPreset);
  els.apiUrl.addEventListener('input', checkHttpsWarning);

  // Init
  (function boot(){
    els.apiUrl.value = localStorage.getItem('apiUrl') || 'http://127.0.0.1:8000';
    ['apiUrl','source','minUsd','minTrade','subAlloc','symBTC','symETH','symSOL'].forEach(id=>{
      els[id].addEventListener('change', ()=> localStorage.setItem(id, els[id].value));
      const saved = localStorage.getItem(id);
      if (saved) els[id].value = saved;
    });
    initTargets();
    checkHttpsWarning();
  })();
</script>
</body>
</html>
