<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Rebalance ‚Äî Plan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b0f14; --panel:#121821; --muted:#9fb0c3; --text:#e6eef7; --acc:#2dd4bf; --err:#ff6b6b; --ok:#22c55e; }
    * { box-sizing: border-box; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    body { margin:0; background:var(--bg); color:var(--text); }
    .wrap { max-width:1100px; margin:24px auto; padding:0 16px; }
    h1 { font-size:22px; margin:0 0 12px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .card { background:var(--panel); border:1px solid #243041; border-radius:14px; padding:14px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    label { font-size:13px; color:var(--muted); }
    input[type="text"], input[type="number"], select, textarea {
      width:100%; background:#0c121a; color:var(--text); border:1px solid #2a3647; border-radius:10px; padding:10px 12px; outline:none;
    }
    textarea { min-height:64px; resize:vertical; }
    .btn {
      background:var(--acc); border:0; color:#07211e; font-weight:700; padding:10px 14px; border-radius:10px; cursor:pointer;
    }
    .btn.secondary { background:#223044; color:var(--text); }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .muted { color:var(--muted); font-size:13px; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { border-bottom:1px solid #223044; padding:8px; text-align:left; }
    th { color:#b5c3d5; font-weight:600; }
    .ok { color:var(--ok); }
    .err { color:var(--err); }
    details { background:#0c121a; border:1px solid #223044; border-radius:10px; padding:10px 12px; }
    summary { cursor:pointer; color:#b5c3d5; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#1a2432; color:#bcd; margin:2px; font-size:12px; border:1px solid #2a3647; }
    .section-title { font-weight:700; margin:0 0 4px; }
    .inline { display:inline-flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .w-120 { width:120px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üßÆ Rebalancing ‚Äî G√©n√©rateur de plan</h1>

    <!-- Param√®tres -->
    <div class="card">
      <div class="grid">
        <div class="card" style="padding:12px;">
          <div class="section-title">Source & Filtres</div>
          <div class="row">
            <div style="flex:1">
              <label for="source">Source</label>
              <!-- ‚ö†Ô∏è par d√©faut on force l‚ÄôAPI -->
              <input id="source" type="text" value="cointracking_api" />
            </div>
            <div style="flex:1">
              <label for="api_base">API URL</label>
              <input id="api_base" type="text" value="http://127.0.0.1:8000" />
              <div class="muted"></div>
            </div>
            <div style="width:180px">
              <label for="min_usd">Min USD (d√©sagr√©g.)</label>
              <input id="min_usd" type="number" step="1" value="1" />
            </div>
            <div style="width:180px">
              <label for="min_trade">Min trade USD</label>
              <input id="min_trade" type="number" step="1" value="25" />
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="section-title">Sous-allocation (r√©partition interne BTC/ETH/SOL)</div>
          <div class="inline">
            <label class="inline"><input type="radio" name="suballoc" value="proportional" checked> Proportionnelle</label>
            <label class="inline"><input type="radio" name="suballoc" value="equal"> √âgalitaire</label>
          </div>

          <div style="height:10px"></div>

          <div class="section-title">Primary symbols</div>
          <div class="grid">
            <div>
              <label>BTC (CSV)</label>
              <input id="btc_syms" type="text" value="BTC,TBTC,WBTC" />
            </div>
            <div>
              <label>ETH (CSV)</label>
              <input id="eth_syms" type="text" value="ETH,WSTETH,STETH,RETH,WETH" />
            </div>
            <div>
              <label>SOL (CSV)</label>
              <input id="sol_syms" type="text" value="SOL,JUPSOL,JITOSOL" />
            </div>
          </div>
        </div>

        <div class="card" style="padding:12px;">
          <div class="section-title">Cibles par groupe (%)</div>
          <div class="grid">
            <div><label>BTC</label><input id="pct_btc" type="number" step="0.1" value="35" /></div>
            <div><label>ETH</label><input id="pct_eth" type="number" step="0.1" value="25" /></div>
            <div><label>Stablecoins</label><input id="pct_stables" type="number" step="0.1" value="10" /></div>
            <div><label>SOL</label><input id="pct_sol" type="number" step="0.1" value="10" /></div>
            <div><label>L1/L0 majors</label><input id="pct_l1" type="number" step="0.1" value="10" /></div>
            <div><label>Others</label><input id="pct_others" type="number" step="0.1" value="10" /></div>
          </div>

          <div style="height:8px"></div>
          <div class="muted">La somme doit faire 100.
            <span id="srcBadge" class="pill" style="margin-left:6px;">source: ?</span>
          </div>

          <div style="height:12px"></div>
          <div class="inline">
            <button id="btnRun" class="btn">G√©n√©rer le plan</button>
            <button id="btnCsv" class="btn secondary" disabled>T√©l√©charger CSV</button>
            <span id="status" class="muted">Pr√™t.</span>
          </div>
        </div>
      </div>
    </div>

    <!-- R√©sum√© -->
    <div class="grid" style="margin-top:16px;">
      <div class="card">
        <div class="section-title">Cible par groupe</div>
        <div id="targets"></div>
      </div>
      <div class="card">
        <div class="section-title">Deltas par groupe (USD)</div>
        <div id="deltas"></div>
      </div>
    </div>

    <!-- Tops -->
    <div class="grid" style="margin-top:16px;">
      <div class="card">
        <div class="section-title">Top achats</div>
        <table id="topBuys">
          <thead><tr><th>group</th><th>alias</th><th>symbol</th><th>usd</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card">
        <div class="section-title">Top ventes</div>
        <table id="topSells">
          <thead><tr><th>group</th><th>alias</th><th>symbol</th><th>usd</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <h3>R√©sum√© par lieu d‚Äôex√©cution</h3>
    <table id="tblLocations" class="mini">
      <thead>
        <tr>
          <th>Location</th>
          <th>Buys (USD)</th>
          <th>Ventes (USD)</th>
          <th>Net (USD)</th>
          <th>#Buys</th>
          <th>#Ventes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Contr√¥le & Debug -->
    <div class="grid" style="margin-top:16px;">
      <div class="card">
        <div class="section-title">Contr√¥le</div>
        <div id="control" class="muted">Aucun calcul pour le moment.</div>
      </div>
      <div class="card">
        <div class="section-title">Unknown aliases</div>
        <div id="unknowns"></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <details>
        <summary>JSON brut (debug)</summary>
        <pre id="raw" style="white-space:pre-wrap; font-size:12px;"></pre>
      </details>
    </div>
  </div>

  <script>
    const el = id => document.getElementById(id);
    const prettyUsd = n => (typeof n === "number" ? n : parseFloat(n || 0)).toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    function joinBase(base, path) {
      if (!base) return path;                 // m√™me origine
      return base.replace(/\/+$/,'') + path;  // nettoie le slash de fin
    }
    
    function buildTargets() {
      return {
        BTC: parseFloat(el('pct_btc').value || '0'),
        ETH: parseFloat(el('pct_eth').value || '0'),
        "Stablecoins": parseFloat(el('pct_stables').value || '0'),
        SOL: parseFloat(el('pct_sol').value || '0'),
        "L1/L0 majors": parseFloat(el('pct_l1').value || '0'),
        Others: parseFloat(el('pct_others').value || '0')
      };
    }

    function sum(obj) { return Object.values(obj).reduce((a,b)=>a+(+b||0),0); }

    function buildPrimarySymbols() {
      const parseCsv = s => (s||"")
        .split(",")
        .map(x => x.trim().toUpperCase())
        .filter(Boolean);
      return {
        BTC: parseCsv(el('btc_syms').value),
        ETH: parseCsv(el('eth_syms').value),
        SOL: parseCsv(el('sol_syms').value),
      };
    }

    function renderPairsList(obj, containerId) {
      const cont = el(containerId); cont.innerHTML = "";
      const tbl = document.createElement("table");
      tbl.innerHTML = "<thead><tr><th>Groupe</th><th>Valeur</th></tr></thead>";
      const tb = document.createElement("tbody");
      Object.entries(obj||{}).forEach(([k,v])=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${k}</td><td>${prettyUsd(v)}</td>`;
        tb.appendChild(tr);
      });
      tbl.appendChild(tb); cont.appendChild(tbl);
    }

    function renderTop(actions, isBuy, tableId) {
      const rows = actions.filter(a => isBuy ? a.usd > 0 : a.usd < 0);
      rows.sort((a,b)=> Math.abs(b.usd) - Math.abs(a.usd));
      const top = rows.slice(0, 12);
      const tb = document.querySelector(`#${tableId} tbody`);
      tb.innerHTML = "";
      top.forEach(a => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${a.group||""}</td><td>${a.alias||""}</td><td>${a.symbol||""}</td><td>${prettyUsd(a.usd)}</td>`;
        tb.appendChild(tr);
      });
    }

    function getGroupsFromTargets(){
      return ["BTC", "ETH", "Stablecoins", "SOL", "L1/L0 majors", "Others"];
    }

    async function saveAliasMapping(alias, group){
      const apiBase = (document.getElementById('api_base').value || '').trim();
      const url = joinBase(apiBase, '/taxonomy/aliases');

      // 1) format A (cl√©->groupe)
      try {
        await fetch(url, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ [alias]: group })
        });
        const tax = await fetch(joinBase(apiBase, '/taxonomy')).then(r=>r.json());
        if (tax && tax.aliases && Object.prototype.hasOwnProperty.call(tax.aliases, alias)) return true;
      } catch (_) {}

      // 2) format B (wrapper)
      const respB = await fetch(url, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ aliases: { [alias]: group } })
      });
      if (!respB.ok){
        const txtB = await respB.text();
        throw new Error(`[${respB.status}] ${txtB || 'Erreur API lors du mapping alias (format B)'}`);
      }

      const tax2 = await fetch(joinBase(apiBase, '/taxonomy')).then(r=>r.json()).catch(()=>null);
      if (tax2 && tax2.aliases && Object.prototype.hasOwnProperty.call(tax2.aliases, alias)) return true;
      throw new Error("Le mapping n'appara√Æt pas dans /taxonomy apr√®s √©criture.");
    }

    function renderUnknowns(list) {
      const box = document.getElementById('unknowns');
      box.innerHTML = "";
      if (!list || !list.length) { box.innerHTML = "<span class='muted'>Aucun.</span>"; return; }

      const tbl = document.createElement('table');
      tbl.innerHTML = "<thead><tr><th>Alias</th><th>Groupe</th><th></th></tr></thead>";
      const tb = document.createElement('tbody');

      const groups = ["BTC","ETH","Stablecoins","SOL","L1/L0 majors","Others"];

      list.slice().sort().forEach(alias => {
        const tr = document.createElement('tr');

        const tdA = document.createElement('td'); tdA.textContent = alias; tr.appendChild(tdA);

        const tdG = document.createElement('td');
        const sel = document.createElement('select');
        groups.forEach(g => {
          const opt = document.createElement('option');
          opt.value = g; opt.textContent = g;
          if (g === "Others") opt.selected = true;
          sel.appendChild(opt);
        });
        tdG.appendChild(sel);
        tr.appendChild(tdG);

        const tdBtn = document.createElement('td');
        const btn = document.createElement('button');
        btn.className = 'btn secondary';
        btn.textContent = 'Ajouter';
        btn.addEventListener('click', async () => {
          try{
            btn.disabled = true;
            await saveAliasMapping(alias, sel.value);
            tdBtn.innerHTML = "<span class='ok'>OK</span>";
            await runPlan(false);
          }catch(e){
            btn.disabled = false;
            alert(e?.message || 'Erreur mapping alias');
          }
        });
        tdBtn.appendChild(btn);
        tr.appendChild(tdBtn);

        tb.appendChild(tr);
      });

      // Bouton "Tout ajouter ‚Üí Others"
      const trAll = document.createElement('tr');
      const tdAll = document.createElement('td'); tdAll.colSpan = 3;
      const btnAll = document.createElement('button');
      btnAll.className = 'btn secondary';
      btnAll.textContent = 'Tout ajouter ‚Üí Others';
      btnAll.addEventListener('click', async ()=>{
        btnAll.disabled = true;
        try{
          for(const alias of list){ await saveAliasMapping(alias, 'Others'); }
          await runPlan(false);
        }catch(e){
          btnAll.disabled = false;
          alert(e?.message || 'Erreur mapping (batch)');
        }
      });
      tdAll.appendChild(btnAll);
      trAll.appendChild(tdAll);
      tb.appendChild(trAll);

      tbl.appendChild(tb);
      box.appendChild(tbl);
    }

    function renderControl(actions) {
      let buys = 0, sells = 0;
      for (const a of (actions||[])) {
        if (a.usd > 0) buys += a.usd; else sells += a.usd;
      }
      const net = buys + sells; // sells est n√©gatif
      el('control').innerHTML = `
        Total achats USD : <b>${prettyUsd(buys)}</b><br/>
        Total ventes USD : <b>${prettyUsd(sells)}</b><br/>
        Net (doit ‚âà 0) : <b class="${Math.abs(net) < 1 ? 'ok':'err'}">${prettyUsd(net)}</b>
      `;
    }

    async function runPlan(downloadCsv=false) {
      el('status').textContent = "Calcul en cours‚Ä¶";
      el('btnRun').disabled = true; el('btnCsv').disabled = true;

      try {
        const source = el('source').value.trim() || "cointracking";
        const min_usd = (el('min_usd').value || "1").trim();
        const min_trade_usd = parseFloat(el('min_trade').value || '25');

        let sub_allocation = [...document.querySelectorAll('input[name="suballoc"]')]
          .find(r=>r.checked)?.value || "proportional";

        const targets = buildTargets();
        const s = Object.values(targets).reduce((a,b)=>a+(+b||0),0);
        if (Math.abs(s - 100) > 0.0001) {
          alert("La somme des cibles doit √™tre 100. Actuellement: " + s);
          el('status').textContent = "Erreur ‚Äî somme ‚â† 100.";
          return;
        }

        const primary_symbols = buildPrimarySymbols();
        const hasPrimary = Object.values(primary_symbols).some(arr => arr && arr.length);
        if (hasPrimary) sub_allocation = "primary_first";

        const payload = {
          group_targets_pct: targets,
          sub_allocation,
          min_trade_usd,
          primary_symbols
        };

        const apiBase = (el('api_base').value || '').trim();
        const qs = new URLSearchParams({ source, min_usd }).toString();
        const url = joinBase(apiBase, `/rebalance/plan?${qs}`);
        const csvUrl = joinBase(apiBase, `/rebalance/plan.csv?${qs}`);

        if (downloadCsv) {
          // On g√©n√®re d‚Äôabord pour rafra√Æchir l‚ÄôUI‚Ä¶
          const resp = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const plan = await resp.json();

          // ‚Ä¶puis on t√©l√©charge le CSV depuis le m√™me endpoint/base
          const csvResp = await fetch(csvUrl, {
            method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
          });
          if (!csvResp.ok) throw new Error(`CSV HTTP ${csvResp.status}`);
          const blob = await csvResp.blob();
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'rebalance-actions.csv';
          document.body.appendChild(a); a.click(); a.remove();
          URL.revokeObjectURL(a.href);

          renderPairsList(plan.target_weights_pct || {}, 'targets');
          renderPairsList(plan.deltas_by_group_usd || {}, 'deltas');
          renderTop(plan.actions||[], true, 'topBuys');
          renderTop(plan.actions||[], false, 'topSells');
          renderUnknowns(plan.unknown_aliases||[]);
          renderControl(plan.actions||[]);
          el('raw').textContent = JSON.stringify(plan, null, 2);

          el('status').textContent = "CSV t√©l√©charg√©.";
          return;
        }

        // JSON normal
        const resp = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        document.getElementById('srcBadge').textContent =
          'source: ' + (data?.meta?.source_used || (el('source').value || '?'));

        renderPairsList(data.target_weights_pct || {}, 'targets');
        renderPairsList(data.deltas_by_group_usd || {}, 'deltas');
        renderTop(data.actions||[], true, 'topBuys');
        renderTop(data.actions||[], false, 'topSells');
        renderUnknowns(data.unknown_aliases||[]);
        renderControl(data.actions||[]);
        el('raw').textContent = JSON.stringify(data, null, 2);

        el('status').textContent = "OK.";
        el('btnCsv').disabled = false;
      } catch (e) {
        console.error(e);
        el('status').textContent = "Erreur ‚Äî voir console.";
        alert("Erreur: " + (e?.message || e));
      } finally {
        el('btnRun').disabled = false;
      }
    }

    // Uniques handlers
    el('btnRun').addEventListener('click', ()=>runPlan(false));
    el('btnCsv').addEventListener('click', ()=>runPlan(true));
  </script>
</body>
</html>
