<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Rebalance ‚Äî Plan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b0f14; --panel:#121821; --muted:#9fb0c3; --text:#e6eef7; --acc:#2dd4bf; --err:#ff6b6b; --ok:#22c55e; }
    * { box-sizing: border-box; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    body { margin:0; background:var(--bg); color:var(--text); }
    .wrap { max-width:1100px; margin:24px auto; padding:0 16px; }
    h1 { font-size:22px; margin:0 0 12px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .card { background:var(--panel); border:1px solid #243041; border-radius:14px; padding:14px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    label { font-size:13px; color:var(--muted); }
    input[type="text"], input[type="number"], select, textarea {
      width:100%; background:#0c121a; color:var(--text); border:1px solid #2a3647; border-radius:10px; padding:10px 12px; outline:none;
    }
    textarea { min-height:64px; resize:vertical; }
    .btn {
      background:var(--acc); border:0; color:#07211e; font-weight:700; padding:10px 14px; border-radius:10px; cursor:pointer;
    }
    .btn.secondary { background:#223044; color:var(--text); }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .muted { color:var(--muted); font-size:13px; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { border-bottom:1px solid #223044; padding:8px; text-align:left; }
    th { color:#b5c3d5; font-weight:600; }
    .ok { color:var(--ok); }
    .err { color:var(--err); }
    details { background:#0c121a; border:1px solid #223044; border-radius:10px; padding:10px 12px; }
    summary { cursor:pointer; color:#b5c3d5; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#1a2432; color:#bcd; margin:2px; font-size:12px; border:1px solid #2a3647; }
    .section-title { font-weight:700; margin:0 0 4px; }
    .inline { display:inline-flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .w-120 { width:120px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üßÆ Rebalancing ‚Äî G√©n√©rateur de plan</h1>

    <!-- Param√®tres -->
    <div class="card">
      <div class="grid">
        <div class="card" style="padding:12px;">
          <div class="section-title">Source & Filtres</div>
          <div class="row">
            <div style="flex:1">
              <label for="source">Source</label>
              <input id="source" type="text" value="cointracking" />
            </div>
            <div style="flex:1">
              <label for="api_base">API URL</label>
              <input id="api_base" type="text" value="http://127.0.0.1:8000" />
              <div class="muted"></div>
            </div>
            <div style="width:180px">
              <label for="min_usd">Min USD (d√©sagr√©g.)</label>
              <input id="min_usd" type="number" step="1" value="1" />
            </div>
            <div style="width:180px">
              <label for="min_trade">Min trade USD</label>
              <input id="min_trade" type="number" step="1" value="25" />
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="section-title">Sous-allocation (r√©partition interne BTC/ETH/SOL)</div>
          <div class="inline">
            <label class="inline"><input type="radio" name="suballoc" value="proportional" checked> Proportionnelle</label>
            <label class="inline"><input type="radio" name="suballoc" value="equal"> √âgalitaire</label>
          </div>

          <div style="height:10px"></div>

          <div class="section-title">Primary symbols</div>
          <div class="grid">
            <div>
              <label>BTC (CSV)</label>
              <input id="btc_syms" type="text" value="BTC,TBTC,WBTC" />
            </div>
            <div>
              <label>ETH (CSV)</label>
              <input id="eth_syms" type="text" value="ETH,WSTETH,STETH,RETH,WETH" />
            </div>
            <div>
              <label>SOL (CSV)</label>
              <input id="sol_syms" type="text" value="SOL,JUPSOL,JITOSOL" />
            </div>
          </div>
        </div>

        <div class="card" style="padding:12px;">
          <div class="section-title">Cibles par groupe (%)</div>
          <div class="grid">
            <div><label>BTC</label><input id="pct_btc" type="number" step="0.1" value="35" /></div>
            <div><label>ETH</label><input id="pct_eth" type="number" step="0.1" value="25" /></div>
            <div><label>Stablecoins</label><input id="pct_stables" type="number" step="0.1" value="10" /></div>
            <div><label>SOL</label><input id="pct_sol" type="number" step="0.1" value="10" /></div>
            <div><label>L1/L0 majors</label><input id="pct_l1" type="number" step="0.1" value="10" /></div>
            <div><label>Others</label><input id="pct_others" type="number" step="0.1" value="10" /></div>
          </div>

          <div style="height:8px"></div>
          <div class="muted">La somme doit faire 100.</div>

          <div style="height:12px"></div>
          <div class="inline">
            <button id="btnRun" class="btn">G√©n√©rer le plan</button>
            <button id="btnCsv" class="btn secondary" disabled>T√©l√©charger CSV</button>
            <span id="status" class="muted">Pr√™t.</span>
          </div>
        </div>
      </div>
    </div>

    <!-- R√©sum√© -->
    <div class="grid" style="margin-top:16px;">
      <div class="card">
        <div class="section-title">Cible par groupe</div>
        <div id="targets"></div>
      </div>
      <div class="card">
        <div class="section-title">Deltas par groupe (USD)</div>
        <div id="deltas"></div>
      </div>
    </div>

    <!-- Tops -->
    <div class="grid" style="margin-top:16px;">
      <div class="card">
        <div class="section-title">Top achats</div>
        <table id="topBuys">
          <thead><tr><th>group</th><th>alias</th><th>symbol</th><th>usd</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card">
        <div class="section-title">Top ventes</div>
        <table id="topSells">
          <thead><tr><th>group</th><th>alias</th><th>symbol</th><th>usd</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <h3>R√©sum√© par lieu d‚Äôex√©cution</h3>
    <table id="tblLocations" class="mini">
      <thead>
        <tr>
          <th>Location</th>
          <th>Buys (USD)</th>
          <th>Ventes (USD)</th>
          <th>Net (USD)</th>
          <th>#Buys</th>
          <th>#Ventes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Contr√¥le & Debug -->
    <div class="grid" style="margin-top:16px;">
      <div class="card">
        <div class="section-title">Contr√¥le</div>
        <div id="control" class="muted">Aucun calcul pour le moment.</div>
      </div>
      <div class="card">
        <div class="section-title">Unknown aliases</div>
        <div id="unknowns"></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <details>
        <summary>JSON brut (debug)</summary>
        <pre id="raw" style="white-space:pre-wrap; font-size:12px;"></pre>
      </details>
    </div>
  </div>

  <script>
    const el = id => document.getElementById(id);
    const prettyUsd = n => (typeof n === "number" ? n : parseFloat(n || 0)).toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    function joinBase(base, path) {
      if (!base) return path;                 // m√™me origine
      return base.replace(/\/+$/,'') + path;  // nettoie le slash de fin
    }
    
    function buildTargets() {
      return {
        BTC: parseFloat(el('pct_btc').value || '0'),
        ETH: parseFloat(el('pct_eth').value || '0'),
        "Stablecoins": parseFloat(el('pct_stables').value || '0'),
        SOL: parseFloat(el('pct_sol').value || '0'),
        "L1/L0 majors": parseFloat(el('pct_l1').value || '0'),
        Others: parseFloat(el('pct_others').value || '0')
      };
    }

    function sum(obj) { return Object.values(obj).reduce((a,b)=>a+(+b||0),0); }

    function buildPrimarySymbols() {
      const parseCsv = s => (s||"")
        .split(",")
        .map(x => x.trim().toUpperCase())
        .filter(Boolean);
      return {
        BTC: parseCsv(el('btc_syms').value),
        ETH: parseCsv(el('eth_syms').value),
        SOL: parseCsv(el('sol_syms').value),
      };
}

    function renderPairsList(obj, containerId) {
      const cont = el(containerId); cont.innerHTML = "";
      const tbl = document.createElement("table");
      tbl.innerHTML = "<thead><tr><th>Groupe</th><th>Valeur</th></tr></thead>";
      const tb = document.createElement("tbody");
      Object.entries(obj||{}).forEach(([k,v])=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${k}</td><td>${prettyUsd(v)}</td>`;
        tb.appendChild(tr);
      });
      tbl.appendChild(tb); cont.appendChild(tbl);
    }

    function renderTop(actions, isBuy, tableId) {
      const rows = actions.filter(a => isBuy ? a.usd > 0 : a.usd < 0);
      rows.sort((a,b)=> Math.abs(b.usd) - Math.abs(a.usd));
      const top = rows.slice(0, 12);
      const tb = document.querySelector(`#${tableId} tbody`);
      tb.innerHTML = "";
      top.forEach(a => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${a.group||""}</td><td>${a.alias||""}</td><td>${a.symbol||""}</td><td>${prettyUsd(a.usd)}</td>`;
        tb.appendChild(tr);
      });
    }

    function renderUnknowns(list) {
      const box = el('unknowns'); box.innerHTML = "";
      if (!list || !list.length) { box.innerHTML = "<span class='muted'>Aucun.</span>"; return; }
      list.forEach(x => { const p = document.createElement('span'); p.className="pill"; p.textContent = x; box.appendChild(p); });
    }

    function renderControl(actions) {
      let buys = 0, sells = 0;
      for (const a of (actions||[])) {
        if (a.usd > 0) buys += a.usd; else sells += a.usd;
      }
      const net = buys + sells; // sells est n√©gatif
      el('control').innerHTML = `
        Total achats USD : <b>${prettyUsd(buys)}</b><br/>
        Total ventes USD : <b>${prettyUsd(sells)}</b><br/>
        Net (doit ‚âà 0) : <b class="${Math.abs(net) < 1 ? 'ok':'err'}">${prettyUsd(net)}</b>
      `;
    }

    async function runPlan(downloadCsv=false) {
      el('status').textContent = "Calcul en cours‚Ä¶";
      el('btnRun').disabled = true; el('btnCsv').disabled = true;

      try {
        const source = el('source').value.trim() || "cointracking";
        const min_usd = (el('min_usd').value || "1").trim();
        const min_trade_usd = parseFloat(el('min_trade').value || '25');

        // radio par d√©faut‚Ä¶
        let sub_allocation = [...document.querySelectorAll('input[name="suballoc"]')]
          .find(r=>r.checked)?.value || "proportional";

        const targets = buildTargets();
        const s = Object.values(targets).reduce((a,b)=>a+(+b||0),0);
        if (Math.abs(s - 100) > 0.0001) {
          alert("La somme des cibles doit √™tre 100. Actuellement: " + s);
          el('status').textContent = "Erreur ‚Äî somme ‚â† 100.";
          return;
        }

        const primary_symbols = buildPrimarySymbols();
        const hasPrimary = Object.values(primary_symbols).some(arr => arr && arr.length);
        if (hasPrimary) sub_allocation = "primary_first"; // <<< cl√©

        const payload = {
          group_targets_pct: targets,
          sub_allocation,
          min_trade_usd,
          primary_symbols
        };

        const apiBase = (el('api_base').value || '').trim();
        const url = joinBase(apiBase, `/rebalance/plan?source=${encodeURIComponent(source)}&min_usd=${encodeURIComponent(min_usd)}`);
        const csvUrl = joinBase(apiBase, `/rebalance/plan.csv?source=${encodeURIComponent(source)}&min_usd=${encodeURIComponent(min_usd)}`);

        if (downloadCsv) {
          const resp = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const plan = await resp.json();

          // üëâ utiliser csvUrl (et pas un chemin absolu fixe)
          const csvResp = await fetch(csvUrl, {
            method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
          });
          if (!csvResp.ok) throw new Error(`CSV HTTP ${csvResp.status}`);
          const blob = await csvResp.blob();
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'rebalance-actions.csv';
          document.body.appendChild(a); a.click(); a.remove();
          URL.revokeObjectURL(a.href);

          // rendu r√©sum√©
          renderPairsList(plan.target_weights_pct || {}, 'targets');
          renderPairsList(plan.deltas_by_group_usd || {}, 'deltas');
          renderTop(plan.actions||[], true, 'topBuys');
          renderTop(plan.actions||[], false, 'topSells');
          renderUnknowns(plan.unknown_aliases||[]);
          renderControl(plan.actions||[]);
          el('raw').textContent = JSON.stringify(plan, null, 2);

          el('status').textContent = "CSV t√©l√©charg√©.";
          return;
        }

        // JSON normal
        const resp = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();

        renderPairsList(data.target_weights_pct || {}, 'targets');
        renderPairsList(data.deltas_by_group_usd || {}, 'deltas');
        renderTop(data.actions||[], true, 'topBuys');
        renderTop(data.actions||[], false, 'topSells');
        renderUnknowns(data.unknown_aliases||[]);
        renderControl(data.actions||[]);
        el('raw').textContent = JSON.stringify(data, null, 2);

        el('status').textContent = "OK.";
        el('btnCsv').disabled = false;
      } catch (e) {
        console.error(e);
        el('status').textContent = "Erreur ‚Äî voir console.";
        alert("Erreur: " + (e?.message || e));
      } finally {
        el('btnRun').disabled = false;
      }
    }

    el('btnRun').addEventListener('click', ()=>runPlan(false));
    el('btnCsv').addEventListener('click', ()=>runPlan(true));

  function parsePrimaryCSV(raw) {
    // Format attendu (insensible aux espaces) :
    // BTC: BTC, TBTC, WBTC
    // ETH: ETH, WSTETH, RETH
    // SOL: SOL, JUPSOL, JITOSOL
    const map = {};
    if (!raw) return map;

    // coupe par lignes
    const lines = raw.split(/\r?\n/);
    for (const line of lines) {
      if (!line.trim()) continue;
      const parts = line.split(':');
      if (parts.length < 2) continue;

      const alias = parts[0].trim(); // ex. "BTC", "ETH", "SOL"
      const symbolsStr = parts.slice(1).join(':'); // tout ce qui suit
      const symbols = symbolsStr
        .split(/[,\s]+/)          // s√©pare par virgule ET/OU espaces
        .map(s => s.trim().toUpperCase())
        .filter(Boolean);

      if (alias && symbols.length) {
        map[alias.toUpperCase()] = symbols;
      }
    }
    return map;
  }

  // utilitaire simple pour mettre √† jour le statut
  function setStatus(msg, isError=false){
    const el = document.getElementById('statusText');
    if (!el) return;
    el.textContent = msg;
    el.style.color = isError ? '#b00020' : '#2e7d32';
  }

  async function buildPayloadFromForm() {
    // => adapte si tes IDs diff√®rent; logique identique √† ton bouton "Calculer"
    // Exemples :
    // - lecture des poids par groupe
    // - sub_allocation
    // - min_trade_usd
    // - primary_symbols (BTC/ETH/SOL)
    // Retourne un objet { group_targets_pct, sub_allocation, min_trade_usd, primary_symbols }
    // -------------------------
    // Ici, je montre le squelette ; remplace par ta lecture r√©elle des champs :
    const group_targets_pct = {
      BTC: parseFloat(document.getElementById('w_btc').value || '0'),
      ETH: parseFloat(document.getElementById('w_eth').value || '0'),
      'L1/L0 majors': parseFloat(document.getElementById('w_l1').value || '0'),
      Others: parseFloat(document.getElementById('w_others').value || '0'),
      SOL: parseFloat(document.getElementById('w_sol').value || '0'),
      Stablecoins: parseFloat(document.getElementById('w_stable').value || '0'),
    };

    const sub_allocation = (document.querySelector('input[name="suballoc"]:checked')?.value) || 'proportional';
    const min_trade_usd = parseFloat(document.getElementById('min_trade').value || '25');

    // Primary symbols selon tes checkboxes / inputs
    const prim_btc = [];
    if (document.getElementById('p_btc').checked) prim_btc.push('BTC');
    if (document.getElementById('p_tbtc').checked) prim_btc.push('TBTC');
    if (document.getElementById('p_wbtc').checked) prim_btc.push('WBTC');

    const prim_eth = [];
    if (document.getElementById('p_eth').checked) prim_eth.push('ETH');
    if (document.getElementById('p_wsteth').checked) prim_eth.push('WSTETH');
    if (document.getElementById('p_steth').checked) prim_eth.push('STETH');
    if (document.getElementById('p_reth').checked) prim_eth.push('RETH');
    if (document.getElementById('p_weth').checked) prim_eth.push('WETH');

    const prim_sol = [];
    if (document.getElementById('p_sol').checked) prim_sol.push('SOL');
    if (document.getElementById('p_jupsol').checked) prim_sol.push('JUPSOL');
    if (document.getElementById('p_jitosol').checked) prim_sol.push('JITOSOL');

    const primary_symbols = {};
    if (prim_btc.length) primary_symbols['BTC'] = prim_btc;
    if (prim_eth.length) primary_symbols['ETH'] = prim_eth;
    if (prim_sol.length) primary_symbols['SOL'] = prim_sol;

    return { group_targets_pct, sub_allocation, min_trade_usd, primary_symbols };
  }

  // Bouton T√©l√©charger CSV
  document.getElementById('btnCsv')?.addEventListener('click', async () => {
    try {
      setStatus('Calcul en cours‚Ä¶', false);

      const payload = await buildPayloadFromForm();
      const minUsd = encodeURIComponent(document.getElementById('min_usd').value || '1');
      const source = encodeURIComponent((document.getElementById('source')?.value) || 'cointracking');

      const url = `http://127.0.0.1:8000/rebalance/plan.csv?source=${source}&min_usd=${minUsd}`;
      const resp = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (!resp.ok) {
        const txt = await resp.text();
        setStatus('Erreur calcul CSV', true);
        alert('Erreur API CSV:\n' + txt);
        return;
      }

      const blob = await resp.blob();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'rebalance-actions.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      setStatus('OK');
    } catch (e) {
      console.error(e);
      setStatus('Erreur r√©seau', true);
      alert('Erreur r√©seau: ' + (e?.message || e));
    }
  });

  // (Optionnel) dans ton bouton "Calculer", appelle setStatus('Calcul en cours‚Ä¶') au d√©but,
  // puis setStatus('OK') en succ√®s, setStatus('Erreur') en catch.
  </script>
</body>
</html>
