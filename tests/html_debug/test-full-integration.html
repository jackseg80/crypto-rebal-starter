<!DOCTYPE html>
<html lang="fr">
<head>
    <base href="/static/">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Test Full Integration - 30+ Indicators</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a202c;
            color: #e2e8f0;
            line-height: 1.6;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .card {
            background: #2d3748;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #4a5568;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            background: #3182ce;
            color: white;
            margin: 5px;
        }
        .btn:hover { background: #2c5282; }
        .log {
            background: #1a202c;
            padding: 15px;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .indicator-card {
            background: #1a202c;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #63b3ed;
        }
        .indicator-card.critical {
            border-left-color: #f56565;
            background: #2d1b1e;
        }
        .indicator-name {
            font-weight: bold;
            color: #63b3ed;
            margin-bottom: 8px;
        }
        .indicator-name.critical {
            color: #f56565;
        }
        .indicator-value {
            font-size: 18px;
            color: #48bb78;
            margin: 5px 0;
        }
        .indicator-meta {
            font-size: 12px;
            color: #a0aec0;
            margin-top: 8px;
        }
        .stats-summary {
            background: #1a202c;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .stats-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid #4a5568;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üß™ Test Full Integration - 30+ Real Indicators</h1>
            <p>Test de l'int√©gration compl√®te des indicateurs r√©els dans le dashboard</p>
            
            <div>
                <button class="btn" onclick="testFullIntegration()">üéØ Test Full Integration</button>
                <button class="btn" onclick="testBackendAPI()">üîß Test Backend Direct</button>
                <button class="btn" onclick="testDashboardFunction()">üìä Test Dashboard Function</button>
                <button class="btn" onclick="clearResults()">üßπ Clear</button>
            </div>
        </div>

        <div class="card">
            <h3>üìä Integration Summary</h3>
            <div class="stats-summary" id="stats-summary">
                No tests run yet...
            </div>
        </div>

        <div class="card">
            <h3>üéØ All Indicators Display</h3>
            <div class="indicators-grid" id="indicators-display">
                No indicators loaded yet...
            </div>
        </div>

        <div class="card">
            <h3>üìù Test Log</h3>
            <div class="log" id="test-log">
Full integration test ready...
</div>
        </div>
    </div>

    <script type="module">
        let logElement;
        let indicatorsDisplayElement;
        let statsSummaryElement;
        
        window.onload = function() {
            logElement = document.getElementById('test-log');
            indicatorsDisplayElement = document.getElementById('indicators-display');
            statsSummaryElement = document.getElementById('stats-summary');
            log('üß™ Full integration test ready', 'success');
        };
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            logElement.textContent += `[${timestamp}] ${icon} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        window.testFullIntegration = async function() {
            log('üéØ Testing full integration with dashboard function...', 'info');
            
            try {
                // Import the updated modules
                const { fetchAllIndicators, calculateCompositeScore } = 
                    await import('./modules/onchain-indicators.js');
                
                log('‚úÖ Modules imported successfully', 'success');
                
                // Test the updated fetchAllIndicators function
                log('üì° Calling updated fetchAllIndicators...', 'info');
                const indicators = await fetchAllIndicators();
                
                log(`üìä Indicators result type: ${typeof indicators}`, 'info');
                
                if (!indicators) {
                    log('‚ùå No indicators returned', 'error');
                    return;
                }
                
                // Count real indicators (exclude metadata)
                const indicatorKeys = Object.keys(indicators).filter(k => !k.startsWith('_'));
                log(`‚úÖ Total indicators loaded: ${indicatorKeys.length}`, 'success');
                
                // Display summary stats
                const metadata = indicators._metadata;
                if (metadata) {
                    log(`üìä Metadata: ${metadata.message}`, 'info');
                    log(`üìä Sources: ${JSON.stringify(metadata.source_stats)}`, 'info');
                }
                
                // Test the composite score calculation
                log('üßÆ Testing composite score calculation...', 'info');
                const composite = calculateCompositeScore(indicators);
                
                log(`‚úÖ Composite score: ${composite.score}/100`, 'success');
                log(`üìä Categories: ${composite.activeCategories}`, 'info');
                log(`üö® Critical zones: ${composite.criticalZoneCount}`, 'info');
                
                // Display all indicators
                displayAllIndicators(indicators, composite);
                
                // Update summary
                updateStatsSummary(indicators, composite);
                
                log('‚úÖ Full integration test completed successfully!', 'success');
                
            } catch (error) {
                log(`‚ùå Full integration test failed: ${error.message}`, 'error');
                console.error(error);
            }
        };
        
        window.testBackendAPI = async function() {
            log('üîß Testing backend API directly...', 'info');
            
            try {
                const response = await fetch('http://127.0.0.1:8001/api/crypto-toolbox');
                
                if (!response.ok) {
                    throw new Error(`Backend error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                log(`‚úÖ Backend API response: ${data.total_count} indicators`, 'success');
                log(`üö® Critical indicators: ${data.critical_count}`, 'info');
                
                if (data.indicators && data.indicators.length > 0) {
                    log('Sample indicators from backend:', 'info');
                    data.indicators.slice(0, 5).forEach(ind => {
                        log(`  ‚Ä¢ ${ind.name}: ${ind.value} ${ind.in_critical_zone ? 'üö®' : ''}`, 'info');
                    });
                }
                
            } catch (error) {
                log(`‚ùå Backend API test failed: ${error.message}`, 'error');
            }
        };
        
        window.testDashboardFunction = async function() {
            log('üìä Testing dashboard loadOnChainIndicators function...', 'info');
            
            try {
                // This would test the actual dashboard function
                // For now, let's test the module functions directly
                const { fetchCryptoToolboxIndicators } = await import('./modules/onchain-indicators.js');
                
                const rawData = await fetchCryptoToolboxIndicators();
                log(`üì° Raw backend data keys: ${Object.keys(rawData).length}`, 'info');
                
                Object.entries(rawData).forEach(([key, data]) => {
                    if (!key.startsWith('_') && data.name) {
                        log(`  ‚Ä¢ ${data.name}: ${data.value_numeric}%`, 'info');
                    }
                });
                
                log('‚úÖ Dashboard function compatibility test completed', 'success');
                
            } catch (error) {
                log(`‚ùå Dashboard function test failed: ${error.message}`, 'error');
            }
        };
        
        function displayAllIndicators(indicators, composite) {
            let html = '';
            
            Object.entries(indicators).forEach(([key, data]) => {
                if (key.startsWith('_') || !data || typeof data !== 'object') {
                    return;
                }
                
                const isCritical = data.in_critical_zone || false;
                const value = data.value_numeric || data.value || 0;
                
                html += `
                    <div class="indicator-card ${isCritical ? 'critical' : ''}">
                        <div class="indicator-name ${isCritical ? 'critical' : ''}">
                            ${isCritical ? 'üö® ' : ''}${data.name || key}
                        </div>
                        <div class="indicator-value">
                            ${typeof value === 'number' ? value.toFixed(1) + '%' : value}
                        </div>
                        <div class="indicator-meta">
                            Source: ${data.source || 'Unknown'}
                            ${data.raw_threshold ? `<br>Seuil: ${data.raw_threshold}` : ''}
                            ${data.scraped_at ? `<br>Scraped: ${new Date(data.scraped_at).toLocaleTimeString()}` : ''}
                        </div>
                        ${isCritical ? '<div style="color: #f56565; font-weight: bold; margin-top: 8px;">ZONE CRITIQUE</div>' : ''}
                    </div>
                `;
            });
            
            indicatorsDisplayElement.innerHTML = html || 'No indicators to display';
        }
        
        function updateStatsSummary(indicators, composite) {
            const indicatorCount = Object.keys(indicators).filter(k => !k.startsWith('_')).length;
            const criticalCount = composite.criticalZoneCount || 0;
            const metadata = indicators._metadata;
            
            let html = `
                <div class="stats-row">
                    <span>Total Indicators:</span>
                    <span style="color: #48bb78; font-weight: bold;">${indicatorCount}</span>
                </div>
                <div class="stats-row">
                    <span>Critical Zones:</span>
                    <span style="color: ${criticalCount > 0 ? '#f56565' : '#48bb78'}; font-weight: bold;">${criticalCount}</span>
                </div>
                <div class="stats-row">
                    <span>Composite Score:</span>
                    <span style="color: #63b3ed; font-weight: bold;">${composite.score || 'N/A'}/100</span>
                </div>
                <div class="stats-row">
                    <span>Active Categories:</span>
                    <span style="color: #f59e0b; font-weight: bold;">${composite.activeCategories || 0}</span>
                </div>
            `;
            
            if (metadata && metadata.source_stats) {
                html += '<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #4a5568;">';
                html += '<div style="font-weight: bold; margin-bottom: 8px;">Sources:</div>';
                Object.entries(metadata.source_stats).forEach(([source, count]) => {
                    html += `
                        <div class="stats-row">
                            <span>${source}:</span>
                            <span style="color: #a0aec0;">${count} indicators</span>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            statsSummaryElement.innerHTML = html;
        }
        
        window.clearResults = function() {
            logElement.textContent = 'Log cleared...\n';
            indicatorsDisplayElement.innerHTML = 'No indicators loaded yet...';
            statsSummaryElement.innerHTML = 'No tests run yet...';
        };
    </script>
</body>
</html>
