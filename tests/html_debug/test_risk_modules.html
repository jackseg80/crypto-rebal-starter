<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tests - Risk Dashboard Modules</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1b26;
            color: #c0caf5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #7aa2f7;
            margin-bottom: 20px;
            border-bottom: 2px solid #414868;
            padding-bottom: 10px;
        }

        h2 {
            color: #bb9af7;
            margin-top: 30px;
            margin-bottom: 15px;
            border-left: 4px solid #bb9af7;
            padding-left: 10px;
        }

        .test-suite {
            background: #24283b;
            border: 1px solid #414868;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .test-case {
            background: #1f2335;
            border-left: 3px solid #565f89;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .test-case.pass {
            border-left-color: #9ece6a;
        }

        .test-case.fail {
            border-left-color: #f7768e;
        }

        .test-case.skip {
            border-left-color: #e0af68;
        }

        .test-name {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-status {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .test-status.pass {
            background: #9ece6a;
            color: #1a1b26;
        }

        .test-status.fail {
            background: #f7768e;
            color: #1a1b26;
        }

        .test-status.skip {
            background: #e0af68;
            color: #1a1b26;
        }

        .test-detail {
            font-size: 14px;
            color: #a9b1d6;
            margin-top: 5px;
        }

        .test-error {
            background: #2a1820;
            border: 1px solid #f7768e;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #f7768e;
            white-space: pre-wrap;
        }

        .summary {
            background: #24283b;
            border: 2px solid #7aa2f7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .summary-item {
            text-align: center;
        }

        .summary-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .summary-value.pass {
            color: #9ece6a;
        }

        .summary-value.fail {
            color: #f7768e;
        }

        .summary-value.skip {
            color: #e0af68;
        }

        .summary-label {
            font-size: 14px;
            color: #565f89;
            text-transform: uppercase;
        }

        .run-button {
            background: #7aa2f7;
            color: #1a1b26;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .run-button:hover {
            background: #9ece6a;
            transform: translateY(-2px);
        }

        .run-button:disabled {
            background: #565f89;
            cursor: not-allowed;
            transform: none;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .log {
            background: #1f2335;
            border: 1px solid #414868;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-entry.info {
            color: #7aa2f7;
        }

        .log-entry.success {
            color: #9ece6a;
        }

        .log-entry.error {
            color: #f7768e;
        }

        .log-entry.warn {
            color: #e0af68;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Tests - Risk Dashboard Modules Refactoris√©s</h1>

        <div class="controls">
            <button class="run-button" id="runAllBtn">‚ñ∂Ô∏è Lancer Tous les Tests</button>
            <button class="run-button" id="clearBtn">üóëÔ∏è Effacer</button>
        </div>

        <div class="summary" id="summary">
            <div class="summary-item">
                <div class="summary-value pass" id="passCount">0</div>
                <div class="summary-label">Pass</div>
            </div>
            <div class="summary-item">
                <div class="summary-value fail" id="failCount">0</div>
                <div class="summary-label">Fail</div>
            </div>
            <div class="summary-item">
                <div class="summary-value skip" id="skipCount">0</div>
                <div class="summary-label">Skip</div>
            </div>
            <div class="summary-item">
                <div class="summary-value" id="totalCount">0</div>
                <div class="summary-label">Total</div>
            </div>
        </div>

        <div id="testResults"></div>

        <div class="log" id="logContainer"></div>
    </div>

    <script type="module">
        // ===================================================================
        // Mini Test Framework
        // ===================================================================

        class TestRunner {
            constructor() {
                this.results = [];
                this.currentSuite = null;
            }

            describe(name, fn) {
                this.currentSuite = { name, tests: [] };
                fn();
                return this.currentSuite;
            }

            test(name, fn) {
                if (!this.currentSuite) {
                    throw new Error('test() must be called inside describe()');
                }

                const testCase = {
                    name,
                    fn,
                    status: 'pending',
                    error: null,
                    duration: 0
                };

                this.currentSuite.tests.push(testCase);
            }

            async run() {
                this.results = [];
                const suites = document.querySelectorAll('.test-suite');

                for (const suite of suites) {
                    const suiteName = suite.dataset.suite;
                    const tests = Array.from(suite.querySelectorAll('.test-case'));

                    for (const testEl of tests) {
                        const testName = testEl.dataset.test;
                        const testFn = testEl._testFn;

                        const start = performance.now();
                        try {
                            await testFn();
                            const duration = performance.now() - start;

                            this.results.push({
                                suite: suiteName,
                                name: testName,
                                status: 'pass',
                                duration
                            });

                            testEl.classList.remove('fail', 'skip');
                            testEl.classList.add('pass');
                            testEl.querySelector('.test-status').textContent = 'PASS';
                            testEl.querySelector('.test-status').className = 'test-status pass';
                            testEl.querySelector('.test-detail').textContent = `‚úì Pass√© en ${duration.toFixed(2)}ms`;

                            this.log('success', `‚úì ${suiteName} > ${testName} (${duration.toFixed(2)}ms)`);

                        } catch (error) {
                            const duration = performance.now() - start;

                            this.results.push({
                                suite: suiteName,
                                name: testName,
                                status: 'fail',
                                error: error.message,
                                duration
                            });

                            testEl.classList.remove('pass', 'skip');
                            testEl.classList.add('fail');
                            testEl.querySelector('.test-status').textContent = 'FAIL';
                            testEl.querySelector('.test-status').className = 'test-status fail';
                            testEl.querySelector('.test-detail').textContent = `‚úó √âchou√© en ${duration.toFixed(2)}ms`;

                            // Afficher l'erreur
                            let errorDiv = testEl.querySelector('.test-error');
                            if (!errorDiv) {
                                errorDiv = document.createElement('div');
                                errorDiv.className = 'test-error';
                                testEl.appendChild(errorDiv);
                            }
                            errorDiv.textContent = error.stack || error.message;

                            this.log('error', `‚úó ${suiteName} > ${testName}: ${error.message}`);
                        }
                    }
                }

                this.updateSummary();
            }

            updateSummary() {
                const passCount = this.results.filter(r => r.status === 'pass').length;
                const failCount = this.results.filter(r => r.status === 'fail').length;
                const skipCount = this.results.filter(r => r.status === 'skip').length;
                const totalCount = this.results.length;

                document.getElementById('passCount').textContent = passCount;
                document.getElementById('failCount').textContent = failCount;
                document.getElementById('skipCount').textContent = skipCount;
                document.getElementById('totalCount').textContent = totalCount;
            }

            log(level, message) {
                const logContainer = document.getElementById('logContainer');
                const entry = document.createElement('div');
                entry.className = `log-entry ${level}`;
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logContainer.appendChild(entry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        // Helpers d'assertion
        const assert = {
            equal(actual, expected, message) {
                if (actual !== expected) {
                    throw new Error(message || `Expected ${expected}, got ${actual}`);
                }
            },
            notEqual(actual, expected, message) {
                if (actual === expected) {
                    throw new Error(message || `Expected not ${expected}`);
                }
            },
            ok(value, message) {
                if (!value) {
                    throw new Error(message || `Expected truthy value, got ${value}`);
                }
            },
            throws(fn, message) {
                try {
                    fn();
                    throw new Error(message || 'Expected function to throw');
                } catch (e) {
                    if (e.message === (message || 'Expected function to throw')) {
                        throw e;
                    }
                }
            },
            async resolves(promise, message) {
                try {
                    await promise;
                } catch (e) {
                    throw new Error(message || `Expected promise to resolve, got ${e.message}`);
                }
            },
            async rejects(promise, message) {
                try {
                    await promise;
                    throw new Error(message || 'Expected promise to reject');
                } catch (e) {
                    if (e.message === (message || 'Expected promise to reject')) {
                        throw e;
                    }
                }
            }
        };

        // ===================================================================
        // Tests Unitaires - risk-alerts-tab.js
        // ===================================================================

        function createTestSuite(suiteName, tests) {
            const resultsContainer = document.getElementById('testResults');

            const suiteDiv = document.createElement('div');
            suiteDiv.className = 'test-suite';
            suiteDiv.dataset.suite = suiteName;

            const title = document.createElement('h2');
            title.textContent = suiteName;
            suiteDiv.appendChild(title);

            tests.forEach(test => {
                const testDiv = document.createElement('div');
                testDiv.className = 'test-case';
                testDiv.dataset.test = test.name;
                testDiv._testFn = test.fn;

                const nameDiv = document.createElement('div');
                nameDiv.className = 'test-name';
                nameDiv.innerHTML = `
                    <span class="test-status">PENDING</span>
                    <span>${test.name}</span>
                `;

                const detailDiv = document.createElement('div');
                detailDiv.className = 'test-detail';
                detailDiv.textContent = '‚è≥ En attente...';

                testDiv.appendChild(nameDiv);
                testDiv.appendChild(detailDiv);
                suiteDiv.appendChild(testDiv);
            });

            resultsContainer.appendChild(suiteDiv);
        }

        // Suite 1: risk-alerts-tab.js
        createTestSuite('risk-alerts-tab.js', [
            {
                name: 'doit filtrer les alertes par severit√©',
                fn: async () => {
                    const mockAlerts = [
                        { id: '1', severity: 'S1', alert_type: 'VOL' },
                        { id: '2', severity: 'S2', alert_type: 'REGIME' },
                        { id: '3', severity: 'S3', alert_type: 'VOL' }
                    ];

                    const filtered = mockAlerts.filter(a => ['S2', 'S3'].includes(a.severity));
                    assert.equal(filtered.length, 2, 'Devrait filtrer 2 alertes');
                }
            },
            {
                name: 'doit paginer les alertes correctement',
                fn: async () => {
                    const mockAlerts = Array.from({ length: 25 }, (_, i) => ({ id: `${i}` }));

                    const page1 = mockAlerts.slice(0, 10);
                    const page2 = mockAlerts.slice(10, 20);
                    const page3 = mockAlerts.slice(20, 25);

                    assert.equal(page1.length, 10, 'Page 1 devrait avoir 10 items');
                    assert.equal(page2.length, 10, 'Page 2 devrait avoir 10 items');
                    assert.equal(page3.length, 5, 'Page 3 devrait avoir 5 items');
                }
            },
            {
                name: 'doit calculer les stats correctement',
                fn: async () => {
                    const mockAlerts = [
                        { severity: 'S1' },
                        { severity: 'S1' },
                        { severity: 'S2' },
                        { severity: 'S3' }
                    ];

                    const stats = mockAlerts.reduce((acc, alert) => {
                        acc[alert.severity] = (acc[alert.severity] || 0) + 1;
                        return acc;
                    }, {});

                    assert.equal(stats['S1'], 2, 'Devrait compter 2 alertes S1');
                    assert.equal(stats['S2'], 1, 'Devrait compter 1 alerte S2');
                    assert.equal(stats['S3'], 1, 'Devrait compter 1 alerte S3');
                }
            }
        ]);

        // Suite 2: risk-overview-tab.js
        createTestSuite('risk-overview-tab.js', [
            {
                name: 'doit valider Risk Score entre 0 et 100',
                fn: async () => {
                    const riskScore = 65;
                    assert.ok(riskScore >= 0 && riskScore <= 100, 'Risk Score doit √™tre entre 0 et 100');
                }
            },
            {
                name: 'doit d√©tecter dual window disponible',
                fn: async () => {
                    const mockDualWindow = {
                        enabled: true,
                        long_term: { available: true, window_days: 365, asset_count: 3 },
                        full_intersection: { window_days: 55, asset_count: 5 }
                    };

                    assert.ok(mockDualWindow.enabled, 'Dual window devrait √™tre activ√©');
                    assert.ok(mockDualWindow.long_term.available, 'Long-term devrait √™tre disponible');
                    assert.equal(mockDualWindow.long_term.window_days, 365, 'Devrait utiliser 365j');
                }
            },
            {
                name: 'doit calculer la divergence Risk Score V2',
                fn: async () => {
                    const legacyScore = 65;
                    const v2Score = 35;
                    const divergence = legacyScore - v2Score;

                    assert.equal(divergence, 30, 'Divergence devrait √™tre 30 points');
                    assert.ok(divergence > 10, 'Divergence significative d√©tect√©e');
                }
            }
        ]);

        // Suite 3: risk-cycles-tab.js
        createTestSuite('risk-cycles-tab.js', [
            {
                name: 'doit formater les donn√©es pour Chart.js',
                fn: async () => {
                    const mockData = {
                        dates: ['2024-01-01', '2024-01-02'],
                        prices: [50000, 51000]
                    };

                    assert.equal(mockData.dates.length, mockData.prices.length, 'Dates et prices doivent avoir m√™me longueur');
                    assert.ok(mockData.prices[1] > mockData.prices[0], 'Prix devrait augmenter');
                }
            },
            {
                name: 'doit calculer le composite score on-chain',
                fn: async () => {
                    const indicators = {
                        momentum: 0.75,
                        valuation: 0.60,
                        network: 0.80,
                        risk: 0.50
                    };

                    const weights = { momentum: 0.3, valuation: 0.2, network: 0.3, risk: 0.2 };
                    const composite = Object.keys(indicators).reduce((sum, key) => {
                        return sum + indicators[key] * weights[key];
                    }, 0);

                    assert.ok(composite >= 0 && composite <= 1, 'Composite score entre 0 et 1');
                }
            },
            {
                name: 'doit g√©rer le cache hash-based',
                fn: async () => {
                    const data1 = JSON.stringify({ prices: [50000, 51000] });
                    const data2 = JSON.stringify({ prices: [50000, 51000] });

                    // Simuler un hash simple
                    const hash1 = data1.length;
                    const hash2 = data2.length;

                    assert.equal(hash1, hash2, 'Donn√©es identiques devraient avoir m√™me hash');
                }
            }
        ]);

        // Suite 4: risk-targets-tab.js
        createTestSuite('risk-targets-tab.js', [
            {
                name: 'doit comparer allocation actuelle vs objectifs',
                fn: async () => {
                    const current = { BTC: 0.40, ETH: 0.30, Stables: 0.30 };
                    const target = { BTC: 0.50, ETH: 0.30, Stables: 0.20 };

                    const delta = {
                        BTC: target.BTC - current.BTC,
                        ETH: target.ETH - current.ETH,
                        Stables: target.Stables - current.Stables
                    };

                    assert.equal(delta.BTC, 0.10, 'BTC devrait augmenter de 10%');
                    assert.equal(delta.Stables, -0.10, 'Stables devraient diminuer de 10%');
                }
            },
            {
                name: 'doit g√©n√©rer plan d\'action (buy/sell)',
                fn: async () => {
                    const delta = { BTC: 0.10, ETH: 0, Stables: -0.10 };

                    const actions = Object.entries(delta).map(([asset, pct]) => {
                        if (pct > 0.01) return { action: 'BUY', asset, pct };
                        if (pct < -0.01) return { action: 'SELL', asset, pct: Math.abs(pct) };
                        return null;
                    }).filter(Boolean);

                    assert.equal(actions.length, 2, 'Devrait avoir 2 actions');
                    assert.equal(actions[0].action, 'BUY', 'Premi√®re action devrait √™tre BUY');
                    assert.equal(actions[1].action, 'SELL', 'Deuxi√®me action devrait √™tre SELL');
                }
            },
            {
                name: 'doit g√©rer les 5 strat√©gies disponibles',
                fn: async () => {
                    const strategies = ['macro', 'ccs', 'cycle', 'blend', 'smart'];
                    assert.equal(strategies.length, 5, 'Devrait avoir 5 strat√©gies');
                    assert.ok(strategies.includes('smart'), 'Devrait inclure SMART');
                }
            }
        ]);

        // Suite 5: Performance & Edge Cases
        createTestSuite('Performance & Edge Cases', [
            {
                name: 'doit g√©rer un grand nombre d\'alertes (1000+)',
                fn: async () => {
                    const largeAlerts = Array.from({ length: 1000 }, (_, i) => ({ id: `${i}` }));

                    const start = performance.now();
                    const filtered = largeAlerts.filter(a => parseInt(a.id) % 2 === 0);
                    const duration = performance.now() - start;

                    assert.ok(duration < 50, `Filtrage devrait √™tre rapide (${duration.toFixed(2)}ms < 50ms)`);
                    assert.equal(filtered.length, 500, 'Devrait filtrer 500 alertes');
                }
            },
            {
                name: 'doit g√©rer les donn√©es manquantes gracieusement',
                fn: async () => {
                    const incompleteData = { risk_score: 65 };

                    const riskScore = incompleteData.risk_score || 0;
                    const dualWindow = incompleteData.dual_window || null;

                    assert.equal(riskScore, 65, 'Risk Score devrait √™tre pr√©sent');
                    assert.equal(dualWindow, null, 'Dual window devrait √™tre null (pas d\'erreur)');
                }
            },
            {
                name: 'doit cacher les Chart.js correctement',
                fn: async () => {
                    const cache = new Map();
                    const chartKey = 'btc_365d';
                    const chartData = { labels: [], datasets: [] };

                    cache.set(chartKey, chartData);
                    assert.ok(cache.has(chartKey), 'Cache devrait contenir la cl√©');
                    assert.equal(cache.get(chartKey), chartData, 'Cache devrait retourner les bonnes donn√©es');
                }
            }
        ]);

        // ===================================================================
        // Initialisation
        // ===================================================================

        const runner = new TestRunner();

        document.getElementById('runAllBtn').addEventListener('click', async () => {
            const btn = document.getElementById('runAllBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Tests en cours...';

            runner.log('info', 'D√©marrage des tests...');

            await runner.run();

            runner.log('success', `Tests termin√©s: ${runner.results.filter(r => r.status === 'pass').length} pass√©s, ${runner.results.filter(r => r.status === 'fail').length} √©chou√©s`);

            btn.disabled = false;
            btn.textContent = '‚ñ∂Ô∏è Relancer les Tests';
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('logContainer').innerHTML = '';
            runner.results = [];
            runner.updateSummary();

            // Recr√©er les suites
            location.reload();
        });

        runner.log('info', 'Framework de tests charg√©. Cliquez sur "Lancer Tous les Tests" pour commencer.');
    </script>
</body>
</html>
