<!DOCTYPE html>
<html lang="fr">
<head>
    <base href="/static/">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Test Pond√©ration Dynamique Debug</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #1a1a1a; color: #e0e0e0; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #333; border-radius: 5px; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        .info { color: #60a5fa; }
        button { padding: 10px 20px; margin: 5px; background: #333; color: white; border: 1px solid #555; border-radius: 3px; cursor: pointer; }
        button:hover { background: #555; }
        pre { background: #2a2a2a; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .checkbox-container { margin: 10px 0; }
        .checkbox-container input { margin-right: 8px; }
    </style>
</head>
<body>
    <h1>üß™ Debug Pond√©ration Dynamique</h1>
    
    <div class="test-section">
        <h2>1. √âtat localStorage</h2>
        <div class="checkbox-container">
            <input type="checkbox" id="dynamic-weighting-test" onchange="updateLocalStorage()">
            <label for="dynamic-weighting-test">Activer pond√©ration dynamique (test)</label>
        </div>
        <pre id="localStorage-status">Loading...</pre>
    </div>

    <div class="test-section">
        <h2>2. Test Imports des Modules</h2>
        <button onclick="testImports()">Tester les imports</button>
        <pre id="imports-result">Cliquez sur le bouton pour tester</pre>
    </div>

    <div class="test-section">
        <h2>3. Test Fetch Indicateurs</h2>
        <button onclick="testFetchIndicators()">Tester fetch indicateurs</button>
        <pre id="fetch-result">Cliquez sur le bouton pour tester</pre>
    </div>

    <div class="test-section">
        <h2>4. Test Composite Score</h2>
        <button onclick="testCompositeScore()">Tester score composite</button>
        <pre id="composite-result">Cliquez sur le bouton pour tester</pre>
    </div>

    <div class="test-section">
        <h2>5. Test Pond√©ration Dynamique</h2>
        <button onclick="testDynamicWeighting()">Tester pond√©ration dynamique</button>
        <pre id="dynamic-result">Cliquez sur le bouton pour tester</pre>
    </div>

    <script type="module">
        // Import modules
        let fetchAllIndicators, calculateCompositeScoreV2;
        
        try {
            const indicatorsModule = await import('./modules/onchain-indicators.js');
            const compositeModule = await import('./modules/composite-score-v2.js');
            
            fetchAllIndicators = indicatorsModule.fetchAllIndicators;
            calculateCompositeScoreV2 = compositeModule.calculateCompositeScoreV2;
            
            console.log('‚úÖ Modules import√©s avec succ√®s');
            updateImportsStatus('‚úÖ Modules import√©s avec succ√®s');
        } catch (error) {
            console.error('‚ùå Erreur import modules:', error);
            updateImportsStatus(`‚ùå Erreur import: ${error.message}`);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateLocalStorageStatus();
        });

        // Functions
        window.updateLocalStorage = function() {
            const isChecked = document.getElementById('dynamic-weighting-test').checked;
            localStorage.setItem('enable_dynamic_weighting', isChecked.toString());
            updateLocalStorageStatus();
        };

        function updateLocalStorageStatus() {
            const status = localStorage.getItem('enable_dynamic_weighting');
            document.getElementById('localStorage-status').innerHTML = `
enable_dynamic_weighting: "${status}"
Type: ${typeof status}
Boolean cast: ${status === 'true'}
            `;
            
            // Sync checkbox
            const checkbox = document.getElementById('dynamic-weighting-test');
            if (checkbox) {
                checkbox.checked = status === 'true';
            }
        }

        function updateImportsStatus(message) {
            document.getElementById('imports-result').textContent = message;
        }

        window.testImports = function() {
            const result = {
                fetchAllIndicators: typeof fetchAllIndicators,
                calculateCompositeScoreV2: typeof calculateCompositeScoreV2
            };
            
            document.getElementById('imports-result').textContent = `
fetchAllIndicators: ${result.fetchAllIndicators}
calculateCompositeScoreV2: ${result.calculateCompositeScoreV2}

Status: ${result.fetchAllIndicators === 'function' && result.calculateCompositeScoreV2 === 'function' ? '‚úÖ OK' : '‚ùå MISSING'}
            `;
        };

        window.testFetchIndicators = async function() {
            document.getElementById('fetch-result').textContent = 'üîÑ Testing...';
            
            try {
                if (!fetchAllIndicators) {
                    throw new Error('fetchAllIndicators not available');
                }
                
                const indicators = await fetchAllIndicators();
                const keys = Object.keys(indicators);
                const nonMetaKeys = keys.filter(k => !k.startsWith('_'));
                
                document.getElementById('fetch-result').textContent = `
‚úÖ Fetch successful
Total keys: ${keys.length}
Indicator keys: ${nonMetaKeys.length}
Meta keys: ${keys.filter(k => k.startsWith('_')).length}

Sample keys: ${nonMetaKeys.slice(0, 5).join(', ')}
                `;
            } catch (error) {
                document.getElementById('fetch-result').textContent = `‚ùå Error: ${error.message}`;
            }
        };

        window.testCompositeScore = async function() {
            document.getElementById('composite-result').textContent = 'üîÑ Testing...';
            
            try {
                if (!fetchAllIndicators || !calculateCompositeScoreV2) {
                    throw new Error('Required functions not available');
                }
                
                const indicators = await fetchAllIndicators();
                
                // Test static
                const staticComposite = calculateCompositeScoreV2(indicators, false);
                
                // Test dynamic
                const dynamicComposite = calculateCompositeScoreV2(indicators, true);
                
                document.getElementById('composite-result').textContent = `
‚úÖ Tests completed

STATIC COMPOSITE:
- Score: ${staticComposite?.score}
- Version: ${staticComposite?.version}
- HasDynamicWeighting: ${!!staticComposite?.dynamicWeighting}

DYNAMIC COMPOSITE:
- Score: ${dynamicComposite?.score}  
- Version: ${dynamicComposite?.version}
- HasDynamicWeighting: ${!!dynamicComposite?.dynamicWeighting}
- Phase: ${dynamicComposite?.dynamicWeighting?.phase?.name || 'N/A'}

Difference: ${staticComposite?.score === dynamicComposite?.score ? 'SAME SCORE' : 'DIFFERENT SCORES'}
                `;
            } catch (error) {
                document.getElementById('composite-result').textContent = `‚ùå Error: ${error.message}`;
            }
        };

        window.testDynamicWeighting = async function() {
            document.getElementById('dynamic-result').textContent = 'üîÑ Testing...';
            
            try {
                const indicators = await fetchAllIndicators();
                
                // Test avec diff√©rents param√®tres
                const tests = [
                    { useDynamic: false, label: 'Static' },
                    { useDynamic: true, label: 'Dynamic' },
                ];
                
                let results = 'üß™ DYNAMIC WEIGHTING TESTS:\n\n';
                
                for (const test of tests) {
                    const composite = calculateCompositeScoreV2(indicators, test.useDynamic);
                    
                    results += `${test.label.toUpperCase()}:\n`;
                    results += `- Score: ${composite?.score}\n`;
                    results += `- Version: ${composite?.version}\n`;
                    results += `- Dynamic data: ${!!composite?.dynamicWeighting}\n`;
                    
                    if (composite?.dynamicWeighting) {
                        results += `- Phase: ${composite.dynamicWeighting.phase.name}\n`;
                        results += `- Weights: ${JSON.stringify(composite.dynamicWeighting.weights, null, 2)}\n`;
                    }
                    
                    if (composite?.categoryBreakdown) {
                        results += `- Categories: ${Object.keys(composite.categoryBreakdown).length}\n`;
                        const firstCat = Object.values(composite.categoryBreakdown)[0];
                        if (firstCat) {
                            results += `- Sample weight: ${Math.round((firstCat.weight || 0) * 100)}%\n`;
                            results += `- Static weight: ${Math.round((firstCat.staticWeight || 0) * 100)}%\n`;
                        }
                    }
                    results += '\n';
                }
                
                document.getElementById('dynamic-result').textContent = results;
                
            } catch (error) {
                document.getElementById('dynamic-result').textContent = `‚ùå Error: ${error.message}\n\nStack: ${error.stack}`;
            }
        };
    </script>
</body>
</html>
