<!DOCTYPE html>
<html>
<head>
    <base href="/static/">
  <title>Test FRED Complete Data</title>
  <script src="global-config.js"></script>
</head>
<body>
  <h1>🏛️ Test FRED Données Complètes</h1>
  <p>Vérification que FRED retourne bien les données depuis 2014</p>
  
  <button onclick="testFredComplete()">Test FRED Complete</button>
  <button onclick="testFetchFunction()">Test fetchBitcoinHistoricalData()</button>
  
  <div id="results"></div>

  <script>
    function log(message, type = 'info') {
      const results = document.getElementById('results');
      const div = document.createElement('div');
      div.style.cssText = `
        margin: 0.5rem 0; 
        padding: 0.5rem; 
        border-radius: 4px; 
        background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#fff3cd'};
        color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#856404'};
      `;
      div.innerHTML = message;
      results.appendChild(div);
    }

    // Test FRED API directement avec les vraies données complètes
    async function testFredComplete() {
      log('🏛️ Test FRED API avec données complètes depuis 2014...');
      
      const FRED_API_KEY = prompt('Entrez votre clé API FRED:') || 'test-key';
      
      try {
        // Test avec toutes les données depuis 2014
        const url = `https://api.stlouisfed.org/fred/series/observations?series_id=CBBTCUSD&api_key=${encodeURIComponent(FRED_API_KEY)}&file_type=json&observation_start=2014-01-01`;
        const response = await fetch(url, { mode: 'cors' });
        
        if (response.ok) {
          const data = await response.json();
          if (data.observations && data.observations.length > 0) {
            const totalCount = data.count;
            const observations = data.observations;
            
            // Filtrer les données valides
            const validData = observations
              .filter(o => o.value !== '.' && o.value != null)
              .map(o => ({ 
                date: o.date, 
                price: parseFloat(o.value),
                timestamp: new Date(o.date).getTime()
              }))
              .filter(p => Number.isFinite(p.price));
            
            const firstValid = validData[0];
            const lastValid = validData[validData.length - 1];
            
            log(`✅ FRED API: ${totalCount} observations totales disponibles`, 'success');
            log(`📊 Données valides: ${validData.length} points`, 'success');
            log(`📅 Première donnée: ${firstValid.date} = $${firstValid.price}`, 'success');
            log(`📅 Dernière donnée: ${lastValid.date} = $${lastValid.price}`, 'success');
            
            // Vérifier l'étendue temporelle
            const firstYear = new Date(firstValid.timestamp).getFullYear();
            const lastYear = new Date(lastValid.timestamp).getFullYear();
            
            log(`🗓️ Période couverte: ${firstYear} à ${lastYear} (${lastYear - firstYear + 1} années)`, 'success');
            
            if (firstYear <= 2014) {
              log(`✅ HISTORIQUE COMPLET: Données depuis ${firstYear} ✨`, 'success');
            } else {
              log(`⚠️ Historique limité: Données depuis ${firstYear} seulement`, 'warning');
            }
            
            // Sauvegarder la clé dans globalConfig
            window.globalConfig?.set?.('fred_api_key', FRED_API_KEY);
            log(`💾 Clé FRED sauvée dans GlobalConfig`, 'success');
            
          } else {
            log('❌ FRED API: Aucune observation dans la réponse', 'error');
          }
        } else {
          log(`❌ FRED API erreur: HTTP ${response.status}`, 'error');
        }
      } catch (e) {
        log(`❌ Erreur FRED API: ${e.message}`, 'error');
      }
    }

    // Test de la fonction complète fetchBitcoinHistoricalData
    async function testFetchFunction() {
      log('📈 Test de fetchBitcoinHistoricalData() complète...');
      
      // Simuler la fonction du risk dashboard
      async function fetchBitcoinHistoricalData() {
        let FRED_API_KEY = (window.globalConfig?.get?.('fred_api_key')) || '';
        
        // Fallback: demander la clé si pas dans globalConfig
        if (!FRED_API_KEY) {
          FRED_API_KEY = prompt('Entrez votre clé API FRED:') || 'test-key';
          window.globalConfig?.set?.('fred_api_key', FRED_API_KEY);
        }
        
        if (FRED_API_KEY) {
          try {
            const url = `https://api.stlouisfed.org/fred/series/observations?series_id=CBBTCUSD&api_key=${encodeURIComponent(FRED_API_KEY)}&file_type=json&observation_start=2014-01-01`;
            const r = await fetch(url, { mode: 'cors' });
            if (!r.ok) throw new Error(`FRED HTTP ${r.status}: ${r.statusText}`);
            const j = await r.json();
            if (Array.isArray(j.observations)) {
              const data = j.observations
                .filter(o => o.value !== '.' && o.value != null)
                .map(o => ({ time: new Date(o.date).getTime(), price: parseFloat(o.value) }))
                .filter(p => Number.isFinite(p.price));
              if (data.length > 0) {
                return { data, source: 'FRED (CBBTCUSD)' };
              }
            }
          } catch (e) {
            console.warn('FRED fetch failed:', e.message);
          }
        }
        return { data: [], source: 'Échec' };
      }

      try {
        const result = await fetchBitcoinHistoricalData();
        
        if (result.data.length > 0) {
          const first = result.data[0];
          const last = result.data[result.data.length - 1];
          const firstDate = new Date(first.time);
          const lastDate = new Date(last.time);
          
          log(`✅ fetchBitcoinHistoricalData() réussie!`, 'success');
          log(`📊 Source: ${result.source}`, 'success');
          log(`📊 Points de données: ${result.data.length}`, 'success');
          log(`📊 Période: ${firstDate.toLocaleDateString()} ($${first.price}) → ${lastDate.toLocaleDateString()} ($${last.price})`, 'success');
          
          // Vérifier que nous avons des données depuis 2014
          if (firstDate.getFullYear() <= 2014) {
            log(`🎯 SUCCÈS: Historique complet depuis ${firstDate.getFullYear()}! Le graphique devrait maintenant montrer toute l'histoire Bitcoin.`, 'success');
          } else {
            log(`⚠️ Historique limité: données depuis ${firstDate.getFullYear()} seulement`, 'warning');
          }
          
          // Format pour Chart.js
          const chartData = result.data.map(point => ({
            x: point.time,
            y: point.price
          }));
          
          log(`📊 Données prêtes pour Chart.js: ${chartData.length} points formatés`, 'success');
          
        } else {
          log(`❌ fetchBitcoinHistoricalData() retourne aucune donnée`, 'error');
        }
      } catch (e) {
        log(`❌ Erreur test fonction: ${e.message}`, 'error');
      }
    }

    // Auto-test on load
    document.addEventListener('DOMContentLoaded', () => {
      log('🚀 Test FRED complet initialisé');
      setTimeout(testFredComplete, 500);
    });
  </script>
</body>
</html>
