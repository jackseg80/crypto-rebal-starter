<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CCS Sync Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin: 20px 0; border: 1px solid #ccc; padding: 15px; }
        .btn { padding: 10px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; background: #3b82f6; color: white; }
        .btn:hover { background: #2563eb; }
        #log { background: #f3f4f6; padding: 10px; min-height: 200px; font-family: monospace; font-size: 12px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>CCS Sync Debug Test</h1>
    
    <div class="section">
        <h3>Step 1: Set up CCS data (simulates risk-dashboard.html)</h3>
        <button id="setupCcsBtn" class="btn">Setup Mock CCS Data</button>
        <div id="setupResult"></div>
    </div>
    
    <div class="section">
        <h3>Step 2: Test sync function (simulates rebalance.html)</h3>
        <button id="testSyncBtn" class="btn">Test syncCCSTargets()</button>
        <div id="syncResult"></div>
    </div>
    
    <div class="section">
        <h3>Debug Log</h3>
        <div id="log"></div>
    </div>

    <script type="module">
        const log = document.getElementById('log');
        const setupResult = document.getElementById('setupResult');
        const syncResult = document.getElementById('syncResult');
        
        function logMessage(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#dc2626' : type === 'success' ? '#10b981' : '#374151';
            log.innerHTML += `<div style="color: ${color}; margin: 2px 0;">[${timestamp}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        // Step 1: Setup CCS data like risk-dashboard.html does
        document.getElementById('setupCcsBtn').onclick = async function() {
            try {
                logMessage('Setting up mock CCS data...');
                
                // Import modules and generate real data like risk-dashboard.html does
                const { fetchAndComputeCCS } = await import('./static/modules/signals-engine.js');
                const { estimateCyclePosition, blendCCS } = await import('./static/modules/cycle-navigator.js');
                const { proposeTargets, applyTargets } = await import('./static/modules/targets-coordinator.js');
                const { store } = await import('./static/core/risk-dashboard-store.js');
                
                // Generate CCS data
                const ccs = await fetchAndComputeCCS();
                const cycle = estimateCyclePosition();
                const blended = blendCCS(ccs.score, cycle.months, 0.3);
                
                // Set up store like risk-dashboard does
                store.set('ccs', ccs);
                store.set('cycle', cycle);
                store.set('cycle.ccsStar', blended.blendedCCS);
                
                logMessage(`CCS Score: ${ccs.score}`, 'info');
                logMessage(`Cycle: ${cycle.phase.phase} (${Math.round(cycle.months)}m)`, 'info');
                logMessage(`Blended CCS: ${blended.blendedCCS.toFixed(1)}`, 'info');
                
                // Generate and apply targets like clicking a strategy button
                const proposal = proposeTargets('blend');
                logMessage(`Proposal: ${proposal.strategy}`, 'info');
                logMessage(`BTC: ${proposal.targets.BTC?.toFixed(1)}%, ETH: ${proposal.targets.ETH?.toFixed(1)}%`, 'info');
                
                await applyTargets(proposal);
                logMessage('Targets applied to localStorage', 'success');
                
                // Verify what was saved
                const saved = localStorage.getItem('last_targets');
                if (saved) {
                    const data = JSON.parse(saved);
                    logMessage(`Verified save - Source: ${data.source}, BTC: ${data.targets.BTC?.toFixed(1)}%`, 'success');
                }
                
                setupResult.innerHTML = '<div style="color: #10b981; padding: 10px;">✅ CCS data setup complete</div>';
                
            } catch (error) {
                logMessage(`Setup error: ${error.message}`, 'error');
                setupResult.innerHTML = `<div style="color: #dc2626; padding: 10px;">❌ Setup failed: ${error.message}</div>`;
            }
        };
        
        // Step 2: Test sync function like rebalance.html does
        document.getElementById('testSyncBtn').onclick = function() {
            try {
                logMessage('Testing syncCCSTargets function...');
                
                // This is the exact syncCCSTargets function from rebalance.html
                function syncCCSTargets() {
                    const storedTargets = localStorage.getItem('last_targets');
                    logMessage(`Raw localStorage data: ${storedTargets ? 'Found data' : 'No data'}`, storedTargets ? 'success' : 'error');
                    
                    if (!storedTargets) {
                        logMessage('No localStorage data found', 'error');
                        return null;
                    }
                    
                    try {
                        const targetsData = JSON.parse(storedTargets);
                        logMessage(`Parsed data source: ${targetsData.source}`, 'info');
                        logMessage(`BTC value: ${targetsData.targets?.BTC}`, 'info');
                        logMessage(`ETH value: ${targetsData.targets?.ETH}`, 'info');
                        
                        if (targetsData.source === 'risk-dashboard-ccs' && targetsData.targets && targetsData.timestamp) {
                            // Check data age
                            const dataAge = Date.now() - new Date(targetsData.timestamp).getTime();
                            const maxAge = 2 * 60 * 60 * 1000; // 2 hours
                            
                            logMessage(`Data age: ${Math.round(dataAge / 60000)} minutes`, 'info');
                            
                            if (dataAge < maxAge) {
                                // Filter targets to keep only numeric values
                                const cleanTargets = {};
                                Object.entries(targetsData.targets).forEach(([key, value]) => {
                                    if (typeof value === 'number' && key !== 'model_version') {
                                        cleanTargets[key] = value;
                                        logMessage(`Adding ${key}: ${value}%`, 'info');
                                    } else {
                                        logMessage(`Skipping ${key}: ${value} (${typeof value})`, 'info');
                                    }
                                });
                                
                                logMessage('Sync successful!', 'success');
                                return {
                                    targets: cleanTargets,
                                    strategy: targetsData.strategy,
                                    timestamp: targetsData.timestamp
                                };
                            } else {
                                logMessage('Data too old, ignoring', 'error');
                            }
                        } else {
                            logMessage('Invalid data structure or wrong source', 'error');
                        }
                    } catch (error) {
                        logMessage(`Error parsing stored targets: ${error.message}`, 'error');
                    }
                    
                    return null;
                }
                
                const result = syncCCSTargets();
                
                if (result) {
                    syncResult.innerHTML = '<div style="color: #10b981; padding: 10px;">✅ Sync successful! Check debug log for details.</div>';
                    logMessage('Final sync result:', 'success');
                    logMessage(`Strategy: ${result.strategy}`, 'success');
                    logMessage(`Targets: ${Object.entries(result.targets).map(([k,v]) => `${k}=${v.toFixed(1)}%`).join(', ')}`, 'success');
                } else {
                    syncResult.innerHTML = '<div style="color: #dc2626; padding: 10px;">❌ Sync failed. Check debug log for details.</div>';
                }
                
            } catch (error) {
                logMessage(`Test error: ${error.message}`, 'error');
                syncResult.innerHTML = `<div style="color: #dc2626; padding: 10px;">❌ Test failed: ${error.message}</div>`;
            }
        };
        
        logMessage('CCS Sync Debug Test ready. Run Step 1 first, then Step 2.');
    </script>
</body>
</html>