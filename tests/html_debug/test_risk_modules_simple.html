<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tests - Risk Dashboard Modules (Simple)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1b26;
            color: #c0caf5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #7aa2f7;
            margin-bottom: 20px;
            border-bottom: 2px solid #414868;
            padding-bottom: 10px;
        }

        h2 {
            color: #bb9af7;
            margin-top: 30px;
            margin-bottom: 15px;
            border-left: 4px solid #bb9af7;
            padding-left: 10px;
        }

        .test-suite {
            background: #24283b;
            border: 1px solid #414868;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .test-case {
            background: #1f2335;
            border-left: 3px solid #565f89;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .test-case.pass {
            border-left-color: #9ece6a;
        }

        .test-case.fail {
            border-left-color: #f7768e;
        }

        .test-name {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-status {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .test-status.pass {
            background: #9ece6a;
            color: #1a1b26;
        }

        .test-status.fail {
            background: #f7768e;
            color: #1a1b26;
        }

        .test-status.pending {
            background: #565f89;
            color: #c0caf5;
        }

        .test-detail {
            font-size: 14px;
            color: #a9b1d6;
            margin-top: 5px;
        }

        .test-error {
            background: #2a1820;
            border: 1px solid #f7768e;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #f7768e;
            white-space: pre-wrap;
        }

        .summary {
            background: #24283b;
            border: 2px solid #7aa2f7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .summary-item {
            text-align: center;
        }

        .summary-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .summary-value.pass {
            color: #9ece6a;
        }

        .summary-value.fail {
            color: #f7768e;
        }

        .summary-label {
            font-size: 14px;
            color: #565f89;
            text-transform: uppercase;
        }

        .run-button {
            background: #7aa2f7;
            color: #1a1b26;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 20px;
        }

        .run-button:hover {
            background: #9ece6a;
            transform: translateY(-2px);
        }

        .run-button:disabled {
            background: #565f89;
            cursor: not-allowed;
            transform: none;
        }

        .log {
            background: #1f2335;
            border: 1px solid #414868;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-entry.info {
            color: #7aa2f7;
        }

        .log-entry.success {
            color: #9ece6a;
        }

        .log-entry.error {
            color: #f7768e;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Tests - Risk Dashboard Modules (Simple)</h1>

        <button class="run-button" id="runBtn">‚ñ∂Ô∏è Lancer les Tests</button>

        <div class="summary" id="summary">
            <div class="summary-item">
                <div class="summary-value pass" id="passCount">0</div>
                <div class="summary-label">Pass</div>
            </div>
            <div class="summary-item">
                <div class="summary-value fail" id="failCount">0</div>
                <div class="summary-label">Fail</div>
            </div>
            <div class="summary-item">
                <div class="summary-value" id="totalCount">0</div>
                <div class="summary-label">Total</div>
            </div>
        </div>

        <div id="testResults"></div>

        <div class="log" id="logContainer"></div>
    </div>

    <script>
        // Simple test framework
        let passCount = 0;
        let failCount = 0;
        let totalCount = 0;

        function log(level, message) {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${level}`;
            const time = new Date().toLocaleTimeString();
            entry.textContent = `[${time}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateSummary() {
            document.getElementById('passCount').textContent = passCount;
            document.getElementById('failCount').textContent = failCount;
            document.getElementById('totalCount').textContent = totalCount;
        }

        function runTest(suiteName, testName, testFn) {
            totalCount++;

            const resultsContainer = document.getElementById('testResults');

            // Cr√©er l'√©l√©ment de test
            const testDiv = document.createElement('div');
            testDiv.className = 'test-case';
            testDiv.innerHTML = `
                <div class="test-name">
                    <span class="test-status pending">RUNNING</span>
                    <span>${suiteName} > ${testName}</span>
                </div>
                <div class="test-detail">‚è≥ En cours...</div>
            `;
            resultsContainer.appendChild(testDiv);

            const statusEl = testDiv.querySelector('.test-status');
            const detailEl = testDiv.querySelector('.test-detail');

            const start = performance.now();

            try {
                testFn();
                const duration = performance.now() - start;

                passCount++;
                testDiv.classList.add('pass');
                statusEl.textContent = 'PASS';
                statusEl.className = 'test-status pass';
                detailEl.textContent = `‚úì Pass√© en ${duration.toFixed(2)}ms`;

                log('success', `‚úì ${suiteName} > ${testName} (${duration.toFixed(2)}ms)`);

            } catch (error) {
                const duration = performance.now() - start;

                failCount++;
                testDiv.classList.add('fail');
                statusEl.textContent = 'FAIL';
                statusEl.className = 'test-status fail';
                detailEl.textContent = `‚úó √âchou√© en ${duration.toFixed(2)}ms`;

                const errorDiv = document.createElement('div');
                errorDiv.className = 'test-error';
                errorDiv.textContent = error.stack || error.message;
                testDiv.appendChild(errorDiv);

                log('error', `‚úó ${suiteName} > ${testName}: ${error.message}`);
            }

            updateSummary();
        }

        // Assertion helpers
        const assert = {
            equal(actual, expected, message) {
                if (actual !== expected) {
                    throw new Error(message || `Expected ${expected}, got ${actual}`);
                }
            },
            ok(value, message) {
                if (!value) {
                    throw new Error(message || `Expected truthy value, got ${value}`);
                }
            },
            isTrue(value, message) {
                if (value !== true) {
                    throw new Error(message || `Expected true, got ${value}`);
                }
            }
        };

        // Tests
        function runAllTests() {
            const btn = document.getElementById('runBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Tests en cours...';

            passCount = 0;
            failCount = 0;
            totalCount = 0;

            document.getElementById('testResults').innerHTML = '';
            document.getElementById('logContainer').innerHTML = '';

            log('info', 'D√©marrage des tests...');

            // Suite 1: risk-alerts-tab.js
            runTest('risk-alerts-tab.js', 'doit filtrer les alertes par severit√©', () => {
                const mockAlerts = [
                    { id: '1', severity: 'S1', alert_type: 'VOL' },
                    { id: '2', severity: 'S2', alert_type: 'REGIME' },
                    { id: '3', severity: 'S3', alert_type: 'VOL' }
                ];

                const filtered = mockAlerts.filter(a => ['S2', 'S3'].includes(a.severity));
                assert.equal(filtered.length, 2, 'Devrait filtrer 2 alertes');
            });

            runTest('risk-alerts-tab.js', 'doit paginer les alertes correctement', () => {
                const mockAlerts = Array.from({ length: 25 }, (_, i) => ({ id: `${i}` }));

                const page1 = mockAlerts.slice(0, 10);
                const page2 = mockAlerts.slice(10, 20);
                const page3 = mockAlerts.slice(20, 25);

                assert.equal(page1.length, 10, 'Page 1 devrait avoir 10 items');
                assert.equal(page2.length, 10, 'Page 2 devrait avoir 10 items');
                assert.equal(page3.length, 5, 'Page 3 devrait avoir 5 items');
            });

            runTest('risk-alerts-tab.js', 'doit calculer les stats correctement', () => {
                const mockAlerts = [
                    { severity: 'S1' },
                    { severity: 'S1' },
                    { severity: 'S2' },
                    { severity: 'S3' }
                ];

                const stats = mockAlerts.reduce((acc, alert) => {
                    acc[alert.severity] = (acc[alert.severity] || 0) + 1;
                    return acc;
                }, {});

                assert.equal(stats['S1'], 2, 'Devrait compter 2 alertes S1');
                assert.equal(stats['S2'], 1, 'Devrait compter 1 alerte S2');
                assert.equal(stats['S3'], 1, 'Devrait compter 1 alerte S3');
            });

            // Suite 2: risk-overview-tab.js
            runTest('risk-overview-tab.js', 'doit valider Risk Score entre 0 et 100', () => {
                const riskScore = 65;
                assert.ok(riskScore >= 0 && riskScore <= 100, 'Risk Score doit √™tre entre 0 et 100');
            });

            runTest('risk-overview-tab.js', 'doit d√©tecter dual window disponible', () => {
                const mockDualWindow = {
                    enabled: true,
                    long_term: { available: true, window_days: 365, asset_count: 3 },
                    full_intersection: { window_days: 55, asset_count: 5 }
                };

                assert.isTrue(mockDualWindow.enabled, 'Dual window devrait √™tre activ√©');
                assert.isTrue(mockDualWindow.long_term.available, 'Long-term devrait √™tre disponible');
                assert.equal(mockDualWindow.long_term.window_days, 365, 'Devrait utiliser 365j');
            });

            runTest('risk-overview-tab.js', 'doit calculer la divergence Risk Score V2', () => {
                const legacyScore = 65;
                const v2Score = 35;
                const divergence = legacyScore - v2Score;

                assert.equal(divergence, 30, 'Divergence devrait √™tre 30 points');
                assert.ok(divergence > 10, 'Divergence significative d√©tect√©e');
            });

            // Suite 3: risk-cycles-tab.js
            runTest('risk-cycles-tab.js', 'doit formater les donn√©es pour Chart.js', () => {
                const mockData = {
                    dates: ['2024-01-01', '2024-01-02'],
                    prices: [50000, 51000]
                };

                assert.equal(mockData.dates.length, mockData.prices.length, 'Dates et prices doivent avoir m√™me longueur');
                assert.ok(mockData.prices[1] > mockData.prices[0], 'Prix devrait augmenter');
            });

            runTest('risk-cycles-tab.js', 'doit calculer le composite score on-chain', () => {
                const indicators = {
                    momentum: 0.75,
                    valuation: 0.60,
                    network: 0.80,
                    risk: 0.50
                };

                const weights = { momentum: 0.3, valuation: 0.2, network: 0.3, risk: 0.2 };
                const composite = Object.keys(indicators).reduce((sum, key) => {
                    return sum + indicators[key] * weights[key];
                }, 0);

                assert.ok(composite >= 0 && composite <= 1, 'Composite score entre 0 et 1');
            });

            runTest('risk-cycles-tab.js', 'doit g√©rer le cache hash-based', () => {
                const data1 = JSON.stringify({ prices: [50000, 51000] });
                const data2 = JSON.stringify({ prices: [50000, 51000] });

                const hash1 = data1.length;
                const hash2 = data2.length;

                assert.equal(hash1, hash2, 'Donn√©es identiques devraient avoir m√™me hash');
            });

            // Suite 4: risk-targets-tab.js
            runTest('risk-targets-tab.js', 'doit comparer allocation actuelle vs objectifs', () => {
                const current = { BTC: 0.40, ETH: 0.30, Stables: 0.30 };
                const target = { BTC: 0.50, ETH: 0.30, Stables: 0.20 };

                const delta = {
                    BTC: target.BTC - current.BTC,
                    ETH: target.ETH - current.ETH,
                    Stables: target.Stables - current.Stables
                };

                assert.equal(delta.BTC, 0.10, 'BTC devrait augmenter de 10%');
                assert.equal(delta.Stables, -0.10, 'Stables devraient diminuer de 10%');
            });

            runTest('risk-targets-tab.js', 'doit g√©n√©rer plan d\'action (buy/sell)', () => {
                const delta = { BTC: 0.10, ETH: 0, Stables: -0.10 };

                const actions = Object.entries(delta).map(([asset, pct]) => {
                    if (pct > 0.01) return { action: 'BUY', asset, pct };
                    if (pct < -0.01) return { action: 'SELL', asset, pct: Math.abs(pct) };
                    return null;
                }).filter(Boolean);

                assert.equal(actions.length, 2, 'Devrait avoir 2 actions');
                assert.equal(actions[0].action, 'BUY', 'Premi√®re action devrait √™tre BUY');
                assert.equal(actions[1].action, 'SELL', 'Deuxi√®me action devrait √™tre SELL');
            });

            runTest('risk-targets-tab.js', 'doit g√©rer les 5 strat√©gies disponibles', () => {
                const strategies = ['macro', 'ccs', 'cycle', 'blend', 'smart'];
                assert.equal(strategies.length, 5, 'Devrait avoir 5 strat√©gies');
                assert.ok(strategies.includes('smart'), 'Devrait inclure SMART');
            });

            // Suite 5: Performance
            runTest('Performance', 'doit g√©rer un grand nombre d\'alertes (1000+)', () => {
                const largeAlerts = Array.from({ length: 1000 }, (_, i) => ({ id: `${i}` }));

                const start = performance.now();
                const filtered = largeAlerts.filter(a => parseInt(a.id) % 2 === 0);
                const duration = performance.now() - start;

                assert.ok(duration < 50, `Filtrage devrait √™tre rapide (${duration.toFixed(2)}ms < 50ms)`);
                assert.equal(filtered.length, 500, 'Devrait filtrer 500 alertes');
            });

            log('success', `Tests termin√©s: ${passCount} pass√©s, ${failCount} √©chou√©s sur ${totalCount} total`);

            btn.disabled = false;
            btn.textContent = '‚ñ∂Ô∏è Relancer les Tests';
        }

        // Event listener
        document.getElementById('runBtn').addEventListener('click', runAllTests);

        // Log initial
        log('info', 'Page charg√©e. Cliquez sur "Lancer les Tests" pour commencer.');
        console.log('‚úÖ Test page loaded successfully');
    </script>
</body>
</html>
