<!DOCTYPE html>
<html lang="fr">
<head>
    <base href="/static/">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¨ Test V2 Comprehensive - Validation Compl√®te</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            background: #0f172a;
            color: #e2e8f0;
            line-height: 1.6;
        }
        .container { max-width: 1800px; margin: 0 auto; }
        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #334155;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            background: #3b82f6;
            color: white;
            margin: 5px;
        }
        .btn:hover { background: #2563eb; }
        .btn.success { background: #10b981; }
        .btn.warning { background: #f59e0b; }
        .btn.danger { background: #ef4444; }
        
        .test-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .category-panel {
            border-left: 4px solid #3b82f6;
            background: #1e293b;
            padding: 20px;
            border-radius: 8px;
        }
        
        .onchain-pure { border-left-color: #3b82f6; }
        .cycle-technical { border-left-color: #10b981; }
        .sentiment-social { border-left-color: #f59e0b; }
        .market-context { border-left-color: #8b5cf6; }
        
        .score-display {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            margin: 15px 0;
        }
        
        .consensus-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin: 2px 5px;
        }
        .consensus-bullish { background: #065f46; color: #10b981; }
        .consensus-bearish { background: #7f1d1d; color: #f87171; }
        .consensus-neutral { background: #374151; color: #9ca3af; }
        
        .indicator-list {
            max-height: 300px;
            overflow-y: auto;
            background: #0f172a;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .indicator-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #334155;
        }
        
        .critical-indicator {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
            padding-left: 8px;
        }
        
        .correlation-info {
            font-size: 0.75rem;
            color: #64748b;
            margin-left: 10px;
        }
        
        .log {
            background: #0f172a;
            padding: 15px;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .validation-section {
            background: #1e293b;
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .validation-passed { border-color: #10b981; }
        .validation-failed { border-color: #ef4444; }
        .validation-warning { border-color: #f59e0b; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üî¨ Test V2 Comprehensive</h1>
            <p><strong>Validation compl√®te du syst√®me V2</strong> avant int√©gration dans le dashboard</p>
            
            <div>
                <button class="btn success" onclick="runFullValidation()">‚úÖ Full Validation</button>
                <button class="btn" onclick="testCategoryLogic()">üìä Test Categories</button>
                <button class="btn" onclick="testCorrelationReduction()">üîó Test Correlations</button>
                <button class="btn" onclick="testConsensusVoting()">üó≥Ô∏è Test Consensus</button>
                <button class="btn warning" onclick="simulateScenarios()">üé≠ Simulate Scenarios</button>
                <button class="btn danger" onclick="stressTest()">üí™ Stress Test</button>
            </div>
        </div>

        <!-- Validation Status -->
        <div class="validation-section" id="validation-status" style="display: none;">
            <h3>üîç Validation Results</h3>
            <div id="validation-content"></div>
        </div>

        <!-- Category Analysis -->
        <div class="test-results" id="category-results" style="display: none;">
            <!-- Categories will be populated dynamically -->
        </div>

        <!-- Detailed Analysis -->
        <div class="card" id="detailed-analysis" style="display: none;">
            <h3>üìã Detailed Analysis</h3>
            <div id="analysis-content"></div>
        </div>

        <!-- Test Scenarios -->
        <div class="card" id="scenarios-panel" style="display: none;">
            <h3>üé≠ Test Scenarios</h3>
            <div id="scenarios-content"></div>
        </div>

        <!-- Test Log -->
        <div class="card">
            <h3>üìù Test Log</h3>
            <div class="log" id="test-log">
V2 comprehensive test ready...
</div>
        </div>
    </div>

    <script type="module">
        let logElement;
        let validationResults = {};
        
        window.onload = function() {
            logElement = document.getElementById('test-log');
            log('üî¨ V2 comprehensive test ready', 'success');
            log('‚ÑπÔ∏è This will validate all V2 improvements before dashboard integration', 'info');
        };
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logElement.textContent += `[${timestamp}] ${icon} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        window.runFullValidation = async function() {
            log('üî¨ Starting comprehensive V2 validation...', 'info');
            
            validationResults = {
                modules_loaded: false,
                data_fetched: false,
                categories_classified: false,
                correlations_handled: false,
                consensus_calculated: false,
                score_computed: false,
                cache_working: false
            };
            
            document.getElementById('validation-status').style.display = 'block';
            
            try {
                // 1. Test module loading
                log('üì¶ Testing module imports...', 'info');
                const v2Module = await import('./modules/composite-score-v2.js');
                const categoriesModule = await import('./modules/indicator-categories-v2.js');
                const v1Module = await import('./modules/onchain-indicators.js');
                validationResults.modules_loaded = true;
                log('‚úÖ All modules loaded successfully', 'success');
                
                // 2. Test data fetching
                log('üì° Testing data fetching...', 'info');
                const indicators = await v1Module.fetchAllIndicators();
                const indicatorCount = Object.keys(indicators).filter(k => !k.startsWith('_')).length;
                validationResults.data_fetched = indicatorCount > 0;
                log(`‚úÖ ${indicatorCount} indicators fetched`, 'success');
                
                // 3. Test categorization
                log('üìä Testing V2 categorization...', 'info');
                let categorizedCount = 0;
                Object.entries(indicators).forEach(([key, data]) => {
                    if (!key.startsWith('_') && data.name) {
                        const classification = categoriesModule.classifyIndicatorV2(data.name);
                        if (classification.category !== 'market_context' || classification.key !== 'unknown') {
                            categorizedCount++;
                        }
                    }
                });
                validationResults.categories_classified = categorizedCount > (indicatorCount * 0.8);
                log(`‚úÖ ${categorizedCount}/${indicatorCount} indicators properly classified`, 'success');
                
                // 4. Test V2 score calculation
                log('üßÆ Testing V2 score calculation...', 'info');
                const v2Result = v2Module.calculateCompositeScoreV2(indicators);
                validationResults.score_computed = v2Result.score !== null;
                log(`‚úÖ V2 score calculated: ${v2Result.score}/100`, 'success');
                
                // 5. Test correlations
                log('üîó Testing correlation handling...', 'info');
                const hasCorrelationReduction = Object.values(v2Result.correlationAnalysis || {})
                    .some(analysis => analysis.correlation_reduction);
                validationResults.correlations_handled = hasCorrelationReduction;
                log(`${hasCorrelationReduction ? '‚úÖ' : '‚ö†Ô∏è'} Correlation reductions: ${hasCorrelationReduction ? 'Applied' : 'None detected'}`, hasCorrelationReduction ? 'success' : 'warning');
                
                // 6. Test consensus
                log('üó≥Ô∏è Testing consensus voting...', 'info');
                const hasConsensus = Object.keys(v2Result.consensusSignals || {}).length > 0;
                validationResults.consensus_calculated = hasConsensus;
                log(`‚úÖ Consensus signals: ${Object.keys(v2Result.consensusSignals || {}).length} categories`, 'success');
                
                // 7. Test cache
                log('‚ö° Testing cache performance...', 'info');
                const start = performance.now();
                await v1Module.fetchAllIndicators(); // Should be cached
                const cacheTime = performance.now() - start;
                validationResults.cache_working = cacheTime < 50; // Less than 50ms = probably cached
                log(`${validationResults.cache_working ? '‚úÖ' : '‚ö†Ô∏è'} Cache response time: ${cacheTime.toFixed(0)}ms`, validationResults.cache_working ? 'success' : 'warning');
                
                // Display validation summary
                displayValidationResults();
                
                // Display detailed analysis
                displayDetailedAnalysis(v2Result, indicators);
                
                log('üéâ Full validation completed!', 'success');
                
            } catch (error) {
                log(`‚ùå Validation failed: ${error.message}`, 'error');
                console.error(error);
            }
        };
        
        window.testCategoryLogic = async function() {
            log('üìä Testing category logic in detail...', 'info');
            document.getElementById('category-results').style.display = 'grid';
            
            try {
                const v2Module = await import('./modules/composite-score-v2.js');
                const categoriesModule = await import('./modules/indicator-categories-v2.js');
                const v1Module = await import('./modules/onchain-indicators.js');
                
                const indicators = await v1Module.fetchAllIndicators();
                const v2Result = v2Module.calculateCompositeScoreV2(indicators);
                
                displayCategoryBreakdown(v2Result.categoryBreakdown, indicators);
                
                log('‚úÖ Category logic test completed', 'success');
                
            } catch (error) {
                log(`‚ùå Category test failed: ${error.message}`, 'error');
            }
        };
        
        window.testCorrelationReduction = async function() {
            log('üîó Testing correlation reduction in detail...', 'info');
            
            // This will test specific correlation scenarios
            try {
                const categoriesModule = await import('./modules/indicator-categories-v2.js');
                
                // Test case: Multiple MVRV indicators (should be correlated)
                const testIndicators = {
                    'mvrv_z_score': { name: 'MVRV Z-Score', value_numeric: 82.5 },
                    'mvrv': { name: 'MVRV', value_numeric: 85.0 },
                    'nupl': { name: 'NUPL', value_numeric: 83.8 },
                    'pi_cycle': { name: 'Pi Cycle', value_numeric: 57.6 },
                    'cbbi': { name: 'CBBI*', value_numeric: 75.4 }
                };
                
                log('Testing with correlated indicators (MVRV group)...', 'info');
                
                // Check classifications
                Object.entries(testIndicators).forEach(([key, data]) => {
                    const classification = categoriesModule.classifyIndicatorV2(data.name);
                    log(`  ${data.name} ‚Üí ${classification.category} (${classification.correlationGroup || 'no group'})`, 'info');
                });
                
                log('‚úÖ Correlation reduction test completed', 'success');
                
            } catch (error) {
                log(`‚ùå Correlation test failed: ${error.message}`, 'error');
            }
        };
        
        window.testConsensusVoting = async function() {
            log('üó≥Ô∏è Testing consensus voting system...', 'info');
            
            try {
                const v2Module = await import('./modules/composite-score-v2.js');
                const v1Module = await import('./modules/onchain-indicators.js');
                
                const indicators = await v1Module.fetchAllIndicators();
                const v2Result = v2Module.calculateCompositeScoreV2(indicators);
                
                // Test contradictory signals
                const contradictions = v2Module.analyzeContradictorySignals(v2Result.categoryBreakdown);
                
                log(`üìä Consensus results:`, 'info');
                Object.entries(v2Result.consensusSignals || {}).forEach(([category, consensus]) => {
                    log(`  ${category}: ${consensus.consensus} (${consensus.confidence}% confidence)`, 'info');
                });
                
                if (contradictions.length > 0) {
                    log(`‚ö†Ô∏è Found ${contradictions.length} contradictory signal(s):`, 'warning');
                    contradictions.forEach(contradiction => {
                        log(`  ${contradiction.category1.name} vs ${contradiction.category2.name}`, 'warning');
                    });
                } else {
                    log('‚úÖ No contradictory signals - good consensus!', 'success');
                }
                
                log('‚úÖ Consensus voting test completed', 'success');
                
            } catch (error) {
                log(`‚ùå Consensus test failed: ${error.message}`, 'error');
            }
        };
        
        window.simulateScenarios = async function() {
            log('üé≠ Simulating different market scenarios...', 'info');
            document.getElementById('scenarios-panel').style.display = 'block';
            
            try {
                const scenarios = [
                    {
                        name: 'Bull Market Peak',
                        description: 'High MVRV, high sentiment, cycle indicators at peak',
                        indicators: {
                            'mvrv_z_score': 95,
                            'pi_cycle': 98,
                            'fear_greed': 85,
                            'cbbi': 92
                        }
                    },
                    {
                        name: 'Bear Market Bottom',
                        description: 'Low MVRV, extreme fear, cycle at bottom',
                        indicators: {
                            'mvrv_z_score': 15,
                            'pi_cycle': 5,
                            'fear_greed': 10,
                            'nupl': 20
                        }
                    },
                    {
                        name: 'Mixed Signals',
                        description: 'Contradictory signals between categories',
                        indicators: {
                            'mvrv_z_score': 25, // Bullish
                            'pi_cycle': 85,     // Bearish
                            'fear_greed': 50    // Neutral
                        }
                    }
                ];
                
                let scenarioHtml = '';
                
                // For now, just simulate the logic
                scenarios.forEach(scenario => {
                    let avgScore = Object.values(scenario.indicators).reduce((a, b) => a + b, 0) / Object.values(scenario.indicators).length;
                    
                    scenarioHtml += `
                        <div class="validation-section">
                            <h4>${scenario.name}</h4>
                            <p>${scenario.description}</p>
                            <p><strong>Simulated Average Score:</strong> ${avgScore.toFixed(1)}/100</p>
                            <div style="font-size: 0.9rem; color: #64748b;">
                                ${Object.entries(scenario.indicators).map(([key, value]) => 
                                    `${key}: ${value}%`
                                ).join(', ')}
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('scenarios-content').innerHTML = scenarioHtml;
                
                log('‚úÖ Market scenarios simulated', 'success');
                
            } catch (error) {
                log(`‚ùå Scenario simulation failed: ${error.message}`, 'error');
            }
        };
        
        window.stressTest = async function() {
            log('üí™ Running stress test...', 'info');
            
            try {
                // Test multiple rapid calls
                const iterations = 10;
                const times = [];
                
                for (let i = 0; i < iterations; i++) {
                    const start = performance.now();
                    
                    const v1Module = await import('./modules/onchain-indicators.js');
                    const v2Module = await import('./modules/composite-score-v2.js');
                    
                    const indicators = await v1Module.fetchAllIndicators();
                    const result = v2Module.calculateCompositeScoreV2(indicators);
                    
                    const time = performance.now() - start;
                    times.push(time);
                    
                    if (i === 0) {
                        log(`First call: ${time.toFixed(0)}ms (includes network)`, 'info');
                    } else if (i < 3) {
                        log(`Call ${i + 1}: ${time.toFixed(0)}ms`, 'info');
                    }
                }
                
                const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
                const maxTime = Math.max(...times);
                const minTime = Math.min(...times);
                
                log(`üìä Stress test results:`, 'success');
                log(`  Average: ${avgTime.toFixed(0)}ms`, 'info');
                log(`  Min: ${minTime.toFixed(0)}ms`, 'info');
                log(`  Max: ${maxTime.toFixed(0)}ms`, 'info');
                
                if (avgTime < 100) {
                    log('‚úÖ Performance is excellent', 'success');
                } else if (avgTime < 500) {
                    log('‚ö†Ô∏è Performance is acceptable', 'warning');
                } else {
                    log('‚ùå Performance needs improvement', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Stress test failed: ${error.message}`, 'error');
            }
        };
        
        function displayValidationResults() {
            const total = Object.keys(validationResults).length;
            const passed = Object.values(validationResults).filter(Boolean).length;
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            `;
            
            Object.entries(validationResults).forEach(([test, passed]) => {
                const icon = passed ? '‚úÖ' : '‚ùå';
                const color = passed ? '#10b981' : '#ef4444';
                const testName = test.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                
                html += `
                    <div style="background: #0f172a; padding: 15px; border-radius: 6px; border-left: 4px solid ${color};">
                        <div style="font-weight: bold; color: ${color};">${icon} ${testName}</div>
                    </div>
                `;
            });
            
            html += `</div>`;
            html += `<div style="text-align: center; margin-top: 20px; font-size: 1.5rem; font-weight: bold;">
                Score: ${passed}/${total} ${passed === total ? 'üéâ' : passed > total/2 ? 'üëç' : '‚ö†Ô∏è'}
            </div>`;
            
            document.getElementById('validation-content').innerHTML = html;
            
            const validationSection = document.getElementById('validation-status');
            validationSection.className = `validation-section ${
                passed === total ? 'validation-passed' : 
                passed > total/2 ? 'validation-warning' : 
                'validation-failed'
            }`;
        }
        
        function displayCategoryBreakdown(categoryBreakdown, indicators) {
            const container = document.getElementById('category-results');
            let html = '';
            
            Object.entries(categoryBreakdown).forEach(([categoryKey, data]) => {
                const consensus = data.consensus || {};
                const consensusClass = `consensus-${consensus.consensus || 'neutral'}`;
                
                html += `
                    <div class="category-panel ${categoryKey.replace('_', '-')}">
                        <h4 style="color: ${data.color || '#64748b'};">
                            ${data.description} (${Math.round(data.weight * 100)}%)
                        </h4>
                        
                        <div class="score-display" style="color: ${data.color || '#64748b'};">
                            ${data.score}/100
                        </div>
                        
                        <div style="text-align: center;">
                            <span class="consensus-badge ${consensusClass}">
                                ${consensus.consensus || 'neutral'} (${consensus.confidence || 0}%)
                            </span>
                        </div>
                        
                        <div class="indicator-list">
                            ${data.contributors.map(indicator => `
                                <div class="indicator-item ${indicator.inCriticalZone ? 'critical-indicator' : ''}">
                                    <span>
                                        ${indicator.inCriticalZone ? 'üö® ' : ''}${indicator.name}
                                        ${indicator.correlationReduction ? 
                                          `<span class="correlation-info">(${indicator.correlationReduction})</span>` : 
                                          ''}
                                    </span>
                                    <span>${indicator.originalValue}%</span>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="font-size: 0.85rem; color: #64748b; margin-top: 10px;">
                            ${data.contributorsCount} indicators
                            ${data.correlationAnalysis && data.correlationAnalysis.correlation_reduction ? 
                              ` (${data.correlationAnalysis.original_count} ‚Üí ${data.correlationAnalysis.reduced_count} after correlation reduction)` : 
                              ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function displayDetailedAnalysis(v2Result, indicators) {
            document.getElementById('detailed-analysis').style.display = 'block';
            
            const totalIndicators = Object.keys(indicators).filter(k => !k.startsWith('_')).length;
            const criticalCount = v2Result.criticalZoneCount || 0;
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div>
                        <h4>üìä Score Metrics</h4>
                        <p><strong>Final Score:</strong> ${v2Result.score}/100</p>
                        <p><strong>Confidence:</strong> ${Math.round((v2Result.confidence || 0) * 100)}%</p>
                        <p><strong>Version:</strong> ${v2Result.version || 'V2'}</p>
                    </div>
                    
                    <div>
                        <h4>üìà Indicator Stats</h4>
                        <p><strong>Total Indicators:</strong> ${totalIndicators}</p>
                        <p><strong>Critical Zones:</strong> ${criticalCount}</p>
                        <p><strong>Active Categories:</strong> ${v2Result.activeCategories}</p>
                    </div>
                    
                    <div>
                        <h4>üîó Correlation Analysis</h4>
                        <p><strong>Reductions Applied:</strong> ${
                            Object.values(v2Result.correlationAnalysis || {})
                                .filter(analysis => analysis.correlation_reduction).length
                        }</p>
                        <p><strong>Weight Adjustments:</strong> ${
                            Object.values(v2Result.correlationAnalysis || {})
                                .reduce((sum, analysis) => sum + (analysis.weight_adjustment || 0), 0)
                        }</p>
                    </div>
                </div>
                
                <h4>‚ú® V2 Improvements Applied:</h4>
                <div style="margin: 10px 0;">
                    ${(v2Result.improvements || []).map(improvement => 
                        `<span style="background: #1e40af; color: #93c5fd; padding: 4px 12px; border-radius: 12px; margin: 2px; display: inline-block;">${improvement}</span>`
                    ).join('')}
                </div>
            `;
            
            document.getElementById('analysis-content').innerHTML = html;
        }
    </script>
</body>
</html>
