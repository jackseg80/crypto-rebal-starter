<!DOCTYPE html>
<html>
<head>
    <title>Fix Strategy Buttons</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .result { padding: 10px; margin: 5px 0; border-radius: 5px; }
        .success { background: #e8f5e9; border: 1px solid #4caf50; }
        .error { background: #ffebee; border: 1px solid #f44336; }
        .info { background: #e3f2fd; border: 1px solid #2196f3; }
        button { padding: 10px; margin: 5px; cursor: pointer; }
        .strategy-btn { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 5px; }
        .apply-btn { background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Strategy Buttons Fix Test</h1>
    <div id="results"></div>
    
    <h3>Manual Test Buttons (should work):</h3>
    <button class="strategy-btn" onclick="testManualStrategy('macro')">Test Macro Strategy</button>
    <button class="strategy-btn" onclick="testManualStrategy('ccs')">Test CCS Strategy</button>
    <button class="strategy-btn" onclick="testManualStrategy('cycle')">Test Cycle Strategy</button>
    <button class="strategy-btn" onclick="testManualStrategy('blend')">Test Blend Strategy</button>
    <button class="apply-btn" onclick="testApplyTargets()">Test Apply Targets</button>
    
    <script type="module">
        const results = document.getElementById('results');
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            results.appendChild(div);
            console.log(message);
        }
        
        let store, proposeTargets, applyTargets;
        
        try {
            // Import modules
            const storeModule = await import('./core/risk-dashboard-store.js');
            store = storeModule.store;
            
            const targetsModule = await import('./modules/targets-coordinator.js');
            proposeTargets = targetsModule.proposeTargets;
            applyTargets = targetsModule.applyTargets;
            
            addResult('✅ Modules imported successfully', 'success');
            
            // Initialize store with some mock CCS data so strategy buttons work
            store.set('ccs.score', 65);
            store.set('ccs.signals', {
                fear_greed: { value: 65, normalized: 65 },
                rsi: { value: 45, normalized: 45 },
                moving_average: { value: 1.02, normalized: 52 },
                funding_rate: { value: 0.01, normalized: 30 },
                eth_btc_ratio: { value: 0.063, normalized: 55 },
                volatility: { value: 0.35, normalized: 40 }
            });
            store.set('ccs.weights', {
                fear_greed: 0.25,
                rsi: 0.20,
                moving_average: 0.15,
                funding_rate: 0.15,
                eth_btc_ratio: 0.15,
                volatility: 0.10
            });
            
            // Mock cycle data
            store.set('cycle.months', 18);
            store.set('cycle.ccsStar', 72);
            store.set('cycle.multipliers', {
                'BTC': 1.2,
                'ETH': 1.1,
                'Stablecoins': 0.8
            });
            
            addResult('✅ Store initialized with mock CCS data', 'success');
            
        } catch (error) {
            addResult(`❌ Setup failed: ${error.message}`, 'error');
        }
        
        // Test strategy function
        window.testManualStrategy = function(mode) {
            try {
                addResult(`🧪 Testing strategy: ${mode}`, 'info');
                
                if (!proposeTargets) {
                    throw new Error('proposeTargets function not available');
                }
                
                const proposal = proposeTargets(mode);
                addResult(`✅ Strategy ${mode} generated: ${proposal.strategy}`, 'success');
                
                // Show some target details
                const topTargets = Object.entries(proposal.targets)
                    .filter(([key, value]) => key !== 'model_version' && value > 0)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3);
                    
                const targetsStr = topTargets.map(([k, v]) => `${k}: ${v}%`).join(', ');
                addResult(`📊 Top allocations: ${targetsStr}`, 'info');
                
                return proposal;
                
            } catch (error) {
                addResult(`❌ Strategy ${mode} failed: ${error.message}`, 'error');
                console.error(error);
            }
        };
        
        // Test apply targets
        window.testApplyTargets = async function() {
            try {
                addResult('🧪 Testing Apply Targets...', 'info');
                
                if (!proposeTargets || !applyTargets) {
                    throw new Error('Required functions not available');
                }
                
                // Generate a blended proposal
                const proposal = proposeTargets('blend');
                addResult(`📋 Generated proposal: ${proposal.strategy}`, 'info');
                
                // Apply it
                await applyTargets(proposal);
                addResult('✅ Apply Targets completed!', 'success');
                
                // Check localStorage
                const savedTargets = localStorage.getItem('last_targets');
                if (savedTargets) {
                    const data = JSON.parse(savedTargets);
                    addResult(`💾 Saved to localStorage: ${data.strategy}`, 'success');
                    addResult(`📂 Source: ${data.source}, Timestamp: ${data.timestamp}`, 'info');
                } else {
                    addResult('❌ Nothing saved to localStorage', 'error');
                }
                
            } catch (error) {
                addResult(`❌ Apply Targets failed: ${error.message}`, 'error');
                console.error(error);
            }
        };
        
        // Auto-test all strategies on load
        setTimeout(() => {
            addResult('🚀 Running auto-tests...', 'info');
            ['macro', 'ccs', 'cycle', 'blend'].forEach(mode => {
                setTimeout(() => testManualStrategy(mode), 100);
            });
        }, 1000);
        
    </script>
</body>
</html>