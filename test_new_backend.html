<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Test New Backend Integration</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a202c;
            color: #e2e8f0;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .card {
            background: #2d3748;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #4a5568;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            background: #3182ce;
            color: white;
            margin: 5px;
        }
        .btn:hover { background: #2c5282; }
        .log {
            background: #1a202c;
            padding: 15px;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .indicator-card {
            background: #1a202c;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #63b3ed;
        }
        .indicator-name {
            font-weight: bold;
            color: #63b3ed;
            margin-bottom: 8px;
        }
        .indicator-value {
            font-size: 18px;
            color: #48bb78;
            margin: 5px 0;
        }
        .indicator-critical {
            font-size: 12px;
            color: #f56565;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üß™ Test New Backend Integration</h1>
            <p>Test de l'int√©gration compl√®te avec le backend Python + Playwright</p>
            
            <div>
                <button class="btn" onclick="testBackendAPI()">üîß Test Backend API</button>
                <button class="btn" onclick="testJavaScriptModule()">üì¶ Test JS Module</button>
                <button class="btn" onclick="testFullIndicators()">üéØ Test Full Indicators</button>
                <button class="btn" onclick="clearResults()">üßπ Clear</button>
            </div>
        </div>

        <div class="card">
            <h3>üìä Extracted Indicators</h3>
            <div class="indicators-grid" id="indicators-display">
                No indicators loaded yet...
            </div>
        </div>

        <div class="card">
            <h3>üìù Test Log</h3>
            <div class="log" id="test-log">
Test ready...
</div>
        </div>
    </div>

    <script type="module">
        let logElement;
        let indicatorsDisplayElement;
        
        window.onload = function() {
            logElement = document.getElementById('test-log');
            indicatorsDisplayElement = document.getElementById('indicators-display');
            log('üß™ New backend integration test ready', 'success');
        };
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            logElement.textContent += `[${timestamp}] ${icon} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function displayIndicators(indicators) {
            if (!indicators || Object.keys(indicators).length === 0) {
                indicatorsDisplayElement.innerHTML = '<p>No indicators found</p>';
                return;
            }
            
            let html = '';
            Object.entries(indicators).forEach(([key, indicator]) => {
                const isCritical = indicator.in_critical_zone;
                html += `
                    <div class="indicator-card" style="border-left-color: ${isCritical ? '#f56565' : '#63b3ed'}">
                        <div class="indicator-name">${indicator.name || key}</div>
                        <div class="indicator-value">${indicator.value}${typeof indicator.value === 'number' ? '%' : ''}</div>
                        <div class="indicator-critical">Critical: ${isCritical ? 'YES' : 'NO'}</div>
                        ${indicator.threshold ? `<div style="font-size: 11px; color: #718096;">Threshold: ${indicator.threshold}</div>` : ''}
                        <div style="font-size: 10px; color: #4a5568; margin-top: 5px;">
                            Raw: ${indicator.raw_value || 'N/A'}
                        </div>
                    </div>
                `;
            });
            indicatorsDisplayElement.innerHTML = html;
        }
        
        window.testBackendAPI = async function() {
            log('üîß Testing backend API directly...', 'info');
            
            try {
                log('Making request to http://127.0.0.1:8001/api/crypto-toolbox', 'info');
                const response = await fetch('http://127.0.0.1:8001/api/crypto-toolbox');
                
                log(`Response status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    log(`API Success: ${data.total_count} indicators, ${data.critical_count} critical`, 'success');
                    log(`Response keys: ${Object.keys(data).join(', ')}`, 'info');
                    
                    if (data.indicators && data.indicators.length > 0) {
                        log(`Sample indicators:`, 'info');
                        data.indicators.slice(0, 3).forEach(ind => {
                            log(`  ${ind.name}: ${ind.value} (${ind.in_critical_zone ? 'CRITICAL' : 'OK'})`, 'info');
                        });
                    }
                } else {
                    const errorData = await response.text();
                    log(`Backend error: ${errorData}`, 'error');
                }
                
            } catch (error) {
                log(`Backend API test failed: ${error.message}`, 'error');
                if (error.message.includes('Failed to fetch')) {
                    log('üö® Backend seems to be down or unreachable', 'error');
                }
            }
        };
        
        window.testJavaScriptModule = async function() {
            log('üì¶ Testing JavaScript module...', 'info');
            
            try {
                log('Importing fetchCryptoToolboxIndicators from module...', 'info');
                const { fetchCryptoToolboxIndicators } = await import('./modules/onchain-indicators.js');
                log('‚úÖ Module imported successfully', 'success');
                
                log('Calling fetchCryptoToolboxIndicators...', 'info');
                const result = await fetchCryptoToolboxIndicators();
                
                log(`Function result type: ${typeof result}`, 'info');
                if (result) {
                    log(`Result keys: ${Object.keys(result).join(', ')}`, 'success');
                    log(`Indicators count: ${Object.keys(result).length}`, 'success');
                    
                    Object.entries(result).forEach(([key, value]) => {
                        log(`  ${key}: ${JSON.stringify(value)}`, 'info');
                    });
                    
                    displayIndicators(result);
                } else {
                    log('‚ùå Function returned null', 'error');
                }
                
            } catch (error) {
                log(`JS Module test failed: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
            }
        };
        
        window.testFullIndicators = async function() {
            log('üéØ Testing full indicators system...', 'info');
            
            try {
                const { fetchAllOnchainIndicators } = await import('./modules/onchain-indicators.js');
                log('‚úÖ Full indicators module imported', 'success');
                
                log('Fetching all onchain indicators...', 'info');
                const allIndicators = await fetchAllOnchainIndicators();
                
                if (allIndicators) {
                    log(`Total indicators fetched: ${Object.keys(allIndicators).length}`, 'success');
                    
                    const cryptoToolboxCount = Object.keys(allIndicators).filter(key => 
                        allIndicators[key].source === 'crypto-toolbox'
                    ).length;
                    
                    log(`Crypto-Toolbox indicators: ${cryptoToolboxCount}`, 'success');
                    
                    displayIndicators(allIndicators);
                } else {
                    log('‚ùå No indicators returned', 'error');
                }
                
            } catch (error) {
                log(`Full indicators test failed: ${error.message}`, 'error');
            }
        };
        
        window.clearResults = function() {
            logElement.textContent = 'Log cleared...\n';
            indicatorsDisplayElement.innerHTML = 'No indicators loaded yet...';
        };
    </script>
</body>
</html>